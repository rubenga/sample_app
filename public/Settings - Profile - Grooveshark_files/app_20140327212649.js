(function(){var e=function(e,t){var n={};(function(){function e(e){function t(){n.trigger("player:pauseSong"),n.trigger("lightbox:open","login",{premiumRequired:!0,_canClose:!1,message:_.getString("LB_SIGNUP_LOGIN_PREMIUM_REQUIRED")})}n.ready.done(function(){n.Services.API.reportUserChange(e);if(n.getLoggedInUserID()!==e.id)return;var r=e.get("subscription");r.premiumRequired()&&_.defer(t,100)})}function t(e,t){var n=e.get("oldUserClean"),r=e.cleanUpOnLogout(!0);if(n&&n.state()=="pending"){var i=$.after(n,r);return t.set("oldUserClean",i),i.promise()}return t.set("oldUserClean",r),r}function i(t,n,r,i,s){this.trigger("userChange:started",{newUser:s,oldUser:i,destination:n}),this.set({user:s}),this.trigger("userChange:finished",{newUser:s,oldUser:i,destination:n,preventRedirect:r}),e(s),t&&t.resolve(s)}function s(e,r,s,u,a){if(!a||a.userID===0){o.call(this,e,r,a);return}a=_.clone(a),n.Models.AuthUser.uncacheID(a.UserID);var f;a.profile&&(f=_.clone(a.profile),delete a.profile);var l=this.get("user"),c=new n.Models.AuthUser(a,{noCache:!0});f&&(f.ProfileID=f.profile&&f.profile.ProfileID,n.Models.Profile.newOrUpdate(f,{overrideUser:c})),t(l,c).done(_.bind(i,this,e,s,u,l,c))}function o(e,t,r){r||(r={}),r.authType=t,n.trigger("guts:log","loginFail",{type:t}),e.reject(r)}function u(e){var r=this.get("user");if(!r.get("isLoggedIn"))return!1;n.Models.AuthUser.uncacheID(-1);var s=new n.Models.AuthUser({UserID:-1,userTrackingID:r.get("userTrackingID")},{noCache:!0});t(r,s).done(_.bind(i,this,null,null,null,r,s)),e&&n.Services.SWF.sendSelfMessage&&n.Services.SWF.sendSelfMessage(null,"logout")}function a(e){if(!e||!e.length)return;var t=this.get("user");t.get("library")&&t.get("library").remove(e),t.get("favoriteSongs")&&t.get("favoriteSongs").remove(e)}n.Models=n.Models||{},n.Models.Model=Backbone.Model.extend({initialize:function(){var t=new n.Models.AuthUser(_.extend({},gsConfig.user),{noCache:!0});gsConfig.profile&&n.Models.Profile.newOrUpdate(gsConfig.profile,{overrideUser:t}),this.set({user:t,player:new n.Models.Player,theme:new n.Models.Theme}),e(this.get("user")),n.on("songs:deleted",a,this)},onSignup:function(r,i){n.Models.AuthUser.uncacheID(r.UserID);var s=this.get("user"),o=new n.Models.AuthUser(r,{noCache:!0});t(s,o),i&&n.router.setHash(i),this.set("user",o),e(o)},login:function(e,t,r,i,u){var a=new $.Deferred,f;switch(e){case"google":f=n.Services.Google.login();break;case"twitter":f=n.Services.Twitter.login();break;case"normal":default:e="normal",f=n.Services.API.authenticateUser(t,r)}return f.done(_.bind(s,this,a,e,i,u)).fail(_.bind(o,this,a,e)),a.promise()},authenticateAsAuthorizedUser:function(e){var t=new $.Deferred,i=this,u=this.get("user"),a=n.Services.API.authenticateAsAuthorizedUser(e),f=function(){var f=u.get("primaryUserID")||u.get("UserID"),l=u.get("primaryFName")||u.get("FName"),c=u.get("artistsOwned");a.done(function(r){if(r.userID!=e){r.attemptedUserID=e,r.reason="userID does not match",o.call(i,t,"authAsUser",r);return}r.artistsOwned=c,r.primaryUserID=f,r.primaryFName=l,s.call(i,t,"authAsUser",null,null,r),n.trigger("switchUser",u,i.get("user"))}).fail(function(n){n=n?_.clone(n):{},n.attemptedUserID=e,o.call(i,t,"authAsUser",n)})};if(n.isBroadcaster()){var l=r.model.get("player"),c=l.get("currentQueue"),h=c&&c.get("currentBroadcast");h&&n.trigger("lightbox:open","broadcastListeners",{broadcast:h,endBroadcast:!0,onBroadcastEnded:function(){f.call(i)},onCloseLightbox:function(){var n={};n.attemptedUserID=e,o.call(i,t,"authAsUser",n)}})}else f.call(this);return t.promise()},logout:function(e,t){if(e)return u.call(this,!1);var r,i=this,s=this.get("player").get("currentQueue");return!t&&s&&s.get("isBroadcasting")?(r=$.Deferred(),n.trigger("lightbox:open",{_type:"logoutConfirm",view:{header:"LB_LOGOUT_CONFIRM_BROADCAST_TITLE",message:"LB_LOGOUT_CONFIRM_BROADCAST_MSG",buttonsLeft:[{label:"CANCEL",className:"close"}],buttonsRight:[{label:"SIGN_OUT",className:"btn-primary submit"}]},callbacks:{".submit":function(e){n.Services.SWF.endBroadcast(),i.logout(!1,!0).done(function(){r.resolve.apply(r,_.toArray(arguments))}).fail(function(){r.reject.apply(r,_.toArray(arguments))}).always(function(){n.trigger("lightbox:close","logoutConfirm")})}},onDestroy:function(){r.state()=="pending"&&r.reject()}})):this.get("user").get("isLoggedIn")?(r=n.Services.API.logoutUser(),r.done(_.bind(u,this,!0))):r.resolve(),r.promise()}},{})})(),function(){function s(e,t,r){if(!r)return o(e,t);r.Data?this.set("pageNameData",r.Data):this.set("pageNameData",{}),r.Name?r.Name.indexOf("/")>-1?this.set("PathName",""):this.set("PathName",r.Name):this.set("PathName",""),r.Data&&r.Data.Tags?this.set("Tags",new n.Models.Collections.Tags(r.Data.Tags)):this.set("Tags",new n.Models.Collections.Tags([])),t==="data"?e.resolve(this.get("pageNameData")):e.resolve(this.get("PathName"))}function o(e,t){this.set({PathName:"",pageNameData:{}}),e.resolve(null)}function u(e){return{AlbumID:e.A,AlbumName:e.B,ArtistID:e.C,ArtistName:e.D,CoverArtFilename:e.E,EstimateDuration:e.F,Flags:e.G,Popularity:e.H,SongID:e.I,SongName:e.J,TSAdded:e.K,TrackNum:e.L,Year:_.defined(e.M)?e.M:"0",TSFavorited:e.O,TagIDs:e.P}}function a(e){return{AlbumID:e.alID,AlbumName:e.alN,ArtistID:e.arID,ArtistName:e.arN,CoverArtFilename:e.art,EstimateDuration:e.estD,Flags:e.f,SongID:e.sID,SongName:e.sN,TrackNum:e.t,token:e.tk}}function f(e,t){this._artists||(this._artists={}),this._albums||(this._albums={});var r=this._artists,i=this._albums;e.ArtistID&&(t||!r.hasOwnProperty(e.ArtistID))&&(r[e.ArtistID]=n.Models.Artist.newOrUpdate({ArtistID:e.ArtistID,ArtistName:e.ArtistName})),e.AlbumID&&(t||!i.hasOwnProperty(e.AlbumID))&&(i[e.AlbumID]=n.Models.Album.newOrUpdate({ArtistID:e.AlbumArtistID||e.ArtistID,ArtistName:e.AlbumArtistName||e.ArtistName,AlbumID:e.AlbumID,AlbumName:e.AlbumName,Year:e.Year,CoverArtFilename:e.CoverArtFilename,IsVerifiedSongs:e.IsVerified})),e.TrackNum&&(this.attributes.TrackNumsByAlbumID[e.AlbumID]=e.TrackNum);var s=this.attributes.ArtistID;(t||!s||s===n.Models.Artist.UNKNOWN&&s!=e.ArtistID)&&this.setPreferredArtist(e.ArtistID,{silent:!0});var o=this.attributes.AlbumID;(!o||o===n.Models.Album.UNKNOWN&&o!=e.AlbumID)&&this.setPreferredAlbum(e.AlbumID,{silent:!0});if(e.artistIsClaimed&&e.ArtistID&&r[e.ArtistID]){var u=r[e.ArtistID].get("Flags")||0;r[e.ArtistID].set("Flags",u|n.Models.Artist.FLAG_ARTIST_CLAIMED),delete e.artistIsClaimed}}function l(e,t){return e.CalloutID||e.calloutID?t&&t.skipUpdate?new n.Models.Callout(e,t):n.Models.Callout.newOrUpdate(e,t):t&&t.skipUpdate?new n.Models.Song(e,t):n.Models.Song.newOrUpdate(e,t)}n.Models=n.Models||{};var i=["songID","songName","Name","artistID","artistName","albumID","albumName","flags","artFilename","tagIDs","trackNum","popularity","isVerified","Token","A","B","C","D","E","F","H","I","J","K","L","M","N","O","P","G","uSecs","NumPlays","Weight","SongNameID","AvgRating","ur","broadcastUpVotes","broadcastDownVotes","broadcastListens","artistIsClaimed","owningName","timestamp","RawWeight"];n.Models.Song=Backbone.CachedModel.extend({idAttribute:"SongID",_useAlbumContextForImg:!1,parse:function(e,r){var s=r||{},o=e,f;e.hasOwnProperty("A")?o=u(e):e.hasOwnProperty("sID")&&(o=a(e));var l=_.orEqualEx(o.SongName,o.songName,o.Name,"Unknown Title"),c=_.orEqualEx(o.ArtistName,o.artistName,_.getString("UNKNOWN_ARTIST")),h=_.orEqualEx(o.AlbumName,o.albumName,_.getString("UNKNOWN_ALBUM")),p=[l,c,h].join(" ").toLowerCase(),d=_.orEqualEx(o.CoverArtFilename,o.artFilename,""),v=_.orEqual(o.Flags,o.flags),m=parseFloat(_.orEqual(o.IsVerified,o.isVerified));return m=isNaN(m)?0:m,d==="default.png"&&(d=""),f={SongID:_.toInt(_.orEqualEx(o.SongID,o.songID,0)),SongName:l,ArtistID:_.toInt(_.orEqualEx(o.ArtistID,o.artistID,0)),ArtistName:c,AlbumID:_.toInt(_.orEqualEx(o.AlbumID,o.albumID,0)),AlbumName:h,Flags:_.defined(v)?_.toInt(v):t,IsVerified:m,CoverArtFilename:d,EstimateDuration:_.orEqualEx(o.EstimateDuration,o.estimateDuration,0),TrackNum:_.toInt(_.orEqualEx(o.TrackNum,o.trackNum,0)),Year:_.orEqualEx(o.Year,o.year,"0"),Popularity:_.toInt(_.orEqualEx(o.Popularity,o.popularity,0)),TagIDs:_.orEqualEx(o.tagIDs,o.TagIDs,[]),Tags:_.isArray(o.Tags)?new n.Models.Collections.Tags(o.Tags):o.Tags,TrackNumsByAlbumID:_.orEqual(o.TrackNumsByAlbumID,{}),fromLibrary:!!o.fromLibrary||!!s.fromLibrary,isFavorite:!!o.isFavorite||!!s.isFavorite,IsLowBitrateAvailable:_.toInt(o.IsLowBitrateAvailable),searchText:p,token:_.orEqual(o.token,o.Token,null),tokenFailed:!!o.tokenFailed,ppVersion:o.ppVersion,PathName:o.PathName,pageNameData:o.pageNameData,TSFavorited:o.TSFavorited,TSAdded:o.TSAdded,listenDataKey:o.listenDataKey,listenTime:o.listenTime,client:o.client},f},initialize:function(e,t){f.call(this,e,!0);if(!e.isFavorite||!e.fromLibrary){var n=r.model.attributes.user,i={};n&&(n.attributes.favoriteSongsSongIDs&&n.attributes.favoriteSongsSongIDs[this.id]&&(i.isFavorite=!0),n.attributes.librarySongsSongIDs&&n.attributes.librarySongsSongIDs[this.id]&&(i.fromLibrary=!0),(i.fromLibrary||i.isFavorite)&&this.set(i,{silent:!0}))}return Backbone.CachedModel.prototype.initialize.call(this,e,t)},updateFromNew:function(e,t){var r=_.omitSameKeys(this.attributes,e);e.hasOwnProperty("ppVersion")&&(r.ppVersion=e.ppVersion);var i=_.toInt(e.Popularity);if(i>0||!this.attributes.Popularity)r.Popularity=i;var s=_.toInt(e.Year);s!==this.attributes.Year&&(r.Year=s);if(e.isFavorite||t&&t.isFavorite)r.isFavorite=!0;if(e.fromLibrary||t&&t.fromLibrary)r.fromLibrary=!0,e.TSAdded&&(r.TSAdded=e.TSAdded);_.toInt(e.IsVerified)&&!this.attributes.IsVerified&&(r.IsVerified=1),_.isArray(e.Tags)&&(this.attributes.Tags?this.attributes.Tags.add(e.Tags):r.Tags=new n.Models.Collections.Tags(e.Tags)),f.call(this,e),this.set(r,t)},archiveAttr:function(){var e=[],t=this.attributes;t.Tags&&(e=t.Tags.pluck("TagID")),!e.length&&$.isArray(t.TagIDs)&&(e=t.TagIDs);var n={A:t.AlbumID,B:t.AlbumName,C:t.ArtistID,D:t.ArtistName,E:t.CoverArtFilename,F:t.EstimateDuration,H:t.Popularity,I:t.SongID,J:t.SongName,K:t.TSAdded,L:t.TrackNum,M:t.Year,N:0,O:t.TSFavorited,P:e};return _.defined(t.Flags)&&(n.G=t.Flags),n},get:function(e){var t=this.attributes.AlbumID;switch(e){case"ArtistName":return this._artists&&this._artists[this.attributes.ArtistID]?this._artists[this.attributes.ArtistID].attributes.ArtistName:"";case"AlbumName":return this._albums&&this._albums[t]?this._albums[t].attributes.AlbumName:"";case"CoverArtFilename":return this._albums&&this._albums[t]?this._albums[t].attributes.CoverArtFilename:"";case"TrackNum":return this.attributes.TrackNumsByAlbumID&&this.attributes.TrackNumsByAlbumID[t]?this.attributes.TrackNumsByAlbumID[t]:0}return this.attributes[e]},setPreferredArtist:function(e,t){t=t||{};var r=this._artists,i=r[e],s=i?i.get("ArtistName"):_.getString("UNKNOWN"),o=this._albums,u=o[this.get("AlbumID")];i||(e=n.Models.Artist.UNKNOWN),this.set({ArtistID:e,ArtistName:s},t);if(!t.fromAlbumSet&&(!u||u.get("ArtistID")!=e)){var a=_.find(o,function(t){return t.get("ArtistID")==e});t.fromArtistSet=!0,(a||e==n.Models.Artist.UNKNOWN)&&this.setPreferredAlbum(a?a.get("AlbumID"):n.Models.Album.UNKNOWN,t)}},setPreferredAlbum:function(e,t){t=t||{};var r=this._albums,i=r[e],s=i?i.get("AlbumName"):_.getString("UNKNOWN"),o=i?i.get("ArtistID"):n.Models.Artist.UNKNOWN,u=this._artists;i||(e=n.Models.Album.UNKNOWN),this.set({AlbumID:e,AlbumName:s},t),!t.fromArtistSet&&o!=this.get("ArtistID")&&(t.fromAlbumSet=!0,this.setPreferredArtist(u[o]?o:n.Models.Artist.UNKNOWN,t))},getAlbums:function(e){var t=this._albums;return _.defined(e)?t[e]:_.extend({},t)},addAlbum:function(e){this._albums[e.get("AlbumID")]=e;var t=e.get("ArtistID"),r=this._artists;if(!r.hasOwnProperty(t)){var i=n.Models.Artist.getCached(t);i&&this.addArtist(i)}},removeAlbum:function(e){var t=this._albums,r=this.get("TrackNumsByAlbumID"),i=this.get("AlbumID");t.hasOwnProperty(e)&&delete t[e],r.hasOwnProperty(e)&&delete r[e];if(e==i){var s=_.keys(t);s.length?this.setPreferredAlbum(s[0]):this.setPreferredAlbum(n.Models.Album.UNKNOWN)}},getArtists:function(e){var t=this._artists;return _.defined(e)?t[e]:_.extend({},t)},addArtist:function(e){this._artists[e.get("ArtistID")]=e},removeArtist:function(e){var t=this._artists,r=this._albums,i=this.get("ArtistID");t.hasOwnProperty(e)&&delete t[e],_.each(r,function(t,n,r){t.get("ArtistID")==e&&delete r[n]});if(e==i){var s=_.keys(t);s.length?this.setPreferredArtist(s[0]):this.setPreferredArtist(n.Models.Artist.UNKNOWN)}},toUrl:function(e){var t=this.getToken(!0);return t?_.cleanUrl(this.get("SongName"),this.get("SongID"),"s",t,e):"#!/notFound"},toArtistUrl:function(e){return n.Models.Artist.getArtistUrl(this.get("ArtistID"),this.get("ArtistName"),e)},toAlbumUrl:function(e){return _.cleanUrl(this.get("AlbumName"),this.get("AlbumID"),"album",null,e)},getToken:function(e){e=_.orEqual(e,!1);var t;return!this.get("token")&&!this.get("tokenFailed")?t=n.Services.API.getTokenForSong(this.get("SongID"),_.bind(this._onGetToken,this),null,{async:!e}):(t=new $.Deferred,t.resolve({Token:this.get("token")})),e?this.get("token"):t.promise()},getPathName:function(){var e=new $.Deferred;return this.pageNameDataDfd&&this.pageNameDataDfd.state()=="pending"?this.pageNameDataDfd.done(_.bind(function(){e.resolve(this.get("PathName"))},this)):typeof this.get("PathName")!="undefined"?e.resolve(this.get("PathName")):n.Services.API.getPageInfoByIDType(this.get("SongID"),"song").done(_.bind(s,this,e,"name")).fail(_.bind(o,this,e)),e.promise()},getPageNameData:function(){if(this.pageNameDataDfd&&this.pageNameDataDfd.state()!="rejected")return this.pageNameDataDfd.promise();var e=new $.Deferred;return typeof this.get("pageNameData")!="undefined"?e.resolve(this.get("pageNameData")):n.Services.API.getPageInfoByIDType(this.get("SongID"),"song").done(_.bind(s,this,e,"data")).fail(_.bind(o,this,e)),this.pageNameDataDfd=e,e.promise()},getTags:function(){var e=new $.Deferred;return typeof this.get("Tags")!="undefined"?e.resolve(this.get("Tags")):this.getPageNameData().done(_.bind(function(){e.resolve(this.get("Tags"))},this)).fail(e.reject),e.promise()},_onGetToken:function(e){e.Token?(this.set("token",e.Token),this.constructor.getCached(this.id)&&this.cid===this.constructor.getCached(this.id).cid&&this.constructor.cacheToken(this)):this.set("tokenFailed",!0)},getImageURL:function(t,r){r=_.extend({useDefault:!1},r),t=_.orEqual(t,70);var i,s=this._useAlbumContextForImg||r.useAlbumContext,o=n.Models.Song.artPath+t+"_album.png";if(s&&this.attributes.context&&this.attributes.context.type=="album"){var u=this.getAlbums(this.attributes.context.data.albumID);u&&(i=u.attributes.CoverArtFilename)}else i=this.get("CoverArtFilename");return i&&!r.useDefault&&(o=n.Models.Song.artPath+t+"_"+i),gsConfig.runMode!=="production"&&(o+="?co="+e.location.host),o},getDetailsForFeeds:function(){return{songID:this.get("SongID"),songName:this.get("SongName"),albumID:this.get("AlbumID"),albumName:this.get("AlbumName"),artistID:this.get("ArtistID"),artistName:this.get("ArtistName"),artFilename:this.get("CoverArtFilename"),track:this.get("TrackNum"),isVerified:this.get("IsVerified"),token:this.get("token")}},getDetailsForSwf:function(){var e=/\u0000/g;return{SongID:this.get("SongID"),SongName:this.get("SongName").replace(e,""),AlbumID:this.get("AlbumID"),AlbumName:this.get("AlbumName").replace(e,""),ArtistID:this.get("ArtistID"),ArtistName:this.get("ArtistName").replace(e,""),CoverArtFilename:this.get("CoverArtFilename").replace(e,""),TrackNum:this.get("TrackNum"),Flags:this.get("Flags"),EstimateDuration:this.get("EstimateDuration")}},toProxyLabel:function(){return _.getString("SELECTION_SONG_SINGLE",{SongName:this.escape("SongName"),ArtistName:this.escape("ArtistName")})},getTitle:function(e){return e?['"',this.get("SongName"),'" by ',this.get("ArtistName"),' on "',this.get("AlbumName"),'"'].join(""):['"',this.escape("SongName"),'" by ',this.escape("ArtistName"),' on "',this.escape("AlbumName"),'"'].join("")},getAnchorTag:function(e,t,n){var r=this.escape("SongName");return"<a "+(this.get("token")?' href="'+this.toUrl(t)+'"':"")+' class="song-link tooltip-for-full-text '+(n?n:"")+'" data-song-id="'+this.get("SongID")+'">'+(e?_.getString(e).toLocaleLowerCase():r)+"</a>"},getArtistAnchorTag:function(e,t,r){var i=n.Models.Artist.getArtistUrl(this.get("ArtistID"),this.get("ArtistName"),t);return'<a href="'+i+'" class="artist-link '+(r?r:"")+'">'+(e?_.getString(e).toLocaleLowerCase():_.escape(this.get("ArtistName")))+"</a>"},getAlbumAnchorTag:function(e,t){return'<a href="'+_.cleanUrl(this.get("AlbumName"),this.get("AlbumID"),"album",null,t)+'" class="album-link">'+(e?_.getString(e).toLocaleLowerCase():_.escape(this.get("AlbumName")))+"</a>"},getWidgetCode:function(e,t,n){n=_.orEqual(n,"metal");var r="gsSong"+this.get("SongID")+Math.floor(Math.random()*101),i=_.orEqual(e,250),s=_.orEqual(t,40),o=_.escape(this.get("SongName")+" by "+this.get("ArtistName")+" on Grooveshark"),u='<a href="http://grooveshark.com/search/song?q='+encodeURIComponent(this.get("ArtistName")+" "+this.get("SongName"))+'" title="'+o+'">'+o+"</a>";return'<object width="'+i+'" height="'+s+'" classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000" id="'+r+'" name="'+r+'">'+'<param name="movie" value="http://grooveshark.com/songWidget.swf" /><param name="wmode" value="window" /><param name="allowScriptAccess" value="always" />'+'<param name="flashvars" value="hostname=grooveshark.com&songID='+this.get("SongID")+"&style="+n+'&p=0" />'+'<object type="application/x-shockwave-flash" data="http://grooveshark.com/songWidget.swf" width="'+i+'" height="'+s+'"><param name="wmode" value="window" />'+'<param name="allowScriptAccess" value="always" /><param name="flashvars" value="hostname=grooveshark.com&songID='+this.get("SongID")+"&style="+n+'&p=0" />'+"<span>"+u+"</span></object></object>"},getWidgetType:function(){return"single"},toManateeProperties:function(){var e={},t={sID:this.id,sN:this.attributes.SongName,cID:this.attributes.CalloutID,arID:this.get("ArtistID"),arN:this.get("ArtistName"),alID:this.get("AlbumID"),alN:this.get("AlbumName"),uID:this.attributes.UserID,art:this.get("CoverArtFilename"),t:this.get("TrackNum"),estD:this.attributes.EstimateDuration,flags:this.attributes.Flags,tk:this.attributes.Token,arCl:this.attributes.ArtistIsClaimed},n=this.attributes.Tags;return n&&n.length&&(t.tags=[],n.each(function(e){t.tags.push({tid:e.id,tag:e.get("Tag")})})),e.b=t,e}},{artPath:"http://images.gs-cdn.net/static/albums/",cache:function(e,n){if(e._wrapped!==t)return!1;var r=Backbone.CachedModel.cache.call(this,e,n);return(!n||!n.noCache&&!n.dontCache)&&this.cacheToken(e,n),r},cacheToken:function(e){var t=e.get("token");if(t){var n="t:"+t;if(this._cache.hasOwnProperty(n)){if(this._cache[n].cid!==e.cid)throw["Attempt to overwrite cached instance for ",n].join("");return}this._cache[n]=e}},popularSort:function(e,t){return t.get("Popularity")-e.get("Popularity")},trackSort:function(e,t){return _.toInt(e.get("TrackNum"))-_.toInt(t.get("TrackNum"))},trackAlphaSort:function(e,t){var n=_.toInt(e.get("TrackNum")),r=_.toInt(t.get("TrackNum")),i=n-r;return n&&r&&i?i:n?-1:r?1:(n=e.get("SongName"),r=t.get("SongName"),n<r?-1:n===r?0:1)},getLayeredSort:_.bind(_.getModelSort,_,{ArtistName:["ArtistName","AlbumName","TrackNum"],AlbumName:["AlbumName","TrackNum"]}),nukeSong:function(e,t){if(!e)return;e.getAlbums()&&_.each(e.getAlbums(),function(t){t.get("songs")&&t.get("songs").remove(e),t.get("extraSongs")&&t.get("extraSongs").remove(e)}),e.getArtists()&&_.each(e.getArtists(),function(t){t.get("songs")&&t.get("songs").remove(e)});if(t){var r=n.Models.AuthUser.getCached(n.getLoggedInUserID());r&&(r.localRemoveSongsFromLibrary([e]),r.localRemoveSongsFromFavorites([e])),n.Models.Song.uncache(e)}},get:function(e,t){var r=function(e){var t=new $.Deferred;return n.Services.API.getQueueSongListFromSongIDs([e]).done(function(e){t.resolve(e[0])}).fail(function(e){t.reject(e)}),t.promise()},i=Backbone.CachedModel.genericGet.call(this,r,"SongID",e,t);return i.promise()},getByToken:function(e,t){var r=function(t){var r=new $.Deferred;return n.Services.API.getSongFromToken(e).done(function(t){t.token=e,r.resolve(t)}).fail(function(e){r.reject(e)}),r.promise()},i="t:"+e,s=Backbone.CachedModel.genericGet.call(this,r,"SongID",i,t);return s.promise()},unarchiveSong:function(e){var t=n.Models.Song.getCached(e.I);return t?t:new n.Models.Song(u(e))},unarchiveSongAttributes:function(e){return u(e)},convertManateeSongCalloutProperties:function(e){return!e||!e.b?t:{SongID:e.b.sID,SongName:e.b.sN,CalloutID:e.b.cID,ArtistID:e.b.arID,ArtistName:e.b.arN,AlbumID:e.b.alID,AlbumName:e.b.alN,UserID:e.b.uID,CoverArtFilename:e.b.art,TrackNum:e.b.t,EstimateDuration:e.b.estD,Flags:e.b.flags,Token:e.b.tk,Tags:e.b.tags,ArtistIsClaimed:e.b.arCl,IsCallout:e.b.cID&&!e.b.sID,broadcastUpVotes:e.bUV,broadcastDownVotes:e.bDV,broadcastListens:e.bL,queueSongID:e.queueSongID}}}),n.Models.QueueSong=Backbone.MagicModelWrapper.extend({idAttribute:"queueSongID",myAttributes:["queueSongID","context","paused","playerDuration","active","smile","frown","suggestion","songQueueHelper","source","parentQueueID","autoplayVote","reportedUpcomingInBroadcast","isCallout","broadcastPlayed"],makeWrappedModel:l,_useAlbumContextForImg:!0,parse:function(e,t){var n=t||{},r={},s,o,u;n.fromWrapper=!0,r.isCallout=!!e.CalloutID||!!e.calloutID;for(s=0,o=this.myAttributes.length;s<o;s++)u=this.myAttributes[s],e.hasOwnProperty(u)&&(r[u]=e[u]);return r},getImageURL:n.Models.Song.prototype.getImageURL,toManateeProperties:function(){var e=this._wrapped.toManateeProperties();return e.queueSongID=this.id,e}}),n.Models.PlaylistSong=Backbone.MagicModelWrapper.extend({idAttribute:"playlistSongID",myAttributes:["playlistSongID"],wrappedClass:n.Models.Song,getImageURL:n.Models.Song.prototype.getImageURL}),n.Models.BroadcastSong=Backbone.MagicModelWrapper.extend({idAttribute:"broadcastSongID",myAttributes:["broadcastSongID","broadcast","upVotes","downVotes","userVote","nowPlaying","queueSongID","noSkip","isActiveSong","listens","listensCounted"],wrappedClass:n.Models.Song,_useAlbumContextForImg:!0,parse:function(e,t){var n=t||{},r,s;n.fromWrapper=!0,!_.isArray(e.upVotes)&&_.isObject(e.upVotes)?r=_.keys(e.upVotes):r=e.upVotes||[],!_.isArray(e.downVotes)&&_.isObject(e.downVotes)?s=_.keys(e.downVotes):s=e.downVotes||[];var o={broadcastSongID:e.broadcastSongID,broadcast:e.broadcast,upVotes:r,downVotes:s,userVote:_.toInt(e.userVote),nowPlaying:e.nowPlaying,queueSongID:e.queueSongID,noSkip:e.noSkip,isActiveSong:e.isActiveSong,listens:e.listens,listensCounted:e.listensCounted};return o},getImageURL:n.Models.Song.prototype.getImageURL,toManateeProperties:function(){var e=this._wrapped.toManateeProperties();return e.bUV=this.attributes.broadcastUpVotes,e.bDV=this.attributes.broadcastDownVotes,e.bL=this.attributes.broadcastListens,e.queueSongID=this.attributes.queueSongID,e},makeWrappedModel:function(e,t){return e.CalloutID?new n.Models.Callout(e,t):new n.Models.Song(e,t)}}),n.Models.BroadcastSuggestion=Backbone.MagicModelWrapper.extend({idAttribute:"SongID",myAttributes:["broadcast","upVotes","userVote","approvalStatus","suggester"],wrappedClass:n.Models.Song,parse:function(e,t){var n=t||{},r,s;n.fromWrapper=!0,_.isArray(e.upVotes)?r=e.upVotes||[]:r=_.keys(e.upVotes),n.broadcastListeners&&r.length&&!s?s=n.broadcastListeners.get(r[0]):s=e.suggester;var o={broadcast:e.broadcast,upVotes:r,userVote:_.toInt(e.userVote),approvalStatus:_.toInt(e.approvalStatus),suggester:s,SongID:_.toInt(e.SongID)};return o},getImageURL:n.Models.Song.prototype.getImageURL});var c=["toUrl","toArtistUrl","getArtists","getAlbums","toAlbumUrl","getToken","getDetailsForFeeds","getDetailsForSwf","toProxyLabel","getPageNameData","getAnchorTag","getArtistAnchorTag"];Backbone.MagicModelWrapper.wrapMethods(n.Models.Song,n.Models.QueueSong,c),Backbone.MagicModelWrapper.wrapMethods(n.Models.Song,n.Models.BroadcastSong,c),Backbone.MagicModelWrapper.wrapMethods(n.Models.Song,n.Models.PlaylistSong,c),Backbone.MagicModelWrapper.wrapMethods(n.Models.Song,n.Models.BroadcastSuggestion,c),Backbone.MagicModelWrapper.createMyAttributesHash(n.Models.QueueSong),Backbone.MagicModelWrapper.createMyAttributesHash(n.Models.BroadcastSong),Backbone.MagicModelWrapper.createMyAttributesHash(n.Models.PlaylistSong),Backbone.MagicModelWrapper.createMyAttributesHash(n.Models.BroadcastSuggestion)}(),function(){function i(e,t,r){if(!r)return s(e,t);var i={pageNameData:r.Data||{},PathName:(r.Name&&r.Name.indexOf("/")>-1?"":r.Name)||"",Tags:new n.Models.Collections.Tags(r.Data&&r.Data.Tags||[])};this.set(i),t==="data"?e.resolve(this.get("pageNameData")):e.resolve(this.get("PathName"))}function s(e,t){this.set({PathName:"",pageNameData:{}}),e.resolve(null)}function o(e,t,n){if(n&&n.success){var r={};t.hasOwnProperty("bio")&&(r.Bio=t.bio),t.hasOwnProperty("bioAttribution")&&(r.BioAttribution=t.bioAttribution),t.urls&&(this.get("pageNameData")&&this.get("pageNameData").URLs?r.URLs=$.extend({},this.get("pageNameData").URLs,t.urls):r.URLs=t.urls),t.ArtistName&&this.set("pendingArtistName",t.ArtistName);var i=$.extend({},_.orEqual(this.get("pageNameData"),{}),r);this.set("pageNameData",i),e.resolve(this.get("pageNameData"))}else a(e,n?n.errorCode:0)}function u(e,t,r){r?(this.get("PathName")&&n.router.uncachePageName(this.get("PathName")),t?(this.set("PathName",t),n.router.cachePageName(t,"artist",this.id)):this.set("PathName",""),e.resolve(this.get("PathName"))):a(e,r)}function a(e,t){e.reject(t)}function f(e){return function(t){return t.get("ArtistID")===e}}function l(e,t,n,r){if(!r)return a(e,r);for(var i=0;i<n.length;i++)n[i].removeArtist(t);e.resolve(n)}function c(e,t,r){if(!r)return a(e,r);for(var i=0;i<t.length;i++)n.Models.Song.uncache(t[i]);n.trigger("songs:deleted",t),e.resolve()}function h(e,t,r){if(!r||!r.events){e.reject();return}t&&this.attributes.feed?this.attributes.feed.add(r.events):this.set("feed",new n.Models.Collections.FeedEvents(r.events,{feedType:"model",ownerModel:this,initialPageableItemLimit:25,pageableItemsPerLoad:25,modelOptions:{dontCache:!0}})),e.resolve(this.attributes.feed,r.events)}function p(e){var t=_.toInt(e.attributes.Flags||0),n=e.attributes.ReleaseType,r=_.defined(e.attributes.IsVerified)||e.attributes.source=="songData"?e.attributes.IsVerified:e.attributes.IsVerifiedSongs;return n==1&&e.attributes.ReleaseStatus==1&&r&&(t>=512||t===0)?"fullAlbums":(n==2||n==3)&&r&&e.attributes.ReleaseStatus==1&&(t>=512||t===0)?"singlesEPs":"others"}function d(){var e=this.attributes.albums?this.attributes.albums.models:[],t={fullAlbums:[],singlesEPs:[],others:[]},r=0,i=e.length,s,o,u=_.any(e,function(e){return e.attributes.ReleaseType>0});if(u){for(;r<i;r++)s=e[r],o=p(s),o&&t[o].push(s);this.set({hasReleaseTypes:!0,fullAlbums:new n.Models.Collections.Albums(t.fullAlbums),singlesEPs:new n.Models.Collections.Albums(t.singlesEPs),others:new n.Models.Collections.Albums(t.others)}),this.attributes.albums.on("add",_.bind(v,this,"add")),this.attributes.albums.on("remove",_.bind(v,this,"remove")),this.attributes.albums.on("change",_.bind(v,this,"change"))}else this.set({hasReleaseTypes:!1})}function v(e,t){function a(e){r.attributes[e].indexOf(t)!=-1&&r.attributes[e].remove(t)}if(e=="change"){var n=t.changedAttributes();if(!(n.hasOwnProperty("ReleaseType")||n.hasOwnProperty("ReleaseStatus")||n.hasOwnProperty("IsVerified")||n.hasOwnProperty("Flags")))return}var r=this,i=p(t),s=["fullAlbums","singlesEPs","others"],o=0,u=s.length;switch(e){case"add":i&&this.attributes[i].add(t);break;case"remove":for(;o<u;o++)a(s[o]);break;case"change":for(;o<u;o++)i&&s[o]==i?this.attributes[i].add(t):a(s[o])}}n.Models=n.Models||{};var e=[{type:"dailyStats",call:"getArtistsDailyArtistStatsEx"}],r=[{type:"dailySongsStats",call:"getArtistDailySongsStats",single:!0},{type:"weeklyTopStats",call:"getArtistWeeklyTopStats",single:!0}];n.Models.Artist=Backbone.CachedModel.extend({idAttribute:"ArtistID",parse:function(e,r){var i=r||{},s=_.orEqualEx(e.ArtistName,e.Name,e.artistName)||_.getString("UNKNOWN_ARTIST");e.pageNameData&&e.pageNameData.Tags&&!(e.pageNameData.Tags instanceof n.Models.Collections.Tags)&&(e.pageNameData.Tags=new n.Models.Collections.Tags(e.pageNameData.Tags));var o={ArtistID:_.toInt(_.orEqual(e.ArtistID,e.artistID)),ArtistName:s,searchText:s.toLowerCase(),CoverArtFilename:_.orEqualEx(e.ArtistCoverArtFilename,e.CoverArtFilename,e.artFilename),isFavorite:!!e.isFavorite||!!i.isFavorite,IsVerified:e.IsVerified,Flags:typeof e.Flags!="undefined"?_.toInt(e.Flags):t,estimatedBroadcastListens:_.toInt(e.estimatedBroadcastListens||e.pageNameData&&e.pageNameData.BroadcastListens),pageNameData:e.pageNameData,Tags:e.pageNameData?e.pageNameData.Tags:t,profileID:_.toInt(e.profileID||e.ProfileID)||t,PathName:e.PathName,pageNameSource:e.pageNameSource,Popularity:e.Popularity,Picture:e.Picture,TSFavorited:_.toInt(e.TSFavorited)};return o},initialize:function(e,t){return this.on("change:pageNameData",this.resetEstimatedListens,this),Backbone.CachedModel.prototype.initialize.call(this,e,t)},destroy:function(){return this.off("change:pageNameData",this.resetEstimatedListens,this),Backbone.CachedModel.prototype.destroy.apply(_.toArray(arguments))},updateFromNew:function(e,t){var r=_.omitSameKeys(this.attributes,e);if(e.pageNameData){var i=e.pageNameData;r.pageNameData=i,i.Tags&&(i.Tags.models||(i.Tags=new n.Models.Collections.Tags(i.Tags)),r.Tags=i.Tags)}if(e.isFavorite||t&&t.isFavorite)r.isFavorite=!0;!this.attributes.CoverArtFilename&&e.CoverArtFilename&&(r.CoverArtFilename=e.CoverArtFilename),this.set(r,t)},resetEstimatedListens:function(){var e=_.orEqual(this.get("pageNameData"),{}),t=_.toInt(e.BroadcastListens);this.set("estimatedBroadcastListens",t)},incrementEstimatedListens:function(e){e=_.toInt(e);var t=_.toInt(this.get("estimatedBroadcastListens"));this.set("estimatedBroadcastListens",t+e)},getSongs:function(){if(this.loadSongsDfd)return this.loadSongsDfd.promise();var e=$.Deferred(),t;return n.isLoggedInUserOwnerOfArtist(this.id)?t=n.Services.API.artistGetArtistSongs(this.id,5e3):t=n.Services.API.artistGetArtistSongs(this.id),t.done(_.bind(function(t){var r=new n.Models.Collections.Songs(t),i={},s=this.id;_.each(t,function(e){if(e.AlbumArtistID==s){var t=e.AlbumID;i[t]?i[t].IsVerifiedSongs!=1&&(i[t].IsVerifiedSongs=e.IsVerified):i[t]={AlbumID:t,AlbumName:e.AlbumName,ArtistID:e.AlbumArtistID,ArtistName:e.AlbumArtistName||e.ArtistName,CoverArtFilename:e.CoverArtFilename,IsVerifiedSongs:e.IsVerified,songsFromArtist:[],ReleaseType:e.ReleaseType,ReleaseStatus:e.ReleaseStatus,Year:e.Year,source:"songData"},i[t].songsFromArtist.push(e)}}),this.set("songs",r),this.attributes.albums?this.attributes.albums.add(_.toArray(i)):(this.set("albums",new n.Models.Collections.Albums(_.toArray(i))),d.call(this)),e.resolve(r)},this)),t.fail(function(t){e.reject(t)}),this.loadSongsDfd=e,e.promise()},getTopSongs:function(){if(this.loadTopSongsDfd)return this.loadTopSongsDfd.promise();var e=$.Deferred();return this.get("topSongs")?e.resolve(this.get("topSongs")):this.getSongs().done(_.bind(function(t){var r=this.get("songs").toArray(),i=new n.Models.Collections.Songs(r,{comparator:_.getModelSort("Popularity")});i.reset(i.first(100)),this.set("topSongs",i),e.resolve(i)},this)).fail(function(t){e.reject(t)}),this.loadTopSongsDfd=e,e.promise()},getAlbums:function(){if(this.loadAlbumsDfd)return this.loadAlbumsDfd.promise();var e=$.Deferred();return this.get("albums")?e.resolve(this.get("albums")):(this.getSongs().done(_.bind(function(){e.resolve(this.get("albums"))},this)).fail(_.bind(function(){e.reject()},this)),this.loadAlbumsDfd=e),e.promise()},getAllAlbums:function(){if(this.loadAllAlbumsDfd&&this.loadAllAlbumsDfd.state()!=="rejected")return this.loadAllAlbumsDfd.promise();var e=$.Deferred(),t=this.id,r=this.get("albums");return r&&r.isAllAlbums?(e.resolve(r),e.promise()):(n.Services.API.artistGetAllAlbums(t).done(_.bind(function(r){var i=[],s=[],o=this.get("ArtistName"),u;r&&r.albums&&(i=r.albums);for(var a=0,f=i.length;a<f;a++)!i[a].ArtistName&&i[a].ArtistID==t&&(i[a].ArtistName=o),(u=n.Models.Album.getCached(i[a].AlbumID))?u.updateLocalInfo(i[a]):u=new n.Models.Album(i[a]),s.push(u);if(this.attributes.albums)this.attributes.albums.add(s);else{var l=new n.Models.Collections.Albums(s);l.isAllAlbums=!0,this.set("albums",l),d.call(this)}e.resolve(this.attributes.albums)},this)).fail(_.bind(e.reject,e)),this.loadAllAlbumsDfd=e,e.promise())},getSimilarArtists:function(){if(this.loadSimilarArtistsDfd)return this.loadSimilarArtistsDfd.promise();var e=$.Deferred();return this.get("similarArtists")?e.resolve(this.get("similarArtists")):(n.Services.API.artistGetSimilarArtists(this.id).done(_.bind(function(t){var r=new n.Models.Collections.Artists(t.SimilarArtists);this.set("similarArtists",r),e.resolve(r)},this)),this.loadSimilarArtistsDfd=e),e.promise()},getFollowers:function(){if(this.loadFollowers)return this.loadFollowersDfd.promise();var e=$.Deferred();return this.get("followers")?e.resolve(this.get("followers")):(n.Services.API.artistGetFans(this.id,0).done(_.bind(function(t){var r=new n.Models.Collections.Users(t.Return.fans);this.set("followers",r),e.resolve(r)},this)),this.loadFollowersDfd=e),e.promise()},toUrl:function(e){var t=this.get("PathName")||"";if(t&&t.indexOf("/")===-1)return _.makeUrlFromPathName(t,e);var n=this.get("profileID");return n?_.cleanUrl(this.get("ArtistName"),n,"profile",null,e):_.cleanUrl(this.get("ArtistName"),this.id,"artist",null,e)},getPathName:function(){var e=new $.Deferred;return this.pageNameDataDfd&&this.pageNameDataDfd.state()=="pending"?this.pageNameDataDfd.done(_.bind(function(){e.resolve(this.get("PathName"))},this)):typeof this.get("PathName")!="undefined"?e.resolve(this.get("PathName")):n.Services.API.getPageInfoByIDType(this.get("ArtistID"),"artist").done(_.bind(i,this,e,"name")).fail(_.bind(s,this,e)),e.promise()},getPageNameData:function(e){if(this.pageNameDataDfd&&this.pageNameDataDfd.state()!="rejected"&&!e)return this.pageNameDataDfd.promise();var t=new $.Deferred;return!e&&typeof this.get("pageNameData")!="undefined"?t.resolve(this.get("pageNameData")):n.Services.API.getPageInfoByIDType(this.get("ArtistID"),"artist",e).done(_.bind(i,this,t,"data")).fail(_.bind(s,this,t)),this.pageNameDataDfd=t,t.promise()},getTags:function(){var e=new $.Deferred;return typeof this.get("Tags")!="undefined"?e.resolve(this.get("Tags")):this.getPageNameData().done(_.bind(function(){var t=this.get("Tags");if(!t){var n=this.get("pageNameData");n&&n.Tags&&(t=n.Tags,this.set("Tags",t))}e.resolve(t)},this)).fail(e.reject),e.promise()},getSongkickEvents:function(){if(this.songkickDfd)return this.songkickDfd.promise();var e=$.Deferred();return this.get("songkickEvents")?e.resolve(this.get("songkickEvents")):(n.Services.API.getSongkickEventsFromArtists([this.id],[this.get("ArtistName")]).done(_.bind(function(t){var r=new n.Models.Collections.Events(t);r.comparator=_.getModelSort("StartTime",!0),r.sort(),this.set("songkickEvents",r),e.resolve(r)},this)),this.songkickDfd=e),e.promise()},getImageURL:function(e){e=_.orEqual(e,70);var t=n.Models.Artist.artPath+e+"_artist.png";return this.get("CoverArtFilename")?n.Models.Artist.artPath+e+"_"+this.get("CoverArtFilename"):t},getImageAttribution:function(){if(this.loadAttribution)return this.loadAttribution.promise();var e=$.Deferred();return this.get("attribution")?e.resolve(this.get("attribution")):(n.Services.API.artistGetArtAttribution(this.id).done(_.bind(function(t){if(!t||!t.URL)t={};this.set("attribution",t),e.resolve(t)},this)),this.loadAttribution=e),e.promise()},getArtistDetails:function(){if(this.loadDetailsDfd)return this.loadDetailsDfd.promise();var e=$.Deferred();return this._gotExtraDetails?e.resolve(this):(n.Services.API.getArtistByID(this.id).done(_.bind(function(t){this._gotExtraDetails=!0;var n={CoverArtFilename:t.CoverArtFilename,IsVerified:this.attributes.IsVerified||t.IsVerified};this.set(n),e.resolve(this)},this)).fail(function(t){e.reject(t)}),this.loadDetailsDfd=e),e.promise()},toProxyLabel:function(){return this.escape("ArtistName")},getTitle:function(e){return e?this.get("ArtistName"):this.escape("ArtistName")},updateProfile:function(e){var r=!0,i=this.get("pageNameData"),s=new $.Deferred;if(!i)r=!1;else{i=$.extend({},i),i.Bio===e.bio||!i.Bio&&!e.bio?delete e.Bio:r=!1,i.BioAttribution===e.bioAttribution||!i.BioAttribution&&!e.bioAttribution?delete e.BioAttribution:r=!1;if(!i.URLs&&e.urls)r=!1;else if(e.urls){for(var u in e.urls)e.urls.hasOwnProperty(u)&&(!i.URLs.hasOwnProperty(u)||e.urls[u]!==i.URLs[u])&&(r=!1);for(u in i.URLs)i.URLs.hasOwnProperty(u)&&!e.urls.hasOwnProperty(u)&&(e.urls[u]=i.URLs[u]||t)}e.ArtistName&&this.get("ArtistName")!==e.ArtistName&&this.get("pendingArtistName")!==e.ArtistName?r=!1:e.ArtistName&&delete e.ArtistName,typeof i.Bio=="string"&&(i.bio=i.Bio,delete i.Bio),typeof i.URLs=="object"&&(i.urls=i.URLs,delete i.URLs),typeof i.BioAttribution=="string"&&(i.bioAttribution=i.BioAttribution,delete i.BioAttribution)}return r?s.resolve(this.get("pageNameData")):n.Services.API.artistUpdateProfileEx(this.get("ArtistID"),e,i).done(_.bind(o,this,s,e)).fail(_.bind(a,this,s)),s.promise()},updatePageName:function(e){var t=$.Deferred();return e===this.get("PathName")?t.resolve(!0):n.Models.AuthUser.checkEmailUsername(null,e).done(_.bind(function(r){r.username===-1?t.reject(-1):r.username===!1?t.reject(-2):n.Services.API.artistUpdatePageName(this.get("ArtistID"),e).done(_.bind(u,this,t,e)).fail(_.bind(a,this,t))},this)),t.promise()},disownSongs:function(e,t){var r=this.get("ArtistID"),i=[],s=[],o=new $.Deferred,u,f,h;for(var p=0;p<e.length;p++){u=n.Models.Song.getCached(e[p]);if(u){i.push(u),f=u.getAlbums(),h=0,_.each(f,function(e){e.get("ArtistID")===r&&(h++,_.indexOf(s,e.get("AlbumID"))===-1&&s.push(e.get("AlbumID")))});if(!h)return o.reject(!1),o.promise()}}return t?n.Services.API.artistDeleteSongs(e,s,r).done(_.bind(c,this,o,r,i)).fail(_.bind(a,this,o)):n.Services.API.artistDisownSongs(e,s,r).done(_.bind(l,this,o,r,i)).fail(_.bind(a,this,o)),o.promise()},getDetailsForFeeds:function(){var e={artistID:this.get("ArtistID"),artistName:this.get("ArtistName"),artFilename:this.get("CoverArtFilename"),isVerified:this.get("IsVerified")};return e},getAnchorTag:function(e,t){return['<a href="',this.toUrl(t),'" class="artist-link">',e?_.getString(e).toLocaleLowerCase():_.escape(this.get("ArtistName")),"</a>"].join("")},getFeed:function(e){if(this.feedDfd&&this.feedDfd.state()!=="rejected"&&!e)return this.feedDfd.promise();var t=$.Deferred();if(this.get("feed")&&!e)t.resolve(this.get("feed"),[]);else if(this.id<=0)i=new n.Models.Collections.FeedEvents([]),this.set({feed:i}),t.resolve(i,[]);else{var r=null;if(e&&this.get("feed")&&this.get("feed").length){var i=this.get("feed");i&&i.length&&(r=this.get("feed").last().get("timestamp"))}this.feedDfd=t,n.Services.API.getProfileFeedForItem(this.id,"artist",r).done(_.bind(h,this,t,e)).fail(_.bind(this.feedDfd.reject,this.feedDfd))}return t.promise()},getCurrentStatus:function(){if(!this.currentStatusDfd||this.currentStatusDfd.state()!=="pending"){this.currentStatusDfd=$.Deferred();var e=setTimeout(_.bind(function(){this.currentStatusDfd&&this.currentStatusDfd.reject()},this),3e3);this.currentStatusDfd.always(_.bind(function(){delete this.currentStatusDfd,clearTimeout(e)},this)),n.Services.SWF.ready.done(_.bind(function(){n.Services.SWF.connectToChat(),n.Services.SWF.getArtistStatus(this.get("ArtistID"))},this))}return this.currentStatusDfd.promise()},storeCurrentBroadcast:function(e,t,r,i,s,o,u){var a={};a.statusFromSwf=!!u;if(t){if(!u&&t<this.attributes.currentBroadcastID)return{};a.isOwnerOfCurrentBroadcast=e,a.currentBroadcastID=t,a.currentBroadcastName=r,a.currentBroadcastPicture=i;if(!e&&s&&s.i&&s.n)s.u?a.currentBroadcastOwner=n.Models.User.newOrUpdate({FName:s.n,UserID:_.toInt(s.i),Picture:s.p}):a.currentBroadcastOwner=n.Models.Artist.newOrUpdate({ArtistName:s.n,ArtistID:_.toInt(s.i),CoverArtFilename:s.p}),a.currentBroadcastOwner.storeCurrentBroadcast(1,t,r,i,null);else if(!e&&s&&(s instanceof n.Models.Artist&&this!==s||s instanceof n.Models.User))a.currentBroadcastOwner=s,s.storeCurrentBroadcast(1,t,r,i);else{a.currentBroadcastOwner=null;if(u){var f=n.Models.Broadcast.getCached(t);f&&f.set("activeStatus",1)}}}else a.isOwnerOfCurrentBroadcast=0,a.currentBroadcastID=null,a.currentBroadcastName=null,a.currentBroadcastPicture=null,a.currentBroadcastOwner=null;return o||this.set(a),a},subscribeToStatus:function(e){this.statusSubLocks||(this.statusSubLocks=[]);if(!this.statusSubLocks.length){var t=this.id;n.Services.SWF.ready.done(function(){n.Services.SWF.connectToChat(),n.Services.SWF.subscribeToArtistsStatuses([t])})}_.indexOf(this.statusSubLocks,e)===-1&&this.statusSubLocks.push(e)},unsubscribeFromStatus:function(e){if(!this.statusSubLocks)return;var t=_.indexOf(this.statusSubLocks,e);t>-1&&this.statusSubLocks.splice(t,1);if(!this.statusSubLocks.length){var r=this.id;n.Services.SWF.ready.done(function(){n.Services.SWF.unsubscribeFromArtistsStatuses([r])})}},unsubscribeAllFromStatus:function(){if(this.statusSubLocks){this.statusSubLocks=[];var e=this.id;n.Services.SWF.ready.done(function(){n.Services.SWF.unsubscribeFromArtistsStatuses([e])})}},isClaimed:function(){return(this.get("Flags")&n.Models.Artist.FLAG_ARTIST_CLAIMED)>0?!0:!1}},{getArtistStatusDfds:{},artPath:"http://images.gs-cdn.net/static/artists/",themeArtPath:"http://images.gs-cdn.net/static/artistthemes/",FLAG_ARTIST_CLAIMED:1,UNKNOWN:5062,tagIgnoredArtistIDs:{5062:!0,55:!0,401329:!0,1174303:!0,1038545:!0},get:function(e,t){var r=Backbone.CachedModel.genericGet.call(this,n.Services.API.getArtistByID,"ArtistID",e,t);return r.promise()},getArtistUrl:function(e,t,r){var i=n.Models.Artist.getCached(e);return i?i.toUrl(r):_.cleanUrl(t,e,"artist",null,r)},getCombinedArtistsStats:function(t,i,s,o){function T(e,r,i){if(!i){r.reject();return}for(g=0;g<p;g++)b=h[g],i[b]||(i[b]={}),b==t?(i[b].Cumulative?v.Cumulative={time:f,data:i[b].Cumulative}:v&&v.Cumulative&&v.Cumulative.data&&(i[b].Cumulative=v.Cumulative.data),a[e]=i[b],v[e]={time:f,data:a[e]},e==="dailyStats"&&(v.statsDaysLoaded=s)):(E=n.Models.Artist.getCached(b),E&&(S=E.get("stats"),S||(S={},E.set("stats",S)),i[b].Cumulative?S.Cumulative={time:f,data:i[b].Cumulative}:S&&S.Cumulative&&S.Cumulative.data&&(i[b].Cumulative=S.Cumulative.data),S[e]={time:f,data:i[b]},e==="dailyStats"&&(S.statsDaysLoaded=s)));r.resolve(i)}function N(e,t,n){if(!n){t.reject();return}v[e]={time:f,data:n},e==="dailySongsStats"&&(v.songStatsDaysLoaded=s),a[e]=n,t.resolve(n)}var u=_.chainLoading(),a={},f=Math.floor($.now()/1e3),l=$.Deferred(),c={},h=i.pluck("ArtistID"),p=h.length,d=n.Models.Artist.getCached(t),v={},m=!1,g,y,b,w,E,S,x;d&&(d.get("stats")?v=d.get("stats"):d.set("stats",v)),s=_.orEqual(s,30),a.days=s,o=_.orEqual(o,!0),x=v.Cumulative;if(!x||x.time<f-3600)m=!0;for(g=0,y=e.length;g<y;g++)w=e[g].type,c[w]||(!v[w]||v[w].time<f-3600||v.statsDaysLoaded<s?c[w]=!0:a[w]=v[w].data);if(o)for(g=0,y=r.length;g<y;g++)w=r[g].type,c[w]||(!v[w]||v[w].time<f-3600||w=="dailySongsStats"&&v.songStatsDaysLoaded<s?c[w]=!0:a[w]=v[w].data);var C;for(g=0,y=e.length;g<y;g++)c[e[g].type]&&(C=$.Deferred(),n.Services.API[e[g].call](h,s,m).done(_.bind(T,this,e[g].type,C)).fail(_.bind(C.reject,C)),u.push(C));for(g=0,y=r.length;g<y;g++)c[r[g].type]&&(C=$.Deferred(),n.Services.API[r[g].call](t,s).done(_.bind(N,this,r[g].type,C)).fail(_.bind(C.reject,C)),u.push(C));return u.done(_.bind(function(){l.resolve(a,v)},this)),u.fail(_.bind(l.reject,l)),l.promise()},getArtistsStatuses:function(e){var t=[],r=0,i=e.length,s=$.Deferred(),o,u;for(;r<i;r++)o=e[r],this.getArtistStatusDfds[userID]?t.push(this.getArtistStatusDfds[userID]):t.push(this.getArtistStatusDfds[userID]=$.Deferred());return n.Services.SWF.ready.done(function(){n.Services.SWF.connectToChat(),n.Services.SWF.chatReady.done(function(){for(r=0;r<i;r++)o=e[r],n.Services.SWF.getArtistStatus(o)})}),$.after(t).done(function(){s.resolve.call(s,_.toArray(arguments)),clearTimeout(u)}),u=setTimeout(_.bind(function(){s.reject()},this),6e3),s},FLAG_CLAIMED:1})}(),function(){function r(e,t,r){if(!r)return i(e,t);r.Data?this.set("pageNameData",r.Data):this.set("pageNameData",{}),r.Name?r.Name.indexOf("/")>-1?this.set("PathName",""):this.set("PathName",r.Name):this.set("PathName",""),r.Data&&r.Data.Tags?this.set("Tags",new n.Models.Collections.Tags(r.Data.Tags)):this.set("Tags",new n.Models.Collections.Tags([])),t==="data"?e.resolve(this.get("pageNameData")):e.resolve(this.get("PathName"))}function i(e,t){this.set({PathName:"",pageNameData:{}}),e.resolve(null)}function s(e,t){var r=u(t,this.attributes.ReleaseType,this.attributes.AlbumID);this.set({songs:new n.Models.Collections.Songs(r.songs),extraSongs:new n.Models.Collections.Songs(r.extraSongs),songsLoaded:!0,defaultTrackSort:r.defaultTrackSort}),e&&e.resolve(this.get("songs"))}function o(e,t){e.reject(t)}function u(e,t,r){var i,s,o,u,a,l,h,p,d,v=[],m=[],g={},y=[],b={},w={},E=0;t=t||!1,_.isArray(e)||(e=[e]);for(i=0,s=e.length;i<s;i++){u=e[i],a=n.Models.Song.newOrUpdate(u),l=a.attributes,v.push(a),p=_.toInt(l.TrackNumsByAlbumID[r]);if(!t||t&&l.IsVerified)E=Math.max(E,p);b[a.id]=p,y[p]?y[p].push(a):y[p]=[a],h=f(a),g.hasOwnProperty(h)?g[h].push(a):g[h]=[a]}i=1;for(i;i<=E;i++){d=y[i];if(!d||!d.length)continue;a=c(d,w,!1);if(!a)continue;h=f(a);if(w[h]&&(!t||!a.attributes.IsVerified)){var S=w[h];if(S.attributes.IsVerified||!a.attributes.IsVerified){a=c(d,w,!0);if(!a)continue;h=f(a)}else{o=_.indexOf(m,S),o!=-1&&m.splice(o,1);var x=c(y[b[S.id]],w,!0);x&&(x.IsVerified=1,w[f(x)]=x)}}m.push(a),w[h]=a}var T,N=!0;return m.length?T=_.difference(v,m):(m=v,T=[],N=!1),{songs:m,extraSongs:T,defaultTrackSort:N}}function f(e){var t=e.get("SongName");t=t.toLowerCase();var n=t.replace(e.get("ArtistName").toLowerCase(),"").replace(a,"");return n.length?t=n:t=t.replace(a,""),t}function c(e,t,n){var r,i;if(!$.isArray(e)||e.length===0)return!1;if(e.length===1)return r=e[0],i=f(r),n&&t[i]?!1:r;e=e.sort(function(e,t){var n=e.attributes.IsVerified,r=t.attributes.IsVerified;if(n!==r)return r-n;var i=l.test(e.SongName),s=l.test(t.SongName);return i===s?0:i&&!s?1:-1});for(var s=0;s<e.length;s++){r=e[s],i=f(r);if(!t[i])return r}return n?!1:e[0]}function h(e,t,n){if(!n)return p(e,n);var r=!1;t.Name&&(t.AlbumName=t.Name,delete t.Name,r=t.AlbumName!==this.get("AlbumName")),this.set(t),r&&this.get("songs")&&_.invoke(this.get("songs").models,"set",{AlbumName:this.get("AlbumName")}),e.resolve(n)}function p(e,t){e.reject(t)}n.Models=n.Models||{};var a=/\s|\-|\:|\(|\)|\[|\]/g,l=/\(|\)|\[|\]|live|feat|\sft|remix|demo/i;n.Models.Album=Backbone.CachedModel.extend({idAttribute:"AlbumID",parse:function(e,r){var i=r||{},s=_.orEqualEx(e.AlbumName,e.albumName,e.Name)||_.getString("UNKNOWN"),o=_.toInt(_.orEqual(e.AlbumID,e.albumID)),a=_.orEqualEx(e.CoverArtFilename,e.ArtFilename,e.artFilename,""),f,l,c,h,p,d,v,m;a&&a.indexOf("default")!==-1&&(a=""),typeof e.ReleaseType!="undefined"&&(f=_.toInt(e.ReleaseType),l=_.toInt(e.ReleaseStatus),typeof e.Year!="undefined"&&(c=_.toInt(e.Year),c||(c=t)),h=e.IsVerified||e.isVerified,h!=="undefined"&&(h=parseFloat(e.IsVerified),h=isNaN(e.IsVerified)?0:e.IsVerified)),typeof e.Flags!="undefined"&&(p=_.toInt(e.Flags));if(i.detailsOnly)return{IsVerified:h,ReleaseType:f,ReleaseStatus:l,Flags:p,Year:c};d=e.songs,v=e.extraSongs,m=e.defaultTrackSort;if(typeof e.songsFromArtist!="undefined"&&!d){var g=u(e.songsFromArtist,f,o);m=g.defaultTrackSort,d=g.songs,v=g.extraSongs}typeof d!="undefined"&&!(d instanceof Backbone.Collection)&&(d=new n.Models.Collections.Songs(d)),typeof v!="undefined"&&!(v instanceof Backbone.Collection)&&(v=new n.Models.Collections.Songs(v));var y={AlbumID:o,AlbumName:s,ArtistID:_.toInt(_.orEqual(e.ArtistID,e.artistID)),ArtistName:_.orEqualEx(e.ArtistName,e.artistName)||_.getString("UNKNOWN_ARTIST"),CoverArtFilename:a,searchText:s.toLowerCase(),isFavorite:!!e.isFavorite||!!i.isFavorite,IsVerified:h,IsVerifiedSongs:e.IsVerifiedSongs,ReleaseType:f,ReleaseStatus:l,Flags:p,Year:c,songs:d,extraSongs:v,defaultTrackSort:m,Popularity:_.toInt(e.Popularity),source:e.source,GenreID:_.defined(e.GenreID)?_.toInt(e.GenreID):t};return y},updateFromNew:function(e,t){var n=_.omitSameKeys(this.attributes,e);e.ArtistName&&this.attributes.ArtistName===_.getString("UNKNOWN_ARTIST")&&(n.ArtistName=e.ArtistName),_.toInt(e.IsVerified)&&(n.IsVerified=1);if(e.isFavorite||t&&t.isFavorite)n.isFavorite=!0;!this.attributes.CoverArtFilename&&e.CoverArtFilename&&(n.CoverArtFilename=e.CoverArtFilename),this.set(n,t)},setSongsFromServer:function(e){if(this.get("songsLoaded"))return;s.call(this,null,e)},getSongs:function(){if(this.loadSongsDfd)return this.loadSongsDfd.promise();var e=$.Deferred(),t=this.get("songs");return this.get("songsLoaded")?e.resolve(t):n.Services.API.albumGetAllSongs(this.id).done(_.bind(s,this,e)).fail(_.bind(o,this,e)),this.loadSongsDfd=e,e.promise()},getExtraSongs:function(){var e=$.Deferred(),t=this.get("extraSongs");return t?e.resolve(t):this.getSongs().done(_.bind(function(){e.resolve(this.get("extraSongs"))},this)).fail(function(t){e.reject(t)}),e.promise()},toUrl:function(e){return this.get("PathName")?_.makeUrlFromPathName(this.get("PathName"),e):_.cleanUrl(this.get("AlbumName"),this.id,"album",null,e)},getPathName:function(){var e=new $.Deferred;return this.pageNameDataDfd&&this.pageNameDataDfd.state()=="pending"?this.pageNameDataDfd.done(_.bind(function(){e.resolve(this.get("PathName"))},this)):typeof this.get("PathName")!="undefined"?e.resolve(this.get("PathName")):n.Services.API.getPageInfoByIDType(this.get("AlbumID"),"album").done(_.bind(r,this,e,"name")).fail(_.bind(i,this,e)),e.promise()},getPageNameData:function(){if(this.pageNameDataDfd&&this.pageNameDataDfd.state()!="rejected")return this.pageNameDataDfd.promise();var e=new $.Deferred;return typeof this.get("pageNameData")!="undefined"?e.resolve(this.get("pageNameData")):n.Services.API.getPageInfoByIDType(this.get("AlbumID"),"album").done(_.bind(r,this,e,"data")).fail(_.bind(i,this,e)),this.pageNameDataDfd=e,e.promise()},getTags:function(){var e=new $.Deferred;return typeof this.get("Tags")!="undefined"?e.resolve(this.get("Tags")):this.getPageNameData().done(_.bind(function(){e.resolve(this.get("Tags"))},this)).fail(e.reject),e.promise()},toArtistUrl:function(e){return n.Models.Artist.getArtistUrl(this.get("ArtistID"),this.get("ArtistName"),e)},getImageURL:function(t){t=_.orEqual(t,70);var r=n.Models.Album.artPath+t+"_album.png";return this.get("CoverArtFilename")&&(r=n.Models.Album.artPath+t+"_"+this.get("CoverArtFilename")),gsConfig.runMode!=="production"&&(r+="?co="+e.location.host),r},getTitle:function(e){return e?['"',this.get("AlbumName"),'" by ',this.get("ArtistName")].join(""):['"',this.escape("AlbumName"),'" by ',this.escape("ArtistName")].join("")},toProxyLabel:function(){var e=this.get("ArtistName")?"SELECTION_ALBUM_SINGLE":"SELECTION_ALBUM_SINGLE_NO_ARTIST";return _.getString(e,{AlbumName:this.escape("AlbumName"),ArtistName:this.escape("ArtistName")})},getAlbumDetails:function(){if(this.loadDetailsDfd)return this.loadDetailsDfd.promise();var e=$.Deferred();return typeof this.get("ReleaseType")!="undefined"?e.resolve(this):(n.Services.API.getAlbumByID(this.id).done(_.bind(function(t){var n=this.parse(t,{detailsOnly:!0});this.set(n),e.resolve(this)},this)).fail(function(t){e.reject(t)}),this.loadDetailsDfd=e),e.promise()},updateLocalInfo:function(e){var t=this.parse(e,{detailsOnly:!0});this.set(t)},updateInfo:function(e){var t=new $.Deferred,r=!1,i={AlbumID:this.get("AlbumID"),ArtistID:this.get("ArtistID"),Name:this.get("AlbumName")+"",Year:_.toInt(this.get("Year")),IsVerified:_.toInt(this.get("IsVerified")),ReleaseType:this.getReleaseTypeForEdit(),ReleaseStatus:_.toInt(this.get("ReleaseStatus")),Flags:_.toInt(this.get("Flags"))};i.Year||(i.Year="");for(var s in e)if(e.hasOwnProperty(s)&&e[s]!==i[s]){r=!0;break}return r?(e=$.extend({},i,e,{ArtistID:this.get("ArtistID"),AlbumID:this.get("AlbumID")}),n.Services.API.artistEditAlbum(e,i).done(_.bind(h,this,t,e)).fail(_.bind(p,this,t))):t.resolve(!0),t.promise()},getDetailsForFeeds:function(){var e={artistID:this.get("ArtistID"),artistName:this.get("ArtistName"),artFilename:this.get("CoverArtFilename"),isVerified:this.get("IsVerified"),albumID:this.get("AlbumID"),albumName:this.get("AlbumName")};return e},getAnchorTag:function(e,t){return'<a href="'+this.toUrl(t)+'" class="album-link">'+(e?_.getString(e).toLocaleLowerCase():this.escape("AlbumName"))+"</a>"},getArtistAnchorTag:function(e,t){return'<a href="'+this.toArtistUrl(t)+'" class="artist-link">'+(e?_.getString(e).toLocaleLowerCase():this.escape("ArtistName"))+"</a>"},getReleaseTypeLocale:function(){var e=this.get("ReleaseType");switch(e){case 1:return"ALBUM_TYPE_FULL_ALBUM";case 2:return"ALBUM_TYPE_SINGLE";case 3:return"ALBUM_TYPE_EP";case 11:return"ALBUM_TYPE_OTHER";case 12:return"ALBUM_TYPE_BROADCAST"}return""},getReleaseTypeForEdit:function(){var e=_.toInt(this.get("Flags")),t=this.get("ReleaseType"),r;return e>0&&t==0&&_.each(n.Models.Album.albumFlagsToType,function(n,i){r=_.toInt(i);if((e&r)==r)return t=n,!1}),t}},{artPath:"http://images.gs-cdn.net/static/albums/",UNKNOWN:92822,get:function(e,t){var r=Backbone.CachedModel.genericGet.call(this,n.Services.API.getAlbumByID,"AlbumID",e,t);return r.promise()},prettySort:function(e,t){return e.get("IsVerified")&&e.get("CoverArtFilename")||e.get("IsVerified")&&!t.get("CoverArtFilename")?-1:t.get("IsVerified")&&t.get("CoverArtFilename")?1:0},popularSort:function(e,t){var n=0,r=0,i,s,o;if(e.get("songs")){i=e.get("songs");for(s=0,o=i.length;s<o;s++)n+=i.at(s).get("Popularity")}if(t.get("songs")){i=t.get("songs");for(s=0,o=i.length;s<o;s++)r+=i.at(s).get("Popularity")}return r-n},experimentalNiftyComparator:function(e){var t=e.attributes.AlbumName||"",n;if(!t.length)n=-20;else{var r=t.toUpperCase().charCodeAt(0),i=t.match(/[\[\]\(\)\{\}]|n\/a|\.(com|net|org|ro|de|ru|co|ws|info|pl|az|fm|vn|hu)|www\.|http\:\/\//ig),s=t.match(/remix|unknown|top.?\d|unofficial|mtv|promo|grammy|no title|blog|album|bootleg|best of|presents|hits|mix|billboard|none|[\=\+]| \d{4}|((cd|vol|disc).{0,2}\d+)/ig);n=(i?i.length*-10:0)+(s?s.length*-3:0)+(t.length<3?-6:0)+(r<65||r>90?-1:0)+r/-1e3}return n*-1},verifiedishFilter:function(e){var t=e.get("songs");return e.attributes.IsVerified==1||e.attributes.IsVerifiedSongs==1||(t instanceof n.Models.Collections.Songs?t.length>=3:!0)},hasSongsFilter:function(e){var t=e.get("songs");return t&&t.length>=1},albumTypes:{0:"ALBUM_TYPE_NONE",1:"ALBUM_TYPE_LP",2:"ALBUM_TYPE_SINGLE",3:"ALBUM_TYPE_EP",4:"ALBUM_TYPE_COMPILATION",5:"ALBUM_TYPE_SOUNDTRACK",6:"ALBUM_TYPE_SPOKENWORD",7:"ALBUM_TYPE_INTERVIEW",8:"ALBUM_TYPE_AUDIOBOOK",9:"ALBUM_TYPE_LIVE",10:"ALBUM_TYPE_REMIX",11:"ALBUM_TYPE_OTHER"},albumFlagsToType:{1:4,2:5,4:6,8:7,16:8,32:9,64:10}})}(),function(){function i(e,t,n){if(!n)return s(e,t);var r=n.Data||{},i=n.Name&&n.Name.indexOf("/")===-1?n.Name:"";this.set({pageNameData:r,pageNameSource:"user",PathName:i}),t==="data"?e.resolve(r):e.resolve(i)}function s(e,t){this.set({PathName:"",pageNameData:{}}),e.resolve(null)}function o(e,t,r){var i=n.Models.Collections[e],s="favorite"+e;if(!i){console.log("favorites returned but invalid collection class??",e),t.reject(r);return}var o={silent:!0};n.getLoggedInUserID()==this.get("UserID")&&(o.isFavorite=!0,e==="Songs"&&(o.fromLibrary=!0));var u=new i(r,o);this.set(s,u),e==="Songs"&&y.call(this),t.resolve(u)}function u(e,t,n){t.reject(n)}function a(e,t,r,i){var s=this.get("library"),o={};n.getLoggedInUserID()==this.get("UserID")&&(o.fromLibrary=!0),s instanceof n.Models.Collections.Songs?e===0?s.reset(i.Songs,o):s.add(i.Songs,o):(s=new n.Models.Collections.Songs(i.Songs,o),this.set("library",s)),i.hasOwnProperty("TSModified")&&this.set("libraryTSModified",i.TSModified);if(i.hasMore===!0){e++;var u=n.Services.API.userGetSongsInLibrary(this.id,e,!r);u.done(_.bind(a,this,e,t,!r)),u.fail(_.bind(f,this,e,t)),u.fail(_.bind(y,this))}else{this.getFavoritesByType("Songs").always(_.bind(function(){y.call(this),t.resolve(s)},this));if(this.get("librarySongsSongIDs")){var l={};s.each(function(e){l[e.id]=1}),this.set({librarySongsSongIDs:l,librarySongsCount:s.length})}}}function f(e,t,n){t.reject(n)}function l(e,t,r){var i={UserID:this.get("UserID"),Username:this.get("Name"),FName:this.get("FName"),LName:this.get("LName")};if(r&&r.Playlists&&_.isArray(r.Playlists))for(var s=0;s<r.Playlists.length;s++)r.Playlists[s]=$.extend(r.Playlists[s],i);var o=new n.Models.Collections.Playlists(r.Playlists),u=!1;t&&r.Playlists.length===t&&(u=!0),this.set({playlists:o,hasMorePlaylists:u}),e.resolve(o)}function c(e,t){e.reject(t)}function h(e,t,r){var i=100,s=new n.Models.Collections.Broadcasts([]),o=!1;r&&r.length&&(s.add(r.slice(1),{activeStatus:0,source:"db"}),s.unshift(r[0],{source:"db"})),t&&r.length===i&&(o=!0),this.set({broadcasts:s,hasMoreBroadcasts:o}),e.resolve(s)}function p(e,t){e.reject(t)}function d(e,t,r,i){if(!i){v(e,t,i);return}if(r){t.resolve(i);return}var s=this.get("followers");if(e!==0&&s instanceof n.Models.Collections.Users)n.getLoggedInUserID()==this.id&&i.each(function(e){e.isFollower=!0}),s.add(i);else{var o={};n.getLoggedInUserID()==this.id&&(o.isFollower=!0),this.set("followers",new n.Models.Collections.Users(i,o))}t.resolve(s)}function v(e,t,n){t.reject(n)}function m(e,t){if(t){var r=new n.Models.Collections.Artists(t);this.set("topArtists",r),e.resolve(r)}else e.reject(t)}function g(e,t){e.reject(t)}function y(){var e=this.get("favoriteSongs"),t=this.get("library");return e instanceof n.Models.Collections.Songs&&t instanceof n.Models.Collections.Songs?(t.add(e.models),!0):!1}function b(e,t,r){if(!r||!r.events){e.reject();return}t&&this.attributes.feed?this.attributes.feed.add(r.events):this.set("feed",new n.Models.Collections.FeedEvents(r.events,{feedType:"model",ownerModel:this,initialPageableItemLimit:25,pageableItemsPerLoad:25,modelOptions:{dontCache:!0}})),e.resolve(this.attributes.feed,r.events)}function w(e){var t=[],r={},i=e.length,s,o;while(i--)s=e[i].songID,o=e[i].listenTime,this.addLocalSongListen(n.Models.Song.newOrUpdate(e[i],{dontCache:!0}),o,!1);t=_.sortBy(settings.local.recentListens,function(e){return e.t[0]*-1})}n.Models=n.Models||{},n.Models.User=Backbone.CachedModel.extend({favoriteSongsDfd:null,favoriteArtistsDfd:null,libraryDfd:null,playlistsDfd:null,followersDfd:null,topArtistsDfd:null,feedDfd:null,recentListensDfd:null,idAttribute:"UserID",parse:function(e,t){var n=t||{},r=[],i=_.orEqualEx(e.FName,e.fName,e.Name,e.userName,e.UserName,e.displayName,""),s=_.orEqual(e.LName,e.lName),o=!1,u;u=i+(s&&s.length?" "+s:"");if(u===""||u&&$.trim(u)==="")o=!0,u=i="New User";e.City&&r.push(e.City),e.State&&r.push(e.State),e.Country&&r.push(e.Country),r.length?r=r.join(", "):r="";var a={UserID:_.toInt(_.orEqual(e.UserID,e.userID))||-1,FName:i||e.displayName,LName:s,Name:u,hasDefaultName:o,searchText:u.toLowerCase(),Location:r,City:e.City,State:e.State,Country:e.Country,Email:_.orEqual(e.Email,e.email),Sex:_.orEqual(e.Sex,e.sex),IsPremium:_.toInt(_.orEqual(e.IsPremium,e.isPremium)),TSDOB:_.orEqual(e.TSDOB,e.tsDOB),Flags:_.toInt(_.orEqual(e.Flags,e.flags)),Picture:e.Picture||e.userPicture,About:e.About,TSAdded:e.TSAdded,FollowingFlags:e.FollowingFlags,SimilarFriendsCount:e.SimilarFriendsCount,pageNameData:e.pageNameData,pageNameSource:e.pageNameSource,isFavorite:!!_.toInt(e.IsFavorite)||!!n.isFavorite,TSFavorited:e.TSFavorited,isFollower:!!_.toInt(e.IsFollower)||!!n.isFollower,isAuth:!!_.orEqual(e.isAuth,!1),nowPlayingSong:_.orEqual(e.nowPlayingSong,null),estimatedBroadcastListens:_.toInt(e.estimatedBroadcastListens||e.pageNameData&&e.pageNameData.BroadcastListens),canBroadcastInvite:_.orEqual(e.canBroadcastInvite,!0),broadcastInviteTime:_.toInt(e.broadcastInviteTime),canBroadcastInviteEmail:_.orEqual(e.canBroadcastInviteEmail,!0),broadcastInviteTimeEmail:_.toInt(e.broadcastInviteTimeEmail),PathName:e.PathName,friendsLinked:e.friendsLinked,contextArtistID:e.contextArtistID,isArtist:e.isArtist,artistID:e.artistID,profileID:e.profileID,permissions:e.permissions};return a},initialize:function(e,t){return this.on("change:pageNameData",this.resetEstimatedListens,this),Backbone.CachedModel.prototype.initialize.call(this,e,t)},destroy:function(e){return this.off("change:pageNameData",this.resetEstimatedListens,this),Backbone.CachedModel.prototype.destroy.call(this,e)},resetEstimatedListens:function(){var e=_.orEqual(this.get("pageNameData"),{}),t=_.toInt(e.BroadcastListens);this.set("estimatedBroadcastListens",t)},incrementEstimatedListens:function(e){e=_.toInt(e);var t=_.toInt(this.get("estimatedBroadcastListens"));this.set("estimatedBroadcastListens",t+e)},updateFromNew:function(e,t){var n=_.omitSameKeys(this.attributes,e),r=!t||t.updateProfile!==!1;e.hasOwnProperty("friendsLinked")&&(this.friendsLinked=e.friendsLinked),!e.hasDefaultName&&(r||this.attributes.hasDefaultName)&&(e.Name?n.FName=n.Name=e.Name:e.FName&&(n.FName=n.Name=e.FName)),e.Picture&&(r||!e.Picture)&&(n.Picture=e.Picture),typeof e.FollowingFlags!="undefined"&&e.FollowingFlags!==null&&(n.FollowingFlags=e.FollowingFlags),e.pageNameData&&(e.pageNameSource=="user"||this.attributes.pageNameSource!="user")&&(n.pageNameData=e.pageNameData,e.pageNameData.BroadcastListens&&this.resetEstimatedListens());if(_.toInt(e.IsFavorite)||e.isFavorite||t&&t.isFavorite)n.isFavorite=!0;if(_.toInt(e.IsFollower)||e.isFollower||t&&t.isFollower)n.isFollower=!0;this.set(n,t)},toUrl:function(e){var t=this.get("PathName")||"",r=this.get("artistID"),i=r&&n.Models.Artist.getCached(r);return i&&i.get("PathName")&&(t=i.get("PathName")),t&&t.indexOf("/")===-1?_.makeUrlFromPathName(t,e):_.cleanUrl(this.id?this.get("Name"):"New User",this.id,"profile",null,e)},getPathName:function(){var e=new $.Deferred;return this.pageNameDataDfd&&this.pageNameDataDfd.state()=="pending"?this.pageNameDataDfd.done(_.bind(function(){e.resolve(this.get("PathName"))},this)):typeof this.get("PathName")!="undefined"?e.resolve(this.get("PathName")):n.Services.API.getPageInfoByIDType(this.get("UserID"),"user").done(_.bind(i,this,e,"name")).fail(_.bind(s,this,e)),e.promise()},getPageNameData:function(){if(this.pageNameDataDfd&&this.pageNameDataDfd.state()!="rejected")return this.pageNameDataDfd.promise();var e=new $.Deferred;return typeof this.get("pageNameData")!="undefined"?e.resolve(this.get("pageNameData")):n.Services.API.getPageInfoByIDType(this.get("UserID"),"user").done(_.bind(i,this,e,"data")).fail(_.bind(s,this,e)),this.pageNameDataDfd=e,e.promise()},getImageURL:function(t,r){t!==""&&(t=_.orEqual(t,70)+"_");var i=this.get("isArtist")?n.Models.Artist.artPath+t+"artist.png":n.Models.User.artPath+t+"user.png";return this.get("Picture")&&(!r||!r.defaultPicture)&&(i=n.Models.User.artPath+t+this.get("Picture")),gsConfig.runMode!=="production"&&(i+="?co="+e.location.host),i},getThemeImageURL:function(){var e=this.get("pageNameData"),t=new $.Deferred;return e?e&&e.ThemeOptions&&e.ThemeOptions.Image?t.resolve(n.Models.User.themeArtPath+e.ThemeOptions.Image):t.reject():this.getPageNameData().done(function(r){e=r,e&&e.ThemeOptions&&e.ThemeOptions.Image?t.resolve(n.Models.User.themeArtPath+e.ThemeOptions.Image):t.reject()}).fail(function(){t.reject()}),t.promise()},getTitle:function(e){return e?this.get("FName"):this.escape("FName")},getShortName:function(){var e="",t=this.get("Name");if(t.length>12){var n=t.split(" ");for(var r=0;r<n.length;r++){if(!(e.length===0||n[r].length<10&&e.length<12))return e;e.length&&(e+=" "),e+=n[r]}return e>12?e.substr(0,12)+"&hellip;":e}return t},getFavoritesByType:function(e){if(this["favorite"+e+"Dfd"])return this["favorite"+e+"Dfd"].promise();var t=$.Deferred(),r=this.get("favorite"+e);if(r)t.resolve(r);else{var i=function(){this.id<=0?(r=new n.Models.Collections[e]([]),this.set("favorite"+e,r),t.resolve(r)):(n.Services.API.getFavorites(this.id,e).done(_.bind(o,this,e,t)).fail(_.bind(u,this,e,t)),this["favorite"+e+"Dfd"]=t)};this.get("oldUserClean")?this.get("oldUserClean").done(_.bind(i,this)):i.call(this)}return t.promise()},getLibrary:function(e){e=_.orEqual(e,!1);if(this.libraryDfd&&this.libraryDfd.state()!=="rejected")return this.libraryDfd.promise();var t=$.Deferred(),r=this.get("library");return r?t.resolve(r):this.id<=0?(r=new n.Models.Collections.Songs([]),this.set({library:r,libraryTSModified:0}),t.resolve(r)):(n.Services.API.userGetSongsInLibrary(this.id,0,!e).done(_.bind(a,this,0,t,e)).fail(_.bind(f,this,0,t)),this.getFavoritesByType("Songs"),this.libraryDfd=t),t.promise()},getLibraryCount:function(){var e=this.get("library");if(e)return e.length;var n=this.get("librarySongsCount");if(n!==t)return n;var r=this.get("pageNameData");if(r)return _.toInt(r.LibrarySongCount)},getFavoriteSongsSongIDs:function(){if(this.favoriteSongIDsDfd&&this.favoriteSongIDsDfd.state()!=="rejected")return this.favoriteSongIDsDfd.promise();var e=this.favoriteSongIDsDfd=$.Deferred(),r=this.get("favoriteSongsSongIDs"),i=this;if(r)e.resolve(r);else{r={};function s(s){var o=i.get("librarySongsSongIDs"),u=i.get("librarySongsCount");for(var a=0,f=s.length,l,c;a<f;a++)l=s[a],l&&(r[l]=1,c=n.Models.Song.getCached(l),c&&c.set("isFavorite",!0),o!==t&&o[l]!==1&&(o[l]=1,u++));i.set({favoriteSongsSongIDs:r,favoriteSongsCount:s.length,librarySongsCount:u}),e.resolve(r)}var o=this.get("favoriteSongs");if(o)s(o.pluck("SongID"));else{var u=_.chainLoading();u.push(this.getLibrarySongIDs()),u.push(n.Services.API.userGetFavoriteSongsSongIDs(this.get("UserID")).done(u.bind(function(t){if(!t){e.reject();return}s(t)},this)).fail(u.bind(e.reject,e)))}}return e.promise()},getFavoriteSongsCount:function(){var e=this.get("favoriteSongs");if(e)return e.length;var n=this.get("favoriteSongsCount");if(n!==t)return n;var r=this.get("pageNameData");if(r)return _.toInt(r.FavoriteSongCount)},getPlaylists:function(e){if(this.playlistsDfd&&this.playlistsDfd.state()!=="rejected"&&this.playlistsDfd._limitSpecified>=e)return this.playlistsDfd.promise();var t=$.Deferred(),r=this.get("playlists");return r&&(!this.get("hasMorePlaylists")||e>0&&e<r.length)?t.resolve(r):this.id<=0?(r=new n.Models.Collections.Playlists([]),this.set({playlists:r}),t.resolve(r)):(n.Services.API.userGetPlaylists(this.id,e).done(_.bind(l,this,t,e)).fail(_.bind(c,this,t)),this.playlistsDfd=t,this.playlistsDfd._limitSpecified=e),t.promise()},getLinks:function(){var e=this.get("pageNameData"),t=this.get("PathName"),r=this.get("artistID"),i=r&&n.Models.Artist.getCached(r),s;return i&&(e=i.get("pageNameData"),t=i.get("PathName")),s=e&&e.URLs||{},{grooveshark:t||"",twitter:s.tw||"",facebook:s.fb||"",site:s.site||""}},getBroadcasts:function(e,t){t=Math.min(1,_.toInt(t));var r=100,i=(t-1)*r;if(this.broadcastsDfd&&this.broadcastsDfd.state()!=="rejected"&&this.broadcastsDfd._limitSpecified>=i)return this.broadcastsDfd.promise();var s=$.Deferred(),o=this.get("broadcasts");return!e&&o&&(!this.get("hasMoreBroadcasts")||i<o.length)?s.resolve(o):this.id<=0?(o=new n.Models.Collections.Broadcasts([]),this.set({broadcasts:o}),s.resolve(o)):(n.Services.API.getUserBroadcasts(this.id,t).done(_.bind(h,this,s,t)).fail(_.bind(p,this,s)),this.broadcastsDfd=s,this.broadcastsDfd._limitSpecified=i),s.promise()},getFollowers:function(e){if(this.followersDfd&&this.followersDfd.state()!=="rejected")return this.followersDfd.promise();var t=$.Deferred(),r=this.get("followers");if(r)t.resolve(r);else{var i=function(){this.id<=0?(r=new n.Models.Collections.Users([]),this.set({followers:r}),t.resolve(r)):e?n.Services.API.userGetFollowersEx(this.id).done(_.bind(d,this,0,t,!0)).fail(_.bind(v,this,0,t,!0)):(n.Services.API.userGetFollowersEx(this.id).done(_.bind(d,this,0,t,!1)).fail(_.bind(v,this,0,t)),this.followersDfd=t)};this.get("oldUserClean")?this.get("oldUserClean").done(_.bind(i,this)):i.call(this)}return t.promise()},getIntersectingFollowers:function(){var e=$.Deferred();return this.getFollowers(!0).done(_.bind(function(t){var i=r.model.get("user").get("favoriteUsers"),s=r.model.get("user").get("favoriteUsers").pluck("UserID"),o=_.pluck(t,"UserID");for(var u=0,a=o.length;u<a;u++)o[u]=_.toInt(o[u]);var f=_.intersection(s,o),l=[];for(var u=0;u<f.length;u++)l.push(i.get(f[u]));e.resolve(new n.Models.Collections.Users(l))},this)),e.promise()},getDetailsForFeeds:function(){return{userID:this.get("UserID"),userName:this.get("FName"),isPremium:this.get("IsPremium"),location:this.get("Location"),userPicture:this.get("Picture")}},getAnchorTag:function(e,t,n){return n?'<a class="user-link open-profile-card" data-user-id="'+this.get("UserID")+'">'+(e?_.getString(e).toLocaleLowerCase():_.escape(this.get("Name")))+"</a>":'<a href="'+this.toUrl(t)+'" class="user-link">'+(e?_.getString(e).toLocaleLowerCase():_.escape(this.get("Name")))+"</a>"},getTopArtists:function(){if(this.topArtistsDfd&&this.topArtistsDfd.state()!=="rejected")return this.topArtistsDfd.promise();var e=$.Deferred(),t=this.get("topArtists");return t?e.resolve(t):this.id<=0?(t=new n.Models.Collections.Artists([]),this.set({topArtists:t}),e.resolve(t)):(n.Services.API.getUserTopArtists(this.get("UserID")).done(_.bind(m,this,e)).fail(_.bind(g,this,e)),this.topArtistsDfd=e),e.promise()},getFeed:function(e){if(this.feedDfd&&this.feedDfd.state()!=="rejected"&&!e)return this.feedDfd.promise();var t=$.Deferred();if(this.get("feed")&&!e)t.resolve(this.get("feed"),[]);else if(this.id<=0)i=new n.Models.Collections.FeedEvents([]),this.set({feed:i}),t.resolve(i,[]);else{var r=null;if(e){var i=this.get("feed");i&&i.length&&(r=i.last().get("timestamp"))}this.feedDfd=t,n.Services.API.getProfileFeedForItem(this.id,"user",r).done(_.bind(b,this,t,e)).fail(_.bind(this.feedDfd.reject,this.feedDfd))}return t.promise()},getRecentListens:function(){if(this.recentListensDfd&&this.recentListensDfd.state()!=="rejected")return this.recentListensDfd.promise();var e=$.Deferred(),t=[];return this.id<=0?(t=new n.Models.Collections.Songs([]),this.set({recentListens:t}),e.resolve(t)):(this.getListens().done(_.bind(function(r){r=r||[];var i=10,s=200,o=[],u=[],a={},f={},l={},c=r.length,h,p,d,v;while(c--)v=r[c].SongID,p=r[c].listenTime,a[v]?d=a[v]:(d=n.Models.Song.newOrUpdate(_.clone(r[c])),a[v]=d),u.push(d),l[v]&&p-l[v].o.t[0]<86400?(h=l[v].o,h.t.length>=i&&h.t.splice(i-1,h.t.length-(i-1)),h.t.unshift(p),o[l[v].i]=null,l[v].i=o.length,o.push(h)):(h={s:d.archiveAttr(),t:[p]},l[v]={i:o.length,o:h},o.push(h));c=o.length;while(c--&&s){if(!o[c])continue;t.push(o[c]),s--}f.recentListens=t,this instanceof n.Models.AuthUser&&this.get("settings")&&this.saveLocalSettings(f),this.set({localRecentListens:f.recentListens});var m=[];c=u.length;while(c--)m.push(u[c]);e.resolve(new n.Models.Collections.Songs(m))},this)).fail(_.bind(e.reject,e)),this.recentListensDfd=e),e.promise()},getListens:function(){if(this.listensDfd&&this.listensDfd.state()!=="rejected")return this.listensDfd.promise();this.listensDfd=new $.Deferred;if(this.get("listens"))this.listensDfd.resolve(this.get("listens"));else{var e=this.listensDfd;n.Services.API.getUserRecentListens(this.get("UserID")).done(_.bind(function(t){var n=[];for(var r=0,i=t.length,s;r<i;r++)s=t[r],n[r]={AlbumName:s.al,AlbumID:s.alid,ArtistName:s.ar,ArtistID:s.arid,listenDataKey:s.dk,SongName:s.s,SongID:s.sid,TagIDs:s.tids,listenTime:s.ts,client:s.c,CoverArtFilename:s.i};this.set("listens",n),e.resolve(n)},this)).fail(function(){e.reject()})}return this.listensDfd.promise()},getLocalRecentListens:function(){var e=this.getRawLocalRecentListens()||[],t=new n.Models.Collections.Songs,r=[];for(var i=0,s=e.length;i<s;i++)r.push(e[i].attrs);return t.add(r),t},getRawLocalRecentListens:function(e){var t=this.get("settings"),r=[],i=_.isArray(e)?e:t&&t.local&&t.local.recentListens;return _.isArray(i)&&i.length&&_.each(i,function(e){var t=n.Models.Song.unarchiveSongAttributes(e.s);r.push({attrs:t,SongID:t.SongID,ArtistID:t.ArtistID,timestamps:e.t})}),r},getPersonalizedTags:function(e){function m(e,t){var r,i;for(r=0,i=e.length;r<i;r++){p=_.toInt(e[r]instanceof n.Models.Tag?e[r].id:e[r]);if(!p||_.indexOf(f,p)!==-1)continue;s[p]?s[p][1].push(t):s[p]=[p,[t]]}}var t=this.get("personalizedTags"),r=$.Deferred(),i=this.getRawLocalRecentListens()||[];t={},e=_.orEqual(e,{}),e.useRandomness=_.orEqual(e.useRandomness,!0);var s={},o={},u=e.defaultTags||[],a=u.slice(0),f=e.blacklist||[],l,c,h,p,d,v;for(d=0,v=i.length;d<v;d++){if(o[i[d].SongID])continue;c=n.Models.Song.newOrUpdate(i[d].attrs),l=i[d].timestamps;if(!c||l&&l.length&&l[0]<1349917200)continue;o[c.id]=!0,h=c.get("Tags"),h&&h.length?h=h.models:h=c.get("TagIDs"),h&&h.length&&m(h,c)}var g={},y=n.Views.Pages.Tags.lowIDFs;for(d=0,v=n.Models.Tag.topGenres.length;d<v;d++)g[n.Models.Tag.topGenres[d].tagID]=1;var b=_.sortBy(_.toArray(s),function(t){var n=1,r=e.useRandomness?Math.random():1;if(g[t[0]])n=.3;else{var i=_.indexOf(y,t[0]);i!==-1&&(n=Math.min(.6,Math.max(.3,i/y.length)))}var s=_.indexOf(a,t[0]);return s!=-1&&a.splice(s,1),t[1].length>1?(Math.pow(r*t[1].length,1.2)+10)*-1*n:-1*n});return r.resolve(b),r},getPersonalizedSongs:function(e,t){e=_.orEqual(e,!1);var r=_.chainLoading(),i=[],s=$.Deferred(),o=$.now()/1e3;this instanceof n.Models.AuthUser||(t=!0),!this.get("librarySongsSongIDs")&&this.get("library")||t?r.push(this.getLibrary()):r.push(this.getLibrarySongIDs()),!this.get("favoriteSongsSongIDs")&&this.get("favoriteSongs")||t?r.push(this.getFavoritesByType("Songs")):r.push(this.getFavoriteSongsSongIDs()),this.id<=0&&(e=!0);if(e){i=this.getRawLocalRecentListens();if(i.length){var u=i[0].timestamps[0];this.id&&o-u>14400&&(i=[])}}else r.push(this.getTopArtists());i.length||r.push(this.getRecentListens().done(r.bind(function(){var e=this.get("localRecentListens");e&&(i=this.getRawLocalRecentListens(e))},this)));var a=function(e){var t=100,n=20,r=.25,i=n*(1+r),s=Math.E,o=Math.pow;return parseInt(1+(t-1)/o(1+n*o(s,-r*e+t*n/e),1/i),10)},f=_.bind(function(){var e=this.get("library"),t=this.get("librarySongsSongIDs"),r=this.get("topArtists")||new n.Models.Collections.Artists,o={},u={},f=0,l=0,c=[],h={},p=[],d=14400,v=86400,m=v*3,g=v*7*2,y=3,b={},w,E,S,x,T,N,C,k,L;i&&i.length&&(f=i[0].timestamps[0],l=f);for(w=0,E=i.length;w<E;w++)C=i[w],k=f-C.timestamps[0],l-C.timestamps[0]>d&&(h={},l=C.timestamps[0]),x=C.SongID,T=C.ArtistID,b[x]?S=b[x]:(S=n.Models.Song.newOrUpdate(C.attrs),b[S.id]=S),p.push(S),N=C.timestamps&&C.timestamps.length,(!h[T]||h[T]<y)&&k<g&&(u[T]||(u[T]=[]),u[T].push(S),h[T]?h[T]++:h[T]=1),L=a(Math.max(((k<m?30:0)+(70-k/v))*N)),o[x]?o[x]+=L:o[x]=L;var A=new n.Models.Collections.Songs(p.concat(e?e.models:[])),O=1,M=[],D=Math.random()*15+15,P=27,H=Math.random()*27+P,B=r.length,j;for(w=0,E=A.length;w<E;w++)S=A.models[w],T=S.attributes.ArtistID,x=S.attributes.SongID,L=Math.random()*20,O=1,o[x]&&(L+=o[x]/100*H,o[x]>22&&(O-=.3)),u[T]&&u[T].length>1&&(L+=Math.min(40,u[T].length/2*D*O),O-=.3),B&&(j=r.indexOf(T))!=-1&&(L+=Math.max(0,(B-j)/B*20)*O,O-=.1),(e&&e.indexOf(S)!==-1||t&&t[x])&&L<50&&(L+=10*O),L=a(L),M.push([S,L]);M=_.sortBy(M,function(e){return e[1]=Math.floor(Math.random()*e[1]+Math.random()*10),e[1]*-1}),_.each(M,function(e){c.push(e[0])}),c=new n.Models.Collections.Songs(c);var F=[];_.each(u,function(e,t){F.push([t,e.length])}),F=_.sortBy(F,1).reverse(),this.set({dominateRecentArtists:u,dominateRecentArtistsSorted:F}),s.resolve(c),this instanceof n.Models.AuthUser&&n.trigger("authUser:personalizedSongsLoaded")},this);return r.done(f).fail(function(){s.reject()}),s},getBroadcastOptionMenu:function(e,t,r,i){var s=this,o=e.get("invitedBroadcasters"),u=this.get("UserID"),a=e.get("bannedUserIDs"),f=a&&a[u],l=e.isUserVIP(u),c=[];return f?c.push({key:"LISTENER_MENU_UNBLOCK",title:_.getString("LISTENER_MENU_UNBLOCK"),action:{type:"fn",callback:_.bind(e.unBanListener,e,s)}}):r!=="owner"&&r!=="admin"&&!l&&c.push({key:"LISTENER_MENU_BLOCK",title:_.getString("LISTENER_MENU_BLOCK"),action:{type:"fn",callback:_.bind(e.banListener,e,s,i)}}),(!o||!o.get(this.id))&&r!=="owner"&&e.isLoggedInUserOwner()&&c.push({key:"MAKE_BROADCAST_OWNER",title:_.getString("MAKE_BROADCAST_OWNER"),action:{type:"fn",callback:function(){function t(){n.trigger("lightbox:close","broadcastListeners")}n.trigger("lightbox:open","broadcastTransferOwnership",{user:s,broadcast:e,endBroadcast:this.endBroadcastOnTransfer,onSuccess:t})}}}),e.isLoggedInUserOwner()&&(l?c.push({key:"LISTENER_MENU_DEMOTE",title:_.getString("LISTENER_MENU_DEMOTE"),action:{type:"fn",callback:_.bind(e.removeVIPUser,e,s.get("UserID"))}}):r!=="owner"&&c.push({key:"LISTENER_MENU_PROMOTE",title:_.getString("LISTENER_MENU_PROMOTE"),action:{type:"fn",callback:function(){var t=n.Models.Broadcast.VIP_PERM_AUTO_APPROVE;t|=n.Models.Broadcast.VIP_PERM_SUGGESTIONS,t|=n.Models.Broadcast.VIP_PERM_CHAT_MODERATE,t|=n.Models.Broadcast.VIP_PERM_METADATA,t|=n.Models.Broadcast.VIP_PERM_FEATURES,t|=n.Models.Broadcast.VIP_PERM_CALLOUTS,e.addVIPUser(s.get("UserID"),0,t)}}})),c},getVIPPermissionsMenu:function(e){var t=this.get("UserID"),r=e.getPermissionsForUserID(t),i=[{locale:"VIP_MENU_PERM_CHAT_MODERATE",flag:n.Models.Broadcast.VIP_PERM_CHAT_MODERATE},{locale:"VIP_MENU_PERM_FEATURES",flag:n.Models.Broadcast.VIP_PERM_FEATURES},{locale:"VIP_MENU_PERM_SUGGESTIONS",flag:n.Models.Broadcast.VIP_PERM_SUGGESTIONS},{locale:"VIP_MENU_PERM_AUTO_APPROVE",flag:n.Models.Broadcast.VIP_PERM_AUTO_APPROVE},{locale:"VIP_MENU_PERM_CALLOUTS",flag:n.Models.Broadcast.VIP_PERM_CALLOUTS},{locale:"VIP_MENU_PERM_METADATA",flag:n.Models.Broadcast.VIP_PERM_METADATA}];return i=_.map(i,function(n){var i=n.flag&r?"check icon-check-orange-flat":"";return{key:n.locale,title:'<i class="icon '+i+'"></i> '+_.getString(n.locale),altText:_.getString(n.locale),action:{type:"fn",callback:function(){e.addVIPUser(t,0,n.flag^r)}}}}),i},getCurrentStatus:function(){var e=this.get("UserID"),t=n.Models.User.getUserStatusDfds[e];if(!t||t.state()!=="pending"){t=$.Deferred();var r=setTimeout(function(){n.Models.User.getUserStatusDfds[e]&&n.Models.User.getUserStatusDfds[e].reject()},3e3);t.always(function(){delete n.Models.User.getUserStatusDfds[e],clearTimeout(r)}),n.Services.SWF.ready.done(function(){n.Services.SWF.connectToChat(),n.Services.SWF.chatReady.done(function(){n.Services.SWF.getUserStatus(e)})}),n.Models.User.getUserStatusDfds[e]=t}return t.promise()},storeCurrentBroadcast:function(e,t,r,i,s,o,u){var a={};a.statusFromSwf=!!u;if(t){if(!u&&t<this.attributes.currentBroadcastID)return{};a.onlineStatus=!0,a.isOwnerOfCurrentBroadcast=e,a.currentBroadcastID=t,a.currentBroadcastName=r,a.currentBroadcastPicture=i;if(!e&&s&&s.i&&s.n)s.u?a.currentBroadcastOwner=n.Models.User.newOrUpdate({FName:s.n,UserID:_.toInt(s.i),Picture:s.p}):a.currentBroadcastOwner=n.Models.Artist.newOrUpdate({ArtistName:s.n,ArtistID:_.toInt(s.i),CoverArtFilename:s.p}),a.currentBroadcastOwner.storeCurrentBroadcast(1,t,r,i,null);else if(!e&&s&&(s instanceof n.Models.User&&this!==s||s instanceof n.Models.Artist))a.currentBroadcastOwner=s,s.storeCurrentBroadcast(1,t,r,i);else{a.currentBroadcastOwner=null;if(u){var f=n.Models.Broadcast.getCached(t);f&&f.set("activeStatus",1)}}}else a.isOwnerOfCurrentBroadcast=0,a.currentBroadcastID=null,a.currentBroadcastName=null,a.currentBroadcastPicture=null,a.currentBroadcastOwner=null;if(o)return a;this.set(a)},addStatusLock:function(e){this.statusSubLocks||(this.statusSubLocks=[]),_.indexOf(this.statusSubLocks,e)===-1&&this.statusSubLocks.push(e)},subscribeToStatus:function(e){var t=this.id,r=!1,i;return this.statusSubLocks||(this.statusSubLocks=[]),n.Models.User.getUserStatusDfds[t]||(n.Models.User.getUserStatusDfds[t]=$.Deferred(),r=!0),i=n.Models.User.getUserStatusDfds[t],this.subActionStarted?(r&&i.resolve(),_.indexOf(this.statusSubLocks,e)===-1&&this.statusSubLocks.push(e)):(this.subActionStarted=!0,n.Services.SWF.ready.done(function(){n.Services.SWF.connectToChat(),n.Services.SWF.chatReady.done(function(){n.Services.SWF.subscribeToUsersStatuses([t]);var e=setTimeout(function(){n.Models.User.getUserStatusDfds[t]&&n.Models.User.getUserStatusDfds[t].reject()},3e3);i.always(function(){delete n.Models.User.getUserStatusDfds[t],clearTimeout(e)})})}),this.statusSubLocks.push(e)),i.promise()},unsubscribeFromStatus:function(e){if(!this.statusSubLocks)return;var t=_.indexOf(this.statusSubLocks,e);t>-1&&this.statusSubLocks.splice(t,1);if(!this.statusSubLocks.length&&!this.get("isFavorite")){this.subActionStarted=!1;var r=this.id;n.Services.SWF.chatReady.done(function(){n.Services.SWF.unsubscribeFromUsersStatuses([r])})}},unsubscribeAllFromStatus:function(){if(this.statusSubLocks){this.statusSubLocks=[];if(this.get("isFavorite"))return;var e=this.id;n.Services.SWF.chatReady.done(function(){n.Services.SWF.unsubscribeFromUsersStatuses([e])})}}},{getUserStatusDfds:{},artPath:"http://images.gs-cdn.net/static/users/",themeArtPath:"http://images.gs-cdn.net/static/userthemes/",get:function(e,t){var r,i;if(e==n.getLoggedInUserID()&&(i=n.Models.AuthUser.getCached(e)))r=new $.Deferred,r.resolve(i);else{var s=function(e){var t=new $.Deferred;return n.Services.API.getUserByID(e).done(function(e){e=e.User||{},t.resolve(e)}).fail(_.bind(t.reject,t)),t.promise()};r=Backbone.CachedModel.genericGet.call(this,s,"UserID",e,t)}return r.promise()},getCached:function(e){var t,i=typeof r!="undefined"&&r.model&&r.model.get("user"),s=i&&i.id;return e==s&&this!==n.Models.AuthUser?t=n.Models.AuthUser.getCached(e):t=Backbone.CachedModel.getCached.call(this,e),t},getUsersStatuses:function(e,t){var r=[],i=0,s=e.length,o=$.Deferred(),u,a;for(;i<s;i++)u=e[i],this.getUserStatusDfds[u]?r.push(this.getUserStatusDfds[u]):r.push(this.getUserStatusDfds[u]=$.Deferred());return n.Services.SWF.ready.done(function(){n.Services.SWF.connectToChat(),n.Services.SWF.chatReady.done(function(){n.Services.SWF.getUsersStatuses(e,t)})}),$.after(r).done(function(){o.resolve.call(o,_.toArray(arguments)),clearTimeout(a)}),a=setTimeout(_.bind(function(){o.reject()},this),6e3),o},pictureNameSort:function(e,t){if(e.attributes.Picture&&!t.attributes.Picture)return-1;if(t.attributes.Picture&&!e.attributes.Picture)return 1;var n=e.attributes.Name,r=t.attributes.Name;return n&&r?(n=n.toLowerCase(),r=r.toLowerCase(),n<r?-1:n===r?0:1):n?-1:r?1:0},niftyFriendSort:function(e,t){var r=e.get("isFavorite"),i=t.get("isFavorite");if(r&&i){var s=e.get("isFollower"),o=t.get("isFollower");if(s&&!o)return-1;if(o&&!s)return 1}else{if(r)return-1;if(i)return 1}return n.Models.User.pictureNameSort(e,t)},addListenToRecentListensArray:function(e,t,n){var r=10,i=200,s=_.isArray(e)?e:[],o,u,a,f,l;if(!t||!n)return s;a=-1,l=t.get("SongID");for(o=0,u=s.length;o<u;o++){if(n-s[o].t[0]>86400)break;if(s[o].s.I==l){a=o;break}}return a!==-1?(f=s[a],f.t.length>=r&&f.t.splice(r-1,f.t.length-(r-1)),f.t.unshift(n),s.splice(a,1)):f={s:t.archiveAttr(),t:[n]},s.unshift(f),s.splice(i,s.length-i),s},FLAG_PLUS:1,FLAG_LASTFM:2,FLAG_FACEBOOK:4,FLAG_FACEBOOKUSER:16,FLAG_GOOGLEUSER:32,FLAG_GOOGLE:64,FLAG_ANYWHERE:128,FLAG_ISARTIST:256,FLAG_MUSIC_BUSINESS:1024,FLAG_TWITTER:4096,FLAG_TWITTERUSER:8192,FLAG_LITE:32768,FLAG_KINESIS:16384,FLAG_OWNS_ARTIST:65536,FLAG_FLATTR:131072,FLAG_VERIFIED_EMAIL:524288,FLAG_HAS_NEW_SUB:1048576,FLAG_HAS_SPECIAL_PRICE:2097152,FLAG_ARTIST_PROFILE:4194304,FOLLOWERS_FLAG_DISABLE_BROADCAST_UPDATES:2,FLAG_EMAIL_ENABLE_ALL:0,FLAG_EMAIL_DISABLE_FOLLOWED:1,FLAG_EMAIL_DISABLE_INVITESIGNUP:2,FLAG_EMAIL_DISABLE_SHARE:8,FLAG_EMAIL_DISABLE_PLAYLISTSUBSCRIBE:16,FLAG_EMAIL_DISABLE_COMMENT:32,FLAG_EMAIL_DISABLE_PRIVATEMESSAGE:128,FLAG_EMAIL_DISABLE_ANNOUNCEMENTS:4096,FLAG_EMAIL_DISABLE_CIVICSCIENCE:32768,FLAG_EMAIL_DISABLE_KINESIS:65536,FLAG_EMAIL_DISABLE_THIRDPARTY_FRIENDS:131072,FLAG_EMAIL_DISABLE_BROADCAST:262144,FLAG_EMAIL_DISABLE_ARTIST_UPDATE:524288})}(),function(){function i(e,t){if(!t)this.set("artistsOwned",t),e.reject();else{var r=new n.Models.Collections.Artists(t);r.comparator=_.getModelSort("ArtistName",!0),this.set("artistsOwned",r);var i=!n.Services.Local.get("gs.contextTopHat")&&r.length&&(r.length>1||!this.get("artistID"))&&!$("#top-hat-notif.notif").length;i&&setTimeout(_.bind(function(){n.trigger("tophat:open",{name:"context",template:"contextTopHat",templateVars:{user:this}}),n.once("switchUser",function(){n.trigger("tophat:close")})},this),5e3),e.resolve(r)}delete this.loadOwnedArtistsDfd}function s(e,t){this.set("extraData",t),t?e.resolve(t):e.reject(),delete this.loadExtraDataDfd}function o(t,r){if(!r)t.reject();else{var i=r.Data||{},s=r.Name&&r.Name.indexOf("/")===-1?r.Name:"";this.set({pageNameData:i,pageNameSource:"user",PathName:s});if(_.defined(i.PendingNotification)){var o=function(){n.Services.API.userSawPendingNotification(i.PendingNotification)};switch(i.PendingNotification){case"canceledCard1119":e.location.hash=="#!/upgrade"||e.location.hash=="#!/settings/subscription"||this.get("subscription").get("apiVersion")>1?o():setTimeout(function(){n.trigger("notification:add",{description:_.getString("ERROR_NOTIF_SUB_EXPIRED"),type:"error",click:function(){n.router.setHash("/settings/subscription")},duration:0,closeAction:o})},1e3);break;case"incorrectEmail1212":setTimeout(function(){n.trigger("notification:add",{description:_.getString("ERROR_NOTIF_INCORRECT_EMAIL"),type:"error",click:function(){n.router.setHash("/settings/account")},duration:0,closeAction:o})},1e3)}}t.resolve(i)}}function u(e,t,n){if(!n){e.reject(n);return}var r={};t&&(this.get("pageNameData")&&this.get("pageNameData").URLs?r.URLs=_.extend({},this.get("pageNameData").URLs,t):r.URLs=t);var i=_.extend({},this.get("pageNameData")||{},r);this.set("pageNameData",i),e.resolve(this.get("pageNameData"))}function a(e,t){n.Models.User.prototype.getLibrary.call(this,e).done(_.bind(function(e){t.resolve(e),this.storeLibrary()},this)).fail(function(e){t.reject(e)})}function f(e,t){this.set("broadcastInvites",t),t?e.resolve(t):e.reject()}function l(e,t,r){if(!r||r.statusCode!==1&&r.statusCode!==-6){r&&t.PageName&&(r.statusCode===-17||r.statusCode===-4||r.statusCode===-8||r.statusCode===-9)&&this.set("PathName",t.PageName),e.reject(r);return}if(r.statusCode===-6){e.resolve(r);return}t.hasOwnProperty("PageName")&&(t.PathName=t.PageName,delete t.PageName),t.hasOwnProperty("FName")&&($.trim(t.FName)?t.hasDefaultName=!1:(t.hasDefaultName=!0,t.FName="New User"),t.Name=t.FName),this.set(t),n.Services.API.reportUserChange(this);var i=this.get("currentBroadcastID");i?n.Services.API.storeChatIdentity("bcast:"+i):n.Services.API.storeChatIdentity(),e.resolve(r)}function c(e,t,r){var i=r&&r.Timestamps?_.toInt(r.Timestamps.newTSModified):null,s=(new Date(i*1e3)).format("Y-m-d G:i:s");this.localAddSongsToLibrary(t,s);if(!e)return;var o=[],u=[],a,f,l;for(f=0,l=t.length;f<l;f++)a=t[f].get("SongID"),o.push(a),u.push({id:a,item:t[f].toManateeProperties()});r&&r.Timestamps&&(_.toInt(r.Timestamps.oldTSModified)>this.get("libraryTSModified")?this.refreshLibrary():i&&this.set("libraryTSModified",i)),t.length>1?n.trigger("notification:add",{title:_.getString("POPUP_SONGS_ADDED",{songCount:t.length}),icon:"collection icon-collection-white-active",type:"success",url:this.toUrl("collection")}):t[0].get("isFavorite")||n.trigger("notification:add",{title:_.getString("POPUP_SONG_ADDED"),icon:"collection icon-collection-white-active",type:"success",url:this.toUrl("collection")}),e.resolve(t),n.trigger("guts:log","songAddedToLibrary",{ids:o.toString()}),this.syncUserContentChange("libraryChange",{added:!0,items:u,type:"Songs",TSAdded:i},"libraryAddedSongs")}function h(e,t,r){e.reject(r),t.length>1?n.trigger("notification:add",{title:_.getString("POPUP_SONGS_ADD_FAILED",{songCount:t.length}),type:"error"}):n.trigger("notification:add",{title:_.getString("POPUP_SONG_ADD_FAILED"),type:"error"})}function p(e,t,r){this.localRemoveSongsFromLibrary(t);if(!e)return;var i=r&&r.Timestamps?_.toInt(r.Timestamps.newTSModified):null,s=[],o=[],u,a,f;for(a=0,f=t.length;a<f;a++)u=t[a].get("SongID"),s.push(u),o.push({id:u});r&&r.Timestamps&&(_.toInt(r.Timestamps.oldTSModified)>this.get("libraryTSModified")?this.refreshLibrary():i&&this.set("libraryTSModified",i)),t.length>1?n.trigger("notification:add",{title:_.getString("POPUP_SONGS_REMOVED",{songCount:t.length}),icon:"collection icon-collection-white-active",type:"success"}):n.trigger("notification:add",{title:_.getString("POPUP_SONG_REMOVED"),icon:"collection icon-collection-white-active",type:"success"}),e.resolve(t),n.trigger("guts:log","songRemovedFromLibrary",{ids:s.toString()}),this.syncUserContentChange("libraryChange",{added:!1,items:o,type:"Songs"},"libraryRemovedSongs")}function d(e,t,r){e.reject(r),t.length>1?n.trigger("notification:add",{title:_.getString("POPUP_SONGS_REMOVE_FAILED",{songCount:t.length}),type:"error"}):n.trigger("notification:add",{title:_.getString("POPUP_SONG_REMOVE_FAILED"),type:"error"})}function v(e,t,r,i){var s=n.Models.Collections[t],o="favorite"+t,u=this.get(o),a=(i.TSFavorited?new Date(i.TSFavorited*1e3):new Date).format("Y-m-d G:i:s"),f=t.toLowerCase().substr(0,t.length-1),l=r.id;if(t=="Songs")this.localAddSongsToFavorites([r],a);else{var c;if(t=="Artists"&&i&&i.profile){var h=n.Models.Profile.newOrUpdate(i.profile),p=h.get("user");p&&(c=p)}r.set({isFavorite:!0,TSFavorited:a}),u&&u instanceof s&&u.add(r);if(c&&!(u instanceof n.Models.Collections.Users)){c.set({isFavorite:!0,TSFavorited:a});var d=this.get("favoriteUsers");d&&d.add(c)}}if(!e)return;t=="Songs"&&n.trigger("notification:add",{title:_.getString("POPUP_SONG_ADDED"),icon:"favorites icon-favorites-white-active",type:"success",url:this.toUrl("collection/favorites")}),t=="Songs"&&n.Services.Flattr.isUserConnected()&&n.Services.Flattr.isUserFavoriteAndFlattr()&&n.Services.Flattr.onFavoriteAndFlattr(r),e.resolve(r),n.trigger("guts:gatrack","user","objectFavorited",f),n.trigger("guts:log","objectFavorited",{type:f,id:l}),(t=="Songs"||t=="Playlists"||t=="Broadcasts")&&this.syncUserContentChange("favoriteChange",{added:!0,items:[{id:r.id,item:r.toManateeProperties()}],type:t},"favoriteAdded"+t)}function m(e,t,r,i){var s=t.toLowerCase().substr(0,t.length-1);n.trigger("guts:gatrack","user","objectFavoritedFailed",s),n.trigger("guts:log","objectFavoritedFailed",{type:s,id:r.id}),e.reject(i)}function g(e,r,i,s){var o=n.Models.Collections[r],u="favorite"+r,a=this.get(u),f=r.toLowerCase().substr(0,r.length-1),l=i.id;if(r=="Songs")this.localRemoveSongsFromFavorites([i]);else{var c;if(r=="Artists"&&s&&s.profile){var h=n.Models.Profile.newOrUpdate(s.profile),p=h.get("user");p&&(c=p)}i.set({isFavorite:!1,TSFavorited:t}),a&&a instanceof o&&a.remove(i);if(c&&!(a instanceof n.Models.Collections.Users)){c.set({isFavorite:!1,TSFavorited:t});var d=this.get("favoriteUsers");d&&d.remove(c)}}if(!e)return;r=="Songs"&&n.trigger("notification:add",{title:_.getString("POPUP_SONG_REMOVED"),icon:"favorites icon-favorites-white-active",type:"success"}),e.resolve(i),n.trigger("guts:gatrack","user","objectFavorited",f),n.trigger("guts:log","objectUnfavorited",{type:f,id:l}),(r=="Songs"||r=="Playlists"||r=="Broadcasts")&&this.syncUserContentChange("favoriteChange",{added:!1,items:[{id:i.id}],type:r},"favoriteRemoved"+r)}function y(e,t,r,i){var s=t.toLowerCase().substr(0,t.length-1);n.trigger("guts:gatrack","user","objectUnfavoritedFailed",s),n.trigger("guts:log","objectUnfavoritedFailed",{type:s,id:r.id}),e.reject(i)}function b(e,t,r){if(!e.loadSubscriptionDfd||e.loadSubscriptionDfd.state()==="rejected"||t){e.loadSubscriptionDfd=$.Deferred();var i=G.get("isLoaded");i&&!t?G.loadSpecialPricing().done(function(){e.loadSubscriptionDfd.resolve(G)}):n.Models.Subscription.get(e).done(function(t){if(i&&r&&t.isSpecial()&&!G.isSpecial()){var s=e.get("Flags");G.get("apiVersion")==1&&(s&n.Models.User.FLAG_HAS_NEW_SUB)>0&&e.set("Flags",s&~n.Models.User.FLAG_HAS_NEW_SUB),e.loadSubscriptionDfd.resolve(G);return}G=t,e.trigger("change:subscription"),e.loadSubscriptionDfd.resolve(t)})}return e.loadSubscriptionDfd.promise()}function w(e,t,n,r){switch(e){case"remove":this.get("friends").remove(t);break;case"add":n===this.get("favoriteUsers")?(this.get("followers").get(t.id)&&this.get("friends").add(t),t.set("isFavorite",!0)):n===this.get("followers")?(this.get("favoriteUsers").get(t.id)&&this.get("friends").add(t),t.set("isFollower",!0)):console.warn("_onFavoriteUsersFollowersChanged fired on unknown collection: ",n);break;case"reset":this.get("friends").reset(_.intersection(this.get("favoriteUsers").models,this.get("followers").models))}}function E(e,t,r){if(!r)e.reject(r);else{var i=new n.Models.Collections.Users(r,{silent:!0}),s=[],o=[],u=[];i.each(function(e){e.attributes.isFavorite&&o.push(e),e.attributes.isFollower&&s.push(e),e.attributes.isFavorite&&e.attributes.isFollower&&u.push(e)}),s=new n.Models.Collections.Users(s,{silent:!0,isFollower:!0}),o=new n.Models.Collections.Users(o,{silent:!0,isFavorite:!0}),u=new n.Models.Collections.Users(u,{silent:!0}),this.set({followers:s,favoriteUsers:o,friends:u}),s.on("all",w,this),o.on("all",w,this),t==="Followers"?e.resolve(s):t==="Following"?e.resolve(o):e.resolve(u)}}function S(e,t){if(!t||!t.playlists)e.reject(t);else{var r=new n.Models.Collections.Playlists(t.playlists),i=new n.Models.Collections.Broadcasts(t.broadcasts);r.each(function(e){e.set("isFavorite",!0)}),i.each(function(e){e.set("isFavorite",!0)}),this.set({favoritePlaylists:r,favoriteBroadcasts:i}),e.resolve()}}function x(e,t,r,i,s){if(s<1){T(e,s);return}if(!e)return;var o=(new Date).valueOf(),u=new n.Models.Playlist({PlaylistID:s,PlaylistName:t,Description:i,Username:this.get("Name"),UserID:this.get("UserID"),FName:this.get("FName"),LName:this.get("LName"),initialSongs:r,TSAdded:o,TSModified:o});this.getPlaylists().done(function(e){e.add(u)}),n.trigger("notification:add",{title:_.getString("POPUP_PLAYLIST_CREATE_TITLE"),description:_.getString("POPUP_PLAYLIST_CREATE_DESCRIPTION"),url:u.toUrl(),icon:"new-playlist icon-new-playlist-white-active",type:"success"}),n.trigger("guts:gatrack","user","playlistCreated"),n.trigger("guts:forcelog","playlistCreated",{playlistID:s}),e.resolve(u),this.syncUserContentChange("playlistChange",{action:"create",items:[u.toManateeProperties()]},"playlistCreated")}function T(e,t){e.reject(t)}function N(e,t,r,i){if(!i){C(e,t,r);return}e.set("isDeleted",!0),this.get("playlists")&&this.get("playlists").remove(e);if(!t)return;r&&n.trigger("notification:add",{title:_.getString("POPUP_PLAYLIST_DELETE_TITLE",{playlist:e.get("PlaylistName")}),description:_.getString("POPUP_PLAYLIST_DELETE_DESCRIPTION"),url:this.toUrl("music/playlists"),icon:"playlist icon-playlist-white-active",type:"success"}),n.trigger("guts:gatrack","user","playlistDeleted"),n.trigger("guts:forcelog","playlistDeleted",{playlistID:e.get("PlaylistID")}),t.resolve(),this.syncUserContentChange("playlistChange",{action:"delete",items:[e.toManateeProperties()]},"playlistDeleted")}function C(e,t,r){r&&n.trigger("notification:add",{description:_.getString("POPUP_FAIL_DELETE_PLAYLIST_MSG",{playlist:e.PlaylistName}),type:"error"}),n.trigger("guts:gatrack","user","deletePlaylistFailed"),n.trigger("guts:log","deletePlaylistFailed",{playlistID:e.get("PlaylistID")}),t.reject()}function k(e,t,r,i){if(!i){L(e,t,r);return}e.set("isDeleted",!1),this.get("playlists").add(e),r&&n.trigger("notification:add",{title:"",description:_.getString("POPUP_PLAYLIST_RESTORED"),url:e.toUrl(),icon:"subbed-playlist icon-subbed-playlist-white-active",type:"success"}),n.trigger("guts:gatrack","user","restorePlaylist"),n.trigger("guts:log","restorePlaylist",{playlistID:e.get("PlaylistID")}),t.resolve()}function L(e,t,r){r&&n.trigger("notification:add",{title:"",description:_.getString("POPUP_PLAYLIST_RESTORE_FAIL"),type:"error"}),n.trigger("guts:gatrack","user","restorePlaylistFailed"),n.trigger("guts:log","restorePlaylistFailed",{playlistID:e.get("PlaylistID")}),t.reject()}function A(e,t,r,i){if(!i){O(e,t,r);return}e.set("isDeleted",!0),this.get("broadcasts")&&this.get("broadcasts").remove(e),r&&n.trigger("notification:add",{title:_.getString("POPUP_BROADCAST_DELETE_TITLE",{broadcast:e.escape("Name")}),description:_.getString("POPUP_BROADCAST_DELETE_DESCRIPTION"),url:e.toUrl(),type:"success"}),n.trigger("guts:gatrack","user","broadcastDeleted"),n.trigger("guts:forcelog","broadcastDeleted",{broadcastID:e.get("BroadcastID")}),t.resolve();var s=n.Services.Local.get("lastBroadcasting"+this.id);s&&s.broadcastID==e.get("BroadcastID")&&n.Services.Local.remove("lastBroadcasting"+this.id)}function O(e,t,r){r&&n.trigger("notification:add",{description:_.getString("POPUP_FAIL_DELETE_BROADCAST_MSG",{broadcast:e.escape("Name")}),type:"error"}),n.trigger("guts:gatrack","user","deleteBroadcastFailed"),n.trigger("guts:log","deleteBroadcastFailed",{broadcastID:e.get("BroadcastID")}),t.reject()}function M(e,t,r,i){if(!i){D(e,t,r);return}e.set("isDeleted",!1),this.get("broadcasts")&&this.get("broadcasts").add(e),r&&n.trigger("notification:add",{title:"",description:_.getString("POPUP_BROADCAST_RESTORED"),url:e.toUrl(),type:"success"}),n.trigger("guts:gatrack","user","restoreBroadcast"),n.trigger("guts:log","restoreBroadcast",{broadcastID:e.get("BroadcastID")}),t.resolve()}function D(e,t,r){r&&n.trigger("notification:add",{title:"",description:_.getString("POPUP_BROADCAST_RESTORE_FAIL"),type:"error"}),n.trigger("guts:gatrack","user","restoreBroadcastFailed"),n.trigger("guts:log","restoreBroadcastFailed",{broadcastID:e.id}),t&&t.reject()}function P(e,t){t&&t.events?(e&&this.get("communityFeed")?(this.get("communityFeed").add(t.events),this.trigger("change:communityFeed",this.get("communityFeed"))):this.set("communityFeed",new n.Models.Collections.FeedEvents(t.events,{modelOptions:{dontCache:!0}})),this.communityFeedDfd.resolve(this.get("communityFeed"),t.events)):this.communityFeedDfd.reject()}function H(e){e?(this.set("recommendedUsers",new n.Models.Collections.Users(e)),this.recommendedUsersDfd.resolve(this.get("recommendedUsers"))):this.recommendedUsersDfd.reject()}function B(e,t){t?(this.set("claimHistory",t),e.resolve(t)):e.reject()}function j(e){var r={local:{}};return r.local.restoreQueue=_.orEqual(n.Services.Local.get("player.restoreQueue"),0),r.local.lowerQuality=_.orEqual(n.Services.Local.get("player.lowerQuality"+e),0),r.local.noPrefetch=_.orEqual(n.Services.Local.get("player.noPrefetch"+e),0),r.local.playPauseFade=_.orEqual(n.Services.Local.get("player.playPauseFade"+e),0),r.local.crossfadeAmount=_.orEqual(n.Services.Local.get("player.crossfadeAmount"+e),5e3),r.local.crossfadeEnabled=_.orEqual(n.Services.Local.get("player.crossfadeEnabled"+e),0),r.local.lastShuffle=_.orEqual(n.Services.Local.get("player.lastShuffle"+e),0),r.local.persistShuffle=_.orEqual(n.Services.Local.get("player.persistShuffle"+e),1),r.local.tooltips=_.orEqual(n.Services.Local.get("user.tooltips"+e),0),r.local.themeFlags=_.orEqual(n.Services.Local.get("user.themeFlags"+e),0),r.local.persistPinboard=_.orEqual(n.Services.Local.get("user.persistPinboard"+e),0),r.local.disablePlayerShortcuts=_.orEqual(n.Services.Local.get("user.disablePlayerShortcuts"+e),0),r.local.civicScienceOptOut=_.orEqual(n.Services.Local.get("civicscience.optOut"),0),r.local.artistsPlayed=_.orEqual(n.Services.Local.get("artistsPlayed"+e),[]),r.local.recentListens=_.orEqual(n.Services.Local.get("recentListens"+e),[]),r.local.joinLeftDisabled=_.orEqual(n.Services.Local.get("broadcast.chat.joinLeftDisabled"+e),!1),r.local.nowPlayingDisabled=_.orEqual(n.Services.Local.get("broadcast.chat.nowPlayingDisabled"+e),!1),r.local.suggestionsDisabled=_.orEqual(n.Services.Local.get("broadcast.chat.suggestionsDisabled"+e),!1),r.local.broadcastAutoApprove=_.orEqual(n.Services.Local.get("broadcast.autoApprove"+e),t),r.local.ignoreChatTag=_.orEqual(n.Services.Local.get("chat.ignoreChatTag"+e),!1),r.local.recentBroadcasts=n.Services.Local.get("broadcast.recent"+e),r.local.inviteOnCreate=n.Services.Local.get("broadcast.inviteOnCreate"+e),_.isArray(r.local.artistsPlayed)||(r.local.artistsPlayed=[]),_.isArray(r.local.recentBroadcasts)||(r.local.recentBroadcasts=[]),_.defined(r.local.inviteOnCreate)||(r.local.inviteOnCreate=!0),r}function F(e,t){if(!t){e.reject();return}t=new n.Models.Collections.Tacos(t,{modelOptions:{dontCache:!0}}),this.set("notifications",t),e.resolve(t)}function I(){var e=this.id,t=this.get("Email"),r=Date.now(),i=n.Services.Local.get("lastLiveRampEx"+e);if(e>0&&t&&(!i||r-i>1296e6)){var s=hex_sha1($.trim(t.toLowerCase()));_.delay(function(){n.Services.Local.set("lastLiveRampEx"+e,Date.now()),$("iframe#liveRamp").remove();var t=$('<iframe id="liveRamp" name="_rlcdn" width=0 height=0 frameborder=0></iframe>'),r="http://ei.rlcdn.com/44054.html?s="+s;t.css("visibility","hidden"),t.attr("src",r),$("body").append(t)},3e4)}}function q(){var e=this.id,t=new Date,r=n.Services.Local.get("lastExcelateEx"+e),i=this.get("Sex"),s=this.get("TSDOB")?this.get("TSDOB").split("-"):!1;(!r||t.valueOf()-r>1296e6)&&_.delay(function(){n.Services.Local.set("lastExcelateEx"+e,Date.now()),$("iframe#excelate").remove();var r=$('<iframe id="excelate" width=0 height=0 frameborder=0></iframe>'),o=["http://loadus.exelator.com/load/?p=259&g=001&c=285367&j=w"];i&&e>0&&(o.push("&ge="),o.push(i.toLowerCase()=="m"?"0":"1"));if(s&&s.length==3&&e>0){var u=t.getFullYear()-_.toInt(s[0]);_.toInt(s[1])>t.month?u-=1:_.toInt(s[1])==t.month&&_.toInt(s[2])>t.date&&(u-=1),o.push("&ae="),o.push(n.Models.Ad.encodeInteger(u))}r.css("visibility","hidden"),r.attr("src",o.join("")),$("body").append(r)},31e3)}function R(e,t){t&&(t=n.Models.Broadcast.newOrUpdate(t,{source:"db"})),e.resolve(t)}function U(e,t){if(!_.isArray(t)||!t.length||!t[0].hasOwnProperty("CalloutID"))t=[];var r=new n.Models.Collections.Callouts(t,{user:this});this.set("callouts",r),e.resolve(r)}function z(e,t){e.reject(t)}function K(){if(!this.get("isLoggedIn"))return;var e=this.libraryFavoritesToSync,t,n,r,i=V.length-1;if(!e||!e.length)return;this.libraryFavoritesToSync=[];var s=this.get("shouldSyncUserContent");if(!s){J&&(clearInterval(J),J=0),s===!1&&(V=[]);return}for(t=0,n=e.length;t<n;t++){r=e[t];if(i>-1&&V[i].groupKey===r.groupKey){V[i].params.items=V[i].params.items.concat(r.params.items);continue}V.push(r),i++}J||(J=setInterval(Q,1e3))}function Q(){if(!V.length){clearInterval(J),J=0;return}if(n.Services.SWF.chatReady.state()==="pending")return;var e=0,t=[],r,i;while(e<W&&V.length){i=V[0],r=i.params.items&&i.params.items.length;if(r>W){var s={type:i.type,groupKey:i.groupKey,params:$.extend({},i.params)};s.params.items=i.params.items.splice(W),V[0]=s}else V.shift();if(r+e>W){V.unshift();break}e+=r,t.push(i)}try{n.Services.SWF.sendSelfMessage(t,"userContentSync")}catch(o){console.warn("Failed to sendSelfMessage with sync change",o,i)}}n.Models=n.Models||{};var W=40,X=0,V=[],J=0,G,Y=/^(?!.*\.@)(?!.*\.{2})[A-z0-9\._+-]+@[A-z0-9][A-z0-9-]*(\.[A-z0-9_-]+)*\.([A-z]{2,6})$/,Z=/^([a-zA-Z0-9]+[\.\-_]?)+[a-zA-Z0-9]+$/;n.Models.AuthUser=n.Models.User.extend({parse:function(e,t){var r=t||{};r.isAuth=!0;var i=n.Models.User.prototype.parse.call(this,e,r);return i.isLoggedIn=i.UserID>0,i.isAuth=!0,i.Privacy=_.orEqual(e.Privacy,e.privacy),i.Privacy=_.toInt(e.Privacy),i.sessionPrivacy=i.Privacy,i.NotificationEmailPrefs=_.toInt(e.NotificationEmailPrefs),i.IsActive=e.IsActive,i.Zip=e.Zip,i.UploadsEnabled=e.UploadsEnabled,i.favoritesLimit=e.favoritesLimit,i.librarySizeLimit=e.librarySizeLimit,i.themeID=e.themeID,i.userTrackingID=e.userTrackingID,i.artistsOwned=e.artistsOwned,i.primaryUserID=e.primaryUserID,i.primaryFName=e.primaryFName,i.TSModified=e.TSModified,i.Context={type:"user",artist:{}},i},initialize:function(e,t){n.Models.User.prototype.initialize.call(this,e,t),this.set("_noCache",!1),n.Models.AuthUser.cache(this);if(this.get("isLoggedIn")){_.defer(_.bind(this.loadUserInfo,this));var r=0,i=!1,s=!1;this.get("Flags")&n.Models.User.FLAG_ANYWHERE?r=8:this.get("Flags")&n.Models.User.FLAG_PLUS&&this.get("IsPremium")?r=6:this.get("Flags")&n.Models.User.FLAG_LITE?r=21:this.get("IsPremium")?r=8:i=!0,this.get("Flags")&n.Models.User.FLAG_HAS_SPECIAL_PRICE&&(s=!0),G=new n.Models.Subscription({SubscriptionTypeID:r,isLoaded:i,hasSpecialPricing:s,user:this})}else G=new n.Models.Subscription({isLoaded:!0,user:this});this.defineProperty("subscription",{get:function(){return G},configurable:!1}),this.set("settings",j(this.get("UserID")));var o=n.Services.Twitter.SERVICE_ID|n.Services.Twitter.TWITTER_ONLY_SERVICE_ID|n.Services.Google.SERVICE_ID|n.Services.Google.GOOGLE_ONLY_SERVICE_ID|n.Services.Facebook.SERVICE_ID|n.Services.Facebook.FACEBOOK_ONLY_SERVICE_ID|n.Services.Flattr.SERVICE_ID|n.Services.Lastfm.SERVICE_ID,u=!1;this.get("isLoggedIn")&&(this.get("Flags")&o)>0&&(u=!0),this.set("hasExtraData",u),this.get("IsPremium")||(I.call(this),q.call(this)),this.unset("shouldSyncUserContent"),V=[]},loadUserInfo:function(){this.getPageNameData(),this.getLibrarySongIDs(),this.getFavoriteSongsSongIDs(),this.getFavoritesByType("Playlists"),this.getFavoritesByType("Artists"),this.getFavoritesByType("Users");var e=this.getOwnedArtists();_.delay(_.bind(this.getExtraData,this),5e3);var t=[n.Services.SWF.chatReady,n.ready];$.after(t).done(_.bind(function(){var t=this.getBroadcastingLocally();if(t&&t.broadcastID){var i=_.bind(function(){var e=r.page.getCurrentPageView();_.isInstance(e,n.Views.Pages.User)&&e.broadcastView&&e.model.get("user")===this?n.Models.Broadcast.fetchRealtimeBroadcast(t.broadcastID).done(_.bind(this.resumeBroadcast,this)).fail(function(){t.alreadyTried=!0,n.trigger("lightbox:open","broadcastResume",t)}):n.trigger("lightbox:open","broadcastResume",t)},this);e.done(i)}this.getLeapLib()},this))},getOwnedArtists:function(e){if(!e&&this.loadOwnedArtistsDfd&&this.loadOwnedArtistsDfd.state()!=="rejected")return this.loadOwnedArtistsDfd.promise();var t=$.Deferred(),r=this.get("Flags")&n.Models.User.FLAG_OWNS_ARTIST||this.get("Flags")&n.Models.User.FLAG_ARTIST_PROFILE;return!e&&typeof this.get("artistsOwned")!="undefined"?t.resolve(this.get("artistsOwned")):this.get("isLoggedIn")&&(r||this.get("primaryUserID"))?(n.Services.API.userGetArtistsOwned().done(_.bind(i,this,t)).fail(_.bind(i,this,t,null)),this.loadOwnedArtistsDfd=t):i.call(this,t,[]),t.promise()},getClaimHistory:function(e){if(!e&&this.loadClaimHistoryDfd&&this.loadClaimHistoryDfd.state()!=="rejected")return this.loadClaimHistoryDfd.promise();var t=$.Deferred();return!e&&typeof this.get("claimHistory")!="undefined"?t.resolve(this.get("claimHistory")):this.get("isLoggedIn")?(n.Services.API.getClaimHistory().done(_.bind(B,this,t)).fail(_.bind(B,this,t,[])),this.loadClaimHistoryDfd=t):B.call(this,t,[]),t.promise()},getExtraData:function(){if(this.loadExtraDataDfd&&this.loadExtraDataDfd.state()!=="rejected")return this.loadExtraDataDfd.promise();var e=$.Deferred();return typeof this.get("extraData")!="undefined"?e.resolve(this.get("extraData")):this.get("hasExtraData")?(n.Services.API.userGetExtraData().done(_.bind(s,this,e)).fail(_.bind(s,this,e,null)),this.loadExtraDataDfd=e):s.call(this,e,null),e.promise()},getPageNameData:function(){if(this.loadUserPageNameDataDfd&&this.loadUserPageNameDataDfd.state()==="pending")return this.loadUserPageNameDataDfd.promise();var e=$.Deferred();return typeof this.get("pageNameData")!="undefined"?e.resolve(this.get("pageNameData")):this.get("isLoggedIn")?(n.Services.API.getPageInfoByIDType(this.get("UserID"),"user").done(_.bind(o,this,e)).fail(_.bind(o,this,e,null)),this.loadUserPageNameDataDfd=e):o.call(this,e,null),e.promise()},getUserBroadcastInvites:function(){if(this.loadUserBroadcastInvitesDfd&&this.loadUserBroadcastInvitesDfd.state()==="pending")return this.loadUserBroadcastInvitesDfd.promise();var e=$.Deferred();return typeof this.get("broadcastInvites")!="undefined"?e.resolve(this.get("broadcastInvites")):this.get("isLoggedIn")?(n.Services.API.getPastBroadcastInvites().done(_.bind(f,this,e)).fail(_.bind(f,this,e)),this.loadUserBroadcastInvitesDfd=e):f.call(this,e,null),e.promise()},changeUserInfo:function(e,t,r){var i=$.Deferred(),s={},o={},u=!1,a;for(var f in e)if(e.hasOwnProperty(f)){a=this.get(f);if(!e[f]&&!a)continue;!e[f]&&f!=="PathName"&&(e[f]=null);if(e[f]!==a){if(f==="TSDOB"&&e[f]===null&&a=="0000-00-00")continue;s[f]=e[f],o[f]=a,u=!0}}var c=this.get("LName");c&&c.length&&(_.isUndefined(s.FName)&&(s.FName=this.get("Name"),o.FName=this.get("FName")),s.LName="",o.LName=this.get("LName"),u=!0);if(!u)i.resolve({statusCode:1,nothingChanged:!0});else{var h=$.extend({},s);h.hasOwnProperty("PathName")&&(h.PageName=h.PathName,delete h.PathName);if(h.PageName||h.Email){var p=this.get("Flags"),d=(p&n.Models.User.FLAG_ARTIST_PROFILE)!=0&&(p&n.Models.User.FLAG_ARTIST_CLAIMED)==0;if(!t&&!r&&((p&n.Models.User.FLAG_GOOGLEUSER)>0||(p&n.Models.User.FLAG_TWITTERUSER)>0)){r={};var v=this;return p&n.Models.User.FLAG_GOOGLEUSER?n.Services.Google.login().done(function(e){r.type="google",r.googleEmailAddress=n.Services.Google.profile.email,r.googleUID=n.Services.Google.profile.id,r.accessToken=e.accessToken,n.Services.API.changeUserInfoEx(h,t,r,o,_.bind(l,v,i,s),function(e){i.reject(e)})}).fail(function(){i.reject({statusCode:-14})}):n.Services.Twitter.login().done(function(e){r.type="twitter",r.twitterUserID=n.Services.Twitter.profile.id_str,r.oauthToken=e.oauthToken,r.oauthSecret=e.oauthSecret,n.Services.API.changeUserInfoEx(h,t,r,o,_.bind(l,v,i,s),function(e){i.reject(e)})}).fail(function(){i.reject({statusCode:-14})}),i.promise()}if(!t&&!r&&!d){i.reject({statusCode:-7});return}}n.Services.API.changeUserInfoEx(h,t,r,o,_.bind(l,this,i,s),function(e){i.reject(e)})}return i.promise()},updateProfileURLs:function(e){var r=!0,i=this.get("pageNameData"),s=new $.Deferred,o;if(!e)r=!0;else if(!i)r=!1;else{o=_.extend({},i.URLs);if(!o&&e)r=!1;else if(e){for(var a in e)e.hasOwnProperty(a)&&(!o.hasOwnProperty(a)||e[a]!==o[a])&&(r=!1);for(a in o)o.hasOwnProperty(a)&&!e.hasOwnProperty(a)&&(e[a]=o[a]||t)}}return r?s.resolve(this.get("pageNameData")):n.Services.API.updateUserProfileURLs(e).done(_.bind(u,this,s,e)).fail(_.bind(s.reject,s)),s.promise()},getLibraryTSModified:function(){if(this.libraryTSModifiedDfd&&this.libraryTSModifiedDfd.state()=="pending")return this.libraryTSModifiedDfd.promise();this.libraryTSModifiedDfd=$.Deferred();var e=this.get("libraryTSModified");return e?this.libraryTSModifiedDfd.resolve(e):this.get("isLoggedIn")?n.Services.API.userGetLibraryTSModified(this.id).done(_.bind(function(t){t?(e=t.TSModified||"0",this.set("libraryTSModified",e),this.libraryTSModifiedDfd.resolve(e)):this.libraryTSModifiedDfd.reject()},this)).fail(_.bind(this.libraryTSModifiedDfd.reject,this.libraryTSModifiedDfd)):(e="0",this.set("libraryTSModified",e),this.libraryTSModifiedDfd.resolve(e)),this.libraryTSModifiedDfd.promise()},getLibrary:function(e){e=_.orEqual(e,!1);if(this.loadAuthLibraryDfd&&this.loadAuthLibraryDfd.state()!=="rejected")return this.loadAuthLibraryDfd.promise();var t=new $.Deferred,r=this.get("library");if(r)t.resolve(r);else{var i=function(){var i=n.Services.Local.get("library"+this.id);i?this.getLibraryTSModified().done(_.bind(function(s){s>i.lastModified?a.call(this,e,t):(r=new n.Models.Collections.Songs(_.toArray(i.songs),{silent:!0,fromLibrary:!0}),this.set("library",r),t.resolve(r))},this)).fail(_.bind(function(){a.call(this,e,t)},this)):a.call(this,e,t),this.getFavoritesByType("Songs")};this.get("oldUserClean")?this.get("oldUserClean").done(_.bind(i,this)):i.call(this),this.loadAuthLibraryDfd=t}return t.promise()},getLibrarySongIDs:function(){function i(i,s){for(var o=0,u=i.length,a,f;o<u;o++)a=i[o],a&&t[a]!==1&&(t[a]=1,f=n.Models.Song.getCached(a),f&&f.set("fromLibrary",!0));r.set({librarySongsSongIDs:t,libraryTSModified:s,librarySongsCount:i.length}),e.resolve(t)}function s(){n.Services.API.userGetSongIDsInLibrary().done(function(t){if(!t||!t.SongIDs){e.reject();return}i(t.SongIDs,t.TSModified),r.storeLibrary()}).fail(_.bind(e.reject,e))}function o(){var t=r.get("library");if(t){i(t.pluck("SongID"),r.get("TSModified")),r.storeLibrary();return}var o=n.Services.Local.get("librarySongIDs"+r.id);if(!o){s();return}r.getLibraryTSModified().done(function(t){s();return}).fail(s)}if(this.loadAuthLibrarySongIDsDfd&&this.loadAuthLibrarySongIDsDfd.state()!=="rejected")return this.loadAuthLibrarySongIDsDfd.promise();var e=new $.Deferred,t=this.get("librarySongsSongIDs"),r=this;return t?(e.resolve(t),e.promise()):this.get("isLoggedIn")?(t={},this.get("oldUserClean")?this.get("oldUserClean").done(o):o(),this.loadAuthLibrarySongIDsDfd=e,e.promise()):(t={},this.set({librarySongsSongIDs:t,librarySongsCount:0}),e.resolve(t),e.promise())},storeLibrary:function(){var e=this.get("library"),t=this.get("librarySongsSongIDs"),r=this.get("libraryTSModified"),i=this.get("librarySongsCount")||0,s;e&&(s={lastModified:r,songs:{}},t||(t={},i=e.length),e.each(function(e){s.songs[e.id]=e.archiveAttr(),t[e.id]=1}),n.Services.Local.set("library"+this.id,s)),t&&(s={lastModified:r,count:i,songIDs:t},n.Services.Local.set("librarySongIDs"+this.id,s))},refreshLibrary:function(){var e=this.get("libraryTSModified"),t=this.get("library");this.unset("libraryTSModified",{silent:!0}),this.unset("library",{silent:!0}),this.hasOwnProperty("loadAuthLibraryDfd")&&delete this.loadAuthLibraryDfd,this.hasOwnProperty("libraryDfd")&&delete this.libraryDfd,this.getLibrary(!0).fail(_.bind(function(){this.set({libraryTSModified:e,library:t},{silent:!0})},this))},getFavoriteSongsSongIDs:function(){function s(s){var o=i.get("librarySongsSongIDs"),u=i.get("librarySongsCount");for(var a=0,f=s.length,l,c;a<f;a++)l=s[a],l&&r[l]!==1&&(r[l]=1,c=n.Models.Song.getCached(l),c&&c.set({isFavorite:!0,fromLibrary:!0}),o!==t&&o[l]!==1&&(o[l]=1,u++));i.set({favoriteSongsSongIDs:r,favoriteSongsCount:s.length,librarySongsCount:u}),e.resolve(r)}function o(){var t=i.get("favoriteSongs");if(t)s(t.pluck("SongID"));else{var r=_.chainLoading();r.push(i.getLibrarySongIDs()),r.push(n.Services.API.userGetFavoriteSongsSongIDs().done(r.bind(function(t){if(!t){e.reject();return}s(t)})).fail(r.bind(e.reject,e)))}}if(this.favoriteSongIDsDfd&&this.favoriteSongIDsDfd.state()!=="rejected")return this.favoriteSongIDsDfd.promise();var e=this.favoriteSongIDsDfd=$.Deferred(),r=this.get("favoriteSongsSongIDs"),i=this;return r?(e.resolve(r),e.promise()):this.get("isLoggedIn")?(r={},this.get("oldUserClean")?this.get("oldUserClean").done(o):o(),e.promise()):(r={},this.set({favoriteSongsSongIDs:r,favoriteSongsCount:0}),e.resolve(r),e.promise())},getCallouts:function(){if(this.loadCalloutsDfd)return this.loadCalloutsDfd.promise();var e=$.Deferred(),t=this.get("callouts");return t?e.resolve(t):n.Services.API.getUserCallouts(this.id).done(_.bind(U,this,e)).fail(_.bind(z,this,e)),this.loadCalloutsDfd=e,e.promise()},gotNewSubscription:function(e,t){if(!e){var r=this.get("Flags");r|=n.Models.User.FLAG_HAS_NEW_SUB,this.set("Flags",r)}return this.loadSubscription(!0,t)},loadSubscription:function(e,t){return b(this,e,t)},getIsPremium:function(){return this.get("subscription").isPremium()},createPlaylist:function(e,t,r){var i=new $.Deferred,s=[],o=[];if(t&&t.length){var u,a;for(var f=0;f<t.length;f++){a=t[f],a instanceof Backbone.Model&&!isNaN(a.get("SongID"))?(u=a,a=u.get("SongID"),n.Models.Song.cache(u,{notifyCache:!0})||(u=n.Models.Song.getCached(a))):u=n.Models.Song.getCached(a);if(!u){gsConfig.runMode!="production"&&console.warn("Tried to add song to playlist that wasn't cached!",a);continue}s.push(u.toJSON()),o.push(a)}}return this.get("isLoggedIn")?n.Services.API.createPlaylist(e,o,r).done(_.bind(x,this,i,e,s,r)).fail(_.bind(T,this,i)):i.reject({error:"Not logged in"}),i.promise()},addSongsToLibrary:function(e){var t=new $.Deferred,r=[],i=[],s=this.get("librarySizeLimit"),o=this.get("librarySongsCount");for(var u=0;u<e.length;u++){var a=e[u];a instanceof Backbone.Model&&!isNaN(a.get("SongID"))&&(a=a.get("SongID"));if(a===0)continue;var f=n.Models.Song.getCached(a);if(!f){gsConfig.runMode!="production"&&console.warn("Tried to add song to library that wasn't cached!",a);continue}f.get("fromLibrary")||(r.push(f),i.push(f.getDetailsForFeeds()))}if(!r.length)return t.resolve([]),t.promise();if(this.get("isLoggedIn")){var l=o+r.length,p=this.get("IsPremium"),d=p?"NOTICE_MAX_SONGS_VIP_TITLE":"NOTICE_MAX_COLLECTION_TITLE",v=p?"NOTICE_MAX_COLLECTION_VIP":"NOTICE_MAX_COLLECTION",m=p?"":"/#!/settings/subscription";l>s?r.length==1?n.trigger("notification:add",{title:_.getString(d),description:_.getString(v)+" "+_.getString("NOTICE_MAX_NOT_SAVED"),type:"error",url:m}):n.trigger("notification:add",{title:_.getString(d),description:_.getString(v)+" "+_.getString("NOTICE_MAX_MULTI_NOT_SAVED"),type:"error",url:m}):(n.Services.API.userAddSongsToLibrary(i).done(_.bind(c,this,t,r)).fail(_.bind(h,this,t,r)),l==s&&n.trigger("notification:add",{title:_.getString(d),description:_.getString(v),type:"error",url:m}))}else n.trigger("lightbox:open","login",{message:_.getString("LB_LOGIN_MUST_LOGIN_TO_ADD_LIBRARY"),onLogin:function(e){e.getLibrary().done(function(){n.Services.API.userAddSongsToLibrary(i).done(_.bind(c,e,t,r)).fail(_.bind(h,e,t,r))})}});return t.promise()},removeSongsFromLibrary:function(e){var t=new $.Deferred,r,i=[],s=[],o=[],u=[],a=[];for(r=0;r<e.length;r++){var f=e[r],l=n.Models.Song.getCached(f);if(!l){gsConfig.runMode!="production"&&console.warn("Tried to add song to library that wasn't cached!",f);continue}l.get("fromLibrary")&&(i.push(l),o.push(f),u.push(l.get("AlbumID")),a.push(l.get("ArtistID"))),l.get("isFavorite")&&s.push(l)}for(r=0;r<s.length;r++)n.Services.API.unfavorite("Song",s[r].id).done(_.bind(this.localRemoveSongsFromFavorites,this,[s[r]]));return i.length?(this.get("isLoggedIn")?n.Services.API.userRemoveSongsFromLibrary(this.id,o,u,a).done(_.bind(p,this,t,i)).fail(_.bind(d,this,t,i)):t.reject(),t.promise()):(t.resolve([]),t.promise())},localAddSongsToLibrary:function(e,t){var n=this.get("librarySongsSongIDs"),r=this.get("librarySongsCount");for(var i=0,s=e.length;i<s;i++){if(n){if(n[e[i].id]===1)continue;n[e[i].id]=1,r++}e[i].set({TSAdded:t,fromLibrary:!0})}var o=this.get("library");o&&o.add(e),(n||o)&&this.set("librarySongsCount",o?o.length:r)},localAddSongsToFavorites:function(e,t){var n=this.get("favoriteSongsSongIDs"),r=this.get("favoriteSongsCount");for(var i=0,s=e.length;i<s;i++)n&&n[e[i].id]!==1&&(n[e[i].id]=1,r++),e[i].set({TSFavorite:t,isFavorite:!0});var o=this.get("favoriteSongs");o&&o.add(e),(n||o)&&this.set("librarySongsCount",o?o.length:r),this.localAddSongsToLibrary(e,t)},localRemoveSongsFromLibrary:function(e){var n=this.get("library");n&&n.remove(e);var r=this.get("librarySongsSongIDs"),i=this.get("librarySongsCount");for(var s=0,o=e.length;s<o;s++)r&&r[e[s].id]&&(r[e[s].id]=t,i--),e[s].set({TSAdded:t,TSFavorite:t,fromLibrary:!1,isFavorite:!1});(r||n)&&this.set("librarySongsCount",n?n.length:i)},localRemoveSongsFromFavorites:function(e){var n=this.get("favoriteSongs");n&&n.remove(e);var r=this.get("favoriteSongsSongIDs"),i=this.get("favoriteSongsCount");for(var s=0,o=e.length;s<o;s++)r&&r[e[s].id]&&(r[e[s].id]=t,i--),e[s].set({TSFavorite:t,isFavorite:!1});(r||n)&&this.set("favoriteSongsCount",n?n.length:i)},favorite:function(e,t){var r=new $.Deferred,i=e.substr(0,e.length-1),s=n.Models[i],o=s?s.getCached(t):null;if(t===0)return r.reject("Invalid item"),r.promise();if(!s)return r.reject("Invalid type"),r.promise();if(!o)return r.reject("Model not cached"),r.promise();if(this.get("isLoggedIn")){var u,a,f,l=this.get("IsPremium"),c=e.toUpperCase(),h=this.get("favorite"+e),p=h?h.length:0;l?u=5e3:u=500,a=l?["NOTICE_MAX_",c,"_VIP_TITLE"].join(""):["NOTICE_MAX_",c,"_TITLE"].join(""),f=l?["NOTICE_MAX_",c,"_VIP"].join(""):["NOTICE_MAX_",c].join("");if(p>=u){n.trigger("notification:add",{title:_.getString(a),description:_.getString(f)+" "+_.getString("NOTICE_MAX_NOT_SAVED"),type:"error",url:"/#!/settings/subscription"});return}p>=u-1&&n.trigger("notification:add",{title:_.getString(a),description:_.getString(f),type:"error",url:"/#!/settings/subscription"});if(e==="Broadcasts"){if(!o||!o.get("Name")||!o.get("UserID")&&!o.get("ArtistID"))return r.reject(),r.promise();n.Services.API.favoriteBroadcast(t,o.get("Name"),o.get("UserID"),o.get("ArtistID")).done(_.bind(v,this,r,e,o)).fail(_.bind(m,this,r,e,o))}else n.Services.API.favorite(i,t,o.getDetailsForFeeds()).done(_.bind(v,this,r,e,o)).fail(_.bind(m,this,r,e,o))}else{var d;switch(e){case"Users":d="LB_LOGIN_MUST_LOGIN_TO_FOLLOW_USER";break;case"Songs":d="LB_LOGIN_MUST_LOGIN_TO_FAV_SONG";break;case"Playlists":d="LB_LOGIN_MUST_LOGIN_TO_SUBSCRIBE_PLAYLIST";break;case"Artists":d="LB_LOGIN_MUST_LOGIN_TO_FOLLOW_ARTIST";break;case"Broadcasts":d="LB_LOGIN_MUST_LOGIN_TO_FAV_BROADCAST"}n.trigger("lightbox:open","login",{message:_.getString(d),onLogin:function(s){s.getFavoritesByType(e).done(function(){n.Services.API.favorite(i,t,o.getDetailsForFeeds()).done(_.bind(v,s,r,e,o)).fail(_.bind(m,s,r,e,o))})}})}return r.promise()},unfavorite:function(e,t){var r=new $.Deferred,i=n.Models[e.substr(0,e.length-1)],s=i?i.getCached(t):null,o=e.substr(0,e.length-1);return t===0?(r.reject("Invalid item"),r.promise()):i?s?(this.get("isLoggedIn")?(o||"").toLowerCase()==="broadcast"?n.Services.API.unfavoriteBroadcast(t).done(_.bind(g,this,r,e,s)).fail(_.bind(y,this,r,e,s)):n.Services.API.unfavorite(o,t).done(_.bind(g,this,r,e,s)).fail(_.bind(y,this,r,e,s)):r.reject("log in plz"),r.promise()):(r.reject("Model not cached"),r.promise()):(r.reject("Invalid type"),r.promise())},handleUserContentSync:function(e){for(var t=0,n=e.length;t<n;t++)switch(e[t].type){case"favoriteChange":e[t].params.added?this.handleSyncedFavorites(e[t].params.type,e[t].params.items):this.handleSyncedUnfavorites(e[t].params.type,e[t].params.items);break;case"playlistChange":e[t].params.action=="create"?this.handleSyncedPlaylistCreated(e[t].params.items):e[t].params.action=="delete"?this.handleSyncedPlaylistDeleted(e[t].params.items):e[t].params.action=="rename"&&this.handleSyncedPlaylistRenamed(e[t].params.items);break;case"playlistSongsChange":this.handleSyncedPlaylistSongsChange(e[t].params.items);break;case"libraryChange":e[t].params.added?this.handleSyncedLibraryAdds(e[t].params.items,e[t].params.TSAdded):this.handleSyncedLibraryRemoves(e[t].params.items)}},handleSyncedUnfavorites:function(e,t){var r=n.Models[e.substr(0,e.length-1)],i,s,o;for(s=0,o=t.length;s<o;s++)t[s].item?e=="Songs"?i=r.newOrUpdate(r.convertManateeSongCalloutProperties(t[s].item)):i=r.newOrUpdate(r.convertManateeProperties(t[s].item)):i=r.getCached(t[s].id),i&&g.call(this,null,e,i,!0)},handleSyncedFavorites:function(e,t){var r=n.Models[e.substr(0,e.length-1)],i,s,o;for(s=0,o=t.length;s<o;s++)t[s].item?e=="Songs"?i=r.newOrUpdate(r.convertManateeSongCalloutProperties(t[s].item)):i=r.newOrUpdate(r.convertManateeProperties(t[s].item)):i=r.getCached(t[s].id),i&&v.call(this,null,e,i,!0)},handleSyncedPlaylistCreated:function(e){var t=this.get("playlists"),r,i,s,o;if(!t)return;for(i=0,s=e.length;i<s;i++)o=n.Models.Playlist.convertManateeProperties(e[i]),o.Username=this.get("Name"),r=n.Models.Playlist.newOrUpdate(o),r&&t.add(r)},handleSyncedPlaylistDeleted:function(e){var t=this.get("playlists"),r,i,s;if(!t){for(i=0,s=e.length;i<s;i++)r=n.Models.Playlist.getCached(e[i].pID),r&&r.uncache();return}for(i=0,s=e.length;i<s;i++)!n.Models.Playlist.getCached(e[i].pID)||(r=n.Models.Playlist.newOrUpdate(n.Models.Playlist.convertManateeProperties(e[i])),r&&N.call(this,r,null,null,!0))},handleSyncedPlaylistRenamed:function(e){var t,r,i;for(r=0,i=e.length;r<i;r++)!n.Models.Playlist.getCached(e[r].pID)||(newPlaylist=n.Models.Playlist.convertManateeProperties(e[r]),t=n.Models.Playlist.newOrUpdate(newPlaylist),t.set("PlaylistName",newPlaylist.PlaylistName))},handleSyncedPlaylistSongsChange:function(e){var t,r,i;for(r=0,i=e.length;r<i;r++)t=n.Models.Playlist.getCached(e[r]),t&&t.clearSongs()},handleSyncedLibraryAdds:function(e,t){var r=[],i,s,o;for(s=0,o=e.length;s<o;s++)e[s].item?i=n.Models.Song.newOrUpdate(n.Models.Song.convertManateeSongCalloutProperties(e[s].item)):i=n.Models.Song.getCached(e[s].id),i&&r.push(i);c.call(this,null,r,{Timestamps:{newTSModified:t}})},handleSyncedLibraryRemoves:function(e){var t=[],r,i,s;for(i=0,s=e.length;i<s;i++)r=n.Models.Song.getCached(e[i].id),r&&t.push(r);p.call(this,null,t,!0)},syncUserContentChange:function(e,t,n){if(!t)return;this.libraryFavoritesToSync||(this.libraryFavoritesToSync=[]),this.libraryFavoritesToSync.push({type:e,params:t,groupKey:n}),X&&clearTimeout(X),X=setTimeout(_.bind(K,this),2e3)},getLastBroadcast:function(){if(this.lastBroadcastDfd&&this.lastBroadcastDfd.state()!=="rejected")return this.lastBroadcastDfd.promise();var e=$.Deferred();return this.lastBroadcastDfd=e,this.get("isLoggedIn")?n.Services.API.getUserLastBroadcast().done(_.bind(R,this,e)).fail(_.bind(e.reject,e)):e.resolve(null),e.promise()},clearLastBroadcast:function(){this.lastBroadcastDfd&&delete this.lastBroadcastDfd},storeBroadcastingLocally:function(e){e&&e.isLoggedInUserOwner()?n.Services.Local.set("lastBroadcasting"+this.id,{broadcastID:e.get("BroadcastID"),broadcastName:this.get("currentBroadcastName"),context:{type:"user",artistID:t},time:Date.now(),bannedUserIDsArray:_.keys(e.get("bannedUserIDs"))}):n.Services.Local.remove("lastBroadcasting"+this.id)},getBroadcastingLocally:function(){var e=n.Services.Local.get("lastBroadcasting"+this.id);return e&&e.time&&e.time+72e5<Date.now()&&(e=null),n.Services.Local.remove("lastBroadcasting"+this.id),e},createBroadcast:function(e,i,s,o,u){if(this.creatingBroadcast)return;if(!this.get("isLoggedIn")){var a=_.toArray(arguments);n.trigger("lightbox:open","login",{message:_.getString("LB_LOGIN_MUST_LOGIN_TO_BROADCAST"),onLogin:function(e){e.createBroadcast.apply(e,a)}});return}n.trigger("player:radio",!1);var f=this,l=function(){f.creatingBroadcast&&(clearTimeout(f.creatingBroadcast),f.creatingBroadcast=null)};this.creatingBroadcast=setTimeout(l,5e3),this.getLastBroadcast().always(_.bind(function(a){var f=!1,c;a instanceof n.Models.Broadcast||(a=null),e=_.orEqual(e,a&&!a.get("IsRandomName")?a.get("Name"):"")+"";if(!e){var h=["Street","Pizza","Trap","Crystal","Beat","Moon","Night","Summer","Dance","Lazer","Ice","Gold","Red","Blue","Hot","Orange","Turquoise","Pretty","Sapphire","Naughty","Weird","Cute","Feisty","Purple","Neon","Groovy","Funky","Tangerine","Awesome","Sparkle"],p=["Weasel","Meow","Wave","Bop","Pudding","Panda","Wolf","Buggy","Cake","Beach","Berry","Otter","Sloth","Donkey","Llama","Manatee","Bat","Hippo","Dog","Giraffe","Mouse","Cat","Ant","Lion","Elephant","Zebra","Rhino","Tiger","Flamingo","Candles","Soap","Balloons","Lake","Statues","Path","Hats","Party","Zoo"],d=["FM","Mixtape","Radio","Mix","Music"];e=[h[Math.floor(Math.random()*h.length)],p[Math.floor(Math.random()*p.length)],d[Math.floor(Math.random()*d.length)]].join(" "),f=!0}i=u&&u.ignoreLast?null:_.orEqual(i,a?a.get("Tag"):null),s=_.orEqual(s,a?a.get("Description"):"");if(o){var v=a?a.get("Image")||"":t,m=a?a.get("Privacy")||0:t,g=v?v.indexOf("?"):-1;g>-1&&(v=v.substring(0,g));function y(e){(!e||!e.success)&&n.router.setHash("broadcasts?down"),l(),r.model.get("player").set("isCreatingBroadcast",!1)}i&&i.i<1&&(i=null);var b={Name:e,IsRandomName:f,Tag:i,Description:s,Image:v,Privacy:m};r.model.get("player").set({isCreatingBroadcast:b,isJoiningBroadcast:!1}),n.once("manatee:startBroadcast",y),n.Services.SWF.ready.done(function(){n.Services.SWF.connectToChat(),n.Services.SWF.chatReady.done(function(){n.Services.SWF.startBroadcast(b,u&&u.bannedUserIDsArray)})})}else n.trigger("lightbox:open","createBroadcast",{name:e,tag:i,description:s}),l()},this)),this.getFollowers().done(_.bind(function(){this.getUserBroadcastInvites().done(_.bind(this.updateBroadcastInviteableUsers,this))},this))},joinBroadcast:function(e,t,i){var s=n.Models.Broadcast.getCached(e),o=$.Deferred(),u=o.promise();if(!s&&!t)return o.reject(1),u;var a=t||s.getOwner(),f=r.model.get("player");if(!a||this===a)return o.reject(3),u;if(f.get("isJoiningBroadcast")==e)return o.reject(4),u;var l=_.bind(function(){f.set({isCreatingBroadcast:!1,isJoiningBroadcast:e}),n.Services.SWF.ready.done(_.bind(function(){n.Services.SWF.connectToChat(),n.Services.SWF.chatReady.done(_.bind(function(){var t={u:!0,n:a.get("Name"),i:a.id,p:a.get("Picture")};n.Services.SWF.joinBroadcast(e,t,i),this.getFollowers().done(_.bind(function(){this.getUserBroadcastInvites().done(_.bind(this.updateBroadcastInviteableUsers,this))},this)),o.resolve()},this))},this))},this),c=function(){s.set({capacityLimitReached:!0});var e=s.getOwner();e&&e.storeCurrentBroadcast&&e.storeCurrentBroadcast(!0,s.get("BroadcastID"),s.get("Name"),s.get("Image"),e.attributes,!1,!1),n.router.setHash(s.toUrl())},h=s&&s.get("UserID")||t&&t.get("UserID"),p=s&&s.get("ArtistID")||t&&t.get("ArtistID"),d=h&&gsConfig.specialBroadcastUserID&&h==gsConfig.specialBroadcastUserID,v=p&&gsConfig.specialBroadcastArtistID&&p==gsConfig.specialBroadcastArtistID;if(s&&(d||v)){var m=s.getUpdatedListenersCount();return m.done(function(e){!gsConfig.specialBroadcastCap||e<gsConfig.specialBroadcastCap?l():c()}),m.fail(c),u}return l(),this.invitesDfd=this.getUserBroadcastInvites(),u},leaveBroadcast:function(){n.Services.SWF.endBroadcast()},resumeBroadcast:function(e,i){n.Services.SWF.chatReady.done(_.bind(function(){e?(n.on("manatee:startBroadcast",function s(e){(!e||!e.success)&&n.router.setHash("broadcasts?down"),r.model.get("player").set("isCreatingBroadcast",!1),n.off("manatee:startBroadcast",s)}),n.Services.SWF.resumeBroadcast(e.get("BroadcastID"))):this.createBroadcast(t,t,t,!0,{bannedUserIDsArray:i}),this.getFollowers().done(_.bind(function(){this.getUserBroadcastInvites().done(_.bind(this.updateBroadcastInviteableUsers,this))},this))},this))},takeOverOwnBroadcast:function(e){function i(s){n.off("manatee:self:queueTransferResponse",i),r&&clearTimeout(r);var o=[];s&&s.songs&&(o=s.songs),console.log("songs for take over",o),n.Services.SWF.resumeActiveSelfBroadcast(e.get("BroadcastID"),o),t.resolve()}var t=$.Deferred();if(e.get("UserID")!=this.id)return n.trigger("notification:add",{description:_.getString("POPUP_ERROR_BROADCAST_TAKE_OVER_FAILED"),type:"error"}),t.reject(),t.promise();var r;return n.on("manatee:self:queueTransferResponse",i),n.Services.SWF.chatReady.done(function(){n.Services.SWF.getSelfBroadcasterQueueSongs(),r=setTimeout(function(){i(),n.trigger("notification:add",{description:_.getString("NOTIF_QUEUE_TRANSFER_TIMEOUT"),duration:5e3,type:"error"})},5e3)}),t.promise()},cleanUpOnLogout:function(e){var t=new $.Deferred,r=this;this.id>0&&this.storeLibrary();var i=function(e,t){var s=e.splice(0,1e3),o=s.length,u;for(var a=0;a<o;a++)u=s[a],u instanceof n.Models.Song?u.set({isFavorite:!1,fromLibrary:!1}):u instanceof n.Models.User?u.set({isFavorite:!1,isFollower:!1,canBroadcastInvite:!0,broadcastInviteTime:0,canBroadcastInviteEmail:!0,broadcastInviteTimeEmail:0}):u.set({isFavorite:!1});e.length?_.defer(i,e,t):(n.Models.AuthUser.uncache(r),n.Services.API.getPageInfoByIDType(r.id,"user",!1,{uncache:!0}),t.resolve())},s=this.get("library")?this.get("library").models:null,o=this.get("favoriteUsers")?this.get("favoriteUsers").models:[],u=this.get("favoriteArtists")?this.get("favoriteArtists").models:[],a=this.get("favoritePlaylists")?this.get("favoritePlaylists").models:[],f=this.get("followers")?this.get("followers").models:[],l=this.get("favoriteBroadcasts")?this.get("favoriteBroadcasts").models:[],c=this.get("librarySongsSongIDs")||{},h;return n.trigger("tophat:close"),s||(s=[],_.each(c,function(e,t){h=n.Models.Song.getCached(t),h&&s.push(h)})),_.defer(i,s.concat(o,u,a,f,l),t),V=[],t.promise()},getFollowers:function(){if(this.followersDfd&&this.followersDfd.state()!=="rejected")return this.followersDfd.promise();var e=$.Deferred(),t=this.get("followers");if(t)e.resolve(t);else{if(!!this.get("favoriteUsers"))return this._super("getFollowers");var r=function(){if(this.id<=0)t=new n.Models.Collections.Users([]),this.set({followers:t}),e.resolve(t);else if(!this.get("favoriteUsers")){n.Services.API.userGetFollowersFollowing().done(_.bind(E,this,e,"Followers")).fail(_.bind(E,this,e,"Followers"));var r=$.Deferred(),i=this;this.favoriteUsersDfd=r,e.done(_.debounce(function(){r.resolve(i.get("favoriteUsers"))},0)).fail(function(e){r.reject(e)});var s=$.Deferred();this.friendsDfd=s,e.done(_.debounce(function(){s.resolve(i.get("friends"))},0)).fail(function(e){s.reject(e)})}};this.get("oldUserClean")?this.get("oldUserClean").done(_.bind(r,this)):r.call(this),this.followersDfd=e}return e.promise()},getFavoritesByType:function(e,t){if(e!=="Users"&&e!=="Playlists"&&e!=="Broadcasts")return this._super("getFavoritesByType",e);var r=e;t&&(r=e+="Metadata");if(this["favorite"+r+"Dfd"]&&this["favorite"+r+"Dfd"].state()!=="rejected")return this["favorite"+r+"Dfd"].promise();var i=$.Deferred(),s=this.get("favorite"+e),o,u;if(s)i.resolve(s);else if(e==="Users"&&!this.get("favoriteUsers"))u=function(){if(this.id<=0)s=new n.Models.Collections[e]([]),this.set("favorite"+e,s),i.resolve(s);else{n.Services.API.userGetFollowersFollowing().done(_.bind(E,this,i,"Following")).fail(_.bind(E,this,i,"Following"));var t=$.Deferred(),r=this;this.followersDfd=t,i.done(_.debounce(function(){t.resolve(r.get("followers"))},0)).fail(function(e){t.reject(e)});var o=$.Deferred();this.friendsDfd=o,i.done(_.debounce(function(){o.resolve(r.get("friends"))},0)).fail(function(e){o.reject(e)})}},this.get("oldUserClean")?this.get("oldUserClean").done(_.bind(u,this)):u.call(this),this["favorite"+r+"Dfd"]=i;else if(e==="Playlists")o=this.get("favoritePlaylists"),o?i.resolve(o):u=function(){this.getFavoritePlaylistsBroadcasts().always(_.bind(function(){var e=this.get("favoritePlaylists");e?i.resolve(e):i.reject()},this))},this.get("oldUserClean")?this.get("oldUserClean").done(_.bind(u,this)):u.call(this),this["favorite"+r+"Dfd"]=i;else if(e==="Broadcasts"&&!t)o=this.get("favoriteBroadcasts"),o?i.resolve(o):this.getFavoritePlaylistsBroadcasts().always(_.bind(function(){var e=this.get("favoriteBroadcasts");e?i.resolve(e):i.reject()},this)),this["favorite"+r+"Dfd"]=i;else{if(e!=="Broadcasts"||!t)return this._super("getFavoritesByType",e);o=this.get("favoriteBroadcasts"),o&&o.includedMetadata?i.resolve(o):(u=function(){this.id<=0?(s=new n.Models.Collections.Broadcasts([]),this.set("favoriteBroadcasts",s),s.includeMetadata=!0,i.resolve(s)):n.Services.API.getFavoriteBroadcasts().always(_.bind(function(e){if(!e){i.reject();return}s=new n.Models.Collections.Broadcasts(e),s.includeMetadata=!0,s.each(function(e){e.set("isFavorite",!0)}),this.set("favoriteBroadcasts",s),i.resolve(s)},this))},this.get("oldUserClean")?this.get("oldUserClean").done(_.bind(u,this)):u.call(this)),this["favorite"+r+"Dfd"]=i}return i.promise()},getFavoritePlaylistsBroadcasts:function(){if(this.getFavoritePlaylistsBroadcastsDfd)return this.getFavoritePlaylistsBroadcastsDfd.promise();var e=$.Deferred(),t=this.get("favoritePlaylists"),r=this.get("favoriteBroadcasts");if(t&&r)e.resolve();else{var i=_.bind(function(){this.id<=0?(t=new n.Models.Collections.Playlists([]),r=new n.Models.Collections.Broadcasts([]),r.includeMetadata=!0,this.set({favoritePlaylists:t,favoriteBroadcasts:r}),e.resolve()):(n.Services.API.getSubscribedPlaylistsBroadcasts().always(_.bind(S,this,e)),this.getFavoritePlaylistsBroadcastsDfd=e)},this);this.get("oldUserClean")?this.get("oldUserClean").done(i):i()}return e.promise()},getFriends:function(){if(this.friendsDfd&&this.friendsDfd.state()!=="rejected")return this.friendsDfd.promise();var e=$.Deferred(),t=new n.Models.Collections.Users([]);this.get("followers")&&this.get("favoriteUsers")&&t.reset(_.intersection(this.get("followers").models,this.get("favoriteUsers").models));if(t.length)e.resolve(t);else{var r=function(){if(this.id<=0)t=new n.Models.Collections.Users([]),this.set("friends",t),e.resolve(t),this.friendsDfd=e;else{n.Services.API.userGetFollowersFollowing().done(_.bind(E,this,e,"Friends")).fail(_.bind(E,this,e,"Friends")),this.friendsDfd=e;var r=$.Deferred(),i=this;this.followersDfd=r,e.done(_.debounce(function(){r.resolve(i.get("followers"))},0)).fail(function(e){r.reject(e)});var s=$.Deferred();this.favoriteUsersDfd=s,e.done(_.debounce(function(){s.resolve(i.get("favoriteUsers"))},0)).fail(function(e){s.reject(e)})}};this.get("oldUserClean")?this.get("oldUserClean").done(_.bind(r,this)):r.call(this)}return e.promise()},getRecommendedUsers:function(){return this.recommendedUsersDfd&&this.recommendedUsersDfd.state()!=="rejected"?this.recommendedUsersDfd.promise():(this.recommendedUsersDfd=new $.Deferred,this.get("recommendedUsers")?this.recommendedUsersDfd.resolve(this.get("recommendedUsers")):this.get("isLoggedIn")?n.Services.API.userGetRecommendedUsers().done(_.bind(H,this)):this.recommendedUsersDfd.reject(),this.recommendedUsersDfd.promise())},getPlaylistsMenu:function(e,t,r,i){function a(e,t){o.id>0?n.trigger("lightbox:open","createPlaylist",{songs:e}):n.trigger("lightbox:open","login",{message:_.getString("LB_LOGIN_MUST_LOGIN_TO_CREATE_PLAYLIST"),onLogin:function(t){n.trigger("lightbox:open","createPlaylist",{songs:e})}}),t&&(n.trigger("guts:log","newPlaylistFromSongsClicked",{elementType:"queueMenu"}),n.trigger("guts:gatrack","player","newPlaylistFromSongsClicked"))}e=_.orEqual(e,!1),t=_.orEqual(t,!0);var s=[],o=this,u=new n.Models.Collections.Playlists(this.get("playlists")?this.get("playlists").models:[]);t&&(s.push({key:"CONTEXT_NEW_PLAYLIST",title:_.getString("CONTEXT_NEW_PLAYLIST"),customClass:"jj_menu_item_new_playlist",action:{type:"fn",callback:function(){r.hasOwnProperty("songs")?a(r.songs,r.fromQueue):r.modelObj&&_.isFunction(r.modelObj.getSongs)&&r.modelObj.getSongs().done(function(e){a(e.toArray(),r.fromQueue)})}}}),u&&u.length!==0&&s.push({customClass:"separator"}));var f=!1;u.comparator=function(e){return e.get("PlaylistName").toLowerCase()},u.sort(),u.each(function(e){s.push({title:e.escape("PlaylistName"),customClass:"jj_menu_item_playlist",action:{type:"fn",callback:function(){return i(e),!0}}}),f=!0});var l=this.get("collabPlaylists")?new n.Models.Collections.Playlists(this.get("collabPlaylists").models):[];f&&l.length&&u.push({customClass:"separator"}),l.length&&(l.comparator=function(e){return e.get("PlaylistName").toLowerCase()},l.sort(),l.each(function(e){s.push({title:e.escape("PlaylistName"),customClass:"jj_menu_item_playlist",action:{type:"fn",callback:function(){return i(e),!0}}})}));if(e){var c=this.get("favoritePlaylists")?new n.Models.Collections.Playlists(this.get("favoritePlaylists").models):[];c.length&&(c.comparator=function(e){return e.get("PlaylistName").toLowerCase()},c.sort(),c.each(function(e){s.push({title:e.escape("PlaylistName"),customClass:"jj_menu_item_playlist",action:{type:"fn",callback:function(){return i(e),!0}}})}))}return s},getLeapLib:function(){n.Services.Local.get("leapLib"+this.id)&&n.trigger("leap:loadLib")},addLocalSongListen:function(e,t,r){var i={},s=this.get("settings");e&&t&&s&&s.local&&_.isArray(s.local.recentListens)&&(i.recentListens=n.Models.User.addListenToRecentListensArray(s.local.recentListens,e,t)),r&&this.saveLocalSettings(i)},saveLocalSettings:function(e){if(!e)return;var t=this.get("UserID");typeof e.restoreQueue!="undefined"&&n.Services.Local.set("player.restoreQueue",e.restoreQueue),typeof e.artistsPlayed!="undefined"&&n.Services.Local.set("artistsPlayed"+t,e.artistsPlayed),typeof e.recentListens!="undefined"&&n.Services.Local.set("recentListens"+t,e.recentListens),typeof e.broadcastAutoApprove!="undefined"&&n.Services.Local.set("broadcast.autoApprove"+t,e.broadcastAutoApprove),typeof e.inviteOnCreate!="undefined"&&n.Services.Local.set("broadcast.inviteOnCreate"+t,e.inviteOnCreate);if(typeof e.recentBroadcasts!="undefined"){var r=e.recentBroadcasts,i=n.Services.Local.get("broadcast.recent"+t);_.isArray(i)||(i=[]);if(!_.isArray(r)){var s=[r];_.each(i,function(e){if(typeof e!="string"&&e.UserID===r.UserID)return;if(typeof e=="string"&&e===r.BroadcastID)return;s.push(e)}),r=_.first(s,6)}e.recentBroadcasts=r,n.Services.Local.set("broadcast.recent"+t,e.recentBroadcasts)}var o=["lowerQuality","noPrefetch","playPauseFade","crossfadeAmount","crossfadeEnabled","lastShuffle","persistShuffle"];for(var u=0;u<o.length;u++)typeof e[o[u]]!="undefined"&&n.Services.Local.set("player."+o[u]+t,e[o[u]]);var a=["disablePlayerShortcuts","persistSidebar","themeFlags","tooltips"];for(var u=0;u<a.length;u++)typeof e[a[u]]!="undefined"&&n.Services.Local.set("user."+a[u]+t,e[a[u]]);var f={local:e},l=this.get("settings");l=$.extend(!0,{},l,f),this.set("settings",l)},savePrivacySettings:function(e,t,r,i){var s=_.chainLoading(!0),o=new $.Deferred,u=!1,a=this.get("Privacy"),f=this.get("Privacy"),l;if(_.defined(e))switch(e){case 1:this.get("Privacy")&1||(a=a&-3|1,u=!0),r&&s.push(n.Services.API.deleteFeedEvents().fail(s.bind(function(){n.trigger("notification:add",{title:_.getString("SETTINGS_DELETE_FAILED_TITLE"),type:"error",description:_.getString("SETTINGS_DELETE_FAILED")})}),this));break;case 0:(this.get("Privacy")&3)>0?(a&=-4,u=!0):(this.get("sessionPrivacy")&1)>0&&(f&=-2);break;case 2:this.get("Privacy")&2||(a=a&-2|2,u=!0);break;case-1:if(!(this.get("Privacy")&1)||!(this.get("sessionPrivacy")&1))f|=1}if(_.defined(t))switch(t){case 4:this.get("Privacy")&4||(a=a&-9|4,u=!0);break;case 0:(this.get("Privacy")&12)>0?(a&=-13,u=!0):(this.get("sessionPrivacy")&4)>0&&(f&=-5);break;case 8:this.get("Privacy")&8||(a=a&-5|8,u=!0);break;case-4:if(!(this.get("Privacy")&4)||!(this.get("sessionPrivacy")&4))f|=4}if(_.defined(i)){var c=this.get("Privacy")&16;!i&&!c?(a|=16,u=!0):i&&c&&(a&=-17,u=!0)}return l=a,u?s.add(n.Services.API.changePrivacySettings(a).done(s.bind(function(e){if(!e||e.statusCode!==1){o.reject();return}this.set({sessionPrivacy:a,Privacy:a})},this)).fail(s.bind(o.reject,o))):f!==this.get("sessionPrivacy")&&(this.set("sessionPrivacy",f),l=f),s.done(function(){o.resolve(l)}),o.promise()},saveLocalChatSettings:function(e){var t=this.get("UserID");e.hasOwnProperty("joinLeftDisabled")&&n.Services.Local.set("broadcast.chat.joinLeftDisabled"+t,!!e.joinLeftDisabled),e.hasOwnProperty("nowPlayingDisabled")&&n.Services.Local.set("broadcast.chat.nowPlayingDisabled"+t,!!e.nowPlayingDisabled),e.hasOwnProperty("suggestionsDisabled")&&n.Services.Local.set("broadcast.chat.suggestionsDisabled"+t,!!e.suggestionsDisabled),e.hasOwnProperty("ignoreChatTag")&&n.Services.Local.set("chat.ignoreChatTag"+t,!!e.ignoreChatTag),this.set("settings",j(t))},deletePlaylist:function(e,t){t=_.orEqual(t,!0);var r=$.Deferred(),i=n.Models.Playlist.getCached(e);return i&&i.get("UserID")===this.get("UserID")?n.Services.API.deletePlaylist(i.get("PlaylistID"),i.get("PlaylistName")).done(_.bind(N,this,i,r,t)).fail(_.bind(C,this,i,r,t)):r.reject(),r.promise()},restorePlaylist:function(e,t){t=_.orEqual(t,!0);var r=$.Deferred(),i=n.Models.Playlist.getCached(e);return n.Services.API.playlistUndelete(i.get("PlaylistID")).done(_.bind(k,this,i,r,t)).fail(_.bind(L,this,i,r,t)),r.promise()},deleteBroadcast:function(e,t){t=_.orEqual(t,!0);var r=$.Deferred(),i=n.Models.Broadcast.getCached(e);if(i){var s=this.get("artistsOwned"),o=i.get("ArtistID"),u=i.get("UserID");!o&&u!==this.get("UserID")||o&&(!s||!s.get(o))?r.reject():n.Services.API.deleteBroadcast(i.get("BroadcastID"),o).done(_.bind(A,this,i,r,t)).fail(_.bind(O,this,i,r,t))}else r.reject();return r.promise()},restoreBroadcast:function(e,t){t=_.orEqual(t,!0);var r=$.Deferred(),i=n.Models.Broadcast.getCached(e);if(i){var s=this.get("artistsOwned"),o=i.get("ArtistID"),u=i.get("UserID");!o&&u!==this.get("UserID")||o&&(!s||!s.get(o))?r.reject():n.Services.API.undeleteBroadcast(i.get("BroadcastID"),o).done(_.bind(M,this,i,r,t)).fail(_.bind(D,this,i,r,t))}else r.reject();return r.promise()},loadCommunityFeed:function(e){if(this.communityFeedDfd&&this.communityFeedDfd.state()!=="rejected"&&!e)return this.communityFeedDfd.promise();this.communityFeedDfd=new $.Deferred;if(!e&&this.get("communityFeed"))this.communityFeedDfd.resolve(this.get("communityFeed"));else if(this.get("isLoggedIn")){var t=null;if(e){var r=this.get("communityFeed");r&&r.length&&(t=this.get("communityFeed").last().get("timestamp"))}n.Services.API.getUserCombinedFeedEx(this.id,[],t).done(_.bind(P,this,e)).fail(_.bind(this.communityFeedDfd.reject,this.communityFeedDfd))}else this.communityFeedDfd.reject();return this.communityFeedDfd.promise()},getNotifications:function(){if(this.userNotificationsDfd&&this.userNotificationsDfd.state()!=="rejected")return this.userNotificationsDfd.promise();this.userNotificationsDfd=new $.Deferred;if(this.get("notifications"))this.userNotificationsDfd.resolve(this.get("notifications"));else if(this.get("isLoggedIn")){var e=t;if((this.get("Flags")&n.Models.User.FLAG_OWNS_ARTIST)>0){var r=this.get("artistsOwned");r&&r.length>2?e=200:e=100}n.Services.API.getUserNotifications(e).done(_.bind(F,this,this.userNotificationsDfd)).fail(_.bind(this.userNotificationsDfd.reject,this.userNotificationsDfd))}else this.userNotificationsDfd.reject();return this.userNotificationsDfd.promise()},onNewNotification:function(e){if(!e||!this.get("notifications"))return;e.timestamp||(e.timestamp=(new Date).getTime()),e.isNew=!0,e=new n.Models.Taco(e,{dontCache:!0}),this.get("notifications").unshift(e);var i=e.get("data"),s=e.get("genericType");if(s===5&&i&&i.claimStatus===9){(this.get("Flags")&n.Models.User.FLAG_OWNS_ARTIST)===0&&this.set("Flags",this.get("Flags")|n.Models.User.FLAG_OWNS_ARTIST);var o=i.artistName,u=i.artistID;this.getOwnedArtists(!0).done(function(){n.trigger("notification:add",{title:_.getString("NOTIF_EVENT_ARTIST_APPROVED",{name:_.escape(o)}),url:n.Models.Artist.getArtistUrl(u,o),icon:"artist icon-artist-white-active",type:"success"})})}else{if(!i||s!==2&&s!==3){if(e.get("activityName")==="comment")n.Models.FeedEvent.uncacheID(e.get("eventID"));else if(i&&s===8&&i.follower&&i.follower.UserID){var a=n.Models.User.newOrUpdate(i.follower);this.get("followers").add(a)}}else n.Models.Comment.clearCachedCommentsForItemType(i.ItemID,i.TypeID);var f=e.getNormalizedObject(this);if(!f)return;var l=e.get("forArtistID");(!l||l&&l==this.get("artistID"))&&n.trigger("notification:add",{title:f.text,url:f.link?f.link:t,icon:"artist icon-artist-white-active",type:f.icon?f.icon:t,duration:1e4,click:function(){if(f.link)return!1;i&&(s===2||s===3)&&i.TypeID==n.Models.Comment.COMMENT_PAGE_TYPES.SONG&&r.navigateToSong(i.ItemID,"comment/"+i.CommentID)}})}},onNewFeedEvent:function(e){if(!e)return;var t=this.get("communityFeed");e.timestamp||(e.timestamp=Math.floor((new Date).getTime()/1e3)),e.activityName==="artistBroadcastFeed"?e.type="artist":e.type="user";if(n.Models.FeedEvent.getCached(e.eventID)){var r=n.Models.FeedEvent.getCached(e.eventID);t&&t.remove(r),r.updateSelf(e),e=r}else e=new n.Models.FeedEvent(e,{dontCache:!0}),(e.get("activityName")==="broadcast"||e.get("activityName")==="artistBroadcastFeed")&&e.get("UserID")==this.id&&e.set("forceDisplay",!0);t&&t.unshift(e);if(e.get("feedType")==="artist"&&e.get("ArtistID")){var i=n.Models.Artist.getCached(e.get("ArtistID"));i&&i.get("feed")&&i.get("feed").unshift(e)}n.trigger("authUser:newFeedEvent",e)},claimArtist:function(e){this.id>0?this.getClaimHistory().done(function(t){n.trigger("lightbox:open","claimArtist",{artist:e})}):n.trigger("lightbox:open","login",{message:_.getString("LB_LOGIN_MUST_LOGIN_TO_CLAIM_ARTIST"),onLogin:function(t){t.claimArtist(e)}})},getUserAge:function(){var e=this.get("TSDOB"),t="";return e?(t=e.match(/(\d+)/g),_.dobToAge(Number(t[0]),Number(t[1])-1,Number(t[2]))):!1},getUserStringForAnalytics:function(){var e,t,r,i,s,o="";e=this.get("isLoggedIn")?"Y":"N",t=_.orEqual(this.get("Sex"),"U"),r=this.getUserAge();switch(!0){case r>=13&&r<=17:i="A";break;case r>=18&&r<=23:i="B";break;case r>=24&&r<=29:i="C";break;case r>=30&&r<40:i="D";break;case r>=40&&r<50:i="E";break;case r>=50&&r<60:i="F";break;case r>=60&&r<70:i="G";break;case r>=70&&r<80:i="H";break;case r>=80&&r<90:i="I";break;case r>=90:i="J";break;default:i="U"}return s=(this.get("Flags")&n.Models.User.FLAG_OWNS_ARTIST)>0?"Y":"N",o+="L:"+e,o+=",S:"+t,o+=",A:"+i,o+=",C:"+s,o},getImageURL:function(e){return this.getUserImageURL(e)},getUserImageURL:function(e){return this._super.apply(this,["getImageURL",e])},getThemeImageURL:function(){return this.getUserThemeImageURL()},getUserThemeImageURL:function(){return this._super.apply(this,["getThemeImageURL"])},saveNotificationSettings:function(e){e=_.toInt(e);var t=$.Deferred();return e!==this.get("NotificationEmailPrefs")?n.Services.API.changeNotificationSettings(e).done(_.bind(function(n){n&&n.statusCode?(this.set("NotificationEmailPrefs",e),t.resolve(e)):t.reject()},this)).fail(_.bind(t.reject,t)):t.resolve(e),t.promise()},setContext:function(t,r){this.clearLastBroadcast(),n.Services.API.reportUserChange(this),r||(n.router.setHash("/#!/"),$(e).trigger("hashchange"))},updateBroadcastInviteableUsers:function(){var t=this.get("broadcastInvites"),i=(Date.now()+e.clientTimeDivergence)/1e3>>0,s=Infinity,o=Infinity,u=14400,a=86400,f;if(!t||!this.get("isLoggedIn"))return;t.InvitedUsers&&_.forEach(t.InvitedUsers,function(e,t){var f=n.Models.User.getCached(t);if(!f)return;var l=_.toInt(f.get("broadcastTimeInvited")),c=_.toInt(f.get("broadcastTimeInvitedEmail")),h=_.toInt(e[1]),p=_.toInt(e[2]),d=Math.max(h,l),v=Math.max(p,c),m=r.model.get("user").get("currentBroadcastID"),g=f.get("currentBroadcastID"),y=(!d||i-d>u)&&m!==g,b=!v||i-v>a;f.set({canBroadcastInvite:y,broadcastTimeInvited:d,canBroadcastInviteEmail:b,broadcastTimeInvitedEmail:v}),s=Math.min(d,s),o=Math.min(v,o)}),f=s===Infinity&&o===Infinity?1:Math.min(s+u,o+a),this.set("checkBroadcastInvitesTime",f)},getCurrentMasterStatus:function(){if(!this.currentMasterStatusDfd||this.currentMasterStatusDfd.state()!=="pending"){this.currentMasterStatusDfd=$.Deferred();var e=setTimeout(_.bind(function(){this.currentMasterStatusDfd&&this.currentMasterStatusDfd.reject()},this),7e3);this.currentMasterStatusDfd.always(_.bind(function(){delete this.currentMasterStatusDfd,clearTimeout(e)},this));var t=this.get("UserID");n.Services.SWF.ready.done(function(){n.Services.SWF.connectToChat(),n.Services.SWF.chatReady.done(function(){n.Services.SWF.getSelfMasterStatus()})})}return this.currentMasterStatusDfd.promise()},subscribeToStatus:function(){var e=n.Models.User.getUserStatusDfds[this.id];if(!e||e.state()!="pending"){e=$.Deferred();var t={status:this.get("onlineStatus"),bcastOwner:this.get("isOwnerOfCurrentBroadcast"),bcast:this.get("currentBroadcastID"),bcastName:this.get("currentBroadcastName"),bcastPic:this.get("currentBroadcastPicture"),bcastOwnerInfo:null,song:null},r=this.get("currentBroadcastOwner"),i=this.get("nowPlayingSong");r&&(t.bcastOwnerInfo=r),i&&(t.song=i.getDetailsForSwf()),e.resolve(t,this.id),n.Models.User.getUserStatusDfds[this.id]=e}return e.promise()}},{checkEmailUsername:function(e,t,r){var i=$.Deferred(),s={username:-1,email:-1};if(!t||t.length>=5&&t.length<=32&&t.match(Z))s.username=t;if(!e||e.match(Y))s.email=e;return r||(!s.email||s.email===-1)&&(!s.username||s.username===-1)?i.resolve(s):(typeof t=="undefined"&&(t=""),n.Services.API.getIsUsernameEmailAvailable(t,e,function(n){n.email&&(n.email=e),n.username&&(n.username=t),i.resolve(n)},function(){i.reject()})),i.promise()}})}(),function(){n.Models=n.Models||{};var e;n.Models.Profile=e=Backbone.CachedModel.extend({idAttribute:"ProfileID",parse:function(t,r){var i=r||{},s=!1,o=!1,u=t.pageNames,a=t.artist,f=t.user,l,c,h,p;h=t.profile&&_.toInt(t.profile.ProfileID)||t.user&&_.toInt(t.user.UserID||t.user.id);if(a){var d;a instanceof n.Models.Artist?d={ArtistID:a.id}:d=_.clone(a),d.profileID=h,a=e.importArtist(d,u&&u.artist,i),p=a.get("ArtistID"),o=!0}if(f){var v;f instanceof n.Models.User?v={UserID:f.id}:v=_.clone(f),v.isArtist=!!p,v.artistID=p,f=e.importUser(v,u&&u.user,i)}var m={ProfileID:h,isArtist:o,artist:a,user:f,profile:t.profile,attemptedPageNames:t.attemptedPageNames,pageNames:u};return m},updateFromNew:function(e,t){var n=_.defaults({},this.attributes,e);e.artist instanceof Backbone.Model&&(n.artist=e.artist),e.user instanceof Backbone.Model&&(n.user=e.user),this.set(n,t)}},{get:function(e,t,r,i,s){r=r!==!1,i=i!==!1;var o=$.Deferred(),u,a,f=n.Models.User.getCached(e),l=t&&n.Models.Artist.getCached(t),c=f&&f.get("Flags"),h=!_.isUndefined(c)&&c&n.Models.User.FLAG_ARTIST_PROFILE;return e&&(a=n.Models.Profile.getCached(e)),!a&&l&&l.get("profileID")&&(a=n.Models.Profile.getCached(l.get("profileID"))),a&&(a.get("attemptedPageNames")||f&&f.get("pageNameData")&&l&&l.get("pageNameData"))?(o.resolve(a),o.promise()):(f&&(!h||l)&&(r&&(r=!1),i&&f.get("pageNameData")&&(!h||l.get("pageNameData"))&&(i=!1)),!r&&!i&&f?(a=n.Models.Profile.newOrUpdate({user:f,artist:l},s),o.resolve(a),o.promise()):(t?u=n.Services.API.getProfileInfoByID(null,t,r,i):e?u=n.Services.API.getProfileInfoByID(e,null,r,i):u=$.Deferred().reject(),u.done(function(e){if(!e||!e.user){o.reject(e);return}e=_.clone(e),i&&(e.attemptedPageNames=!0);var t=n.Models.Profile.newOrUpdate(e,s);o.resolve(t)}).fail(function(e){o.reject(e)}),o.promise()))},importUser:function(e,t,r){var i;return t&&(e.PathName=(t.Name&&t.Name.indexOf("/")>-1?"":t.Name)||"",e.pageNameData=t.Data,e.pageNameSource="profile"),r&&r.overrideUser?(i=r.overrideUser,e=n.Models.AuthUser.prototype.parse.call(i,e,r),i.updateFromNew(e)):i=n.Models.User.newOrUpdate(e,r),e.PathName&&n.router.cachePageName(e.PathName,"user",i.id),i},importArtist:function(e,t,r){var i,s;return t&&(e.PathName=(t.Name&&t.Name.indexOf("/")>-1?"":t.Name)||"",e.pageNameData=t.Data,e.pageNameSource="profile"),!_.isUndefined(e.IsVerified)&&!_.isUndefined(e.CoverArtFilename)&&(s=!0),i=n.Models.Artist.newOrUpdate(e,r),s&&(i._gotExtraDetails=!0),e.PathName&&n.router.cachePageName(e.PathName,"artist",i.id),i}})}(),function(){function i(e){var t=[],r={};_.each(e,_.bind(function(e){e.playlistSongID=[this.id,":",this.lastPlaylistSongID++].join(""),t.push(e);var n=e.AlbumID;n&&(r[n]?r[n].IsVerified!=1&&(r[n].IsVerified=e.IsVerified):r[n]={AlbumID:n,AlbumName:e.AlbumName,ArtistID:e.ArtistID,ArtistName:e.ArtistName,CoverArtFilename:e.CoverArtFilename,IsVerified:e.IsVerified})},this));var i=new n.Models.Collections.PlaylistSongs(t);this.set({songs:i,albums:new n.Models.Collections.Albums(_.toArray(r))})}function s(e){if(e.get("SongID")<=0)return;var t=n.getLoggedInUserID(),r=$.Deferred();n.Services.API.playlistAddSongToExisting(this.get("PlaylistID"),e.get("SongID"),e.getDetailsForFeeds()).done(_.bind(l,this,r,e,!0)).fail(_.bind(h,this,r))}function o(e,t,r){var i=$.Deferred(),s=[],o=[],u;for(var a=0;a<e.length;a++)s.push(e[a].get("SongID")),o.push(e[a].getDetailsForFeeds());return t=_.orEqual(t,!0),r?u=_.bind(c,this,i,e,t,!0):u=_.bind(f,this,i,e,t,!0),n.Services.API.overwritePlaylist(this.get("PlaylistID"),this.get("PlaylistName"),s,o).done(u).fail(_.bind(h,this,i)),n.trigger("guts:log","savePlaylist",{playlistID:this.get("PlaylistID")}),i.promise()}function u(e){var t=this.get("changeLog");t.push(e),t.length>10&&t.shift()}function a(e){var t=e.get("PlaylistName");t&&t.length>18&&(t=t.substr(0,15)+"..."),n.trigger("notification:add",{title:_.getString("POPUP_PLAYLIST_SAVE_TITLE",{playlist:"<i>"+_.escape(t)+"</i>"}),description:_.getString("POPUP_PLAYLIST_SAVE_DESCRIPTION"),url:e.toUrl(),icon:"subbed-playlist icon-subbed-playlist-white-active",type:"success"})}function f(e,t,i,s,o){if(!o)return n.trigger("notification:add",{description:_.getString("POPUP_FAIL_SAVE_PLAYLIST_MSG",{playlist:this.escape("PlaylistName")}),type:"error"}),!1;if(o==-1)return n.trigger("notification:add",{title:_.getString("POPUP_FAIL_PLAYLIST_ADD_TITLE"),description:_.getString("POPUP_FAIL_PLAYLIST_ADD_MSG"),type:"error"}),!1;if(this.get("songs")){i=_.orEqual(i,!0);if(i){var f=this.get("songs").toArray();u.call(this,f)}this.get("songs").reset(t),this.set("TSModified",(new Date).getTime()),a(this)}n.trigger("guts:gatrack","playlist","savePlaylist"),s,r.model.get("user").syncUserContentChange("playlistSongsChange",{items:[this.get("PlaylistID")]},"playlistSongsChange"),e.resolve()}function l(e,t,i,s,o){if(!s)return n.trigger("notification:add",{description:_.getString("POPUP_FAIL_SAVE_PLAYLIST_MSG",{playlist:this.escape("PlaylistName")}),type:"error"}),!1;if(s==-1)return n.trigger("notification:add",{title:_.getString("POPUP_FAIL_PLAYLIST_ADD_TITLE"),description:_.getString("POPUP_FAIL_PLAYLIST_ADD_MSG_SINGLE"),type:"error"}),!1;if(this.get("songs")){o=_.orEqual(o,!0);if(o){var f=this.get("songs").toArray();u.call(this,f)}this.get("songs").add(t)}a(this),i,e.resolve(),r.model.get("user").syncUserContentChange("playlistSongsChange",{items:[this.get("PlaylistID")]},"playlistSongsChange"),n.trigger("guts:gatrack","playlist","songsAddedToPlaylist","count",1),n.trigger("guts:forcelog","singleSongAddedToPlaylist",{playlistID:this.get("PlaylistID"),songID:t._wrapped.id})}function c(e,t,n,i,s){var o=this.get("changeLog");o.pop(),this.get("songs")&&(this.get("songs").reset(t),this.set("TSModified",(new Date).getTime()),a(this)),r.model.get("user").syncUserContentChange("playlistSongsChange",{items:[this.get("PlaylistID")]},"playlistSongsChange")}function h(e){e.reject()}n.Models=n.Models||{},n.Models.Playlist=Backbone.CachedModel.extend({idAttribute:"PlaylistID",parse:function(e,t){var r=t||{},i=e.Collaborators,s=""+_.orEqualEx(e.PlaylistName,e.Name,""),o=_.orEqual(e.Username,_.getString("UNKNOWN_USER"));i&&!(i instanceof n.Models.Collections.Users)&&(i=new n.Models.Collections.Users(i));var u={PlaylistID:_.toInt(e.PlaylistID),PlaylistName:s,Description:_.orEqualEx(e.Description,e.About,""),Picture:e.Picture,Username:o,UserName:_.orEqual(e.attributor,$.trim($.trim(e.FName)+" "+$.trim(e.LName))||o),UserID:_.toInt(e.UserID),Collaborators:i,Collaborative:_.orEqual(e.Collaborative,!!i),TSAdded:_.toInt(e.TSAdded),TSModified:_.toInt(e.TSModified),TSFavorited:_.toInt(e.TSFavorited),searchText:s.toLowerCase(),isFavorite:!!e.isFavorite||!!r.isFavorite,SongCount:e.SongCount,SubscriberCount:e.SubscriberCount,initialSongs:e.initialSongs,IsDeleted:e.IsDeleted,changeLog:[]};return u},initialize:function(e,t){this.lastPlaylistSongID=0;var n=this.get("initialSongs");n&&(i.call(this,n),this.unset("initialSongs",{silent:!0})),Backbone.CachedModel.prototype.initialize.call(this,e,t)},updateFromNew:function(e,t){var n=_.omitSameKeys(this.attributes,e);if(e.isFavorite||t&&t.isFavorite)n.isFavorite=!0;this.set(n,t)},getSongs:function(){if(this.loadSongsDfd)return this.loadSongsDfd.promise();var e=$.Deferred();return this.get("songs")?e.resolve(this.get("songs")):(n.Services.API.playlistGetSongs(this.id,this._skipSongsAPICache).done(_.bind(function(t){this._skipSongsAPICache=!1,i.call(this,t.Songs),e.resolve(this.get("songs"))},this)).fail(function(t){e.reject(t)}),this.loadSongsDfd=e),e.promise()},clearSongs:function(){this._skipSongsAPICache=!0,delete this.loadSongsDfd,delete this.loadAlbumsDfd,this.unset("songs"),this.unset("albums")},getUnwrappedSongs:function(){var e=this.getSongs(),t=$.Deferred();return e.done(function(e){e=e.models;var r=[];for(var i=0,s=e.length;i<s;i++)r.push(e[i]._wrapped);t.resolve(new n.Models.Collections.Songs(r))}).fail(function(){t.reject.apply(t,arguments)}),t},getAlbums:function(){if(this.loadAlbumsDfd)return this.loadAlbumsDfd.promise();var e=new $.Deferred;return this.get("albums")?e.resolve(this.get("albums")):(this.getSongs().done(_.bind(function(){e.resolve(this.get("albums"))},this)).fail(function(t){e.reject(t)}),this.loadAlbumsDfd=e),e.promise()},getFans:function(){if(this.loadFansDfd)return this.loadFansDfd.promise();var e=$.Deferred();return this.get("fans")?e.resolve(this.get("fans")):(n.Services.API.playlistGetFans(this.id).done(_.bind(function(t){if(t.Users){var r=new n.Models.Collections.Users(_.toArray(t.Users));this.set({fans:r}),e.resolve(r)}else e.reject(t)},this)).fail(function(t){e.reject(t)}),this.loadFansDfd=e),e.promise()},getImageURL:function(t){t=_.orEqual(t,200);var r=this.get("Picture"),i=n.Models.Playlist.artPath+t+"_playlist.png";return this.attributes.hasCustomImage?(t==200&&(t=120),i=n.Models.Playlist.featuredArtPath+t+"_"+this.get("Picture")):r&&(i=n.Models.Playlist.artPath+t+"_"+this.get("Picture")),gsConfig.runMode!=="production"&&(i+="?co="+e.location.host),i},getPlaylistArt:function(e){e=_.orEqual(e,200);var t=this.get("Picture");if(t)return[n.Models.Playlist.artPath+e+"_"+t];var r=[],i={},s=[];this.get("songs")&&(this.get("songs").each(function(e){e.get("CoverArtFilename")&&(i.hasOwnProperty(e.get("AlbumID"))?i[e.AlbumID].weight++:i[e.AlbumID]={CoverArtFilename:e.get("CoverArtFilename"),weight:1})}),s=_.toArray(i),s=s.sort(function(e,t){return t.weight-e.weight}).slice(0,4)),s.length==4&&(e=70);for(var o=0;o<s.length;o++)r.push(n.Models.Album.artPath+e+"_"+s[o].CoverArtFilename);return r.length?r:[n.Models.Playlist.artPath+e+"_playlist.png"]},addSongs:function(e,t){if(!this.isEditable())return;var r=!1;if(e[0]instanceof n.Models.PlaylistSong||e[0]instanceof n.Models.Song||e[0]instanceof n.Models.QueueSong||e[0]instanceof n.Models.BroadcastSuggestion)r=!0;var i=[],u,a,f;for(var l=0;l<e.length;l++){if(!e[l])continue;u=[this.id,":",this.lastPlaylistSongID++].join(""),a=r?e[l].get("SongID"):e[l],f=n.Models.Song.getCached(a),!f&&r&&(f=e[l]._wrapped||e[l],n.Models.Song.cache(f,{notifyCache:!0})),f&&a!==0&&i.push(new n.Models.PlaylistSong($.extend(f.toJSON(),{playlistSongID:u})))}if(i.length===0)return;e=i,t=_.orEqual(t,-1);var c=this.get("songs");if(e.length==1&&(c&&t==c.length||t===-1)){s.call(this,e[0]);return}this.getSongs().done(_.bind(function(r){if(e.length+r.length>2500){n.trigger("notification:add",{title:_.getString("POPUP_FAIL_PLAYLIST_ADD_TITLE"),description:_.getString("POPUP_FAIL_PLAYLIST_ADD_MSG"),type:"error"});return}var i=r.toArray();t==-1||t>=r.length?i.push.apply(i,e):i.splice.apply(i,[t,0].concat(e)),o.call(this,i,!0,!1).done(_.bind(function(){var t=[];for(var r=0;r<e.length;r++)t.push(e[r].get("SongID"));n.trigger("guts:gatrack","playlist","songsAddedToPlaylist","count",t.length),n.trigger("guts:forcelog","songsAddedToPlaylist",{playlistID:this.get("PlaylistID"),ids:t})},this))},this)).fail(function(){})},moveSongsTo:function(e,t){if(!this.isEditable())return!1;var n,r,i=[],s=this.get("songs").toArray();for(n=0;n<e.length;n++)i.push(s[e[n]]);for(n=0;n<i.length;n++)r=_.indexOf(s,i[n]),s.splice(r,1),r<t&&t--;s.splice.apply(s,[t,0].concat(i)),o.call(this,s,!0,!1)},undo:function(){var e=this.get("changeLog");o.call(this,e[e.length-1],!1,!0)},removeSongs:function(e){if(!this.isEditable())return!1;e.sort(function(e,t){return t-e});var t=this.get("songs").toArray(),r=[];for(var i=0;i<e.length;i++)r.push(t.splice(e[i],1)[0].get("SongID"));o.call(this,t,!0,!1).done(_.bind(function(){n.trigger("guts:gatrack","playlist","songsRemovedFromPlaylist","count",r.length),n.trigger("guts:forcelog","songsRemovedFromPlaylist",{playlistID:this.get("PlaylistID"),ids:r})},this))},overwriteWithSongs:function(e){var t=$.Deferred();if(!this.isEditable())return!1;var r=!1;if(e[0]instanceof n.Models.PlaylistSong||e[0]instanceof n.Models.Song||e[0]instanceof n.Models.QueueSong)r=!0;var i=[],s=[];for(var u=0;u<e.length;u++){var a=[this.id,":",this.lastPlaylistSongID++].join(""),f=r?n.Models.Song.getCached(e[u].get("SongID")):n.Models.Song.getCached(e[u]);i.push(new n.Models.PlaylistSong($.extend(f.toJSON(),{playlistSongID:a}))),s.push(f.get("SongID"))}return e=i,o.call(this,e,!0,!1).done(_.bind(function(){n.trigger("guts:gatrack","playlist","overwritePlaylist","count",s),n.trigger("guts:forcelog","overwritePlaylist",{playlistID:this.get("PlaylistID"),replacementSongIDs:s}),t.resolve()},this)).fail(function(){t.reject()}),t.promise()},toProxyLabel:function(){return _.getString("SELECTION_PLAYLIST_SINGLE",{PlaylistName:this.escape("PlaylistName"),Username:this.escape("UserName")})},getTitle:function(e){return e?['"',this.get("PlaylistName"),'" by ',this.get("UserName")].join(""):['"',this.escape("PlaylistName"),'" by ',this.escape("UserName")].join("")},isEditable:function(){return this.get("UserID")===n.getLoggedInUserID()},toUrl:function(e){return _.cleanUrl(this.get("PlaylistName"),this.get("PlaylistID"),"playlist",null,e)},toUserUrl:function(e){return _.cleanUrl(this.get("UserName"),this.get("UserID"),"profile",null,e)},rename:function(e){var t={messageType:"playlist",action:"rename",time:Math.floor(+(new Date)/1024),data:{userID:this.get("UserID"),name:e,playlistID:this.get("PlaylistID"),uuid:gsConfig.uuid}},i={publishers:[this.get("UserID")+""]},s=$.Deferred();return n.Services.API.renamePlaylist(this.get("PlaylistID"),e,!1).done(_.bind(function(t){this.set("PlaylistName",e),r.model.get("user").syncUserContentChange("playlistChange",{action:"rename",items:[this.toManateeProperties()]},"playlistUpdated"),s.resolve()},this)).fail(function(e){s.reject()}),s.promise()},changeDescription:function(e){var t={messageType:"playlist",action:"description",time:Math.floor(+(new Date)/1024),data:{userID:this.get("UserID"),name:e,playlistID:this.get("PlaylistID"),uuid:gsConfig.uuid}},r=$.Deferred();return n.Services.API.setPlaylistAbout(this.get("PlaylistID"),e,!1).done(_.bind(function(t){this.set("Description",e),r.resolve()},this)).fail(function(e){r.reject()}),r.promise()},getDetailsForFeeds:function(){var e={playlistID:this.get("PlaylistID"),playlistName:this.get("PlaylistName"),artFilename:this.get("Picture"),userID:this.get("UserID"),userName:this.get("UserName")};if(!this.get("UserName")){var t=n.Models.User.getCached(this.get("UserID"));t&&(e.userName=t.get("FName"))}return this.get("songs")&&(e.songs=[],e.numSongs=this.get("songs").length),e},getAnchorTag:function(e,t){return'<a href="'+this.toUrl(t)+'" class="playlist-link">'+(e?_.getString(e).toLocaleLowerCase():this.escape("PlaylistName"))+"</a>"},getAuthorAnchorTag:function(e,t){return'<a href="'+this.toUserUrl(t)+'" class="user-link">'+(e?_.getString(e).toLocaleLowerCase():this.escape("UserName"))+"</a>"},getWidgetCode:function(e,t,n){var r=["bbg","bth","pfg","lfg"],i=["bt","pbg","pfgh","si","lbg","lfgh","sb"],s=["bfg","pbgh","lbgh","sbh"],o="gsPlaylist"+this.get("PlaylistID")+Math.floor(Math.random()*101),u=_.orEqual(e,250),a=_.orEqual(t,40),f=_.escape(this.get("PlaylistName")+" by "+this.get("UserName")+" on Grooveshark"),l='<a href="http://grooveshark.com/search/playlist?q='+encodeURIComponent(this.get("PlaylistName")+" "+this.get("UserName"))+'" title="'+f+'">'+f+"</a>",c=[],h,p;for(h=0,p=r.length;h<p;h++)c.push(r[h]+"="+n.base);for(h=0,p=i.length;h<p;h++)c.push(i[h]+"="+n.primary);for(h=0,p=s.length;h<p;h++)c.push(s[h]+"="+n.secondary);return'<object width="'+u+'" height="'+a+'" classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000" id="'+o+'" name="'+o+'">'+'<param name="movie" value="http://grooveshark.com/widget.swf" /><param name="wmode" value="window" /><param name="allowScriptAccess" value="always" />'+'<param name="flashvars" value="hostname=grooveshark.com&playlistID='+this.get("PlaylistID")+"&p=0&"+c.join("&")+'" />'+'<object type="application/x-shockwave-flash" data="http://grooveshark.com/widget.swf" width="'+u+'" height="'+a+'"><param name="wmode" value="window" />'+'<param name="allowScriptAccess" value="always" /><param name="flashvars" value="hostname=grooveshark.com&playlistID='+this.get("PlaylistID")+"&p=0&"+c.join("&")+'" />'+"<span>"+l+"</span></object></object>"},getWidgetType:function(){return"multi"},toManateeProperties:function(){return{pID:this.get("PlaylistID"),pN:this.get("PlaylistName"),uID:this.get("UserID"),d:this.get("Description")}}},{featuredArtPath:"http://images.gs-cdn.net/static/featured/",artPath:"http://images.gs-cdn.net/static/playlists/",get:function(e){var t=Backbone.CachedModel.genericGet.call(this,n.Services.API.getPlaylistByID,"PlaylistID",e);return t.promise()},wrapFeedData:function(e){var t={PlaylistID:_.orEqual(e.playlistID,e.PlaylistID),PlaylistName:$.trim(_.orEqualEx(e.playlistName,e.PlaylistName,e.Name)),Username:$.trim(_.orEqualEx(e.owningName,e.userName,e.UserName)),UserID:_.orEqualEx(e.owningUserID,e.userID,e.UserID),Picture:e.artFilename};return!t.Username&&e.subscribingName&&(t.Username=e.subscribingName),n.Models.Playlist.newOrUpdate(t,{noCache:!0})},convertManateeProperties:function(e){return e?{PlaylistID:e.pID,PlaylistName:e.pN,UserID:e.uID,Description:e.d}:t},createdSort:function(e,t){return _.orEqual(t.get("TSAdded"),0)-_.orEqual(e.get("TSAdded"),0)},modifiedSort:function(e,t){return _.orEqual(t.get("TSModified"),0)-_.orEqual(e.get("TSModified"),0)},acceptDrop:function(e,t,n,r){function l(e){a=a.concat(e.toArray())}n=_.orEqual(n,-1),r=_.orEqual(r,!1);if(r){var i=[];return _.forEach(t.draggedItems,function(t){var n=e.get("songs").indexOf(t);n!=-1&&i.push(n)}),i.length?(e.moveSongsTo(i,n),!0):!1}var s,o,u,a=[],f=[];switch(t.draggedItemsType){case"song":return e.addSongs(t.draggedItems,n),!0;case"album":case"artist":case"playlist":for(s=0;s<t.draggedItems.length;s++)o=t.draggedItems[s],_.isFunction(o.getSongs)&&(u=o.getSongs().done(l),f.push(u));break;case"user":for(s=0;s<t.draggedItems.length;s++)o=t.draggedItems[s],_.isFunction(o.getFavorites)&&(u=o.getFavorites("Songs").done(l),f.push(u))}return f.length&&$.when.apply($,f).always(function(){a.length&&e.addSongs(a,n)}),!0}})}(),function(){n.Models=n.Models||{},n.Models.Video=Backbone.Model.extend({idAttribute:"UniqueVideoID",params:{allowscriptaccess:"always",allowfullscreen:!0},attributes:{name:"videoPlayer"},parse:function(e,t){var n=t||{},r=_.orEqualEx(e.embedType,e.type),i=_.orEqualEx(e.vimeoID,e.VimeoID,e.videoID,e.VideoID);if(!r||r=="iframe"&&(e.vimeoID||e.VimeoID))r="vimeo";this.flashvars={version:gsConfig.snapVersion};var s={title:_.orEqualEx(e.Title,e.title,e.Video,""),author:_.orEqualEx(e.Author,e.author,""),type:r,swf:_.orEqual(e.swf,"/webincludes/flash/videoplayer.swf"),src:_.orEqual(e.src,""),VideoID:i,VimeoID:_.orEqualEx(e.vimeoID,e.VimeoID,""),ArtistID:e.ArtistID||e.artistID,ArtistName:e.ArtistName||e.artistName,thumbnail:_.orEqual(e.thumbnail,e.Thumbnails&&e.Thumbnails.length&&e.Thumbnails[0]?e.Thumbnails[0].url:""),duration:_.millisToMinutesSeconds(_.orEqual(e.duration,e.Duration)*1e3),durationSecs:_.orEqual(e.duration,e.Duration),width:_.orEqualEx(e.Width,e.width,640),height:_.orEqualEx(e.Height,e.height,360),UniqueVideoID:r+i.toString(),Picture:e.Picture,clickToPlay:e.clickToPlay,attributor:e.attributor,tags:e.tags,info:e.info,hasCustomImage:e.hasCustomImage,gsArtistURL:e.gsArtistURL,gsSongURL:e.gsSongURL,url:e.url,uri:e.uri};return s},getImageURL:function(e){return e=_.orEqual(e,120),this.get("Picture")?n.Models.Video.artPath+e+"_"+this.get("Picture"):""},toArtistUrl:function(e){return n.Models.Artist.getArtistUrl(this.get("ArtistID"),this.get("ArtistName"),e)}},{artPath:"http://images.gs-cdn.net/static/featured/"})}(),function(){n.Models=n.Models||{},n.Models.Event=Backbone.Model.extend({idAttribute:"EventID",parse:function(e,n){var r=(e.EventName||"").replace(/\s\((.*?)\)$/,""),i=e.StartTime,s=e.EndTime,o,u,a;i&&!(i instanceof Date)&&(typeof i!="string"||i.indexOf("-")==-1?(o=_.toInt(i),i=new Date(o*1e3)):(u=i.split(" "),u.length>1?(a=u[1]?u[1].split(":"):"00:00:00",u=u[0].split("-"),i=new Date(parseInt(u[0],10),parseInt(u[1],10)-1,parseInt(u[2],10),parseInt(a[0],10),parseInt(a[1],10),parseInt(a[2],10))):i=t)),s&&!(s instanceof Date)&&(typeof s!="string"||s.indexOf("-")==-1?(o=_.toInt(s),s=new Date(o*1e3)):(u=s.split(" "),u.length>1?(a=u[1]?u[1].split(":"):"00:00:00",u=u[0].split("-"),s=new Date(parseInt(u[0],10),parseInt(u[1],10)-1,parseInt(u[2],10),parseInt(a[0],10),parseInt(a[1],10),parseInt(a[2],10))):s=t));var f={EventName:r,EventID:e.EventID,StartTime:i,EndTime:s,ArtistName:e.ArtistName,City:e.City,VenueName:e.VenueName,TicketsURL:e.TicketsURL,searchText:[r,e.ArtistName,e.City].join(" ").toLowerCase(),UserID:e.UserID,Tag:e.Tag,UserInfo:e.UserInfo,broadcast:e.broadcast,RecurrenceData:e.RecurrenceData,ArtistID:e.ArtistID};return f}},{})}(),function(){function t(t){var r={},i=0,s=e.length,o,u,a;for(;i<s;i++){o=e[i],u=this.attributes?this.attributes[o]:null,a=t&&$.isArray(t[o])?t[o]:!1;if(a){if(u instanceof Backbone.Collection){a.length>u.length&&u.reset(a),t[o]=u;continue}if(!$.isArray(u)||a.length>u.length)u=a}u&&$.isArray(u)&&(t[o]=new n.Models.Collections[o=="RelatedTags"?"Tags":o](u))}return t}function r(e){var t=new $.Deferred;return n.Services.API.getPageInfoByIDType(e,"tag").done(function(n){var r=n.Data;r&&r.Tag?(r.TagID=e,r.Albums=_.orEqual(r.Albums,[]),r.Artists=_.orEqual(r.Artists,[]),r.RelatedTags=_.orEqual(r.RelatedTags,[]),r.Songs=_.orEqual(r.Songs,[]),r.pageInfoLoaded=!0,r.pageMetaInfoLoaded=!0,r.source="getPageInfoByIDType",t.resolve(r)):t.reject(n)}).fail(function(e){t.reject(e)}),t.promise()}function i(e,t){if(!this.updateSelfDfd||this.updateSelfDfd.state()!="pending")this.updateSelfDfd=r(this.id);this.updateSelfDfd.done(_.bind(function(r){var i=n.Models.Tag.newOrUpdate(r);e.resolve(this.get(t))},this)).fail(function(){e.reject()})}n.Models=n.Models||{};var e=["RelatedTags","Songs","Albums","Artists"];n.Models.Tag=Backbone.CachedModel.extend({idAttribute:"TagID",parse:function(e,n){var r=r|{},i=_.orEqualEx(e.Tag,e.TagName,e.tag,""),s=t.call(this,{RelatedTags:e.RelatedTags,Songs:e.Songs,Albums:e.Albums,Artists:e.Artists}),o={TagID:_.orEqualEx(e.TagID,e.tid),Tag:i,DisplayName:_.ucwords(i,!0),searchText:i.toLowerCase(),RelatedTags:s.RelatedTags,Songs:s.Songs,Albums:s.Albums,Artists:s.Artists,pageInfoLoaded:_.defined(e.pageInfoLoaded)?e.pageInfoLoaded:!1,pageMetaInfoLoaded:_.defined(e.pageMetaInfoLoaded)?e.pageMetaInfoLoaded:!1,sampleSongs:_.defined(e.sampleSongs)?e.sampleSongs:!1,Description:e.Description||"",ShortDescription:e.ShortDescription||""};return o},updateFromNew:function(e,n){var r=t.call(this,e),i=_.omitSameKeys(this.attributes,r),s=r.TagName||r.Tag||r.tag||"";r.pageInfoLoaded&&(i.pageInfoLoaded=r.pageInfoLoaded),s&&!this.attributes.Tag&&(i.Tag=s,i.DisplayName=_.ucwords(s,!0),i.searchText=s.toLowerCase()),r.Description&&(i.Description=r.Description),r.ShortDescription&&(i.ShortDescription=r.ShortDescription),this.set(i,n)},getSongs:function(){var e=$.Deferred();return!this.attributes.pageInfoLoaded||!this.attributes.Songs||!this.attributes.Songs instanceof n.Models.Collections.Songs?i.call(this,e,"Songs"):e.resolve(this.attributes.Songs),e},getArtists:function(){var e=$.Deferred();return!this.attributes.pageInfoLoaded||!this.attributes.Artists||!this.attributes.Artists instanceof n.Models.Collections.Artists?i.call(this,e,"Artists"):e.resolve(this.attributes.Artists),e},getAlbums:function(){var e=$.Deferred();return!this.attributes.pageInfoLoaded||!this.attributes.Albums||!this.attributes.Albums instanceof n.Models.Collections.Albums?i.call(this,e,"Albums"):e.resolve(this.attributes.Albums),e},getRelatedTags:function(){var e=$.Deferred();return!this.attributes.pageInfoLoaded||!this.attributes.RelatedTags||!this.attributes.RelatedTags instanceof n.Models.Collections.Tags?i.call(this,e,"RelatedTags"):e.resolve(this.attributes.RelatedTags),e},getDescription:function(){var e=$.Deferred();return this.attributes.Description||this.attributes.source==="getPageInfoByIDType"?e.resolve(this.attributes.Description||""):i.call(this,e,"Description"),e},getShortDescription:function(){var e=$.Deferred();return this.attributes.ShortDescription||this.attributes.source==="getPageInfoByIDType"?e.resolve(this.attributes.ShortDescription||""):i.call(this,e,"ShortDescription"),e},toUrl:function(e){return _.cleanUrl(this.get("DisplayName"),this.id,"genre",null,e)},getImageURL:function(e){e=_.orEqual(e,80);var t=n.Models.Tag.artPath+e+"_"+this.get("TagID")+".jpg";return this.get("CoverArtFilename")?n.Models.Tag.artPath+e+"_"+this.get("CoverArtFilename"):t},getRandomArtists:function(e){var t=this.get("Artists");if(!t||t.length===0)return[];var n=[],r=Math.min(e,t.length),i,s=[];while(n.length<r)i=Math.floor(Math.random()*t.length),_.indexOf(n,i)==-1&&n.push(i);for(i=0;i<r;i++)s.push(t.at(n[i]));return s},toProxyLabel:function(){return this.get("DisplayName")+" - "+_.getString("STATION")}},{artPath:"http://images.gs-cdn.net/static/genres/",topGenres:[{title:"60's",tag:"60s",artists:"",tagID:7512},{title:"70's",tag:"70s",artists:"",tagID:2360},{title:"80's",tag:"80s",artists:"",tagID:424},{title:"90's",tag:"90s",artists:"",tagID:10,important:1},{title:"Alternate Rock",tag:"alternative rock",artists:"",tagID:7096},{title:"Ambient",tag:"ambient",artists:"",tagID:75},{title:"Bachata",tag:"bachata",artists:"",tagID:6310},{title:"Classical",tag:"classical",artists:"",tagID:750},{title:"Classic Rock",tag:"classic rock",artists:"",tagID:3529},{title:"Chillout",tag:"chillout",artists:"",tagID:678},{title:"Country",tag:"country",artists:"",tagID:1933},{title:"Cumbia",tag:"cumbia",artists:"",tagID:4271},{title:"Electronic",tag:"electronic",artists:"",tagID:156,important:1},{title:"Dance",tag:"dance",artists:"",tagID:814},{title:"Hip Hop",tag:"hip hop",artists:"",tagID:3502},{title:"Indie Folk",tag:"indie folk",artists:"",tagID:6939},{title:"Indie Rock",tag:"indie rock",artists:"",tagID:3773,important:1},{title:"Jazz",tag:"jazz",artists:"",tagID:1749},{title:"K-Pop",tag:"k-pop",artists:"",tagID:7588},{title:"Pop Rock",tag:"pop rock",artists:"",tagID:3489},{title:"R&B",tag:"r&b",artists:"",tagID:7614},{title:"Rap",tag:"rap",artists:"",tagID:1748,important:1},{title:"Reggae",tag:"reggae",artists:"",tagID:160},{title:"Samba",tag:"samba",artists:"",tagID:4285},{title:"World",tag:"world",artists:"",tagID:313}],get:function(e){var t=Backbone.CachedModel.genericGet.call(this,r,"TagID",e);return t.promise()},getMulti:function(e){var t=$.Deferred(),r=[],i=[],s;for(var o=0,u=e.length;o<u;o++)s=this.getCached(e[o]),s&&s.attributes.pageInfoLoaded?r.push(s):i.push(e[o]);return i.length?n.Services.API.getPageInfoByIDsType(i,"tag").done(function(e){r=r.concat(n.Models.Tag.convertPageNamesToTags(e)),t.resolve(r)}).fail(function(){r.length?t.resolve(r):t.reject()}):t.resolve(r),t.promise()},getMetaMulti:function(e){var t=$.Deferred(),r=[],i=[],s;for(var o=0,u=e.length;o<u;o++)s=this.getCached(e[o]),s&&s.attributes.pageMetaInfoLoaded?r.push(s):i.push(e[o]);return i.length?n.Services.API.getPageMetaInfoByIDsType(i,"tag").done(function(e){r=r.concat(n.Models.Tag.convertPageNamesToTags(e)),t.resolve(r)}).fail(function(){r.length?t.resolve(r):t.reject()}):t.resolve(r),t.promise()},getTagsSampleSongs:function(e){var t=$.Deferred(),r=[],i=[],s;for(var o=0,u=e.length;o<u;o++)s=this.getCached(e[o]),s&&s.attributes.pageInfoLoaded?r.push(s):i.push(e[o]);return i.length?n.Services.API.getTagsSampleSongs(i).done(function(e){r=r.concat(n.Models.Tag.convertPageNamesToTags(e,!0)),t.resolve(r)}).fail(function(){r.length?t.resolve(r):t.reject()}):t.resolve(r),t.promise()},convertPageNamesToTags:function(e,t){var r=[],i,s,o,u,a,f;if(e.length)for(i=0,s=e.length;i<s;i++){u=e[i].ItemID;if(!u)continue;o=e[i].Data||{},o.TagID=u,o.pageMetaInfoLoaded=!0,f=!1,o.Tag?t?(o.Songs=_.orEqual(o.Songs,[]),o.sampleSongs=!0,f=!0):(o.Albums=_.orEqual(o.Albums,[]),o.Artists=_.orEqual(o.Artists,[]),o.RelatedTags=_.orEqual(o.RelatedTags,[]),o.pageInfoLoaded=!0):e[i].NameFormatted&&(a=e[i].NameFormatted.split("/"),o.TagName=a[1].replace(/\+/g," ").replace(/(\d+) s$/i,"$1s"),o.TagName=="R B"&&(o.TagName="R&B")),r.push(n.Models.Tag.newOrUpdate(o,{noCache:f}))}return r},getTopLevelTags:function(){var e=$.Deferred();if(this.topLevel)e.resolve(this.topLevel);else{if(this.topLevelDfd&&this.topLevelDfd.state()=="pending")return this.topLevelDfd.promise();this.topLevelDfd=e,n.Services.API.getTopLevelTags().done(_.bind(function(t){$.isArray(t)?(this.topLevel=new n.Models.Collections.Tags(t),e.resolve(this.topLevel)):e.reject(t)},this)).fail(function(t){e.reject(t)})}return e.promise()},getTagList:function(){var e=$.Deferred();if(this.tagsList)e.resolve(this.tagsList);else{if(this.tagsListDfd&&this.tagsListDfd.state()=="pending")return this.tagsListDfd.promise();this.tagsListDfd=e,n.Services.API.getTagList().done(_.bind(function(t){if(t){var n,r;for(n in t)t.hasOwnProperty(n)&&(r=t[n],this.fixNameLookup.hasOwnProperty(r)&&this.fixNameLookup[r]!==n&&(delete t[n],t[this.fixNameLookup[r]]=r));this.tagsList=t,e.resolve(t)}else e.reject(t)},this)).fail(function(t){e.reject(t)})}return e.promise()},fixNameLookup:{10:"90's",44:"fusion",75:"ambient",84:"merengue",85:"flamenco",89:"vallenato",100:"ska",102:"oldies",104:"instrumental",130:"bhangra",131:"emo",134:"grunge",153:"downtempo",156:"electronic",160:"reggae",162:"electro",164:"gothic",191:"experimental",230:"blues",245:"hardcore",248:"jungle",267:"comedy",268:"grime",269:"dancehall",270:"breakbeat",275:"industrial",283:"trance",313:"world",424:"80s",443:"musicals",506:"bollywood",510:"synthpop",534:"britpop",625:"romantic",652:"broadway",678:"chillout",748:"crunk",750:"classical",787:"salsa",790:"latin",795:"crossover",807:"nerdcore",814:"dance",820:"baroque",893:"electropop",898:"house",901:"disco",919:"urban",922:"americana",940:"reggaeton",957:"celtic",963:"traditional",975:"mambo",1032:"swing",1086:"rockabilly",1102:"shoegaze",1140:"cabaret",1168:"psychedelic",1210:"mashup",1304:"anime",1332:"post-hardcore",1407:"mariachi",1408:"surf",1411:"metal",1416:"bolero",1430:"string",1489:"gospel",1535:"opera",1599:"jpop",1717:"symphonic",1747:"funk",1748:"rap",1749:"jazz",1750:"soul",1933:"country",1947:"bluegrass",1965:"screamo",2086:"trova",2177:"minimal",2195:"cuarteto",2260:"contemporary",2360:"70s",2412:"techno",2482:"piano",2536:"bebop",2563:"dubstep",2649:"spiritual",2760:"orchestra",2764:"boogie",2856:"rock",2868:"tango",3124:"thrash",3162:"schlager",3454:"rumba",3489:"pop rock",3502:"hip hop",3518:"nu jazz",3519:"acid jazz",3529:"classic rock",3598:"singer-songwriter",3606:"pagode",3625:"hymn",3664:"new age",3692:"chanson",3698:"avant-garde",3773:"indie rock",3855:"smooth jazz",3856:"hard rock",3907:"oldskool",3922:"trip hop",3975:"show tunes",3984:"heavy metal",4009:"soft rock",4028:"eurodance",4063:"power metal",4137:"progressive rock",4171:"nu metal",4271:"cumbia",4274:"hardstyle",4278:"motown",4281:"ragga",4283:"rocksteady",4285:"samba",4286:"sertanejo",5805:"afrobeat",6310:"bachata",6367:"chillwave",6369:"chiptune",6437:"electronic rock",6439:"electroswing",6462:"freestyle",6484:"glitch",6539:"jota",6550:"klasik",6635:"parranda",6680:"ranchera",6719:"soca",6771:"turntablism",6794:"zouk",6799:"blues rock",6834:"big band",6850:"jazz fusion",6869:"cool jazz",6873:"latin jazz",6875:"brazilian music",6878:"soul jazz",6879:"jazz funk",6893:"roots reggae",6897:"post punk",6903:"reggae dub",6928:"punk",6938:"folk rock",6939:"indie folk",6980:"breakbeat hardcore",6994:"pop music",7e3:"goa trance",7004:"psychedelic trance",7008:"vocal trance",7025:"tech house",7027:"happy hardcore",7030:"drum & bass",7036:"progressive house",7038:"electro house",7060:"deep house",7061:"funky house",7063:"neo soul",7066:"rave music",7071:"french music",7075:"edm",7077:"alt country",7085:"southern rock",7090:"old-time music",7091:"country rock",7096:"alternative rock",7109:"new country",7120:"folk music",7121:"garage rock",7126:"uk garage",7127:"intelligent dance music",7139:"electronic body music",7147:"minimal techno",7162:"post-dubstep",7167:"dance pop",7176:"new wave",7200:"indie electronic",7214:"bubblegum pop",7216:"indie pop",7226:"boy bands",7227:"pop punk",7248:"post rock",7252:"black metal",7253:"death metal",7273:"metal core",7319:"christian rock",7324:"doo-wop",7333:"ska punk",7393:"old school hip hop",7399:"gangsta rap",7409:"dirty south",7413:"witch house",7420:"christian music",7463:"british invasion",7469:"medieval music",7490:"dark wave",7512:"60s",7514:"children's music",7515:"classic country",7518:"easy listening",7520:"latin pop",7524:"90's alternative rock",7575:"video game music",7579:"contemporary christian",7588:"k-pop",7607:"italy",7614:"r&b",7623:"vocal music",7626:"film score",7647:"modern rock",7651:"beach music",7656:"underground hip hop",7675:"oi!",7699:"bossa nova",7711:"quiet storm",7756:"music of japan",7792:"nu-folk",7824:"asian music",7830:"sacred music",7862:"spanish rock",7864:"worship music",7873:"string quartet",7877:"banda music",7890:"chicano rap",7894:"rock n roll",7909:"dirty blues",7970:"acoustic guitar",7974:"jesus music",8024:"jazz guitar",8141:"pachanga",8143:"salsa romantica",8183:"slow jam",8191:"turkish music",8488:"christmas music"}})}(),function(){function e(e,r){var i=new n.Models.Collections.Songs(r||[]);return i.defaultOptions={disperseAlbums:!0,disperseArtists:!0,recentArtistsSize:5,recentAlbumsSize:5},i._options=_.clone(i.defaultOptions),i._enabled=i.length,i.frowns=new n.Models.Collections.QueueSongs([]),i.extraStreamFlags=0,i.setOptions=function(e){this._options=_.extend(this._options,e)},i.enable=function(t){if(e.get("currentBroadcast")){console.log("no radio in broadcast!");return}return this._enabled=!0,this._options=_.defaults(t||{},this.defaultOptions),e.set("clientRadioEnabled",!0),this},i.disable=function(){this._options=_.clone(i.defaultOptions),this._enabled=!1,this.extraStreamFlags=0,e.set("clientRadioEnabled",!1),this.off("needSongs"),this.reset([]),this.frowns=new n.Models.Collections.QueueSongs([]);var t=e.get("songs"),r=t.models[t.length-1];return r&&r.get("suggestion")&&n.trigger("player:removeSpecific",r.get("queueSongID"),e.get("queueID")),this},i.voteSong=function(t,n){var r=e.get("songs").get(t);r&&(r.set({autoplayVote:n,smile:n===1,frown:n===-1}),n<0?this.frowns.add(r):this.frowns.indexOf(r)!=-1&&this.frowns.remove(r))},i.chooseNextSong=function(r){r=_.defaults(r||{},{playOnAdd:!1});var i=e.get("activeSong"),s=e.get("songs");if(!this._enabled||e.get("autoplayEnabled"))return;var o=s.length?s.at(s.length-1):!1;if(o&&i&&o.get("context").type=="clientRadio"&&o!=i)return;var u=this.frowns.pluck("ArtistID"),a=this._options,f,l,c,h=function(e){return _.indexOf(u,e.get("ArtistID"))===-1};f=new n.Models.Collections.Songs(_.filter(this.models,h)),console.log(u,f);if(f.length){var p=new n.Models.PlayContext,d=function(e,t){return _.map(this.last(t),function(t){return t.get(e)})};if(a.disperseArtists||a.disperseAlbums){var v=d.apply(s,["ArtistID",a.recentArtistsSize]),m=d.apply(s,["AlbumID",a.recentAlbumsSize]),g=a.disperseArtists-0+(a.disperseAlbums-0),y;for(var b=0,w=Math.min(30,f.length);b<w;b++){y=0,a.disperseArtists&&_.indexOf(v,f.models[b].get("ArtistID"))==-1&&y++,a.disperseAlbums&&_.indexOf(m,f.models[b].get("AlbumID"))==-1&&y++;if(y>=g){c=f.models[b];break}y&&!c&&(c=f.models[b])}}c||(c=f.models[0]),l=c,this.remove(c),p.type="clientRadio",p.addStreamType(n.Models.PlayContext.TYPE_STATION),p.addStreamType(this.extraStreamFlags),n.trigger("player:addSongs",[l],t,r.playOnAdd,p),n.trigger("guts:forcelog","autoplayRecommendedSongToQueue",{songID:l.get("SongID")})}else this.lastNeedSongs=+(new Date),this.trigger("needSongs",this,e)},e.on("change:autoplayEnabled",function(e,t){t&&this.disable()},i),i.on("add",function(){var e=this.lastNeedSongs&&+(new Date)-this.lastNeedSongs;e&&e<5e3&&(this.lastNeedSongs=null,setTimeout(function(){i.chooseNextSong({})},0))}),i.onActiveSongChange=function(e,t,n){return _.delay(function(){i.chooseNextSong(n)},250),this},i.onQueueContentChange=function(){return _.delay(function(){i.chooseNextSong({})},250),this},i.setTypeTypeID=function(e,t){this.type=e,this.typeID=t},i.switchToAutoplay=function(t){var r=i.frowns,s=e.get("songs"),o=s.pluck("ArtistID"),u=r.pluck("ArtistID");o=_.difference(o,u),t=_.extend({},{secondaryArtistWeightModifier:1.3,seedArtistWeightRange:[80,90],weightModifierRange:[-9,9],seeds:o,frowns:u},t),n.trigger("guts:gatrack","player","clientRadioFallbackToServer","fallbackSeedArtistIDs:"+o.length+",fallbackSeedFrownArtistIDs:"+u.length),n.trigger("guts:forcelog","clientRadioFallbackToServer",{fallbackSeedArtistIDs:o.toString(),fallbackSeedFrownArtistIDs:u.toString()}),n.trigger("guts:begincontext",{fallbackSeedArtistIDs:o.toString(),fallbackSeedFrownArtistIDs:u.toString()}),n.Services.SWF.setAutoplay(!0,0,t,"autoplayGetSongEx")},i}n.Models=n.Models||{},n.Models.Queue=Backbone.Model.extend({parse:function(t,r){var i=r||{},s=new n.Models.Collections.QueueSongs(t.songs,{modelOptions:{notifyCache:!0,skipUpdate:!0}}),o=new n.Models.Collections.QueueSongs(s.models),u=t.activeSong?t.activeSong instanceof n.Models.QueueSong?t.activeSong.id:t.activeSong.queueSongID:!1,a=t.nextSong?t.nextSong instanceof n.Models.QueueSong?t.nextSong.id:t.nextSong.queueSongID:!1,f=t.previousSong?t.previousSong instanceof n.Models.QueueSong?t.previousSong.id:t.previousSong.queueSongID:!1,l=e(this,t.clientRadioSongs),c=null,h=null,p=null;u&&(c=s.get(u),c&&c.set("active",!0)),a&&(h=s.get(a)),f&&(p=s.get(f));var d={queueID:t.queueID,songs:s,cachedSongs:o,activeSong:c,nextSong:h,previousSong:p,clientRadio:l,autoplayEnabled:t.autoplayEnabled,clientRadioEnabled:l._enabled,currentAutoplayTagID:t.currentAutoplayTagID,shuffleEnabled:t.shuffleEnabled,repeatMode:t.repeatMode,isBroadcasting:t.isBroadcasting,lastQueueReset:t.lastQueueReset};return d},initialize:function(){var e=this.attributes.clientRadio;this.on("change:activeSong",e.onActiveSongChange,e),this.attributes.songs.on("remove reset sort",e.onQueueContentChange,e)},radioEnabled:function(){return this.get("autoplayEnabled")||this.get("clientRadioEnabled")},randomizeSongs:function(){var e=this.get("songs");if(e&&e.length){var t=e.indexOf(this.get("activeSong")),r=new n.Models.Collections.QueueSongs(e.rest(t+1)),i=r.pluck("queueSongID");if(i.length)return i=_.shuffle(i),n.Services.SWF.moveSongsTo(i,t+1,!0),!0}return!1}},{shuffleSongsForRadio:function(e){var t=_.shuffle(e.first(Math.floor(e.length*.5))),r=_.shuffle(e.rest(Math.ceil(e.length*.5)));return new n.Models.Collections.Songs(t.concat(r))},sortSongsForRadio:function(e,t){t=_.defaults(t||{},{disperseArtists:!0,disperseAlbums:!0,shuffle:!0});var r=[],i=[],s=Math.floor(e.length*.5),o=e.first(s),u=e.rest(s),a=[],f=[],l,c,h,p,d,v,m,g,y,b,w,E,S,x,T;t.shuffle?(o=_.shuffle(o),u=_.shuffle(u),l=o.concat(u)):l=e.models,l=new n.Models.Collections.Songs(l);if(t.disperseArtists||t.disperseAlbums)for(c=0,h=l.length;c<h;c++){b=l.models[c],g=b.get("ArtistID"),y=b.get("AlbumID"),v=_.lastIndexOf(r,g),m=_.lastIndexOf(r,g);if(t.disperseArtists&&v!==-1&&v<r.length-5||t.disperseAlbums&&m!==-1&&m<i.length-5)w=b;if(!w){x=b,E=r.slice(-5),S=i.slice(-5);for(p=0,d=f.length;p<d;p++){b=f[p],g=b.get("ArtistID"),y=b.get("AlbumID"),T=t.disperseArtists&&_.indexOf(E,g)==-1||!t.disperseArtists,T=t.disperseAlbums&&_.indexOf(S,y)==-1||!t.disperseAlbums;if(T){w=b;break}}f.push(x)}w&&(a.push(w),r.push(g),i.push(y),w=null)}return f.length&&(t.shuffle&&(f=_.shuffle(f)),a.push.apply(a,f)),a.length&&l.reset(a),l}})}(),function(){n.Models=n.Models||{},n.Models.Player=Backbone.Model.extend({defaults:{volume:100,isMuted:!1,crossfadeAmount:0,crossfadeEnabled:!1,playPauseFade:!1,position:0,duration:0,bytesLoaded:0,bytesTotal:0,playStatus:0,currentStreamServer:"",currentQueue:null,previousQueue:!1,expectManualSongChange:!1,isJoiningBroadcast:!1,uiMode:"normal"},playStatusIsPlaying:function(){switch(this.get("playStatus")){case n.Models.Player.playStatuses.INITIALIZING:case n.Models.Player.playStatuses.LOADING:case n.Models.Player.playStatuses.PLAYING:case n.Models.Player.playStatuses.BUFFERING:return!0;default:return!1}}},{playStatuses:{NONE:0,INITIALIZING:1,LOADING:2,PLAYING:3,PAUSED:4,BUFFERING:5,FAILED:6,COMPLETED:7},repeatModes:{NONE:0,ALL:1,ONE:2}})}(),function(){n.Models=n.Models||{},n.Models.Station=Backbone.Model.extend({idAttribute:"TagID",defaults:{TagID:0,StationTitle:""},toProxyLabel:function(){return _.escape(_.getString(this.get("StationTitle")))}},{getStations:function(){var e=[{StationTitle:"STATION_INDIE",TagID:136},{StationTitle:"STATION_ELECTRONICA",TagID:67},{StationTitle:"STATION_CLASSICAL",TagID:750},{StationTitle:"STATION_POP",TagID:56},{StationTitle:"STATION_RAP",TagID:3},{StationTitle:"STATION_COUNTRY",TagID:80},{StationTitle:"STATION_ALTERNATIVE",TagID:13},{StationTitle:"STATION_HIP_HOP",TagID:29},{StationTitle:"STATION_CLASSIC_ROCK",TagID:3529},{StationTitle:"STATION_AMBIENT",TagID:75},{StationTitle:"STATION_PUNK",TagID:111},{StationTitle:"STATION_90S_ALT_ROCK",TagID:9},{StationTitle:"STATION_BLUES",TagID:230},{StationTitle:"STATION_ROCK",TagID:12},{StationTitle:"STATION_JAZZ",TagID:43},{StationTitle:"STATION_RNB",TagID:4},{StationTitle:"STATION_FOLK",TagID:122},{StationTitle:"STATION_DUBSTEP",TagID:2563},{StationTitle:"STATION_80s",TagID:55},{StationTitle:"STATION_TRANCE",TagID:69},{StationTitle:"STATION_BLUEGRASS",TagID:96},{StationTitle:"STATION_REGGAE",TagID:160},{StationTitle:"STATION_METAL",TagID:17},{StationTitle:"STATION_OLDIES",TagID:102},{StationTitle:"STATION_EXPERIMENTAL",TagID:191},{StationTitle:"STATION_LATIN",TagID:528}];return new n.Models.Collections.Stations(e)},getStationsStartMenu:function(){var e=n.Models.Station.getStations(),t=[],r=function(e){return function(){n.trigger("player:radio",!0,e),n.trigger("guts:log","autoplayOn",{stationType:"tag",tagID:e})}};return e.comparator=function(e){return _.getString(e.get("StationTitle"))},e.sort(),e.each(function(e){t.push({key:e.get("StationTitle").toUpperCase(),title:_.getString(e.get("StationTitle")),customClass:"jj_menu_item_hasIcon jj_menu_item_station",action:{type:"fn",callback:r(e.get("TagID"))}})}),t}})}(),function(){function e(e,t,r,i,s,o){(!o||!o.comments)&&e.reject();var u=o.users,a=o.artists,f;n.Models.Comment.handleUsersArtistsInResult(o.comments,u,a);if(s){var l=s.getCached(t);l&&(i===0?(f=new n.Models.Collections.Comments(o.comments,{modelOptions:{dontCache:!0}}),l.set("comments",f,{silent:!0})):l.get("comments")&&(f=l.get("comments"),f.processMore?f.processMore(o.comments):f.add(o.comments)))}f||(f=new n.Models.Collections.Comments(o.comments,{modelOptions:{dontCache:!0}})),f.lastLoaded=$.now(),f.loadedPages=Math.max(_.toInt(f.loadedPages),i),f.loadedTypeID=r,f.loadedItemID=t,e.resolve(f,t,r)}function t(t,r,i,s,o){s||(s=0);var u=_.toInt(r);u&&(r=u);if(o){var a=o.getCached(r);if(a){var f=a.get("comments"),l=$.now();if(f&&f.lastLoaded&&f.lastLoaded>l-3e5&&f.loadedPages>=s){t.resolve(f,r,i);return}}}n.Services.API.getCommentsForItem(r,i,s).done(_.bind(e,this,t,r,i,s,o)).fail(_.bind(t.reject,t))}n.Models=n.Models||{},n.Models.Comment=Backbone.CachedModel.extend({idAttribute:"CommentID",parse:function(e,t){var r=t&&t.clone===!1?e:_.clone(e);r.OriginalItem&&(r.ItemID=r.OriginalItem,delete r.OriginalItem),r.OriginalType&&(r.TypeID=r.OriginalType,delete r.OriginalType);if(r.user||r.artist)r.author=_.getNormalizedAuthorForCommentResponse(r,r.ItemID,r.TypeID);var i=[],s=this;return _.each(r.Responses,function(e){e.comment=s,e.ItemID=r.ItemID,e.TypeID=r.TypeID,i.push(e)}),r.Responses=new n.Models.Collections.CommentResponses(i,{dontCache:!0}),i.length?(r.ResponsesCount=r.Responses.length,r.ResponsesLoaded=!0):(r.ResponsesCount=_.toInt(r.ResponsesCount),r.ResponsesLoaded=r.ResponsesCount<=0),r},get:function(e){switch(e){case"time":return _.getFormattedDate(this.attributes.Timestamp)}return this.attributes[e]},loadResponses:function(){var e=$.Deferred();if(this.get("ResponsesLoaded"))e.resolve(this.get("Responses"));else{var t=function(){n.trigger("notification:add",{description:_.getString("POPUP_FAILED_LOAD_RESPONSES"),type:"error",url:""}),e.reject()};n.Services.API.getCommentByID(this.id).done(_.bind(function(r){if(!r||!r.comment)return t();var i=[];if(r.comment.Responses){var s=this;n.Models.Comment.handleUsersArtistsInResult(r.comment,r.users,r.artists),_.each(r.comment.Responses,function(e){e.comment=s,e.ItemID=s.get("ItemID"),e.TypeID=s.get("TypeID"),i.push(e)}),this.get("Responses").add(i)}this.set({ResponsesLoaded:!0,ResponsesCount:i.length}),e.resolve(this.get("Responses"))},this)).fail(t)}return e.promise()},reportComment:function(){if(n.getLoggedInUserID()>0)return n.Services.API.reportComment(this.get("CommentID"));var e=new $.Deferred,t=this.get("CommentID");return n.trigger("lightbox:open","login",{message:_.getString("LB_LOGIN_MUST_LOGIN_TO_REPORT_COMMENT"),onLogin:function(r){n.Services.API.reportComment(t).done(function(t){e.resolve(t)}).fail(function(t){e.reject(t)})},onClose:function(){e.state()=="pending"&&d.reject()}}),e.promise()},deleteComment:function(){var e=new $.Deferred;return this.get("UserID")===n.getLoggedInUserID()?n.Services.API.deleteComment(this.get("CommentID"),this.get("AuthorArtistID")).done(_.bind(function(t){t?(this.destroy(),e.resolve(t)):e.reject(t)},this)).fail(_.bind(e.reject,e)):this.canDelete()?n.Services.API.deleteCommentFromMyPage(this.get("CommentID"),this.get("ItemID"),this.get("TypeID")).done(_.bind(function(t){t?(this.destroy(),e.resolve(t)):e.reject(t)},this)).fail(_.bind(e.reject,e)):e.reject(),e.promise()},canDelete:function(){if(n.isLoggedInUserOwnerOfArtist(this.get("AuthorArtistID")))return!0;if(this.get("UserID")===n.getLoggedInUserID())return!0;if(this.get("TypeID")===n.Models.Comment.COMMENT_PAGE_TYPES.USER&&this.get("ItemID")===n.getLoggedInUserID())return!0;if(this.get("TypeID")===n.Models.Comment.COMMENT_PAGE_TYPES.PLAYLIST){var e=n.Models.Playlist.getCached(this.get("ItemID"));if(e&&e.get("UserID")===n.getLoggedInUserID())return!0}else if(this.get("TypeID")===n.Models.Comment.COMMENT_PAGE_TYPES.ALBUM){var t=n.Models.Album.getCached(this.get("ItemID"));if(t&&n.isLoggedInUserOwnerOfArtist(t.get("ArtistID")))return!0}else if(this.get("TypeID")===n.Models.Comment.COMMENT_PAGE_TYPES.SONG){var r=n.Models.Song.getCached(this.get("ItemID"));if(r&&n.isLoggedInUserOwnerOfArtist(r.get("ArtistID")))return!0}else if(this.get("TypeID")===n.Models.Comment.COMMENT_PAGE_TYPES.ARTIST&&n.isLoggedInUserOwnerOfArtist(this.get("ItemID")))return!0;return n.Models.Comment.ADMINS[n.getLoggedInUserID()]?!0:!1},canEdit:function(){var e=this.get("AuthorArtistID");return e?n.isLoggedInUserOwnerOfArtist(e):this.get("UserID")===n.getLoggedInUserID()},storeResponse:function(e){function r(){var r=this.get("CommentID"),i=this.get("ItemID"),s=this.get("TypeID");n.Services.API.storeResponseToComment(r,i,s,e).done(_.bind(function(e){e&&e.ResponseID?(e.user=n.Models.User.getCached(n.getLoggedInUserID()),this.addResponse(e),t.resolve(e)):(n.trigger("notification:add",{description:_.getString("POPUP_ERROR_COMMENT_FAILED"),type:"error",url:""}),t.reject())},this)).fail(_.bind(t.reject,t)),n.trigger("guts:log","respondToComment",{commentID:r,itemID:i,typeID:s}),n.trigger("guts:gatrack","site","respondToComment",s)}var t=$.Deferred();return n.getLoggedInUserID()>0?r.call(this):n.trigger("lightbox:open","login",{message:_.getString("LB_LOGIN_MUST_LOGIN_TO_REPORT_COMMENT"),onLogin:_.bind(r,this),onClose:function(){t.state()=="pending"&&t.reject()}}),t.promise()},getMessage:function(){if(this.get("linkedMessage"))return this.get("linkedMessage");var e=this.get("Message");return e=_.makeSafeLinks(e),this.set("linkedMessage",e),e},getResponsesCount:function(){return this.get("MoreResponses")?"30+":this.get("ResponsesCount")},addResponse:function(e){e instanceof n.Models.CommentResponse||(e.comment=this,e=new n.Models.CommentResponse(e,{dontCache:!0})),this.get("Responses").push(e),this.set("ResponsesCount",this.get("Responses").length)},toUrl:function(){var e=this.get("ItemID"),t="",r;switch(this.get("TypeID")){case n.Models.Comment.COMMENT_PAGE_TYPES.ARTIST:r=n.Models.Artist,t="artist";break;case n.Models.Comment.COMMENT_PAGE_TYPES.ALBUM:r=n.Models.Album,t="album";break;case n.Models.Comment.COMMENT_PAGE_TYPES.PLAYLIST:r=n.Models.Playlist,t="playlist";break;case n.Models.Comment.COMMENT_PAGE_TYPES.USER:r=n.Models.User,t="user";break;case n.Models.Comment.COMMENT_PAGE_TYPES.SONG:r=n.Models.Song,t="song";break;default:return""}var i="",s=r.getCached(e);return this.get("TypeID")===n.Models.Comment.COMMENT_PAGE_TYPES.SONG&&(!s||!s.get("token"))?i="":s?i=s.toUrl("comment/"+this.id):i=_.cleanUrl(null,e,t,null,"comment/"+this.id),i},getAnchorTag:function(e){if(!e)switch(this.get("TypeID")){case n.Models.Comment.COMMENT_PAGE_TYPES.ARTIST:e=_.getString("ARTIST").toLocaleLowerCase();break;case n.Models.Comment.COMMENT_PAGE_TYPES.ALBUM:e=_.getString("ALBUM").toLocaleLowerCase();break;case n.Models.Comment.COMMENT_PAGE_TYPES.PLAYLIST:e=_.getString("PLAYLIST").toLocaleLowerCase();break;case n.Models.Comment.COMMENT_PAGE_TYPES.USER:e=_.getString("USER").toLocaleLowerCase();break;case n.Models.Comment.COMMENT_PAGE_TYPES.SONG:e=_.getString("SONG").toLocaleLowerCase();break;default:return""}return'<a href="'+this.toUrl()+'" class="comment-link" data-comment-id="'+this.escape("CommentID")+'">'+e+"</a>"},getChildMetadata:function(){var e=n.Models.Comment.getModelForType(this.get("TypeID"));if(!e)return null;var t=e.getCached(this.get("ItemID"));return t?_.getString("COMMENTED_ON",{item:t.getAnchorTag()}):null}},{COMMENT_PAGE_TYPES:{USER:1,ARTIST:2,ALBUM:3,PLAYLIST:4,SONG:5},ADMINS:{3879:1,42:1,3327599:1,21007202:1,17729920:1,17638985:1,2226931:1,25736013:1,579416:1},getModelForType:function(e){var t;switch(e){case n.Models.Comment.COMMENT_PAGE_TYPES.ARTIST:t=n.Models.Artist;break;case n.Models.Comment.COMMENT_PAGE_TYPES.ALBUM:t=n.Models.Album;break;case n.Models.Comment.COMMENT_PAGE_TYPES.PLAYLIST:t=n.Models.Playlist;break;case n.Models.Comment.COMMENT_PAGE_TYPES.USER:t=n.Models.User;break;case n.Models.Comment.COMMENT_PAGE_TYPES.SONG:t=n.Models.Song;break;case 9:t=null}return t},loadCommentsItemType:function(e,r,i){var s=new $.Deferred,o=n.Models.Comment.getModelForType(r);return t(s,e,r,i,o),s.promise()},loadComments:function(e,r,i){var s=new $.Deferred,o,u;switch(e){case"artist":o=n.Models.Comment.COMMENT_PAGE_TYPES.ARTIST,u=n.Models.Artist;break;case"album":o=n.Models.Comment.COMMENT_PAGE_TYPES.ALBUM,u=n.Models.Album;break;case"playlist":o=n.Models.Comment.COMMENT_PAGE_TYPES.PLAYLIST,u=n.Models.Playlist;break;case"user":o=n.Models.Comment.COMMENT_PAGE_TYPES.USER,u=n.Models.User;break;case"song":o=n.Models.Comment.COMMENT_PAGE_TYPES.SONG,u=n.Models.Song;break;case"other":o=9,u=null;break;default:return s.reject(),s.promise()}return t(s,r,o,i,u),s.promise()},storeComment:function(e,t,r){var i=$.Deferred(),s=n.getLoggedInUserID(),o,u,a,f;switch(e){case"artist":u=n.Models.Comment.COMMENT_PAGE_TYPES.ARTIST,f=n.Models.Artist;break;case"album":u=n.Models.Comment.COMMENT_PAGE_TYPES.ALBUM,f=n.Models.Album;break;case"playlist":u=n.Models.Comment.COMMENT_PAGE_TYPES.PLAYLIST,f=n.Models.Playlist;break;case"user":u=n.Models.Comment.COMMENT_PAGE_TYPES.USER,f=n.Models.User;break;case"song":u=n.Models.Comment.COMMENT_PAGE_TYPES.SONG,f=n.Models.Song;break;case"other":u=9,f=null;break;default:return i.reject(),i.promise()}return o=f?f.getCached(t):null,a=o?o.getDetailsForFeeds():null,n.Services.API.storeCommentForItem(t,u,r,a).done(_.bind(function(e){if(e&&e.CommentID){e.user=n.Models.User.getCached(s);var t=o?o.get("comments"):null;t&&t.unshift(e),i.resolve()}else n.trigger("notification:add",{description:_.getString("POPUP_ERROR_COMMENT_FAILED"),type:"error",duration:5e3}),i.reject()},this)).fail(_.bind(function(){n.trigger("notification:add",{description:_.getString("POPUP_ERROR_COMMENT_FAILED"),type:"error",duration:5e3}),i.reject()},this)),n.trigger("guts:log","comment",{itemID:t,typeID:u}),n.trigger("guts:gatrack","site","comment",u),i.promise()},clearCachedCommentsForItemType:function(e,t){var r=n.Models.Comment.getModelForType(t),i=r&&r.getCached(e),s;if(!i)return;s=i.get("comments"),s&&(s.lastLoaded=0)},handleUsersArtistsInResult:function(e,t,r){var i=e;_.isArray(i)||(i=[e]);if(t)for(var s in t)t.hasOwnProperty(s)&&t[s].UserID&&(t[s]=n.Models.User.newOrUpdate(t[s],{dontCache:!0,updateProfile:!1}));else t={};if(r)for(var o in r)r.hasOwnProperty(o)&&r[o].ArtistID&&(r[o]=n.Models.Artist.newOrUpdate(r[o],{dontCache:!0,updateProfile:!1}));else r={};_.each(i,function(e){e.AuthorArtistID?e.artist=r[e.AuthorArtistID]:e.user=t[e.UserID],e.Responses&&_.each(e.Responses,function(e){e.AuthorArtistID?e.artist=r[e.AuthorArtistID]:e.user=t[e.UserID]})})},get:function(e){var t=function(e){var t=new $.Deferred;return n.Services.API.getCommentByID(e).done(function(e){if(e&&e.comment&&e.users){var r=e.comment;n.Models.Comment.handleUsersArtistsInResult(r,e.users,e.artists),t.resolve(r)}else t.reject(e)}).fail(_.bind(t.reject,t)),t.promise()},r=Backbone.CachedModel.genericGet.call(this,t,"CommentID",e);return r.promise()}})}(),function(){function e(e,t){t?(this.destroy(),e.resolve(!0)):(e.reject(),n.trigger("notification:add",{description:_.getString("POPUP_ERROR_COMMENT_DELETE_FAILED"),type:"error",duration:5e3}))}n.Models=n.Models||{},n.Models.CommentResponse=Backbone.CachedModel.extend({idAttribute:"ResponseID",parse:function(e,t){var n=t&&t.clone===!1?e:_.clone(e);return n.author=_.getNormalizedAuthorForCommentResponse(n,n.ItemID,n.TypeID),n.time=_.getFormattedDate(n.Timestamp),n},deleteResponse:function(){var t=new $.Deferred;return n.isLoggedInUserOwnerOfArtist(this.get("AuthorArtistID"))||this.get("UserID")===n.getLoggedInUserID()?n.Services.API.deleteResponseToComment(this.get("comment").get("CommentID"),this.get("ResponseID"),this.get("AuthorArtistID")).always(_.bind(e,this,t)):this.canDelete()?n.Services.API.deleteResponseToCommentFromMyPage(this.get("comment").get("CommentID"),this.get("ResponseID"),this.get("ItemID"),this.get("TypeID")).always(_.bind(e,this,t)):t.reject(),t.promise()},canDelete:function(){if(n.isLoggedInUserOwnerOfArtist(this.get("AuthorArtistID")))return!0;if(this.get("UserID")===n.getLoggedInUserID())return!0;if(this.get("TypeID")===n.Models.Comment.COMMENT_PAGE_TYPES.USER&&this.get("ItemID")===n.getLoggedInUserID())return!0;if(this.get("TypeID")===n.Models.Comment.COMMENT_PAGE_TYPES.PLAYLIST){var e=n.Models.Playlist.getCached(this.get("ItemID"));if(e&&e.get("UserID")===n.getLoggedInUserID())return!0}else if(this.get("TypeID")===n.Models.Comment.COMMENT_PAGE_TYPES.ALBUM){var t=n.Models.Album.getCached(this.get("ItemID"));if(t&&n.isLoggedInUserOwnerOfArtist(t.get("ArtistID")))return!0}else if(this.get("TypeID")===n.Models.Comment.COMMENT_PAGE_TYPES.SONG){var r=n.Models.Song.getCached(this.get("ItemID"));if(r&&n.isLoggedInUserOwnerOfArtist(r.get("ArtistID")))return!0}else if(this.get("TypeID")===n.Models.Comment.COMMENT_PAGE_TYPES.ARTIST&&n.isLoggedInUserOwnerOfArtist(this.get("ItemID")))return!0;return n.Models.Comment.ADMINS[n.getLoggedInUserID()]?!0:!1},reportResponse:function(){var e=this.get("comment").get("CommentID");if(n.getLoggedInUserID()>0)return n.Services.API.reportResponseToComment(e,this.get("ResponseID"));var t=new $.Deferred;return n.trigger("lightbox:open","login",{message:_.getString("LB_LOGIN_MUST_LOGIN_TO_REPORT_COMMENT"),onLogin:function(r){n.Services.API.reportResponseToComment(e).done(function(e){t.resolve(e)}).fail(function(e){t.reject(e)})},onClose:function(){t.state()=="pending"&&d.reject()}}),t.promise()},getMessage:function(){if(this.get("linkedMessage"))return this.get("linkedMessage");var e=this.get("Message");return e=_.makeSafeLinks(e),this.set("linkedMessage",e),e}})}(),function(){function e(e,t){var r=e.get("data");if(r.users&&r.users.length){var i=new n.Models.Collections.Users(r.users,{updateProfile:!1});t.user&&i.remove(t.user.get("UserID")),t.localeVariables.numOthers=i.length,i.at(0)&&(t.localeVariables.userTwo=i.at(0).getAnchorTag())}}n.Models=n.Models||{};var t={handlePlaylist:function(e,t){var r=new $.Deferred,i=e.get("data");t.icon=_.orEqual(t.icon,"playlist");var s=n.Models.Playlist.wrapFeedData(i.playlists[0]||i.playlist);t.item={id:s.get("PlaylistID"),image:s.getImageURL(200),title:s.get("PlaylistName"),subTitle:s.get("UserName"),subURL:s.toUserUrl(),url:s.toUrl(),model:s};var o=!1;return s.get("UserID")===n.getLoggedInUserID()?(t.localeVariables.objectArticle=s.getAnchorTag("YOUR_PLAYLIST"),o=!0):t.user&&t.user.get("UserID")===s.get("UserID")?(t.localeVariables.objectArticle=_.getString(t.localeVariables.possessiveKey+"_OWNER")+" "+s.getAnchorTag("PLAYLIST"),o=!0):t.localeVariables.objectArticle=s.getAnchorTag("PLAYLIST_ARTICLE"),t.localeVariables.objectNamed=s.getAnchorTag(),!o&&t.groupBy&&s.get("UserName")&&(t.localeKey+="_BY",t.localeVariables.grouping=s.getAuthorAnchorTag()),r.resolve(),r.promise()},playlistPlayed:function(e,t){t.itemType="playlist",t.localeKey="FEED2_USER_LISTENED",t.groupBy="user"},createPlaylist:function(e,t){t.itemType="playlist",t.localeKey="FEED2_USER_CREATED"},subscribePlaylist:function(e,t){t.itemType="playlist",t.localeKey="FEED2_USER_SUBSCRIBED",t.groupBy="user"},overwritePlaylist:function(e,t){t.itemType="playlist",t.localeKey="FEED2_USER_EDITED",t.groupBy="user"},handleSong:function(e,t){var r=new $.Deferred,i=e.get("data");t.localeVariables.eventLink=e.toUrl(),t.icon=_.orEqual(t.icon,"song");var s=new n.Models.Collections.Songs(i.songs||[i.song]),o=s.at(0);if(s.length>1)e.get("activityType")!=="broadcast"&&e.get("activityType")!=="share"&&(t.localeKey+="_MANY"),t.items=[],s.each(function(n){t.items.push({id:n.get("SongID"),image:n.getImageURL(40),title:n.get("SongName"),subTitle:n.get("ArtistName"),subURL:n.toArtistUrl(),url:null}),n.client&&!e.attributes.client&&e.set("client",n.client)}),t.localeVariables.objectTwo=s.at(1).getAlbumAnchorTag(),t.localeVariables.objectCount=s.length;else{if(!s.length)return r.reject(),r.promise();t.item={id:o.get("SongID"),image:o.getImageURL(80),title:o.get("SongName"),subTitle:o.get("ArtistName"),subURL:o.toArtistUrl(),url:null},o.client&&!e.attributes.client&&e.set("client",o.client)}return t.localeVariables.objectNamed=o.getAnchorTag(),t.localeVariables.objectArticle=o.getAnchorTag("SONG_ARTICLE"),t.groupBy==="artist"?(t.localeKey+="_BY",t.localeVariables.grouping=o.getArtistAnchorTag()):t.groupBy==="album"&&(t.localeKey+="_FROM",t.localeVariables.grouping=o.getAlbumAnchorTag()),r.resolve(),r.promise()},songPlayed:function(e,t){var n=e.get("data");t.itemType="song",t.localeVariables.eventLink=e.toUrl(),n.users&&n.users.length>1?t.localeKey="FEED2_USER_MANY_LISTENED":t.localeKey="FEED2_USER_LISTENED"},favoriteSong:function(e,t){var n=e.get("data");t.icon="favorite",t.itemType="song",t.localeVariables.eventLink=e.toUrl(),n.users&&n.users.length>1?t.localeKey="FEED2_USER_MANY_FAVORITED":t.localeKey="FEED2_USER_FAVORITED"},addSongsToLibrary:function(e,t){var n=e.get("data");t.icon="collection",t.itemType="song",t.localeVariables.eventLink=e.toUrl(),t.localeVariables.destinations=_.getString("COLLECTIONS"),t.localeVariables.destination=_.getString(t.localeVariables.possessiveKey)+" "+_.getString("COLLECTION").toLocaleLowerCase(),t.user&&(t.localeVariables.destination='<a href="'+t.user.toUrl("collection")+'" class="user-collection-link">'+t.localeVariables.destination+"</a>"),n.users&&n.users.length>1?t.localeKey="FEED2_USER_MANY_ADDED":t.localeKey="FEED2_USER_ADDED"},obsession:function(e,t){var n=e.get("data");!n.songs&&n.song&&(n.songs=[n.song]),t.itemType="song",t.localeKey="FEED2_USER_OBSESSION",t.localeVariables.eventLink=e.toUrl();if(n.songs&&n.songs.length===1){var r=1;typeof n.songs[0].timestamp=="object"&&(r=n.songs[0].timestamp.length),r>7?t.localeKey="FEED2_USER_BLEEDING":r>5&&(t.localeKey="FEED2_USER_ADDICTED")}},handleArtist:function(e,t){var r=new $.Deferred,i=e.get("data");t.icon=_.orEqual(t.icon,"artist"),t.localeVariables.eventLink=e.toUrl();var s=new n.Models.Collections.Artists(i.artists||[i.artist]),o=s.at(0);if(s.length>1)e.get("activityType")!=="broadcast"&&e.get("activityType")!=="share"&&(t.localeKey+="_MANY"),t.items=[],s.each(function(e){t.items.push({id:e.get("ArtistID"),image:e.getImageURL(40),title:e.get("ArtistName"),url:e.toUrl()})}),t.localeVariables.objectTwo=s.at(1).getAnchorTag(),t.localeVariables.objectCount=s.length;else{if(!s.length)return r.reject(),r.promise();t.item={id:o.get("ArtistID"),image:o.getImageURL(80),title:o.get("ArtistName"),url:o.toUrl()}}return t.localeVariables.objectNamed=o.getAnchorTag(),t.localeVariables.objectArticle=o.getAnchorTag("ARTIST_ARTICLE"),r.promise()},favoriteArtist:function(e,t){var r=e.get("data");t.icon="favorite",t.itemType="artist",t.localeVariables.eventLink=e.toUrl();if(!r.artists&&e.get("feedType")==="artist"){var i=n.Models.Artist.getCached(e.get("ArtistID"));i&&(r.artists=[i])}r.users&&r.users.length>2?t.localeKey="FEED2_USER_MANY_FOLLOWING":r.users&&r.users.length>1?t.localeKey="FEED2_USER_TWO_FOLLOWING":t.localeKey="FEED2_USER_FOLLOWING"},usersFavoriteArtist:function(e,t){return this.favoriteArtist(e,t)},addArtistToLibrary:function(e,t){var n=e.get("data");t.icon="collection",t.localeVariables.eventLink=e.toUrl(),t.localeVariables.destinations=_.getString("COLLECTIONS"),t.localeVariables.destination=_.getString(t.localeVariables.possessiveKey)+" "+_.getString("COLLECTION").toLocaleLowerCase(),t.user&&(t.localeVariables.destination='<a href="'+t.user.toUrl("collection")+'" class="user-collection-link">'+t.localeVariables.destination+"</a>"),!n.songs&&n.artists?t.itemType="artist":(t.itemType="song",t.groupBy="artist"),n.users&&n.users.length>1?t.localeKey="FEED2_USER_MANY_ADDED":t.localeKey="FEED2_USER_ADDED"},usersAddArtistToLibrary:function(e,t){this.addArtistToLibrary(e,t)},artistPlayed:function(e,t){var n=e.get("data");if(!n.artists&&n.songs){var r=n.songs[0],i={ArtistName:_.orEqual(r.artistName,r.ArtistName),ArtistID:_.orEqual(r.artistID,r.ArtistID)};n.artists=[i]}t.itemType="artist",n.users&&n.users.length>1?t.localeKey="FEED2_USER_MANY_LISTENED":t.localeKey="FEED2_USER_LISTENED"},handleAlbum:function(e,t){var r=new $.Deferred,i=e.get("data");t.icon=_.orEqual(t.icon,"song"),t.localeVariables.eventLink=e.toUrl();var s=new n.Models.Collections.Albums(i.albums||[i.album]),o=s.at(0);if(s.length>1)e.get("activityType")!=="broadcast"&&e.get("activityType")!=="share"&&(t.localeKey+="_MANY"),t.items=[],s.each(function(e){t.items.push({id:e.get("AlbumID"),image:e.getImageURL(40),title:e.get("AlbumName"),subTitle:e.get("ArtistName"),subURL:e.toArtistUrl(),url:e.toUrl()})}),t.localeVariables.objectTwo=s.at(1).getAnchorTag(),t.localeVariables.objectCount=s.length;else{if(!s.length)return r.reject(),r.promise();t.item={id:o.get("AlbumID"),image:o.getImageURL(80),title:o.get("AlbumName"),subTitle:o.get("ArtistName"),subURL:o.toArtistUrl(),url:o.toUrl()}}return t.localeVariables.objectNamed=o.getAnchorTag(),t.localeVariables.objectArticle=o.getAnchorTag("ALBUM_ARTICLE"),r.promise()},albumPlayed:function(e,t){var n=e.get("data");t.localeVariables.eventLink=e.toUrl();if(!n.albums&&n.songs){var r=n.songs[0],i={ArtistName:_.orEqual(r.artistName,r.ArtistName),ArtistID:_.orEqual(r.artistID,r.ArtistID),AlbumName:_.orEqual(r.albumName,r.AlbumName),AlbumID:_.orEqual(r.albumID,r.AlbumID)};n.albums=[i]}t.itemType="album",n.users&&n.users.length>1?t.localeKey="FEED2_USER_MANY_LISTENED":t.localeKey="FEED2_USER_LISTENED"},usersAddAlbumToLibrary:function(e,t){var n=e.get("data");t.icon="collection",t.localeVariables.eventLink=e.toUrl(),t.localeVariables.destinations=_.getString("COLLECTIONS"),t.localeVariables.destination=_.getString(t.localeVariables.possessiveKey)+" "+_.getString("COLLECTION").toLocaleLowerCase(),t.user&&(t.localeVariables.destination='<a href="'+t.user.toUrl("collection")+'" class="user-collection-link">'+t.localeVariables.destination+"</a>"),!n.songs&&n.albums?t.itemType="album":(t.itemType="song",t.groupBy="album"),n.users&&n.users.length>1?t.localeKey="FEED2_USER_MANY_ADDED":t.localeKey="FEED2_USER_ADDED"},addAlbumToLibrary:function(e,t){return this.usersAddAlbumToLibrary(e,t)},share:function(e,t){var r=e.get("broadcastType"),i=e.get("data");t.localeVariables.eventLink=e.toUrl(),e.get("broadcastType")===void 0&&(i.songs&&i.songs.length?(e.set("broadcastType",n.Models.FeedEvent.BROADCAST_TYPES.SONG),r=n.Models.FeedEvent.BROADCAST_TYPES.SONG):i.artists&&i.artists.length?(e.set("broadcastType",n.Models.FeedEvent.BROADCAST_TYPES.ARTIST),r=n.Models.FeedEvent.BROADCAST_TYPES.ARTIST):i.albums&&i.albums.length?(e.set("broadcastType",n.Models.FeedEvent.BROADCAST_TYPES.ALBUM),r=n.Models.FeedEvent.BROADCAST_TYPES.ALBUM):i.playlists&&i.playlists.length&&(e.set("broadcastType",n.Models.FeedEvent.BROADCAST_TYPES.PLAYLIST),r=n.Models.FeedEvent.BROADCAST_TYPES.PLAYLIST)),t.icon="share";var s=[],o=0;if(i.users||i.people)s=new n.Models.Collections.Users(i.users||i.people,{updateProfile:!1}),o=s.length,o&&(s.get(n.getLoggedInUserID())?(t.localeVariables.destination=_.getString("SELF_THIRD_PERSON"),s.remove(n.getLoggedInUserID())):t.localeVariables.destination=s.at(0).getAnchorTag(!1,null,!0));o>2?(t.localeKey="FEED2_USER_SHARED_WITH_MANY",t.localeVariables.destinationCountMinusOne=o-1):o>1?(t.localeKey="FEED2_USER_SHARED_WITH_TWO",s.length===o?t.localeVariables.destinationTwo=s.at(1).getAnchorTag(!1,null,!0):t.localeVariables.destinationTwo=s.at(0).getAnchorTag(!1,null,!0)):s.length?t.localeKey="FEED2_USER_SHARED_WITH":t.localeKey="FEED2_USER_SHARED",r===n.Models.FeedEvent.BROADCAST_TYPES.SONG?t.itemType="song":r===n.Models.FeedEvent.BROADCAST_TYPES.PLAYLIST?t.itemType="playlist":r===n.Models.FeedEvent.BROADCAST_TYPES.ARTIST?t.itemType="artist":r===n.Models.FeedEvent.BROADCAST_TYPES.ALBUM&&(t.itemType="album")},artistBroadcastFeed:function(e,t){var r=e.get("broadcastType"),i=e.get("data"),s=_.orEqualEx(i.message,e.get("message"),null);t.icon="star",s?(t.localeKey="FEED2_USER_POSTED_UPDATE",t.localeVariables.eventLink=e.toUrl()):t.localeKey="FEED2_USER_SHARED";switch(r){case n.Models.FeedEvent.BROADCAST_TYPES.SONG:t.itemType="song";break;case n.Models.FeedEvent.BROADCAST_TYPES.PLAYLIST:t.itemType="playlist";break;case n.Models.FeedEvent.BROADCAST_TYPES.ARTIST:t.itemType="artist";break;case n.Models.FeedEvent.BROADCAST_TYPES.ALBUM:t.itemType="album"}},broadcast:function(e,t){return this.share(e,t)},handleUser:function(e,t){var r=new $.Deferred,i=e.get("data"),s=!1;t.icon=_.orEqual(t.icon,"user"),t.localeVariables.eventLink=e.toUrl();var o=new n.Models.Collections.Users(i.users||[i.user]),u=o.length,a;u&&(o.get(n.getLoggedInUserID())&&(s=!0,o.remove(n.getLoggedInUserID())),a=o.at(0));if(u>1)e.get("activityName")==="favoriteUser"?(u===2?t.localeKey+="_TWO":t.localeKey+="_AND",t.localeVariables.objects=_.getString("OBJECT_OTHERS")):t.localeKey+="_MANY",t.items=[],o.each(function(e){t.items.push({id:e.get("UserID"),image:e.getImageURL(40),title:e.get("Name"),url:e.toUrl()})}),t.localeVariables.objectTwo=o.at(1).getAnchorTag(!1,null,!0),t.localeVariables.objectCount=u,t.localeVariables.objectCountMinusOne=u-1;else{if(!u)return r.reject(),r.promise();s?(t.item={id:t.user.get("UserID"),image:t.user.getImageURL(80),title:t.user.get("Name"),url:t.user.toUrl()},s=!0):t.item={id:a.get("UserID"),image:a.getImageURL(80),title:a.get("Name"),url:a.toUrl()}}return s?(t.localeVariables.objectArticle=_.getString("SELF_THIRD_PERSON"),t.localeVariables.objectNamed=_.getString("SELF_THIRD_PERSON")):(t.localeVariables.objectNamed=a.getAnchorTag(!1,null,!0),e.get("activityName")==="favoriteUser"&&u>1?t.localeVariables.objectArticle=t.localeVariables.objectNamed:e.get("activityName")==="favoriteUser"?t.localeVariables.objectArticle="":t.localeVariables.objectArticle=_.getString("USER_SOMEONE")),r.promise()},favoriteUser:function(e,t){t.itemType="user",t.localeKey="FEED2_USER_FOLLOWING"},handleComment:function(e,t){var r=$.Deferred(),i=e.get("data");t.icon=_.orEqual(t.icon,"comment"),t.localeVariables.eventLink=e.toUrl();var s=[],o=0,u,a,f,l;switch(t.commentType){case"song":var c;u=new n.Models.Collections.Songs([]),_.each(i.comments,function(e){f=e.comment=new n.Models.Comment(e.comment);if(!e.comment)return;o++,c=n.Models.Song.newOrUpdate({AlbumID:e.albumID,AlbumName:e.albumName,ArtistID:e.artistID,ArtistName:e.artistName,SongID:e.songID,SongName:e.songName,artFilename:e.artFilename,token:e.token}),u.add(c,{silent:!0}),a=c.escape("SongName"),s.push({id:f.get("CommentID"),image:c.getImageURL(40),medimage:c.getImageURL(80),title:c.get("SongName"),comment:f.get("Message"),url:f.toUrl()})}),t.localeVariables.objectArticle=f.getAnchorTag(_.getString("SONG_ARTICLE",{otherUser:a}));break;case"artist":var h;u=new n.Models.Collections.Artists([]),_.each(i.comments,function(e){f=e.comment=new n.Models.Comment(e.comment);if(!e.comment)return;o++,h=n.Models.Artist.newOrUpdate({ArtistID:e.artistID,ArtistName:e.artistName,artFilename:e.artFilename}),u.add(h,{silent:!0}),a=h.escape("ArtistName"),s.push({id:f.get("CommentID"),image:h.getImageURL(40),medimage:h.getImageURL(80),title:h.get("ArtistName"),comment:f.get("Message"),url:f.toUrl()})}),t.localeVariables.objectArticle=f.getAnchorTag(_.getString("ARTIST_ARTICLE",{otherUser:a}));break;case"album":var p;u=new n.Models.Collections.Albums([]),_.each(i.comments,function(e){f=e.comment=new n.Models.Comment(e.comment);if(!e.comment)return;o++,p=n.Models.Album.newOrUpdate({AlbumID:e.albumID,AlbumName:e.albumName,ArtistID:e.artistID,ArtistName:e.artistName,artFilename:e.artFilename}),u.add(p,{silent:!0}),a=p.escape("AlbumName"),s.push({id:f.get("CommentID"),image:p.getImageURL(40),medimage:p.getImageURL(80),title:p.get("AlbumName"),comment:f.get("Message"),url:f.toUrl()})}),t.localeVariables.objectArticle=f.getAnchorTag(_.getString("ALBUM_ARTICLE",{otherUser:a}));break;case"user":var d;u=new n.Models.Collections.Users([]),_.each(i.comments,function(e){f=e.comment=new n.Models.Comment(e.comment);if(!e.comment)return;o++,d=n.Models.User.newOrUpdate({UserID:e.userID,FName:_.orEqual(e.userName,e.displayName),IsPremium:e.isPremium,Picture:_.orEqual(e.picture,e.artFilename)},{updateProfile:!1}),u.add(d,{silent:!0}),a=d.escape("Name"),s.push({id:f.get("CommentID"),image:d.getImageURL(40),medimage:d.getImageURL(80),title:d.get("Name"),comment:f.get("Message"),url:f.toUrl()})}),u.length===1&&d.get("UserID")===t.user.get("UserID")?(l=_.getString(t.localeVariables.possessiveKey+"_OWNER")+" "+_.getString("PROFILE").toLocaleLowerCase(),t.localeVariables.objectArticle=t.localeVariables.objectNamed=f.getAnchorTag(l)):u.length===1&&d.get("UserID")===n.getLoggedInUserID()?t.localeVariables.objectArticle=t.localeVariables.objectNamed=f.getAnchorTag(_.getString("YOUR_PROFILE")):t.localeVariables.objectArticle=t.localeVariables.objectNamed=f.getAnchorTag(_.getString("OTHER_USER_PROFILE",{otherUser:a}));break;case"playlist":var v;u=new n.Models.Collections.Playlists([]),_.each(i.comments,function(e){f=e.comment=new n.Models.Comment(e.comment);if(!e.comment)return;o++,v=n.Models.Playlist.newOrUpdate({UserID:e.userID,UserName:e.userName,PlaylistID:e.playlistID,PlaylistName:e.playlistName,Picture:_.orEqual(e.picture,e.artFilename)}),u.add(v,{silent:!0}),a=v.escape("PlaylistName"),s.push({id:f.get("CommentID"),image:v.getImageURL(70),medimage:v.getImageURL(200),title:v.get("PlaylistName"),comment:f.get("Message"),url:f.toUrl()})}),u.length===1&&v.get("UserID")===t.user.get("UserID")?(l=_.getString(t.localeVariables.possessiveKey+"_OWNER")+" "+_.getString("PLAYLIST").toLocaleLowerCase(),t.localeVariables.objectArticle=t.localeVariables.objectNamed=f.getAnchorTag(l)):u.length===1&&v.get("UserID")===n.getLoggedInUserID()&&(t.localeVariables.objectArticle=t.localeVariables.objectNamed=f.getAnchorTag(_.getString("YOUR_PLAYLIST"))),t.localeVariables.objectArticle=f.getAnchorTag(_.getString("PLAYLIST_ARTICLE").toLocaleLowerCase())}return u>1?(t.localeKey+="_MANY",t.items=s):s.length>1?t.items=s:f&&(t.item=s[0],t.items=null),!t.localeVariables.objectNamed&&f&&(t.localeVariables.objectNamed=f.getAnchorTag(a)),r.promise()},commentedOnArtist:function(e,t){t.itemType="comment",t.localeKey="FEED2_USER_COMMENTED",t.commentType="artist"},commentedOnSong:function(e,t){t.itemType="comment",t.localeKey="FEED2_USER_COMMENTED",t.commentType="song"},commentedOnAlbum:function(e,t){t.itemType="comment",t.localeKey="FEED2_USER_COMMENTED",t.commentType="album"},commentedOnUser:function(e,t){t.itemType="comment",t.localeKey="FEED2_USER_COMMENTED",t.commentType="user"},commentedOnPlaylist:function(e,t){t.itemType="comment",t.localeKey="FEED2_USER_COMMENTED",t.commentType="playlist"},getEventComments:function(e){var t=$.Deferred(),r=[];if(!e.get("comments")||!e.get("comments").length)t.resolve(r);else{r=e.get("comments").slice(0);var i=[];_.each(r,function(e){if(!e.userID&&!e.fromArtistID)return;if(e.fromArtistID)i.push(n.Models.Artist.get(e.fromArtistID).done(function(t){e.user=t,e.authorName=t.get("ArtistName")}));else if(_.isUndefined(e.userPicture))i.push(n.Models.User.get(e.userID).done(function(t){e.user=t,e.authorName=t.get("Name")}));else{var t={UserID:e.userID,FName:e.username,Picture:e.userPicture};e.user=n.Models.User.newOrUpdate(t,{dontCache:!0,updateProfile:!1}),e.authorName=e.username}e.time=_.getFormattedDate(e.timestamp),e.comment=_.makeSafeLinks(e.comment)}),$.after(i).done(function(){t.resolve(r)})}return t.promise()},handleMessage:function(){}};n.Models.FeedEvent=Backbone.CachedModel.extend({idAttribute:"EventID",parse:function(e,t){var n=t&&t.clone===!1?e:_.clone(e);return n.EventID=_.orEqual(n.eventID,n.EventID),n.client=_.orEqual(n.client,null),n.UserID=_.orEqualEx(n.userIDFrom,n.userID,n.UserID),n.UserID&&(n.UserID=_.toInt(n.UserID),n.UserPicture=_.orEqual(n.userPicture,n.UserPicture),n.UserName=_.orEqualEx(n.displayName,n.UserName,n.Username,n.username,n.FName)),n.ArtistID=n.artistID,n.feedType=_.orEqualEx(n.type,n.feedType,n.UserID?"user":"artist"),n.people&&(n.data.users=n.people),typeof n.bt!="undefined"&&(n.broadcastType=n.bt,delete n.bt),delete n.eventID,delete n.userID,delete n.userPicture,delete n.displayName,delete n.Username,delete n.username,delete n.people,delete n.FName,n},getPrimaryUser:function(){var e={UserID:this.get("UserID"),Picture:this.get("UserPicture"),FName:this.get("UserName")},t=$.Deferred(),r;return this.get("activityName")==="artistBroadcastFeed"?(r=n.Models.Artist.getCached(this.get("ArtistID")),r?t.resolve(r):t.resolve(n.Models.Artist.newOrUpdate({ArtistID:this.get("ArtistID"),Name:this.get("artistName"),ArtFilename:this.get("artFilename")})),t.resolve(r),t.promise()):e.UserID?(r=n.Models.User.getCached(e.UserID),r?t.resolve(r):e.FName?t.resolve(n.Models.User.newOrUpdate(e,{updateProfile:!1})):t.reject(),t.promise()):(this.get("data").users&&this.get("data").users.length?(e=this.get("data").users[0],r=n.Models.User.getCached(_.orEqual(e.UserID,e.userID)),r?t.resolve(r):t.resolve(n.Models.User.newOrUpdate(e,{updateProfile:!1}))):t.reject(),t.promise())},getIsUserOnEvent:function(e){if(this.get("UserID")===e)return!0;if(this.get("data").users){var t=this.get("data").users;for(var n=0,r=t.length;n<r;n++)if(t[n]&&_.orEqual(t[n].userID,t[n].UserID)==e)return!0;return!1}return this.get("UserID")==e},canComment:function(){var e=r.model.get("user");return this.get("activityName")==="artistBroadcastFeed"?!0:this.get("feedType")!=="user"||e.get("UserID")!=this.get("UserID")&&!e.get("followers").get(this.get("UserID"))?!1:!0},storeComment:function(e){var t=$.Deferred(),r;if(this.get("feedType")==="artist")this.get("ArtistID")?r=n.Services.API.addArtistFeedComment(this.get("EventID"),e,null,this.get("ArtistID")):r=n.Services.API.addArtistFeedComment(this.get("EventID"),e,null);else{var i="",s=n.Models.User.getCached(this.get("UserID"));s&&(i=s.get("Name")),r=n.Services.API.addEventComment(this.get("EventID"),e,i)}return r.done(_.bind(function(e){e&&e._id?(this.unset("normalizedObject"),this.get("comments")?(this.get("comments").push(e),this.trigger("change:comments",this.get("comments"))):this.set("comments",[e]),this.trigger("newComment",e),t.resolve(e)):(t.reject(e),n.trigger("notification:add",{description:_.getString("POPUP_ERROR_COMMENT_FAILED"),type:"error",duration:5e3}))},this)).fail(_.bind(t.reject,t)),t.promise()},hideEvent:function(){var e=$.Deferred(),t;if(this.get("feedType")==="artist")t=n.Services.API.hideArtistEvent(this.get("ArtistID"),this.get("EventID"));else{var r=n.getLoggedInUserID()===this.get("UserID");t=n.Services.API.hideUserEvent(this.get("EventID"),r)}return t.done(_.bind(function(t){t&&t.success?(this.destroy(),e.resolve(t)):(e.reject(t),n.trigger("notification:add",{description:_.getString("POPUP_ERROR_FEED_DELETE_FAILED"),type:"error",duration:5e3}))},this)),e.promise()},hideComment:function(e){var t=$.Deferred(),r;return this.get("feedType")==="artist"?r=n.Services.API.hideArtistFeedComment(this.get("EventID"),e):r=n.Services.API.hideEventComment(this.get("EventID"),e),r.done(_.bind(function(r){if(r&&r.success){this.unset("normalizedObject");var i=this.get("comments").concat([]);for(var s=0,o=i.length;s<o;s++)if(i[s]._id===e){i.splice(s,1);break}this.set("comments",i),this.trigger("removedComment"),t.resolve(r)}else t.reject(r),n.trigger("notification:add",{description:_.getString("POPUP_ERROR_COMMENT_DELETE_FAILED"),type:"error",duration:5e3})},this)),t.promise()},updateSelf:function(e){this.unset("normalizedObject"),this.set({data:e.data,timestamp:e.timestamp})},getNormalizedObject:function(r,i,s){var o=$.Deferred(),u=_.getFormattedDate(this.get("timestamp")),a=this.get("normalizedObject");if(typeof a=="object"&&!i){if(a){a.time=u;var f=$.extend({},a);f.localeVariables.object=r&&f.localeVariables.objectNamed?f.localeVariables.objectNamed:f.localeVariables.objectArticle,!_.defined(f.localeVariables.object)&&!r&&(f.localeVariables.object=f.localeVariables.objectNamed),!s&&typeof a.comments=="undefined"?t.getEventComments(this).done(function(e){f.comments=a.comments=e,o.resolve(f)}):o.resolve(f)}else o.reject(a);return o.promise()}if(_.defined(t[this.get("activityName")]))try{var l=_.chainLoading(),c={id:this.get("EventID"),time:u,client:this.get("client"),message:"",itemType:"message",item:null,items:[],localeKey:"",localeVariables:{},groupBy:"",destination:""};return l.push(this.getPrimaryUser().done(l.bind(function(e){c.user=e,c.localeVariables.possessiveKey="AMBIGUOUS_POSSESSIVE",e.get("Name")||e.get("ArtistName")?c.localeVariables.user=e.getAnchorTag(!1,null,!0):c.localeVariables.user=e.getAnchorTag("USER_SOMEONE",null,!0)},this))),l.done(_.bind(function(){t[this.get("activityName")](this,c),c.itemType&&(t["handle"+_.ucwords(c.itemType)](this,c),c.localeVariables.objects||(c.localeVariables.objects=_.getString(c.itemType.toUpperCase()+"_PLURAL"))),e(this,c);if(c.item){c.item.isFavorite=!1;var r=n.Models[_.ucwords(c.itemType)].getCached(c.item.id);r&&r.get("isFavorite")&&(c.item.isFavorite=r.get("isFavorite"))}var i=_.orEqual(this.get("data")&&this.get("data").message,this.get("message"));if(i){var s=$.parseGSTagMessage(i);c.message="";for(var o=0,u=s.length;o<u;o++)s[o].name&&s[o].id?c.message+='<a href="'+_.cleanUrl(s[o].name,s[o].id,"profile")+'">'+_.escape(s[o].name)+"</a>":s[o]&&(c.message+=_.makeSafeLinks(s[o]))}},this)),s||l.push(t.getEventComments(this).done(l.bind(function(e){c.comments=e},this))),l.done(_.bind(function(){if(c.itemType==="message"||c.item&&c.items&&!c.items.length)c.items=null;if(c.item||c.items&&c.items.length||this.get("activityName")==="artistBroadcastFeed"){c.eventLink=this.toUrl(),this.set("normalizedObject",c);var e=$.extend({},c);e.localeVariables.object=r&&e.localeVariables.objectNamed?e.localeVariables.objectNamed:e.localeVariables.objectArticle,!_.defined(e.localeVariables.object)&&!r&&(e.localeVariables.object=e.localeVariables.objectNamed),o.resolve(e)}else this.set("normalizedObject",null),o.reject(null)},this)),o.promise()}catch(h){gsConfig.runMode!=="production"&&console.warn("couldn't process feed event",h,h.stack,this)}else gsConfig.runMode!=="production"&&console.warn("no event handler found for type: ",this.get("activityName"),this);return this.set("normalizedObject",null),o.reject(null),o.promise()},getSongsPlayed:function(){var e=[];try{switch(this.get("activityName")){case"userPlayed":case"playlistPlayed":case"artistPlayed":case"albumPlayed":case"songPlayed":case"obsession":e=_.orEqual(this.get("data").songs,[])}}catch(t){console.warn("couldn't load songs for feed event",t,this)}return e},toUrl:function(){switch(this.get("feedType")){case"user":var e=this.get("UserID"),t=n.Models.User.getCached(e);if(t)return t.toUrl("activity/"+this.id);if(e)return _.cleanUrl(null,e,"profile",null,"activity/"+this.id);case"artist":var r=this.get("ArtistID"),i=n.Models.Artist.getCached(r);if(i)return i.toUrl("activity/a/"+this.id);if(r)return _.cleanUrl(null,r,"artist",null,"activity/a/"+this.id)}return""},canRemove:function(){var e=n.getLoggedInUserID();if(this.get("UserID")===e||this.get("ArtistID")&&n.isLoggedInUserOwnerOfArtist(this.get("ArtistID")))return!0;if(this.get("activityName")==="broadcast"&&this.get("data")&&this.get("data").users){var t=this.get("data").users;for(var r=0,i=t.length;r<i;r++)if(t[r]&&_.orEqual(t[r].userID,t[r].UserID)===e)return!0}return!1}},{BROADCAST_TYPES:{SONG:1,PLAYLIST:2,ARTIST:3,ALBUM:4},get:function(e,t){var r;return t==="artist"?r=Backbone.CachedModel.genericGet.call(this,n.Services.API.getArtistFeedEventByID,"eventID",e):r=Backbone.CachedModel.genericGet.call(this,n.Services.API.getFeedEventByID,"eventID",e),r.promise()}})}(),function(){function e(e){return(new Date(e.getFullYear(),e.getMonth()+1,0)).getDate()}n.Models=n.Models||{};var t=Backbone.Collection.extend({model:Backbone.Model,comparator:function(e){return-e.get("periodPlays")}});n.Models.Leaderboard=Backbone.Model.extend({initialize:function(){var e={tagID:"all",date:new Date,unit:"week",max:50,collection:new t};this.set(_.defaults(this.attributes,e))},toUrl:function(e){var t=this.get("date"),n=[t.getMonth()+1,"-",t.getDate(),"-",t.getFullYear()].join("");return[e,"?period=",this.get("unit"),"&date=",n].join("")},dateRange:function(){var t=this.get("date"),r=new Date,i=new Date(t),s=new Date(t);switch(this.get("unit")){case"day":break;case"week":i.setDate(i.getDate()-i.getDay()),s.setDate(s.getDate()+(6-s.getDay()));break;case"month":i.setDate(1),s.setDate(e(t));break;case"year":i.setMonth(0),i.setDate(1),s.setMonth(11),s.setDate(31);case"alltime":i=new Date(n.Models.Leaderboard.earliest),s=new Date(r);break;default:}return i<n.Models.Leaderboard.earliest&&(i=new Date(n.Models.Leaderboard.earliest)),s>r&&(s=new Date(r)),i.setHours(0,0,0,0),s.setHours(23,59,59,999),{from:i,to:s}},inRange:function(e){var t=this.dateRange();return e>=t.from&&e<=t.to},stringifyDate:function(e){e=_.orEqual(e,!0);var t=new Date;if(!this.inRange(t))return this.get("date").toDateString();switch(this.get("unit")){case"day":return e?_.getString("TODAY"):"today";case"week":return e?_.getString("THIS_WEEK"):"this week";case"month":return e?_.getString("THIS_MONTH"):"this month";case"year":return e?_.getString("THIS_YEAR"):"this year";case"alltime":return e?_.getString("ALL_TIME"):"all time"}},stringifyDateRange:function(){var e=new Date,t=this.dateRange(),n=_.shortMonthsOfTheYear[t.from.getMonth()],r=_.shortMonthsOfTheYear[t.to.getMonth()];return this.inRange(e)?this.stringifyDate():t.from.getMonth()===t.to.getMonth()?[n,t.from.getDate(),"-",t.to.getDate()+",",t.to.getFullYear()].join(" "):[n,t.from.getDate(),"-",r,t.to.getDate()+",",t.to.getFullYear()].join(" ")},fetch:function(e){var t=$.Deferred();return this.set(e),n.Services.API.getLeaderboardBroadcasters(this.stringifyDate(!1),this.get("tagID"),this.get("unit")).done(_.bind(function(e){var r=e.users||[],i=e.artists||[],s=_.sortBy(r.concat(i),function(e){return-e.periodPlays}).slice(0,this.get("max")),o=_.filter(_.pluck(s,"UserID"),function(e){return!_.isUndefined(e)});this.get("collection").reset(s),n.Models.User.getUsersStatuses(o),t.resolve()},this)),t}},{earliest:new Date(2013,6,29)})}(),function(){n.Models=n.Models||{};var e={generic:function(e,t,i){var s,o={};switch(e.genericType){case 1:return s=e.data.playlists[0],{icon:"playlist",text:_.getString("NOTIF_EVENT_ADDED_COLLABORATOR",{user:'<a class="open-profile-card" data-user-id="'+e.userIDFrom+'">'+e.userNameFrom+"</a>",playlist:'<a class="open-profile-card" data-user-id="'+e.userIDFrom+'">'+w.get("Name")+"</a>"}),picture:n.Models.Playlist.artPath+"70_"+(s.artFilename?s.artFilename:"playlist.png"),link:_.cleanUrl(s.name,s.playlistID,"playlist")};case 2:s=e.data,e.artistIDFrom?o.picture=n.Models.Artist.artPath+"40_"+(e.artistCoverArt?e.artistCoverArt:"artist.png"):o.picture=n.Models.User.artPath+"40_"+(e.userPicture?e.userPicture:"user.png");var u=_.orEqual(e.artistNameFrom,e.usernameFrom),a=e.fromArtistID?"artist":"user",f=e.artistIDFrom?e.artistIDFrom:e.userIDFrom,l=s.Message?s.Message.length>r?_.escape(s.Message.slice(0,r))+"...":_.escape(s.Message):null;switch(s.TypeID){case n.Models.Comment.COMMENT_PAGE_TYPES.SONG:o.text=_.getString("NOTIF_EVENT_COMMENT_SONG",{user:_.escape(u),name:_.escape(s.SongName),comment:l}),o.textLinks=_.getString("NOTIF_EVENT_COMMENT_SONG",{user:'<a class="open-profile-card" data-user-id="'+f+'">'+_.escape(u)+"</a>",name:'<a class="comment-link" data-comment-id="'+s.CommentID+'">'+_.escape(s.SongName)+"</a>",comment:_.escape(l)}),o.link=null,o.type="comment",o.itemType="song",o.itemID=s.ItemID;break;case n.Models.Comment.COMMENT_PAGE_TYPES.ALBUM:o.text=_.getString("NOTIF_EVENT_COMMENT_ALBUM",{user:_.escape(u),name:_.escape(s.AlbumName),comment:l}),o.textLinks=_.getString("NOTIF_EVENT_COMMENT_ALBUM",{user:'<a class="open-profile-card" data-user-id="'+f+'">'+_.escape(u)+"</a>",name:'<a class="comment-link" data-comment-id="'+s.CommentID+'">'+_.escape(s.AlbumName)+"</a>",comment:_.escape(l)}),o.link=_.cleanUrl(null,s.ItemID,"album",null,"comment/"+s.CommentID),o.type="comment";break;case n.Models.Comment.COMMENT_PAGE_TYPES.PLAYLIST:o.text=_.getString("NOTIF_EVENT_COMMENT_PLAYLIST",{user:_.escape(u),name:_.escape(s.PlaylistName),comment:l}),o.textLinks=_.getString("NOTIF_EVENT_COMMENT_PLAYLIST",{user:'<a class="open-profile-card" data-user-id="'+f+'">'+_.escape(u)+"</a>",name:'<a class="comment-link" data-comment-id="'+s.CommentID+'">'+_.escape(s.PlaylistName)+"</a>",comment:_.escape(l)}),o.link=_.cleanUrl(null,s.ItemID,"playlist",null,"comment/"+s.CommentID),o.type="comment";break;case n.Models.Comment.COMMENT_PAGE_TYPES.ARTIST:o.text=_.getString("NOTIF_EVENT_COMMENT_PROFILE",{user:_.escape(u),profile:_.getString("PROFILE").toLowerCase(),comment:l}),o.textLinks=_.getString("NOTIF_EVENT_COMMENT_PROFILE",{user:'<a class="open-profile-card" data-user-id="'+f+'">'+_.escape(u)+"</a>",profile:'<a class="comment-link" data-comment-id="'+s.CommentID+'">'+_.getString("PROFILE").toLowerCase()+"</a>",comment:_.escape(l)}),o.link=n.Models.Artist.getArtistUrl(s.ItemID,null,"comment/"+s.CommentID),o.type="comment";break;default:o.text=_.getString("NOTIF_EVENT_COMMENT_PROFILE",{user:_.escape(u),profile:_.getString("PROFILE").toLowerCase(),comment:l}),o.textLinks=_.getString("NOTIF_EVENT_COMMENT_PROFILE",{user:'<a class="open-profile-card" data-user-id="'+f+'">'+_.escape(u)+"</a>",profile:'<a class="comment-link" data-comment-id="'+s.CommentID+'">'+_.getString("PROFILE").toLowerCase()+"</a>",comment:_.escape(l)}),o.link=t.toUrl("comment/"+s.CommentID),o.type="comment"}return o.btnType="comment",o.itemType=o.itemType?o.itemType:null,o.itemID=o.itemID?o.itemID:null,o.commentItemType=s.TypeID,o.commentItemID=s.ItemID,o.commentID=s.CommentID,o;case 3:s=e.data;var f,c,h,a,l=s.Message?s.Message.length>r?_.escape(s.Message.slice(0,r))+"...":_.escape(s.Message):null;s.FromOwner&&s.TypeID!==n.Models.Comment.COMMENT_PAGE_TYPES.USER||e.artistIDFrom?(a="artist",f=e.artistIDFrom,c=e.artistNameFrom,o.picture=n.Models.Artist.artPath+"40_"+(e.artistCoverArt?e.artistCoverArt:"artist.png")):(a="user",f=e.userIDFrom,c=e.usernameFrom,o.picture=n.Models.User.artPath+"40_"+(e.userPicture?e.userPicture:"user.png"));if(s.CommentID){h=n.Models.Comment.getCached(s.CommentID);var p=n.Models.Comment.getModelForType(s.TypeID);if(h&&p){var d=p.getCached(s.ItemID),v=d?d.get("comments"):null;v&&(v.lastLoaded=0),n.Models.Comment.uncache(h)}}return o.text=_.getString("NOTIF_EVENT_COMMENT_INCEPTION",{user:_.escape(c),comment:l}),o.textLinks=_.getString("NOTIF_EVENT_COMMENT_INCEPTION_LINK",{user:'<a class="open-profile-card" data-user-id="'+f+'">'+_.escape(c)+"</a>",commentID:s.CommentID,comment:l}),o.link=h?h.toUrl():null,o.type="comment",o.btnType="comment",o.itemType=null,o.itemID=null,o.commentID=s.CommentID,o.commentItemType=s.TypeID,o.commentItemID=s.ItemID,o;case 4:return null;case 5:return s=e.data,s.claimStatus===9?(o.text=_.getString("NOTIF_EVENT_ARTIST_APPROVED",{name:_.escape(s.artistName)}),o.textLinks=_.getString("NOTIF_EVENT_ARTIST_APPROVED",{name:'<a href="'+n.Models.Artist.getArtistUrl(s.artistID,s.artistName)+'">'+_.escape(s.artistName)+"</a>"}),o.btnType=null,o.itemType="artist-approved",o.itemID=s.artistID):(o.text=_.getString("NOTIF_EVENT_ARTIST_UPDATED",{name:_.escape(s.artistName)}),o.textLinks=_.getString("NOTIF_EVENT_ARTIST_UPDATED",{name:'<a href="'+n.Models.Artist.getArtistUrl(s.artistID,s.artistName)+'">'+_.escape(s.artistName)+"</a>"}),o.btnType=null,o.itemType="artist-updated",o.itemID=null),o.link=n.Models.Artist.getArtistUrl(s.artistID,s.artistName),o.picture=_.getCDNImage("40_Logo.png"),o.artistID=s.artistID,o;case 6:s=e.data,o.picture=n.Models.Artist.artPath+"40_"+(s.artFilename?s.artFilename:"artist.png");if(s.claimStatus===9){o.text=_.getString("NOTIF_EVENT_CONTENT_APPROVED",{name:_.escape(s.artistName)});if(s.songs&&s.songs.length){var m=[],g;i&&_.each(s.songs,function(e){g=n.Models.Song.getCached(_.toInt(e.SongID));if(g){if(g.get("ArtistID")===_.toInt(e.ArtistID))return;n.Models.Song.nukeSong(g,!1)}g=new n.Models.Song(e),g.setPreferredAlbum(e.AlbumID),g.setPreferredArtist(e.ArtistID),m.push(g)});var y=n.Models.Album.getCached(s.songs[0].AlbumID);y||(y=new n.Models.Album({AlbumID:s.songs[0].AlbumID,AlbumName:s.songs[0].AlbumName}));if(m.length&&i){var b=n.Models.Artist.getCached(m[0].get("ArtistID"));b&&b.get("songs")&&b.get("songs").add(m),y.get("songs")&&y.get("songs").add(m)}o.link=y.toUrl()}}else o.text=_.getString("NOTIF_EVENT_CONTENT_UPDATED",{name:_.escape(s.artistName)}),o.link="#";return o.picture=_.getCDNImage("40_Logo.png"),o.btnType=null,o.itemType="content-updated",o.itemID=null,o;case 7:return null;case 8:var w=n.Models.User.getCached(e.userIDFrom);return w||(w={UserID:e.userIDFrom,Picture:e.userPicture,FName:e.usernameFrom},w=new n.Models.User(w)),{btnType:"plus",itemType:"user",itemID:e.userIDFrom,text:_.getString("NOTIF_USER_FOLLOWED_YOU",{user:w.escape("Name")}),textLinks:_.getString("NOTIF_USER_FOLLOWED_YOU",{user:'<a class="open-profile-card" data-user-id="'+e.userIDFrom+'">'+w.escape("Name")+"</a>"}),picture:w.getImageURL(70),link:w.toUrl()};case 9:s=e.data;if(!s.Playlist)return null;var w=n.Models.User.getCached(e.userIDFrom);w||(w={UserID:e.userIDFrom,Picture:e.userPicture,FName:e.usernameFrom},w=new n.Models.User(w));var E=n.Models.Playlist.getCached(s.Playlist.PlaylistID);return E||(E=new n.Models.Playlist(s.Playlist)),{btnType:"plus",itemType:"user",itemID:e.userIDFrom,text:_.getString("NOTIF_USER_FOLLOWED_YOUR_PLAYLIST",{user:w.escape("Name"),playlist:E.escape("PlaylistName")}),textLinks:_.getString("NOTIF_USER_FOLLOWED_YOUR_PLAYLIST",{user:'<a class="open-profile-card" data-user-id="'+e.userIDFrom+'">'+w.escape("Name")+"</a>",playlist:'<a href="'+E.toUrl()+'"><strong>'+E.escape("PlaylistName")+"</strong></a>"}),picture:w.getImageURL(70),link:w.toUrl()};case 10:var w=n.Models.User.getCached(e.userIDFrom),S;return w||(w={UserID:e.userIDFrom,Picture:e.userPicture,FName:e.usernameFrom},!$.trim(e.usernameFrom)&&e.data&&e.data.twitterHandleFrom&&(S="@"+_.escape(e.data.twitterHandleFrom)),w=new n.Models.User(w)),S||(S=w.escape("Name")),{btnType:"plus",itemType:"user",itemID:e.userIDFrom,text:_.getString("NOTIF_FRIEND_FROM_TWITTER_JOINED",{user:S}),picture:w.getImageURL(70),link:w.toUrl()};case 11:s=e.data;if(!s.artistID||n.isLoggedInUserOwnerOfArtist(s.artistID))return null;return{btnType:null,itemType:null,itemID:null,text:_.getString("NOTIF_ARTIST_VERIFY_EMAIL",{artist:_.escape(s.artistName)}),picture:n.Models.Artist.artPath+"40_"+(s.artFilename||"artist.png"),link:n.Models.Artist.getArtistUrl(s.artistID,s.artistName)}}},broadcast:function(e,t){var i=e.data;_.defined(e.broadcastType)||(e.broadcastType=e.bt);var s=new n.Models.FeedEvent(e,{dontCache:!0}),o=s.get("UserName"),u=s.get("UserID"),a=e.message?e.message.length>r?_.escape(e.message.slice(0,r))+"...":_.escape(e.message):"",f;switch(e.broadcastType){case 1:var l=n.Models.Song.newOrUpdate(i.songs[0]),c=l.get("SongID");return f=_.getString("SELECTION_SONG_SINGLE",{SongName:'<a class="song-link" data-song-id="'+c+'"><strong>'+l.escape("SongName")+"</strong></a>",ArtistName:'<a href="'+_.cleanUrl(l.get("ArtistName"),l.get("ArtistID"),"artist")+'"><strong>'+l.escape("ArtistName")+"</strong></a>"}),i=_.getString("SELECTION_SONG_SINGLE",{SongName:"<strong>"+l.escape("SongName")+"</strong>",ArtistName:"<strong>"+l.escape("ArtistName")+"</strong>"}),{type:"share",btnType:"play",itemType:"song",itemID:c,text:_.getString("NOTIF_BROADCAST_SONG_WITH_YOU",{user:_.escape(o),name:i,shareComment:a}),textLinks:_.getString("NOTIF_BROADCAST_SONG_WITH_YOU",{user:'<a class="open-profile-card" data-user-id="'+e.userIDFrom+'">'+_.escape(o)+"</a>",name:i,shareComment:a}),picture:l.getImageURL(40),songID:c,link:s.toUrl()};case 2:var h=n.Models.Playlist.wrapFeedData(i.playlists[0]);return f=['<a href="',h.toUrl(),'"><strong>',h.escape("PlaylistName"),"</strong></a>"].join(""),i=["<strong>",h.escape("PlaylistName"),"</strong>"].join(""),{type:"share",btnType:"play",itemType:"playlist",itemID:h.get("PlaylistID"),text:_.getString("NOTIF_BROADCAST_PLAYLIST_WITH_YOU",{user:_.escape(o),shareComment:a}),textLinks:_.getString("NOTIF_BROADCAST_PLAYLIST_WITH_YOU",{user:'<a class="open-profile-card" data-user-id="'+e.userIDFrom+'">'+_.escape(o)+"</a>",shareComment:a}),picture:h.getImageURL(70),link:s.toUrl()};case 3:var p=n.Models.Artist.newOrUpdate(i.artists[0]);return f=['<a href="',p.toUrl(),'"><strong>',p.escape("ArtistName"),"</strong></a>"].join(""),i=["<strong>",p.escape("ArtistName"),"</strong>"].join(""),{type:"share",btnType:"play",itemType:"artist",itemID:p.get("ArtistID"),text:_.getString("NOTIF_BROADCAST_ARTIST_WITH_YOU",{user:_.escape(o),name:i,shareComment:a}),textLinks:_.getString("NOTIF_BROADCAST_ARTIST_WITH_YOU",{user:'<a class="open-profile-card" data-user-id="'+e.userIDFrom+'">'+_.escape(o)+"</a>",name:i,shareComment:a}),picture:p.getImageURL(40),link:s.toUrl()};case 4:var d=n.Models.Album.newOrUpdate(i.albums[0]);return f=_.getString("SELECTION_ALBUM_SINGLE",{AlbumName:'<a href="'+d.toUrl()+'"><strong>'+d.escape("AlbumName")+"</strong></a>",ArtistName:'<a href="'+_.cleanUrl(d.get("ArtistName"),d.get("ArtistID"),"artist")+'"><strong>'+d.escape("ArtistName")+"</strong></a>"}),i=_.getString("SELECTION_ALBUM_SINGLE",{AlbumName:"<strong>"+d.escape("AlbumName")+"</strong>",ArtistName:"<strong>"+d.escape("ArtistName")+"</strong>"}),{type:"share",btnType:"play",itemType:"album",itemID:d.get("AlbumID"),text:_.getString("NOTIF_BROADCAST_ALBUM_WITH_YOU",{user:_.escape(o),name:i,shareComment:a}),textLinks:_.getString("NOTIF_BROADCAST_ALBUM_WITH_YOU",{user:'<a class="open-profile-card" data-user-id="'+e.userIDFrom+'">'+_.escape(o)+"</a>",name:i,shareComment:a}),picture:d.getImageURL(40),link:s.toUrl()}}},artistBroadcastFeed:function(e,t){var i=e.data;_.defined(e.broadcastType)||(e.broadcastType=e.bt),e.type==="user"&&(e.type="artist");var s=new n.Models.FeedEvent(e,{dontCache:!0}),o=s.get("artistName"),u=s.get("artistID"),a=e.message?e.message.length>r?_.escape(e.message.slice(0,r))+"...":_.escape(e.message):"",f;switch(e.broadcastType){case 0:return{type:"share",btnType:"comment",itemType:"update",itemUrl:s.toUrl(),text:_.getString("NOTIF_BROADCAST_TEXT_WITH_FANS",{artist:_.escape(o),update:a}),textLinks:_.getString("NOTIF_BROADCAST_TEXT_WITH_FANS_LINK",{artist:'<a href="'+_.cleanUrl(o,u,"artist")+'">'+_.escape(o)+"</a>",eventLink:s.toUrl()}),picture:n.Models.Artist.artPath+"40_"+(e.artFilename||"artist.png"),broadcastMessage:e.message,link:s.toUrl()};case 1:var l=n.Models.Song.newOrUpdate(i.songs[0]),c=l.get("SongID");return f=_.getString("SELECTION_SONG_SINGLE",{SongName:'<a class="song-link" data-song-id="'+c+'"><strong>'+l.escape("SongName")+"</strong></a>",ArtistName:'<a href="'+_.cleanUrl(l.get("ArtistName"),l.get("ArtistID"),"artist")+'"><strong>'+l.escape("ArtistName")+"</strong></a>"}),i=_.getString("SELECTION_SONG_SINGLE",{SongName:"<strong>"+l.escape("SongName")+"</strong>",ArtistName:"<strong>"+l.escape("ArtistName")+"</strong>"}),{type:"share",btnType:"play",itemType:"song",itemID:c,text:_.getString("NOTIF_BROADCAST_SONG_WITH_FANS",{artist:_.escape(o),name:i,shareComment:a}),textLinks:_.getString("NOTIF_BROADCAST_SONG_WITH_FANS",{artist:'<a href="'+_.cleanUrl(o,u,"artist")+'">'+_.escape(o)+"</a>",name:i,shareComment:a}),picture:l.getImageURL(40),songID:c,broadcastMessage:e.message,link:s.toUrl()};case 2:var h=n.Models.Playlist.wrapFeedData(i.playlists[0]);return f=['<a href="',h.toUrl(),'"><strong>',h.escape("PlaylistName"),"</strong></a>"].join(""),i=["<strong>",h.escape("PlaylistName"),"</strong>"].join(""),{type:"share",btnType:"play",itemType:"playlist",itemID:h.get("PlaylistID"),text:_.getString("NOTIF_BROADCAST_PLAYLIST_WITH_FANS",{artist:_.escape(o),shareComment:a}),textLinks:_.getString("NOTIF_BROADCAST_PLAYLIST_WITH_FANS",{artist:'<a href="'+_.cleanUrl(o,u,"artist")+'">'+_.escape(o)+"</a>",shareComment:a}),picture:h.getImageURL(70),broadcastMessage:e.message,link:s.toUrl()};case 3:var p=n.Models.Artist.newOrUpdate(i.artists[0]);return f=['<a href="',p.toUrl(),'"><strong>',p.escape("ArtistName"),"</strong></a>"].join(""),i=["<strong>",p.escape("ArtistName"),"</strong>"].join(""),{type:"share",btnType:null,itemType:"artist",itemID:p.get("ArtistID"),text:_.getString("NOTIF_BROADCAST_ARTIST_WITH_FANS",{artist:_.escape(o),name:i,shareComment:a}),textLinks:_.getString("NOTIF_BROADCAST_ARTIST_WITH_FANS",{artist:'<a href="'+_.cleanUrl(o,u,"profile")+'">'+_.escape(o)+"</a>",name:i,shareComment:a}),picture:p.getImageURL(40),broadcastMessage:e.message,link:s.toUrl()};case 4:var d=n.Models.Album.newOrUpdate(i.albums[0]);return f=_.getString("SELECTION_ALBUM_SINGLE",{AlbumName:'<a href="'+d.toUrl()+'"><strong>'+d.escape("AlbumName")+"</strong></a>",ArtistName:'<a href="'+_.cleanUrl(d.get("ArtistName"),d.get("ArtistID"),"artist")+'"><strong>'+d.escape("ArtistName")+"</strong></a>"}),i=_.getString("SELECTION_ALBUM_SINGLE",{AlbumName:"<strong>"+d.escape("AlbumName")+"</strong>",ArtistName:"<strong>"+d.escape("ArtistName")+"</strong>"}),{type:"share",btnType:"play",itemType:"album",itemID:d.get("AlbumID"),text:_.getString("NOTIF_BROADCAST_ALBUM_WITH_FANS",{artist:_.escape(o),name:i,shareComment:a}),textLinks:_.getString("NOTIF_BROADCAST_ALBUM_WITH_FANS",{artist:'<a href="'+_.cleanUrl(o,u,"artist")+'">'+_.escape(o)+"</a>",name:i,shareComment:a}),picture:d.getImageURL(40),broadcastMessage:e.message,link:s.toUrl()}}},comment:function(e,t){var r=_.orEqual(e.usernameFrom,e.displayName),i,s;if(e.eventOwnerUserID&&e.eventOwnerUserID!=n.getLoggedInUserID()){var o=n.Models.User.getCached(e.eventOwnerUserID);o?(s=o.toUrl("activity/"+e.eventID),e.eventOwnerName=o.get("Name")):s=_.cleanUrl(null,e.eventOwnerUserID,"profile",e.eventOwnerName,"activity/"+e.eventID),e.eventOwnerUserID==e.userIDFrom?i=_.getString("NOTIF_COMMENT_SELF_FEED_EVENT",{user:_.escape(r),owner:_.escape(e.eventOwnerName)}):i=_.getString("NOTIF_COMMENT_OTHER_FEED_EVENT",{user:_.escape(r),owner:_.escape(e.eventOwnerName)})}else i=_.getString("NOTIF_COMMENT_FEED_EVENT",{user:_.escape(r)}),s=t.toUrl("activity/"+e.eventID);return{btnType:null,itemType:null,itemID:null,type:"comment",text:i,picture:n.Models.User.artPath+"40_"+(e.userPicture?e.userPicture:"user.png"),link:s}}},t=1,r=75;n.Models.Taco=Backbone.CachedModel.extend({idAttribute:"TacoID",parse:function(e,n){var r=n&&n.clone===!1?e:_.clone(e);r.isNew=_.orEqual(r.isNew,!1),r.TacoID=t++,r.data=_.orEqual(r.data,{});var i=null;if(r.genericType)switch(r.genericType){case 2:i=r.artistID;break;case 3:i=r.artistID;break;case 6:i=r.artistID}return r.forArtistID=i,r},getNormalizedObject:function(t){var n=this.get("normalizedObject");if(typeof n!="object")try{var r=e[this.get("activityName")](this.attributes,t,this.get("isNew"));if(!r)return;r.timestamp=this.get("timestamp"),this.set("normalizedObject",r),n=r}catch(i){return gsConfig.runMode!=="production"&&console.warn("Couldn't process taco",i,i.message,this),null}return n.time=_.getFormattedDate(this.get("timestamp")),this.get("forArtistID")&&(n.forArtistID=this.get("forArtistID")),$.extend({},n)}},{})}(),function(){function b(e){var t={};e=_.toInt(e);switch(e){case 1:case 3:case 4:t.type=l,t.length=h,t.special=!0;break;case 2:t.type=l,t.length=d,t.special=!0;break;case 5:t.type=l,t.length=h,t.special=!0;break;case 6:case 15:case 20:t.type=f,t.length=h;break;case 7:case 16:case 19:t.type=f,t.length=d;break;case 8:case 10:case 11:case 13:case 14:case 17:t.type=l,t.length=h;break;case 9:case 18:t.type=l,t.length=d;break;case 12:t.type=l,t.length=c;break;case 21:t.type=a,t.length=h;break;case 22:t.type=a,t.length=d;break;case 97:t.type=a,t.length=v;break;case 98:t.type=f,t.length=v;break;case 99:t.type=l,t.length=v}return t}function w(e,t){var r=e.bVip===1||e.bVip==="1",i={vip:r,isLoaded:!0};if((e===!1||!e.paymentType)&&t&&t.get("IsPremium"))i.SubscriptionTypeID=99,i.type=l,i.length=v,t.get("Flags")&n.Models.User.FLAG_ANYWHERE||(t.get("Flags")&n.Models.User.FLAG_PLUS?(i.SubscriptionTypeID=98,i.type=f):t.get("Flags")&n.Models.User.FLAG_LITE&&(i.SubscriptionTypeID=97,i.type=a));else if(!e||!e.bActive||e.bActive=="0")i={SubscriptionTypeID:0,vip:r,isLoaded:!0};else{i.SubscriptionTypeID=e.subscriptionTypeID;if(i.SubscriptionTypeID>0){var s=b(i.SubscriptionTypeID);i=$.extend({},s,i)}i.recurring=e.bRecurring,(e.bVip==="1"||e.bVip===1)&&t&&t.get("IsPremium")&&(i.type=l),i.paymentMethod=_.orEqual(e.paymentType,"UNKNOWN"),i.billingAmount=parseFloat(e.amount).toFixed(2);if(e.dateUnsubscribed){var o=e.dateUnsubscribed.split("-");o.length>1&&(i.unsubscriptionDate=new Date(_.toInt(o[0]),_.toInt(o[1])-1,_.toInt(o[2])))}if((e.dateSubscriptionEnd||e.dateEnd||e.dateSubcriptionEnd)&&!i.recurring)try{var u=_.orEqual(e.dateSubscriptionEnd,e.dateSubcriptionEnd,e.dateEnd,"").split("-");u.length>1&&(i.endDate=new Date(_.toInt(u[0]),_.toInt(u[1])-1,_.toInt(u[2])))}catch(p){i.endDate=-1}else i.unsubscriptionDate&&(i.endDate=i.unsubscriptionDate);if((e.dateNextBill||e.dateNextCheck)&&i.recurring&&e.dateStart!=e.dateNextCheck)try{var m=_.orEqual(e.dateNextBill,e.dateNextCheck,"").split("-");m.length>1&&(i.nextBillDate=new Date(_.toInt(m[0]),_.toInt(m[1])-1,_.toInt(m[2])))}catch(p){i.nextBillDate=-1}else e.dateStart==e.dateNextCheck&&(i.nextBillDate=i.endDate);e.period=="MONTH"?i.length=h:e.period=="YEAR"?i.length=d:e.period=="WEEK"&&(i.length=c),t&&(t.get("Flags")&n.Models.User.FLAG_ANYWHERE)>0?i.type=l:t&&(t.get("Flags")&n.Models.User.FLAG_PLUS)>0&&t.get("IsPremium")?i.type=f:t&&(t.get("Flags")&n.Models.User.FLAG_LITE)>0&&(i.type=a)}return i}function E(e,t){var r={isLoaded:!0};if((!e||!e.UserID)&&t&&t.get("IsPremium"))r.SubscriptionTypeID=99,r.type=l,r.length=v,t.get("Flags")&n.Models.User.FLAG_ANYWHERE||(t.get("Flags")&n.Models.User.FLAG_PLUS?(r.SubscriptionTypeID=98,r.type=f):t.get("Flags")&n.Models.User.FLAG_LITE&&(r.SubscriptionTypeID=97,r.type=a));else if(!e||!e.Status||e.Status==="0")r={SubscriptionTypeID:0,isLoaded:!0};else{r.SubscriptionTypeID=_.toInt(e.SubType);if(r.SubscriptionTypeID>0){var i=b(r.SubscriptionTypeID);r=$.extend({},i,r)}r.recurring=!parseInt(e.CancelAtPeriodEnd,10),r.paymentMethod=_.orEqual(e.api,"UNKNOWN").toUpperCase(),e.Amount?r.billingAmount=parseFloat(e.Amount).toFixed(2):r.billingAmount="0.00";switch(_.toInt(e.Period)){case m:r.length=h;break;case g:r.length=d;break;case y:r.length=c}if(e.TSEnded&&e.TSEnded!=="0"){var s=new Date;s.setTime(_.toInt(e.TSEnded)*1e3),r.unsubscriptionDate=s}if(e.finalEndDate&&e.finalEndDate!=="0"&&!r.recurring){var o=new Date;o.setTime(_.toInt(e.finalEndDate)*1e3),r.endDate=o}else if(e.TSPeriodEnd&&e.TSPeriodEnd!=="0"&&!r.recurring){var u=new Date;u.setTime(_.toInt(e.TSPeriodEnd)*1e3),r.endDate=u}else if(r.unsubscriptionDate)r.endDate=r.unsubscriptionDate;else if(e.TSStart&&r.length){var p=new Date;p.setTime(parseInt(e.TSStart,10)*1e3),r.length===h?p.setMonth(p.getMonth()+1):r.length===d?p.setYear(p.getYear()+1):r.length===c&&p.setYear(p.getWeek()+1),r.endDate=p}if(e.TSPeriodStart&&e.TSPeriodStart!=="0"&&r.recurring){var w=new Date;w.setTime(parseInt(e.TSPeriodEnd,10)*1e3),r.nextBillDate=w}if(e.recurBillDate){var E=new Date;E.setTime(parseInt(e.recurBillDate,10)*1e3),r.recurBillDate=E}r.recurBillAmount=e.recurBillAmount?parseFloat(e.recurBillAmount).toFixed(2):0,r.recurBillPeriod=e.recurBillPeriod||0,t&&(t.get("Flags")&n.Models.User.FLAG_ANYWHERE)>0?r.type=l:t&&(t.get("Flags")&n.Models.User.FLAG_PLUS)>0&&r.type!==l?r.type=f:t&&(t.get("Flags")&n.Models.User.FLAG_LITE)>0&&r.type!==l&&r.type!==f?r.type=a:r.type=_.toInt(e.SubType),t&&r.type===l?t.set("Flags",t.get("Flags")|n.Models.User.FLAG_ANYWHERE):t&&r.type===f?t.set("Flags",t.get("Flags")|n.Models.User.FLAG_PLUS):t.set("Flags",t.get("Flags")|n.Models.User.FLAG_LITE),e.api==="paypal"&&(r.PaypalProfileID=e.ProfileID)}return r}function S(e){switch(e){case a:return i.canListen|i.email;case f:return i.canListen|i.noAds|i.playerBonuses|i.desktop|i.email;case l:return i.canListen|i.noAds|i.mobile|i.playerBonuses|i.desktop|i.email}return 0}function x(e){return e.type=_.orEqual(e.type,0),e.length=_.orEqual(e.length,0),e.billingAmount=_.orEqual(e.billingAmount,0),e.recurring=_.orEqual(e.recurring,!1),e.features=S(e.type),e.endDate=_.orEqual(e.endDate,null),e.nextBillDate=_.orEqual(e.nextBillDate,null),e.unsubscriptionDate=_.orEqual(e.unsubscriptionDate,null),e.paymentMethod=_.orEqual(e.paymentMethod,null),e.vip=_.orEqual(e.vip,!1),e.isLoaded=e.isLoaded?!0:!1,e}n.Models=n.Models||{};var t=e.nodeWebkit,r=0,i={canListen:1,noAds:2,mobile:4,playerBonuses:8,desktop:16,email:32},s={plus:{month:6,year:60},anywhere:{month:9,year:90},lite:{month:2,year:20},liteEx:{month:4,year:40},codes:{"1month":9,"3month":27,"6month":54,"12month":90}},o,u=-1;setTimeout(function(){n.ready.done(function(){$.now()-e.clientTimeDivergence<13911372e5&&(s.anywhere={month:5,year:50},s.codes={"1month":5,"3month":15,"6month":25,"12month":50})})},10);var a=21,f=6,l=8,c=2,h=3,p=7,d=9,v=11,m=0,g=1,y=2;n.Models.Subscription=Backbone.Model.extend({idAttribute:"SubscriptionID",parse:function(e,t){var n=t&&t.clone===!1?e:_.clone(e);n.apiVersion=_.orEqual(n.apiVersion,1);if(n.hasOwnProperty("details")&&n.hasOwnProperty("user"))n.apiVersion===2?$.extend(n,E(n.details,n.user)):$.extend(n,w(n.details,n.user));else if(n.SubscriptionTypeID>0){var r=b(n.SubscriptionTypeID);n=$.extend({},r,n)}return n.user&&n.user.id!==u&&(o=null,u=n.user.id),n.hasSpecialPricing=_.orEqual(n.hasSpecialPricing,!1),delete n.details,delete n.user,n=x($.extend(n,!0)),n},initialize:function(){typeof Object.defineProperty=="function"&&this.freeze(),this.on("freeAdExpiresUpdate",function(e){e>r&&e>$.now()-(144e5+1)&&(r=e,this.trigger("adUpdate"))},this)},get:function(e){switch(e){case"altPricing":return o}return this.attributes[e]},isActive:function(){var t=Date.now()+e.clientTimeDivergence;return this.get("endDate")&&this.get("endDate")<t?!1:!0},getTypeName:function(){switch(this.get("type")){case a:return"Grooveshark";case f:return $.localize.getString("GROOVESHARK_PLUS");case l:return $.localize.getString("GROOVESHARK_ANYWHERE")}return""},getTypeString:function(){switch(this.get("type")){case a:return"lite";case f:return"plus";case l:return"anywhere"}return""},getPrices:function(){var e;if(this.hasRecurring()){var t={},n,r;this.get("apiVersion")==2?(n=_.toInt(this.get("recurBillAmount")),n&&this.get("recurBillPeriod")==m?r=n:n&&(r=n/10)):this.isAnywhere()&&(n=_.toInt(this.get("billingAmount")),this.get("length")==h?r=n:n&&(r=n/10)),r&&(t.anywhere={month:r,year:r*10}),e=$.extend(!0,{},s,t)}else this.get("hasSpecialPricing")&&this.get("altPricing")?e=this.get("altPricing"):e=$.extend(!0,{},s);return e},loadSpecialPricing:function(){var e=$.Deferred();if(this.get("hasSpecialPricing")&&this.get("altPricing"))e.resolve(this.get("altPricing"));else if(this.get("hasSpecialPricing")){var t=gsConfig.forceHTTPS?"getUserSpecialPricingEx":"getUserSpecialPricing";n.Services.API[t]().done(_.bind(function(t){o=$.extend(!0,{},s),t&&t.Price&&(o.anywhere.month=parseFloat(t.Price)||0,o.anywhere.year=parseFloat(t.YearPrice)||0),e.resolve($(!0,{},o))},this)).fail(function(){e.reject()})}else e.resolve(s);return e.promise()},hasSubscription:function(){return this.get("type")>0},hasRecurring:function(){return this.get("recurring")||this.get("recurBillAmount")},isPremium:function(){return this.get("type")!==a&&this.get("type")!==0},isPlus:function(){return this.get("type")===f},isAnywhere:function(){return this.get("type")===l},isLite:function(){return this.get("type")===a},isSpecial:function(){return this.get("length")===v},canHideAds:function(){if((gsConfig.inOffice||_.cookie("g53Mpl0y33"))&&gsConfig.runMode=="production"){var e=["5be3","d798","1e133b","3c8c8c","1e","f27","c09b9","2a","f","8694c1","6e5","1529a6","14b1c06","356bc","17a681d"];if(_.indexOf(e,parseInt(n.getLoggedInUserID()).toString(16))<0)return _.cookie("g53Mpl0y33",!0),!1}return t||(this.get("features")&i.noAds)>0||r>$.now()},canUsePlayerBonuses:function(){return this.isAnywhere()||this.isPlus()},canListenUninterrupted:function(){return(this.get("features")&i.canListen)>0||r>$.now()},canDirectEmail:function(){return(this.get("features")&i.email)>0},canUseDesktop:function(){return(this.get("features")&i.desktop)>0},getNextBillDate:function(){return this.get("nextBillDate")>0?this.get("nextBillDate").format("F j, Y"):this.get("recurBillDate")>0?this.get("recurBillDate").format("F j, Y"):null},getEndDate:function(){return this.get("endDate")>0?this.get("endDate").format("F j, Y"):null},canExtend:function(){return this.get("length")!==v&&!this.hasRecurring()},canUpgradeToLite:function(){return!(this.isLite()||this.isSpecial()||this.isPlus()||this.isAnywhere())},canUpgradeToPlus:function(){return!this.isPlus()&&!this.isSpecial()},canUpgradeToAnywhere:function(){return!this.isAnywhere()&&!this.isSpecial()},premiumRequired:function(){return this.isPremium()?!1:!this.canUseDesktop()&&(n.External.AIRBridge.isDesktop||n.External.DesktopBridge.active)||gsConfig.isPreview&&e.location.host==="preview.grooveshark.com"}},{PLAN_TYPES:{ANYWHERE:8,PLUS:6,LITE:21},PLAN_PERIODS:{MONTH:m,YEAR:g,WEEK:y},get:function(e){var t=$.Deferred(),r=e.get("Flags")&n.Models.User.FLAG_HAS_SPECIAL_PRICE;if(e.get("Flags")&n.Models.User.FLAG_HAS_NEW_SUB)n.Services.API.nautilusFetchSubscriptionStatusEx().done(function(i){var s=new n.Models.Subscription({details:i,user:e,apiVersion:2,hasSpecialPricing:r});s.loadSpecialPricing().done(function(){t.resolve(s)})}).fail(function(e){t.reject(e)});else if(e.get("isLoggedIn"))n.Services.API.getSubscriptionDetails().done(function(i){var s=new n.Models.Subscription({details:i,user:e,hasSpecialPricing:r});s.loadSpecialPricing().done(function(){t.resolve(s)})}).fail(function(e){t.reject(e)});else{var i=new n.Models.Subscription({isLoaded:!0,user:this});t.resolve(i)}return t}})}(),function(){n.Models=n.Models||{};var e=/\u0000/g,t=n.Models.PlayContext=function(r,i){r=_.orEqual(r,{}),this.type=r instanceof Backbone.Model?_.getItemType(r):"unknown",_.isFunction(r.getDetailsForFeeds)?this.data=r.getDetailsForFeeds():_.isFunction(r.getDetailsForSwf)?this.data=r.getDetailsForSwf():_.isFunction(r.toJSON)?this.data=r.toJSON():this.data=r,this.type==="unknown"&&this.data.hasOwnProperty("contextType")&&(this.type=this.data.contextType,delete this.data.contextType),this.type==="album"&&r.get("CoverArtFilename")&&(this.data.CoverArtFilename=r.get("CoverArtFilename")),this.type==="playlist"&&(this.addStreamType(t.TYPE_PLAYLIST),r.get("UserID")!=n.getLoggedInUserID()&&this.addStreamType(t.TYPE_OTHER_PLAYLIST)),this.type==="popular"&&this.addStreamType(t.TYPE_POPULAR),this.type==="user"&&r.get("UserID")==n.getLoggedInUserID()&&this.addStreamType(t.TYPE_LIBRARY),this.type==="artist"&&this.addStreamType(t.TYPE_DEFAULT),this.type==="broadcast"&&(i&&i.archivedBroadcast&&(this.data.archivedBroadcast=!0),this.addStreamType(t.TYPE_BROADCAST));for(var s in this.data)this.data.hasOwnProperty(s)&&typeof this.data[s]=="string"&&(this.data[s]=this.data[s].replace(e,""))};t.prototype.addStreamType=function(e){e=_.toInt(e),_.defined(this.streamType)||(this.streamType=0),this.streamType=this.streamType|e},t.prototype.addDefaultType=function(){this.addStreamType(t.TYPE_DEFAULT)},t.prototype.clone=function(){var e=new n.Models.PlayContext;return $.extend(!0,e,this),e},t.TYPE_DEFAULT=0,t.TYPE_STATION=1,t.TYPE_RADIO=2,t.TYPE_DMCA_RADIO=4,t.TYPE_VIP=8,t.TYPE_PLAYLIST=16,t.TYPE_LIBRARY=32,t.TYPE_POPULAR=64,t.TYPE_HOME_RADIO_SEEDS=128,t.TYPE_USER_STATION=256,t.TYPE_BROADCAST=512,t.TYPE_RECOMMENDED=1024,t.TYPE_SHARE=2048,t.TYPE_ACTIVITY=4096,t.TYPE_PLAY_ALL=8192,t.TYPE_OTHER_PLAYLIST=16384}(),function(){n.Models=n.Models||{};var t=n.Models.Theme=Backbone.Model.extend({idAttribute:"themeID",slideShowIntervalID:null,notifOptions:null,initialize:function(){},bindAssets:function(e,t,r){tracking=this.get(t)?this.get(t):this.set(t,r).get(t);var i=$(e).find("a[data-click-id], div[data-click-id]"),s,o,u,a,f,l=0,c;return _.each(i,_.bind(function(t,r){t=$(t);var i=tracking[t.attr("data-click-id")];switch(t.attr("data-click-action")){case"song":t.attr("data-song-id",i);break;case"album":t.attr("data-album-id",i);break;case"playlist":t.attr("data-playlist-id",i);break;case"station":t.attr("data-station-id",i);break;case"videos":break;case"lightbox":break;case"expand":break;case"link":default:if(i){var h=(new Date).getTime();i=i.replace("%c","").replace("%n",h),i=i.replace("%%CLICK_URL_UNESC%%","").replace("%%CACHEBUSTER%%",h),t.attr("href",i),t.attr("target")||t.attr("target","_blank")}}t.hasClass("flash")?(s=_.orEqual(t.attr("data-flash-wmode"),"opaque"),o=_.orEqual(t.attr("data-flash-width"),"100%"),u=_.orEqual(t.attr("data-flash-height"),"100%"),a=_.orEqual(t.attr("data-flash-src"),null),flashParams=_.orEqual(t.attr("data-flash-params"),""),flashVisualizer=_.orEqual(t.attr("data-flash-visualizer"),null),a&&t.attr("id")&&(c=flashVisualizer?"visualizerTheme":e+"-flash-"+l++,t.append('<div id="'+c+'"></div>'),f=swfobject.embedSWF("/themes/"+this.get("location")+"/assets/"+a+"?ver="+this.get("version")+"&themeID="+this.get("themeID")+"&currentTarget=%23"+t.attr("id")+flashParams,c,o,u,"9.0.0",null,null,{wmode:s,allowScriptAccess:"always"},null,_.bind(function(e){this.trigger("theme:swf:event",e)},this)))):(t.off("click",n.Models.Theme.handleClick),t.click({currentTheme:this},n.Models.Theme.handleClick))},this)),this},bindVideos:function(e){return this.get("videos")||this.set("videos",e),this},bindLocale:function(e){return _.each($(".theme-component").find(".locale"),function(t,n){t=$(t);var r=t.attr("class").split(" ");t.removeClass(),_.each(r,function(e,n){e.indexOf("locale-")==-1&&t.addClass(e)}),t.addClass("locale-"+e.lang)}),this},bindPageType:function(e){return _.each($(".theme-component").find(".page"),function(t,n){t=$(t);var r=t.attr("class").split(" ");t.removeClass(),_.each(r,function(e,n){e.indexOf("page-")==-1&&t.addClass(e)}),t.addClass("page-"+e.type)}),_.each($(".theme-component.page"),function(t,n){t=$(t);var r=t.attr("class").split(" ");t.removeClass(),_.each(r,function(e,n){e.indexOf("page-")==-1&&t.addClass(e)}),t.addClass("page-"+e.type)}),this},bindClickPixelTrackers:function(e){return e&&this.set("clickPixelTrackers",e),this},bindNotif:function(e){return n.Models.Theme.notification?this:(n.Models.Theme.notification={title:e.title,description:e.description,url:e.url,target:e.target||"_blank",duration:e.duration||0,type:"theme",image:"../../themes/"+this.get("location")+"/assets/"+"notif.png",options:e.options,click:function(e){e.model.get("options").actions&&_.each(e.model.get("options").actions,function(t,r){var i=_.toInt(t.actionID);switch(t.action){case"song":n.Models.Song.get(i).done(function(e){var t=new n.Models.PlayContext({contextType:"theme"});t.addStreamType(n.Models.PlayContext.TYPE_DEFAULT),n.trigger("player:addSongs",[e],null,!0,t)});break;case"album":n.Models.Album.get(i).done(_.bind(function(e){e&&e.getSongs().done(function(e){var t=new n.Models.PlayContext({contextType:"theme"});t.addStreamType(n.Models.PlayContext.TYPE_DEFAULT),n.trigger("player:addSongs",e.models,null,!0,t)})},this));break;case"playlist":n.Models.Playlist.get(i).done(_.bind(function(e){e&&e.getSongs().done(function(e){var t=new n.Models.PlayContext({contextType:"theme"});t.addStreamType(n.Models.PlayContext.TYPE_DEFAULT),n.trigger("player:addSongs",e.models,null,!0,t)})},this));break;case"station":n.trigger("player:radio",!0,i);break;case"tracking":n.Models.Ad.loadTracking(n.Models.Theme.cleanTracking(t.tracking));break;case"track-click":}e.model.get("options").themeID&&t.clickID&&n.Services.API.logThemeOutboundLinkClick(e.model.get("options").themeID,t.clickID)})}},n.Models.Theme.notification.options.themeID=this.get("themeID"),$.extend(n.Models.Theme.notification.options,this.get("notif")),e.force&&(n.trigger("notification:add",n.Models.Theme.notification),this.get("view").lastThemeNotification=(new Date).getTime(),n.Models.Theme.notification=null),this)},onHandleOpenNotif:function(e){e.model.get("type")&&e.model.get("type")=="theme"&&this.get("notif")&&n.Models.Ad.loadTracking(this.get("notif").tracking)},initSlideShow:function(e){setTimeout(_.bind(function(){$(".theme-slide").css("visibility","visible"),this.slideShowIntervalID=setInterval(function(){var e=$("#theme-slideshow .theme-slide.active");e.length===0&&(e=$("#theme-slideshow .theme-slide:last"));var t=e.next().length?e.next():$("#theme-slideshow .theme-slide:first");e.addClass("last-active"),t.css({opacity:0}).addClass("active").animate({opacity:1},1e3,function(){e.removeClass("active last-active")})},e)},this),300)},transform:function(e){_.each(e,function(e,t){if(!e.type||!e.target){console.log("Theme tranform type or target name not found");return}var n=$("#"+e.target),r=e.fade?e.fade:0;if(!n.length){console.log("Theme tranform target not found");return}switch(e.type){case"color":if(!e.hex){console.log("Theme tranform hex not found");return}n.stop().animate({backgroundColor:e.hex},r);break;case"image":if(!e.transformClass){console.log("Theme tranform class not found");return}if(r)n.stop().animate({opacity:0},r,function(){if(n.attr("class")){var t=n.attr("class").split(" ");n.removeClass(),_.each(t,function(e,t){e.indexOf("transform-")==-1&&n.addClass(e)})}$(this).addClass(e.transformClass),$("#"+e.target).stop().animate({opacity:1},r)});else{if(n.attr("class")){var i=n.attr("class").split(" ");n.removeClass(),_.each(i,function(e,t){e.indexOf("transform-")==-1&&n.addClass(e)})}n.addClass(e.transformClass)}}})},bindTwitter:function(e){var t=e.lang?e.lang:gsConfig.lang,r,i,s=e.action?e.action:"follow",o=e.message?e.message:"",u=e.hashtags?e.hashtags:"",a="https://twitter.com/",f=$("#"+e.target);return s=="tweet"?(r=e.command?e.command:"Tweet",i=e.showCount===!0?e.showCount:"none",f.html("").append($('<a class="twitter-share-button" data-count="'+i+'" data-show-screen-name="false"></a>').attr("href",a+"share").attr("data-lang",t).attr("data-text",o).attr("data-hashtags",u).text(r))):s=="follow"&&(r=e.command?e.command:"Follow",i=e.showCount===!0?e.showCount:!1,f.html("").append($('<a class="twitter-follow-button" data-show-count="'+i+'" data-show-screen-name="false"></a>').attr("href",e.url).attr("data-lang",t).text(r+e.name))),n.Services.Twitter.parseWidgets(),this},bindFacebook:function(t){var r=t.lang?t.lang:e.navigator.language?navigator.language.replace("-","_"):e.navigator.userLanguage.replace("-","_"),i=t.width?t.width:"90",s=t.height?t.height:"21",o=$("#"+t.target);return t.iframe?o.html("").append($('<iframe src="//www.facebook.com/plugins/like.php?href='+t.url+"&amp;locale="+r+"&amp;send=false&amp;layout=button_count&amp;width="+i+"&amp;show_faces=false&amp;action=like&amp;colorscheme=light&amp;font&amp;height="+s+'" scrolling="no" frameborder="0" style="positioning:static; border:none; overflow:hidden; 0px; width:'+i+'px; height:21px;" allowTransparency="true"></iframe>')):o.html("").append($('<fb:like href="'+t.url+'" send="false" layout="button_count" style="width:'+i+'px" show_faces="false"></fb:like>')),n.Services.Facebook.parseWidgets(),this},bindPreload:function(e,t){t=t||function(){};for(var n=0;n<e.length;n++)$("<img/>").attr("src",gsConfig.assetHost+"/themes/"+this.get("location")+"/assets/"+e[n]).load(t);return this},bindDynamicHeight:function(){function n(){e.is(":visible")&&e.height(t.height()).height(t[0].scrollHeight)}var e=$("#theme-wall"),t=$("#page-wrapper");return t.on("scroll",n),n(),this.on("theme:destroy",function(){t.off("scroll",n)}),this},bindPromo:function(e){this.set("promo",e)},bindForm:function(e,t){return e=$(e),_.each(e.find("[data-formtype]"),function(e,r){e=$(e);switch(e.data("formtype")){case"select":if(e.is("select"))break;var i=t?t[e.data("datasource")]||n.Models.Theme[e.data("datasource")]:[],s=$("<select></select>");_.each(i,function(e,t){s.append($('<option value="'+e+'">'+e+"</option>"))}),e.append(s)}}),e.find('[data-formtype="submit"]').on("click",function(){function s(e){e.addClass("invalid"),r++}var n=$(this).data("validationgroup"),r=0,i={};_.each(e.find('[data-validationgroup="'+n+'"]'),_.bind(function(e,t){var n;if(e!=this){e=$(e),e.removeClass("invalid");switch(e.data("formtype")){case"select":e.find("select").removeClass("invalid"),e.data("required")&&!e.find("select")[0].selectedIndex&&s(e.find("select"));if(e.data("validvalues")){var r=e.data("validvalues").split(",");_.indexOf(r,e.find("select")[0].value)<0&&s(e.find("select"))}if(e.data("invalidvalues")){var o=e.data("invalidvalues").split(",");_.indexOf(o,e.find("select")[0].value)>=0&&s(e.find("select"))}break;case"input":if(e.data("required")&&(!e.val().length||e.val()==e.attr("placeholder"))){s(e);break}var u=e.is("input")?e:e.find("input");switch(e.data("validtype")){case"email":if(e.val().length&&e.val()!=e.attr("placeholder")){n=u.val().match(_.emailRegex),(!n||!n.length)&&s(e);var a=u.val().split("@");a.length&&a[0].length<=2&&s(e)}break;case"zip":n=u.val().match(/^\d{5}(-\d{4})?$/),(!n||!n.length)&&s(e);break;case"phone":e.data("required")&&(!e.val().length||e.val()==e.attr("placeholder"))?s(e):e.val().length&&(n=u.val().match(/^\(?([0-9]{3})\)?[-. ]?([0-9]{3})[-. ]?([0-9]{4})$/),(!n||!n.length)&&s(e));break;case"date":try{(new Date(u.val())).toString().toLowerCase().indexOf("invalid")>=0&&s(e),e.data("validregex")&&(n=u.val().match(new RegExp(e.data("validregex"))),(!n||!n.length)&&s(e))}catch(f){s(e)}if(e.data("validminimum")){var l=new Date(u.val()),c=new Date,h=c.getFullYear()-l.getFullYear();l.getMonth()>c.getMonth()?h-=1:l.getMonth()==c.getMonth()&&l.getDate()>c.getDate()&&(h-=1),h<_.toInt(e.data("validminimum"))&&s(e)}break;case"terms":u.attr("checked")||(s(e),s(e.parent()))}}if(e.data("validmessage")&&(e.hasClass("invalid")||e.children().hasClass("invalid"))){var p=_.toInt(e.data("validweight"))||10;if(!i.weight||p<=i.weight)i.weight=p,i.message=e.data("validmessage")}}},this)),r?_.isFunction(t.onInvalid)&&t.onInvalid(i.message):_.isFunction(t.onSubmit)&&t.onSubmit()}),this}},{THEME_FLAG_DEFAULT:0,THEME_FLAG_FAMILY_FRIENDLY:1,themePages:["home","search","popular","tags","community","broadcasts","promotion"],themeSubPages:[],lastThemeID:null,notification:null,lastTakeoverID:null,userThemeFlags:0,definitionsUpdated:0,themeVersion:0,artist:[],themes:{814:{themeID:814,title:"Fusion",author:"Grooveshark",location:"fusion",premium:!1,sections:["#theme-header"],version:1.001}},userThemeFlagDefinitions:{positionLeft:1,positionCenter:2,positionRight:4,tiled:8,transparent:16,cover:32,ignoreImage:64},userThemeProps:{url:null,position:null,tiled:!1,transparent:!1,cover:!1,Color1:null},convertUserThemePropsForSave:function(e){var t=0,r={},i=n.Models.Theme.userThemeFlagDefinitions;e.tiled&&(t|=i.tiled),e.transparent&&(t|=i.transparent),e.cover&&(t|=i.cover);switch(e.position){case"left":t|=i.positionLeft;break;case"center":t|=i.positionCenter;break;case"right":t|=i.positionRight}return e.ignoreImage&&(t|=i.ignoreImage),t&&(r.Flags=t),e.Color1&&(r.Color1=e.Color1.charAt(0)=="#"?e.Color1.slice(1,e.Color1.length):e.Color1),e.ThemeID&&(r.ThemeID=e.ThemeID),r},convertUserThemePropsForStyles:function(e){var t={},r=n.Models.Theme.userThemeFlagDefinitions;return e.Flags&r.tiled&&(t.tiled=!0),e.Flags&r.transparent&&(t.transparent=!0),e.Flags&r.cover&&(t.cover=!0),e.Flags&r.positionLeft?t.position="left":e.Flags&r.positionCenter?t.position="center":e.Flags&r.positionRight&&(t.position="right"),e.Flags&r.ignoreImage&&(t.ignoreImage=!0),e.Image&&(t.Image=e.Image),e.Color1&&(t.Color1=e.Color1.charAt(0)!="#"?"#"+e.Color1:e.Color1),t},getThemeDefinitions:function(){function s(){t.reject()}if(this.themeDfd)return this.themeDfd.promise();var t=this.themeDfd=$.Deferred(),n=document.getElementsByTagName("script")[0],r=n.parentNode,i=document.createElement("script");return i.type="text/javascript",i.async=!0,e.gsProduction&&e.gsProduction.THEMES?i.src=gsConfig.assetHost+e.gsProduction.THEMES.assetPath:i.src=gsConfig.assetHost+"/themes/themes.js?_="+Date.now(),i.id="themeJS",i.onerror=s,i.onreadystatechange=function(){if(this.readyState!=="complete"&&this.readyState!=="loaded")return;this.status==404&&s()},r.appendChild(i),t.promise()},themePageCheck:function(e,t){return _.indexOf(this.themePages,e)>=0||t&&t.section=="broadcast"},themeSubPageCheck:function(e,t){return _.indexOf(this.themeSubPages,e)>=0},get:function(e){var t=Backbone.CachedModel.genericGet.call(this,n.Services.API.getThemeFromDFP,"themeID",e.params);return t.promise()},cleanTracking:function(e){return _.each(e,function(t,n){e[n]=e[n].replace("%c","").replace("%n",(new Date).getTime())}),e},handleClick:function(t){var r=$(t.currentTarget),i=t.data?t.data.currentTheme:null,s;switch(r.attr("data-click-action")){case"link":r.hasClass("flash")&&e.open(s,"_newtab");break;case"song":s=_.toInt(r.attr("data-song-id")),n.Models.Song.get(s).done(function(e){var t=new n.Models.PlayContext({contextType:"theme"});t.addStreamType(n.Models.PlayContext.TYPE_DEFAULT),n.trigger("player:addSongs",[e],null,!0,t)});break;case"album":s=r.attr("data-album-id"),n.Models.Album.get(s).done(function(e){e&&e.getSongs().done(function(e){var t=new n.Models.PlayContext({contextType:"theme"});t.addStreamType(n.Models.PlayContext.TYPE_DEFAULT),n.trigger("player:addSongs",e.models,null,!0,t)})});break;case"playlist":s=r.attr("data-playlist-id"),n.Models.Playlist.get(s).done(function(e){e&&e.getSongs().done(function(e){var t=new n.Models.PlayContext({contextType:"theme"});t.addStreamType(n.Models.PlayContext.TYPE_DEFAULT),n.trigger("player:addSongs",e.models,null,!0,t)})});break;case"station":s=r.attr("data-station-id"),n.trigger("player:radio",!0,s);break;case"videos":if(i&&i.get("videos")){var o=_.orEqual(r.attr("data-video-index"),0);n.trigger("lightbox:open","video",{videos:i.get("videos"),index:o})}break;case"lightbox":s=r.attr("data-lightbox-name"),s&&n.trigger("lightbox:open",s);break;case"expand":var u=$("#theme-expand-inner"),a=_.toInt(r.attr("data-expand-height"));u.height()>0?u.animate({height:0},200):u.animate({height:a},200)}i&&r.attr("data-track-id")&&i.get("clickPixelTrackers")&&n.Models.Ad.loadTracking(i.get("clickPixelTrackers")[r.attr("data-track-id")]),(r.attr("data-theme-id")||i&&i.get("themeID"))&&n.Services.API.logThemeOutboundLinkClick(r.attr("data-theme-id")||i.get("themeID"),r.attr("data-click-id"))},getImageAverageColor:function(e,t,n){function h(e){function t(e){var t=e.toString(16);return t.length==1?"0"+t:t}a=e.data.length;while((u+=r*4)<a)++l,f.r+=e.data[u],f.g+=e.data[u+1],f.b+=e.data[u+2];return f.r=~~(f.r/l),f.g=~~(f.g/l),f.b=~~(f.b/l),t(f.r)+t(f.g)+t(f.b)}function p(e,t){return $.xcolor.average(e,t).getColor();var n,r,i,s,o,u,a,f,l,c,h,p}var r=5,i="#000000",s=document.createElement("canvas"),o=s.getContext&&s.getContext("2d"),u=-4,a,f={r:0,g:0,b:0},l=0;if(!$.xcolor)return i;try{if(!o)throw new Error;o.getImageData(0,0,t,n)}catch(c){return i}return s.height=n,s.width=t,o.drawImage(e,0,0),p(h(o.getImageData(0,0,1,n)),h(o.getImageData(0,0,t,n,t-1,0)))}})}(),function(){function u(e,t,n,r){if(!r||!r.length){e.resolve([]);return}t||(t={});var i=[],s;for(s=0;s<r.length;s++)_.isFunction(t.onCredit)&&r[s].onCredit(t.onCredit),_.isFunction(t.onStart)&&r[s].onStart(t.onStart),_.isFunction(t.onFinish)&&r[s].onFinish(t.onFinish),r[s].loadIntoContainer=_.bind(n.loadActivityIntoContainer,n,r[s]),i.push(r[s]);e.resolve(i)}n.Models=n.Models||{};var i,s={partner_config_hash:"6c5673a47e1ef5525c824f330ffa029f4dd70a49"},o,a=n.Models.Ad=Backbone.Model.extend({idAttribute:"AdID",reportCount:0,firstReport:0,userActivity:null,preventRotation:!1,initialize:function(e){this.options=e||{},this.width=this.options.width,this.height=this.options.height,this.dimensions=this.width+"x"+this.height,this.$placeholder=$("#capital-"+this.dimensions+"-placeholder"),this.currentPage=this.options.currentPage,this.isThemeCapital=this.options.isThemeCapital,this.isHome=this.options.isHome,this.preventRotation=this.options.preventRotation,this.footerHeight=this.width==160?40:20,this.user=this.options.user,this.currentTheme=this.options.currentTheme,this.create(),$("#page-wrapper").on("scroll."+this.cid,_.bind(this.reposition,this))},create:function(){var e=this.$placeholder.offset(),t=$("#page"),n=t.offset();if(!e||!n)return;var r={top:e.top-n.top,left:e.left-n.left},i=this.width==160,s=this.$placeholder.attr("data-capital-id"),o=$("<div>").addClass("capital-footer"+(i?" vertical":"")).css({bottom:0,height:this.footerHeight}),u=$("<a>").addClass("capital-ad-report").data({capitalId:s,translateText:"REPORT_AD"}).text(_.getString("REPORT_AD")),a=$("<a>").addClass("capital-ad-upgrade").data({capitalId:s,translateText:"REMOVE_AD"}).text(_.getString("REMOVE_AD")).attr("href","/#!/settings/subscription");this.$capital=$("<div>").attr({id:s,"class":"decoupledCapital"+(this.isThemeCapital?" theme-capital":"")}).data({userActivity:null}).css({top:r.top,left:r.left,position:"absolute",width:this.width,height:this.height+this.footerHeight,overflow:"hidden",zIndex:350}).on("mouseover."+this.cid,_.bind(function(e){this.userActivity=$.now()+9e4},this)).on("mouseout."+this.cid,_.bind(function(e){this.userActivity=null},this)),!this.firstReport&&$.now()-this.firstReport>9e5&&(this.firstReport=0,this.reportCount=0),this.reportCount<3&&o.append(u),o.append(a),this.$capital.append(o),t.append(this.$capital),this.update()},update:function(){this.refresh();if(!this.$placeholder.length)return;if(this.userActivity&&this.userActivity>$.now())return;if(this.preventRotation&&this.$capital.find("iframe").length)return;this.source=this.getSource(),this.unit=this.getUnit(),this.adParams=["p="+this.unit,"w="+this.width,"h="+this.height],this.params=this.getParams();var e=this.$capital.children("iframe.gs-capital"),t=$("<iframe>").attr({width:this.width,height:this.height,"class":"gs-capital",scrolling:"no",frameborder:0,allowTransparency:!0}).css({overflow:"hidden",position:"absolute",top:0,visibility:e.length?"hidden":"visible"});return t.on("load."+this.cid,_.bind(function(){e.off("load."+this.cid).remove(),t.width(0),t.width(this.width).css("visibility","visible"),r.lightbox.isOpen&&this.$capital.hide(),this.refresh(),n.trigger("page:redrawUpdate"),n.trigger("ad:resetRotation")},this)),t.data("adInfo",{unitName:this.unit+"_"+this.dimensions,itemID:"unknown",extra:""}),t.attr("src",this.source+this.params),this.$capital.append(t),!this.firstReport&&$.now()-this.firstReport>9e5&&(this.firstReport=0,this.reportCount=0,this.$capital.find(".capital-ad-report").removeClass("hide")),this.reportCount>=3&&this.$capital.find(".capital-ad-report").addClass("hide"),!0},refresh:function(){this.$placeholder=$("#capital-"+this.dimensions+"-placeholder"),this.$placeholder.length&&(this.$capital.show(),this.$placeholder.width(this.width).height(this.height+this.footerHeight),this.reposition())},reposition:function(){if(!this.$placeholder.length)return;!this.isHome&&!this.isThemeCapital?this.sticky():this.$capital.css({position:"absolute"}).offset(this.$placeholder.offset())},hide:function(){if(this.isThemeCapital)return;this.$capital.hide()},remove:function(){$("#page-wrapper").off("scroll."+this.cid),this.$placeholder.height(0),delete this.$placeholder,delete this.user,delete this.currentPage,this.$capital.remove()},sticky:function(){this.$placeholder=$("#capital-"+this.dimensions+"-placeholder");var e=$("#column1"),t=$("#column2"),n=$("#footer"),r=$("#top-hat-notif").outerHeight()||0,i=this.$placeholder.offset(),s=this.$capital.offset(),o,u,a;if(!this.$placeholder.length||!this.$capital.length||!e.length||!t.length||!n.length||!i||!s)return;if(t.outerHeight(!0)>this.$capital.outerHeight(!0)+30)if(i.top+this.$placeholder.outerHeight(!0)<0){if(e.height()-t.outerHeight(!0)>this.$capital.outerHeight(!0)){if(!$("#"+this.$placeholder.attr("id")+"-fold").length){var f=$('<div id="'+this.$placeholder.attr("id")+'-fold"></div>').height(this.$placeholder.height());t.append(f)}else $("#"+this.$placeholder.attr("id")+"-fold").height(this.$placeholder.height());foldOffset=$("#"+this.$placeholder.attr("id")+"-fold").offset();if(!foldOffset)return;u=foldOffset.top,a=foldOffset.left;if(s.top<=60+r&&u&&u<=60+r){var l=this.$capital.outerHeight(!0)+40+r,c=n.offset().top,h=c<l?(l-c)*-1:60+r;this.$capital.css({position:"fixed",left:i.left,top:h})}else u&&a&&this.$capital.css("position","absolute").offset({left:a,top:u})}}else $("#"+this.$placeholder.attr("id")+"-fold").height(0),this.$capital.css("position","absolute").offset(i);else if(s.top<=60+r&&i.top<=60+r){if(i.left){var l=this.$capital.outerHeight(!0)+40+r,c=n.offset().top,h=c<l?(l-c)*-1:60+r;this.$capital.css({position:"fixed",left:i.left,top:h})}}else this.$capital.css({position:"absolute"}).offset(i)},getUnit:function(){return this.currentPage.type=="home"?"jawharp_hp":n.Models.Theme.themePageCheck(this.currentPage.type)?"jawharp_tl":"jawharp_ros"},getSource:function(){var e=this.options.source||(gsConfig.runMode!="production"?gsConfig.assetHost:"http://ads-grooveshark.com")+"/dfpAds.html";if(this.isHome&&this.currentPage.type=="home"){var t=this.currentTheme||r.model.get("theme");t&&t.get("capital")&&t.get("capital")!="default"&&(e="themes/"+t.get("location")+"/"+t.get("capital").source)}return e},getParams:function(){return n.Models.Ad.getParams(this.adParams,null,null,this)}},{useTestAds:!1,useTestAdsValue:null,RANDOM_PERCENT:Math.floor(Math.random()*10)+1,locales:{en:"1",bg:"2",ca:"3",cs:"4",da:"5",de:"6",es:"7",eu:"8",fi:"9",fr:"10",it:"11",ja:"12",lt:"13",nb:"14",nl:"15",pl:"16",pt:"17",ro:"18",ru:"19",sk:"20",sl:"21",sv:"22",tr:"23",zh:"24"},personalizedTags:null,adRotationCount:0,loadTracking:function(e,t){if(_.isArray(e)){var n=(new Date).getTime(),r;_.forEach(e,function(e){e&&(e=e.replace("%n",n),e.indexOf("pointroll")==-1&&(e.indexOf("?")!=-1?e+="&"+n:e+="?"+n),r=new Image,$("body").append($(r).load(function(e){$(e.target).remove()}).css("visibility","hidden").attr("src",e)))})}},loadCustomTracking:function(e,t){switch(e){case"iframe":var n=$("<iframe>");$("body").append(n.css({width:1,height:1,visibility:"hidden"}).attr("src",t)),setTimeout(function(){n.remove()},1e4)}},getParams:function(t,i,s,o){t=t instanceof Array?t:[],i=_.orEqual(i,"?"),s=_.orEqual(s,"&"),o=o||{};var u=o.user||r.model.get("user"),a=o.currentPage||r.page,f=o.currentTheme||r.model.get("theme");if(u){var l,c;if(u.get("isLoggedIn")){u.get("Sex")&&t.push("1="+(u.get("Sex").toLowerCase()=="m"?"0":"1"));if(u.get("TSDOB")){var h=u.get("TSDOB").split("-");if(h.length==3){var p=new Date,d=p.getFullYear()-_.toInt(h[0]);_.toInt(h[1])>p.getMonth()?d-=1:_.toInt(h[1])==p.getMonth()&&_.toInt(h[2])>p.getDate()&&(d-=1),d>=13&&d<18?l="1":d>=18&&d<25?l="2":d>=25&&d<35?l="3":d>=35&&d<50?l="4":d>=50&&(l="5"),d>=21&&t.push("a=1"),l&&t.push("10="+l),t.push("14="+this.encodeInteger(d))}}if(u.get("Email")){var v=u.get("Email").split(".");v.length&&v[v.length-1]=="edu"&&t.push("20=1")}u.get("Flags")&n.Models.User.FLAG_ISARTIST?t.push("17=1"):u.get("Flags")&n.Models.User.FLAG_MUSIC_BUSINESS&&t.push("17=2"),u.get("subscription").isAnywhere()?t.push("19=3"):u.get("subscription").isPlus()?t.push("19=2"):t.push("19=1")}else t.push("19=0");t.push("5="+((u.get("settings").local.themeFlags&n.Models.Theme.THEME_FLAG_FAMILY_FRIENDLY)==n.Models.Theme.THEME_FLAG_FAMILY_FRIENDLY?1:0)),!n.Models.Ad.personalizedTags&&n.Services.Local&&n.Services.Local.get("personalizedTags")&&(n.Models.Ad.personalizedTags=n.Services.Local.get("personalizedTags"));if(n.Models.Ad.personalizedTags&&n.Models.Ad.personalizedTags[u.get("UserID")]){var m=n.Models.Ad.personalizedTags[u.get("UserID")];for(var g=0;g<m.length;g++)t.push("26="+m[g])}}this.useTestAds&&(this.useTestAdsValue?t.push("testAds="+this.useTestAdsValue):t.push("testAds=1"));if(a&&a.currentPageView){var y=a.currentPageView;n.Views.Pages.Home&&_.isInstance(y,n.Views.Pages.Home)?t.push("9=1"):n.Views.Pages.Search&&_.isInstance(y,n.Views.Pages.Search)?t.push("9=2"):n.Views.Pages.Profile&&_.isInstance(y,n.Views.Pages.Profile)?t.push("9=3-"+y.id):n.Views.Pages.Tag&&_.isInstance(y,n.Views.Pages.Tag)?t.push("9=4-"+y.id):n.Views.Pages.Popular&&_.isInstance(y,n.Views.Pages.Popular)&&t.push("9=5")}if(a&&a.view){var y=a.view;switch(a.type){case"popular":t.push("9=5");break;case"artist":case"user":t.push("9=3-"+y.id);break;case"tag":t.push("9=4-"+y.id);break;case"search":t.push("9=2");break;case"home":t.push("9=1")}}if(a&&(!$.browser.msie||$.browser.msie&&$.browser.version>=10)){switch(a.type){case"popular":case"tags":t.push("multi=1");break;case"artist":a.section=="albums"&&t.push("multi=1");break;case"album":a.subpage=="related-albums"&&t.push("multi=1");break;case"playlist":a.view&&a.view.id&&t.push("27="+a.view.id);break;case"song":a.view&&a.view.id&&t.push("28="+a.view.id)}_.indexOf(n.Models.Theme.themePages,a.type)>=0&&(t.push("tl=1"),t.push("tl="+a.type))}f&&f.get("themeID")&&(t.push("11="+f.get("themeID")),t.push("themeID="+f.get("themeID")),f.get("capital")&&f.get("capital")!="default"&&t.push(f.get("capital").extraParams||""));if(r.model.get("player")&&r.model.get("player").get("currentQueue")){var b=r.model.get("player").get("currentQueue");b.get("currentAutoplayTagID")&&(t.push("12=1"),t.push("13="+b.get("currentAutoplayTagID"))),b.get("activeSong")&&t.push("2="+b.get("activeSong").get("ArtistID"))}var w;try{w="0=",w+=this.locales[n.Services.Local.get("gs.locale")]}catch(E){w="0=1"}return t.push(w),gsConfig&&gsConfig.isPreview&&t.push("16=1"),t.push("4="+this.adRotationCount),this.useTestAds&&t.push("testAds=1"),t.push("21="+n.Models.Ad.RANDOM_PERCENT),t.push("24="+gsConfig.country.ID),t.push("host="+e.location.host),n.Models.Theme.lastTakeoverID&&t.push("25="+n.Models.Theme.lastTakeoverID),t.push((new Date).getTime()+"="+(new Date).getTime()),i+t.join(s)},encodeInteger:function(e){var t=e.toString(2).split(""),n=1,r=t.length,i=0;while(n<r)t.splice(n+i,0,0),n+=3,i++;return(parseInt(t.join(""),2)*751).toString(16)},decodeInteger:function(e){var n=(parseInt(e,16)/751).toString(2).split(""),r=1,i=0;while(n[r+i]!==t)n[r+i]=null,r+=3,i++;return parseInt(n.join(""),2)},showFlashElements:function(){$.browser.mozilla&&_.toInt($.browser.version)<6?$('#theme-header div[data-flash-wmode="window"] object').each(function(e,t){t.style.visibility="visible"}):$('#theme-header div[data-flash-wmode="window"] object').show(),_.each($(".theme-capital-placeholder"),function(e,t){$("#"+$(e).attr("data-capital-id")).show()})},hideFlashElements:function(){$.browser.mozilla&&_.toInt($.browser.version)<6?$('#theme-header div[data-flash-wmode="window"] object').each(function(e,t){t.style.visibility="hidden"}):$('#theme-header div[data-flash-wmode="window"] object').hide(),_.each($(".theme-capital-placeholder"),function(e,t){$("#"+$(e).attr("data-capital-id")).hide()})},loadSocialvibe:function(){if(i)return i.promise();i=$.Deferred();var t=setTimeout(function(){e.socialvibe||i.reject()},3e3),n=document.getElementById("socialvibe-root");document.getElementById("socialvibe-js")?$(n).empty():(n=document.createElement("div"),n.id="socialvibe-js",document.body.appendChild(n));var r=function(){var r=document.createElement("script");r.id="socialvibe-client-js",r.async=!0,gsConfig&&gsConfig.testSocialvibe?r.src=document.location.protocol+"//qa.static.socialvi.be/js/socialvibe.client.js":r.src=document.location.protocol+"//static.socialvi.be/js/socialvibe.client.js";var s=function(){if($.browser.msie&&this.readyState&&this.readyState!=="complete"&&this.readyState!=="loaded")return;this.onload=this.onreadystatechange=null,setTimeout(function(){clearTimeout(t),typeof e.socialvibe=="object"&&e.socialvibe&&i.resolve(e.socialvibe)},100)};r.onload=r.onreadystatechange=s,n.appendChild(r)};if(typeof e.easyXDM=="object"&&e.easyXDM)return r(),i.promise();var s=document.createElement("script");s.id="easyXDM-js",s.async=!0,s.src=document.location.protocol+"//static.socialvi.be/js/easyXDM.min.js";var o=function(){if($.browser.msie&&this.readyState&&this.readyState!=="complete"&&this.readyState!=="loaded")return;this.onload=this.onreadystatechange=null,setTimeout(function(){r()},10)};s.onload=s.onreadystatechange=o,n.appendChild(s)},getSocialvibeActivities:function(e,t){var r=$.extend({},s),i=$.Deferred();if(e&&e.get("TSDOB")){var a=e.get("TSDOB").split("-");if(a.length==3){var f=new Date,l=f.getFullYear()-_.toInt(a[0]);_.toInt(a[1])>f.month?l-=1:_.toInt(a[1])==f.month&&_.toInt(a[2])>f.date&&(l-=1),r.age=l}}e&&e.get("Sex")&&(r.gender=e.get("Sex").toLowerCase()),e&&e.get("UserID")>0?r.network_user_id=e.get("UserID"):r.network_user_id=n.Services.API.sessionID;var c=function(e){try{e.requestActivities(_.bind(u,this,i,t,e))}catch(n){i.reject()}};return o?c(o):n.Models.Ad.loadSocialvibe().done(function(e){e&&e.client(r,function(e){o=e,c(e)})}).fail(_.bind(i.reject,i)),i.promise()}})}(),function(){n.Models=n.Models||{};var e=n.Models.Promotions=Backbone.Model.extend({idAttribute:"PromotionsID",initialize:function(){}},{promotions:{1206:{key:"whiteCastle",location:"whiteCastle",themeID:1199,themeOnly:!0,version:1.002},1203:{key:"mitsubishi",location:"mitsubishi",themeID:1204,version:1.001},1228:{key:"reyka",location:"reyka",themeID:1236,version:1.008},1347:{key:"newReleases",location:"newReleases",themeID:1337,version:1.008},1425:{key:"mitsubishiMirage",location:"mitsubishiMirage",themeID:1425,version:1.006}},getPromotion:function(e){return this.promotions[e]}})}(),function(){function i(e,t){var n=e.attributes.upVotes,r=t.attributes.upVotes;return(r?r.length:0)-(n?n.length:0)}function s(e,t,n){var r=[],i=0,s=e.length,o,u=0,a=0,f=0;for(;i<s;i++)o=e[i],o.broadcastSongID=[n,":",i].join(""),t&&t[i]&&t[i].s==o.SongID?(o.upVotes=_.toInt(t[i].u)||0,o.downVotes=_.toInt(t[i].d)||0,o.listens=_.toInt(t[i].l)||0,u+=o.upVotes,a+=o.downVotes,f+=o.listens):(o.upVotes=0,o.downVotes=0,o.listens=0),r.push(o);return{totalUpVotes:u,totalDownVotes:a,totalListens:f,songs:r}}function o(e,r,i){var s=[],o=0,u=e.length,a,f=0,l=0;for(;o<u;o++){a=e[o],a.broadcastSongID=[r,":",a.queueSongID].join("");if(i[a.broadcastSongID]){a.broadcastListens&&(a.listens=_.toInt(a.broadcastListens),i[a.broadcastSongID].set({listens:a.listens})),s.push(i[a.broadcastSongID]);continue}a.broadcastUpVotes!==t&&(a.upVotes=_.toInt(a.broadcastUpVotes),f+=a.upVotes,delete a.broadcastUpVotes),a.broadcastDownVotes!==t&&(a.downVotes=_.toInt(a.broadcastDownVotes),l+=a.downVotes,delete a.broadcastDownVotes),a.broadcastListens!==t&&(a.listens=_.toInt(a.broadcastListens),delete a.broadcastListens),a=new n.Models.BroadcastSong(a,{dontCache:!0}),i[a.id]=a,s.push(a)}return{totalUpVotes:f,totalDownVotes:l,songs:s}}function u(e,t,r){var i=n.Models.Player.playStatuses;switch(t){case i.NONE:case i.FAILED:case i.COMPLETED:!this.get("nextSong")&&!this.idleTimeout&&(this.idleTimeout=setTimeout(_.bind(function(){var e=this.get("activeSongStatus");switch(e){case i.NONE:case i.FAILED:case i.COMPLETED:this.set("idle",!this.get("nextSong"));break;default:this.set("idle",!1)}this.idleTimeout=!1},this),15e3));break;default:this.set({idle:!1}),this.idleTimeout&&(clearTimeout(this.idleTimout),this.idleTimeout=!1)}}function a(e,t){var r={};t&&_.each(t,function(e){r[e]=1});if(e){var i=e.chatActivities,s=n.getLoggedInUserID(),o;i&&i.each(function(e){if(e.get("type")!="message")return;o=e.get("user");if(!o||o.id===s)return;r[o.get("UserID")]?e.set("specialFlag","banned"):e.get("specialFlag")==="banned"&&e.unset("specialFlag")})}return r}function f(e,r,s){var u=r?r.cachedBroadcastSongs:e.cachedBroadcastSongs,f=r?r.cachedBroadcastSuggestions:e.cachedBroadcastSuggestions,l;if(e.history&&!(e.history instanceof n.Models.Collections.BroadcastSongs))if(e.history.songs){var c=r&&r.history,h;if(c&&c.length&&e.history.songs.length>1&&c.at(0).get("queueSongID")===e.history.songs[1].queueSongID)h=o([e.history.songs[0]],s,r.cachedBroadcastSongs),l=h.songs[0],l&&c.add(l,{at:0}),delete e.history;else{h=o(e.history.songs,s,u);var p=h.songs;r&&r.history?(r.history.reset(p),delete e.history):e.history=new n.Models.Collections.BroadcastSongs(p,{broadcastID:s,modelOptions:{dontCache:!0}}),e.historyLoaded=!0}}else delete e.history;if(e.newHistorySong){if(r&&r.history){e.newHistorySong.b&&(e.newHistorySong=n.Models.Song.convertManateeSongCalloutProperties(e.newHistorySong));var d=o([e.newHistorySong],s,r.cachedBroadcastSongs);l=d.songs[0],l&&r.history.add(l,{at:0})}delete e.newHistorySong}if(e.suggestions){e.blockedSuggestionSongIDs=_.orEqual(e.suggestions.blockedSongIDs,[]);var v=[],m=n.getLoggedInUserID(),g=0,y=e.listeners,b;_.each(e.suggestions.songs,function(e){e.song&&e.users&&e.users.length&&(_.indexOf(e.users,m)>-1?g=1:g=0,f[e.song.SongID]?b=f[e.song.SongID]:(b=new n.Models.BroadcastSuggestion(e.song,{dontCache:!0,broadcastListeners:y}),f[e.song.SongID]=b),b.set({userVote:g,upVotes:e.users}),v.push(b))});var w=_.toInt(e.suggestions.lastChangeID);r&&r.suggestions?(r.suggestions.reset(v),r.lastChangeID=w,delete e.suggestions):(e.suggestions=new n.Models.Collections.BroadcastSuggestions(null,{modelOptions:{dontCache:!0,broadcastListeners:y}}),e.suggestions.comparator=i,e.suggestions.add(v),e.suggestions.lastChangeID=w)}e.playbackStatus&&(e.status=e.playbackStatus,delete e.playbackStatus);if(e.status){var E=!1,S=0;e.status.activeSong&&e.status.activeSong.b&&(e.status.activeSong=n.Models.Song.convertManateeSongCalloutProperties(e.status.activeSong)),e.status.activeSong&&e.status.activeSong.SongID&&(!r||!r.activeSong||e.status.activeSong.queueSongID!=r.activeSong.get("queueSongID"))?(e.status.activeSong.broadcastSongID=[s,":",e.status.activeSong.queueSongID].join(""),e.status.activeSongVotes&&(e.status.activeSongVotes.up&&e.status.activeSongVotes.up[n.getLoggedInUserID()]?S=1:e.status.activeSongVotes.down&&e.status.activeSongVotes.down[n.getLoggedInUserID()]&&(S=-1)),u[e.status.activeSong.broadcastSongID]?(e.activeSong=u[e.status.activeSong.broadcastSongID],e.activeSong.set({upVotes:e.status.activeSongVotes?_.keys(e.status.activeSongVotes.up):[],downVotes:e.status.activeSongVotes?_.keys(e.status.activeSongVotes.down):[],isActiveSong:!0,userVote:S})):(e.status.userVote=S,e.status.activeSongVotes&&(e.status.activeSong.upVotes=_.keys(e.status.activeSongVotes.up),e.status.activeSong.downVotes=_.keys(e.status.activeSongVotes.down)),e.status.activeSong.isActiveSong=!0,e.activeSong=new n.Models.BroadcastSong(e.status.activeSong,{dontCache:!0}),u[e.activeSong.id]=e.activeSong),E=!0):e.status.activeSong?r&&r.activeSong&&(e.status.activeSongVotes&&(e.status.activeSongVotes.up&&e.status.activeSongVotes.up[n.getLoggedInUserID()]?S=1:e.status.activeSongVotes.down&&e.status.activeSongVotes.down[n.getLoggedInUserID()]&&(S=-1)),r.activeSong.set({upVotes:e.status.activeSongVotes?_.keys(e.status.activeSongVotes.up):[],downVotes:e.status.activeSongVotes?_.keys(e.status.activeSongVotes.down):[],userVote:S})):(e.activeSong=null,E=!0),e.status.nextSong&&e.status.nextSong.b&&(e.status.nextSong=n.Models.Song.convertManateeSongCalloutProperties(e.status.nextSong)),e.status.nextSong&&e.status.nextSong.SongID&&(!r||!r.nextSong||e.status.nextSong.queueSongID!=r.nextSong.get("queueSongID"))?(e.status.nextSong.broadcastSongID=[s,":",e.status.nextSong.queueSongID].join(""),u[e.status.nextSong.broadcastSongID]?e.nextSong=u[e.status.nextSong.broadcastSongID]:(e.nextSong=new n.Models.BroadcastSong(e.status.nextSong,{dontCache:!0}),u[e.nextSong.id]=e.nextSong)):e.status.nextSong||(e.nextSong=null),e.status.activeSongPosition&&(e.activeSongPosition=e.status.activeSongPosition),e.status.activeSongStatus&&(e.activeSongStatus=e.status.activeSongStatus),e.status.timestamp&&(e.lastHeartbeatTime=e.status.timestamp),delete e.status,E&&r&&r.history&&r.history.models[0]&&r.activeSong&&r.history.models[0].get("queueSongID")===r.activeSong.get("queueSongID")&&(r.sumVotes+=r.history.models[0].get("userVote")),E&&r&&r.activeSong&&r.activeSong.set("isActiveSong",!1)}return e.activeSong&&e.activeSong.id&&!u[e.activeSong.id]&&(u[e.activeSong.id]=e.activeSong),e.owners&&(e.owners.artists.length&&(e.ArtistID=e.owners.artists[0]),e.owners.users&&(e.UserID&&_.indexOf(e.owners.users,e.UserID)===-1&&e.owners.users.push(e.UserID),e.owners.users.length&&(e.ownerUserIDs=e.owners.users)),delete e.owners),e.ownerArtistIDs&&(e.ownerArtistIDs.length&&(e.ArtistID=e.ownerArtistIDs[0]),delete e.ownerArtistIDs),e.ownerArtistID&&(e.ArtistID=e.ownerArtistID,delete e.ownerArtistID),e.ownerUserIDs&&!e.UserID&&(e.UserID||(e.UserID=e.ownerUserIDs[0])),e.publishers&&(e.publishers.users&&(e.publishersUsersIDs=e.publishers.users),delete e.publishers),e.Description&&(e.Description=$.trim(e.Description.replace(/[\r\n]/g," ").replace(/\s{2,}/," ")),r&&r.Description==e.Description&&delete e.Description),e.activeStatus===1&&(!r||!r.chatActivities)&&(e.chatActivities=new n.Models.Collections.ChatActivities(t,{silentCapping:!0,limit:100})),e.pendingNewOwnerUserDetails?(e.pendingNewOwnerUserDetails.u?e.pendingNewOwner=n.Models.User.newOrUpdate({UserID:_.toInt(e.pendingNewOwnerUserDetails.i),FName:e.pendingNewOwnerUserDetails.n,Picture:e.pendingNewOwnerUserDetails.p}):e.pendingNewOwner=n.Models.Artist.newOrUpdate({ArtistID:_.toInt(e.pendingNewOwnerUserDetails.i),ArtistName:e.pendingNewOwnerUserDetails.n,CoverArtFilename:e.pendingNewOwnerUserDetails.p}),delete e.pendingNewOwnerUserDetails):e.hasOwnProperty("pendingNewOwnerUserDetails")&&(e.pendingNewOwner=null,delete e.pendingNewOwnerUserDetails),e.bannedUserIDs&&(e.bannedUserIDs=a(r,e.bannedUserIDs)),e}function l(e){var t={},r,i,s,o,u;for(o in e){if(!e.hasOwnProperty(o)||!n.Models.Broadcast.broadcastsByTagsDeferreds[o])continue;r=e[o],u=r.length;for(s=0;s<u;s++)r[s]&&r[s].sub&&r[s].sub.substr(0,6)==="bcast:"&&(i=r[s].sub.substr(6),t[i]=1,n.Models.Broadcast.broadcastIDToTags[i]?n.Models.Broadcast.broadcastIDToTags[i].push(o):n.Models.Broadcast.broadcastIDToTags[i]=[o],n.Models.Broadcast.storeListenersInCache(i,null,r[s].subscribers_count))}var a=_.keys(t);n.Services.SWF.fetchBroadcastsInfo(a,["owners","t","py","n","ownerSubscribed"])}function c(){g||(n.on("manatee:fetchSubsByTags",l),n.on("manatee:broadcastsInfo",p),n.on("manatee:broadcastInfo",h),n.on("manatee:getUsersChatInfo",d),g=!0)}function h(e,t){!e&&n.Models.Broadcast.broadcastsDeferreds[t]&&n.Models.Broadcast.broadcastsDeferreds[t].reject()}function p(e){var t=[],r={},i=e.length,s=[],o,u,a,f,l,c;for(f=0;f<i;f++){if(!e[f])continue;a=e[f].get("BroadcastID"),u=n.Models.Broadcast.broadcastIDToTags[a];if(u){s=s.concat(u);for(l=0,c=u.length;l<c;l++)n.Models.Broadcast.broadcastsByTagsDeferreds[u[l]]&&n.Models.Broadcast.broadcastsByTagsDeferreds[u[l]].__broadcasts.push(e[f])}o=e[f].get("ownerUserIDs")[0];if(e[f].get("ownerArtistID")||!o||o<1||r[o])continue;if(n.Models.User.getCached(o)){r[o]=1;continue}t.push(o)}s=_.unique(s),t.length?(t=_.unique(t),n.Services.SWF.getUsersChatInfo(t,{completedTags:s})):d(null,{completedTags:s})}function d(e,t){if(!t||!t.completedTags)return;var r=t.completedTags,i,s,o;for(s=0,o=r.length;s<o;s++)i=n.Models.Broadcast.broadcastsByTagsDeferreds[r[s]],i&&(i.resolve(i.__broadcasts),delete n.Models.Broadcast.broadcastsByTagsDeferreds[r[s]])}n.Models=n.Models||{};var v={msPlayed:5e3,msLeft:3e4,numListeners:10,downDelta:5,downPercent:.9,activePercent:.25,countdown:20},m=_.throttle(function(){var e=this.get("activeSong");if(!e||e.get("noSkip"))return;var t=r.model.get("player");if(!t.get("duration")||t.get("position")<v.msPlayed||t.get("duration")-t.get("position")<v.msLeft)return;var n=this.get("listeners");if(!n||n.length<v.numListeners)return;var i=e.get("upVotes")||[],s=e.get("downVotes")||[];if(s.length-i.length<v.downDelta)return;if(s.length/(s.length+i.length)<v.downPercent)return},1e3),g=!1,y={},b={},w=n.Models.Broadcast=Backbone.CachedModel.extend({idAttribute:"BroadcastID",parse:function(e,t){var r=t||{},i=r.clone===!1?e:_.clone(e);i.BroadcastID=_.orEqual(i.BroadcastID,i.broadcastID),i.UserID&&(i.ownerUserIDs=[i.UserID]);if(i.Songs){var o=s(i.Songs,i.PlayData,i.BroadcastID);i.history=new n.Models.Collections.BroadcastSongs(o.songs,{broadcastID:i.BroadcastID,modelOptions:{dontCache:!0}}),i.historyLoaded=!0,i.totalUpVotes=o.totalUpVotes,i.totalDownVotes=o.totalDownVotes,i.totalListens=o.totalListens}return i.ownerArtist?i.ownerArtist instanceof n.Models.Artist?i.ownerModel=i.ownerArtist:i.ownerModel=n.Models.Artist.newOrUpdate(i.ownerArtist,{dontCache:!0}):i.ownerUser&&(i.ownerUser instanceof n.Models.User?i.ownerModel=i.ownerUser:i.ownerModel=n.Models.User.newOrUpdate(i.ownerUser,{dontCache:!0})),i.cachedBroadcastSongs={},i.cachedBroadcastSuggestions={},i.approvedSuggestions=new n.Models.Collections.BroadcastSongs([]),!i.activeStatus&&y[i.BroadcastID]&&(i.activeStatus=0,delete y[i.BroadcastID]),f(i,null,i.BroadcastID),delete i.broadcastID,delete i.Songs,delete i.PlayVotes,delete i.owner,delete i.ownerArtist,delete i.ownerUser,delete i.suggestionsChanges,r.isFavorite&&(i.isFavorite=!0),r.activeStatus===0&&!i.activeStatus&&(i.activeStatus=0),_.defaults(i,{activeSong:null,nextSong:null,listenersLoaded:!1,activeStatus:-1,isFavorite:!1,vipUsers:null,sumVotes:0}),i},initialize:function(e,t){this.chatLocks=[],this.updateSearchText();var r=this.get("vipUsers");r&&this.set({vipUsers:this.processVIPUsers(r,!0)}),this.isLoggedInUserOwner()&&this.get("chatEnabled")===!1&&this.addPersistentChatActivity(new n.Models.ChatActivity({type:"info",infoType:n.Models.ChatActivity.CHAT_DISABLED_OWNER})),n.Models.Broadcast.restoreListenersFromCache(this),this.on("change:Name change:Tag change:UserID",this.updateSearchText,this),this.on("change:Name change:Tag change:Description",this.onMainAttrChange,this),this.on("change:totalListens",this.onTotalListensChange,this),this.isLoggedInUserOwner()&&this.on("change:activeSong",this.suggestInvitingBroadcasterFriends,this),this.on("change:activeSongStatus",u,this),Backbone.CachedModel.prototype.initialize.call(this,e,t),n.Models.Broadcast.broadcastsDeferreds[this.id]&&this.get("activeStatus")!==-1&&n.Models.Broadcast.broadcastsDeferreds[this.id].resolve(this,this.id);var i=this.id.indexOf(":");if(i>-1){var s=this.id.substr(0,i),o=this.id.substr(i+1);if(!b[s]||this.id>b[s])b[s]=this.id}},updateFromNew:function(e,t){var n;t&&t.source==="db"?n=e:this.attributes.listenersLoaded||(t&&t.source==="memcache"&&!this.attributes.listenersLoaded?n=e:e.hasOwnProperty("listenersCount")&&(n=_.omitSameKeys(this.attributes,e),n.listenersCount=_.toInt(e.listenersCount)));if(e.isFavorite||t&&t.isFavorite)n.isFavorite=!0;this.set(n,t)},updateListenersCount:function(e){var t={};e=_.toInt(e),e>-1&&!this.attributes.listenersLoaded&&(t.listenersCount=e),this._getUpdatedListenersCountDfd&&(e>-1?this._getUpdatedListenersCountDfd.resolve(e):this._getUpdatedListenersCountDfd.reject(e)),this.set(t)},updateFromSwf:function(e,r){if(!e||e.BroadcastID&&e.BroadcastID!==this.id)return;if(e.vipUsers){var i=!r||this.get("vipUsers")===null;e.vipUsers=this.processVIPUsers(e.vipUsers,i)}e.suggestionsChanges&&(e.suggestions?e.suggestionsChanges.length&&(e.suggestions.lastChangeID=_.last(e.suggestionsChanges).id):this.handleSuggestionsChanges(e.suggestionsChanges)),delete e.broadcastID,delete e.BroadcastID,delete e.lastPublicMessages,delete e.suggestionsChanges,this.isLoggedInUserOwner()&&(e.chatEnabled===!0?this.removePersistentChatActivity("info",n.Models.ChatActivity.CHAT_DISABLED_OWNER):e.chatEnabled===!1&&this.addPersistentChatActivity(new n.Models.ChatActivity({type:"info",infoType:n.Models.ChatActivity.CHAT_DISABLED_OWNER}))),e.lastUpdated=Date.now(),e.activeStatus===t&&this.get("activeStatus")<0&&(e.activeStatus=1),f(e,this.attributes,this.get("BroadcastID")),this.set(e),n.Models.Broadcast.broadcastsDeferreds[this.id]&&n.Models.Broadcast.broadcastsDeferreds[this.id].resolve(this,this.id),this.cleanupSuggestionsCache()},updateSearchText:function(){var e=this.get("Name"),t=this.get("Tag"),r=t&&t.n||_.getString("BROADCAST_DEFAULT_TAG"),i=this.getOwner(),s=i&&i.get(i instanceof n.Models.Artist?"ArtistName":"Name");this.set("searchText",[e,r,s].join(" ").toLowerCase())},onTotalListensChange:function(e,t){var n=this.getOwner(),r=t-this.previous("totalListens");n.incrementEstimatedListens(r)},activeVotesChanged:function(){this.isLoggedInUserOwner()&&m.call(this)},transferFromOldBroadcast:function(e,t){var r=this.id,s=e.get("chatActivities"),o={BroadcastID:r,history:new n.Models.Collections.BroadcastSongs([],{broadcastID:r}),totalListens:0,chatActivities:new n.Models.Collections.ChatActivities(s&&s.models,{silentCapping:!0,limit:100}),cachedBroadcastSongs:{},cachedBroadcastSuggestions:{},lastUpdated:Date.now(),pendingNewOwner:null};if(t){var u=t.get("UserID");o.UserID=u,o.ownerModel=t,o.ownerUserIDs=[u]}var a=e.get("listeners");o.suggestions=new n.Models.Collections.BroadcastSuggestions(null,{modelOptions:{dontCache:!0,broadcastListeners:a}}),o.suggestions.comparator=i;var f=[],l;e.get("suggestions").each(function(e){l=e.get("SongID"),e=new n.Models.BroadcastSuggestion($.extend({SongID:l},e.attributes),{dontCache:!0,broadcastListeners:a,wrappedModel:e._wrapped}),f.push(e),o.cachedBroadcastSuggestions[l]=e}),o.suggestions.add(f);var c=e.get("activeSong"),h=e.get("nextSong"),p;c&&(l=c.get("SongID"),p=$.extend({SongID:l},c.attributes,{broadcastSongID:[r,":",c.get("queueSongID")].join("")}),c=new n.Models.BroadcastSong(p,{dontCache:!0}),o.activeSong=c,o.cachedBroadcastSongs[p.broadcastSongID]=c),h&&(l=h.get("SongID"),p=$.extend({SongID:l},h.attributes,{broadcastSongID:[r,":",h.get("queueSongID")].join("")}),p.broadcastSongID=[r,":",h.get("queueSongID")].join(""),h=new n.Models.BroadcastSong(p,{dontCache:!0}),o.nextSong=h,o.cachedBroadcastSongs[p.broadcastSongID]=h),this.set($.extend({},e.attributes,o)),e.trigger("transferred",this)},setListeners:function(e){var t=this.get("listeners");if(t){t.reset(e),this.set("listenersLoaded",!0);return}var r=new n.Models.Collections.Users([],{modelOptions:{dontCache:!0}}),i=this.get("UserID");this.on("change:UserID",function(e,t){t&&(i=t.id,r.sort())}),r.comparator=_.bind(function(e,t){return e.id===i?-1:t.id===i?1:n.Models.User.niftyFriendSort(e,t)},this),r.add(e),this.set({listeners:r,listenersLoaded:!0})},addHistoryListenCount:function(e,t){var n=this.get("history"),r=t;for(var i=0,s=n.models.length;i<s;i++)if(n.models[i]&&n.models[i].get("SongID")==e){r-=_.toInt(n.models[i].attributes.listens),n.models[i].set({listens:t});break}},isLoggedInUserOwner:function(){return this.attributes.ownerUserIDs&&_.contains(this.attributes.ownerUserIDs,n.getLoggedInUserID())},isUserVIP:function(e){var t=this.get("vipUsersKeyed");return t&&_.has(t,"u:"+e)},getPermissionsForUserID:function(e){var t=this.get("vipUsersKeyed");return t&&t["u:"+e]},checkPermissionsForUserID:function(e,t){return(this.getPermissionsForUserID(e)&t)>0},addVIPCallout:function(e){if(!this.checkPermissionsForUserID(n.getLoggedInUserID(),n.Models.Broadcast.VIP_PERM_CALLOUTS)){n.trigger("notification:add",{description:_.getString("POPUP_ERROR_BROADCAST_CALLOUT_PERMISSIONS"),type:"error",duration:5e3});return}n.Services.SWF.addCalloutForBroadcast(e.getDetailsForSwf())},updateBroadcastDetails:function(e,t,r,i,s){i=_.orEqual(i,null),s=_.orEqual(s,null);var o=$.Deferred(),u=n.getLoggedInUserID(),a=this.isUserVIP(u),f=this.get("BroadcastID"),l=this.get("Tag"),c=this.get("Description"),h;if(!this.isLoggedInUserOwner()&&!a)return n.trigger("notification:add",{description:_.getString("POPUP_ERROR_BROADCAST_CHANGE_NOT_OWNER"),type:"error",duration:5e3}),o.reject();if(a&&!this.checkPermissionsForUserID(u,n.Models.Broadcast.VIP_PERM_METADATA))return n.trigger("notification:add",{description:_.getString("POPUP_ERROR_BROADCAST_CHANGE_PERMISSIONS"),type:"error",duration:5e3}),o.reject();e=_.isString(e)&&e.substr(0,255);if(!e||e===this.get("Name"))e=null;return t===null&&l&&l.i>0?t={i:0,n:"multi-genre"}:t=_.orEqual(t,l),c||(c=""),_.defined(r)&&r!==c?r=r.substr(0,145):r=null,s!==null&&s===this.get("Privacy")&&(s=null),e!==null||r!==null||i!==null&&i!=this.get("Image")||s!==null&&s!=this.get("Privacy")||!(!t&&!l||t&&l&&t.i==l.i)?(h=function(){var u={};e!==null&&(u.Name=e),r!==null&&(u.Description=r),i!==null&&(u.Image=i),s!==null&&(u.Privacy=s),t&&(t.i===0?u.Tag=null:u.Tag=t),n.Services.SWF.changeBroadcastInfo(f,u),o.resolve(this)},a?h():n.Services.API.broadcastUpdateExtraData(f,e,t,r,i,s,this.get("ArtistID")).done(_.bind(h,this)).fail(_.bind(o.reject,o)),o.promise()):(o.resolve(this),o.promise())},updateImage:function(e){e=e||null,n.Services.SWF.changeBroadcastInfo(this.get("BroadcastID"),{Image:e})},updateBroadcastPreferences:function(e,t){var r=n.getLoggedInUserID(),i=this.isUserVIP(r);if(!this.isLoggedInUserOwner()&&!i){n.trigger("notification:add",{description:_.getString("POPUP_ERROR_BROADCAST_CHANGE_NOT_OWNER"),type:"error",duration:5e3});return}if(i&&!this.checkPermissionsForUserID(r,n.Models.Broadcast.VIP_PERM_FEATURES)){n.trigger("notification:add",{description:_.getString("POPUP_ERROR_BROADCAST_CHANGE_PERMISSIONS"),type:"error",duration:5e3});return}n.Services.SWF.changeBroadcastInfo(this.get("BroadcastID"),{chatEnabled:e,suggestionsEnabled:t})},sendChatMessage:function(e){var t=_.orEqual(r.model.get("user").get("settings"),{}),i=_.orEqual(t.local,{}),s=!1;i&&i.ignoreChatTag&&(s=!0),e=e.substr(0,256),n.getLoggedInUserID()>0?(n.Services.SWF.sendBroadcastChat(e,this.id,s),n.trigger("guts:log","broadcastChatMessageSent",{broadcastID:this.id}),this.suggestInvitingUserFriends()):n.trigger("lightbox:open","login",{message:_.getString("LB_LOGIN_MUST_LOGIN_TO_CHAT"),onLogin:_.bind(n.Services.SWF.sendBroadcastChat,n.Services.SWF,e,this.id,s),destination:this.toUrl()})},suggestSong:function(e){function u(){n.on("broadcast:suggestionResult:"+t,function r(s){s&&s.success?i&&i.set("userVote",1):(n.trigger("notification:add",{description:_.getString("POPUP_BROADCAST_SUGGESTION_FAILED",{song:e.escape("SongName")}),type:"error",duration:5e3}),n.trigger("guts:log","broadcastSuggestFailed",o)),n.off("broadcast:suggestionResult:"+t,r)},this),n.Services.SWF.suggestSongForBroadcast(s),n.trigger("guts:log","broadcastSongSuggested",o)}if(!this.get("activeStatus"))return;var t=e.get("SongID"),r=this.get("blockedSuggestionSongIDs");if(r&&_.indexOf(r,t)>-1){n.trigger("notification:add",{description:_.getString("POPUP_BROADCAST_SUGGESTION_BLOCKED"),type:"error",duration:5e3});return}if(!this.get("suggestionsEnabled")){n.trigger("notification:add",{description:_.getString("SUGGESTIONS_DISABLED"),type:"error",duration:5e3});return}var i=this.get("cachedBroadcastSuggestions")[t];if(i&&_.indexOf(i.get("upVotes"),n.getLoggedInUserID())>-1){n.trigger("notification:add",{description:_.getString("POPUP_BROADCAST_SUGGESTION_ALREADY_VOTED",{song:i.escape("SongName")}),type:"error",url:this.toUrl(),duration:5e3}),i.set("userVote",1);return}var s=e.getDetailsForSwf(),o={songID:t};n.getLoggedInUserID()>0?(this.suggestInvitingUserFriends(),u()):n.trigger("lightbox:open","login",{message:_.getString("LB_LOGIN_MUST_LOGIN_TO_SUGGEST"),onLogin:u,destination:this.toUrl()})},suggestInvitingUserFriends:function(){function e(){this.newChatActivity(new n.Models.ChatActivity({type:"info",infoType:"inviteUserFollowers"})),this.suggestedInvitation=!0}if(this.isLoggedInUserOwner())return;if(this.suggestedInvitation||this.get("activeStatus")!==1)return;this.suggestInvitingUserFriendsTimer?(clearTimeout(this.suggestInvitingUserFriendsTimer),this.suggestInvitingUserFriendsTimer=null):this.suggestInvitingUserFriendsTimer=setTimeout(_.bind(e,this),1e4)},suggestInvitingBroadcasterFriends:function(){if(this.get("history").length<2)return;this.off("change:activeSong",this.suggestInvitingBroadcasterFriends),this.get("listenersCount")<5&&this.newChatActivity(new n.Models.ChatActivity({type:"info",infoType:"inviteBroadcasterFollowers"}))},removeSuggestion:function(e){var t=e.get("SongID"),r=this.get("blockedSuggestionSongIDs");if(r&&_.indexOf(r,t)>-1){e.set("userVote",0);return}var i=this.get("cachedBroadcastSuggestions")[t];if(i&&_.indexOf(i.get("upVotes"),n.getLoggedInUserID())===-1){i.set("userVote",0);return}n.getLoggedInUserID()>0&&(n.on("manatee:suggestionRemove:"+t,function s(r){(!r||!r.success)&&n.trigger("notification:add",{description:_.getString("POPUP_BROADCAST_SUGGESTION_REMOVE_FAILED",{song:e.escape("SongName")}),type:"error",duration:5e3}),n.off("manatee:suggestionRemove:"+t,s)},this),n.Services.SWF.removeSuggestionForSongInBroadcast(t))},approveTopSuggestion:function(e,t){if(!_.defined(e)&&!this.get("nextSong")){this.cancelPendingAutoApprove();var r=this.get("suggestions");if(r&&r.length){var i=r.at(0);this.approveSuggestedSong(i,!0),n.trigger("notification:add",{description:_.getString("POPUP_BROADCAST_SUGGESTION_AUTO_APPROVED",{song:i.escape("SongName")}),type:"success",duration:5e3})}return}if(!this.autoApproveTimeout||this.autoApproveAllowOverwrite)this.cancelPendingAutoApprove(),this.autoApproveTimeout=setTimeout(_.bind(this.approveTopSuggestion,this),e),this.autoApproveAllowOverwrite=!!t},cancelPendingAutoApprove:function(){clearTimeout(this.autoApproveTimeout),this.autoApproveTimeout=!1},approveSuggestedSong:function(e,t){t=_.orEqual(t,!1);var r=n.getLoggedInUserID(),i=this.isUserVIP(r);if(!this.isLoggedInUserOwner()&&!i){n.trigger("notification:add",{description:_.getString("POPUP_ERROR_BROADCAST_APPROVE_NOT_OWNER"),type:"error",duration:5e3});return}if(i&&!this.checkPermissionsForUserID(r,n.Models.Broadcast.VIP_PERM_SUGGESTIONS)){n.trigger("notification:add",{description:_.getString("POPUP_ERROR_BROADCAST_APPROVE_PERMISSIONS"),type:"error",duration:5e3});return}if(!e||e.get("approvedStatus")==1)return;var s=e.get("SongID"),o=this.get("cachedBroadcastSuggestions"),u={songID:s};t&&(u.wasAuto=t);if(o&&o[s])n.Services.SWF.approveSuggestedSongForBroadcast(s,!1,t),n.trigger("guts:log","broadcastSuggestionApproved",u);else{var a=e._wrapped||e,f=new n.Models.PlayContext;f.type="suggestion",f.data={wasAuto:t},f.addStreamType(n.Models.PlayContext.TYPE_BROADCAST),a&&n.trigger("player:addSongs",[a],n.Services.SWF.playSpecialIndexes.LAST,!1,f)}e.set("approvedStatus",1)},rejectSuggestedSong:function(e){var t=n.getLoggedInUserID(),r=this.isUserVIP(t);if(!this.isLoggedInUserOwner()&&!r){n.trigger("notification:add",{description:_.getString("POPUP_ERROR_BROADCAST_REJECT_NOT_OWNER"),type:"error",duration:5e3});return}if(r&&!this.checkPermissionsForUserID(t,n.Models.Broadcast.VIP_PERM_SUGGESTIONS)){n.trigger("notification:add",{description:_.getString("POPUP_ERROR_BROADCAST_REJECT_PERMISSIONS"),type:"error",duration:5e3});return}if(e.get("approvedStatus")==-1)return;var i=e.get("SongID"),s=this.get("cachedBroadcastSuggestions");n.Services.SWF.rejectSuggestedSongForBroadcast(i),n.trigger("guts:log","broadcastSuggestionRejected",{songID:i}),s&&s[i]&&delete s[i],e.set("approvalStatus",-1)},voteActiveSong:function(e){if(this.isLoggedInUserOwner())return;var t=this.get("activeSong");if(!t)return;var r,i=n.getLoggedInUserID()+"";if(e!==0){e>0?r=t.get("upVotes"):r=t.get("downVotes");if(r&&_.indexOf(r,i)>-1){t.set("userVote",e);return}}else{r=t.get("upVotes");if(r&&_.indexOf(r,i)===-1){r=t.get("downVotes");if(r&&_.indexOf(r,i)===-1){t.set("userVote",e);return}}}n.getLoggedInUserID()>0?(n.Services.SWF.voteActiveBroadcastSong(e),e>0?n.trigger("guts:log","songUpVoted",{nowPlaying:!0,songID:t.get("SongID")}):e===0?n.trigger("guts:log","songVotedNeutral",{nowPlaying:!0,songID:t.get("SongID")}):n.trigger("guts:log","songDownVoted",{nowPlaying:!0,songID:t.get("SongID")})):n.trigger("lightbox:open","login",{message:_.getString("LB_LOGIN_MUST_LOGIN_TO_VOTE"),onLogin:_.bind(n.Services.SWF.voteActiveBroadcastSong,n.Services.SWF,e),destination:this.toUrl()})},setBannedUserIDs:function(e,t){var r={};e&&_.each(e,function(e){r[e]=1});var i=this.get("chatActivities"),s=n.getLoggedInUserID(),o;return i&&i.each(function(e){if(e.get("type")!="message")return;o=e.get("user");if(!o||o.id===s)return;r[o.get("UserID")]?e.set("specialFlag","banned"):e.get("specialFlag")==="banned"&&e.unset("specialFlag")}),t||this.set("bannedUserIDs",r),r},processVIPUsers:function(e,t){var r={},i=this.get("vipUsersKeyed")||{},s=[],o;e&&_.each(e,function(e){e.artistID?(o="a:"+e.userID,r[o]=e.permissions):e.userID&&(o="u:"+e.userID,r[o]=e.permissions),_.has(i,o)||s.push(e)});var u=this.get("chatActivities"),a=n.getLoggedInUserID(),f;u&&u.each(function(e){if(e.get("type")!="message")return;f=e.get("user");if(!f)return;_.has(r,"u:"+f.get("UserID"))?e.set("specialFlag","vip"):e.get("specialFlag")==="vip"&&e.unset("specialFlag")});var l;_.has(r,"u:"+a)&&!_.has(i,"u:"+a)?(l=new n.Models.ChatActivity({type:"info",infoType:n.Models.ChatActivity.YOU_ARE_VIP}),this.newChatActivity(l)):!_.has(r,"u:"+a)&&_.has(i,"u:"+a)&&(l=new n.Models.ChatActivity({type:"info",infoType:n.Models.ChatActivity.NO_LONGER_VIP}),this.newChatActivity(l));if(!t){var c=this.get("listeners");_.each(s,_.bind(function(e){if(e.artistID){f=n.Models.Artist.getCached(e.artistID);if(!f)return;l=new n.Models.ChatActivity({type:"info",user:f,infoType:n.Models.ChatActivity.VIP_ADDED}),this.newChatActivity(l)}else if(e.userID&&e.userID!=a){f=c&&c.get(e.userID)||n.Models.User.getCached(e.userID);if(!f)return;l=new n.Models.ChatActivity({type:"info",user:f,infoType:n.Models.ChatActivity.VIP_ADDED}),this.newChatActivity(l)}},this))}return this.set("vipUsersKeyed",r,{silent:!0}),e},banListener:function(e,t){var r=e.get("UserID"),i=n.getLoggedInUserID(),s=this.get("bannedUserIDs"),o=this.isLoggedInUserOwner(),u=n.Models.Comment.ADMINS[i],a=this.isUserVIP(i);if(!r)return;if(!o&&!u&&!a){n.trigger("notification:add",{description:_.getString("POPUP_ERROR_BROADCAST_BAN_NOT_OWNER"),type:"error",duration:5e3});return}if(a&&!this.checkPermissionsForUserID(i,n.Models.Broadcast.VIP_PERM_CHAT_MODERATE)){n.trigger("notification:add",{description:_.getString("POPUP_ERROR_BROADCAST_BAN_PERMISSIONS"),type:"error",duration:5e3});return}if(_.contains(this.attributes.ownerUserIDs,r)||n.Models.Comment.ADMINS[r]||this.isUserVIP(r))return;o||a?n.Services.SWF.banBroadcastListenerByUserID(r):u&&n.Services.API.banBroadcastListenerByUserID(r,this.get("BroadcastID"),_.keys(s),t)},unBanListener:function(e){var t=e.get("UserID"),r=n.getLoggedInUserID(),i=this.get("bannedUserIDs"),s=this.isLoggedInUserOwner(),o=n.Models.Comment.ADMINS[r],u=this.isUserVIP(r);if(!t||!i||!i[t])return;if(!s&&!o&&!u){n.trigger("notification:add",{description:_.getString("POPUP_ERROR_BROADCAST_BAN_NOT_OWNER"),type:"error",duration:5e3});return}if(u&&!this.checkPermissionsForUserID(r,n.Models.Broadcast.VIP_PERM_CHAT_MODERATE)){n.trigger("notification:add",{description:_.getString("POPUP_ERROR_BROADCAST_BAN_PERMISSIONS"),type:"error",duration:5e3});return}n.Services.SWF.unBanBroadcastListenerByUserID(t)},addVIPUser:function(e,t,r){var i=this.get("vipUsers");if(!this.isLoggedInUserOwner()){n.trigger("notification:add",{description:_.getString("POPUP_ERROR_BROADCAST_PROMOTE_NOT_OWNER"),type:"error",duration:5e3});return}!this.isUserVIP(e)&&i&&i.length===n.Models.Broadcast.MAX_VIPS&&this.removeVIPUser(i[0].userID),n.Services.SWF.broadcastAddVIPUser(e,0,r)},removeVIPUser:function(e){if(!this.isLoggedInUserOwner()){n.trigger("notification:add",{description:_.getString("POPUP_ERROR_BROADCAST_DEMOTE_NOT_OWNER"),type:"error",duration:5e3});return}n.Services.SWF.broadcastRemoveVIPUser(e)},getImageURL:function(t){var r=this.get("Image"),i=this.getOwner(),s;if(r)s=n.Models.Broadcast.artPath+t+"_"+r;else{if(i)return i.getImageURL(t);s=n.Models.User.artPath+t+"_user.png"}return gsConfig.runMode!=="production"&&(s+="?co="+e.location.host),s},getActiveSongImageURL:function(e){var t=this.get("activeSong");return t?t.getImageURL(e):n.Models.Song.artPath+e+"_album.png"},toUrl:function(e){var t=this.get("ArtistID"),r=this.get("UserID"),i=this.getOwner(),s;if(!r&&!t&&!i)return null;if(!i)if(t){var o=n.Models.Artist.getCached(t);o&&(i=o),s="artist"}else{var u=n.Models.User.getCached(r);u&&(i=u),s="profile"}return i?this.get("activeStatus")>0&&!e?i.toUrl("broadcast"):i.toUrl("broadcast/"+this.id):_.cleanUrl("-",t||r,s,null,"broadcast/"+this.id)},toManateeProperties:function(){return{bID:this.get("BroadcastID"),n:this.get("Name"),aID:this.get("ArtistID"),uID:this.get("UserID"),t:this.get("Tag"),d:this.get("Description"),pr:this.get("Privacy"),im:this.get("Image"),pbID:this.get("ParentBroadcastID"),ir:this.get("IsRandomName"),s:this.get("Subscribers"),ps:this.get("PeakSubscribers"),ts:this.get("TSCreated")}},toOwnerUrl:function(){var e=this.get("ArtistID"),t=this.get("UserID"),r=this.getOwner(),i;if(!t&&!e&&!r)return null;if(!r){if(e){var s=n.Models.Artist.getCached(e);s&&(r=s),i="artist"}else{var o=n.Models.User.getCached(t);o&&(r=o),i="user"}i="profile"}return r?r.toUrl():_.cleanUrl("-",e||t,i)},getOwner:function(){if(this.attributes.ownerModel)return this.attributes.ownerModel;if(this.attributes.ArtistID){var e=n.Models.Artist.getCached(this.get("ArtistID"));return e||null}var t=n.Models.User.getCached(this.get("UserID"));return t||null},newListener:function(e){if(!this.get("listenersLoaded"))return;if(e&&!_.contains(this.attributes.ownerUserIDs,e.get("UserID"))){var t=this.get("listeners");if(t.get(e))return;t.add(e);if(!(e instanceof n.Models.AuthUser)){var r=new n.Models.ChatActivity({type:"info",infoType:n.Models.ChatActivity.JOINED_BROADCAST,users:new n.Models.Collections.Users([e],{modelOptions:{dontCache:!0}})});this.newChatActivity(r)}}this.set("listenersCount",_.toInt(this.get("listenersCount"))+1)},listenerLeft:function(e){if(!this.get("listenersLoaded"))return;if(e&&!_.contains(this.attributes.ownerUserIDs,e.get("UserID"))){var t=this.get("listeners");if(!t.get(e))return;t.remove(e);if(!(e instanceof n.Models.AuthUser)){var r=new n.Models.ChatActivity({type:"info",infoType:n.Models.ChatActivity.LEFT_BROADCAST,users:new n.Models.Collections.Users([e],{modelOptions:{dontCache:!0}})});this.newChatActivity(r)}}this.set("listenersCount",Math.max(1,this.get("listenersCount")-1))},suggestionApproved:function(e,t){if(!e){console.log("suggestion approve no song",e);return}var r=this.get("listeners"),i=r&&r.get(t)||n.Models.User.getCached(t),s;e.get("userVote")&&_.indexOf(e.get("upVotes"),n.getLoggedInUserID())===0&&n.trigger("notification:add",{type:"success",description:_.getString("POPUP_BROADCAST_SUGGESTION_APPROVED",{song:e.escape("SongName")}),url:this.toUrl(),duration:5e3}),e.set({userVote:0,approvalStatus:0}),this.get("approvedSuggestions").add(e),s=new n.Models.ChatActivity({type:"info",infoType:n.Models.ChatActivity.SUGGESTION_APPROVED,song:e,user:i}),this.newChatActivity(s)},suggestionAdded:function(e,t){if(!e||!t){console.log("suggestion added no song/user",e,t);return}var r=new n.Models.ChatActivity({type:"info",infoType:n.Models.ChatActivity.SUGGESTION_ADDED,song:e,user:t});this.newChatActivity(r)},newChatActivity:function(e){var i=this.get("chatActivities"),s=_.orEqual(r.model.get("user").get("settings"),{}),o=_.orEqual(s.local,{}),u=e.get("infoType"),a=n.Models.ChatActivity,f=u===a.JOINED_BROADCAST||u===a.LEFT_BROADCAST,l=u===a.SONG_CHANGED,c=u===a.SUGGESTION_ADDED||u===a.SUGGESTION_APPROVED;if(f&&o.joinLeftDisabled||l&&o.nowPlayingDisabled||c&&o.suggestionsDisabled)return;i||(i=new n.Models.Collections.ChatActivities(t,{silentCapping:!0,limit:100}),this.set("chatActivities",i));if(e.get("type")==="info"){var h=i.last();if(h&&h.get("type")==="info"){n.trigger("chat:merge"),_.defer(_.bind(function(){if(h.merge(e))return;e.set("broadcastID",this.id),i.add(e)},this));return}}else{var p=this.get("bannedUserIDs"),d=e.get("artist"),v=e.get("user");if(p&&v&&p[v.id]&&v.id!==n.getLoggedInUserID())e.set("specialFlag","banned");else if(d&&this.get("ArtistID")==d.id)e.set("specialFlag","owner");else if(v&&_.contains(this.get("ownerUserIDs"),v.id))e.set("specialFlag","owner");else if(v&&this.isUserVIP(v.id))e.set("specialFlag","vip");else if(v&&v.get("restricted"))return}e.set("broadcastID",this.id),i.add(e)},cleanupOnEnd:function(e){n.trigger("broadcast:notifEvent",this,!0);var t=this.get("BroadcastID");if(this.get("activeStatus")!==1){this.set("activeStatus",0),n.Models.Broadcast.broadcastsDeferreds[t]&&n.Models.Broadcast.broadcastsDeferreds[t].resolve(this);return}var r=this.get("history"),i=this.get("ownerUserIDs"),s=this.get("ArtistID");if(!e){var o=0,u=0;r&&r.length&&r.each(function(e){o+=e.get("upVotes").length,u+=e.get("downVotes").length}),this.set({activeStatus:0,lastUpdated:Date.now(),activeSong:null,nextSong:null,listenersCount:0,listenersLoaded:!1,listeners:null,suggestions:null,approvedSuggestions:new n.Models.Collections.BroadcastSongs([]),blockedSuggestionSongIDs:null,totalUpVotes:o,totalDownVotes:u,cachedBroadcastSongs:{},cachedBroadcastSuggestions:{}});var a;_.each(i,function(e){a=n.Models.User.getCached(e),a&&a.get("currentBroadcastID")===t&&a.set({isOwnerOfCurrentBroadcast:0,currentBroadcastID:null})}),a=n.Models.Artist.getCached(s),a&&a.get("currentBroadcastID")==t&&a.set({isOwnerOfCurrentBroadcast:0,currentBroadcastID:null}),a=this.getOwner();var f=a?a.get("pageNameData"):null;f&&(f.BroadcastListens||(f.BroadcastListens=0),f.BroadcastListens+=this.get("totalListens")||0,a.resetEstimatedListens()),n.Models.Broadcast.broadcastsDeferreds[t]&&n.Models.Broadcast.broadcastsDeferreds[t].resolve(this)}else{var l={suggestions:null,approvedSuggestions:new n.Models.Collections.BroadcastSongs([]),blockedSuggestionSongIDs:null,nextSong:null,cachedBroadcastSongs:{},cachedBroadcastSuggestions:{}},c=this.get("activeSong");c&&(l.cachedBroadcastSongs[c.id]=c);if(!this.chatLocks||!this.chatLocks.length)l.chatActivities=null,l.persistentChatActivities=null;this.set(l)}this.stopOwnerLeftTimer()},startOwnerLeftTimer:function(){if(this.get("ownerLeftTimer"))return;var e=setTimeout(_.bind(function(){var e=r.model.get("player").get("currentQueue");if(!e||e.get("currentBroadcast")!==this)return;delete this.popupBroadcasterLeftNotif,n.Services.SWF.endBroadcast("broadcastOwnerEnded")},this),6e4);n.trigger("notification:add",{title:"",description:_.getString("POPUP_ERROR_BROADCASTER_LEFT"),url:this.toUrl(),duration:6e4,onOpened:_.bind(function(e){this.popupBroadcasterLeftNotif=e},this)});var t=new n.Models.ChatActivity({type:"info",infoType:n.Models.ChatActivity.BROADCASTER_BAILED});this.newChatActivity(t),this.set("ownerLeftTimer",e)},stopOwnerLeftTimer:function(e){var t=this.get("ownerLeftTimer");if(t){clearTimeout(t);if(e){this.popupBroadcasterLeftNotif&&(this.popupBroadcasterLeftNotif.close(),delete this.popupBroadcasterLeftNotif),n.trigger("notification:add",{title:"",description:_.getString("POPUP_ERROR_BROADCASTER_BACK"),url:this.toUrl()});var r=new n.Models.ChatActivity({type:"info",infoType:n.Models.ChatActivity.BROADCASTER_BACK});this.newChatActivity(r)}}},getHistory:function(){var e=$.Deferred();return this.get("historyLoaded")&&this.get("history")?e.resolve(this.get("history")):n.Services.API.getBroadcast(this.id).done(_.bind(function(t){if(this.get("historyLoaded")&&this.get("history")){e.resolve(this.get("history"));return}var r=[];if(t&&t.Songs&&t.PlayData){var i=s(t.Songs,t.PlayData,this.id);r=i.songs}var o=new n.Models.Collections.BroadcastSongs(r,{broadcastID:this.id,modelOptions:{dontCache:!0}});this.set({history:o,historyLoaded:!0}),e.resolve(o)},this)).fail(function(t){e.reject(t)}),e.promise()},getSongs:function(){return this.getHistory()},getUpdatedListenersCount:function(){var e=this._getUpdatedListenersCountDfd,t=this.attributes.BroadcastID;if(!e||e.state()!=="pending")e=$.Deferred(),this._getUpdatedListenersCountDfd=e;return n.Services.SWF.ready.done(function(){n.Services.SWF.connectToChat(),n.Services.SWF.chatReady.done(function(){n.Services.SWF.fetchBroadcastListenerCount(t)})}),e.promise()},toProxyLabel:function(){return _.getString("SELECTION_BROADCAST_SINGLE",{name:this.escape("Name")})},subscribeToChat:function(e,t){var r=this.id;(!this.chatLocks.length||t)&&n.Services.SWF.ready.done(function(){n.Services.SWF.connectToChat(),n.Services.SWF.chatReady.done(function(){n.Services.SWF.subscribeToBroadcastChat(r)})}),_.indexOf(this.chatLocks,e)===-1&&this.chatLocks.push(e)},unsubscribeFromChat:function(e){var t=_.indexOf(this.chatLocks,e);t>-1&&this.chatLocks.splice(t,1);if(!this.chatLocks.length){var r=this.id;n.Services.SWF.chatReady.done(function(){n.Services.SWF.unsubscribeFromBroadcastChat(r)})}},unsubscribeAllFromChat:function(){this.chatLocks=[];var e=this.id;n.Services.SWF.chatReady.done(function(){n.Services.SWF.unsubscribeFromBroadcastChat(e)})},inviteUserToTransferOwnership:function(e,t){function f(){o.reject({error:"ackTimeout"})}function l(){a&&clearTimeout(a),a=!1}function c(){o.reject({error:"cancel"})}function h(e){e&&e.success?(n.Services.SWF.currentBroadcastPrivateDispatch("inviteNewBroadcaster",{name:i},s),a=setTimeout(f,5e3)):o.reject({error:"publisherFailed"})}function p(t){var r=t&&t.success;r?(u||(u=new n.Models.Collections.Users([])),u.push(e),o.notify("invited")):o.reject({error:"inviteFailed"})}function d(t){if(t&&t.data&&t.data.accept&&t.userID==s){var r={u:!0,n:e.get("Name"),i:e.id,p:e.get("Picture")};n.Services.SWF.prepareForNewOwnerTransfer(s,r)}else o.reject({error:"rejected"})}function v(e){e&&e.userID==s&&(n.Services.SWF.broadcastRemoveOwner(e.userID),o.reject({error:"failed"}))}function m(e,i){o.resolve(),t?r.model.get("user").leaveBroadcast():n.router.setHash(e.toUrl())}var i=this.get("Name"),s=e.get("UserID"),o=$.Deferred();if(!this.isLoggedInUserOwner()||this.get("activeStatus")!==1)return o.reject({error:"invalid"}),o.promise();var u=this.get("invitedBroadcasters");if(u&&u.get(s))return o.reject({error:"duplicate"}),o.promise();var a=!1;n.once("broadcast:takeoverRequestAck",l),n.once("broadcast:cancelTakeOver",c),n.once("manatee:broadcastDispatch:inviteNewBroadcaster",p,this),n.once("manatee:newBroadcasterResponse",d),n.once("broadcast:renameForTakeOverFailed",v),n.once("manatee:broadcastTransferred",m),o.always(_.bind(function(){n.off("manatee:broadcastAddPublisher:"+s,h),n.off("manatee:broadcastDispatch:inviteNewBroadcaster",p,this),n.off("manatee:newBroadcasterResponse",d),n.off("manatee:broadcastTransferred",m),n.off("broadcast:cancelTakeOver",c),n.off("broadcast:takeoverRequestAck",l),n.off("broadcast:renameForTakeOverFailed",v),n.Services.SWF.broadcastRemovePublisher(s)},this));var g=this.get("publishersUsersIDs");return g&&_.indexOf(g,s)>-1?h({success:!0}):(n.once("manatee:broadcastAddPublisher:"+s,h),n.Services.SWF.broadcastAddPublisher(s)),o.promise()},addPersistentChatActivity:function(e){var r=this.get("persistentChatActivities");if(!r)r=new n.Models.Collections.ChatActivities(t,{silentCapping:!0,limit:100}),this.set("persistentChatActivities",r);else{var i;for(var s=0,o=r.models.length;s<o;s++){i=r.models[s];if(i.attributes.type===e.attributes.type&&i.attributes.infoType===e.attributes.infoType){if(s<o-1){var u=r.models.splice(s,1);u.push(e),r.reset(u)}return}}}r.add(e)},removePersistentChatActivity:function(e,t){var n=this.get("persistentChatActivities");if(!n)return;var r;for(var i=0,s=n.models.length;i<s;i++){r=n.models[i];if(r.attributes.type===e&&r.attributes.infoType===t){n.remove(r);return}}},end:function(){this.isLoggedInUserOwner()&&this.get("listenersCount")>1?n.trigger("lightbox:open","broadcastListeners",{broadcast:this,endBroadcast:!0}):n.Services.SWF.endBroadcast()},getDetailsForFeeds:function(){return{ArtistID:this.get("ArtistID"),UserID:this.get("UserID"),BroadcastID:this.get("BroadcastID"),Name:this.get("Name"),Tag:this.get("Tag"),Description:this.get("Description")}},cleanupSuggestionsCache:function(){var e=this.get("suggestions");if(!e)return;var t={};e.each(function(e){t[e.id]=e}),this.set("cachedBroadcastSuggestions",t)},handleSuggestionsChanges:function(e){var t=this.get("suggestions");if(!t)return;var r=this.get("cachedBroadcastSuggestions"),i=this.get("listeners"),s=[],o=!1,u,a,f,l;for(var c=0,h=e.length;c<h;c++){u=e[c];if(t.lastChangeID>=u.id)continue;u.s=_.toInt(u.s),u.b&&s.push(u.s),a=t.get(u.s),u.u=_.toInt(u.u);if(!u.a)a&&(u.u?(l=_.indexOf(a.attributes.upVotes,u.u),l>-1&&a.attributes.upVotes.splice(l,1),a.set("suggester",i.get(a.attributes.upVotes[0])),a.trigger("change",this,{}),a.trigger("change:upVotes",this,a.attributes.upVotes,{}),this.handleSuggestionsAction({songID:u.s,type:4,userID:u.u})):t.remove(a,{silent:!0}));else if(a)_.indexOf(a.attributes.upVotes,u.u)==-1&&(a.attributes.upVotes.push(u.u),a.set("suggester",i.get(a.attributes.upVotes[0])),a.trigger("change",this,{}),a.trigger("change:upVotes",this,a.attributes.upVotes,{}),this.handleSuggestionsAction({songID:u.s,type:0,userID:u.u}));else{if(!u.song){console.log("Cannot add suggestion that doesn't have a song object!");continue}a=new n.Models.BroadcastSuggestion(u.song.b,{dontCache:!0,broadcastListeners:i}),a.attributes.upVotes.push(u.u),a.set("suggester",i.get(a.attributes.upVotes[0])),t.add(a,{silent:!0}),r[u.s]=a,this.handleSuggestionsAction({songID:u.s,type:2,userID:u.u})}t.lastChangeID=u.id,o=!0}o&&t.sort()},handleSuggestionsAction:function(e){var t=r.model.get("player").get("currentQueue");if(!e||!t||t.get("currentBroadcast")!==this){console.log("Ignoring handleSuggestionsAction for broadcast that isn't active",e);return}var i=n.Models.Song.getCached(e.songID),s=n.getLoggedInUserID(),o=_.toInt(e.userID)==s,u=this.attributes.cachedBroadcastSuggestions[e.songID],a=this.get("listeners"),f;switch(e.type){case-1:u&&u.get("userVote")&&_.indexOf(u.get("upVotes"),s)===0&&n.trigger("notification:add",{type:"error",description:_.getString("POPUP_BROADCAST_SUGGESTION_REJECTED",{song:u.escape("SongName")}),url:this.toUrl(),duration:5e3});break;case 0:u&&(o?u.set("userVote",1):u.get("userVote")&&_.indexOf(u.get("upVotes"),s)===0&&n.trigger("notification:add",{icon:"upvote icon-upvote-white-active",type:"success",description:_.getString("POPUP_BROADCAST_SUGGESTION_VOTED",{song:u.escape("SongName")}),url:this.toUrl(),duration:5e3}));break;case 4:u&&o&&u.set("userVote",0);break;case 1:u?e.approvedSong&&n.Models.Song.replaceCacheAttributes(u._wrapped,e.approvedSong):(u=i,u?e.approvedSong&&n.Models.Song.replaceCacheAttributes(u,e.approvedSong):u=n.Models.Song.newOrUpdate(e.approvedSong,{dontCache:!0})),u&&this.suggestionApproved(u,e.userID);break;case 2:if(u){o&&(n.trigger("notification:add",{type:"success",description:_.getString("POPUP_BROADCAST_SUGGESTION_ADDED",{song:u.escape("SongName")}),url:this.toUrl(),duration:5e3}),u.set("userVote",1)),f=a&&a.get(e.userID)||n.Models.User.getCached(e.userID);if(f){this.suggestionAdded(u,f);var l=r.page.getCurrentPageView();(!l||!l.broadcastView||l.broadcastView.model.get("broadcast")!==this)&&!o&&n.trigger("broadcast:notifEvent",this)}}break;case 3:case 7:if(o){var c=e.type==3?"POPUP_BROADCAST_SUGGESTION_REJECTED_PLAYED":"POPUP_BROADCAST_SUGGESTION_REJECTED_PLAY_LATER";n.trigger("notification:add",{description:_.getString(c),type:"error",url:this.toUrl(),duration:5e3})}break;case 6:o&&n.trigger("notification:add",{description:_.getString("POPUP_BROADCAST_SUGGESTION_REJECTED_FULL"),type:"error",url:this.toUrl(),duration:5e3});break;case 8:o&&n.trigger("notification:add",{description:_.getString("POPUP_BROADCAST_SUGGESTION_REJECTED_PERCENT_FULL"),type:"error",url:this.toUrl(),duration:5e3})}},handleVIPRequestResponse:function(e){if(!this.isLoggedInUserOwner()&&!this.isUserVIP(n.getLoggedInUserID()))return;var t=this.get("listeners"),r=e.sender&&t&&t.get(e.sender.userID)||n.Models.User.getCached(e.sender.userID),i=r&&n.getLoggedInUserID()===r.get("UserID"),s,o,u;if(!r||!i&&!this.isLoggedInUserOwner())return;e.song||e.callout?s=new n.Models.Song(n.Models.Song.convertManateeSongCalloutProperties(e.song||e.callout),{dontCache:!0}):e.songID&&(s=n.Models.Song.getCached(e.songID));if(!s)return;e.resultKey.indexOf("addSuggestion")>=0?i?o={description:_.getString("VIP_POPUP_SUGGESTION_APPROVED",{song:s.escape("SongName")})}:u={infoType:n.Models.ChatActivity.SONG_ADDED_BY_VIP}:e.resultKey.indexOf("approveSuggestion")>=0?i?o={description:_.getString("VIP_POPUP_SUGGESTION_APPROVED",{song:s.escape("SongName")})}:u={infoType:n.Models.ChatActivity.SONG_ADDED_BY_VIP}:e.resultKey.indexOf("rejectSuggestion")>=0?i?o={description:_.getString("VIP_POPUP_SUGGESTION_REJECTED",{song:s.escape("SongName")})}:u={infoType:n.Models.ChatActivity.SONG_REJECTED_BY_VIP}:e.resultKey.indexOf("addCallout")>=0&&(i?o={description:_.getString("VIP_POPUP_CALLOUT_ADDED_QUEUE")}:u={infoType:n.Models.ChatActivity.CALLOUT_ADDED_BY_VIP}),o&&n.trigger("notification:add",_.defaults(o,{icon:"note icon-note-white-active",type:"success"})),u&&this.newChatActivity(new n.Models.ChatActivity(_.defaults(u,{type:"info",song:s,user:r})))},onMainAttrChange:function(e){e.changed.Name&&n.trigger("guts:log","broadcastNameChanged",{newName:e.changed.Name,broadcastID:e.get("BroadcastID")}),e.changed.Description&&n.trigger("guts:log","broadcastDescriptionChanged",{newText:e.changed.Description,broadcastID:e.get("BroadcastID")}),e.changed.Tag&&n.trigger("guts:log","broadcastDescriptionChanged",{newTagID:e.changed.Tag.i,broadcastID:e.get("BroadcastID")})},getLoggedInListenerCount:function(){var e=this.get("listeners");return e&&e.length||0},getLoggedOutListenerCount:function(){var e=this.get("listenersCount")||0;return Math.max(e-this.getLoggedInListenerCount(),0)},handleSongCached:function(e,t){var n=this.get("activeSong"),r=this.get("nextSong"),i=this.get("history"),s=this.get("suggestions"),o=this.get("chatActivities");n&&n.get("SongID")==e&&n.replaceWrapped(t),r&&r.get("SongID")==e&&r.replaceWrapped(t),i&&i.length&&i.replaceWrappedModelByID(t),s&&s.length&&s.get(e)&&s.replaceWrappedModelByID(t);if(o){var u;for(var a=0,f=o.length;a<f;a++)u=o.at(a),u&&(u.attributes.song||u.attributes.songs)&&u.replaceSong(t)}},handleUserCached:function(e,t){var r=this.get("listeners"),i=this.get("chatActivities"),s=this.get("ownerModel");r&&r.length&&r.replaceModelByID(t);if(i){var o;for(var u=0,a=i.length;u<a;u++)o=i.at(u),o&&(o.attributes.user||o.attributes.users)&&o.replaceUser(t)}s instanceof n.Models.User&&s.id==e&&this.set("ownerModel",t)}},{artPath:"http://images.gs-cdn.net/static/broadcasts/",cachedListenerCounts:{},broadcastIDToTags:{},broadcastsByTagsDeferreds:{},broadcastsDeferreds:{},MAX_VIPS:5,VIP_PERM_AUTO_APPROVE:1,VIP_PERM_SUGGESTIONS:2,VIP_PERM_CHAT_MODERATE:4,VIP_PERM_METADATA:8,VIP_PERM_FEATURES:16,VIP_PERM_CALLOUTS:32,get:function(e,t){var r=$.Deferred();return this._cache&&this._cache.hasOwnProperty(e)?r.resolve(this._cache[e]):n.Services.API.getBroadcast(e).done(function(e){e&&e.BroadcastID?(e.Songs||(e.Songs=[]),r.resolve(n.Models.Broadcast.newOrUpdate(e,$.extend({source:"db"},t)))):r.reject(e)}).fail(function(e){r.reject(e)}),r.promise()},getLatestIncrementedCached:function(e){return e===null||e===t||!this._cache?null:b[e]&&this._cache.hasOwnProperty(b[e])?this._cache[b[e]]:this._cache.hasOwnProperty(e)?this._cache[e]:null},fetchRealtimeBroadcast:function(e,t,i,s){var o=n.Models.Broadcast.getCached(e),u=r.model.get("player").get("currentQueue"),a=u?u.get("currentBroadcast"):null,f=Date.now();if(!o||t||a!==o&&(f-o.get("lastUpdated")>3e4||!o.get("listenersLoaded")&&!i)){if(!t&&n.Models.Broadcast.broadcastsDeferreds[e]&&n.Models.Broadcast.broadcastsDeferreds[e].state()==="pending")return s&&n.Services.SWF.ready.done(function(){c(),n.Services.SWF.subscribeToBroadcastsStatuses([e])}),n.Models.Broadcast.broadcastsDeferreds[e].promise();var l;if(!n.Models.Broadcast.broadcastsDeferreds[e]||n.Models.Broadcast.broadcastsDeferreds[e].state()!=="pending")n.Models.Broadcast.broadcastsDeferreds[e]=$.Deferred();l=n.Models.Broadcast.broadcastsDeferreds[e],n.Services.SWF.ready.done(function(){c(),s?n.Services.SWF.subscribeToBroadcastsStatuses([e]):n.Services.SWF.getBroadcastInfo(e),i?n.Services.SWF.fetchBroadcastListenerCount(e):(o&&o.set("listenersLoaded",!1),n.Services.SWF.getBroadcastListeners(e)),l.timeout&&(clearTimeout(l.timeout),l.timeout=null),l.timeout=setTimeout(function(){l.reject()},7e3),l.always(function(){l.timeout&&(clearTimeout(l.timeout),l.timeout=null)})})}else{if(!n.Models.Broadcast.broadcastsDeferreds[e]||n.Models.Broadcast.broadcastsDeferreds[e].state()!=="pending")n.Models.Broadcast.broadcastsDeferreds[e]=$.Deferred(),n.Models.Broadcast.broadcastsDeferreds[e].resolve(o,e);s&&n.Services.SWF.ready.done(function(){c(),n.Services.SWF.subscribeToBroadcastsStatuses([e])}),n.trigger("manatee:broadcastInfo",o,e,!0)}return n.Models.Broadcast.broadcastsDeferreds[e].promise()},fetchRealtimeBroadcastListeners:function(e){var t=n.Models.Broadcast.getCached(e);t&&t.set("listenersLoaded",!1),n.Services.SWF.ready.done(function(){c(),n.Services.SWF.getBroadcastListeners(e)})},fetchRealtimeBroadcasts:function(e,t,r){var i=[],s=[],o=[];return _.each(e,function(e){var t=n.Models.Broadcast.getCached(e),u=Date.now();if(!t||r||u-t.get("lastUpdated")>3e4||!t.get("listenersLoaded")){if(!r&&n.Models.Broadcast.broadcastsDeferreds[e]&&n.Models.Broadcast.broadcastsDeferreds[e].state()==="pending"){i.push(n.Models.Broadcast.broadcastsDeferreds[e].promise());return}if(!n.Models.Broadcast.broadcastsDeferreds[e]||n.Models.Broadcast.broadcastsDeferreds[e].state()!=="pending")n.Models.Broadcast.broadcastsDeferreds[e]=$.Deferred();s.push(e)}else{if(!n.Models.Broadcast.broadcastsDeferreds[e]||n.Models.Broadcast.broadcastsDeferreds[e].state()!=="pending")n.Models.Broadcast.broadcastsDeferreds[e]=$.Deferred(),n.Models.Broadcast.broadcastsDeferreds[e].resolve(t,e);o.push(t),n.trigger("manatee:broadcastInfo",t,e)}i.push(n.Models.Broadcast.broadcastsDeferreds[e].promise())}),o.length&&n.trigger("manatee:broadcastsInfo",o),s.length&&n.Services.SWF.ready.done(function(){c(),n.Services.SWF.fetchBroadcastsInfo(s,t)}),$.after(i)},recentSort:function(e,t){return _.orEqual(t.get("TSCreated"),0)-_.orEqual(e.get("TSCreated"),0)},storeListenersInCache:function(e,t,r){var i=n.Models.Broadcast.cachedListenerCounts[e];i?(t&&(i.users=t),r&&(i.count=r)):n.Models.Broadcast.cachedListenerCounts[e]={users:t,count:r}},restoreListenersFromCache:function(e){var t=e.id;if(e.get("listenersLoaded")){delete n.Models.Broadcast.cachedListenerCounts[t];return}var r=n.Models.Broadcast.cachedListenerCounts[t];if(!r){var i=t.split(":");if(i.length!=2)return;t=i[0],r=n.Models.Broadcast.cachedListenerCounts[t];if(!r)return}r.users&&e.setListeners(r.users),r.count&&e.set("listenersCount",r.count),delete n.Models.Broadcast.cachedListenerCounts[t]},getBroadcastsForTag:function(e){e||(e="bcast");if(n.Models.Broadcast.broadcastsByTagsDeferreds[e])return n.Models.Broadcast.broadcastsByTagsDeferreds[e];var t=$.Deferred();return t.__broadcasts=[],n.Models.Broadcast.broadcastsByTagsDeferreds[e]=t,c(),n.Services.SWF.ready.done(function(){n.Services.SWF.fetchSubsByTags([e],"desc",100)}),t},cleanupDataFromMemcache:function(e){var t=(e.sub||"").replace("bcast:",""),r,i,s,o;e.users&&e.users.length&&(i=n.Models.User.newOrUpdate(e.users[0],{dontCache:!0})),e.artists&&e.artists.length&&(r=n.Models.Artist.newOrUpdate(e.artists[0],{dontCache:!0}));var u=n.Models.Song.convertManateeSongCalloutProperties(e.s&&e.s.active);return u&&(u.broadcastSongID=[t,":",u.queueSongID].join(""),u.isActiveSong=!0,u=new n.Models.BroadcastSong(u,{dontCache:!0})),{BroadcastID:t,Name:e.n,Tag:e.t,isPlaying:e.py,Image:e.i,totalListens:e.tl,ownerUserIDs:e.ownerUserIDs,ownerArtistID:e.ownerArtistID,ownerSubscribed:e.owner_subscribed,listenersCount:e.subscribers_count,ownerUser:i,ownerArtist:r,tallies:e.tallies||{old_tallies:{},new_tallies:{}},activeSong:u}},getTopBroadcastsForTags:function(t){var r=$.Deferred(),i=n.Services.API.getTopBroadcasts(t);return i.done(function(t){var i={};_.each(t,function(t,r){var s=[],o=Date.now()+e.clientTimeDivergence;_.each(t,function(e){if(e.s&&e.s.ts&&e.s.ts+72e4<o){console.log("rejected bcast too old",e);return}if(!e.sub)return;s.push(n.Models.Broadcast.cleanupDataFromMemcache(e))}),i[r]=s}),r.resolve(i)}),r},getTopBroadcastsCombined:function(t){var r=$.Deferred(),i=n.Services.API.getTopBroadcastsCombinedEx(t);return i.done(function(t){var i=[],s=[],o={},u=Date.now()+e.clientTimeDivergence;_.each(t.all,function(e){if(e.s&&e.s.ts&&e.s.ts+72e4<u){console.log("rejected bcast too old",e);return}if(!e.sub)return;i.push(n.Models.Broadcast.cleanupDataFromMemcache(e))}),_.each(t.events,function(e){if(!e.EventID)return;s.push(e)}),r.resolve(i,s)}),r},getBroadcastImageURL:function(e,t){return n.Models.Broadcast.artPath+t+"_"+e},convertManateeProperties:function(e){return e?{BroadcastID:e.bID,Name:e.n,ArtistID:e.aID,UserID:e.uID,Tag:e.t,Description:e.d,Privacy:e.pr,Image:e.im,ParentBroadcastID:e.pbID,IsRandomName:e.ir,Subscribers:e.s,PeakSubscribers:e.ps,TSCreated:e.ts}:t},storeBroadcastNotFound:function(e){y[e]=1,n.Models.Broadcast.broadcastsDeferreds[e]&&n.Models.Broadcast.broadcastsDeferreds[e].reject()}})}(),function(){n.Models=n.Models||{};var e=1,t=Math.pow(10,12);n.Models.ChatActivity=Backbone.Model.extend({idAttribute:"ChatActivityID",parse:function(r,i){var s=i&&i.clone===!1?r:_.clone(r);s.ChatActivityID=e++,s.timestamp?s.timestamp/t<1&&(s.timestamp*=1e3):s.timestamp=Date.now(),this.messageCache={};switch(s.infoType){case n.Models.ChatActivity.LEFT_BROADCAST:s.iconClass="user icon-user-remove-gray-flat";break;case n.Models.ChatActivity.JOINED_BROADCAST:s.iconClass="user icon-user-add-gray-flat";break;case n.Models.ChatActivity.JOINED_LEFT_BROADCAST:s.iconClass="user icon-user-remove-gray-flat";break;case n.Models.ChatActivity.LEFT_JOINED_BROADCAST:s.iconClass="user icon-user-add-gray-flat";break;case n.Models.ChatActivity.SUGGESTION_APPROVED:s.iconClass="upvote icon-upvote-color-flat"}if(s.type==="message"&&!s.specialFlag&&s.user&&!s.ignoreTag){var o=s.user.get("UserID");n.Models.Comment.ADMINS[o]?s.specialFlag="admin":n.Models.ChatActivity.DEVTagUserIDs[o]&&(s.specialFlag="gsdev")}return s},merge:function(e){if(this.get("type")!=="info")return!1;var t=this.get("infoType"),r=e.get("infoType"),i=this.get("users"),s=e.get("users"),o=t!==r,u=!1,a=null;switch(t){case n.Models.ChatActivity.LEFT_JOINED_BROADCAST:case n.Models.ChatActivity.JOINED_LEFT_BROADCAST:if(r===n.Models.ChatActivity.JOINED_BROADCAST||r===n.Models.ChatActivity.LEFT_BROADCAST)if(s.length===1&&i.length===1&&s.at(0)===i.at(0)){a={infoType:r};break}return!1;case n.Models.ChatActivity.SONG_ADDED_BY_VIP:if(!!o||this.get("user")!==e.get("user"))return!1;a={songs:[this.get("song"),e.get("song")],infoType:n.Models.ChatActivity.SONGS_ADDED_BY_VIP,song:null};break;case n.Models.ChatActivity.SONGS_ADDED_BY_VIP:if(!o||r!==n.Models.ChatActivity.SONG_ADDED_BY_VIP||this.get("user")!==e.get("user"))return!1;this.get("songs").push(e.get("song")),a={_update:Date.now()};break;case n.Models.ChatActivity.LEFT_BROADCAST:case n.Models.ChatActivity.JOINED_BROADCAST:if(o){if((r===n.Models.ChatActivity.JOINED_BROADCAST||r===n.Models.ChatActivity.LEFT_BROADCAST)&&s.length===1){var f=s.at(0),l=i.get(f.get("UserID"));if(l&&i.length>1){i.remove(f,{slient:!0}),a={_update:Date.now()},u=!0,r===n.Models.ChatActivity.JOINED_BROADCAST?e.set("infoType",n.Models.ChatActivity.LEFT_JOINED_BROADCAST):e.set("infoType",n.Models.ChatActivity.JOINED_LEFT_BROADCAST);break}if(l){r===n.Models.ChatActivity.JOINED_BROADCAST?a={infoType:n.Models.ChatActivity.LEFT_JOINED_BROADCAST}:a={infoType:n.Models.ChatActivity.JOINED_LEFT_BROADCAST};break}}return!1}s&&s.length<3&&(i.add(s.models,{at:0}),a={_update:Date.now()});break;default:return!1}return this.messageCache&&(this.messageCache={}),a&&this.set(a),u?!1:(n.trigger("chat:mergeDone"),!0)},getText:function(){var e=_.makeSafeLinks(this.get("message"))||this.messageCache[r.model.get("locale")];if(e)return e;var t="",i,s,o,u,a;switch(this.get("infoType")){case n.Models.ChatActivity.LEFT_BROADCAST:i=this.get("users").map(function(e){return e.getAnchorTag(null,null,!0)}),t=i.join(", "),e=_.getString("CHAT_BROADCAST_LEFT",{users:t});break;case n.Models.ChatActivity.JOINED_BROADCAST:i=this.get("users").map(function(e){return e.getAnchorTag(null,null,!0)}),t=i.join(", "),e=_.getString("CHAT_BROADCAST_JOINED",{users:t});break;case n.Models.ChatActivity.JOINED_LEFT_BROADCAST:i=this.get("users").map(function(e){return e.getAnchorTag(null,null,!0)}),t=i.join(", "),e=_.getString("CHAT_BROADCAST_JOINED_LEFT",{users:t});break;case n.Models.ChatActivity.LEFT_JOINED_BROADCAST:i=this.get("users").map(function(e){return e.getAnchorTag(null,null,!0)}),t=i.join(", "),e=_.getString("CHAT_BROADCAST_LEFT_JOINED",{users:t});break;case n.Models.ChatActivity.SUGGESTION_APPROVED:s=this.get("song"),o=this.get("user"),o?e=_.getString("SUGGESTION_APPROVED_BY_USER",{user:o.getAnchorTag(null,null,!0)}):e=_.getString("SUGGESTION_APPROVED"),e+="<br>"+_.getString("QUEUE_CURRENT_SONG_NO_ALBUM",{song:s.getAnchorTag(null,null,"no-title-tooltip"),artist:s.getArtistAnchorTag()});break;case n.Models.ChatActivity.SUGGESTION_ADDED:s=this.get("song"),o=this.get("user"),e=_.getString("USER_SUGGESTED_A_SONG",{user:o.getAnchorTag(null,null,!0),song:_.getString("QUEUE_CURRENT_SONG_NO_ALBUM",{song:s.getAnchorTag(null,null,"no-title-tooltip"),artist:s.getArtistAnchorTag()})});break;case n.Models.ChatActivity.BROADCASTER_BAILED:e=_.getString("CHAT_BROADCASTER_BAILED");break;case n.Models.ChatActivity.BROADCASTER_BACK:e=_.getString("CHAT_BROADCASTER_BACK");break;case n.Models.ChatActivity.WELCOME_MESSAGE:o=this.get("user"),u=this.get("artist"),a=o&&o.escape("Name")||u&&u.escape("ArtistName"),e=_.getString("CHAT_WELCOME_MESSAGE",{name:a});break;case n.Models.ChatActivity.CHAT_INVITE_FOLLOWERS:e=_.getString("CHAT_INVITE_FOLLOWERS");break;case n.Models.ChatActivity.BROADCASTER_INVITE_FOLLOWERS:e=_.getString("BROADCASTER_INVITE_FOLLOWERS");break;case n.Models.ChatActivity.CHAT_DISABLED:e=_.getString("CHAT_DISABLED");break;case n.Models.ChatActivity.CHAT_DISABLED_OWNER:e=_.getString("CHAT_DISABLED_OWNER");break;case n.Models.ChatActivity.CHAT_FAILED:e=_.getString("CHAT_FAILED");break;case n.Models.ChatActivity.RATE_LIMITED:e=_.getString("CHAT_RATE_LIMITED");break;case n.Models.ChatActivity.NEW_BROADCAST_OWNER:o=this.get("owner"),e=_.getString("NEW_BROADCASTER_MESSAGE",{user:o&&o.escape("Name")});break;case n.Models.ChatActivity.SONG_CHANGED:s=this.get("song"),e=_.getString("CHAT_NOW_PLAYING",{song:s.getAnchorTag(null,null,"no-title-tooltip"),artist:s.getArtistAnchorTag()});break;case n.Models.ChatActivity.OFFLINE_CANT_CHAT:e=_.getString("CHAT_OFFLINE_CANT_CHAT");break;case n.Models.ChatActivity.VISIBILITY_FRIENDS_WARNING:e=_.getString("CHAT_VISIBILITY_FRIENDS_WARNING");break;case n.Models.ChatActivity.YOU_ARE_VIP:e=_.getString("CHAT_YOU_ARE_VIP");break;case n.Models.ChatActivity.NO_LONGER_VIP:e=_.getString("CHAT_NO_LONGER_VIP");break;case n.Models.ChatActivity.VIP_ADDED:o=this.get("user"),e=_.getString("CHAT_VIP_ADDED",{user:o&&o.escape("Name")});break;case n.Models.ChatActivity.SONG_ADDED_BY_VIP:s=this.get("song"),o=this.get("user"),e=_.getString("VIP_ADDED_A_SONG",{user:o.getAnchorTag(null,null,!0),song:_.getString("QUEUE_CURRENT_SONG_NO_ALBUM",{song:s.getAnchorTag(null,null,"no-title-tooltip"),artist:s.getArtistAnchorTag()})});break;case n.Models.ChatActivity.SONGS_ADDED_BY_VIP:o=this.get("user"),e=_.getString("VIP_ADDED_SONGS",{user:o.getAnchorTag(null,null,!0),num:_.orEqual(this.get("songs"),[]).length});break;case n.Models.ChatActivity.SONG_REJECTED_BY_VIP:s=this.get("song"),o=this.get("user"),e=_.getString("VIP_REJECTED_SONG",{user:o.getAnchorTag(null,null,!0),song:_.getString("QUEUE_CURRENT_SONG_NO_ALBUM",{song:s.getAnchorTag(null,null,"no-title-tooltip"),artist:s.getArtistAnchorTag()})});break;case n.Models.ChatActivity.CALLOUT_ADDED_BY_VIP:s=this.get("song"),o=this.get("user"),e=_.getString("VIP_ADDED_CALLOUT",{user:o.getAnchorTag(null,null,!0),callout:s.escape("SongName")})}return this.messageCache||(this.messageCache={}),this.messageCache[r.model.get("locale")]=e,e},getModelToFavorite:function(e){return e==="User"?this.get("user"):null},getFormattedTimestamp:function(){var e=this.get("timestamp"),t=Date.now();if(t-e<=6e4)return _.getString("NUM_SECONDS_AGO",{seconds:Math.floor((t-e)/1e3)});if(t-e<54e5)return _.getString("MINUTES_AGO",{minutes:Math.floor((t-e)/6e4)});if(t-e<864e5){var n=Math.floor((t-e)/36e5);return n>1?_.getString("HOURS_AGO",{hours:n}):_.getString("HOUR_AGO")}var r=new Date;return r.setTime(e),_.getString("OVER_A_WEEK_AGO",{day:_.getString("WEEK_DAYS").split(",")[r.getDay()],date:_.getString("MONTHS").split(",")[r.getMonth()]+" "+r.getDate()+", "+r.getFullYear()})},replaceUser:function(e){var t=this.get("user");if(t){if(e===t||e.id!=t.id)return;this.set("user",e);return}var n=this.get("users");if(!n)return;n.replaceModelByID(e)},replaceSong:function(e){var t=this.get("song"),n=!1;if(t){if(t instanceof Backbone.MagicModelWrapper){if(e===t._wrapped||e.id!=t._wrapped.id)return;t.replaceWrapped(e)}else{if(e===t||e.id!=t.id)return;this.set("song",e)}return}var r=this.get("songs");if(!r)return;r instanceof Backbone.WrappedModelCollection?r.replaceWrappedModelByID(e):r.replaceModelByID(e)}},{LEFT_BROADCAST:"leftBroadcast",JOINED_BROADCAST:"joinedBroadcast",JOINED_LEFT_BROADCAST:"joinedLeftBroadcast",LEFT_JOINED_BROADCAST:"leftJoinedBroadcast",SUGGESTION_APPROVED:"suggestionApproved",SUGGESTION_ADDED:"suggestionAdded",BROADCASTER_BAILED:"broadcasterBail",BROADCASTER_BACK:"broadcasterBack",WELCOME_MESSAGE:"welcomeMessage",CHAT_INVITE_FOLLOWERS:"inviteUserFollowers",BROADCASTER_INVITE_FOLLOWERS:"inviteBroadcasterFollowers",CHAT_DISABLED:"chatDisabled",CHAT_DISABLED_OWNER:"chatDisabledOwner",RATE_LIMITED:"rateLimited",NEW_BROADCAST_OWNER:"newBroadcastOwner",SONG_CHANGED:"songChange",CHAT_FAILED:"chatFailed",OFFLINE_CANT_CHAT:"offlineCantChat",VISIBILITY_FRIENDS_WARNING:"visibilityFriendsWarning",YOU_ARE_VIP:"youAreVIP",NO_LONGER_VIP:"noLongerVIP",VIP_ADDED:"vipAdded",SONG_ADDED_BY_VIP:"songAddedByVIP",SONGS_ADDED_BY_VIP:"songsAddedByVIP",SONG_REJECTED_BY_VIP:"songRejectedByVIP",CALLOUT_ADDED_BY_VIP:"calloutAddedByVIP",DEVTagUserIDs:{15:1,30:1,42:1,352:1,3879:1,23523:1,699759:1,788921:1,1386918:1,1781485:1,1971003:1,2376844:1,2585425:1,3247909:1,6836686:1,8819905:1,8888852:1,9112752:1,13968140:1,17638985:1,19533446:1}})}(),function(){n.Models=n.Models||{},n.Models.Callout=Backbone.CachedModel.extend({idAttribute:"CalloutID",parse:function(e,n){var r=e.Name||e.SongName,i=_.toInt(e.UserID||n&&n.user&&n.user.id),s={CalloutID:_.toInt(e.CalloutID),Name:r,SongName:r,UserID:i,FileID:_.defined(e.FileID)?_.toInt(e.FileID):t,Flags:_.defined(e.Flags)?_.toInt(e.Flags):t,EstimateDuration:e.EstimateDuration||_.defined(e.uSecs)?e.uSecs/1e6:t,uploaded:_.defined(e.uploaded)?e.uploaded:!0,transcoded:_.defined(e.transcoded)?e.transcoded:!0,uploadPercent:e.uploadPercent,ArtistName:e.ArtistName||(n&&n.user&&n.user.id==i?n.user.get("Name"):t)};return s},toUrl:function(){return null},toArtistUrl:function(){var e=this.get("UserID"),t=e&&n.Models.User.getCached(e);return t?t.toUrl():e?_.cleanUrl(this.get("ArtistName"),e,"profile"):null},toAlbumUrl:function(){return null},getToken:function(){},getDetailsForFeeds:function(){return null},toProxyLabel:function(){return _.getString("SELECTION_CALLOUT_SINGLE",{name:this.escape("Name")})},getAnchorTag:function(){return""},getArtistAnchorTag:function(){return""},getDetailsForSwf:function(){var e=/\u0000/g;return{CalloutID:this.get("CalloutID"),SongID:0,isCallout:!0,SongName:this.get("Name").replace(e,""),AlbumID:0,AlbumName:"",ArtistID:0,UserID:this.get("UserID"),ArtistName:this.get("ArtistName")||"",Flags:this.get("Flags"),EstimateDuration:this.get("EstimateDuration")}},getImageURL:function(e){return e=_.orEqual(e,70),n.Models.Callout.artPath+e+"_album.png"},set:function(e,t){return _.isString(e)&&e=="Name"?e={Name:t,SongName:t}:e.hasOwnProperty("Name")&&(e.SongName=e.Name),Backbone.CachedModel.prototype.set.apply(this,_.toArray(arguments))},deleteCallout:function(){return n.Services.API.deleteCallout(this.id).done(_.bind(function(){this.constructor.uncache(this.id)},this))}},{artPath:"http://images.gs-cdn.net/static/albums/",setupCalloutListeners:function(){n.on("callouts:uploadStarted",this.onUploadStarted,this),n.on("callouts:uploadComplete",this.onUploadComplete,this),n.on("callouts:uploadFailed",this.onUploadFailed,this),n.on("manatee:calloutResponse",this.onTranscodeComplete,this)},onUploadStarted:function(e){var t=r.model.get("user"),n=new this({CalloutID:-1*e.tempID,Name:e.Name,EstimateDuration:_.toInt(e.EstimateDuration),uploaded:!1,uploadPercent:0,transcoded:!1},{user:t});t.getCallouts().done(function(e){n.get("uploadFailed")||e.add(n,{at:0})});var i=setInterval(function(){var e=n.get("uploadPercent");e<40&&!n.get("uploadFailed")?n.set("uploadPercent",e+.33):(n.unset("uploadTimer"),clearTimeout(i))},30);n.set("uploadTimer",i)},onUploadComplete:function(e){var t=-1*e.tempID,r=this.getCached(t);r&&(this.uncache(r),r.set({uploaded:!0,uploadPercent:75,CalloutID:e.realID}),this.cache(r),n.Services.API.updateCalloutDetails(e.realID,r.get("Name")))},onUploadFailed:function(e){var t=-1*e.tempID,i=this.getCached(t),s=r.model.get("user");i&&(this.uncache(i),s&&i.get("UserID")==s.get("UserID")&&(i.set("uploadFailed",!0),s.get("callouts")&&s.get("callouts").remove(i),n.trigger("notification:add",{title:_.getString("CALLOUT_UPLOAD_FAILED",{callout:i.escape("Name")}),type:"error"})))},onTranscodeComplete:function(e){if(!e||e.error)return this.onTranscodeFailed(e);var t=e.callout.CalloutID,r=this.getCached(t);r&&(r.set({uploaded:!0,uploadPercent:100}),setTimeout(function(){r.set({transcoded:!0})},330),r.get("UserID")==n.getLoggedInUserID()&&n.trigger("notification:add",{title:_.getString("CALLOUT_SUCCESS",{callout:r.escape("Name")}),type:"success"}))},onTranscodeFailed:function(e){var t=e.CalloutID,i=this.getCached(t),s=r.model.get("user");i&&(this.uncache(i),s&&i.get("UserID")==s.get("UserID")&&(s.get("callouts")&&s.get("callouts").remove(i),n.trigger("notification:add",{title:_.getString("CALLOUT_TRANSCODE_FAILED",{callout:i.escape("Name")}),type:"error"})))},get:function(e){var t=Backbone.CachedModel.genericGet.call(this,n.Services.API.getCallout,"CalloutID",e);return t.promise()}})}(),function(){n.Models=n.Models||{};var e=function(e,t){return e.id<t.id?1:e.id>t.id?-1:0},r=function(e,t){return e.id>t.id?1:e.id<t.id?-1:0},i=function(e,t){return e.attributes.timestamp<t.attributes.timestamp?1:e.attributes.timestamp>t.attributes.timestamp?-1:0},s=function(e,t){t?t=Math.min(t,this.models.length):t=this.models.length;var n=[],r=e.get("artistID"),i;for(var s=0,o=this.models.length,u=0;s<o&&u<t;s++)if(!this.models[s].attributes.forArtistID||this.models[s].attributes.forArtistID==r)i=this.models[s].getNormalizedObject(e),i&&(n.push(i),u++);return n},o=function(e){var r=0;e>=25&&e<75?r=1:e>25&&(r=Math.max(Math.floor((e-25)/50)+1,1));var i=_.orEqual(this.loadedTypeID,this.at(0).get("TypeID")),s=_.orEqual(this.loadedItemID,this.at(0).get("ItemID")),o=this,u=$.Deferred();return n.Models.Comment.loadCommentsItemType(s,i,r).done(function(e){e&&e.models?u.resolve(e.models,t,e===o):u.reject()}).fail(_.bind(u.reject,u)),u.promise()},u=function(e,t,r){var i=$.Deferred();switch(r.feedType){case"community":r.user?r.user.loadCommunityFeed(!0).done(function(e,t){i.resolve(t)}).fail(_.bind(i.reject,i)):i.reject();break;case"model":r.ownerModel?r.ownerModel.getFeed(!0).done(function(e,t){i.resolve(t)}).fail(_.bind(i.reject,i)):i.reject();break;case"interesting":n.Services.API.getInterestingEvents(50).done(function(e){i.resolve(e,!1)}).fail(_.bind(i.reject,i));break;default:i.reject()}return i.promise()},a=function(e){console.log("unsubscribing from",e),n.Services.SWF.ready.done(_.bind(function(){n.Services.SWF.unsubscribeFromBroadcastsStatuses(e,this.subscribedKeys)},this))},f={model:n.Models.Broadcast,subscribed:!1,initialize:function(){this.toUnsubscribe=[],this.subscribeDebounce=_.debounce(_.bind(function(){this.subscribed&&this.subscribe()},this),150),this.unsubscribeBroadcastIDsDebounce=_.debounce(_.bind(function(){var e=_.pluck(this.toUnsubscribe.splice(0,this.toUnsubscribe.length),"id");a.call(this,e)},this),150)},setSubscribedKeys:function(e){return this.subscribed?!1:(this.subscribedKeys=e,!0)},subscribe:function(){if(!this.subscribedKeys||!this.subscribedKeys.length)return!1;var e=this.pluck("BroadcastID");return n.Services.SWF.ready.done(_.bind(function(){n.Services.SWF.subscribeToBroadcastsStatuses(e,this.subscribedKeys),this.subscribed=!0,this.on("add",this.onSubscribedAdd,this),this.on("remove",this.onSubscribedRemove,this)},this)),!0},onSubscribedAdd:function(){this.subscribeDebounce()},onSubscribedRemove:function(e){this.toUnsubscribe.push(e),this.unsubscribeBroadcastIDsDebounce()},unsubscribe:function(){if(!this.subscribedKeys||!this.subscribedKeys.length)return!1;var e=this.pluck("BroadcastID");return n.Services.SWF.ready.done(_.bind(function(){n.Services.SWF.unsubscribeFromBroadcastsStatuses(e,this.subscribedKeys)},this)),this.subscribed=!1,this.off("add",this.onSubscribedAdd),this.off("remove",this.onSubscribedRemove),!0},filterBestBroadcasts:function(){this.reset(this.filter(function(e){return gsConfig.filterBroadcastsByListenersCount&&e.attributes.listenersCount>gsConfig.filterBroadcastsByListenersCount?!1:e.attributes.ownerSubscribed&&e.attributes.isPlaying!==!1&&e.attributes.activeStatus!=0}))},sortByListeners:function(){this.comparator=function(e){return e.attributes.listenersCount*-1},this.sort()},getForTag:function(e){return this.filter(function(t){var n=t.get("Tag");return n&&n.i==e})}},l=function(e){return this.get([this.options.broadcastID,":",e].join(""))};n.Models.Collections={Songs:Backbone.CachedModelCollection.extend({model:n.Models.Song},{}),BroadcastSongs:Backbone.WrappedModelCollection.extend({model:n.Models.BroadcastSong,initialize:function(e,t){this.options=t},getByQueueSongID:l},{}),QueueSongs:Backbone.WrappedModelCollection.extend({model:n.Models.QueueSong},{}),PlaylistSongs:Backbone.WrappedModelCollection.extend({model:n.Models.PlaylistSong},{}),BroadcastSuggestions:Backbone.WrappedModelCollection.extend({model:n.Models.BroadcastSuggestion},{}),Artists:Backbone.CachedModelCollection.extend({model:n.Models.Artist},{}),Albums:Backbone.CachedModelCollection.extend({model:n.Models.Album},{}),Playlists:Backbone.CachedModelCollection.extend({model:n.Models.Playlist},{}),Broadcasts:Backbone.CachedModelCollection.extend(f,{}),Users:Backbone.CachedModelCollection.extend({model:n.Models.User},{}),Videos:Backbone.Collection.extend({model:n.Models.Video},{}),Events:Backbone.Collection.extend({model:n.Models.Event},{}),Stations:Backbone.Collection.extend({model:n.Models.Station},{}),Tags:Backbone.CachedModelCollection.extend({model:n.Models.Tag},{}),Callouts:Backbone.CachedModelCollection.extend({model:n.Models.Callout},{}),Comments:Backbone.PageableCollection.extend({model:n.Models.Comment,comparator:e,_initialPageableItemLimit:25,_pageableItemsPerLoad:50,_pageableLoadFunc:o},{}),CommentResponses:Backbone.CachedModelCollection.extend({model:n.Models.CommentResponse,comparator:r},{}),FeedEvents:Backbone.PageableCollection.extend({model:n.Models.FeedEvent,comparator:i,_initialPageableItemLimit:25,_pageableItemsPerLoad:0,_pageableLoadFunc:u},{}),Tacos:Backbone.CachedModelCollection.extend({model:n.Models.Taco,comparator:i,getNormalized:s},{}),ChatActivities:Backbone.CappedCollection.extend({model:n.Models.ChatActivity},{})}}(),function(){function o(e){this.model.get("user")&&(e.data&&e.data.activityName?(e.userIDFrom&&!e.data.userIDFrom&&(e.data.userIDFrom=e.userIDFrom),e.usernameFrom&&!e.data.usernameFrom&&(e.data.usernameFrom=e.usernameFrom),this.model.get("user").onNewNotification(e.data)):this.model.get("user").onNewNotification(e))}function u(e){this.model.get("user")&&e&&e.data&&this.model.get("user").onNewFeedEvent(e.data)}function a(e){var t=n.Models.Player.playStatuses,i=r.model.get("player").get("playStatus");switch(i){case t.NONE:case t.FAILED:case t.COMPLETED:return!1}return e&&i===t.PAUSED?!1:!0}function f(e,t){var i=setTimeout(function(){var i=$(t.currentTarget),s=(i.attr("class")||"").split(/\s/g),o=$(".jjmenu"),u,f=n.isBroadcastListener();if(!r.tooltip.currentTooltip&&!o.length&&_.indexOf(s,"no-title-tooltip")===-1){if(!f&&e=="PLAY_NOW"&&a()&&_.indexOf(s,"play-or-add")!==-1)e="PLAY_LAST";else if(f&&(e=="PLAY_NOW"||e=="PLAY_LAST")){var l=$("#suggestions-grid"),c=$("#recent-plays-grid");l.length&&$.contains(l[0],i[0])||c.length&&$.contains(c[0],i[0])?e="PREVIEW_SONG":e="SUGGEST_SONG"}u=_.getString(e);if(_.indexOf(s,"use-title-for-tooltip")!==-1)u=i.attr("title")||i.data("title"),i.data("title",u),i.removeAttr("title");else if(_.indexOf(s,"tooltip-for-full-text")!==-1){var h=parseInt(i.css("max-width")),p=i.parent().width(),d=h&&p?h<p?h:p:h?h:p;if(_.defined(d)&&_.calculateTextWidth(i.text(),{fontSize:i.css("font-size"),fontWeight:i.css("font-weight")})<d)return;u=i.text()}var v=new n.Views.Tooltips.Helper({text:u});v.tooltipOptions.delay=10,n.Views.Tooltips.Helper.simpleTooltip(t,v)}},130),s=$(t.currentTarget),o="mouseleave.titleTooltipHelper";s.on(o,function(){clearTimeout(i),s.off(o)}),t.stopPropagation()}function l(e){var t=$(e.currentTarget);return t.data("selected")==="true"||t.data("selected")===!0?f("FOLLOWING",e):f("FOLLOW",e)}n.Views=n.Views||{};var i=" - Grooveshark",s="Grooveshark - ",c=["bg","ca","cs","cy","da","de","el","en","es","eu","et","gl","fi","fr","hr","hu","it","ja","ko","lt","lv","nb","nl","pl","pt","ro","ru","sk","sl","sv","tr","uk","zh"],h="en";n.Views.Application=Backbone.View.extend({el:"body",lastActive:null,events:{"click a,.btn,input":"logGenericClick","click .search-link":"searchLink","click .song-link":"songLink","click .comment-link":"commentLink","click .play":"onPlayClick","click .play-genre":"onPlayGenreClick","click .play-station":"onPlayStationClick","click .join-broadcast":"onJoinBroadcastClick","click .open-broadcast":"onOpenBroadcastClick","click .leave-broadcast":"onLeaveBroadcastClick","click .favorite":"onFavoriteClick","click .share, .song-row-share, .album-cell-share, .artist-cell-share":"onShareClick","click .song-row-add, #np-add":"onAddClick","click #jh-feedback":"onFeedbackClick","click .genre-link":"onGenreTagClick","click .suggest-music":"onSuggestClick","click .login":"showLoginLightbox","click .create-account":"showSignupLightbox","mouseenter .song-row-add":"onSongRowAddMouseenter","mouseenter .song-row-favorite":"onSongRowFavMouseenter","mouseenter .song-row-share":_.bind(f,e,"SHARE_SONG"),"mouseenter .song-row-delete":_.bind(f,e,"REMOVE_LISTEN"),"mouseenter .icon.song-link":_.bind(f,e,"GO_TO_SONG_PAGE"),"mouseenter .go-to-broadcast-page":_.bind(f,e,"GO_TO_BROADCAST_PAGE"),"mouseenter #np-fav":"onSongRowFavMouseenter","mouseenter #np-add":"onSongRowAddMouseenter","mouseenter #np-share":_.bind(f,e,"SHARE_SONG"),"mouseenter #bc-invite-all-control.no-invite":_.bind(f,e,"INVITE_ALL_FOLLOWERS_LIMIT"),"mouseenter .show-song-tooltip":"openSongTooltip","mouseenter .show-user-tooltip":"openUserTooltip","mouseenter .show-broadcast-tooltip":"openBroadcastTooltip","mouseenter .show-artist-tooltip":"openArtistTooltip","mouseenter .title-drag-song":_.bind(f,e,"SHORTCUTS_TAB"),"mouseenter .play-or-add":_.bind(f,e,"PLAY_NOW"),"mouseenter .play-now":_.bind(f,e,"PLAY_NOW"),"mouseenter .play-sm":_.bind(f,e,"PLAY_NOW"),"mouseenter .title-drag-playlist":_.bind(f,e,"DRAG_TO_PLAY"),"mouseenter .title-play-playlist":_.bind(f,e,"PLAY_PLAYLIST"),"mouseenter .play-recent-songs":_.bind(f,e,"SELECTION_PLAY_RECENT"),"mouseenter .title-shuffle-queue":_.bind(f,e,"QUEUE_SHUFFLE_SONGS"),"mouseenter .title-loop-queue":_.bind(f,e,"QUEUE_LOOP_SONGS"),"mouseenter .title-crossfade-queue":_.bind(f,e,"QUEUE_CROSSFADE_SONGS"),"mouseenter .suggest-tags":_.bind(f,e,"SUGGEST_TAGS"),"mouseenter .invite-followers.disabled":_.bind(f,e,"INVITE_FOLLOWERS_RATE_LIMITED"),"mouseenter .upvotes":_.bind(f,e,"VOTES_FROM_LISTENERS"),"mouseenter .use-title-for-tooltip":_.bind(f,e,""),"mouseenter .tooltip-for-full-text":_.bind(f,e,""),"mouseenter .favorite-flat":_.bind(f,e,"FOLLOW"),"mouseenter .favorite-flat.btn-success":_.bind(f,e,"UNFOLLOW"),"mouseenter #trash:not(.restore-queue)":_.bind(f,e,"QUEUE_CLEAR_QUEUE"),"mouseenter #trash.restore-queue":_.bind(f,e,"QUEUE_RESTORE_QUEUE"),"mouseenter #play-prev":_.bind(f,e,"QUEUE_PREV_SONG"),"mouseenter #play-next":_.bind(f,e,"QUEUE_NEXT_SONG"),"mouseenter #repeat":_.bind(f,e,"REPEAT"),"mouseenter #crossfade":_.bind(f,e,"CROSSFADE"),"mouseenter .btn-notif.favorite":_.bind(l,e),"mouseenter .btn-notif.reply":_.bind(f,e,"REPLY"),"mouseenter .btn-notif.edit":_.bind(f,e,"EDIT_ARTIST"),"click .capital-ad-report":"openReportAd","submit .do-search":"doSearch","click .upload-music":"showUploadLightbox","click .invite-friends":"onInviteFriendsClick","click .empty-submit":"submitEmptySearch","focus .placeholder-input":"onPlaceholderFieldFocus","keyup .placeholder-input":"onPlaceholderFieldKeyup","keypress .placeholder-input":"onPlaceholderFieldKeypress","change .placeholder-input":"onPlaceholderFieldChange","blur .placeholder-input":"onPlaceholderFieldBlur","click .placeholder-text":"onPlaceholderClick","click .bc-invite":"onBroadcastInviteClick","click .change-context":"onChangeContextClick","click .open-profile-card":"openProfileCard"},initialize:function(){n.on("setTitle",this.setTitle,this),this.onActivityThrottled=_.throttle(_.bind(function(){this.onActivity()},this),1e3),this.$el.on("mousemove."+this.cid,this.onActivityThrottled),this.$el.on("keydown."+this.cid,this.onActivityThrottled),this.onActivity();var t=_.throttle(_.bind(function(){var t=$(document).width(),i=$(e).height(),s=this.model.attributes.pageSize,o=this.model.get("user");t<=1080&&s!==2?($(document.body).addClass("app-shrink"),o.get("isLoggedIn")?n.trigger("sidebar:size",null,"small"):n.trigger("sidebar:close"),this.model.set({pageSize:2})):t>1080&&t<=1240&&s!==1?($(document.body).removeClass("app-shrink"),o.get("isLoggedIn")?n.trigger("sidebar:size",null,"small"):n.trigger("sidebar:close"),this.model.set({pageSize:1})):t>1240&&s!==0&&($(document.body).removeClass("app-shrink"),o.get("isLoggedIn")?n.trigger("sidebar:size",null,"large"):n.trigger("sidebar:close"),this.model.set({pageSize:0})),typeof r!="undefined"&&r.handleResize(),_.resizeClipboardHandler(),n.trigger("app:resize",t,i)},this),300);$(e).resize(t),t(),this.header=new n.Views.Header({el:$("#header-container")[0],model:this.model}),this.player=new n.Views.Player({el:$("#player-wrapper")[0],model:this.model}),this.queue=new n.Views.Queue({model:this.model}),this.sidebar=new n.Views.Sidebar({model:this.model}),this.page=new n.Views.Page({model:this.model}),this.theme=new n.Views.Theme({model:this.model}),this.ad=new n.Views.Ad({model:this.model});var r=this.lightbox=new n.Views.Lightbox({model:this.model});this.tooltip=new n.Views.Tooltip({model:this.model}),this.notification=new n.Views.Notification({model:this.model}),this.leapLibLoaded=!1,this.leapLibAttempts=0,this.adRollLoaded=!1,this.model.set("adrollPages",[]),this.model.on("userChange:started",this.onUserChangeStarted,this),this.model.on("userChange:finished",this.onUserChangeFinished,this),this.model.on("change:user",this.onUserChange,this),this.model.on("change:user",t,this),this.model.on("change:userActive",this.loadAdroll,this),this.onUserChange(),this.lastTitleObj={title:(document.title||"").replace(" - Grooveshark","").replace("Grooveshark - ",""),page:this.page.getCurrentPageView()},this.model.get("player").on("change:playStatus",function(){this.setTitle(this.lastTitleObj)},this);var i=(n.Services.Local.get("gs.locale")||gsConfig.lang||this.detectLangauge()||"en").substring(0,2);_.indexOf(c,i)===-1&&(i="en"),n.on("locale:change",this.refreshLanguage,this),$.localize.ready.done(_.bind(function(){this.refreshLanguage(this.model.get("locale"))},this)),this.refreshLanguage(i),n.on("manatee:notification",o,this),n.on("manatee:feedEvent",u,this),n.on("manatee:broadcastGet",function(e){(!e||!e.success)&&n.trigger("notification:add",{description:_.getString("POPUP_ERROR_BROADCAST_GET_FAILED"),type:"error",duration:5e3})}),n.on("manatee:broadcastInvite",this.onBroadcastInvitation,this),Math.random()<.9&&$("#jh-feedback").hide(),n.on("tour:start",this.startTour,this),n.on("leap:loadLib",this.loadLeapLibrary,this),n.on("leap:unloadLib",this.unloadLeapLibrary,this)},render:function(){this.header.render(),this.player.render(),this.page.render(),this.lightbox.render(),this.showHiringMsg({inConsole:!0,inPoptart:!1})},onUserChangeStarted:function(e){this.page.removeCurrentPageView()},onUserChangeFinished:function(t){var r=t.destination,i=e.location.hash||"#!";r||(r="#!/"),t.preventRedirect||n.router.setHash(r),(r===i||t.preventRedirect)&&$(e).trigger("hashchange"),n.trigger("leap:unloadLib")},setTitle:function(e){if(!e||!e.title||!e.page)return;e=_.clone(e);var t=e.title,n=e.prepend,r=e.page;_.isArray(t)&&(t=_.filter(t,function(e){return e}),t=t.join(" - ")),this.lastTitleObj=e,_.defer(_.bind(function(){if(r!==this.page.getCurrentPageView())return;n=_.orEqual(n,!0);var e="",o=($.browser.version||"").split("."),u=$.browser.webkit;$.browser.chrome&&_.toInt(o[0])>31&&(u=!1),a(!0)&&u&&(e=" "),n?this.lastTitle=e+t+i:this.lastTitle=e+s+t,document.title=this.lastTitle},this))},onUserChange:function(){var e=this.model.get("user");e.get("subscription").canHideAds()?$(document.body).addClass("premium-user"):$(document.body).removeClass("premium-user")},detectLangauge:function(){var t=e.navigator;return t.language||t.browserLanguage||t.systemLanguage||t.userLanguage},refreshLanguage:function(e){_.indexOf(c,e)===-1&&(e="en");var t=_.getString("WEEK_DAYS");t&&t.length&&(_.daysOfTheWeek=t.split(","));var r=_.getString("MONTHS");r&&r.length&&(_.monthsOfTheYear=r.split(",")),$("[data-translate-text]").localize("gs",{language:e}).done(_.bind(function(){$("[data-translate-title]").localize("gs",{language:e,callback:"titleCallback"}),n.Services.Local.set("gs.locale",e),this.model.set("locale",e),e!==h&&(n.trigger("locale:changed",e),h=e),$("#jh-feedback").removeClass().addClass(e)},this))},logGenericClick:function(e){var t=$(e.currentTarget),r=t.data(),i={tag:t.prop("tagName"),classes:t.attr("class"),id:t.attr("id")};for(var s in r)r.hasOwnProperty(s)&&(i["data-"+s]=r[s]);switch(i.tag){case"input":i.inputType=t.attr("type"),i.inputType!=="password"&&(i.value=t.val());break;case"a":i.href=t.attr("href")}_.extend(i,_.eventToGUTSCoords(e)),n.trigger("guts:log","defaultClicked",i)},searchLink:function(e){e.preventDefault();var t=$(e.currentTarget),r=t.data("searchtype"),i=t.data("searchquery");r=r?r:"",i=i?i:"",n.router.performSearch(r,i)},songLink:function(e){e.preventDefault();var t=$(e.currentTarget),n=t.data("songId"),r=t.data("subpage");this.navigateToSong(n)},navigateToSong:function(e,t){n.Models.Song.get(e,{notifyCache:!0}).done(function(e){e&&e.getToken().done(function(){n.router.setHash(e.toUrl(t))})})},commentLink:function(e){var t=$(e.currentTarget);if(!t.attr("href")){e.preventDefault();var r=t.data("commentId");n.Models.Comment.get(r).done(_.bind(function(e){e&&e.get("TypeID")===n.Models.Comment.COMMENT_PAGE_TYPES.SONG?this.navigateToSong(e.get("ItemID"),"comment/"+e.id):e&&n.router.setHash(e.toUrl())},this))}},onShareClick:function(e){e.preventDefault();var t=$(e.currentTarget),r=t.data(),i={type:"",id:0,excludeServices:{}};r.playlistId?(i.type="playlist",i.id=r.playlistId):r.songId?(i.type="song",i.id=r.songId):r.albumId?(i.type="album",i.id=r.albumId,i.excludeServices={embed:!0}):r.artistId?(i.type="artist",i.id=r.artistId,i.excludeServices={embed:!0}):r.tagId?(i.type="tag",i.id=r.tagId):r.broadcastId?(i.type="broadcast",i.id=r.broadcastId,i.excludeServices={grooveshark:!1,embed:!0,email:!0}):r.userId&&(i.type="user",i.id=r.userId,i.excludeServices={grooveshark:!0,embed:!0},i.service="facebook"),r.service&&(i.service=r.service),i.type&&i.id&&n.trigger("lightbox:open","share",i)},onAddClick:function(e){var t=$(e.currentTarget),r=t.data("songId"),i=n.Models.Song.getCached(r),s=n.getLoggedInUserID(),o=n.Models.User.getCached(s);if(!i){var u=t.parents(".module").data("module");u&&u.model&&(u.model._wrapped?i=u.model._wrapped:i=u.model,n.Models.Song.cache(i,{notifyCache:!0}))}if(!i)return;return i.get("fromLibrary")?o.removeSongsFromLibrary([r]):o.addSongsToLibrary([r]),!1},onFavoriteClick:function(e){var t=$(e.currentTarget),r=this.model.get("user"),i=t.data("playlistId"),s=t.data("artistId"),o=t.data("userId"),u=t.data("songId"),a=t.data("broadcastId"),f,l,c,h=function(e,n){var i;e?i=r.unfavorite(n+"s",f):i=r.favorite(n+"s",f),n=="Artist"&&i.done(_.bind(d,this,e,s)),t.hasClass("btn-notif")&&p(e,t)},p=function(e,t){var n=t.parents("div.header-notification").first(),r=n.add(n.siblings('[data-from-user-id="'+n.data("from-user-id")+'"]'));e?r.find(".btn-notif.favorite").removeClass("btn-success").data("selected","false"):r.find(".btn-notif.favorite").addClass("btn-success").data("selected","true")},d=function(e,t){if(!e){var r=n.Models.Artist.getCached(t);n.trigger("notification:add",{title:_.getString("POPUP_FOLLOWED_ARTIST",{artistLink:r.get("ArtistName")}),icon:"artist icon-artist-white-active",type:"success"})}};i?(l="Playlist",f=i):o?(l="User",f=o):s?(l="Artist",f=s):u?(l="Song",f=u):a&&(l="Broadcast",f=a);if(!n.Models[l].getCached(f)){var v=t.parents(".module").data("module");if(!v||!v.model){console.warn("Couldn't favorite type because we didn't have it cached and it wasn't on the module");return}c=v.model,_.isFunction(c.getModelToFavorite)&&(c=c.getModelToFavorite(l)||c);if(c._wrapped&&c._wrapped instanceof n.Models[l])n.Models[l].cache(c._wrapped);else{if(!(c instanceof n.Models[l])){console.warn("Couldn't favorite type because we didn't have it cached and it wasn't on the module");return}n.Models[l].cache(c)}}n.Models[l].get(f).done(function(e){var t=e.get("isFavorite"),r;l==="Artist"&&(r=n.Models.User.getCached(e.get("profileID")),r&&(t=r.get("isFavorite"))),h(t,l)})},onPlayClick:function(e){e.preventDefault();var r=$(e.currentTarget),i=r.data("playlistId"),s=r.data("songId"),o=r.data("albumId"),u=r.data("artistId"),f=r.data("tagId"),l=r.data("broadcastId"),c=r.hasClass("play-pause"),h=r.data("streamType"),p=r.hasClass("btn-notif"),d=!0;_.defined(h)||(h=r.closest(".module").data("streamType"));var v=_.bind(function(e,i){var s=this.model.get("player").get("currentQueue");if(s){d=!a(),r.hasClass("play-or-add")||(d=!0);if(c)n.trigger("player:togglePlay");else{i=_.orEqual(i,new n.Models.PlayContext);if(h){var o=h.split(",");_.each(o,function(e){e=$.trim(e),_.defined(n.Models.PlayContext[e])&&i.addStreamType(n.Models.PlayContext[e])})}n.trigger("player:addSongs",e,t,d,i)}}},this);if(i)n.Models.Playlist.get(i).then(function(e){e.getSongs().then(function(t){v(t.toArray(),new n.Models.PlayContext(e))})});else if(s){var m=r.data("contextClass"),g=r.data("contextId"),y=r.closest(".grid-item"),b=r.parents(".module").data("module");function w(e){y.length&&y.data("playContext")?v([e],y.data("playContext")):m&&g&&n.Models[m]&&n.Models[m].hasOwnProperty("get")?n.Models[m].get(g).then(function(t){v([e],new n.Models.PlayContext(t))}).fail(function(){v([e])}):v([e])}b&&b.model&&(b.model instanceof n.Models.Song||b.model._wrapped instanceof n.Models.Song)?w(b.model._wrapped||b.model):n.Models.Song.get(s).done(w)}else o?n.Models.Album.get(o).then(function(e){e.getSongs().then(function(t){v(t.toArray(),new n.Models.PlayContext(e))})}):u?n.Models.Artist.get(u).then(function(e){e.getTopSongs().then(function(t){v(t.toArray(),new n.Models.PlayContext(e))})}):f?n.Models.Tag.get(f).then(_.bind(function(e){this.playGenre(e.get("Tag"),e.get("TagID"))},this)):l&&n.Models.Broadcast.get(l).done(function(e){e.getHistory().done(function(t){v(t.toArray(),new n.Models.PlayContext(e))})})},onActivity:function(){this.lastActive=Date.now();var t=this.model.get("user");t.get("isLoggedIn")&&t.get("checkBroadcastInvitesTime")&&t.get("checkBroadcastInvitesTime")<(this.lastActive+e.clientTimeDivergence)/1e3>>0&&t.updateBroadcastInviteableUsers(),this.model.set("userActive",!0),this.setIdleTimer(),n.trigger("userActivity",this.lastActive)},setIdleTimer:function(){var e=18e4;clearTimeout(this.idleTimer),this.idleTimer=setTimeout(_.bind(function(){this.lastActive<=Date.now()-e?this.model.set("userActive",!1):this.setIdleTimer()},this),e)},onGenreTagClick:function(e){var t=$(e.currentTarget),r=t.attr("href");if(r&&r.length)return!0;var i=$(e.currentTarget).data();i.tag||(i.tag="x");if(!i.tagId)return!1;n.router.setHash("/genre/"+_.cleanNameForURL(i.tag)+"/"+i.tagId),n.trigger("guts:gatrack","site","genreTagClick",i.tagId),n.trigger("guts:log","onGenreTagClick",{genreTagTagID:i.tagId})},radioClearQueue:function(e){var t=this.model.get("player"),r=t.get("currentQueue"),i=!1;if((!r.get("songs")||!r.get("songs").length)&&!r.get("currentBroadcast")){e();return}var s=function(){var s=function(){if(i)return;i=!0,t.off("change:currentQueue",s),r.off("change",s),e()};n.Services.SWF.stopSong(),n.Services.SWF.clearQueue(),t.on("change:currentQueue",s),r.on("change",s)};n.trigger("lightbox:open","radioClearQueue",{startRadio:s,inBroadcast:!!r.get("currentBroadcast")})},onPlayStationClick:function(e,t){var r=$(e.currentTarget),i=r.data(),s=this.model.get("player");if(n.isBroadcaster()){n.trigger("notification:add",{title:_.getString("POPUP_NO_RADIO_WHILE_BROADCASTING"),type:"error"});return}_.isUndefined(i.userId)?_.isUndefined(i.artistId)||n.trigger("player:radio",!0,null,{seeds:[i.artistId],seedArtistWeightRange:[110,130],secondaryArtistWeightModifier:.75}):t=i.userId;if(!_.isUndefined(t)){var o=n.Models.User.getCached(t);if(!o){this.onPlayRadioFail();return}var u=o.get("playlists");u=new n.Models.Collections.Playlists(u&&u.models||null),u.comparator=n.Models.Playlist.modifiedSort,u.sort(),u=u.last(3).reverse();var a=_.bind(function(e){var r=$.Deferred(),i={},a=new n.Models.Collections.Songs,f=new n.Models.Collections.Songs,l=1,c=s&&s.get("currentQueue"),h=c&&c.get("clientRadio"),p=!1,d=$.now(),v,m,g=1,y=0,b=!1;v=function(e,t,n,r){var s=[];return r&&(r=r.models?r.models:r,b&&(r=_.shuffle(r)),s=_.first(r,_.toInt(t)),n==1?a.add(s):f.add(s)),a.length&&!i[e]&&l<=3&&d&&($.now()-d)/1e3>1&&(console.log("time expired, songBucket!"),m(e)),_.difference(r,s)},m=function(e){if(i[e])return;i[e]=!0,a=new n.Models.Collections.Songs(b?_.shuffle(a.models):a.models);var s=Math.floor(a.length*g),o=a.first(s),u=!1,d;a.length<=4&&f.length&&(o=o.concat(f.models),f.reset([]));if(!o||!o.length){r.notify(l++);return}a.reset(a.rest(s)),o=new n.Models.Collections.Songs(o),p?(d=c.get("activeSong"),h.add(o.models)):(o=n.Models.Queue.sortSongsForRadio(o,{shuffle:!1}),p=!0,u=!0,d={},o=o.models,h.reset(o).enable(),h.on("needSongs",function(e,t){r.notify(l++)},this),n.trigger("guts:startNewAutoplayContext","user",t)),y+=o.length,h.onActiveSongChange(c,d,{playOnAdd:u})},r.progress(_.bind(function(e){var t=!1,i=function(e,n,r,i){if(t)return;t=!0,v(e,n,r,i)};if(e>7)return;var s=[],d,y=_.bind(function(){a.length?m.apply(this,[e].concat(_.toArray(arguments))):p?r.notify(l++):n.trigger("lightbox:open","stations",{noRecs:!0})},this);switch(e){case 1:s.push(o.getPersonalizedSongs().done(_.bind(function(t){i(e,1,1,t)},this))),o.getLibrary(),o.getFavoritesByType("Songs");break;case 2:s.push(o.getPersonalizedSongs(!1,!0).done(_.bind(function(t){var n=i(e,Math.min(100,t.length/1.4),1,t);n&&n.length&&i(e,100,2,n)},this)));break;case 3:case 4:case 5:b=!0,g=.67;if(!u.length){l=5,r.notify(l);return}var w=u.shift();d=w.getUnwrappedSongs(),d.done(_.bind(i,this,e,5,1)),s.push(d);break;case 6:g=1,a.add(f.models),f.reset([]),d=$.Deferred(),d.resolve(),s.push(d);break;case 7:d=o.getTopArtists(),d.done(function(e){var t=h.frowns,r=c.get("songs"),i=r.pluck("ArtistID"),s=e.pluck("ArtistID"),o=t.pluck("ArtistID");i=_.uniq(i.concat(i,s)),i=_.difference(i,o);var u={secondaryArtistWeightModifier:.1,seedArtistWeightRange:[80,100],weightModifierRange:[-9,9],seeds:i,frowns:o};n.trigger("guts:gatrack","player","clientRadioFallbackToServer","fallbackSeedArtistIDs:"+i.length+",fallbackSeedFrownArtistIDs:"+o.length),n.trigger("guts:forcelog","clientRadioFallbackToServer",{fallbackSeedArtistIDs:i.toString(),fallbackSeedFrownArtistIDs:o.toString()}),n.trigger("guts:startAutoplayFallbackContext","autoplay",0,"artist",i.toString()),n.Services.SWF.setAutoplay(!0,0,u,"autoplayGetSongEx")});return;default:h.disable(),this.onPlayRadioFail(),n.trigger("guts:clearAllAutoplayContexts");return}setTimeout(_.bind(i,this,e),1200),$.after(s).always(y)},this)),r.notify(l++)},this);this.radioClearQueue(a,s)}},onPlayGenreClick:function(e){var t=$(e.currentTarget),n=t.data("tag"),r=t.data("tagId"),i=this.model.get("player");if(!r){console.log("missing tagId data on element",t),n&&this.onPlayGenreFail(n);return}var s=$.Deferred();return this.playGenre(n,r).done(function(){s.resolve.apply(s,_.toArray(arguments))}).fail(function(){s.resolve.apply(s,_.toArray(arguments))}),s.fail(_.bind(this.onPlayGenreFail,this,n)),s},playGenre:function(e,t){var i=$.Deferred();return n.Models.Tag.get(t).done(_.bind(function(e){if(!e){i.reject();return}e.getSongs().done(function(e){(!e||!e.length)&&i.reject(),e=new n.Models.Collections.Songs(e.models);var s=_.bind(function(){var s=r.model.get("player"),o=s.get("currentQueue"),u=o.get("clientRadio");e=n.Models.Queue.shuffleSongsForRadio(e),u.reset(e.models).enable(),u.onActiveSongChange(o,{},{playOnAdd:!0}),u.on("needSongs",function(e,t){e.switchToAutoplay({secondaryArtistWeightModifier:.7,seedArtistWeightRange:[75,100],weightModifierRange:[-14,9]}),n.trigger("guts:startAutoplayFallbackContext","autoplay",0)}),i.resolve(e),n.trigger("guts:startNewAutoplayContext","tag",t)},this);r.radioClearQueue(s)}).fail(function(){i.reject()})},this)),i},onPlayGenreFail:function(e){n.trigger("notification:add",{title:"Error retrieving tag songs for "+e+".",description:"",url:"",type:"error"})},onPlayRadioFail:function(){n.trigger("notification:add",{title:_.getString("ERROR_FETCHING_RADIO"),description:"",url:"",type:"error"})},onSuggestClick:function(e){n.trigger("lightbox:open","share",{service:"grooveshark",serviceLock:!0,toUserID:$(e.currentTarget).data("userId")}),n.trigger("guts:gatrack","site","onSuggestClick"),n.trigger("guts:log","onSuggestClick",{toUserID:$(e.currentTarget).data("userId")})},onFeedbackClick:function(e){e.preventDefault(),n.trigger("lightbox:open","feedback",{type:"feedback"})},onJoinBroadcastClick:function(e){var t=$(e.currentTarget),n=t.find(".title"),r=t.data(),i=_.eventToGUTSCoords(e);this.joinBroadcast(r.broadcastId,r.userId,r.artistId,i).done(function(e){n.data({translateText:e}).text(_.getString(e))})},joinBroadcast:function(e,t,i,s){var o=r.model.get("user"),u=r.model.get("player").get("currentQueue"),a=u?u.get("isBroadcasting"):!1,f=u?u.get("currentBroadcast"):null,l=$.Deferred(),c;s=_.orEqual(s,{}),s.broadcastID=f?f.get("BroadcastID"):e;if(e){s.broadcastID=e;if(!i&&!t){var h=n.Models.Broadcast.getCached(e);i=h.get("ArtistID"),t=h.get("UserID")}if(!u||!f||f.get("BroadcastID")!=e){var p;i?p=n.Models.Artist.getCached(i):t&&(p=n.Models.User.getCached(t));function d(){o.joinBroadcast(e,p).done(function(){l.resolve("LEAVE_BROADCAST")}).fail(function(e){if(e===4)return;var t="POPUP_ERROR_BROADCAST_JOIN_ERROR";e===2&&(t="POPUP_ERROR_BROADCAST_JOIN_ARTIST"),n.trigger("notification:add",{description:_.getString(t),type:"error",duration:5e3})}),l.fail()}return a&&f?n.trigger("lightbox:open","broadcastListeners",{broadcast:f,endBroadcast:!0,onBroadcastEnded:d}):d(),n.trigger("guts:log","joinBroadcastButtonClicked",s),l.promise()}}if(f){function v(){o.leaveBroadcast(),l.resolve("JOIN_BROADCAST")}c=f.get("listeners"),a&&c&&c.length>1?n.trigger("lightbox:open","broadcastListeners",{broadcast:f,endBroadcast:!0,onBroadcastEnded:v}):v()}else t&&(n.router.setHash("/profile/-/"+t+"/broadcast/join"),l.resolve("LEAVE_BROADCAST"));return n.trigger("guts:log","joinBroadcastButtonClicked",s),l.promise()},onOpenBroadcastClick:function(e){var t=$(e.currentTarget),r=t.data();if(r.broadcastId){var i=n.Models.Broadcast.getCached(r.broadcastId);i&&n.router.setHash(i.toUrl())}},onLeaveBroadcastClick:function(e){var t=$(e.currentTarget),i=t.find(".title"),s=t.data(),o=r.model.get("user"),u=r.model.get("player").get("currentQueue"),a=u?u.get("isBroadcasting"):!1,f=u?u.get("currentBroadcast"):null;if(s.broadcastId){var l=_.eventToGUTSCoords(e);l.broadcastID=s.broadcastId;function c(){o.leaveBroadcast();var e="JOIN_BROADCAST";i.data({translateText:e}).text(_.getString(e))}u&&f&&f.get("BroadcastID")==s.broadcastId&&(a?n.trigger("lightbox:open","broadcastListeners",{broadcast:f,endBroadcast:!0,onBroadcastEnded:c}):c()),n.trigger("guts:log","leaveBroadcastButtonClicked",l)}},onSongRowAddMouseenter:function(e){var t=$(e.currentTarget),r=t.data("songId"),i=n.Models.Song.getCached(r),s="HELPER_ROW_COLLECTION_ADD";if(!i){var o=t.parents(".module").data("module");o&&(i=o.model)}if(!i)return;i&&i.get("fromLibrary")&&(s="HELPER_ROW_COLLECTION_REMOVE");var u=new n.Views.Tooltips.Helper({text:_.getString(s)});n.Views.Tooltips.Helper.simpleTooltip(e,u)},onSongRowFavMouseenter:function(e){var t=$(e.currentTarget),r=t.data("songId"),i="HELPER_ROW_FAVORITES_ADD",s=n.Models.Song.getCached(r);if(!s){var o=t.parents(".module").data("module");o&&(s=o.model)}if(!s)return;s.get("isFavorite")&&(i="HELPER_ROW_FAVORITES_REMOVE");var u=new n.Views.Tooltips.Helper({text:_.getString(i)});n.Views.Tooltips.Helper.simpleTooltip(e,u)},openSongTooltip:function(e){var t=$(e.currentTarget),r=t.data(),i=[],s=null,o={delay:50,notchSize:6,notchY:10,notch:"top",x:"center",y:"bottom",maxWidth:420,width:null},u=t.closest(".sidebar-user");r.tooltipLeft&&(o.notchX=300,o.x=-300+t.width()/2);if(r.tooltipCacheKey){var a=this.model.get("tooltipOptionsCache"),f=a&&a[r.tooltipCacheKey];f&&(o=_.extend({},o,f))}u.length&&(t=$(u[0]));if(r.songId){var l=new n.Views.Tooltips.SingleSong({songID:r.songId,addStreamType:r.addStreamType});i.push(l),s="song:"+r.songId,o.views=i,o.$attached=t,o.tooltipKey=s,_.isFunction(o.beforeRender)&&o.beforeRender(t,l,o),n.trigger("tooltip:open",o)}},openUserTooltip:function(e){var t=$(e.currentTarget),r=t.data(),i=[],s=null,o={delay:250,notchSize:6,notchY:10,notch:"top",x:"center",y:"bottom"},u=t.closest(".sidebar-user");r.tooltipLeft&&(o.notchX=300,o.x=-300+t.width()/2);if(r.tooltipCacheKey){var a=this.model.get("tooltipOptionsCache"),f=a&&a[r.tooltipCacheKey];f&&(o=_.extend({},o,f))}u.length&&(t=$(u[0]));if(r.userId){var l=new n.Views.Tooltips.User({userID:r.userId});i.push(l),s="user:"+r.userId,o.views=i,o.$attached=t,o.tooltipKey=s,n.trigger("tooltip:open",o)}},openBroadcastTooltip:function(e){var t=$(e.currentTarget),r=t.data(),i=[],s=null,o={delay:250,notchSize:6,notchY:10,notch:"top",x:"center",y:"bottom"},u=t.closest(".sidebar-user");r.tooltipLeft&&(o.notchX=300,o.x=-300+t.width()/2);if(r.tooltipCacheKey){var a=this.model.get("tooltipOptionsCache"),f=a&&a[r.tooltipCacheKey];f&&(o=_.extend({},o,f))}u.length&&(t=$(u[0]));if(r.userId){var l=new n.Views.Tooltips.Broadcast({broadcastID:r.broadcastId,userID:r.userId});i.push(l),s="broadcast:"+r.userId,o.views=i,o.$attached=t,o.tooltipKey=s,o.tooltipClass="broadcast-tooltip",o.width=330,n.trigger("tooltip:open",o)}},openArtistTooltip:function(e){var t=$(e.currentTarget),r=t.data(),i=[],s=null,o={delay:50,notchSize:6,notchY:10,notch:"top",x:"center",y:"bottom"};r.tooltipLeft&&(o.notchX=300,o.x=-300+t.width()/2);if(r.tooltipCacheKey){var u=this.model.get("tooltipOptionsCache"),a=u&&u[r.tooltipCacheKey];a&&(o=_.extend({},o,a))}if(!r.artistId)return;var f=new n.Views.Tooltips.Artist({artistID:r.artistId});i.push(f),s="artist:"+r.artistId,o.views=i,o.$attached=t,o.tooltipKey=s,_.isFunction(o.beforeRender)&&o.beforeRender(t,f,o),n.trigger("tooltip:open",o)},openReportAd:function(e){var t=$(e.currentTarget),r=t.data("capitalId"),i=$("iframe","#"+r);if(!i||!i.length)return;var s=_.extend(i.data("adInfo"),{capitalID:r}),o={delay:0,hideDelay:5e3,notchSize:6,notchY:10,notchX:300,notch:"top",x:"center",y:"bottom"};gsConfig.runMode!=="production"&&console.log("Got ad info from iFrame: "+$.stringify(s)),o.views=[new n.Views.Tooltips.ReportAd({info:s})],o.$attached=t,o.tooltipKey="reportAd",n.trigger("tooltip:open",o),n.trigger("guts:forcelog","openedReportAd",{iframeID:r,country:gsConfig.country.ID}),n.trigger("guts:gatrack","site","openedReportAd",r+"_"+gsConfig.country.ID)},doSearch:function(e){e.preventDefault();var t=$(e.currentTarget),r=t.attr("data-search-type")||"";query=$(e.currentTarget).find(".search-input").val(),console.warn(r,query),n.router.performSearch(r,query)},submitEmptySearch:function(e){e.preventDefault();var t=$(e.currentTarget);return t.parent(".empty-search").submit(),!1},showLoginLightbox:function(){return n.trigger("lightbox:open","login"),!1},showSignupLightbox:function(){return n.trigger("lightbox:open","signup"),!1},showUploadLightbox:function(){var e=function(e){var t=e.get("artistID"),r=t&&n.Models.Artist.getCached(t),i=r?{artist:r}:{};n.trigger("lightbox:open","upload",i)};if(n.getLoggedInUserID()>0){e(this.model.get("user"));return}n.trigger("lightbox:open","login",{onLogin:e})},startTour:function(e){var t=new n.Views.Tooltips.Tour({type:"default"}),r={persist:!0,width:265,delay:0,views:[t],tooltipKey:"tour",fixPosition:!1,scrollable:$("body"),tooltipClass:"tooltip-tour"};t.tour[0].setup(r),n.trigger("tooltip:open",r)},loadLeapLibrary:function(){if(!this.leapLibLoaded||this.leapTmpObj){var i=function(){$(".enable-leap").addClass("btn-success").text(_.getString("SETTINGS_LEAP_MOTION_ENABLED")).attr("data-translate-text","SETTINGS_LEAP_MOTION_ENABLED"),n.Services.Local.set("leapLib"+n.getLoggedInUserID(),!0)};if(this.leapTmpObj){e.Leap=this.leapTmpObj,this.leapTmpObj=t,i();return}if(e.gsProduction&&e.gsProduction.LEAP_CSSURI){var s=_.isUndefined(e.dataURISupport)||dataURISupport?gsProduction.LEAP_CSSURI:gsProduction.LEAP_CSS;s&&s.assetPath&&$.getStylesheet(s.assetPath)}var o=[];o.push(amdModules.requireDeferred("leapGestures")),o.push(amdModules.requireDeferred("leap")),$.after(o).done(_.bind(function(){this.leapLibLoaded=!0,i(),n.External.LeapPlayer.init(r.model)},this));var u=amdModules.getModuleScriptDeferred("leap");u&&u.fail(_.bind(function(){this.leapLibAttempts++,this.leapLibAttempts>1?(this.leapLibAttempts=0,n.trigger("notification:add",{type:"error",duration:5e3,description:_.getString("LEAP_LIB_LOAD_FAILED")})):this.loadLeapLibrary()},this)).done(function(){e.Leap&&define("leap",Leap)})}},unloadLeapLibrary:function(){$(".enable-leap").removeClass("btn-success").text(_.getString("SETTINGS_LEAP_MOTION_ENABLE")).attr("data-translate-text","SETTINGS_LEAP_MOTION_ENABLE"),n.Services.Local.set("leapLib"+n.getLoggedInUserID(),!1),this.leapTmpObj=e.Leap,e.Leap=t},loadAdroll:function(){var e=this.model.get("adrollPages"),t;e&&(t="#"+e.join("&"));if(this.model.get("userActive")===!1&&!this.adRollLoaded){var n=$('<iframe id="adRollFrame" class="hide">');gsConfig.runMode==="production"?n.attr("src","http://www.gscookiemonster.com/adroll.html"+t).appendTo("body"):n.attr("src",gsConfig.assetHost+"/adroll.html"+t).appendTo("body"),this.adRollLoaded=!0,n.load(function(){setTimeout(function(){n.remove()},5e3)})}},onInviteFriendsClick:function(e){n.trigger("lightbox:open","invite")},onPlaceholderClick:function(e){e.preventDefault(),$(e.target).parent().find(".placeholder-input").focus()},onPlaceholderFieldFocus:function(e){$(e.currentTarget).parent().addClass("focused")},onPlaceholderFieldKeyup:function(e){var t=$(e.currentTarget),n=t.parent();t.val()?n.addClass("has-text"):n.removeClass("has-text")},onPlaceholderFieldKeypress:function(e){$(e.currentTarget).parent().addClass("has-text")},onPlaceholderFieldBlur:function(e){$(e.currentTarget).parent().removeClass("focused")},onPlaceholderFieldChange:function(e){var t=$(e.currentTarget),n=t.parent();t.val()?n.addClass("has-text"):n.removeClass("has-text")},onBroadcastInviteClick:function(t){var i=$(t.currentTarget),s=i.data("userId"),o=r.model.get("player").get("currentQueue"),u=o?o.get("currentBroadcast").get("BroadcastID"):null;if(i.hasClass("disabled"))return;n.Services.API.sendRealtimeBroadcastInvite(s,u).done(_.bind(function(){var t=this.model.get("user"),r=n.Models.User.getCached(s);t&&t.get("isLoggedIn")&&(r.set({canBroadcastInvite:!1,broadcastTimeInvited:(Date.now()+e.clientTimeDivergence)/1e3>>0}),t.updateBroadcastInviteableUsers())},this))},onBroadcastInvitation:function(e){var t=e.userIDFrom?n.Models.User.getCached(e.userIDFrom):n.Models.Artist.getCached(e.artistIDFrom),i=e.ownerUser?n.Models.User.newOrUpdate(e.ownerUser):n.Models.Artist.newOrUpdate(e.ownerArtist),s=e.userIDFrom?t.escape("Name"):t.escape("ArtistName"),o=e.ownerUser?i.escape("Name"):i.escape("ArtistName"),u=n.Models.Broadcast.newOrUpdate(e.broadcastInfo);n.trigger("notification:add",{title:_.getString("INVITED_TO_BROADCAST",{sender:s}),description:_.getString("INVITED_TO_BROADCAST_DESC",{broadcast:u.escape("Name"),owner:o}),click:_.bind(function(){var e=r.model.get("player").get("currentQueue");e&&e.get("currentBroadcast")?n.router.setHash(u.toUrl()):this.joinBroadcast(u.get("BroadcastID"),u.get("UserID"),u.get("ArtistID"))},this),duration:1e4})},onChangeContextClick:function(e){var t=$(e.currentTarget),r=t.data("artistId"),i=t.data("userId"),s;i?s={type:"user",artist:{}}:r&&(s={type:"artist",artist:n.Models.Artist.getCached(r)}),this.model.get("user").setContext(s,!0)},openProfileCard:function(e){e.preventDefault();var t=$(e.currentTarget),r=t.data("userId");n.trigger("lightbox:open","profileCard",{userID:r})},showHiringMsg:function(e){if(gsConfig.runMode==="dev")return;e.inConsole&&console.info(['"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""',"Join Our Team! ","We're hiring and you should apply: http://grooveshark.com/careers ",'"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""'].join("\n"));if(e.inPoptart&&gsConfig.country&&gsConfig.country.ID==223&&!n.Services.Local.get("gs.hiringNotif")){function t(){n.trigger("notification:add",{title:_.getString("POPUP_HIRING_TITLE"),description:_.getString("POPUP_HIRING_DESCRIPTION"),icon:"large grooveshark-large",duration:0,activeDuration:30,click:function(){n.router.setHash("/careers")},closeAction:function(){n.Services.Local.set("gs.hiringNotif",1)}})}setTimeout(t,12e4)}}})}(),function(){n.Views=n.Views||{},n.Views.LeapPlayer=Backbone.View.extend({templatePath:"leap",id:"leap-container",events:{"click #player-close":"closePlayer","click .now-playing-link":"preventLinkNav","click #full-play":"triggerPlayClick","click #full-prev":"triggerPrevClick","click #full-next":"triggerNextClick","click #full-volume":"toggleMute","click .gesture-anim":"fireAnim","click #leap-overlay":"closePlayer",dropinit:"handleDropInit",dropstart:"handleDropStart",drop:"handleDrop"},initialize:function(){this.model=r.model,this.player=r.model.get("player"),this.$parent=$("#stage"),this.swf=n.Services.SWF,this.$nowPlayingImage=$("#now-playing-image"),this.renderDfd=$.Deferred(),this.destroyDfd=$.Deferred(),n.on("player:nextSong",this.showNextClick,this),n.on("player:previousSong",this.showPrevClick,this),n.on("queue:setSize",this.checkQueue,this),this.player.on("change:volume",this.setVolumeControl,this),this.player.on("change:isMuted",this.checkMute,this),this.player.on("change:playStatus",this.showPlayClick,this),$(document).on("keydown.leapOverlay",_.bind(function(e){e.which===_.keyboard.ESC&&this.closePlayer()},this))},render:function(){this.fetchTemplate("leap").always(_.bind(this.onTemplate,this))},onTemplate:function(e){this.$el.html(this.renderTemplate(e,{num:0})),this.$parent.prepend(this.$el),this.openPlayer()},openPlayer:function(){this.checkQueue(),this.imgWidth=this.$nowPlayingImage.attr("width");var e=$("#full-play"),t=$("#now-playing"),n=this.player.get("currentQueue").get("activeSong");!this.player.playStatusIsPlaying()&&!e.hasClass("paused")?e.addClass("paused").removeClass("playing"):e.hasClass("playing")||e.removeClass("paused").addClass("playing"),this.removeTooltips(),n&&this.$nowPlayingImage.attr({src:n.getImageURL(500)}),t.addClass("hide"),this.$nowPlayingImage.attr("width","300px").attr("height","300px"),this.setVolumeControl(),$(".np-actions").addClass("hide"),$(".np-text").html(_.getString("BY")+"&nbsp;"),t.prependTo("#leap-player").removeClass("hide"),$("#leap-elements").appendTo("#now-playing"),$("#leap-player").removeClass("hide"),this.player.set("uiMode","leap-overlay"),this.renderDfd.resolve()},checkQueue:function(){var e=$("#now-playing");this.player.get("currentQueue").get("songs").length!==0?(e.removeClass("empty-player"),this.removeTooltips()):e.addClass("empty-player")},closePlayer:function(){var e=$("#now-playing");e.find(".song").addClass("show-song-tooltip song-link"),e.find(".artist").addClass("show-artist-tooltip"),$("#leap-container").addClass("hide"),this.$nowPlayingImage.attr("width",this.imgWidth).attr("height",this.imgWidth),e.appendTo("#player").addClass("hide"),$("#leap-elements").appendTo("#leap-player"),e.removeClass("hide"),$(".np-actions").removeClass("hide"),$(".np-text").html("&nbsp;"+_.getString("BY")+"&nbsp;"),this.player.set("uiMode","normal"),n.External.LeapPlayer.closePlayer()},onDestroy:function(){n.off("player:nextSong",this.showNextClick,this),n.off("player:previousSong",this.showPrevClick,this),n.off("queue:setSize",this.checkQueue,this),this.player.off("change:volume",this.setVolumeControl,this),this.player.off("change:isMuted",this.checkMute,this),this.player.off("change:playStatus",this.showPlayClick,this),$(document).off(".leapOverlay"),this.destroyDfd.resolve()},removeTooltips:function(){var e=$("#now-playing");_.defer(function(){e.find(".song").removeClass("show-song-tooltip song-link"),e.find(".artist").removeClass("show-artist-tooltip")})},visualHighlight:function(e){e.stop(!0,!1).css("background-color","#F77F00").delay(300).animate({"background-color":"#3a3a3a"},1e3)},showPlayClick:function(){var e=$("#full-play");!this.player.playStatusIsPlaying()&&!e.hasClass("paused")?(this.visualHighlight(e),e.addClass("paused").removeClass("playing")):e.hasClass("playing")||(this.visualHighlight(e),e.removeClass("paused").addClass("playing"))},triggerPlayClick:function(){var e=this.player.get("currentQueue");if(e){var t=this.player.get("currentQueue").get("activeSong");t&&n.trigger("guts:log","playButtonClicked",{activeSong:t.get("SongID"),leap:!0})}n.trigger("player:togglePlay")},showNextClick:function(){this.visualHighlight($("#full-next"))},triggerNextClick:function(){var e=this.player.get("currentQueue");if(e){var t=this.player.get("currentQueue").get("activeSong");t&&n.trigger("guts:log","skipForwardClicked",{activeSong:t.get("SongID"),leap:!0})}n.trigger("player:nextSong")},showPrevClick:function(){this.visualHighlight($("#full-prev"))},triggerPrevClick:function(){var e=this.player.get("currentQueue");if(e){var t=this.player.get("currentQueue").get("activeSong");t&&n.trigger("guts:log","skipBackClicked",{activeSong:t.get("SongID"),leap:!0})}n.trigger("player:previousSong")},setVolumeControl:function(){var e=this.swf.getVolume(),t=Math.round(e/7.333)*-60+"px 0px",n=$("#volume"),r=$("#volume-control"),i=$("#full-volume");e<8&&(t="0px 0px"),this.player.get("isMuted")?(t="0px 0px",i.addClass("mute"),n.addClass("mute"),r.addClass("hide")):n.hasClass("mute")&&(i.removeClass("mute"),n.removeClass("mute"),r.removeClass("hide")),$(".circle-volume").css("background-position",t)},toggleMute:function(){n.trigger("player:volumeMute")},checkMute:function(){this.player.get("isMuted")?($("#full-volume").addClass("mute"),this.setVolumeControl()):($("#full-volume").removeClass("mute"),this.setVolumeControl())},fireAnim:function(e){var t=e.target;!$(".animating").length&&$(t).attr("id")&&($(t).parent().addClass("animating"),this.checkAnimSupport(t),this.animateUIEl(t,e))},checkAnimSupport:function(n){function p(){var t=0,r=0,i=setInterval(function(){$(n).css("background-position-x",t+"px"),$(n).css("background-position-y","0px"),r++,t-=130,t<=-3900&&(i=e.clearInterval(i),$(n).removeClass("animating"))},50)}function d(){function n(e,n,r){for(var i=0;i<t.length;i++)t[i]||(n=n.toLowerCase()),e.on(t[i]+n,r)}function r(e,n,r){for(var i=0;i<t.length;i++)t[i]||(n=n.toLowerCase()),e.off(t[i]+n,r)}function i(){e.removeClass("animating"),r(e,"AnimationEnd",i)}var e=$(".animating"),t=["webkit","moz","MS","o",""];n(e,"AnimationEnd",i)}var r="Webkit Moz O ms Khtml".split(" "),i=$(n)[0],s=!1,o=!1,u="animation",a="transform",f="",l="";i.style.animationName&&(s=!0),i.style.transform&&(o=!0);if(s===!1)for(var c=0;c<r.length;c++)if(i.style[r[c]+"AnimationName"]!==t){l=r[c],u=l+"Animation",f="-"+l.toLowerCase()+"-",s=!0;break}if(o===!1)for(var h=0;h<r.length;h++)if(i.style[r[c]+"Transform"]!==t){l=r[c],a=l+"Transform",o=!0;break}s===!1?p():d()},animateUIEl:function(e,t){$(e).attr("id")==="leap-swipe"&&(setTimeout(function(){$("#full-prev").css("background-color","#F77F00").delay(300).animate({"background-color":"#3a3a3a"},1e3)},600),setTimeout(function(){$("#full-next").css("background-color","#F77F00").delay(300).animate({"background-color":"#3a3a3a"},1e3)},1500));if($(e).attr("id")==="leap-tap"){var n=$("#full-play");setTimeout(function(){n.stop(!0,!1).css("background-color","#F77F00").delay(300).animate({"background-color":"#3a3a3a"},1e3),n.hasClass("playing")?(n.addClass("paused"),n.removeClass("playing")):(n.removeClass("paused"),n.addClass("playing"))},350),setTimeout(function(){n.stop(!0,!1).css("background-color","#F77F00").delay(300).animate({"background-color":"#3a3a3a"},1e3),n.hasClass("playing")?(n.addClass("paused"),n.removeClass("playing")):(n.removeClass("paused"),n.addClass("playing"))},1400)}$(e).attr("id")==="leap-palm"&&setTimeout(function(){$("#lightbox-close").css("background-color","#F77F00").delay(300).animate({"background-color":"#000000"},1e3)},600);if($(e).attr("id")==="leap-circle"){var r=-300;for(var i=0;i<6;i++)setTimeout(function(){$(".circle-volume").css("background-position",r+"px 0px"),r-=60},100*i);for(var s=0;s<6;s++)setTimeout(function(){r+=60,$(".circle-volume").css("background-position",r+"px 0px")},100*s+1e3);setTimeout(_.bind(this.setVolumeControl,this),2200)}},isObjectDropable:function(e){var t=this.model.get("player"),r=t.get("currentQueue"),i=r?r.get("currentBroadcast"):null,s=r?r.get("isBroadcasting"):!1,o=r&&!0;if(o&&s&&e){var u=t.get("position"),a=t.get("duration");if(i.get("listenersCount")>n.Services.SWF.largeBroadcastThreshold&&r.get("nextSong")===e&&a&&a-u<n.Services.SWF.broadcastNextPreventPosition)o=!1;else{var f=r.get("songs"),l=f.indexOf(e);l>-1&&l<f.indexOf(r.get("activeSong"))&&(o=!1)}}return o},handleDropInit:function(e,t){var n=$(e.srcElement).closest(".queue-item"),r=!0;n.length===1?r=this.isObjectDropable(n.data("module").model):r=this.isObjectDropable(),this.$el.data("valid-drop",r)},handleDropStart:function(e,t){if(t.draggedItems.length===0)return!1},handleDrop:function(e,t){function h(e,t){!_.isArray(t)&&t.toArray&&(t=t.toArray());var r=this.model.get("player"),i=r&&r.get("currentQueue"),s=i&&i.get("songs");n.trigger("player:addSongs",t,-1,s.length===0,e)}t.draggedItemsType=t.draggedItemsType||_.getCollectionType(t.draggedItems);if(t.draggedItemsType=="song"&&t.draggedItems&&t.draggedItems.length){var i=t.draggedItems[0];if(!this.isObjectDropable(i))return;var s=i.get("queueSongID"),o=this.model.get("player"),u=o&&o.get("currentQueue"),a=u&&u.get("songs");if(s&&a&&a.length){n.Services.SWF.moveSongsTo([s],a.length);return}}else if(!this.isObjectDropable())return;var f,l,c;switch(t.draggedItemsType){case"song":_.bind(h,this)(t.draggedItemsContext,t.draggedItems);break;case"album":case"artist":case"playlist":case"broadcast":for(f=0,c=t.draggedItems.length;f<c;f++)l=t.draggedItems[f],_.isFunction(l.getSongs)&&l.getSongs().then(_.bind(h,this,new n.Models.PlayContext(l)));break;case"tag":var p=t.draggedItems[0];r.playGenre(p.get("DisplayName"),p.get("TagID"));break;case"user":for(f=0,c=t.draggedItems.length;f<c;f++)l=t.draggedItems[f],_.isFunction(l.getFavorites)&&l.getFavorites("Songs").then(_.bind(h,this,new n.Models.PlayContext(l)))}},preventLinkNav:function(e){e.preventDefault()}})}(),function(){function o(e,t){return function(n){return e.filter(function(e){return _.startsWith(e.attributes[t],n)})}}function u(){i&&t&&(i.hide(),t.append('<img id="taco-explosion" src="'+_.getCDNImage("tacoExplosion.gif")+'" style="position: absolute; height: 20px;" />'),setTimeout(function(){t.addClass("boom")},10),setTimeout(function(){t.removeClass("boom").addClass("hide"),$("#taco-explosion").remove(),i.show()},700),s=0)}function a(){this.userNotificationsFailed=!0}function f(n){this.userNotificationsFailed=!1;var r=e.get("artistID"),o;if(e.get("pageNameData")&&n&&n.length){s=0;var u=e.get("pageNameData").NotificationReadTime;u?n.each(function(e){o=e.get("forArtistID"),e.get("timestamp")>=u&&(!o||o==r)&&s++}):s=n.length,i.text(s),s>0?t.removeClass("hide"):t.addClass("hide")}n.on("add",this.newNotification,this)}n.Views=n.Views||{};var e,t,i,s=0;n.Views.Header=Backbone.View.extend({templatePath:"header",autocompleteTooltip:null,tacobellTooltip:null,events:{"mouseenter #logo":"showExploreDropdown","click #logo":"handleLogoClick","click #settings-button":"showSettingsDropdown","submit #header-search":"performSearch","click #header-search .placeholder":"focusSearch","click #header-search .remove":"clearSearch","click #header-search .icon.search":"submitSearch","focus #header-search input":"onSearchFocus","blur #header-search input":"onSearchBlur","keydown input.search":"onSearchKeydown","keyup input.search":"onSearchKeyup","mousedown input.search":"onSearchMousedown","click .clear-filter":"onClearFilterClick","click #notification-button":"showNotifications","mouseenter #settings-button":"onSettingsMouseenter","mouseenter #upload-button":"onUploadMouseenter","mouseenter #notification-button":"onNotificationsMouseenter","mouseenter #header-back-btn":"onBackBtnMouseenter","mouseenter #header-forward-btn":"onForwardBtnMouseenter","mouseenter #header-copy-btn":"onCopyBtnMouseenter","click #close-top-hat":"closeTopHat","click #header-back-btn":"navigateBack","click #header-forward-btn":"navigateForward","click #header-copy-btn":"toggleClipboardTooltip","mouseenter #profile-button":"showUserDropdown","click #upload-button":"logUploadClick"},initialize:function(){this.$search=$(),this.$placeholder=$(),this.$prediction=$(),this.$clearFilter=$(),this.artistContextScroll=!1,this.userNotificationsFailed=!0,n.ready.done(_.bind(function(){this.model.on("change:user",this.onModelUserChange,this),this.onModelUserChange(),n.on("router:change",_.bind(this.updateNavButtons,this)),n.on("tophat:open",_.bind(this.openTopHat,this)),n.on("tophat:close",_.bind(this.closeTopHat,this))},this)),$(document).on("keydown",_.bind(function(e){var t=e.target&&e.target.tagName||"",n=["input","textarea","select","object"];if(!_.isString(t)||_.indexOf(n,t.toLowerCase())!=-1)return;var r=e.which,i=e.metaKey||e.ctrlKey,s=String.fromCharCode(r).replace(/\s+/g,"");r==8?history.back():s!==""&&!_.playerShortcuts[r]&&!_.specialKeys[r]&&!i&&!this.model.get("lightboxOpen")&&(this.$el.find("input.search").val("").select().focus(),this.onSearchKeydown(e));if(String.fromCharCode(r)==" "&&this.getSearchValue().length===0)return!1},this))},render:function(){if(!e)return;var t=$("#page-wrapper").width(),r=$("#page-helper").width(),i=t-r,s=new Date,o=(new Date).setFullYear(2014,0,28),u=_.getString("MONTHS").split(",")[0];$("#header").css({left:Math.ceil(i/2)*-1}),this.fetchTemplate("search").always(_.bind(this.renderSearch,this)),e.get("isLoggedIn")?this.fetchTemplate("loggedIn").always(_.bind(this.renderUserOptions,this,!0)):this.fetchTemplate("loggedOut").always(_.bind(this.renderUserOptions,this,!1)),!n.Services.Local.get("gs.notifTopHat")&&o-s>0&&n.trigger("tophat:open",{name:"notif",template:"topHatNotif",templateVars:{text:_.getString("TOP_HAT_TOS",{date:u+" 28, 2014"}),url:"/#!/legal/terms",urlText:_.getString("TOP_HAT_TOS_LINK")}}),(n.External.AIRBridge&&n.External.AIRBridge.isDesktop||n.External.DesktopBridge.active)&&this.fetchTemplate("desktopNavigation").always(_.bind(this.renderDesktopNav,this))},destroy:function(){this._super.apply(this,["destroy"].concat(_.toArray(arguments)))},renderUserOptions:function(n,r){if(n!==e.get("isLoggedIn"))return;this.model.off("change:user",this.updateUserMenu,this),e.off("change",this.updateUserMenu,this),$("#header-user-assets").html(this.renderTemplate(r));if(e.get("isLoggedIn")){var s=_.chainLoading();s.push(e.getPageNameData()),s.push(e.getNotifications().done(s.bind(f,this)).fail(s.bind(a,this,!1))),t=$("#header-notification-pill"),i=$("#header-notification-count"),this.model.on("change:user",this.updateUserMenu,this),e.on("change",this.updateUserMenu,this)}},renderSearch:function(e){var t=$("#header-search-container");t.removeClass("hide"),t.html(this.renderTemplate(e)),this.$search=t.find("input.search"),this.$placeholder=t.find(".placeholder"),this.$prediction=t.find(".prediction"),this.$clearFilter=t.find(".clear-filter")},renderDesktopNav:function(e){$("#desktop-nav").html(this.renderTemplate(e)).removeClass("hide")},toggleClipboardTooltip:function(e){var t=this.$("#header-copy-btn");if(this.clipboardTooltip&&!this.clipboardTooltip.destroyed){n.trigger("tooltip:close");return}this.clipboardTooltip=new n.Views.Tooltips.Clipboard,n.trigger("tooltip:open",{sticky:!0,fixPosition:!0,delay:0,notchSize:6,notchX:157,notchBackgroundColor:"#323232",notchBorderColor:"#000",width:300,x:"center",y:48,$attached:t,views:[this.clipboardTooltip],tooltipClass:"header-clipboard dark",tooltipKey:"clipboard-tooltip"}),t.addClass("active"),this.clipboardTooltip.destroyDfd.always(_.bind(function(){t.removeClass("active")},this))},onModelUserChange:function(r){if(e&&e.get("UserID")===this.model.get("user").get("UserID"))return;var i=!1;e&&(e.get("notifications")&&e.get("notifications").off(null,null,this),e.off(null,null,this),this.userNotificationsFailed=!0,s=0,t&&t.addClass("hide"),i=!0),e=this.model.get("user"),e.bind("change",this.onUserChange,this),i&&(this.render(),this.tacobellTooltip&&(this.tacobellTooltip.openDfd&&this.tacobellTooltip.openDfd.state()==="pending"&&n.trigger("tooltip:close"),this.tacobellTooltip.destroy(),this.tacobellTooltip=null))},onUserChange:function(e){var t=e.changedAttributes();t&&(t.PathName&&$("#profile-button").attr("href",e.toUrl()),t.Picture&&$(".profile-img","#profile-button").attr("src",e.getImageURL(30)),t.Context&&(this.tacobellTooltip&&this.tacobellTooltip.destroy(),$("#profile-button").attr("href",e.toUrl()),$("#profile-button .title").text(e.getShortName()),$("#profile-button .profile-img").attr("src",e.getImageURL(30)),this.updateExploreDropdown()),t.Name&&$("#profile-button .title").text(e.getShortName()))},updateUserMenu:function(){var e=$("#profile-button"),t=r.model.get("user"),i=_.toInt(t.get("primaryUserID")),s=t.get("artistsOwned");this.userMenuOptions={delay:0,notchSize:6,notchX:16,width:170,x:1,y:30,$attached:e,tooltipClass:"menu user-menu"};var o=function(e){n.trigger("guts:gatrack","site","headerClick",e),n.trigger("guts:log","headerClick",{buttonLabel:e}),n.trigger("tooltip:close","user-menu")},u=[{localeKey:"PROFILE",url:t.toUrl(),click:_.bind(o,this,"profile")}];t.get("artistID")&&u.push({localeKey:"DASHBOARD",url:t.toUrl("dashboard"),click:_.bind(o,this,"dashboard")}),u.push({localeKey:"COLLECTION",url:t.toUrl("collection"),click:_.bind(o,this,"my music")},{localeKey:"FAVORITES",url:t.toUrl("collection/favorites"),click:_.bind(o,this,"favorites")},{localeKey:"PLAYLISTS",url:t.toUrl("playlists"),click:_.bind(o,this,"playlists")});var a={model:t,appModel:this.model,items:u},f=s&&s.length;f&&s.length==1&&!i&&s.at(0).get("ArtistID")===t.get("artistID")&&(f=!1);if(f){var l=[],c;i&&t.get("Flags")&n.Models.User.FLAG_ARTIST_PROFILE?c=t.escape("primaryFName"):c=t.escape("Name"),l.push({title:_.getString("USE_GROOVESHARK_AS"),type:"title"}),l.push({title:c,click:function(){i&&r.model.authenticateAsAuthorizedUser(i)},itemClass:!i||t.id==i?"active":""}),s.length>9?(l.push({type:"html",html:'<div class="js-scrollable"><div class="scrollbar"><div class="track"><div class="thumb"><div class="end"></div></div></div></div><div class="viewport"><div class="overview">'}),this.artistContextScroll=!0):this.artistContextScroll=!1,s.sort(),s.each(function(e){var i=e.get("profileID"),s=i==t.id;l.push({title:e.escape("ArtistName"),click:function(){n.Models.Profile.get(null,e.id).done(function(e){if(!e.id)return;r.model.authenticateAsAuthorizedUser(e.id)})},itemClass:s?"active":""})}),this.artistContextScroll&&l.push({type:"html",html:"</div></div></div>"}),a.items.push({type:"divider"}),a.items=a.items.concat(l)}a.items.push({type:"divider"}),a.items.push({localeKey:"SIGN_OUT",click:_.bind(function(){this.model.logout()},this)}),this.userMenuTooltip?this.userMenuTooltip.updateMenuOptions(a.items):this.userMenuTooltip=new n.Views.Tooltips.Menu(a),this.userMenuOptions.views=[this.userMenuTooltip],this.userMenuOptions.tooltipKey="user-menu",this.userMenuOptions.persistOnRouterChange=!0},showUserDropdown:function(e){if(this.userMenuTooltip&&this.userMenuTooltip.openDfd&&this.userMenuTooltip.openDfd.state()==="pending")return;this.userMenuTooltip||this.updateUserMenu();var t=$(e.currentTarget);$.hideJJMenu(),t.addClass("active"),this.userMenuOptions.dfd=$.Deferred(),n.trigger("tooltip:open",this.userMenuOptions),this.userMenuTooltip.openDfd=this.userMenuOptions.dfd,this.userMenuTooltip.renderDfd.done(_.bind(n.Models.Ad.hideFlashElements,n.Models.Ad)),this.userMenuTooltip.openDfd.always(function(){n.Models.Ad.showFlashElements(),t.removeClass("active")}),this.artistContextScroll&&$(".js-scrollable",".user-menu").tinyscrollbar()},updateExploreDropdown:function(){this.exploreTooltip&&(this.exploreTooltip.destroy(),delete this.exploreTooltip);var e=$("#logo"),t=this.model.get("user");this.headerMenuOptions={delay:0,notchSize:6,width:170,notch:!1,x:1,y:"bottom",$attached:e,tooltipClass:"header-explore"};if(!this.exploreTooltip){var r=function(e){n.trigger("guts:gatrack","site","headerClick",e),n.trigger("guts:log","headerClick",{buttonLabel:e}),n.trigger("tooltip:close","explore")},i=[{localeKey:"HOME",url:"/#!/",click:_.bind(r,this,"home")},{localeKey:"GENRES",descriptionKey:"TAGS_TAGLINE",url:"/#!/genres",click:_.bind(r,this,"genres")},{localeKey:"BROADCASTS",descriptionKey:"BROADCASTS_TAGLINE",url:"/#!/broadcasts",click:_.bind(r,this,"broadcasts")},{localeKey:"COMMUNITY",descriptionKey:"COMMUNITY_TAGLINE",url:"/#!/community",click:_.bind(r,this,"community")},{localeKey:"POPULAR",descriptionKey:"POPULAR_TAGLINE",url:"/#!/popular",click:_.bind(r,this,"popular")}],s={model:t,appModel:this.model,items:i};this.exploreTooltip=new n.Views.Tooltips.Menu(s)}this.headerMenuOptions.views=[this.exploreTooltip],this.headerMenuOptions.tooltipKey="explore",this.headerMenuOptions.persistOnRouterChange=!0},showExploreDropdown:function(e){if(this.exploreTooltip&&this.exploreTooltip.openDfd&&this.exploreTooltip.openDfd.state()==="pending")return;this.exploreTooltip||this.updateExploreDropdown();var t=$(e.currentTarget);$.hideJJMenu(),t.addClass("active"),this.headerMenuOptions.dfd=$.Deferred(),n.trigger("tooltip:open",this.headerMenuOptions),this.exploreTooltip.openDfd=this.headerMenuOptions.dfd,this.exploreTooltip.renderDfd.done(_.bind(n.Models.Ad.hideFlashElements,n.Models.Ad)),this.exploreTooltip.openDfd.always(function(){n.Models.Ad.showFlashElements(),t.removeClass("active")})},handleLogoClick:function(e){n.trigger("guts:gatrack","site","headerClick","logo"),n.trigger("guts:log","headerClick",{buttonLabel:"logo"})},showSettingsDropdown:function(e){n.trigger("tooltip:close");var t=$(e.currentTarget);n.Models.Ad.hideFlashElements(),t.jjmenu(e,this.getSettingsOptions(),null,{xposition:"right",yposition:"bottom",show:"default",spill:"left",keepState:t,className:"settings-dropdown",shouldLog:!0}),n.trigger("guts:gatrack","site","headerClick","onSettings"),n.trigger("guts:log","headerClick",{headerAction:"onSettings"})},getSettingsOptions:function(){var e=[],t=this.model.get("user"),r=t.get("UserID"),i=t.get("subscription");return e.push({key:"SETTINGS",title:_.getString("SETTINGS"),action:{type:"gourl",url:r>0?"/#!/settings":"/#!/settings/preferences"}},{key:"LANGUAGE",title:_.getString("LANGUAGE"),action:{type:"fn",callback:function(){n.trigger("lightbox:open","locale"),n.trigger("guts:log","localeLBOpenedFromHeader"),n.trigger("guts:gatrack","site","localeLBOpenedFromHeader")}}}),i&&i.isPremium()&&e.push({key:"HOME_THEMES",title:_.getString("HOME_THEMES"),action:{type:"gourl",url:"/#!/settings/design"}}),i&&i.canDirectEmail()&&e.push({key:"FEEDBACK",title:_.getString("FEEDBACK"),action:{type:"fn",callback:function(){n.trigger("lightbox:open","feedback",{type:"feedback"})}}}),r>0&&e.push({key:"INVITE_FRIENDS",title:_.getString("INVITE_FRIENDS"),action:{type:"fn",callback:function(){n.trigger("lightbox:open","invite")}}}),t.get("Flags")&n.Models.User.FLAG_KINESIS&&e.push({key:"SETTINGS_NAV_SURVEYS",title:_.getString("SETTINGS_NAV_SURVEYS"),action:{type:"gourl",url:"/#!/surveys"}}),e.push({key:"HOME_HELP",title:_.getString("HOME_HELP"),action:{type:"gourl",target:"_blank",url:"http://help.grooveshark.com"}}),r<0&&e.push({customClass:"separator"},{key:"SIGN_UP",title:_.getString("SIGN_UP"),action:{type:"fn",callback:function(){n.trigger("lightbox:open","signup")}}}),e},getSearchValue:function(){var e=this.$el.find("input.search"),t=e.val();return t||""},focusSearch:function(e){this.$el.find("input.search").focus()},clearSearch:function(e){return e.preventDefault(),this.$el.find("input.search").val("").blur(),!1},submitSearch:function(e){return e.preventDefault(),$("#header-search").submit(),!1},performSearch:function(e){e.preventDefault();var t=$(e.currentTarget),r=this.getSearchValue(),i=t.find(".search-results"),s=i.find("li.selected");if(s.is(".search-item-result"))return n.router.setHash("/artist/~/"+s.children("a.search-item").attr("data-artist-id")),i.hide(),this.$el.find("input.search").blur().val(""),!1;var o=t.attr("data-search-type")||"";return r&&r.length&&(n.trigger("guts:log","searchQuerySubmitted",{type:o,searchString:r}),n.router.performSearch(o,r)),!1},onSearchFocus:function(t){var n=$(t.currentTarget);this.$placeholder.css({color:"#b2b2b2"});if(n.length)try{n[0].selectionStart=-1,n[0].selectionEnd=-1}catch(r){console.log("selectionStart error",r,r.message,r.code)}n.val()&&setTimeout(function(){n.select()},50);if(n.data("isFakeFocusing")){n.data("isFakeFocusing",null);return}e.getLibrary().done(_.bind(this.doAutocomplete,this,n))},onSearchBlur:function(e){var t=$(e.currentTarget);t.val()||(this.$placeholder.removeClass("hide").css({color:""}),this.$clearFilter.addClass("hide")),this.autocompleteTooltip&&setTimeout(_.bind(function(){this.autocompleteTooltip=null,n.trigger("tooltip:close")},this),200)},onSearchKeydown:function(t){e.getLibrary();var r=this.$el.find("input.search"),i,s,o;this.autocompleteTooltip&&(i=this.autocompleteTooltip.$el,s=$(".ac-list-item.selected",i),o=s.parents(".ac-section"));switch(t.which){case _.keyboard.ENTER:if(s.length){var u=s.find(".ac-item-link").attr("href");if(u){n.router.setHash(u),r.val("");return}var a=s.find(".ac-item-link").data("songId");if(a){var f=n.Models.Song.getCached(a);if(f){f.getToken().done(function(){n.router.setHash(f.toUrl())}),r.val("");return}}}var l=r.parents("form");l&&l.length&&l.submit(),r.blur();return;case _.keyboard.ESC:i?(this.autocompleteTooltip=null,n.trigger("tooltip:close")):(r.val(""),this.doAutocompleteDebounced(r));return;case _.keyboard.UP:t.preventDefault();if(i){var c=s.is(":first-child"),h=o.is(":first-child");!s.length||h&&c?$(".ac-list-item:last",i).addClass("selected"):c?o.prev(".ac-section").children(".ac-list").children(":last-child").addClass("selected"):s.prev().addClass("selected"),s.removeClass("selected")}return;case _.keyboard.DOWN:t.preventDefault();if(i){var p=s.is(":last-child"),d=o.is(":last-child");!s.length||p&&d?$(".ac-list-item:first",i).addClass("selected"):p?o.next(".ac-section").children(".ac-list").children(":first-child").addClass("selected"):s.next().addClass("selected"),s.removeClass("selected")}return;case _.keyboard.TAB:var v=this.$prediction.text();return}this.displaySearchHelpers(t),this.cancelAutocompleteRequests(),this.doAutocompleteDebounced(r)},onSearchKeyup:function(e){this.displaySearchHelpers(e);var t=$(e.currentTarget);t.val()||t.focus()},displaySearchHelpers:function(e){var t=$(e.currentTarget),n=e.which,r=String.fromCharCode(n).replace(/[\b]/g,""),i=String.fromCharCode(n).replace(/[\s]/g,"");if(i&&i.length>0){var s=!t.val()||t.val()===""&&r&&r.length<1;this.$placeholder[s?"removeClass":"addClass"]("hide"),this.$el.find(".clear-filter")[s?"addClass":"removeClass"]("hide"),s&&this.setPrediction()}},onSearchMousedown:function(e){e.which==3&&this.$placeholder.addClass("hide")},onClearFilterClick:function(e){this.clearSearch(e),n.trigger("guts:log","filterTextCancelClicked"),n.trigger("guts:gatrack","user","filterTextCancelClicked")},cancelAutocompleteRequests:function(){this.autocompleteTooltip&&this.autocompleteTooltip.cancelPendingRequests()},doAutocompleteDebounced:_.debounce(function(e){return this.doAutocomplete(e)},100),doAutocomplete:function(t){var r=$.trim((t.val()||"").toLowerCase());if(r.length>1&&this.autocompleteTooltip)this.autocompleteTooltip.changeQuery(r);else if(r.length>1){var i={sticky:!0,width:333,notchX:30,notch:"top",notchBackgroundColor:"#F5F5F5",x:3,y:32,$attached:$("#header-search"),tooltipKey:"autocomplete",fixPosition:!1,tooltipClass:"ac"},s=e?e.get("library"):!1,u=e?e.get("favoriteArtists"):!1,a=e?e.get("favoriteUsers"):!1,f=e?e.get("playlists"):!1,l=e?e.get("favoritePlaylists"):!1,c=function(){return[]},h=!1,p=!1;if(u&&u.length||s&&s.length)h=function(e){var t=[];u&&u.length&&(t=t.concat(u.filter(function(t){return _.startsWith(t.attributes.ArtistName,e)})));if(s&&s.length){var n=s.filter(function(t){return _.startsWith(t.get("ArtistName"),e)});n.length&&(n=_.map(n,function(e){return e.getArtists(e.attributes.ArtistID)}),t=t.concat(n),t=_.uniq(t))}return t};if(f&&f.length||l&&l.length)p=function(e){var t=[];f&&f.length&&(t=t.concat(f.filter(function(t){return _.startsWith(t.attributes.PlaylistName,e)})));if(l&&l.length){var n=l.filter(function(t){return _.startsWith(t.attributes.PlaylistName,e)});n.length&&(t=t.concat(n),t=_.uniq(t))}return t};this.autocompleteTooltip=new n.Views.Tooltips.Autocomplete({query:r,maxResults:12,sections:[{type:"Artists",filterFunction:h||c,search:!0,useCombinedResults:!0},{type:"Users",filterFunction:a&&a.length?o(a,"Name"):c,search:!1},{type:"Songs",filterFunction:s&&s.length?o(s,"SongName"):c,search:!0,useCombinedResults:!0},{type:"Albums",search:!0,useCombinedResults:!0},{type:"Playlists",filterFunction:p||c,search:!1}]}),i.views=[this.autocompleteTooltip],n.trigger("tooltip:open",i);var d=_.bind(function(e){var t,n;switch(e){case"progress":n=arguments[1];if(n=="resultsChanged"||n=="rendered")t=arguments[2];break;case"fail":case"done":t={}}t&&(t.sections&&_.each(t.sections,_.bind(function(e){if(e.type==="Artists"){var t=e.results.models;this.lastPrediction=t&&t[0]&&t[0].get("ArtistName")||this.lastPrediction||""}},this)),this.setPrediction())},this);i.dfd.progress(_.bind(d,this,"progress")),i.dfd.done(_.bind(d,this,"done")),i.dfd.fail(_.bind(d,this,"fail")),i.dfd.then(_.bind(function(){this.autocompleteTooltip=null},this))}else this.autocompleteTooltip&&(this.autocompleteTooltip=null,n.trigger("tooltip:close"))},setPrediction:function(e){return;var t,n,r},newNotification:function(r){if(this.tacobellTooltip&&this.tacobellTooltip.openDfd&&this.tacobellTooltip.openDfd.state()==="pending")this.tacobellTooltip.newNotification(r),setTimeout(n.Services.API.updateNotificationReadTime,1e3);else{var o=e.get("artistID"),u=r.get("forArtistID");if(!u||u==o)s++,i.text(s),t.removeClass("hide")}},showNotifications:function(t){t.preventDefault();if(this.userNotificationsFailed)return;if(this.tacobellTooltip&&this.tacobellTooltip.openDfd&&this.tacobellTooltip.openDfd.state()==="pending"){n.trigger("tooltip:close");return}var r={sticky:!0,delay:0,notchSize:6,notchX:300,notch:"top",x:-286,y:"bottom",$attached:$("#notification-button"),tooltipClass:"header-notifications",destroyViewOnClose:!1};this.tacobellTooltip||(this.tacobellTooltip=new n.Views.Tooltips.Tacobell({model:e,appModel:this.model})),r.views=[this.tacobellTooltip],r.tooltipKey="tacobell",n.trigger("tooltip:open",r),this.tacobellTooltip.openDfd=r.dfd,s&&n.Services.API.updateNotificationReadTime().done(u),this.tacobellTooltip.renderDfd.done(_.bind(n.Models.Ad.hideFlashElements,n.Models.Ad)),$("#notification-button").addClass("active"),this.tacobellTooltip.openDfd.always(function(){n.Models.Ad.showFlashElements(),$("#notification-button").removeClass("active")}),n.trigger("guts:gatrack","site","headerClick","onTacoBell"),n.trigger("guts:log","headerClick",{headerAction:"onTacoBell"})},delayHeaderTooltip:function(e,t){_.delay(function(){var i=$(".jjmenu"),s=_.any(r.tooltip.tooltips,function(e,t){return t=="user-menu"});if(!s&&!i.length){var o=new n.Views.Tooltips.Helper({text:_.getString(t)});o.tooltipOptions.delay=500,o.tooltipOptions.adjustY=5,n.Views.Tooltips.Helper.simpleTooltip(e,o)}},40)},openTopHat:function(e){var t=_.orEqual(e.templateVars,{});this.fetchTemplate(e.template).done(_.bind(function(n){$("#top-hat-notif").data("topHatName",e.name).addClass(e.name),$("#top-hat-notif .inner").html(this.renderTemplate(n,t)),$("body").addClass("top-hat")},this))},closeTopHat:function(){n.Services.Local.set("gs."+$("#top-hat-notif").data("topHatName")+"TopHat",1),$("body").removeClass("top-hat")},onSettingsMouseenter:function(e){this.delayHeaderTooltip(e,"SETTINGS")},onUploadMouseenter:function(e){this.delayHeaderTooltip(e,"UPLOAD_MUSIC")},onNotificationsMouseenter:function(e){this.delayHeaderTooltip(e,"NOTIFICATIONS")},onBackBtnMouseenter:function(e){this.delayHeaderTooltip(e,"BACK")},onForwardBtnMouseenter:function(e){this.delayHeaderTooltip(e,"FORWARD")},onCopyBtnMouseenter:function(e){this.delayHeaderTooltip(e,"COPY_URL")},navigateBack:function(e){e&&e.preventDefault(),n.router.back()},navigateForward:function(e){e&&e.preventDefault(),n.router.forward()},updateNavButtons:function(){n.router&&(n.External.AIRBridge.isDesktop||n.External.DesktopBridge.active)&&($("#header-back-btn").attr("disabled",!n.router.hasBack),$("#header-forward-btn").attr("disabled",!n.router.hasForward))},logUploadClick:function(e){n.trigger("guts:gatrack","site","headerClick","onUpload"),n.trigger("guts:log","headerClick",{headerAction:"onUpload"})}})}(),function(){n.Views=n.Views||{};var e=function(e){e&&!(e instanceof n.Models.Song)&&(e=n.Models.Song.getCached(e.get("SongID")));if(!e||n.isBroadcastListener())return;var t=this.model.get("user");t.addLocalSongListen(e,Math.floor(($.now()+clientTimeDivergence)/1e3),!0)},t=15,i={},s=null,o=!1,u=300;n.Views.Player=Backbone.View.extend({templatePath:"player",events:{"click #player-details-current-song":"onCurrentSongClick","click #progress-bar":"onSeekClick",dropinit:"handleDropInit",dropstart:"handleDropStart",drop:"handleDrop","mouseenter #shuffle":"onMouseenterShuffle"},initialize:function(){this.$playerWrapper=$("#player-wrapper"),this.$player=$("#player"),this.$progressBar=$("#progress-bar"),this.$seekBuffer=$("#buffered"),this.$seekProgress=$("#elapsed"),this.$seekScrubber=$("#scrubber"),this.$timeElapsed=$("#time-elapsed"),this.$timeTotal=$("#time-total"),this.$nowPlaying=$("#now-playing"),this.$nowPlayingImage=$("#now-playing-image"),this.$nowPlayingMetadata=$("#now-playing-metadata"),this.$activeSongMenuBtn=$("#np-menu"),this.$activeSongCommentBtn=$("#np-comment"),this.$seekScrubber.on("dragstart",_.bind(this.onScrubberDragStart,this)),this.$seekScrubber.on("drag",_.bind(this.onScrubberDrag,this)),this.$seekScrubber.on("dragend",_.bind(this.onScrubberDragEnd,this)),this.$playPause=$("#play-pause"),this.$volume=$("#volume"),this.$volumeControl=$("#volume-control"),this.$shuffle=$("#shuffle"),this.$repeat=$("#repeat"),this.$playNext=$("#play-next"),this.$playPrevious=$("#play-prev"),this.$crossfade=$("#crossfade"),this.$upvote=$("#player-upvote"),this.$downvote=$("#player-downvote"),this.$playPause.on("click",_.bind(this.onPlayPauseClick,this)),this.$playNext.on("click",_.bind(this.onPlayNextSongClick,this)),this.$playPrevious.on("click",_.bind(this.onPlayPreviousSongClick,this)),this.$shuffle.on("click",_.bind(this.onShuffleClick,this)),this.$repeat.on("click",_.bind(this.onRepeatClick,this)),this.$crossfade.on("click",_.bind(this.onCrossfadeClick,this)),this.$upvote.on("click",_.bind(this.onUpvoteClick,this)),this.$downvote.on("click",_.bind(this.onDownvoteClick,this)),this.$activeSongMenuBtn.on("click",_.bind(this.onActiveSongMenuClick,this)),this.$activeSongCommentBtn.on("click",_.bind(this.onActiveSongCommentClick,this)),this.$volumeSlider=$("#volume-slider"),this.$volumeSlider.html('<div class="ui-slider-range"></div><a class="ui-slider-handle"></a>'),this.$volumeSliderBar=$("#volume-slider .ui-slider-range"),this.$volumeSliderHandle=$("#volume-slider .ui-slider-handle"),this.$volumeSlider.on("click",_.bind(this.onVolumeSliderBarMove,this)),this.$volumeSlider.on("mousedown",_.bind(this.onVolumeSliderBarDown,this)),this.$volumeSliderHandle.on("click",_.bind(this.preventSelection,this)),this.$volumeSliderHandle.on("mousedown",_.bind(this.preventSelection,this)),this.$volume.on("click",_.bind(this.onVolumeClick,this)),this.$volume.on("mouseenter",_.bind(this.onVolumeMouseEnter,this)),this.$volume.on("mouseleave",_.bind(this.onVolumeMouseLeave,this)),this.$volumeControl.on("mouseenter",_.bind(this.onVolumeControlMouseEnter,this)),this.$volumeControl.on("mouseleave",_.bind(this.onVolumeControlMouseLeave,this)),this.changeVolumeLevelSlider(this.model.get("player").get("volume")),n.on("player:volume:keychange",this.showVolumeBriefly,this),n.on("player:userActiveSongEngagement",this.userActiveSongEngagement,this),this.lockScrubber=!1,this.randomizeSongsThrottled=_.throttle(_.bind(this.randomizeSongs,this),500),this.model.get("player").on("change",this.onStatusChange,this)},preventSelection:function(e){e.preventDefault()},onStatusChange:function(e,t){var n=e.changed;(!_.isUndefined(n.duration)||!_.isUndefined(n.position)||!_.isUndefined(n.bytesLoaded))&&this.onPositionChange(),_.isUndefined(n.playStatus)||this.onPlayStatusChange(),_.isUndefined(n.currentQueue)||this.onModelQueueChange(),_.isUndefined(n.crossfadeEnabled)||this.$crossfade[n.crossfadeEnabled?"addClass":"removeClass"]("active"),_.isUndefined(n.volume)||this.changeVolumeLevelSlider(n.volume),_.isUndefined(n.isMuted)||(e.get("isMuted")?(this.$volume.addClass("mute"),this.$volumeControl.addClass("hide")):(this.$volume.removeClass("mute"),this.$volumeControl.removeClass("hide")))},onModelQueueChange:function(){var e=this.model.get("player"),t=e.previous("currentQueue"),n=e.get("currentQueue");t&&t.off(),n&&(n.on("change",this.onQueueChange,this),this.onQueueChange(n,{overwrite:!0}))},onQueueChange:function(e,t){t=_.extend({},t);var r=t.overwrite?e.toJSON():e.changed;_.isUndefined(r.activeSong)||this.onActiveSongChange(),_.isUndefined(r.shuffleEnabled)?e.get("isBroadcasting")&&this.$shuffle.removeClass("active"):this.$shuffle[r.shuffleEnabled?"addClass":"removeClass"]("active");if(!_.isUndefined(r.repeatMode)){var i=n.Models.Player.repeatModes;switch(r.repeatMode){case i.ALL:this.$repeat.addClass("active");break;case i.ONE:this.$repeat.addClass("active one");break;case i.NONE:default:this.$repeat.removeClass("active one")}}var s=e.get("currentBroadcast")&&!e.get("isBroadcasting"),o=e.get("currentBroadcast")&&e.get("currentBroadcast").isLoggedInUserOwner();e.get("nextSong")&&!s?this.$playNext.removeClass("disabled"):this.$playNext.addClass("disabled"),(e.get("previousSong")||e.get("activeSong")&&this.model.get("position")>5e3)&&!e.get("currentBroadcast")?this.$playPrevious.removeClass("disabled"):this.$playPrevious.addClass("disabled"),s?this.$playerWrapper.addClass("broadcast-listener"):this.$playerWrapper.removeClass("broadcast-listener"),o?this.$playerWrapper.addClass("is-broadcasting"):this.$playerWrapper.removeClass("is-broadcasting")},onPositionChange:function(){var e=this.model.get("player"),t=e.changed,n=Math.min(1,e.get("bytesLoaded")/e.get("bytesTotal")),r=Math.min(1,e.get("position")/e.get("duration")),i=this.$progressBar.width(),s=Math.min(i,n*100),o=Math.min(i,r*100),u=Math.min(i,Math.max(0,i*r));s=isNaN(s)?0:s,o=isNaN(o)?0:o,u=isNaN(u)?0:u-8,this.$seekBuffer.width(s+"%"),this.$seekProgress.width(o+"%"),this.lockScrubber||this.$seekScrubber.css("left",u),_.isUndefined(t.position)||this.$timeElapsed.text(_.millisToMinutesSeconds(e.get("position"),!0)),_.isUndefined(t.duration)||this.$timeTotal.text(_.millisToMinutesSeconds(e.get("duration"),!0));var a=e.get("currentQueue");e.get("position")>5e3&&!a.get("currentBroadcast")?this.$playPrevious.removeClass("disabled"):a.get("previousSong")||this.$playPrevious.addClass("disabled")},onPlayStatusChange:function(){var e=this.model.get("player"),t=e.get("currentQueue"),r=t&&t.get("activeSong"),i=n.Models.Player.playStatuses,s=n.Models.Player.repeatModes,o=e.get("playStatus"),u=e.previous("playStatus"),a=e.get("lastSongByStatus"),f=e.get("currentStreamServer");a||(a={},e.set({lastSongByStatus:a})),status.currentStreamServer&&status.currentStreamServer!==f&&e.set("currentStreamServer",status.currentStreamServer);switch(o){case i.NONE:u!==o&&(this.$nowPlaying.removeClass("buffering"),this.$playPause.removeClass("playing paused buffering"),$("body").removeClass("song-playing")),r&&(r.set({paused:!0}),$("body").addClass("song-playing"));break;case i.INITIALIZING:u!==o&&(this.$nowPlaying.addClass("buffering"),this.$playPause.removeClass("playing paused").addClass("buffering")),$("body").addClass("song-playing");break;case i.LOADING:u!==o&&(this.$playPause.hasClass("buffering")||(this.$nowPlaying.addClass("buffering"),this.$playPause.removeClass("playing paused").addClass("buffering"))),r&&r.set({paused:!1}),$("body").addClass("song-playing");break;case i.PLAYING:var l=e.get("duration"),c=r?r.get("SongID"):!1;if(u!==o||a[o]!=r)this.$nowPlaying.removeClass("buffering"),this.$playPause.addClass("playing").removeClass("paused buffering"),r&&(a[o]!=r||e.get("repeatMode")==s.ONE&&u==i.LOADING)&&l&&r.set("playerDuration",l),u!=i.LOADING&&n.trigger("guts:gatrack","player","loadingTime",f,0),console.log("setting unpaused on song",r),r&&r.set({paused:!1}),$("body").addClass("song-playing");this.pauseNextQueueSongID&&r&&this.pauseNextQueueSongID===r.get("queueSongID")&&(this.pauseNextQueueSongID=!1,setTimeout(_.bind(function(){this.pauseSong()},this),10)),e.get("position")%10<1;break;case i.PAUSED:u!==o&&(this.$nowPlaying.removeClass("buffering"),this.$playPause.addClass("paused").removeClass("playing buffering")),r&&r.set({paused:!0}),$("body").addClass("song-playing");break;case i.BUFFERING:u!==o&&!this.$playPause.hasClass("buffering")&&(this.$nowPlaying.addClass("buffering"),this.$playPause.addClass("buffering").removeClass("playing paused")),r&&r.set({paused:!1}),$("body").addClass("song-playing");break;case i.FAILED:u!==o&&(this.$nowPlaying.removeClass("buffering"),this.$playPause.removeClass("playing paused buffering")),r&&r.set({paused:!0}),$("body").removeClass("song-playing");break;case i.COMPLETED:u!==o&&(this.$nowPlaying.removeClass("buffering"),this.$playPause.removeClass("playing paused buffering"),r&&this.onSongCompleted(r)),r&&r.set({paused:!0}),this.$seekBuffer.width("0%"),this.$seekProgress.width("0%"),this.$seekScrubber.css("left",0),$("body").removeClass("song-playing")}a[o]=r,r&&r.trigger("change",r)},onActiveSongChange:function(){var e=this.model.get("player").get("currentQueue"),r=e.get("activeSong"),i=e.previous("activeSong"),o=this.model.get("user");i&&i.set({active:!1,paused:!0});if(!r)this.$nowPlayingMetadata.html("").addClass("hide"),this.$nowPlayingImage.addClass("hide"),this.$playPause.addClass("disabled"),this.$player.removeClass("playing"),$(document.body).removeClass("song-playing");else{this.activeSong&&this.activeSong.off("change",this.onActiveSongModelChange),this.activeSong=r,r.on("change",this.onActiveSongModelChange,this);var u={active:!0};this.model.get("player").get("playStatus")==3&&(u.paused=!1),r.set(u);var a,f,l=r.get("isCallout");if(l)f=r.escape("Name"),a=['<span data-callout-id="',r.get("CalloutID"),'" class="now-playing-link" title="',f,'">',f,"</a>"];else{var c=/^(.{15,25})[\s;]/i,h=function(e){return new RegExp("^(.{"+Math.max(10,e/2)+","+e+"})[s;]","i")},p=r.get("SongName"),d=r.get("ArtistName"),v=r.get("AlbumName")||"Unknown Album";p=_.escape(p),d=_.escape(d),v=_.escape(v);var m=_.getString("BY"),g=_.getString("ON"),y="&nbsp;"+m+"&nbsp;"+r.escape("ArtistName"),b=_.calculateTextWidth(p),w=_.calculateTextWidth(y),E=$("#np-meta-container"),S=E.width(),x=b+w,T="",N="";this.model.get("player").get("uiMode")!=="leap-overlay"&&(T="song-link show-song-tooltip",N="show-artist-tooltip"),a=['<a data-song-id="',r.get("SongID"),'" data-tooltip-cache-key="playerSong" class="now-playing-link song no-title-tooltip '+T+'" title="',r.escape("SongName"),'">',p,"</a>",'<div class="data-container">','<span data-translate-text="BY" class="np-text">&nbsp;',m,"&nbsp;</span>",'<a data-artist-id="',r.get("ArtistID"),'" href="',r.toArtistUrl(),'" data-tooltip-cache-key="playerArtist"',' class="now-playing-link artist no-title-tooltip '+N+'" title="',r.escape("ArtistName"),'">',d,"</a>","</div>"];var C=this.model.get("tooltipOptionsCache");C&&(!C.playerSong||!C.playerArtist)&&(C.playerArtist={shouldHideAds:!0},C.playerSong={zIndex:2e6,notch:"bottom",y:"top",notchBackgroundColor:"#cdcdcd",notchBorderColor:"#cdcdcd",shouldHideAds:!0}),f=r.escape("SongName")}var k=this.model.get("player").get("uiMode")==="leap-overlay"?500:40;this.$nowPlayingImage.attr({src:r.getImageURL(k),title:r.escape("SongName")}).removeClass("hide"),this.$nowPlayingMetadata.html(a.join("")).removeClass("hide"),this.$playPause.removeClass("disabled"),this.$player.addClass("playing"),s&&(clearTimeout(s),s=null),this.fanFeedbackTooltip&&this.fanFeedbackTooltip.options.closeOnNextSong&&!this.fanFeedbackTooltip.hasUserInteracted()&&this.closeFanFeedbackTooltip(),l?this.$el.find(".np-action").addClass("hide"):(this.$el.find(".np-action").removeClass("hide").data("songId",r.get("SongID")),this.userActiveSongEngagement(),t++)}var L=r?n.Models.Song.getCached(r.get("SongID")):null,A={},O;if(o&&L&&L.get("source")!=="recommended"){var M=o.get("settings");if(M&&M.local&&_.isArray(M.local.artistsPlayed)){A.artistsPlayed=M.local.artistsPlayed;var D=L.get("ArtistID");O=_.indexOf(A.artistsPlayed,D),O!==-1&&A.artistsPlayed.splice(O,1),A.artistsPlayed.unshift(D),A.artistsPlayed.splice(999,1),o.saveLocalSettings(A)}}},userActiveSongEngagement:function(){var e=this.model.get("player"),n=e.get("currentQueue");if(!n||s)return;var r=n.get("activeSong"),o=r?r.get("ArtistID"):0,u=r?r.getArtists(o):0,a=this.model.get("user"),f=a.get("isLoggedIn"),l=e.get("duration"),c=e.get("position"),h=f?5:15,p;if(!r||!u||o==a.get("artistID"))return;u.isClaimed()&&l>35e3&&!i[o]&&t>=h&&(p=Math.max(0,(l>12e4?9e4:3e4)-c),s=setTimeout(_.bind(function(){if(n.get("activeSong")!==r||this.isFanFeedbackOpen())return;this.createFanFeedbackTooltip($("#np-comment"),"ARTIST_FAN_FEEDBACK",!0),s=null,i[o]=!0,t=0},this),p))},onActiveSongModelChange:function(e){var t=this.model.get("player").get("currentQueue").get("activeSong");t&&(t.get("isFavorite")?$("#np-fav").addClass("active"):$("#np-fav").removeClass("active"),t.get("fromLibrary")?$("#np-add").addClass("active"):$("#np-add").removeClass("active"))},onSongCompleted:e,onPlayPauseClick:function(){var e=this.model.get("player"),t=e.get("currentQueue");!t.get("currentBroadcast")||t.get("isBroadcasting")?n.trigger("player:togglePlay"):this.onVolumeClick()},onVolumeClick:function(){n.trigger("player:volumeMute")},showVolumeBriefly:function(){this.$volumeControl.show(),this.onVolumeMouseLeave()},onVolumeMouseEnter:function(){clearTimeout(this.volumeSliderTimeout),this.$volume.mousewheel(_.bind(this.onVolumeSliderBarWheel,this)),this.model.get("player").get("uiMode")!=="leap-overlay"&&this.$volumeControl.show()},onVolumeMouseLeave:function(){clearTimeout(this.volumeSliderTimeout),this.$volume.off("mousewheel");var e=this;this.volumeSliderTimeout=setTimeout(function(){e.$volumeControl.hide()},u)},onVolumeControlMouseEnter:function(){this.$volumeControl.mousewheel(_.bind(this.onVolumeSliderBarWheel,this)),clearTimeout(this.volumeSliderTimeout)},onVolumeControlMouseLeave:function(){this.$volumeControl.off("mousewheel"),clearTimeout(this.volumeSliderTimeout);var e=this;o?$("body").on("mouseleave.player mouseup.player",_.bind(this.onVolumeControlMouseDrag,this)):this.volumeSliderTimeout=setTimeout(function(){e.$volumeControl.hide()},u)},onVolumeControlMouseDrag:function(e,t){var n=$("body");n.off("mouseup.player mouseleave.player",_.bind(this.onVolumeControlMouseDrag,this)),o=!1;var r=this;this.volumeSliderTimeout=setTimeout(function(){r.$volumeControl.hide()},u)},onVolumeSliderBarDown:function(){o=!0;var e=$("body");e.on("mousemove.player",_.bind(this.onVolumeSliderBarMove,this)),e.on("mouseup.player",_.bind(this.onVolumeSliderBarUp,this))},onVolumeSliderBarUp:function(){o=!1;var e=$("body");e.off("mousemove.player mouseup.player"),this.$volumeSlider.off("mouseout")},onVolumeSliderBarMove:function(e){var t=this.$volumeSlider.height()-(e.pageY-this.$volumeSlider.offset().top),n=Math.floor(100*t/this.$volumeSlider.height());this.changeVolumeLevelSlider(Math.min(Math.max(n,0),100))},onVolumeSliderBarWheel:function(e){var t;e.originalEvent.wheelDelta>0||e.originalEvent.detail<0?t=1:t=-1;var n=this.model.get("player").get("volume");this.changeVolumeLevelSlider(Math.min(Math.max(n+25*t,1),100))},changeVolumeLevelSlider:function(e){var t=["off","one","two","three","four","five"],r=_.orEqual(Math.ceil((e-3)/20),5),i=t[r];e===0?(n.trigger("player:volumeMute"),this.$volume.addClass("mute")):(n.trigger("player:volumeChange",e),t.push("mute"),this.$volume.removeClass(t.join(" ")).addClass(i)),this.$volumeSliderBar.css("height",e+"%"),this.$volumeSliderHandle.css("bottom",e+"%")},onPlayNextSongClick:function(){this.$playNext.hasClass("disabled")||n.trigger("player:nextSong")},onPlayPreviousSongClick:function(){this.$playPrevious.hasClass("disabled")||n.trigger("player:previousSong")},onShuffleClick:function(e){var t=this.model.get("player").get("currentQueue");t&&(t.get("currentBroadcast")?t.get("isBroadcasting")&&(this.randomizeSongsThrottled?this.randomizeSongsThrottled():this.randomizeSongs()):n.trigger("player:shuffle"))},randomizeSongs:function(){var e=this.model.get("player").get("currentQueue"),t=e&&e.get("songs");if(t){var i=t.indexOf(e.get("activeSong")),s=new n.Models.Collections.QueueSongs(t.models),o=e.randomizeSongs(),u="randomizeQueueSongs";if(s&&s.length&&o){var a=r&&r.notification&&r.notification.notifications,f=r&&r.notification&&r.notification.notifsQueue,l=null,c=1e4,h,p;for(h=0,p=a&&a.length;h<p;h++)if(a[h]&&a[h].model.get("name")==u){l=a[h];break}for(h=0,p=f&&f.length;h<p;h++)if(f[h]&&f[h].model.get("name")==u){l=f[h];break}if(!l){var d=s.pluck("queueSongID");n.trigger("notification:add",{name:u,queueSongIDs:d,click:function(){n.Services.SWF.moveSongsTo(d,i+1,!0)},title:_.getString("POPUP_QUEUE_RANDOMIZED"),description:_.getString("CLICK_HERE_TO_UNDO"),icon:"shuffle icon-shuffle-white-flat",type:"success",duration:c})}else l.timeout&&(clearTimeout(l.timeout),l.timeout=setTimeout(function(){l.close()},c))}this.$shuffle.addClass("disabled"),setTimeout(_.bind(function(){this.$shuffle.removeClass("disabled")},this),500)}},onRepeatClick:function(){var e=this.model.get("player").get("currentQueue");e&&!e.get("currentBroadcast")&&n.trigger("player:repeat")},onCrossfadeClick:function(){var e=this.model.get("player").get("currentQueue");e&&!e.get("currentBroadcast")&&n.trigger("player:crossfade")},onCurrentSongClick:function(e){var t=$(".now-playing-caret",this.el);if(e.currentTarget!=e.target&&e.target!=t[0])return;var n=this.model.get("player"),r=n.get("currentQueue"),i=r&&r.get("activeSong"),s=i.get("queueSongID"),o=$(e.currentTarget);if(i){var u={extra:{isQueue:!0,queueSongClickedID:s,autoplayEnabled:r.get("autoplayEnabled")},menuOptions:{xposition:"right",yposition:"top",orientation:"top",spill:"left",show:"show",className:"queuesongid"+s,keepState:t}};_.asyncMenu(e,o,u,i,"getContextMenuForSong")}},onActiveSongMenuClick:function(e){var t=$(e.currentTarget),n=this.model.get("player").get("currentQueue").get("activeSong"),r=this.model.get("player").get("currentQueue"),i=r.get("autoplayEnabled")||r.get("clientRadioEnabled");if(n){var s={extra:{isQueue:!0,queueSongClickedID:n.get("SongID"),queueSongClickedQueueSongID:n.get("queueSongID"),autoplayEnabled:i},menuOptions:{xposition:"auto",yposition:"top",orientation:"top",show:"show",className:"songid"+n.get("SongID"),keepState:t}};_.asyncMenu(e,t,s,n,"getContextMenuForSong")}},onActiveSongCommentClick:function(e){this.isFanFeedbackOpen()?this.closeFanFeedbackTooltip():this.createFanFeedbackTooltip(e.currentTarget,"COMMENT_TOOLTIP_SONG",!1)},createFanFeedbackTooltip:function(e,t,r){var i=$(e),s={},o="active-song-comment",u=this.model.get("player"),a=u.get("currentQueue"),f=a?a.get("activeSong"):null;if(!f)return;var l=new n.Views.Tooltips.Comment({model:f,user:this.model.get("user"),placeholderTextKey:t,tooltipKey:o,closeOnNextSong:r});s.views=[l],s.$attached=i,s.persist=!0,s.y="top",s.notch="bottom",s.tooltipClass=o,s.tooltipKey=o,s.model=this,s.adjustX=-6,s.adjustY=-2,n.trigger("tooltip:open",s),n.Models.Ad.hideFlashElements(),this.fanFeedbackTooltip=l},closeFanFeedbackTooltip:function(){this.fanFeedbackTooltip&&(this.fanFeedbackTooltip.closeTooltip(),n.Models.Ad.showFlashElements(),this.fanFeedbackTooltip=null)},isFanFeedbackOpen:function(){var e="active-song-comment",t=$("."+e);return t&&t.length?!0:!1},onSeekClick:function(e){var t=this.model.get("player"),r=t.get("currentQueue");if(r&&r.get("currentBroadcast")&&!r.get("isBroadcasting"))return e.preventDefault(),!1;var i=this.$progressBar.offset(),s=e.pageX-i.left,o=s/this.$progressBar.width(),u=Math.min(Math.max(o,0),1),a=this.model.get("player").get("duration")*u;n.trigger("player:seekTo",a)},onScrubberDragStart:function(e,t){var r=this.model.get("player"),i=r.get("currentQueue"),s=r.get("playStatus");if(s!==n.Models.Player.playStatuses.PLAYING&&s!==n.Models.Player.playStatuses.PAUSED||i&&i.get("currentBroadcast")&&!i.get("isBroadcasting"))return!1;this.lockScrubber=!0;var o=this.$seekScrubber.css("left");return this.scrubberLeft=_.toInt(o.substring(0,o.length-2)),this.maxScrubberLeft=this.$progressBar.width()-8,this.minScrubberLeft=-8,t.draggedItems=[],t.scrubber=!0,!0},onScrubberDrag:function(e,t){var n=this.scrubberLeft+t.deltaX;if(n>=this.maxScrubberLeft){this.$seekScrubber.css("left",this.maxScrubberLeft);return}if(n<=this.minScrubberLeft){this.$seekScrubber.css("left",this.minScrubberLeft);return}this.$seekScrubber.css("left",n)},onScrubberDragEnd:function(e,t){t.scrubber&&this.onSeekClick(e),this.lockScrubber=!1},onMouseenterShuffle:function(e){var t=setTimeout(_.bind(function(){var t=this.model.get("player").get("currentQueue"),r=t.get("isBroadcasting"),i=r?"RANDOMIZE_SONGS":"SHUFFLE",s=_.getString(i),o=new n.Views.Tooltips.Helper({text:s});o.tooltipOptions.delay=10,n.Views.Tooltips.Helper.simpleTooltip(e,o)},this),130),r=$(e.currentTarget),i="mouseleave.titleTooltipHelper";r.on(i,function(){clearTimeout(t),r.off(i)})},isObjectDropable:function(e){var t=this.model.get("player"),r=t.get("currentQueue"),i=r?r.get("currentBroadcast"):null,s=r?r.get("isBroadcasting"):!1,o=r&&!0;if(o&&s&&e){var u=t.get("position"),a=t.get("duration");if(i.get("listenersCount")>n.Services.SWF.largeBroadcastThreshold&&r.get("nextSong")===e&&a&&a-u<n.Services.SWF.broadcastNextPreventPosition)o=!1;else{var f=r.get("songs"),l=f.indexOf(e);l>-1&&l<f.indexOf(r.get("activeSong"))&&(o=!1)}}return o},handleDropInit:function(e,t){var n=$(e.srcElement).closest(".queue-item"),r=!0;n.length===1?r=this.isObjectDropable(n.data("module").model):r=this.isObjectDropable(),this.$el.data("valid-drop",r)},handleDropStart:function(e,t){if(t.draggedItems.length===0)return!1},handleDrop:function(e,t){function h(e,t){!_.isArray(t)&&t.toArray&&(t=t.toArray());var r=this.model.get("player"),i=r&&r.get("currentQueue"),s=i&&i.get("songs");n.trigger("player:addSongs",t,-1,s.length===0,e)}t.draggedItemsType=t.draggedItemsType||_.getCollectionType(t.draggedItems);if(t.draggedItemsType=="song"&&t.draggedItems&&t.draggedItems.length){var i=t.draggedItems[0];if(!this.isObjectDropable(i))return;var s=i.get("queueSongID"),o=this.model.get("player"),u=o&&o.get("currentQueue"),a=u&&u.get("songs");if(s&&a&&a.length){n.Services.SWF.moveSongsTo([s],a.length);return}}else if(!this.isObjectDropable())return;var f,l,c;switch(t.draggedItemsType){case"song":_.bind(h,this)(t.draggedItemsContext,t.draggedItems);break;case"album":case"artist":case"playlist":case"broadcast":for(f=0,c=t.draggedItems.length;f<c;f++)l=t.draggedItems[f],_.isFunction(l.getSongs)&&l.getSongs().then(_.bind(h,this,new n.Models.PlayContext(l)));break;case"tag":var p=t.draggedItems[0];r.playGenre(p.get("DisplayName"),p.get("TagID"));break;case"user":for(f=0,c=t.draggedItems.length;f<c;f++)l=t.draggedItems[f],_.isFunction(l.getFavorites)&&l.getFavorites("Songs").then(_.bind(h,this,new n.Models.PlayContext(l)))}},onUpvoteClick:function(e){this.onVoteLogic(1)},onDownvoteClick:function(e){this.onVoteLogic(-1)},onVoteLogic:function(e){var t=r.model.get("player").get("currentQueue"),n=t&&t.get("currentBroadcast");activeSong=n&&n.get("activeSong");if(!activeSong)return;activeSong.get("userVote")===e?n.voteActiveSong(0):n.voteActiveSong(e)}})}(),function(){function s(){var e=document.createElement("canvas");return!!e.getContext&&!!e.getContext("2d")}n.Views=n.Views||{};var i={};n.Views.Queue=Backbone.View.extend({el:document.getElementById("player-wrapper"),templatePath:"queue",openedOnce:!1,autoplayEnabled:!1,queueSize:"",openQueueSize:"",bestQueueSize:"",lastUserQueueSize:"",preferredUserQueueSize:"",viewDirty:!1,queueOpen:!1,greatestQueueSongID:0,songsAdded:0,events:{"click #player-radio-button":"onRadioClick","click .queue-song-options .options":"onSongOptionsClick","click #player-radio-label":"onStationsLabelClick","click .smile":"onSmileClick","click .frown":"onFrownClick","click .restore-queue":"onRestoreClick","click .bc-more-options":"onBroadcastMoreOptions"},initialize:function(){var e=this.model.get("player");this._onScrollForDebounce=_.bind(this.onScroll,this,i),this.collection=new n.Models.Collections.QueueSongs,this.$playerBg=$("#player-bg"),this.$queue=$("#queue"),this.$queueMenu=$("#queue-menu-btn"),this.$broadcastBtn=$("#broadcast-menu-btn"),this.$player=$("#player"),this.$main=$("#main"),this.$queueListWindow=$("#queue-list-window"),this.$queueList=$("#queue-list"),this.$queueNum=$("#queue-num"),this.$queueNumTotal=$("#queue-num-total"),this.$songsText=$("#songs-text"),this.$queueText=$("#queue-text"),this.$trash=$("#trash"),this.$bcIcon=$("#bc-icon-anim"),this.grid=new n.Views.QueueGrid({el:this.$queueList[0],collection:this.collection,model:e,scrollElement:this.$queueListWindow}),this.grid.on("rendered",this.updateScrollbar,this),this.grid.render(),n.on("queue:setSize",this.setQueueSize,this),e.on("change:playStatus",function(e,t){var r=e.get("currentQueue").get("activeSong"),i=n.Models.Player.playStatuses,s="";switch(t){case i.NONE:s="NONE";break;case i.INITIALIZING:s="INITIALIZING";break;case i.LOADING:s="LOADING";break;case i.PLAYING:s="PLAYING";break;case i.PAUSED:s="PAUSED";break;case i.BUFFERING:s="BUFFERING";break;case i.FAILED:s="FAILED";break;case i.COMPLETED:s="COMPLETED";break;default:s="UNKNOWN"}r&&n.trigger("guts:log","playStatusUpdate",{playStatus:s,activeSong:r.get("SongID"),streamServer:e.get("currentStreamServer")})},this),e.on("change:currentQueue",this.onCurrentQueueChange,this),e.on("change:previousQueue",this.onPreviousQueueChange,this),e.get("currentQueue")&&this.onCurrentQueueChange(e,{}),this.$queue.tinyscrollbar({axis:"x",onscroll:_.bind(this.onScroll,this)}),this.$playerBg.on("click",_.bind(this.onQueueToggle,this)),this.$queueMenu.on("click",_.bind(this.onOptionsClick,this)),n.Services.SWF.chatReady.done(_.bind(function(){this.$broadcastBtn.removeClass("hide")},this)),n.on("manatee:connected",function(){this.$broadcastBtn.removeClass("hide")},this),this.$broadcastBtn.on("click",_.bind(this.onBroadcastBtnClick,this)),this.$broadcastBtn.on("mouseenter",_.bind(this.onBroadcastBtnHover,this)),this.$trash.on("click",_.bind(this.onClearQueueClick,this)),this.broadcastNotifs=0,n.on("broadcast:notifEvent",this.onBroadcastNotifEvent,this),this.songQueueHelper={},this.isDragging=!1,n.on("drag:start",function(){this.isDragging=!0},this),n.on("drag:end",function(){this.isDragging=!1},this),this.lastMouseInteraction=Date.now()-3e4,this.$queue.on("click mousewheel",_.debounce(_.bind(function(){this.lastMouseInteraction=Date.now()},this),100));var t=function(e,t){var r="s";t>=825&&(r="m"),this.queueOpen&&this.bestQueueSize!=r&&n.trigger("queue:setSize",r,!1),this.bestQueueSize=r,this.optionsTooltip&&n.trigger("tooltip:close"),this.updateScrollbar()};n.on("app:resize",t,this),t.call(this,0,$("body").height()),this.notifySongsAdded=_.debounce(_.bind(function(){var e=this.model.get("player").get("currentQueue");if(!e)return;this.songsAdded=Math.max(0,Math.min(this.songsAdded,e.get("songs").length));if(this.songsAdded===0)return;var t=this.songsAdded>1?"POPUP_QUEUE_SONGS_ADDED":"POPUP_QUEUE_SONG_ADDED",r=_.getString(t,{numSongs:this.songsAdded}),i=$(".popupQueueSongs .description"),s=$(".popupQueueSongs").data();if(i.length&&s.view&&!s.view.closing)i.html(r);else{if(e.get("currentBroadcast")&&!e.get("isBroadcasting")){this.songsAdded=0;return}n.trigger("notification:add",{description:r,className:"popupQueueSongs",icon:"note icon-note-white-active",type:"success",closeAction:_.bind(function(){this.songsAdded=0},this)})}},this),700)},onCurrentQueueChange:function(e,t,r){this.greatestQueueSongID=0;var i=e.previous("currentQueue"),s=t.get("songs"),o=n.isBroadcastListener()||e.get("isJoiningBroadcast");if(i){var u=i.get("songs"),a=i.get("currentBroadcast");u.off(null,null,this),i.off("change",null,this),a&&a.off("change",null,this)}t&&(s.on("add",this.addSong,this),s.on("remove",this.removeSong,this),s.on("reset sort",this.resetSongs,this),s.on("add remove reset sort",this.onSongsChanged,this),t.on("change",this.onQueueChange,this),s.on("change",this.onSongChanged,this),this.updateCurrentSongs(),this.updateRadio(),this.resetSongs(s,{}),this.onActiveSongChange(),this.onSongsChanged()),this.updateRestoreQueue(),!t||!s.length||o?(n.trigger("queue:setSize","c",!1),this.openedOnce=!1):n.trigger("queue:setSize",this.lastUserQueueSize||this.bestQueueSize,!1)},onPreviousQueueChange:function(){this.updateRestoreQueue()},onQueueChange:function(e,r){var i=e.changedAttributes();if(i.activeSong){var s=e.previous("activeSong");s&&s.trigger("change",s),this.onActiveSongChange()}if(i.currentBroadcast!==t){var o=e.previous("currentBroadcast");if(o){o.off(null,null,this);var u=o.get("history");u&&u.off("add reset sort",this.onNewBroadcastHistory,this)}var a=i.currentBroadcast;if(a){a.on("change:Name",this.onBroadcastChange,this),n.isBroadcaster()||(this.onBroadcastActiveSongChange(a,a.get("activeSong")),a.on("change:activeSong",this.onBroadcastActiveSongChange,this));var f=a.get("history");if(f)f.on("add reset sort",this.onNewBroadcastHistory,this);else{var l=this;a.on("change:history",function(e,t){var n=this.model.get("player").get("currentQueue");n&&n.get("currentBroadcast")===e&&t.on("add reset sort",l.onNewBroadcastHistory,l),l.onNewBroadcastHistory(t),a.off("change:history",null,this)},this)}this.animation=setInterval(_.bind(function(){var e=this.$bcIcon.data("bgPos")||0;e<-16?e=0:e-=16,this.$bcIcon.css("background-position",e+"px"+" 0").data("bgPos",e)},this),1e3)}else{var c=e.get("songs");c&&c.each(function(e){e.set("broadcastPlayed",!1)}),this.animation&&clearInterval(this.animation)}this.onBroadcastChange(a)}(!_.isUndefined(i.autoplayEnabled)||!_.isUndefined(i.clientRadioEnabled))&&this.updateRadio()},onActiveSongChange:function(){var e=this.model.get("player"),t=e.get("currentQueue"),n=t.get("activeSong");if(n){var r=t.get("songs").indexOf(n)+1;this.$queueNum.text(r),n==this.lastSuggestedSong&&this.lastSuggestedSong.set({suggestion:!1}),n.trigger("change",n),t.get("autoplayEnabled")||t.get("clientRadioEnabled")?e.set("scrollAfterRadioAdd",!0):this.scrollToActiveSong()}else e.set("expectManualSongChange",!1)},scrollToActiveSong:function(e){e=_.orEqual(e,!1);var t=this.model.get("player"),n=t.get("currentQueue").get("activeSong");if(!n)return;if(e||t.get("expectManualSongChange")||!this.isDragging&&Date.now()-this.lastMouseInteraction>3e4){var r=this.grid.getScrollPositionToShowItem(n,!0);r!==-1&&(this.$queue.tinyscrollbar_forceScroll(r),this.onScroll({},r,{force:!0}))}t.set("expectManualSongChange",!1),t.set("scrollAfterRadioAdd",!1)},scrollToEnd:function(){var e=this.grid.getMaxScrollPos();this.$queue.tinyscrollbar_forceScroll(e),this.onScroll({},e,{force:!0})},onScroll:function(e,t,n){e===i&&this._debouncedOnScrollArgs&&(e=this._debouncedOnScrollArgs[0],t=this._debouncedOnScrollArgs[1],n=this._debouncedOnScrollArgs[2],this._debouncedOnScrollArgs=null),n=n||{};if(_.isUndefined(t)||_.isNull(t))t=this.$queueList.position().left*-1;n.overrideScrollPos=t,this.grid.handleScroll(n)},debouncedOnScroll:function(){return this._debouncedOnScrollArgs=_.toArray(arguments),_.debounce(this._onScrollForDebounce,10)},updateRestoreQueue:function(){var e=this.model.get("player").get("currentQueue"),t=this.model.get("player").get("previousQueue");t&&(!e||!e.get("songs").length)&&!n.isBroadcastListener()?this.$trash.addClass("restore-queue"):this.$trash.removeClass("restore-queue")},onClearQueueClick:function(e){var t=this.model.get("player").get("currentQueue").get("currentBroadcast");$(e.currentTarget).hasClass("restore-queue")?n.trigger("player:restore"):n.isBroadcaster()&&t&&t.get("listenersCount")>1?n.trigger("lightbox:open","broadcastListeners",{type:"clearQueue",broadcast:t}):n.trigger("player:clear")},onRadioClick:function(e,t){var r=this.model.get("player").get("currentQueue"),i=r.get("clientRadioEnabled");i?(r.get("clientRadio").disable(),n.trigger("guts:clearAllAutoplayContexts")):n.trigger("player:radio")},addQueuePropertiesToSong:function(e){var t=this.model.get("player"),n=t.get("currentQueue"),r=n.get("songs"),i=r.indexOf(e),s=!1,o=e.get("autoplayVote")-0,u=n.get("autoplayEnabled")||n.get("clientRadioEnabled");return u&&r.length>1&&i==r.length-1&&e.get("source")!="user"&&!e.get("fromUserAction")&&(s=!0,this.lastSuggestedSong=e),e.set({paused:e!=n.get("activeSong")||!t.playStatusIsPlaying(),smile:o==1||e.get("source")=="user"&&o===0,frown:o==-1,suggestion:s,songQueueHelper:this.songQueueHelper}),e},addSong:function(e,t,n){this.lastSuggestedSong&&this.lastSuggestedSong.set({suggestion:!1}),t.AlbumName&&(console.trace(),console.log(e,t)),this.addQueuePropertiesToSong(e),this.collection.add(e,{at:t.indexOf(e)}),this.debouncedOnScroll(null,null,{force:!0}),e==this.lastSuggestedSong&&this.model.get("player").get("scrollAfterRadioAdd")&&this.scrollToActiveSong()},notifySongsAdded:function(){},removeSong:function(e,t,n){this.collection.remove(e),this.debouncedOnScroll(null,null,{force:!0})},resetSongs:function(e,t){this.greatestQueueSongID=0,_.each(e.models,_.bind(this.addQueuePropertiesToSong,this)),this.collection.reset(e.models,{sorted:!0}),this.debouncedOnScroll(null,null,{force:!0})},updateCurrentSongs:function(){var e=this.model.get("player").get("currentQueue"),t;e.get("songs").length===0?t="QUEUE_NO_SONGS":e.get("songs").length==1?t="QUEUE_ONE_SONG":t="QUEUE_NUM_SONGS",$(".current-songs-text").text(_.getString(t,{numSongs:e.get("songs").length}))},updateRadio:function(){var e=this.model.get("player").get("currentQueue"),t=e.get("autoplayEnabled")||e.get("clientRadioEnabled");this.songQueueHelper.autoplayEnabled=t,t?(this.$el.addClass("has-some-radio"),this.$queueList.addClass("autoplay")):(this.$el.removeClass("has-some-radio"),this.$queueList.removeClass("autoplay")),this.grid.refresh(),this.debouncedOnScroll(null,null,{force:!0})},setQueueSize:function(e,t,n){t=_.orEqual(t,!0),n=_.orEqual(n,!1);if(!e||!_.isString(e)){e=this.queueSize;switch(e){case"c":e="s";break;case"m":e="l";break;case"l":e="c";break;case"s":default:e="m"}}var r=["queue-closed","queue-small","queue-medium","queue-large"],i=["closed","small","medium","large"],s,o,u,a;this.queueSize=e,e!="c"&&(this.openQueueSize=e),n?this.preferredUserQueueSize=e:t?this.lastUserQueueSize=e:this.preferredUserQueueSize&&(e=this.preferredUserQueueSize),!this.queueOpen&&!t&&this.openedOnce&&(e="c");switch(e){case"c":s=[0,0],o=r[0],u=i[0],a=70;break;case"s":s=[144,55],o=r[1],u=i[1],a=30;break;case"m":s=[86,125],o=r[2],u=i[2],a=70;break;case"l":s=[106,145],o=r[3],u=i[3],a=90}this.songQueueHelper.queueImageSize=a,this.queueDimensions={width:s[0],height:s[1]},this.openedOnce=this.openedOnce||e!="c",this.queueOpen=e!="c",$([this.$el[0],this.$main[0]]).removeClass(r.join(" ")).addClass(o),this.grid.options.itemWidth=s[0],this.grid.refresh(),this.grid.resize(),this.updateScrollbar(!1),this.scrollToActiveSong(!0)},onSongsChanged:function(e){this.updateRestoreQueue(),this.updateCurrentSongs();var t=this.collection.length==1?"SONG":"SONGS",r=this.collection.length;this.lastSongCount&&(r=this.collection.length-this.lastSongCount),r>0&&(!e||!e.get("suggestion")&&e.get("queueSongID")>this.greatestQueueSongID)&&(this.songsAdded+=r,this.notifySongsAdded()),this.lastSongCount=this.collection.length,r>0&&e&&e instanceof n.Models.QueueSong&&this.greatestQueueSongID<e.get("queueSongID")&&(this.greatestQueueSongID=e.get("queueSongID"));if(this.collection.length){var i=this.model.get("player").get("currentQueue"),s=n.isBroadcastListener()||this.model.get("player").get("isJoiningBroadcast"),o=i?i.get("activeSong"):!1;if(o){var u=i.get("songs").indexOf(o)+1;this.$queueNum.text(u)}this.queueSize==="c"&&this.lastUserQueueSize!=="c"&&!s&&n.trigger("queue:setSize",this.lastUserQueueSize||this.bestQueueSize,!1),this.$el.addClass("has-songs"),this.$queueNumTotal.text(this.collection.length),this.$songsText.data("translateText",t).text(_.getString(t)),this.$el.find(".num-text").removeClass("hide")}else this.$el.find(".num-text").addClass("hide"),this.$el.removeClass("has-songs"),this.$queueNumTotal.text("0"),this.$songsText.data("translateText",t).text(_.getString(t));var a=0;this.queueDimensions&&(a=this.queueDimensions.width),this.$queueList.width(this.collection.length*a),this.updateScrollbar()},onSongChanged:function(e){this.addQueuePropertiesToSong(e)},updateScrollbar:_.debounce(function(e){e=typeof e=="undefined"?!0:e,this.$queue.tinyscrollbar_update("relative"),e&&this.debouncedOnScroll(null,null,{force:!0})},100),sidebarToggle:function(){$("body").hasClass("sidebar-open")?n.trigger("sidebar:close"):n.trigger("sidebar:open")},onSongOptionsClick:function(e){var t=$(e.currentTarget),n=t.parents(".queue-item").data("queueSongId"),r=this.model.get("player").get("currentQueue"),i=null,s=r.get("songs");for(var o=0;o<s.length;o++)if(s.at(o).get("queueSongID")==n){i=s.at(o);break}var u=r.get("autoplayEnabled")||r.get("clientRadioEnabled");if(i){var a={extra:{isQueue:!0,queueSongClickedID:n,queueSongClickedQueueSongID:i.get("queueSongID"),autoplayEnabled:u},menuOptions:{xposition:"auto",yposition:"top",orientation:"top",show:"show",className:"queuesongid"+n,keepState:t}};_.asyncMenu(e,t,a,i,"getContextMenuForSong")}},onStationsLabelClick:function(e){var t=$(e.currentTarget);t.jjmenu(e,n.Models.Station.getStationsStartMenu(),null,{xposition:"right",yposition:"top",orientation:"top",spill:"left",show:"show",className:"radiomenu",keepState:t})},onOptionsClick:function(e){e.preventDefault();var t=$(e.currentTarget);t.jjmenu(e,this.getQueueMenu(),null,{xposition:"left",yposition:"top",orientation:"top",spill:"right",show:"show",className:"current-songs-menu",keepState:t})},onBroadcastBtnClick:function(e){var t=r.model.get("user"),i=this.model.get("player").get("currentQueue"),s=i?i.get("currentBroadcast"):null;s?n.router.setHash(s.toUrl()):t.createBroadcast()},onBroadcastBtnHover:function(e){var t=r.model.get("user"),n=this.model.get("player").get("currentQueue");(!n||!n.get("currentBroadcast"))&&t.getLastBroadcast()},onBroadcastChange:function(e){e?(this.$broadcastBtn.removeClass("hide").find(".label").text(e.get("Name")).removeAttr("data-translate-text").siblings(".icon.icon-caret").removeClass("hide"),this.$broadcastBtn.find(".icon-station-orange-animation").removeClass("hide"),this.$broadcastBtn.find(".icon-station-orange-shadow").addClass("hide"),this.$broadcastBtn.parent().addClass("btn-group"),this.$broadcastBtn.siblings(".bc-more-options").removeClass("hide"),this.$broadcastBtn.addClass("go-to-broadcast-page"),$("body").addClass("in-broadcast")):(this.$broadcastBtn.find(".label").text(_.getString("START_BROADCASTING")).attr("data-translate-text","START_BROADCASTING").siblings(".icon.icon-caret").addClass("hide"),this.$broadcastBtn.find(".icon-station-orange-animation").addClass("hide"),this.$broadcastBtn.find(".icon-station-orange-shadow").removeClass("hide"),this.$broadcastBtn.parent().removeClass("btn-group"),this.$broadcastBtn.siblings(".bc-more-options").addClass("hide"),this.$broadcastBtn.removeClass("go-to-broadcast-page"),$("body").removeClass("in-broadcast"),this.onBroadcastNotifEvent(e,!0)),this.updateRestoreQueue()},onBroadcastActiveSongChange:function(e,t){var n=e.changedAttributes(),r=n.activeSong;r&&r.off(null,null,this),t&&t.on("change:userVote",this.onActiveSongVoteChange,this),this.onActiveSongVoteChange()},onActiveSongVoteChange:function(e,t){t&&t==1?($("#player-upvote").find(".icon").removeClass("icon-upvote-m-gray").addClass("icon-upvote-orange-shadow"),$("#player-downvote").find(".icon").removeClass("icon-downvote-orange-shadow").addClass("icon-downvote-m-gray")):_.isUndefined(t)||t==0?($("#player-upvote").find(".icon").removeClass("icon-upvote-orange-shadow").addClass("icon-upvote-m-gray"),$("#player-downvote").find(".icon").removeClass("icon-downvote-orange-shadow").addClass("icon-downvote-m-gray")):($("#player-upvote").find(".icon").removeClass("icon-upvote-orange-shadow").addClass("icon-upvote-m-gray"),$("#player-downvote").find(".icon").removeClass("icon-downvote-gray").addClass("icon-downvote-orange-shadow"))},onBroadcastNotifEvent:function(e,t){var n=this.model.get("player").get("currentQueue");if(!n||n.get("currentBroadcast")!==e)return;t?this.broadcastNotifs=0:this.broadcastNotifs++;var r=$("#broadcast-menu-btn-group").find(".notification-pill"),i=r.find(".notification-pill-count");if(this.broadcastNotifs>0){var s=this.broadcastNotifs;this.broadcastNotifs>=1e3&&(s=Math.floor(this.broadcastNotifs/1e3)+"K+"),r.removeClass("hide"),i.text(s)}else r.addClass("hide")},onNewBroadcastHistory:function(e){var t=this.model.get("player").get("currentQueue"),r=t?t.get("songs"):null;if(!r)return;var i;e instanceof n.Models.BroadcastSong?(i=r.get(e.get("queueSongID")),i&&i.set("broadcastPlayed",!0)):e instanceof n.Models.Collections.BroadcastSongs&&r.each(function(t){i=e.getByQueueSongID(t.get("queueSongID")),i?t.set("broadcastPlayed",!0):t.set("broadcastPlayed",!1)})},onQueueToggle:function(e){var t=this.queueOpen?"c":this.openQueueSize;t||(t=this.lastUserQueueSize||this.preferredUserQueueSize||this.bestQueueSize),n.trigger("queue:setSize",t,!0,!1),t!="c"?(n.trigger("guts:log","openQueueClicked",{elementType:"player"}),n.trigger("guts:gatrack","player","openQueueClicked")):(n.trigger("guts:log","closeQueueClicked",{elementType:"player"}),n.trigger("guts:gatrack","player","closeQueueClicked"))},onRestoreClick:function(e){e.preventDefault(),n.trigger("player:restore")},onSmileClick:function(e){var t=$(e.currentTarget),r=t.parents(".queue-item"),i=r.data("module"),s=i&&i.model,o=this.model.get("player").get("currentQueue");if(s){var u=s.get("smile"),a=s.get("queueSongID"),f=u?0:1;n.trigger("player:voteSong",a,f)}},onFrownClick:function(e){var t=$(e.currentTarget),r=t.parents(".queue-item"),i=r.data("module"),s=i&&i.model,o=this.model.get("player").get("currentQueue");if(s){var u=s.get("frown"),a=s.get("queueSongID"),f=u?0:-1;n.trigger("player:voteSong",a,f)}},getQueueMenu:function(){var t=[],r=[],i=[],o=this.model.get("player"),u=o.get("currentQueue"),a=u.get("songs"),f=o.get("previousQueue"),l=u.get("autoplayEnabled")||u.get("clientRadioEnabled"),c=u.get("isBroadcasting"),h=u.get("currentBroadcast");if(!n.isBroadcaster()){var p=l?"TURN_RADIO_OFF":"TURN_RADIO_ON",d=u.get("repeatMode"),v;d===1?v="active":d===2?v="active1":v="",t.push({key:p,title:_.getString(p),customClass:"radio menu-icon "+(l?"active":""),action:{type:"fn",callback:_.bind(function(){u.get("clientRadioEnabled")?(u.get("clientRadio").disable(),this.updateRadio(),n.trigger("guts:clearAllAutoplayContexts")):(n.trigger("player:radio"),l?n.trigger("guts:gatrack","player","radioOffClicked"):n.trigger("guts:gatrack","player","radioOnClicked"))},this)}},{title:"",customClass:"divider"})}return s()&&t.push({key:"PLAYER_SHOW_VISUALIZER",title:_.getString("PLAYER_SHOW_VISUALIZER"),customClass:"jj_menu_item_visualizer",action:{type:"fn",callback:function(){var e=function(t){t=_.orEqual(t,n.Models.User.getCached(n.getLoggedInUserID()));if(!t)return;t.get("subscription").canUsePlayerBonuses()?n.trigger("lightbox:open","visualizers",{showPlayerControls:!0,_showPlayerControls:!0}):n.trigger("lightbox:open","vipOnlyFeature",{onLogin:e}),n.trigger("guts:gatrack","player","openVisualizerClicked")};e()}}}),e.Leap&&t.push({key:"PLAYER_LEAP_MOTION_CONTROLS",title:_.getString("PLAYER_LEAP_MOTION_CONTROLS"),customClass:"jj_menu_item_leap_player",action:{type:"fn",callback:_.bind(function(){var e=this.model.get("player").get("currentQueue"),t=e.get("songs"),r=this.model.get("user");if(t.length<1){var i=new n.Views.Tooltips.Tour({type:"leapMotion"}),s={persist:!0,width:265,delay:0,views:[i],tooltipKey:"tour",fixPosition:!1,scrollable:$("body"),tooltipClass:"tooltip-tour tooltip-leapMotion",destroyViewOnClose:!0};i.tour[0].setup(s),n.trigger("tooltip:open",s)}else{if(!r)return;o.get("uiMode")!=="leap-overlay"&&(n.External.LeapPlayer.openPlayer(),n.trigger("guts:log","leapPlayerOpened",{}))}},this)}}),t.push({key:"VIEW_SONGS",title:_.getString("VIEW_SONGS"),customClass:"jj_menu_item_now_playing",action:{type:"fn",callback:function(){n.isBroadcastListener()?(n.router.setHash(h.toUrl()),n.trigger("guts:gatrack","player","openBroadcastClicked")):(n.router.setHash("now_playing"),n.trigger("guts:gatrack","player","nowPlayingOpenClicked"))}}}),r=this.getCurrentSongsSaveMenu(),r.length&&t.push({key:"SAVE_SONGS",title:_.getString("SAVE_SONGS"),customClass:"jj_menu_item_save_songs",type:"sub",src:this.getCurrentSongsSaveMenu()}),i=this.getCurrentSongsLoadMenu(),i.length&&n.getLoggedInUserID()>0&&(!h||c)&&t.push({key:"QUEUE_LOAD_SONGS",title:_.getString("QUEUE_LOAD_SONGS"),customClass:"jj_menu_item_load_songs jj_menu_item_more",type:"sub",src:this.getCurrentSongsLoadMenu()}),f&&!a.length&&!h&&t.push({key:"QUEUE_RESTORE_QUEUE",title:_.getString("QUEUE_RESTORE_QUEUE"),customClass:"jj_menu_item_restore_queue",action:{type:"fn",callback:function(){n.trigger("player:restore")}}}),t.push({title:"",customClass:"divider"},{key:this.queueOpen?"CLOSE_QUEUE":"OPEN_QUEUE",title:this.queueOpen?_.getString("CLOSE_QUEUE"):_.getString("OPEN_QUEUE"),action:{type:"fn",callback:_.bind(this.onQueueToggle,this)}}),t},getCurrentSongsSaveMenu:function(){var e=this.model.get("player").get("currentQueue"),t=e.get("songs"),r=this.model.get("user"),i=[];if(t.length<1)return i;var s=t.pluck("SongID");return i.push({key:"ADD_TO_COLLECTION",title:_.getString("ADD_TO_COLLECTION"),customClass:"jj_menu_item_music",action:{type:"fn",callback:function(){r.addSongsToLibrary(s),n.trigger("guts:gatrack","player","songsSaveToLibraryClicked")}}},{key:"QUEUE_SAVE_PLAYLIST",title:_.getString("QUEUE_SAVE_PLAYLIST"),customClass:"jj_menu_item_replace_playlist",type:"sub",src:r.getPlaylistsMenu(!1,!0,{songs:t.toArray(),fromQueue:!0},function(e){var r=e.get("PlaylistName");n.trigger("lightbox:open",{_type:"overwritePlaylist",view:{header:"LB_OVERWRITE_TITLE",messageHTML:'<p class="lb-copy">'+_.getString("LB_OVERWRITE_MESSAGE",{playlistName:r})+'</p><img class="overwrite_skull" src="/webincludes/images/overwrite_playlist_skull.png" width="156" height="111">',buttonsLeft:[{label:"LB_KEEP_PLAYLIST",className:"close btn-l-gray"}],buttonsRight:[{label:"LB_OVERWRITE_PLAYLIST",className:"continue btn-primary"}]},callbacks:{".continue":function(){e.overwriteWithSongs(t.pluck("SongID")).done(function(){n.trigger("lightbox:close"),n.trigger("notification:add",{description:_.getString("POPUP_PLAYLIST_SAVED"),icon:"subbed-playlist icon-subbed-playlist-white-active",type:"success",duration:5e3})}).fail(function(){n.trigger("lightbox:close"),n.trigger("notification:add",{description:_.getString("POPUP_PLAYLIST_SAVED_FAIL"),type:"error",duration:5e3})})}}}),n.trigger("guts:gatrack","player","overwriteSongsInPlaylistClicked")})},{key:"QUEUE_ADD_TO_PLAYLIST",title:_.getString("QUEUE_ADD_TO_PLAYLIST"),customClass:"jj_menu_item_add_playlist",type:"sub",src:r.getPlaylistsMenu(!1,!0,{songs:t.toArray()},function(e){e.addSongs(t.pluck("SongID"),null,!0),n.trigger("guts:gatrack","player","addSongsToPlaylistClicked")})}),i},getCurrentSongsLoadMenu:function(){var e=[],t=this.model.get("player").get("currentQueue"),r=t.get("songs"),i=this.model.get("user");i&&i.get("favoriteSongs")&&e.push({key:"QUEUE_LOAD_FAVORITES",title:_.getString("QUEUE_LOAD_FAVORITES"),customClass:"jj_menu_item_favorites",action:{type:"fn",callback:function(){var e=new n.Models.PlayContext;e.addStreamType(n.Models.PlayContext.TYPE_LIBRARY),n.trigger("player:addSongs",i.get("favoriteSongs").pluck("SongID"),n.Services.SWF.playSpecialIndexes.DEFAULT,!1,e),n.trigger("guts:gatrack","player","loadFavoritesToQueueClicked")}}});if(i&&i.get("playlists")&&i.get("playlists").length>0){var s=r&&r.toArray();e.push({key:"QUEUE_LOAD_PLAYLIST",title:_.getString("QUEUE_LOAD_PLAYLIST"),customClass:"jj_menu_item_playlists",type:"sub",src:i.getPlaylistsMenu(!0,!1,{songs:s},function(e){e.getSongs().done(function(t){var r=new n.Models.PlayContext(e);n.trigger("player:addSongs",t,n.Services.SWF.playSpecialIndexes.DEFAULT,!1,r),n.trigger("guts:gatrack","player","loadPlaylistToQueueClicked")}).fail(function(){})})})}return e},getOptionsMenu:function(){var e=[],t=n.getLoggedInUserID(),r=this.model.get("player").get("currentQueue"),i=[{key:"QUEUE_LARGE",title:_.getString("QUEUE_LARGE"),action:{type:"fn",callback:function(){n.trigger("queue:setSize","l")}}},{key:"QUEUE_NORMAL",title:_.getString("QUEUE_NORMAL"),action:{type:"fn",callback:function(){n.trigger("queue:setSize","m")}}},{key:"QUEUE_SMALL",title:_.getString("QUEUE_SMALL"),action:{type:"fn",callback:function(){n.trigger("queue:setSize","s")}}},{key:"QUEUE_HIDE",title:_.getString("QUEUE_HIDE"),action:{type:"fn",callback:function(){n.trigger("queue:setSize","c")}}}];return e.push({key:"QUEUE_SIZES",title:_.getString("QUEUE_SIZES"),type:"sub",customClass:"jj_menu_item_play",src:i}),t>0&&e.push({key:"PLAYER_SHOW_SETTINGS",title:_.getString("PLAYER_SHOW_SETTINGS"),customClass:"jj_menu_item_privacy",action:{type:"fn",callback:function(){n.router.setHash("/settings/preferences")}}}),r&&r.get("songs")&&r.get("songs").length&&(e.push({customClass:"separator"}),e.push({key:"PLAYER_SHOW_VISUALIZER",title:_.getString("PLAYER_SHOW_VISUALIZER"),customClass:"jj_menu_item_visualizer",action:{type:"fn",callback:function(){var e=function(t){t=_.orEqual(t,n.Models.User.getCached(n.getLoggedInUserID()));if(!t)return;t.get("subscription").canUsePlayerBonuses()?n.trigger("lightbox:open","visualizers",{_showPlayerControls:!0}):n.trigger("lightbox:open","vipOnlyFeature",{onLogin:e}),n.trigger("guts:gatrack","player","openVisualizerClicked")};e()}}})),e},onBroadcastMoreOptions:function(e){if(this.bcMoreOptions&&this.bcMoreOptions.openDfd&&this.bcMoreOptions.openDfd.state()==="pending"){this.bcMoreOptions.closeTooltip();return}var t=$(".bc-more-options"),r=this.model.get("player").get("currentQueue"),i=r.get("currentBroadcast"),s=i&&!r.get("isBroadcasting");this.broadcastMenuOptions={tooltipKey:"bc-more-options",sticky:!0,delay:0,notchSize:6,width:170,notch:"bottom",notchX:155,x:-140,y:"top",adjustY:-10,$attached:t,tooltipClass:"menu bc-more-options"};if(!this.bcMoreOptions){var o=function(e){n.router.setHash(i.toUrl()),n.trigger("tooltip:close")},u=function(e){n.trigger("lightbox:open","editBroadcast",{broadcast:i}),n.trigger("tooltip:close")},a=function(e){i.end(),n.trigger("tooltip:close")},f=[{localeKey:"GO_TO_PAGE",click:o},{localeKey:"EDIT_BROADCAST",click:u},{localeKey:"STOP_BROADCASTING",click:a}];s&&(f=[{localeKey:"GO_TO_PAGE",click:o},{localeKey:"LEAVE_BROADCAST",click:a}]);var l={tooltipKey:"bc-more-options",model:i,items:f};this.bcMoreOptions=new n.Views.Tooltips.Menu(l)}this.broadcastMenuOptions.views=[this.bcMoreOptions],$.hideJJMenu(),t.addClass("active"),this.broadcastMenuOptions.dfd=$.Deferred(),n.trigger("tooltip:open",this.broadcastMenuOptions),this.bcMoreOptions.openDfd=this.broadcastMenuOptions.dfd,this.bcMoreOptions.openDfd.always(function(){t.removeClass("active")})}})}(),function(){function t(e){e.id<-100&&(e=e.attributes.artist||e);var t=e.attributes.currentBroadcastID&&e.attributes.nowPlayingSong,n=e.attributes.currentBroadcastID;if(e.attributes.currentBroadcastID&&e.attributes.currentBroadcastOwner){var i=e.attributes.currentBroadcastOwner;i&&(t=i.attributes.nowPlayingSong,i.attributes.currentBroadcastID!=n&&(n=null))}if(t)return e.attributes.isOwnerOfCurrentBroadcast&&n&&(r.sidebar.currentBroadcasts[n]={owner:e.id,Name:e.attributes.currentBroadcastName}),0+n+(e.attributes.isOwnerOfCurrentBroadcast?0:1);var s=e.attributes.Name||e.attributes.ArtistName;return 1+(e.attributes.onlineStatus?0:1)+(e.attributes.nowPlayingSong?0:1)+s.toLowerCase()}function i(e){var t=parseFloat(e.attributes.TSModified,10);return isNaN(t)&&(t=0),-1*t}function s(){if(!this.indexRendered||!this.isOnline)return;this.communityUsers.sort(),n.trigger("sidebar:friendsChange")}n.Views=n.Views||{};var e;n.Views.Sidebar=Backbone.View.extend({el:document.getElementById("sidebar"),templatePath:"sidebar",communityScrollPos:0,playlistsScrollPos:0,events:{"click .collapser":"toggleList","mouseenter .scrollable":"scrollbarFadeIn","mouseleave .scrollable":"scrollbarFadeOut","keyup #sidebar-filter":"filterGrids","submit form.search-bar":"onFilterSubmit","focus .filter":"onFilterFocus","blur .filter":"onFilterBlur","click .search-bar":"filterFocus","click .new-playlist":"newPlaylist","click #sidebar-add-menu":"onAddMenu","click #manatee-reconnect":"onManateeReconnectClick","click #sidebar-playlists-title":"onPlaylistsTitleClick","click .sidebar-user":"onSidebarUserClick","click .sidebar-playlist":"onSidebarPlaylistClick","click .sidebar-broadcast":"onSidebarBroadcastClick","click #toggle-sidebar":"onSizeChange","click #filter-toggle, #hide-sidebar-filter":"toggleFilter","click #sidebar-settings":"onSettingsMenu","click #sidebar-go-online":"updatePrivacySetting","click #close-offline-msg":"closeOfflineMsg"},initialize:function(){this.$main=$("#main"),this.indexRendered=!1,this.user=this.model.get("user"),this.playlists=new n.Models.Collections.Playlists,this.subscribedPlaylists=new n.Models.Collections.Playlists,this.communityUsers=new n.Models.Collections.Users,this.extraUsers=new n.Models.Collections.Users,this.favoriteBroadcasts=new n.Models.Collections.Broadcasts,this.subscribedToFriendsChange=!1,this.settingChatFriends=!1,this.createdTimestamp=Date.now(),this.loadingFriends=!0,this.renderFriendsCalled=0,this.throttleAppResize=_.throttle(_.bind(this.handleAppResize,this),300),this.currentBroadcasts={},this.communityUsers.comparator=t,this.playlists.comparator=i,this.activeView="music",this.model.set("size",this.model.get("pageSize")>0?"small":"large"),n.on("sidebar:open",_.bind(this.open,this)),n.on("sidebar:close",_.bind(this.close,this)),n.on("sidebar:size",_.bind(this.onSizeChange,this)),n.on("drag:start",this.openDropMenu,this),n.on("drag:end",this.closeDropMenu,this),n.on("app:resize",this.throttleAppResize,this),n.on("manatee:disconnected",_.bind(this.chatDisconnected,this)),n.on("manatee:connected",_.bind(this.chatConnected,this)),n.on("lightbox:open",_.bind(this.onLightboxOpen,this)),n.on("lightbox:closed",_.bind(this.onLightboxClosed,this)),this.model.on("change:user",_.bind(this.onUserChange,this)),this.user.on("change:Context",_.bind(this.onUserChange,this)),this.onUserChange(),this.render()},onDestroy:function(){this.communityUsers.off(null,null,this);var e=this.model.get("user");e&&e.off(null,null,this),n.off(null,null,this)},onSizeChange:function(e,t){if(!t||t&&this.model.get("size")!=t)var r=!0;e?(e.preventDefault(),e.stopPropagation(),this.stickySize=!0):this.stickySize=!1;var i=$(document.body),s=$("#toggle-sidebar");t?this.model.set("size",t):this.model.set("size",this.model.get("size")=="small"?"large":"small"),this.model.get("size")=="small"?(i.addClass("sidebar-small"),this.$el.addClass("small"),_.defer(_.bind(function(){var e=this.model.get("tooltipOptionsCache");e&&(e.sidebarUser={notch:"right",notchY:60,x:-325,y:-43,shouldHideAds:!0})},this)),n.trigger("guts:log","sidebarClosed"),n.trigger("guts:gatrack","sidebar","sidebarClosed")):(i.removeClass("sidebar-small"),s.find(".icon").removeClass("sidebar-open icon-sidebar-open-m-gray").addClass("sidebar-close icon-sidebar-close-m-gray"),this.$el.removeClass("small"),this.$el.hasClass("filter-open")&&this.toggleFilter(),_.defer(_.bind(function(){var e=this.model.get("tooltipOptionsCache");e&&(e.sidebarUser={notch:"right",notchY:60,x:-325,y:-37,shouldHideAds:!0})},this)),n.trigger("guts:log","sidebarExpanded"),n.trigger("guts:gatrack","sidebar","sidebarExpanded")),r&&this.render(),!n.Services.SWF.chatDisconnected&&this.user&&this.indexRendered&&!this.loadingFriends&&$("#chat-loading").addClass("hide")},onUserChange:function(){this.user=this.model.get("user"),e&&e.get("UserID")!=this.user.get("UserID")&&(e.off(null,null,this),e.get("playlists")&&e.get("playlists").off(null,null,this),e.get("friends")&&e.get("friends").off(null,null,this),e.get("favoriteUsers")&&e.get("favoriteUsers").off(null,null,this),e.get("favoritePlaylists")&&e.get("favoritePlaylists").off(null,null,this),e.get("favoriteBroadcasts")&&e.get("favoriteBroadcasts").off(null,null,this),this.extraUsers.reset([]),this.createdTimestamp=Date.now());if(this.user.get("isLoggedIn")){this.user.on("change:pageNameData",this.renderCollabPlaylists,this),this.user.on("change:Context",this.onContextChange,this),this.user.on("change:sessionPrivacy",this.onUpdatePrivacySettings,this);if(this.indexRendered){var t=this.loadUserInfo();this.loadUserInfoMore(t),this.onUpdatePrivacySettings(),this.onSizeChange(null,this.model.get("size"))}n.trigger("sidebar:open")}else n.trigger("sidebar:close");e=this.user},loadUserInfo:function(e){e||(e=_.chainLoading());var t=$.Deferred();return t.resolve(),e.push(t.done(e.bind(function(){this.renderFriendsCalled=0},this))),this.loadFriendsFailed=!1,this.loadingFriends=!0,e.push(this.user.getFavoritesByType("Users").done(e.bind(function(e){this.loadingFriends=!1,e&&(this.updateFriends(),e.on("add remove reset sort",this.updateFriends,this))},this)).fail(function(){this.loadFriendsFailed=!0})),e.push(this.user.getFriends().fail(function(){n.trigger("notification:add",{description:_.getString("POPUP_ERROR_LOAD_FRIENDS"),type:"error",duration:5e3})})),e.push(this.user.getPlaylists().done(e.bind(function(e){this.model.get("size")=="large"&&(this.renderPlaylists(),e=this.user.get("playlists"),e&&e.on("add remove reset sort",this.renderPlaylists,this))},this)).fail(function(){$(".collapser","#sidebar-playlists").addClass("hide"),$(".scrollbar","#sidebar-playlists").addClass("hide"),$("#playlists-failed").removeClass("hide")})),e},loadUserInfoMore:function(e){e.push(this.user.getFavoritesByType("Playlists").done(e.bind(function(e){this.model.get("size")=="large"&&(this.renderSubscribedPlaylists(),e=this.user.get("favoritePlaylists"),e&&e.on("add remove reset sort",this.renderSubscribedPlaylists,this))},this)).fail(function(){$("#sidebar-subbed-collapser").addClass("hide"),$("#sidebar-subbed-playlists").addClass("hide")})),e.push(this.user.getFavoritesByType("Broadcasts").done(e.bind(function(e){this.model.get("size")=="large"&&(this.renderFavoriteBroadcasts(),e=this.user.get("favoriteBroadcasts"),e&&e.on("add remove reset sort",this.renderFavoriteBroadcasts,this)),this.renderEmptyPlaylistsCTA()},this)).fail(function(){$("#sidebar-broadcasts-collapser").addClass("hide"),$("#sidebar-subbed-broadcasts").addClass("hide")}));var t=0,n=Date.now()-this.createdTimestamp,r=300,i=$.Deferred();return n<r&&(t=Math.min(r,Math.max(0,r-n))),_.delay(_.bind(function(){i.resolve()},this),t),e.push(i.done(e.bind(function(){this.renderFriends()},this))),e},render:function(){this.indexRendered=!1,this.throttleAppResize();var e=_.chainLoading();e.push(this.fetchTemplate("index").done(e.bind(this.onTemplate,this)).done(e.bind(function(){this.user.get("isLoggedIn")?n.trigger("sidebar:open"):n.trigger("sidebar:close")},this))),setTimeout(_.bind(this.loadUserInfo,this,e),30),setTimeout(_.bind(this.loadUserInfoMore,this,e),100)},onTemplate:function(e){this.playlistsGrid&&this.playlistsGrid.$el.detach(),this.collabPlaylistsGrid&&this.collabPlaylistsGrid.$el.detach(),this.subscribedPlaylistsGrid&&this.subscribedPlaylistsGrid.$el.detach(),this.favoriteBroadcastsGrid&&this.favoriteBroadcastsGrid.$el.detach(),this.friendsGrid&&this.friendsGrid.$el.detach(),this.$el.html(this.renderTemplate(e,this)),this.isOnline?$("#sidebar-offline-msg").addClass("hide"):$("#sidebar-offline-msg").removeClass("hide"),this.$playlists=$("#sidebar-playlists"),this.$community=$("#sidebar-community"),this.$playlists.tinyscrollbar({onscroll:_.bind(this.onPlaylistScroll,this)}),this.$community.tinyscrollbar({onscroll:_.bind(this.onCommunityScroll,this)}),this.indexRendered=!0,this.titleHeight=this.$playlists.find(".sidebar-title").outerHeight(),this.$sidebarFilter=$("#sidebar-filter-container"),this.$sidebarUtility=$("#sidebar-utility");var t=$("#section-resize-handle");t.on("draginit",_.bind(this.onSectionResizeStart,this)),t.on("drag",_.bind(this.onSectionResize,this)),t.on("dragend",_.bind(this.onSectionResizeEnd,this)),this.onUpdatePrivacySettings(),this.renderFriends(),this.onSizeChange(null,this.model.get("size"))},open:function(){$("body").addClass("sidebar-open")},close:function(){$("body").removeClass("sidebar-open sidebar-small")},renderPlaylists:function(){if(!this.indexRendered||!this.user.get("isLoggedIn")||!this.user.get("playlists")||this.model.get("size")=="small")return;this.renderEmptyPlaylistsCTA(),this.playlists.reset(this.user.get("playlists").models),this.playlists.comparator=function(e){return e.get("PlaylistName").toLowerCase()},this.playlists.sort();var e=$("#sidebar-playlists-grid"),t=this.$playlists.find(".viewport");this.playlistsGrid?(this.playlistsGrid.collection.reset(this.playlists.models,{sorted:!0}),e[0]!==this.playlistsGrid.el&&e.replaceWith(this.playlistsGrid.$el),t[0]!==this.playlistsGrid.$dropListenOn[0]&&(this.playlistsGrid.removeDragListeners(),this.playlistsGrid.createDragListeners({dropListenOn:t})),$("#sidebar-playlists-collapser").removeClass("loading")):(this.playlistsGrid=new n.Views.PlaylistsSidebarGrid({el:e[0],collection:this.playlists,sidebar:this,dropListenOn:t,overrideScrollPos:_.bind(this.getPlaylistsScrollPos,this)}),$("#sidebar-playlists-collapser").removeClass("loading"),this.playlistsGrid.render(),this.playlistsGrid.on("resized",function(){this.$playlists&&this.$playlists.tinyscrollbar_update("relative")},this)),this.filterGrids(null,$("#sidebar-filter")),this.$playlists.tinyscrollbar_update("relative")},renderCollabPlaylists:function(){if(!this.indexRendered||!this.user.get("isLoggedIn")||!this.user.get("pageNameData")||!this.user.get("pageNameData").CollabPlaylists||this.model.get("size")=="small")return;var e;this.collabPlaylists=[],this.user.get("pageNameData")&&(e=this.user.get("pageNameData").CollabPlaylists),_.each(e,function(t,r){this.collabPlaylists.push(new n.Models.Playlist($.extend(e[r],{PlaylistID:r,Collaborative:!0})))},this),this.collabPlaylists=new n.Models.Collections.Playlists(this.collabPlaylists),this.collabPlaylists.comparator=i;var t=$("#sidebar-collab-playlists"),r=this.$playlists.find(".viewport");this.collabPlaylistsGrid?(this.collabPlaylistsGrid.collection.reset(this.collabPlaylists.models,{sorted:!0}),t[0]!==this.collabPlaylistsGrid.el&&t.replaceWith(this.collabPlaylistsGrid.$el),r[0]!==this.collabPlaylistsGrid.$dropListenOn[0]&&(this.collabPlaylistsGrid.removeDragListeners(),this.collabPlaylistsGrid.createDragListeners({dropListenOn:r})),$("#sidebar-collab-collapser").removeClass("loading")):(this.collabPlaylistsGrid=new n.Views.PlaylistsSidebarGrid({el:t[0],collection:this.collabPlaylists,sidebar:this,dropListenOn:r}),$("#sidebar-collab-collapser").removeClass("loading"),this.collabPlaylistsGrid.render(),this.collabPlaylistsGrid.on("resized",function(){this.$playlists&&this.$playlists.tinyscrollbar_update("relative")},this)),this.filterGrids(null,$("#sidebar-filter")),this.$playlists.tinyscrollbar_update("relative")},renderSubscribedPlaylists:function(){if(!this.indexRendered||!this.user.get("isLoggedIn")||!this.user.get("favoritePlaylists")||this.model.get("size")=="small")return;this.renderEmptyPlaylistsCTA(),this.subscribedPlaylists.reset(this.user.get("favoritePlaylists").models);var e=$("#sidebar-subbed-playlists");this.subscribedPlaylistsGrid?(e[0]!==this.subscribedPlaylistsGrid.el&&e.replaceWith(this.subscribedPlaylistsGrid.$el),this.subscribedPlaylistsGrid.collection.reset(this.subscribedPlaylists.models,{sorted:!0}),$("#sidebar-subbed-collapser").removeClass("loading")):(this.subscribedPlaylistsGrid=new n.Views.PlaylistsSidebarGrid({el:e[0],collection:this.subscribedPlaylists,sidebar:this}),$("#sidebar-subbed-collapser").removeClass("loading"),this.subscribedPlaylistsGrid.render(),this.subscribedPlaylistsGrid.on("resized",function(){this.$playlists&&this.$playlists.tinyscrollbar_update("relative")},this)),this.filterGrids(null,$("#sidebar-filter")),this.$playlists.tinyscrollbar_update("relative")},renderFavoriteBroadcasts:function(){if(!this.indexRendered||!this.user.get("isLoggedIn")||!this.user.get("favoriteBroadcasts")||this.model.get("size")=="small")return;this.renderEmptyPlaylistsCTA(),this.favoriteBroadcasts.reset(this.user.get("favoriteBroadcasts").models);var e=$("#sidebar-broadcasts-grid");this.favoriteBroadcastsGrid?(e[0]!==this.favoriteBroadcastsGrid.el&&e.replaceWith(this.favoriteBroadcastsGrid.$el),this.favoriteBroadcastsGrid.collection.reset(this.favoriteBroadcasts.models,{sorted:!0}),$("#sidebar-broadcasts-collapser").removeClass("loading")):(this.favoriteBroadcastsGrid=new n.Views.BroadcastsSidebarGrid({el:e[0],collection:this.favoriteBroadcasts,sidebar:this}),$("#sidebar-broadcasts-collapser").removeClass("loading"),this.favoriteBroadcastsGrid.render(),this.favoriteBroadcastsGrid.on("resized",function(){this.$playlists&&this.$playlists.tinyscrollbar_update("relative")},this)),this.filterGrids(null,$("#sidebar-filter")),this.$playlists.tinyscrollbar_update("relative")},renderEmptyPlaylistsCTA:function(){var e=this.user.get("playlists"),t=this.user.get("favoritePlaylists"),n=this.user.get("favoriteBroadcasts");(!e||!e.length)&&(!t||!t.length)&&(!n||!n.length)?this.showEmptyPlaylistsCTA():this.hideEmptyPlaylistsCTA()},showEmptyPlaylistsCTA:function(){this.$el.find(".collapser").addClass("hide"),$("#sidebar-no-playlists").removeClass("hide"),this.$el.find(".sidebar-link.new-playlist").addClass("hide"),this.$playlists.tinyscrollbar_update()},hideEmptyPlaylistsCTA:function(){this.$el.find(".collapser").removeClass("hide"),$("#sidebar-no-playlists").addClass("hide"),this.$el.find(".sidebar-link.new-playlist").removeClass("hide")},initialOnlineFriendsUpdate:function(){_.delay(_.bind(function(){n.off("manatee:friendsStatus",null,this),this.communityUsers.on("change:onlineStatus",this.updateOnlineFriendsThrottle,this),this.communityUsers.on("change:nowPlayingSong",this.updateOnlineUserSong,this),this.communityUsers.on("change:currentBroadcastID",this.updateOnlineFriendsThrottle,this),s.call(this),this.subscribedToFriendsChange=!1,this.renderFriends(),$("#chat-loading").addClass("hide")},this),50)},extraUsersUpdate:function(e){this.communityUsers.add(e),this.extraUsers.add(e)},extraUsersRemoved:function(e){this.communityUsers.remove(e),this.extraUsers.remove(e)},updateOnlineFriendsThrottle:_.throttle(s,30),updateOnlineUserSong:function(e,t,n){var r=e.previous("nowPlayingSong");(r&&!t||t&&!r)&&this.updateOnlineFriendsThrottle()},updateFriends:function(){var e=$("#sidebar-user-filter"),t=e.val()?!0:!1,n=this.user.get("favoriteUsers"),r=n?n.models:[],i=[].concat(r).concat(this.extraUsers.models);this.communityUsers.reset(i,{silent:t}),this.$community.tinyscrollbar_update("relative"),this.extraUsers.remove(r),this.sendFriendsToManatee()},sendFriendsToManatee:function(){if(this.user&&!this.loadingFriends){var e=this.user.get("favoriteUsers");if(!e)return;if(!e.length||(this.user.get("sessionPrivacy")&4)>0){$("#chat-loading").addClass("hide");return}this.communityUsers&&(this.communityUsers.off("change:onlineStatus",null,this),this.communityUsers.off("change:nowPlayingSong",null,this),this.subscribedToFriendsChange||(n.on("manatee:friendsStatus",this.initialOnlineFriendsUpdate,this),n.on("manatee:extraUsersStatus",this.extraUsersUpdate,this),n.on("manatee:extraUsersRemoved",this.extraUsersRemoved,this),this.subscribedToFriendsChange=!0));if(this.settingChatFriends)return;this.settingChatFriends=!0;var t=[];e.each(function(e){t.push(e.id),e.addStatusLock("sidebar")}),n.Services.SWF.ready.done(_.bind(function(){n.Services.SWF.setChatFriends(t),this.settingChatFriends=!1},this))}},renderFriends:function(){this.renderFriendsCalled++;var e=this.indexRendered&&this.communityUsers&&this.renderFriendsCalled>=2&&!this.loadingFriends;this.communityUsers&&!this.communityUsers.length&&!this.loadingFriends&&(e=!0);if(!e)return;this.loadFriendsFailed?($("#friends-failed").removeClass("hide"),$("#chat-loading").addClass("hide")):this.communityUsers.length?($("#sidebar-no-friends").addClass("hide"),$("#sidebar-friends").removeClass("hide"),$("#friends-failed").addClass("hide"),$("#sidebar-invite-cta").removeClass("hide")):(this.$el.find(".share-profile").data("userId",this.user.get("UserID")),$("#sidebar-no-friends").removeClass("hide"),$("#sidebar-friends").addClass("hide"));var t=$("#sidebar-friends");this.friendsGrid?t[0]!=this.friendsGrid.el&&t.replaceWith(this.friendsGrid.$el):(t.empty(),this.friendsGrid=new n.Views.UserSidebarGrid({el:t[0],collection:this.communityUsers,scrollElement:this.$community,sidebar:this,currentBroadcasts:this.currentBroadcasts,overrideScrollPos:_.bind(this.getCommunityScrollPos,this)}),this.friendsGrid.blockSize=this.friendsGrid.blockSize*2,this.friendsGrid.render(),this.friendsGrid.on("rendered",function(){this.$community.tinyscrollbar_update("relative")},this),this.friendsGrid.on("resized",function(){this.$community&&this.$community.tinyscrollbar_update("relative")},this)),this.filterGrids(null,$("#sidebar-filter")),this.$community.tinyscrollbar_update("relative")},newPlaylist:function(e){this.user.id>0?n.trigger("lightbox:open","createPlaylist"):n.trigger("lightbox:open","login",{message:_.getString("LB_LOGIN_MUST_LOGIN_TO_CREATE_PLAYLIST"),onLogin:function(e){n.trigger("lightbox:open","createPlaylist")}}),n.trigger("guts:gatrack","sidebar","newPlaylistClick"),n.trigger("guts:log","sidebarClick",{sidebarAction:"newPlaylist"})},openDropMenu:function(){$("#sidebar-content").animate({bottom:163},300,"swing")},closeDropMenu:function(){$("#sidebar-content").animate({bottom:0},300,"swing")},onSettingsMenu:function(e){if(this.settingsTooltip&&this.settingsTooltip.openDfd&&this.settingsTooltip.openDfd.state()==="pending"){this.settingsTooltip.closeTooltip();return}var t=$("#sidebar-settings"),r=this.model.get("user");this.sidebarMenuOptions={tooltipKey:"sidebar-settings",delay:0,notchSize:6,width:170,notch:"bottom",notchX:150,x:-128,y:"top",adjustY:-5,$attached:t,tooltipClass:"menu sidebar-settings",sticky:!0};if(!this.settingsTooltip){var i=r.get("sessionPrivacy"),s,o,u;(i&4)>0?(s="GO_ONLINE",o=0,u=!1):(i&8)>0?(s="GO_OFFLINE",o=4,u=!0):(s="GO_OFFLINE",o=4,u=!0);var a={tooltipKey:"sidebar-settings",model:r,appModel:this.model,items:[{localeKey:s,click:_.bind(function(){this.updatePrivacySetting(null,o)},this)}]};u&&a.items.push({title:(i==0?'<i class="icon check icon-check-gray"></i> ':"")+_.getString("SIDEBAR_EVERYONE"),click:_.bind(function(){this.updatePrivacySetting(null,0)},this),localeKey:"SIDEBAR_EVERYONE"},{title:((i&8)>0?'<i class="icon check icon-check-gray"></i> ':"")+_.getString("SIDEBAR_FRIENDS"),click:_.bind(function(){this.updatePrivacySetting(null,8)},this),localeKey:"SIDEBAR_FRIENDS"}),this.settingsTooltip=new n.Views.Tooltips.Menu(a)}this.sidebarMenuOptions.views=[this.settingsTooltip],$.hideJJMenu(),t.addClass("active"),this.sidebarMenuOptions.dfd=$.Deferred(),n.trigger("tooltip:open",this.sidebarMenuOptions),this.settingsTooltip.openDfd=this.sidebarMenuOptions.dfd,this.settingsTooltip.openDfd.always(function(){t.removeClass("active")}),n.trigger("guts:log","sidebarSettingsClick"),n.trigger("guts:gatrack","sidebar","onSettingsClick")},onAddMenu:function(e){if(this.addMenuTooltip&&this.addMenuTooltip.openDfd&&this.addMenuTooltip.openDfd.state()==="pending"){this.addMenuTooltip.closeTooltip();return}var t=$("#sidebar-add-menu"),r=this.model.get("user");this.sidebarMenuOptions={tooltipKey:"sidebar-add-menu",delay:0,notchSize:6,width:170,notch:"bottom",notchX:150,x:-128,y:"top",adjustY:-5,$attached:t,tooltipClass:"menu sidebar-add-menu",sticky:!0};if(!this.addMenuTooltip){var i=function(e){n.trigger("lightbox:open","invite")},s=function(e){n.trigger("lightbox:open","createPlaylist")},o={tooltipKey:"sidebar-add-menu",model:r,appModel:this.model,items:[{localeKey:"CREATE_PLAYLIST",click:s},{localeKey:"INVITE_FRIENDS",click:i}]};this.addMenuTooltip=new n.Views.Tooltips.Menu(o)}this.sidebarMenuOptions.views=[this.addMenuTooltip],$.hideJJMenu(),t.addClass("active"),this.sidebarMenuOptions.dfd=$.Deferred(),n.trigger("tooltip:open",this.sidebarMenuOptions),this.addMenuTooltip.openDfd=this.sidebarMenuOptions.dfd,this.addMenuTooltip.openDfd.always(function(){t.removeClass("active")}),n.trigger("guts:log","sidebarAddMenuClick"),n.trigger("guts:gatrack","sidebar","onAddMenuClick")},updatePrivacySetting:function(e,t){var r=_.orEqual(t,0);this.user.savePrivacySettings(null,r),n.trigger("guts:log","setPrivacySidebar",{setPrivacySetting:r}),n.trigger("guts:gatrack","site","setPrivacySidebar",r)},onUpdatePrivacySettings:function(){this.isOnline=(this.user.get("sessionPrivacy")&4)==0,this.isOnline||(this.communityUsers.remove(this.extraUsers.models),this.extraUsers.reset([]),this.communityUsers.each(_.bind(function(e){e.set({onlineStatus:0,nowPlayingSong:null})},this))),this.sendFriendsToManatee(),n.trigger("tooltip:close");var e=$("#sidebar-offline-msg");this.isOnline?(e.addClass("hide"),this.$community.css("bottom","")):(e.removeClass("hide"),this.$community.css("bottom",e.outerHeight()+31+"px")),this.$community.tinyscrollbar_update("relative")},closeOfflineMsg:function(){$("#sidebar-offline-msg").addClass("hide"),this.$community.css("bottom","")},filterGrids:function(e,t){if(this.model.get("size")=="small")return;var r=[],i=e?$(e.currentTarget).val().toLowerCase():t.val().toLowerCase(),s=!1;r.push(this.playlistsGrid,this.collabPlaylistsGrid,this.subscribedPlaylistsGrid,this.favoriteBroadcastsGrid,this.friendsGrid);for(var o=0,u=r.length;o<u;o++)r[o]&&(r[o].filter(i),r[o].visibleCollection.length>0?(s=!0,r[o].$el.prev().removeClass("hide")):r[o].$el.prev().addClass("hide"));if(e&&e.which==_.keyboard.ENTER&&i.length&&$.trim(i)!==""&&!s){n.router.performSearch("",i);return}},onFilterSubmit:function(e){return!1},filterFocus:function(e){e.preventDefault(),e.stopPropagation();var t=$(e.currentTarget);t.find(".filter").focus()},onFilterFocus:function(e){var t=$(e.currentTarget);t.siblings(".placeholder").hide()},onFilterBlur:function(e){var t=$(e.currentTarget);t.val()||t.siblings(".placeholder").show()},handleAppResize:function(){this.indexRendered&&(this.$community.tinyscrollbar_update("relative"),this.$playlists.tinyscrollbar_update("relative"))},throttleAppResize:function(){},toggleList:function(e){var t=$(e.currentTarget);$(e.currentTarget).next(".collapsable").toggle(),t.children(".caret").toggleClass("point-right")},scrollbarFadeIn:function(e){var t=$(e.currentTarget);t.find(".scrollbar").stop().fadeTo(200,1)},scrollbarFadeOut:function(e){var t=$(e.currentTarget);t.find(".scrollbar").stop().fadeTo(200,0)},toggleFilter:function(e){var t=this.$sidebarFilter;t.hasClass("hide")?(this.$el.addClass("filter-open"),t.removeClass("hide"),$("#sidebar-filter").focus(),n.trigger("guts:gatrack","sidebar","showFilter"),n.trigger("guts:log","sidebarClick",{sidebarAction:"showFilter"})):(this.$el.removeClass("filter-open"),t.addClass("hide"),n.trigger("guts:gatrack","sidebar","hideFilter"),n.trigger("guts:log","sidebarClick",{sidebarAction:"hideFilter"})),t.find("input").val("").keyup()},onPlaylistScroll:function(e,t,n){n=n||{};if(_.isUndefined(t)||_.isNull(t))t=this.$playlists.position().top*-1;n.overrideScrollPos=t,this.playlistsScrollPos=t,this.playlistsGrid&&this.playlistsGrid.handleScroll(n),this.collabPlaylistsGrid&&this.collabPlaylistsGrid.handleScroll(n)},getPlaylistsScrollPos:function(){return this.playlistsScrollPos||0},chatDisconnected:function(){n.Services.SWF.chatReconnecting?$("#manatee-reconnect").addClass("disabled"):$("#manatee-reconnect").removeClass("disabled"),$("#chat-disconnected").removeClass("hide"),$("#chat-loading").addClass("hide"),$(".js-scrollable","#sidebar-community").addClass("hide")},chatConnected:function(){$("#chat-disconnected").addClass("hide"),$(".js-scrollable","#sidebar-community").removeClass("hide"),$("#chat-loading").removeClass("hide"),this.sendFriendsToManatee()},onManateeReconnectClick:function(){if(!n.Services.SWF.chatDisconnected){this.chatConnected();return}$("#manatee-reconnect").addClass("disabled"),n.trigger("manatee:initReconnect")},onCommunityScroll:function(e,t,n){n=n||{};if(_.isUndefined(t)||_.isNull(t))t=this.$community.position().top*-1;n.overrideScrollPos=t,this.communityScrollPos=t,this.friendsGrid&&this.friendsGrid.handleScroll(n)},getCommunityScrollPos:function(){return this.communityScrollPos||0},onSectionResizeStart:function(){this.playlistsHeight=this.$playlists.height(),this.communityHeight=this.$community.height(),this.communityTop=this.$community.offset().top},onSectionResize:function(e,t){var n=this.titleHeight-1,r=this.$el.height()-(this.$sidebarUtility.outerHeight()+this.titleHeight)+1;if(this.communityTop+t.deltaY<n){this.$community.css("top",n),this.$playlists.height(this.titleHeight);return}if(this.communityTop+t.deltaY>r){this.$community.css("top",r),this.$playlists.height(r-n+this.titleHeight);return}this.$playlists.height(this.playlistsHeight+t.deltaY),this.$community.css("top",this.communityTop+t.deltaY)},onSectionResizeEnd:function(){this.$community.tinyscrollbar_update("relative"),this.$playlists.tinyscrollbar_update("relative"),n.trigger("guts:gatrack","site","sidebarClick","sectionResizeHandle"),n.trigger("guts:log","sidebarClick",{sidebarAction:"sectionResizeHandle"})},onSidebarPlaylistClick:function(){n.trigger("guts:gatrack","site","sidebarClick","onPlaylist"),n.trigger("guts:log","sidebarClick",{sidebarAction:"onPlaylist"})},onSidebarBroadcastClick:function(){n.trigger("guts:gatrack","site","sidebarClick","onBroadcast"),n.trigger("guts:log","sidebarClick",{sidebarAction:"onBroadcast"})},onSidebarUserClick:function(e){var t=$(e.currentTarget),r=$(e.target),i=r.hasClass("sidebar-user")?r:r.closest("a"),s=i.attr("class"),o=t.data("userId"),u;t.hasClass("broadcast-owner")?u="broadcastOwner":t.hasClass("broadcast-listener")?u="broadcastListener":u="sidebarUser",n.trigger("guts:gatrack","site","sidebarClick",u),n.trigger("guts:log","sidebarClick",{container:u,classes:s,userID:o})},onPlaylistsTitleClick:function(){},debouncedOnCommunityScroll:function(){return _.debounce(_.bind(this.onCommunityScroll,this),10)},onContextChange:function(){},onLightboxOpen:function(){this.$el.find("#sidebar-overlay").removeClass("hide-lb")},onLightboxClosed:function(){this.$el.find("#sidebar-overlay").addClass("hide-lb")}},{})}(),function(){n.Views=n.Views||{},n.Views.Pages=n.Views.Pages||{};var t=!1,i=function(){n.Services.SWF.ready.then(function(){n.Services.SWF.attemptAutoRestoreQueue()})},s=function(t,r,i){if(this!==this.options.parent.getCurrentPageView())return;i&&(r=r+"/"+i);if(_.isFunction(t.toUrl)){var s=t.toUrl(r);if(e.location.hash!==s){var o=location.hash.match(/(?:&|\?)fb_comment_id=([a-zA-Z0-9\_\-]+)/);o&&o[1]&&(s+=o[0]),e.location.hash.replace(/src=\d/,"")!==s.replace(/src=\d/,"")&&n.router.replaceHash(s)}}};n.Views.Page=Backbone.View.extend({el:document.getElementById("page"),events:{"click #page-nav a":"onPageNavClick"},initialize:function(){this.pageEl=document.getElementById("page-inner"),this.hasRendered=!1},render:function(){this.hasRendered=!0,this.currentPageView&&this.currentPageView.render()},getCurrentPageView:function(e){e=e!==!1;var t=this.currentPageView;return e&&t&&_.isFunction(t.getOverridePageView)&&(t=t.getOverridePageView()),t},setPage:function(e,s){var o=$.Deferred(),u=!t;t=!0;if(this.currentPageView&&this.currentPageView.pageType===e&&this.currentPageView.options&&this.currentPageView.options.id===s.id&&!s.notFound&&this.currentPageView.options.params&&!this.currentPageView.options.params.notFound)return s.fbComment?o.resolve():(n.trigger("change:page",e,s,this),this.$el.parent().scrollTop(0),this.currentPageView.updatePageParams(s),o.resolve());var a=_.bind(function(t){var o=n.Views.Pages[_.ucwords(e)];if(!o){console.log("page not really loaded",e);return}if(this.lastDfd!==t){console.log("page changed during loading of another page"),u&&i();return}$(".decoupledCapital").hide(),this.removeCurrentPageView(),u&&(s.firstPage=!0),this.currentPageView=new o({el:this.pageEl,id:s.id,parent:this,model:new Backbone.Model({appModel:this.model,gsApp:r}),params:s}),n.trigger("change:page",e,s,this),u&&this.currentPageView.wasFirstPage(),this.hasRendered&&this.currentPageView.render(),t.resolve()},this,o),f=n.Views.Pages[_.ucwords(e)];this.lastDfd=o;if(!f){var l=["artistDashboard","settings","nowPlaying","community","promotion","surveys","tag"],c="/gs/views/pages/"+e+".js";return _.contains(l,e)&&(c=e+"Page"),amdModules.requireDeferred(c).done(a).fail(function(){u&&(t=!1),o.reject()}),o}return a(),o.resolve()},removeCurrentPageView:function(){this.currentPageView&&(this.currentPageView.cleanupChildViews(),this.currentPageView.destroy(!1),this.$el.parent().scrollTop(0),this.currentPageView=null)},onPageNavClick:function(e){var t=$(e.target).attr("DATA-TRANSLATE-TEXT").toLowerCase();n.trigger("guts:gatrack","site","pageNavClick",t),n.trigger("guts:log","pageNavClick",{buttonLabel:t})}}),n.Views.Pages.Base=Backbone.View.extend({setTitle:function(e,t){n.trigger("setTitle",{title:e,prepend:t,page:this})},correctUrl:function(e,t,n){_.delay(_.bind(function(){if(this!==this.options.parent.getCurrentPageView())return;e&&(_.isFunction(e.getPathName)?e.getPathName().then(_.bind(s,this,e,t,n)):s.call(this,e,t,n))},this))},wasFirstPage:i,blockPageChange:function(){return!1},pageLoadFailed:function(){n.router.notFound()},getPlayMenu:function(e,t){t=_.orEqual(t,{});var r=[{key:"PLAY_NOW",title:_.getString("PLAY_NOW"),action:{type:"fn",callback:function(){n.trigger("player:addSongs",e,n.Services.SWF.playSpecialIndexes.DEFAULT,!0,t.playContext)}},customClass:"jj_menu_item_play"},{key:"PLAY_NEXT",title:_.getString("PLAY_NEXT"),action:{type:"fn",callback:function(){n.trigger("player:addSongs",e,n.Services.SWF.playSpecialIndexes.NEXT,!1,t.playContext)}},customClass:"jj_menu_item_play_next"},{key:"PLAY_LAST",title:_.getString("PLAY_LAST"),action:{type:"fn",callback:function(){n.trigger("player:addSongs",e,n.Services.SWF.playSpecialIndexes.LAST,!1,t.playContext)}},customClass:"jj_menu_item_play_last"},{customClass:"separator"},{key:"REPLACE_QUEUE",title:_.getString("REPLACE_QUEUE"),action:{type:"fn",callback:function(){n.trigger("player:addSongs",e,n.Services.SWF.playSpecialIndexes.REPLACE,!0,t.playContext)}},customClass:"jj_menu_item_replace_playlist"},{key:"START_RADIO",title:_.getString("START_RADIO"),action:{type:"fn",callback:function(){n.trigger("player:startRadioWithSongs",e)}},customClass:"jj_menu_item_replace_playlist"}];return r},getAddMenu:function(e,t){t=_.orEqual(t,{});var r=this.model.get("appModel").get("user"),i=[{key:"CONTEXT_ADD_TO_QUEUE",title:_.getString("CONTEXT_ADD_TO_QUEUE"),action:{type:"fn",callback:function(){n.trigger("player:addSongs",e,n.Services.SWF.playSpecialIndexes.LAST,!1,t.playContext)}},customClass:"jj_menu_item_now_playing"}],s=!0;for(var o=0;o<e.length;o++){var u=n.Models.Song.getCached(e[o]);if(u&&!u.get("fromLibrary")){s=!1;break}}return s?i.push({key:"REMOVE_FROM_COLLECTION",title:_.getString("REMOVE_FROM_COLLECTION"),customClass:"jj_menu_item_remove_music",action:{type:"fn",callback:function(){r.removeSongsFromLibrary(e)}}}):i.push({key:"ADD_TO_COLLECTION",title:_.getString("ADD_TO_COLLECTION"),action:{type:"fn",callback:function(){r.addSongsToLibrary(e)}},customClass:"jj_menu_item_music"}),e.length==1&&(n.Models.Song.getCached(e[0]).get("isFavorite")?i.push({key:"CONTEXT_REMOVE_FROM_FAVORITES",title:_.getString("CONTEXT_REMOVE_FROM_FAVORITES"),action:{type:"fn",callback:function(){r.favorite("Songs",e[0])}},customClass:"jj_menu_item_favorites"}):i.push({key:"CONTEXT_ADD_TO_FAVORITES",title:_.getString("CONTEXT_ADD_TO_FAVORITES"),action:{type:"fn",callback:function(){r.favorite("Songs",e[0])}},customClass:"jj_menu_item_favorites"})),i.push({key:"CONTEXT_ADD_TO_PLAYLIST",title:_.getString("CONTEXT_ADD_TO_PLAYLIST"),type:"sub",src:r.getPlaylistsMenu(!1,!0,{songs:e},function(t){t.addSongs(e,null,!0)}),customClass:"jj_menu_item_add_playlist jj_menu_item_more"}),i},handleFavoriteButtonChange:function(e,t){var n=["artist","playlist","user"],r=$("a.favorite-page",this.el),i=_.getItemType(e);if(_.indexOf(n,i)==-1||_.isUndefined(r))return;var s=this.model.get("appModel").get("user"),o=this.model.get(i).get("isFavorite"),u=r.hasClass("favorite-flat"),a="",f="";if(i=="playlist")a="SUBSCRIBED",f="SUBSCRIBE";else if(i=="artist"||i=="user")a="FOLLOWING",f="FOLLOW";o?(r.addClass("btn-success"),u?(r.find(".icon").removeClass("icon-plus-small-gray-flat").addClass("icon-check-white-flat"),r.find(".favorite-label").attr("DATA-TRANSLATE-TEXT",a).text(_.getString(a))):(r.find(".icon").removeClass("icon-plus-gray").addClass("icon-check-white-active"),r.find(".favorite-label").attr("DATA-TRANSLATE-TEXT",a).text(_.getString(a)))):(r.removeClass("btn-success"),u?(r.find(".icon").addClass("icon-plus-small-gray-flat").removeClass("icon-check-white-flat"),r.find(".favorite-label").attr("DATA-TRANSLATE-TEXT",f).text(_.getString(f))):(r.find(".icon").addClass("icon-plus-gray").removeClass("icon-check-white-active"),r.find(".favorite-label").attr("DATA-TRANSLATE-TEXT",f).text(_.getString(f))))}}),n.Views.Pages.ItemPage=n.Views.Pages.Base.extend({commentsRendered:!1,initialize:function(){this.$el.on("click",".column2-tab",_.bind(this.toggleCommentsActivity,this)),this.model.has("defaultSidebarTab")||this.model.set("defaultSidebarTab","comments")},toggleCommentsActivity:function(e){var t=$(e.currentTarget),n=$("#comments"),r=$("#activity");t.hasClass("show-comments")?(r.addClass("hide"),n.removeClass("hide")):(n.addClass("hide"),r.removeClass("hide")),t.addClass("active").siblings().removeClass("active")},showActivity:function(){$("#comments").addClass("hide"),$("#activity").removeClass("hide"),$("#comments-tab").removeClass("active"),$("#activity-tab").addClass("active")},showComments:function(){$("#activity").addClass("hide"),$("#comments").removeClass("hide"),$("#comments-tab").addClass("active"),$("#activity-tab").removeClass("active")},handleCommentSubpage:function(){var e=null,t=this.model.get("subpage"),n=this.model.get("section");if(t&&t!=="profile")if(t.indexOf("comment")===0){var r=t.split("/");e=r[1],this.model.set({section:"",subpage:this.defaultSubpage})}else n==="comment"&&(e=t,this.model.set({section:this.defaultSection,subpage:this.defaultSubpage}));return e},loadComments:function(e,t,r){if(r)return this.highlightSingleComment(r,e,t);var i;t?i=t.bind(this.renderComments,this):i=_.bind(this.renderComments,this),t.push(n.Models.Comment.loadComments(this.pageType,e).done(i))},highlightSingleComment:function(e,t,r){r||(r=_.chainLoading());var i=[],s=_.bind(function(){this.renderComments.apply(this,i),this.showComments()},this);r.push(n.Models.Comment.loadComments(this.pageType,t).done(r.bind(function(){i=i.concat(_.toArray(arguments))},this))),r.push(n.Models.Comment.get(e).done(r.bind(function(e){i.push(e),s()},this)).fail(r.bind(function(){i.push(-1),s()},this)))},renderComments:function(e,t,r,i){if(this.destroyed||!this.indexRendered)return;if(!e||!(e instanceof n.Models.Collections.Comments))e=new n.Models.Collections.Comments;if(i===-1)n.router.notFound();else if(i&&(i.get("TypeID")!==r||i.get("ItemID")!==t)){n.router.replaceHash(i.toUrl());return}var s=this.model.get(this.pageType),o="",u=this.model.get("appModel").get("user");switch(r){case n.Models.Comment.COMMENT_PAGE_TYPES.ARTIST:o=s.escape("ArtistName");break;case n.Models.Comment.COMMENT_PAGE_TYPES.ALBUM:o=s.escape("AlbumName");break;case n.Models.Comment.COMMENT_PAGE_TYPES.PLAYLIST:o=s.escape("PlaylistName");break;case n.Models.Comment.COMMENT_PAGE_TYPES.USER:o=s.escape("Name");break;case n.Models.Comment.COMMENT_PAGE_TYPES.SONG:o=s.escape("SongName")}var a=new n.Views.Comments({el:$("#comments")[0],collection:e,itemID:t,typeID:r,model:this.model,item:s,itemName:o,highlightComment:i,commentStyleType:this.pageType=="song"?"page":"sidebar"});a&&(this.childViews.push(a),a.render()),this.commentsRendered||this.modelBindings.push(this.model.get("appModel").on("change:user",_.bind(this.renderComments,this,e,t,r,null))),this.commentsRendered=!0},feedEventsRendered:!1,handleFeedEventSubpage:function(){var e=null,t="user",n=this.model.get("subpage"),r=this.model.get("subpageData"),i=this.model.get("section");if(n&&n!=="profile")if(n.indexOf("activity")===0){var s=n.split("/");s[1]=="a"&&s[2]?(e=s[2],t="artist"):e=s[1],e?this.model.set({subpage:"singleFeedEvent"}):this.model.set({section:"",subpage:this.defaultSubpage,defaultSidebarTab:"activity"})}else i==="activity"&&(n=="a"?(t="artist",e=r):e=n,this.model.set({subpage:"",section:"singleFeedEvent"}));else i==="activity"&&this.model.set({section:"",subpage:this.defaultSubpage,defaultSidebarTab:"activity"});return e?{eventID:e,eventType:t}:null},loadActivity:function(e,t){if(t)return this.highlightSingleFeedEvent(t,e);var n;e?n=e.bind(this.renderActivity,this):n=_.bind(this.renderActivity,this),e.push(this.model.get(this.pageType).getFeed().done(n))},highlightSingleFeedEvent:function(e,t){t||(t=_.chainLoading()),t.push(this.fetchTemplate("/shared/feedEventPage").done(t.bind(function(e){if(this.destroyed&&this.model.get("section")==="singleFeedEvent")return;this.$el.html(this.renderTemplate(e)),n.trigger("page:ready",this)},this))),t.push(n.Models.FeedEvent.get(e.eventID,e.eventType||this.pageType).done(t.bind(function(e){if(!e){n.router.notFound();return}if(e&&e.get("feedType")==="user"&&e.get("UserID")!==this.model.get("userID")){n.router.replaceHash(e.toUrl());return}if(e&&e.get("feedType")==="artist"&&e.get("ArtistID")!==this.model.get("artistID")){n.router.replaceHash(e.toUrl());return}var t=new n.Views.Modules.SingleFeedEvent({el:$("#feed-event-container"),model:e,$relatedContentEl:$("#event-related-content")});this.childViews.push(t),t.render().fail(function(){n.router.notFound()})},this)).fail(t.bind(function(){n.router.notFound()},this)))},renderActivity:function(e,t,r){if(this.destroyed||!this.indexRendered)return;if(!e||!(e instanceof n.Models.Collections.FeedEvents))e=new n.Models.Collections.FeedEvents;if(r!==-1){if(r&&r.get("feedType")==="user"&&r.get("UserID")!==this.model.get("userID")){n.router.replaceHash(r.toUrl());return}if(r&&r.get("feedType")==="artist"&&r.get("ArtistID")!==this.model.get("artistID")){n.router.replaceHash(r.toUrl());return}}var i=new n.Views.ActivityFeed({el:$("#activity")[0],collection:e,model:this.model.get(this.pageType),highlightFeedEvent:r});i&&(this.childViews.push(i),i.render()),this.feedEventsRendered||this.modelBindings.push(this.model.get("appModel").on("change:user",_.bind(this.renderActivity,this,e,null,null))),this.feedEventsRendered=!0}})}(),function(){function s(e){switch(e._type){case"video":case"record":case"previewSong":case"editBroadcast":case"broadcastEnded":return}var n=$("#lightbox-content"),r=n.position(),i=t.height()-(r?r.top:0);n.css("max-height",i+"px");if(n.length&&n[0].scrollHeight<i)e._hasScrollbarEnhancedWidth&&($("#lightbox").css("width",""),e._hasScrollbarEnhancedWidth=!1);else if(!e._hasScrollbarEnhancedWidth&&n.length){var s=$("#lb-side-nav"),o=s.length?n.width()+s.outerWidth():n.width();$("#lightbox").width(o+(n.width()-n[0].clientWidth)),e._hasScrollbarEnhancedWidth=!0}}n.Views=n.Views||{},n.Views.Lightboxes=n.Views.Lightboxes||{};var t=$("#page-wrapper"),i=0;n.Views.Lightbox=Backbone.View.extend({el:document.getElementById("lightbox-outer"),events:{"click .close":"closeHandler","keydown form input":"enterSubmit"},initialize:function(){this.$overlay=$("#lightbox-overlay"),this.$lightbox=$("#lightbox"),this.queue=[],this.currentLightbox=!1,this.isOpen=!1,this.model.set({lightboxOpen:!1}),n.on("lightbox:open",this.open,this),n.on("lightbox:close",this.close,this),n.on("lightbox:closeAll",this.closeAll,this),n.on("queue:setSize",this.handleResize,this),$(document).on("keydown.lightbox",_.bind(function(e){e.which==_.keyboard.ESC&&this.isOpen&&this.currentLightbox._canClose&&this.close()},this)),$("#lightbox-overlay, #lightbox-outer, #sidebar").on("click",_.bind(this.clickOverlay,this)),n.on("lightbox:rendered",this.onRendered,this)},onDestroy:function(){$(document).off(".lightbox")},handleResize:function(){this.isOpen&&s(this.currentLightbox)},render:function(){this.isOpen?(n.trigger("tooltip:close"),this.currentLightbox._canClose?$("#lightbox-close",this.$el).removeClass("hide"):$("#lightbox-close",this.$el).addClass("hide"),$.browser.mozilla&&_.toInt($.browser.version)<6?$(".theme-component .flash object").each(function(e,t){t.style.visibility="hidden"}):$(".theme-component .flash object").hide(),_.each($(".capital, .theme-capital-placeholder"),function(e,t){$("#"+$(e).attr("data-capital-id")).hide()}),this.$el.removeClass("player-visible"),this.$overlay.removeClass("player-visible"),this.currentLightbox._showPlayerControls&&(this.$el.addClass("player-visible"),this.$overlay.addClass("player-visible")),this.$overlay.removeClass("hide-lb"),this.$lightbox.attr("class","lightbox-"+this.currentLightbox._type),this.currentLightbox.render()):($.browser.mozilla&&_.toInt($.browser.version)<6?$(".theme-component .flash object").each(function(e,t){t.style.visibility="visible"}):$(".theme-component .flash object").show(),_.each($(".capital, .theme-capital-placeholder"),function(e,t){$("#"+$(e).attr("data-capital-id")).show()}),n.trigger("ad:updatePositions"),this.$el.addClass("hide-lb"),this.$overlay.addClass("hide-lb"),this.$lightbox.css("width",""),s(this.currentLightbox))},onRendered:function(){this.$el.removeClass("hide-lb")},open:function(t,i){if(t=="payments"&&(!i||i&&i.tab!="redeem")){i=i||{},n.Services.Local.get("gs.locale")&&(i.lang=n.Services.Local.get("gs.locale"));var s=_.getCenteredCoordinates(600,418),o="width=600,height=418,left="+s[0]+",top="+s[1]+",menubar=0,resizable=0,status=0,toolbar=0",u=e.open("https://"+e.location.host+"/pay.php?"+$.param(i),"payGS",o),a,f=function(){clearInterval(a),n.trigger("lightbox:close","paymentsOpen");var e=n.Models.AuthUser.getCached(n.getLoggedInUserID()),t=!0;i.action==="cancel"&&(t=!1),e.gotNewSubscription(!t,!0).done(function(e){}).fail(function(){n.trigger("notification:add",{description:_.getString("REFRESH_SUB_ERROR_UNKNOWN"),type:"error"})})};n.trigger("lightbox:open",{_type:"paymentsOpen",_canClose:!1,view:{header:"PAYMENT",message:"POPUP_PAYMENT_OPEN",buttonsLeft:[{label:"CANCEL",className:"cancel"}]},callbacks:{".cancel":function(){u.close(),f()}}}),a=setInterval(function(){u.closed&&f()},1e3);return}if(e.gsProduction&&e.gsProduction.LB_CSSURI){var l=_.isUndefined(e.dataURISupport)||dataURISupport?gsProduction.LB_CSSURI:gsProduction.LB_CSS;l&&l.assetPath&&$.getStylesheet(l.assetPath)}typeof t=="object"&&(i=t,t="generic"),i=_.orEqual(i,{});var c=t=="generic"?i._type:t;if(this.isOpen&&this.currentLightbox&&c===this.currentLightbox._type)return;var h=_.bind(function(){var e=n.Views.Lightboxes[p];if(!e){console.log("invalid lb type (in bind)");return}var t=new e({model:new Backbone.Model({appModel:this.model,gsApp:r}),params:i});t._type=c;for(var s=0;s<this.queue.length;s++)if(c===this.queue[s]._type){this.queue[s].destroy(),this.queue[s]=t;return}if(this.isOpen&&this.currentLightbox){if(t._priority<this.currentLightbox._priority){var o=_.sortedIndex(this.queue,t,function(e){return e._priority});this.queue.splice(o,0,t);return}this.currentLightbox.suspend(),this.queue.push(this.currentLightbox)}this.currentLightbox=t,this.isOpen=!0,this.model.set({lightboxOpen:!0}),this.render(),n.trigger("lightbox:ready",this,this.currentLightbox)},this),p=t.substr(0,1).toUpperCase()+t.substr(1),d=n.Views.Lightboxes[p];if(!d){var v=["claimArtist","claimSongs","editArtist","editAlbum","editSongs","upload","share","suggestTags","feedback","invite"],m="/gs/views/lightboxes/"+t+".js";_.contains(v,t)&&(m=t+"Lightbox"),amdModules.requireDeferred(m).done(h).fail(function(){console.log("invalid lb type",t,arguments,m)});return}h()},close:function(e){var t=e&&_.isString(e)?e:!1,r=e&&_.isInstance(e,n.Views.Lightboxes.Base)?e:!1;if(t||r){var i=[],s=0,o=this.queue.length,u;for(;s<o;s++)u=this.queue[s],u===r||u._type===t?u.beforeClose()&&u.destroy():i.push(u);this.queue=i}if(!this.currentLightbox||(t||r)&&this.currentLightbox!==r&&this.currentLightbox._type!==t)return;if(!this.currentLightbox.beforeClose())return;this.currentLightbox.destroy(),n.trigger("lightbox:destroyed",this,this.currentLightbox),this.queue.length?(this.currentLightbox=this.queue.pop(),this.currentLightbox.resume()):(this.isOpen=!1,this.model.set({lightboxOpen:!1}),this.currentLightbox=!1,n.trigger("lightbox:closed")),this.render()},closeAll:function(){if(this.currentLightbox){if(!this.currentLightbox.beforeClose())return;this.currentLightbox.destroy(),n.trigger("lightbox:destroyed",this,this.currentLightbox)}_.forEach(this.queue,_.bind(function(e){if(!e.beforeClose())return!1;e.destroy(),this.queue.pop()},this)),this.queue.length?(this.currentLightbox=this.queue.pop(),this.currentLightbox.resume()):(this.isOpen=!1,this.model.set({lightboxOpen:!1}),this.currentLightbox=!1,n.trigger("lightbox:closed")),this.render()},closeHandler:function(){this.close()},clickOverlay:function(e){var t=$(e.target),n=this.currentLightbox&&this.currentLightbox._canClose;t.is("#lightbox-overlay, #lightbox-outer, #sidebar-overlay")&&n&&this.close()},enterSubmit:function(e){if(e.keyCode==13){var t=$(e.currentTarget),n=t.parents("form");if(!t.hasClass("no-submit"))return n.submit(),!1}}},{trackLightboxView:function(t){var n="#!/lb/"+t;return e._gaq&&e._gaq.push?(n=encodeURI(n),e._gaq.push(["_trackPageview",n]),!0):!1}}),n.Views.Lightboxes.Base=Backbone.View.extend({templatePath:"lightbox",tagName:"div",className:"lbcontainer",_priority:0,_canClose:!0,_showPlayerControls:!1,initialize:function(){this.options.params=this.options.params||{},_.defined(this.options.params._priority)&&(this._priority=this.options.params._priority),_.defined(this.options.params._canClose)&&(this._canClose=this.options.params._canClose),_.defined(this.options.params._showPlayerControls)&&(this._showPlayerControls=this.options.params.showPlayerControls),this.$parent=$("#lightbox-inner"),this.viewReported=!1,this.suspended=!1},handleResize:function(){s(this)},render:function(){if(this.suspended||this.destroyed)return;this.viewReported||(this.viewReported=n.Views.Lightbox.trackLightboxView(this._type)),$.contains(this.$parent[0],this.$el[0])||this.$parent.append(this.$el)},onTemplate:function(){this._canClose&&$("#lightbox-close",this.$el).removeClass("hide-lb"),this.handleResize(),$("#lightbox-content :input:visible:first").focus()},suspend:function(){this.suspended=!0,this.$el.hide()},resume:function(){this.suspended=!1,this.$el.show()},beforeClose:function(){return!0},close:function(){n.trigger("lightbox:close",this)}})}(),function(){n.Views=n.Views||{},n.Views.Modules=n.Views.Modules||{};var i=function(e,t,r){if(!t)return;var i=$(e.currentTarget),s=t._wrapped||t,o=r||{},u={xposition:"left",yposition:"auto",show:"default",className:"option-context-menu",keepState:i},a={extra:o,menuOptions:u},f,l;o.onMouse&&(u.xposition=u.yposition="mouse"),o.hasOwnProperty("keepState")&&(u.keepState=o.keepState),o.hasOwnProperty("shouldLog")&&(u.shouldLog=o.shouldLog);if(s instanceof n.Models.Song)f="Song";else if(s instanceof n.Models.Album)f="Album";else{if(!(s instanceof n.Models.Playlist))return;f="Playlist"}l="getContextMenuFor"+f,_.asyncMenu(e,i,a,s,l)};n.Views.Modules.Base=Backbone.View.extend({templatePath:"modules",templateFile:"base",tagName:"div",className:"module grid-item",cacheKey:"Base",initialize:function(e){this.changeModelCached={};var t={module:this};e.grid&&(this.grid=e.grid,this.grid.options&&(this.grid.options.playContext&&(t.playContext=this.grid.options.playContext),this.grid.options.addStreamType&&(t.streamType=this.grid.options.addStreamType))),e.activeSong&&(this.activeSong=!0),this.disabled=!1,this.$el.data(t),this.addModelListeners(),this.$el.on("mouseleave",_.bind(function(){this.$el.blur()},this)),this.options.addClass&&this.$el.addClass(this.options.addClass);var n=this.changeModelSelectors["&"];_.isFunction(n)&&n.call(this,0,this.el)},addModelListeners:function(){this.grid&&this.grid.cid&&(this.model.on(this.grid.cid+":select",this.select,this),this.model.on(this.grid.cid+":deselect",this.deselect,this)),this.model.on("change",this.handleModelChange,this)},removeModelListeners:function(){this.model.off(null,null,this)},destroy:function(e){this.removeModelListeners(),this.$el.off("mouseleave"),this._super.call(this,"destroy",e)},changeModelSelectors:{},render:function(){return this.model?(this.renderDfd=$.Deferred(),n.Views.Modules[this.cacheKey].cachedTemplate?(this.completeRender(n.Views.Modules[this.cacheKey].cachedTemplate),this.renderDfd.promise()):(this.fetchTemplate(this.templateFile).always(_.bind(this.cacheAndCompleteRender,this)),this.renderDfd.promise())):$.Deferred().resolve()},select:function(){this.selected=!0,this.$el.addClass("active")},deselect:function(){this.selected=!1,this.$el.removeClass("active")},changeModel:function(e,t){t=_.defaults(t||{},{selected:!1,force:!1});var n=this.changeModelSelectors,r;if(this.model==e&&!t.force)return;this.model!=e&&(this.removeModelListeners(),this.model=e,this.addModelListeners()),this.selected&&!t.selected?this.deselect():!this.selected&&t.selected&&this.select();if(!this.renderDfd){this.render();return}if(this.renderDfd.state()!=="resolved")return;n.hasOwnProperty("&")&&(this.changeModelCached["&"]||(this.changeModelCached["&"]=this.$el),this.changeModelCached["&"].each(_.bind(n["&"],this)));for(r in n)r!=="&"&&n.hasOwnProperty(r)&&(this.changeModelCached[r]||(this.changeModelCached[r]=this.$el.find(r)),this.changeModelCached[r].each(_.bind(n[r],this)))},show:function(){this.isHidden&&(this.isHidden=!1,this.$el.show())},hide:function(){this.isHidden=!0,this.$el.hide()},cacheAndCompleteRender:function(e){n.Views.Modules[this.cacheKey].cachedTemplate=e,this.completeRender(e)},completeRender:function(e,t){if(this.renderDfd.state()==="resolved")return;var r=t||{};r.skipHTML||this.$el.html(this.renderTemplate(_.bind(e,this)));var i=this.grid&&this.grid.options?this.grid.options.excludeCells:!1;if(i&&i.length)for(var s=0,o=i.length;s<o;s++)this.$el.find(".module-row-cell."+i[s]).remove();this.renderDfd.resolve(e),this.templateConverted&&this.handleModelChange(),this.options.redrawUpdate&&n.trigger("page:redrawUpdate"),this.trigger("rendered")},acceptDrop:function(e){return!1},handleModelChange:function(){var e={force:!0};this.grid&&this.grid.selectedItems&&(e.selected=this.grid.selectedItems.indexOf(this.model)!==-1),this.changeModel(this.model,e)}},{precacheTemplate:function(e,t,r){if(n.Views.Modules[e].cachedTemplate)return $.Deferred().resolve(n.Views.Modules[e].cachedTemplate);var i={templatePath:r,fetchTemplate:Backbone.View.prototype.fetchTemplate};return i.fetchTemplate(t).always(_.bind(function(t){n.Views.Modules[e].cachedTemplate=t},this))}}),n.Views.Modules.SongRow=n.Views.Modules.Base.extend({className:"module module-row song grid-item",cacheKey:"SongRow",templateFile:"songRow",templateConverted:!0,events:{"click .song-row-dropdown":"onDropDownGearClick","click .module-row-cell.artist a":"onArtistLinkClick","click .module-row-cell.album a":"onAlbumLinkClick","click i.song-link":"onSongLinkClick","click a.play":"onSongPlay","click a.song-row-favorite":"onSongFavorite","click a.song-row-add":"onSongAdded","click a.song-row-share":"onSongShared"},changeModelSelectors:{"&":function(e,t){_.$one(t).data("songId",this.model.get("SongID")),this.model.get("removedFrom")?_.$one(t).addClass("removed-from").removeClass("active"):_.$one(t).removeClass("removed-from")},".btn.play":function(e,t){_.$one(t).data("songId",this.model.get("SongID"))},".btn.song-row-favorite":function(e,t){_.$one(t).data("songId",this.model.get("SongID"))},".btn.song-row-add":function(e,t){_.$one(t).data("songId",this.model.get("SongID"))},".btn.song-row-dropdown":function(e,t){_.$one(t).data("songId",this.model.get("SongID"))},".btn.song-row-share":function(e,t){_.$one(t).data("songId",this.model.get("SongID"))},".btn.song-row-delete":function(e,t){_.$one(t).data("songId",this.model.get("SongID"))},".btn.song-row-favorite .icon":function(e,t){this.model.get("isFavorite")?_.$one(t).removeClass("icon-heart-gray-flat").addClass("icon-heart-color-flat color-flat"):_.$one(t).removeClass("icon-heart-color-flat color-flat").addClass("icon-heart-gray-flat")},".btn.song-row-add .icon":function(e,t){this.model.get("fromLibrary")?_.$one(t).removeClass("icon-check-gray-flat").addClass("icon-check-color-flat color-flat"):_.$one(t).removeClass("icon-check-color-flat color-flat").addClass("icon-check-gray-flat")},".song-link":function(e,t){_.$one(t).data("songId",this.model.get("SongID"))},".title":function(e,t){_.$one(t).innerText(this.model.get("SongName"))},".artist a":function(e,t){_.$one(t).attr("href",this.model.toArtistUrl()).innerText(this.model.get("ArtistName"))},".album a":function(e,t){_.$one(t).attr("href",this.model.toAlbumUrl()).innerText(this.model.get("AlbumName"))},".track-num":function(e,t){var n;if(this.grid.options.contextAlbumID){var r=this.model.get("TrackNumsByAlbumID");n=r&&r[this.grid.options.contextAlbumID]||""}else n=this.model.get("TrackNum")||"";_.$one(t).innerText(n)}},initialize:function(e){this.$el.data("songId",this.model.get("SongID")),this._super.call(this,"initialize",e)},completeRender:function(e,t){this._super.call(this,"completeRender",e,t),this.$(".btn.song-row-delete")[(this.grid.options&&this.grid.options.canDelete?"remove":"add")+"Class"]("hide")},onDropDownGearClick:function(e){var t=this.model,r={},s=$.extend({songIDs:t.get("SongID")},n.Services.GUTS&&n.Services.GUTS.songItemGetContexts(e));this.grid&&this.grid.options&&(this.grid.options.playContext&&(r.playContext=this.grid.options.playContext),this.grid.options.playlist&&this.grid.options.playlist.isEditable()&&(r.playlist=this.grid.options.playlist,r.playlistSongID=this.model.get("playlistSongID"))),i(e,t,r),n.trigger("guts:log","OLdropdownClick",s)},onArtistLinkClick:function(e){var t=$(e.currentTarget),r=t.closest(".grid-item").data("songId"),i=$.extend({songID:r},n.Services.GUTS&&n.Services.GUTS.songItemGetContexts(e));n.trigger("guts:log","OLartistPageLoad",i)},onAlbumLinkClick:function(e){var t=$(e.currentTarget),r=t.closest(".grid-item").data("songId"),i=$.extend({songID:r},n.Services.GUTS&&n.Services.GUTS.songItemGetContexts(e));n.trigger("guts:log","OLalbumPageLoad",i)},onSongLinkClick:function(e){var t=$(e.currentTarget),r=t.data("songId"),i=$.extend({songID:r},n.Services.GUTS&&n.Services.GUTS.songItemGetContexts(e));n.trigger("guts:log","OLsongPageLoad",i)},onSongPlay:function(e){var t=$(e.currentTarget),r=t.data("songId"),i=$.extend({songID:r},n.Services.GUTS&&n.Services.GUTS.songItemGetContexts(e));n.trigger("guts:log","OLPlayClick",i)},onSongShared:function(e){var t=$(e.currentTarget),r=t.data("songId"),i=$.extend({songID:r},n.Services.GUTS&&n.Services.GUTS.songItemGetContexts(e));n.trigger("guts:log","OLShareClick",i)},onSongAdded:function(e){var t=$(e.currentTarget),r=t.data("songId"),i=$.extend({songID:r},n.Services.GUTS&&n.Services.GUTS.songItemGetContexts(e));n.trigger("guts:log","OLlibraryClick",i)},onSongFavorite:function(e){var t=$(e.currentTarget),r=t.data("songId"),i=$.extend({songID:r},n.Services.GUTS&&n.Services.GUTS.songItemGetContexts(e));n.trigger("guts:log","OLfavoriteClick",i)}}),n.Views.Modules.SongRowTall=n.Views.Modules.Base.extend({className:"module module-row song tall grid-item",cacheKey:"SongRowTall",templateFile:"songRowTall",events:{"click .song-row-dropdown":"onDropDownGearClick","click .song-row-add":"onAddClick","click .metadata .artist":"onArtistLinkClick","click .metadata .album":"onAlbumLinkClick","click .metadata i.song-link":"onSongLinkClick","click .btn.play":"onSongPlay","click .song-row-favorite":"onSongFavorite","click .song-row-share":"onSongShared","click .upvote-btn":"onSongUpVoteClick","click .downvote-btn":"onSongDownVoteClick","click .approve":"onSongApproveClick","click .reject":"onSongRejectClick"},changeModelSelectors:{"&":function(e,t){var n=this.model.get("SongID"),r=this.model.get("CalloutID");_.$one(t).data("songId",n).data("calloutId",r),r?_.$one(t).smartAddClass("callout-tall"):_.$one(t).smartRemoveClass("callout-tall"),this.activeSong?_.$one(t).smartAddClass("is-playing"):_.$one(t).smartRemoveClass("is-playing"),this.model.get("approvalStatus")>0?_.$one(this.el).smartAddClass("approved").smartRemoveClass("rejected"):this.model.get("approvalStatus")<0?_.$one(this.el).smartAddClass("rejected").smartRemoveClass("approved"):_.$one(this.el).smartRemoveClass("approved rejected"),this.model.idAttribute=="queueSongID"&&this.$el.data("queueSongId",this.model.id)},".btn.play":function(e,t){_.$one(t).data("songId",this.model.get("SongID"))[(this.model.get("isCallout")?"smartAdd":"smartRemove")+"Class"]("hide")},".title":function(e,t){_.$one(t).innerText(this.model.get("SongName"))},".song-link":function(e,t){_.$one(t).data("songId",this.model.get("SongID"))[(this.model.get("isCallout")?"smartAdd":"smartRemove")+"Class"]("hide")},".meta-inner":function(e,t){_.$one(t)[(this.model.get("isCallout")?"smartAdd":"smartRemove")+"Class"]("hide")},".row-actions.bc-actions":function(e,t){_.$one(t)[(this.model.get("isCallout")?"smartAdd":"smartRemove")+"Class"]("hide")},".btn.favorite":function(e,t){_.$one(t).data("songId",this.model.get("SongID"))},".btn.song-row-add":function(e,t){_.$one(t).data("songId",this.model.get("SongID"))},".btn.song-row-dropdown":function(e,t){_.$one(t).data("songId",this.model.get("SongID"))},".btn.song-row-share":function(e,t){_.$one(t).data("songId",this.model.get("SongID"))},".img":function(e,t){_.$one(t).attr("src",this.model.getImageURL(this.activeSong?80:40))},".btn.song-row-favorite .icon":function(e,t){this.model.get("isFavorite")?_.$one(t).smartRemoveClass("icon-heart-gray-flat").smartAddClass("icon-heart-color-flat color-flat"):_.$one(t).smartRemoveClass("icon-heart-color-flat color-flat").smartAddClass("icon-heart-gray-flat")},".btn.song-row-add .icon":function(e,t){this.model.get("fromLibrary")?_.$one(t).smartRemoveClass("icon-check-gray-flat").smartAddClass("icon-check-color-flat color-flat"):_.$one(t).smartRemoveClass("icon-check-color-flat color-flat").smartAddClass("icon-check-gray-flat")},"a.artist":function(e,t){_.$one(t).attr("href",this.model.toArtistUrl()).innerText(this.model.get("ArtistName"))},"a.album":function(e,t){_.$one(t).attr("href",this.model.toAlbumUrl()).innerText(this.model.get("AlbumName"))},".bull":function(e,t){var n=this.model.get("AlbumName");n?_.$one(t).smartRemoveClass("hide"):_.$one(t).smartAddClass("hide")},"a.album.suggestion":function(e,t){var n=this.model.get("suggester");n?_.$one(t).smartAddClass("hide"):_.$one(t).smartRemoveClass("hide")},".suggested-by-text":function(e,t){var n=this.model.get("suggester");n?_.$one(t).smartRemoveClass("hide"):_.$one(t).smartAddClass("hide")},".user-link":function(e,t){var n=this.model.get("suggester");n?(_.$one(t).attr("href",n.toUrl()).html(n.escape("Name")),_.$one(t).smartRemoveClass("hide")):_.$one(t).smartAddClass("hide")},".row-number":function(e,t){_.$one(t).innerText(this.grid.collection.indexOf(this.model)+1+".")},".votes":function(e,t){_.$one(t)[(this.grid.options&&this.grid.options.isBroadcastOwner&&(this.activeSong||this.grid.options.isBroadcastHistory)?"add":"remove")+"Class"]("both-votes")},".upvotes":function(e,t){var n=this.model.get("upVotes"),r=this.model.get("downVotes"),i=this.grid.options&&this.grid.options.isBroadcastHistory,s=(this.activeSong||i)&&this.grid.options&&this.grid.options.isBroadcastOwner;n=_.isArray(n)?n.length:_.toInt(n),r=_.isArray(r)?r.length:_.toInt(r);var o=n-r;_.$one(t)[(s||o>=0?"remove":"add")+"Class"]("hide").html(s?n:o)},".downvotes":function(e,t){var n=this.model.get("upVotes"),r=this.model.get("downVotes"),i=this.grid.options&&this.grid.options.isBroadcastHistory,s=(this.activeSong||i)&&this.grid.options&&this.grid.options.isBroadcastOwner;n=_.isArray(n)?n.length:_.toInt(n),r=_.isArray(r)?r.length:_.toInt(r);var o=n-r;_.$one(t)[(s||o<0?"remove":"add")+"Class"]("hide").html(s?r:o)},".upvote-btn":function(e,t){_.$one(t).data("songId",this.model.get("SongID")),this.model.get("userVote")>0?_.$one(t).smartAddClass("btn-success"):_.$one(t).smartRemoveClass("btn-success")},".downvote-btn":function(e,t){_.$one(t).data("songId",this.model.get("SongID")),this.model.get("userVote")<0?_.$one(t).smartAddClass("btn-danger"):_.$one(t).smartRemoveClass("btn-danger")},".approve":function(e,t){this.model.get("approvalStatus")>0?_.$one(t).smartAddClass("btn-success"):_.$one(t).smartRemoveClass("btn-success")},".reject":function(e,t){this.model.get("approvalStatus")<0?_.$one(t).smartAddClass("btn-danger"):_.$one(t).smartRemoveClass("btn-danger")},".row-actions, .meta-inner, .song-link":function(e,t){this.model.get("isCallout")?_.$one(t).smartAddClass("hide"):_.$one(t).smartRemoveClass("hide")}},initialize:function(e){this.$el.data("songId",this.model.get("SongID")).data("calloutId",this.model.get("CalloutID")),this.activeSong?this.$el.addClass("is-playing"):this.$el.removeClass("is-playing"),this.model.idAttribute=="queueSongID"&&this.$el.data("queueSongId",this.model.id),this.broadcast=n.getCurrentBroadcast(),this.broadcast&&this.broadcast.on("change:vipUsers",this.updateRowActions,this),this._super.call(this,"initialize",e)},onDestroy:function(){this.broadcast&&this.broadcast.off(null,null,this)},updateRowActions:function(){var e=this.broadcast.isLoggedInUserOwner(),t=this.broadcast.checkPermissionsForUserID(n.getLoggedInUserID(),n.Models.Broadcast.VIP_PERM_SUGGESTIONS);e&&this.activeSong?(this.$(".approval-btns").addClass("hide"),this.$(".vote-btns").addClass("hide")):e||t&&!this.activeSong?(this.$(".approval-btns").removeClass("hide"),this.$(".vote-btns").addClass("hide")):(this.$(".approval-btns").addClass("hide"),this.$(".vote-btns").removeClass("hide"))},onDropDownGearClick:function(e){var t=$(e.currentTarget),r=this.model,s=r.id,o={activeSong:this.activeSong};this.grid&&this.grid.options&&this.grid.options.playContext&&(o.playContext=this.grid.options.playContext),r&&(i(e,r,o),n.trigger("guts:log","OLdropdownClick",s?{songID:r.get("SongID")}:null))},onAddClick:function(e){this.grid&&this.grid.onLibraryClick&&this.grid.onLibraryClick(e)},onArtistLinkClick:function(e){this.grid&&this.grid.onArtistLinkClick&&this.grid.onArtistLinkClick(e)},onAlbumLinkClick:function(e){this.grid&&this.grid.onAlbumLinkClick&&this.grid.onAlbumLinkClick(e)},onSongLinkClick:function(e){this.grid&&this.grid.onSongLinkClick&&this.grid.onSongLinkClick(e)},onSongPlay:function(e){this.grid&&this.grid.onSongLinkClick&&this.grid.onSongPlayClick(e);var t=$(e.currentTarget),r=t.data("songId");n.trigger("guts:log","OLPlayClick",{songID:r})},onSongShared:function(e){this.grid&&this.grid.onSongShareClick&&this.grid.onSongShareClick(e)},onSongFavorite:function(e){this.grid&&this.grid.onSongFavoriteClick&&this.grid.onSongFavoriteClick(e)},onSongUpVoteClick:function(e){var t=$(e.currentTarget),n=r.model.get("player").get("currentQueue"),i=n.get("currentBroadcast");if(!i)return;if(n.get("isBroadcasting"))return;this.activeSong?this.model.get("userVote")===1?i.voteActiveSong(0):i.voteActiveSong(1):this.model.get("userVote")?i.removeSuggestion(this.model):i.suggestSong(this.model)},onSongDownVoteClick:function(e){var t=$(e.currentTarget),n=r.model.get("player").get("currentQueue"),i=n.get("currentBroadcast");if(!i)return;if(n.get("isBroadcasting"))return;this.activeSong&&(this.model.get("userVote")===-1?i.voteActiveSong(0):i.voteActiveSong(-1))},onSongApproveClick:function(e){var t=_.eventToGUTSCoords(e);t.songID=this.model.get("SongID");if(!this.broadcast)return;if(this.broadcast.isLoggedInUserOwner()||this.broadcast.checkPermissionsForUserID(n.getLoggedInUserID(),n.Models.Broadcast.VIP_PERM_SUGGESTIONS))this.broadcast.approveSuggestedSong(this.model),n.trigger("guts:log","broadcastApproveSuggestionClicked",t)},onSongRejectClick:function(e){var t=_.eventToGUTSCoords(e);t.songID=this.model.get("SongID");if(!this.broadcast)return;if(this.broadcast.isLoggedInUserOwner()||this.broadcast.checkPermissionsForUserID(n.getLoggedInUserID(),n.Models.Broadcast.VIP_PERM_SUGGESTIONS))this.broadcast.rejectSuggestedSong(this.model),n.trigger("guts:log","broadcastRejectSuggestionClicked",t)}}),n.Views.Modules.SongCell=n.Views.Modules.Base.extend({className:"module module-cell song block grid-item",cacheKey:"SongCell",templateFile:"songCell",events:{"click .song-cell-dropdown":"onDropDownGearClick"},changeModelSelectors:{"&":function(e,t){_.$one(t).data("songId",this.model.get("SongID"))},".song-link":function(e,t){_.$one(t).data("songId",this.model.get("SongID"))},".play-or-add":function(e,t){_.$one(t).data("songId",this.model.get("SongID"))},".artist-link":function(e,t){_.$one(t).attr("href",this.model.toArtistUrl()).attr("title",this.model.get("ArtistName")).innerText(this.model.get("ArtistName"))},".title":function(e,t){_.$one(t).innerText(this.model.get("SongName"))},".btn.song-cell-dropdown":function(e,t){_.$one(t).data("songId",this.model.get("SongID"))},".img":function(e,t){_.$one(t).attr("src",this.model.getImageURL(120))}},initialize:function(e){this.$el.data({songId:this.model.get("SongID"),tooltipCacheKey:"songMini"}),e.grid&&e.grid.options&&(e.grid.options.smallGrid?this.$el.addClass("small"):e.grid.options.mediumGrid&&this.$el.addClass("medium")),this._super.call(this,"initialize",e)},onDropDownGearClick:function(e){var t=$(e.currentTarget),n=this.model,r={};return this.grid&&this.grid.options&&this.grid.options.playContext&&(r.playContext=this.grid.options.playContext),n&&i(e,n,r),!1}}),n.Views.Modules.SongProfileCard=n.Views.Modules.Base.extend({className:"module module-profile-card song grid-item",cacheKey:"SongProfileCard",templateFile:"songProfileCard",events:{"click .play-song-more-options":"onPlayMoreOptions"},changeModelSelectors:{"&":function(e,t){_.$one(t).data("songId",this.model.get("SongID"))},".song-link":function(e,t){_.$one(t).data("songId",this.model.get("SongID")).attr("title",this.model.get("SongName")).innerText(this.model.get("SongName"))},".byline":function(e,t){var n=this.model.getArtists(this.model.get("ArtistID")),r=this.model.getAlbums(this.model.get("AlbumID"));_.$one(t).html(_.getString("SONG_BYLINE",{artist:n?n.getAnchorTag():_.getString("UNKNOWN"),album:r?r.getAnchorTag():_.getString("UNKNOWN")}))},".btn.play":function(e,t){_.$one(t).data("songId",this.model.get("SongID"))},".btn.play-song-more-options":function(e,t){_.$one(t).data("songId",this.model.get("SongID"))},".img":function(e,t){_.$one(t).attr("src",this.model.getImageURL(120))}},initialize:function(){this.$el.data("songId",this.model.get("SongID")),this._super.apply(this,["initialize"].concat(_.toArray(arguments)))},onPlayMoreOptions:function(e){var t=$(e.currentTarget),r=n.Views.Pages.Base.prototype.getPlayMenu,i=new n.Models.PlayContext;return i.addStreamType(n.Models.PlayContext.TYPE_DEFAULT),t.jjmenu(e,r([this.model.id],{playContext:i}),null,{xposition:"left",yposition:"auto",show:"default",className:"contextmenu",keepState:t}),!1}}),n.Views.Modules.ArtistDashboardSongCell=n.Views.Modules.Base.extend({className:"module module-row song tall grid-item dashboard-list",cacheKey:"ArtistDashboardSongCell",templateFile:"artistDashboardSongCell",events:{},changeModelSelectors:{"&":function(e,t){_.$one(t).data("songId",this.model.get("SongID"))},".title":function(e,t){_.$one(t).text(this.model.get("SongName"))},".btn.play":function(e,t){_.$one(t).data("songId",this.model.get("SongID"))},".song-link":function(e,t){_.$one(t).data("songId",this.model.get("SongID"))},".img":function(e,t){_.$one(t).attr("src",this.model.getImageURL(40))},".column-stat":function(e,t){this.grid.options.selectedStatColumn===e?_.$one(t).addClass("selected"):_.$one(t).removeClass("selected"),_.$one(t).data("song-id",this.model.get("SongID"))},".column-stat .num":function(e,t){_.$one(t).text(this.model.get("statsForDashboardColumns")[e])},"a.album":function(e,t){_.$one(t).attr("href",this.model.toAlbumUrl()).innerText(this.model.get("AlbumName"))}},initialize:function(){this.$el.data("songId",this.model.get("SongID")),this._super.apply(this,["initialize"].concat(_.toArray(arguments))),this.grid&&this.grid.options.digest&&this.$el.addClass("digest")}}),n.Views.Modules.ArtistDashboardSongCellSmall=n.Views.Modules.Base.extend({className:"module module-row song artist-dash grid-item dashboard-list",cacheKey:"ArtistDashboardSongCellSmall",templateFile:"artistDashboardSongCellSmall",events:{"click .edit-song":"editBtn"},changeModelSelectors:{"&":function(e,t){_.$one(t).data("songId",this.model.get("SongID"))},".title":function(e,t){_.$one(t).text(this.model.get("SongName"))},".btn.play":function(e,t){_.$one(t).data("songId",this.model.get("SongID"))},".song-link":function(e,t){_.$one(t).data("songId",this.model.get("SongID"))},".column-stat":function(e,t){this.grid.options.selectedStatColumn===e?_.$one(t).addClass("selected"):_.$one(t).removeClass("selected"),_.$one(t).data("song-id",this.model.get("SongID"))},".column-stat .num":function(e,t){var n=this.model.get("statsForDashboardColumns");n?_.$one(t).text(n[e]):_.$one(t).text("")}},initialize:function(){this.$el.data("songId",this.model.get("SongID")),this._super.apply(this,["initialize"].concat(_.toArray(arguments))),this.grid&&this.grid.options.digest&&this.$el.addClass("digest")},editBtn:function(){if(!this.model.get("SongID")){n.trigger("notification:add",{type:"error",title:_.getString("EDIT_SONG_ERROR_TITLE"),description:_.getString("EDIT_SONG_ERROR_EDIT")});return}n.trigger("lightbox:open","editSongs",{songs:[this.model]})}}),n.Views.Modules.AlbumCellVertical=n.Views.Modules.Base.extend({className:"module module-cell album block grid-item",cacheKey:"AlbumCellVertical",templateFile:"albumCellVertical",events:{"click .album-cell-edit":"editAlbum","click .album-cell-dropdown":"onDropDownGearClick"},changeModelSelectors:{"&":function(e,t){_.$one(t).data("albumId",this.model.get("AlbumID"))},".play":function(e,t){_.$one(t).data("albumId",this.model.get("AlbumID"))},".album-link":function(e,t){_.$one(t).attr("href",this.model.toUrl())},".title":function(e,t){_.$one(t).innerText(this.model.get("AlbumName"))},".img":function(e,t){_.$one(t).attr("src",this.model.getImageURL(142))},".btn.album-cell-share":function(e,t){_.$one(t).data("albumId",this.model.get("AlbumID"))},".btn.album-cell-dropdown":function(e,t){_.$one(t).data("albumId",this.model.get("AlbumID"))},".album-cell-edit":function(e,t){n.isLoggedInUserOwnerOfArtist(this.model.get("ArtistID"))?_.$one(t).removeClass("hide"):_.$one(t).addClass("hide")}},initialize:function(e){this.$el.data("albumId",this.model.get("AlbumID")),e.grid&&e.grid.options&&(e.grid.options.smallGrid?this.$el.addClass("small"):e.grid.options.mediumGrid&&this.$el.addClass("medium"));var t=r.model.get("user");t.on("change:currentBroadcastID",this.onBroadcastChange,this),this._super.apply(this,["initialize"].concat(_.toArray(arguments)))},destroy:function(e){var t=r.model.get("user");t.off("change:currentBroadcastID",this.onBroadcastChange,this),this._super.call(this,"destroy",e),this.rendered=!1},onDropDownGearClick:function(e){return this.model&&i(e,this.model,{}),!1},onBroadcastChange:function(){var e=this.$(".actions.primary").first(),t=r.model.get("user").get("currentBroadcastID");t?e.addClass("hide"):e.removeClass("hide")},editAlbum:function(e){return n.trigger("lightbox:open","editAlbum",{album:this.model}),!1}}),n.Views.Modules.AlbumRowTall=n.Views.Modules.Base.extend({className:"module module-row tall album grid-item",cacheKey:"AlbumRowTall",templateFile:"albumRowTall",changeModelSelectors:{"&":function(e,t){_.$one(t).data("albumId",this.model.get("AlbumID"))},".album-link":function(e,t){_.$one(t).attr("href",this.model.toUrl())},".title":function(e,t){_.$one(t).innerText(this.model.get("AlbumName"))},".img":function(e,t){_.$one(t).attr("src",this.model.getImageURL(40))},".artist-link":function(e,t){_.$one(t).innerText(this.model.get("ArtistName")).attr("href",this.model.toArtistUrl())}},initialize:function(){this.$el.data("albumId",this.model.get("AlbumID")),this._super.apply(this,["initialize"].concat(_.toArray(arguments)))}}),n.Views.Modules.ArtistAlbumRow=n.Views.Modules.Base.extend({className:"module module-nested artist-album grid-item",cacheKey:"ArtistAlbumRow",templateFile:"artistAlbumRow",events:{"click .album-cell-edit":"editAlbum","click .album-cell-dropdown":"onDropDownGearClick","contextmenu .context-menu-item":"onContextMenu"},changeModelSelectors:{"&":function(e,t){var r=_.$one(t).data("albumId",this.model.id),i=this.constructor.estimateSize(this.model,this.grid,!0);this.size!==i&&this.tmpSize!==i&&(r.outerHeight(i),this.tmpSize=i);if(!this.songGrid)this.rendered&&this.makeChildGrid();else{var s=this.model.get("songs");this.songGrid.options.contextAlbumID=this.model.get("AlbumID"),s&&this.songGrid.collection.reset(s.models),this.songGrid.options.playContext=new n.Models.PlayContext(this.model)}},".album-link":function(e,t){_.$one(t).attr("href",this.model.toUrl())},".album-title":function(e,t){_.$one(t).innerText(this.model.get("AlbumName"))},".album-year":function(e,t){_.$one(t).innerText(this.model.get("Year"))},".album-type":function(e,t){var n=this.model.getReleaseTypeLocale();_.$one(t).attr("data-translate-text",n).innerText(_.getString(n))},".album-img":function(e,t){_.$one(t).attr("src",this.model.getImageURL(142))},".play-entire-album":function(e,t){_.$one(t).data("albumId",this.model.id)},".album-cell-edit":function(e,t){n.isLoggedInUserOwnerOfArtist(this.model.get("ArtistID"))?_.$one(t).removeClass("hide"):_.$one(t).addClass("hide")}},initialize:function(e){this.$el.data("albumId",this.model.get("AlbumID")),this.size=this.constructor.estimateSize(this.model),this.$el.outerHeight(this.size);var t=r.model.get("user");t.on("change:currentBroadcastID",this.onBroadcastChange,this),this._super.call(this,"initialize",e)},destroy:function(e){var t=r.model.get("user");t.off("change:currentBroadcastID",this.onBroadcastChange,this),this.songGrid&&this.songGrid.off("resized",null,this),this._super.call(this,"destroy",e),this.rendered=!1},completeRender:function(e,t){this._super.call(this,"completeRender",e,t),this.rendered=!0,_.defer(_.bind(this.makeChildGrid,this))},getModelsBetweenPoints:function(e,t,n,r){var i=this.grid.collection.indexOf(e),s=this.grid.collection.indexOf(n),o=[],u,a;if(i===-1||s===-1)return o;var f=e.get("songs"),l=f.indexOf(t),c=n.get("songs"),h=c.indexOf(r);u=Math.min(i,s),a=Math.max(i,s);if(u===a){var p=Math.min(l,h),d=Math.max(l,h);o.push.apply(o,f.slice(p,d+1))}else i===u?(o.push.apply(o,f.last(f.length-l)),o.push.apply(o,c.first(h+1))):(o.push.apply(o,c.last(c.length-h)),o.push.apply(o,f.first(l+1)));if(u>-1&&u+1<a){var v=this.grid.collection.slice(u+1,a);_.each(v,function(e){o.push.apply(o,e.get("songs").models)})}return o},makeChildGrid:function(){this.songGrid&&(this.songGrid.selectedItems.off("add remove reset sort",null,this),this.songGrid.off("resized",null,this),this.songGrid.destroy(!1));var e=this.model.get("songs"),t=new n.Models.Collections.Songs(e?e.models:null),r=this.model.id;t.comparator=function(e){return e.attributes.TrackNumsByAlbumID[r]||""},t.sort();var i=n.Views.SongGrid,s=this.grid.options.childGridAlt;s&&(i=s),this.songGrid=new i({el:this.$el.find(".song-grid")[0],collection:t,columns:n.Views.SongGrid.columnsNoAlbumArtist,excludeCells:["artist","album"],playContext:new n.Models.PlayContext(this.model),header:!1,dontDeselectFor:[this.grid.$el.parent()[0]],parentGrid:this.grid,parentModel:this.model,addStreamType:this.grid.options.addStreamType,getModelsBetweenPoints:_.bind(this.getModelsBetweenPoints,this),contextAlbumID:this.model.id}),this.songGrid.on("resized",this.childResized,this),this.songGrid.render(),this.childViews=[this.songGrid]},childResized:function(){var e=Math.max(142,this.songGrid.$el.height()+30)+15;this.size!==e&&(this.size=e,this.tmpSize!=e&&(this.$el.outerHeight(e),this.tmpSize=null),this.trigger("resized"))},editAlbum:function(e){return n.trigger("lightbox:open","editAlbum",{album:this.model}),!1},onDropDownGearClick:function(e){return i(e,this.model,{}),!1},onContextMenu:function(e){var t={onMouse:!0,shouldLog:!0};return i(e,this.model,t),!1},onBroadcastChange:function(){var e=this.$(".actions.primary").first(),t=r.model.get("user").get("currentBroadcastID");t?e.addClass("hide"):e.removeClass("hide")}},{estimateSize:function(e,t,n){var r=_.isUndefined(n)||n?15:0,i=e.get("songs");return Math.max(142,i?i.length*31+30:0)+15}}),n.Views.Modules.AlbumProfileCard=n.Views.Modules.Base.extend({className:"module module-profile-card album grid-item",cacheKey:"AlbumProfileCard",templateFile:"albumProfileCard",changeModelSelectors:{"&":function(e,t){this.pageNameData=this.model.get("pageNameData")||{},_.$one(t).data("album",this.model)},".album-name a":function(e,t){_.$one(t).attr("href",this.model.toUrl()).innerText(this.model.get("AlbumName"))},".btn.favorite":function(e,t){this.model.get("isFavorite")?_.$one(t).addClass("btn-success"):_.$one(t).removeClass("btn-success")},".btn.favorite .icon":function(e,t){this.model.get("isFavorite")?_.$one(t).removeClass("icon-plus-gray").addClass("icon-check-white-active"):_.$one(t).removeClass("icon-check-white-active").addClass("icon-plus-gray")},".btn.favorite .favorite-label":function(e,t){this.changeFavoriteLabel(e,t)},".tags":function(e,t){this.model.get("Tags")&&this.fetchTemplate("/shared/genreTags").done(_.bind(function(e){var n=_.clone(this.options);n.tags=this.model.get("Tags"),_.$one(t).html(this.renderTemplate(e,n))},this))}},initialize:function(e){this.$el.data("album",this.model).attr("id","album-"+this.model.get("AlbumID")),this._super.apply(this,["initialize"].concat(_.toArray(arguments)))},changeFavoriteLabel:function(e,t){this.model.get("isFavorite")?_.$one(t).attr("data-translate-text","FOLLOWING").text(_.getString("FOLLOWING")):_.$one(t).attr("data-translate-text","FOLLOW").text(_.getString("FOLLOW"))}}),n.Views.Modules.PromotionAlbumCell=n.Views.Modules.Base.extend({className:"module module-cell promotionAlbum song grid-item",cacheKey:"PromotionAlbumCell",templateFile:"promotionAlbumCell",events:{},changeModelSelectors:{"&":function(e,t){_.$one(t).data("albumId",this.model.get("AlbumID"))},".album-link":function(e,t){_.$one(t).data("albumId",this.model.get("AlbumID"))},".artist-link":function(e,t){_.$one(t).attr("href",this.model.get("artistURL")).innerText(this.model.get("ArtistName"))},".title":function(e,t){_.$one(t).innerText(this.model.get("AlbumName"))},".img":function(e,t){_.$one(t).attr("src",this.model.get("albumImage"))}},initialize:function(){this._super.apply(this,["initialize"].concat(_.toArray(arguments)))}}),n.Views.Modules.UserRowTall=n.Views.Modules.Base.extend({className:"module module-row user tall grid-item",cacheKey:"UserRowTall",templateFile:"userRowTall",changeModelSelectors:{"&":function(e,t){this.isArtist=this.artistBroadcast&&this.artistBroadcast.get("ArtistID")===this.model.get("contextArtistID");if(this.isArtist){var n=this.artistBroadcast.getOwner();_.$one(t).data({artistId:n.get("ArtistID"),userId:null}),this.useModel=n||this.model}else _.$one(t).data({artistId:null,userId:this.model.get("UserID")}),this.useModel=this.model},".title":function(e,t){this.isArtist?_.$one(t).attr("href",this.useModel.toUrl()).innerText(this.useModel.get("ArtistName")).data({artistId:this.useModel.get("ArtistID"),userId:null}):_.$one(t).attr("href",this.useModel.toUrl()).innerText(this.useModel.get("Name")).data({artistId:null,userId:this.useModel.get("UserID")})},".img":function(e,t){_.$one(t).attr("src",this.useModel.getImageURL(40))},".img-container":function(e,t){_.$one(t).attr("href",this.useModel.toUrl())},".btn.favorite":function(e,t){this.isArtist?_.$one(t).data({artistId:this.useModel.get("ArtistID"),userId:null}):_.$one(t).data({artistId:null,userId:this.useModel.get("UserID")}),_.$one(t)[this.useModel.get("isFavorite")?"addClass":"removeClass"]("btn-success")},".btn.favorite .icon":function(e,t){this.useModel.get("isFavorite")?_.$one(t).removeClass("icon-plus-gray").addClass("icon-check-white-active"):_.$one(t).removeClass("icon-check-white-active").addClass("icon-plus-gray")},".btn.favorite .favorite-label":function(e,t){this.changeFavoriteLabel(e,t)},".row-actions.secondary":function(e,t){_.$one(t)[this.model.get("UserID")!=n.getLoggedInUserID()?"removeClass":"addClass"]("hide")},".user-broadcast-options":function(e,t){this.updateBroadcastBtn()}},events:{"click .user-broadcast-options":"onBroadcastOptionsClick","click .vip-broadcast-options":"onVIPOptionsClick","click .bc-give-ownership":"onGiveOwnershipClick"},initialize:function(e){e&&e.endBroadcast&&(this.endBroadcastOnTransfer=e.endBroadcast);var t;this.broadcast=this.options.grid&&this.options.grid.options.broadcast,this.broadcast&&this.broadcast.get("ArtistID")&&(this.artistBroadcast=this.broadcast,t=this.artistBroadcast.getOwner()),this.useModel=t||this.model,this.changeModelSelectors["&"].call(this,0,this.el),this._super.call(this,"initialize",e);if(this.artistBroadcast&&this.artistBroadcast.get("ArtistID")===this.model.get("contextArtistID")){var n=this,r=function(){n.off("rendered",r),_.defer(function(){n.handleModelChange()})};this.on("rendered",r)}this.broadcast&&this.on("rendered",_.bind(function(){this.updateBroadcastBtn(),this.broadcast.on("change:vipUsers",this.updateBroadcastBtn,this)},this))},updateBroadcastBtn:function(){var e=this.$(".btn.user-broadcast-options"),t=this.options.grid,r=this.useModel&&this.useModel.get("UserID"),i=n.getLoggedInUserID();t&&(t.options.endBroadcast||!t.options.showBroadcastOptions)?e.addClass("hide"):r===i||this.useModel===this.broadcast.getOwner()?e.addClass("hide"):this.broadcast.isLoggedInUserOwner()?e.removeClass("hide"):!this.broadcast.isUserVIP(r)&&this.broadcast.checkPermissionsForUserID(i,n.Models.Broadcast.VIP_PERM_CHAT_MODERATE)?e.removeClass("hide"):e.addClass("hide")},onDestroy:function(){this.broadcast&&this.broadcast.off(null,null,this)},addModelListeners:function(){this.useModel&&this.useModel.on("change",this.handleModelChange,this),this.grid&&this.grid.cid&&(this.model.on(this.grid.cid+":select",this.select,this),this.model.on(this.grid.cid+":deselect",this.deselect,this)),this.model.on("change",this.handleModelChange,this)},removeModelListeners:function(){this.useModel&&this.useModel.off(null,null,this),this.model.off(null,null,this)},changeFavoriteLabel:function(e,t){var n=this.useModel||this.model;n.get("isFavorite")?_.$one(t).attr("data-translate-text","FOLLOWING").text(_.getString("FOLLOWING")):_.$one(t).attr("data-translate-text","FOLLOW").text(_.getString("FOLLOW"))},onBroadcastOptionsClick:function(e){if(this.isArtist)return;var t=$(e.currentTarget),n=this.useModel,i=r.model.get("player").get("currentQueue"),s=i?i.get("currentBroadcast"):null;s&&t.jjmenu(e,n.getBroadcastOptionMenu(s,this.endBroadcastOnTransfer),null,{xposition:"left",yposition:"auto",show:"default",keepState:t})},onVIPOptionsClick:function(e){if(this.isArtist)return;var t=$(e.currentTarget),n=this.useModel,i=r.model.get("player").get("currentQueue"),s=i?i.get("currentBroadcast"):null,o=[];s&&(o=o.concat(n.getVIPPermissionsMenu(s)),o.push({customClass:"separator"}),o=o.concat(n.getBroadcastOptionMenu(s,this.endBroadcastOnTransfer)),t.jjmenu(e,o,null,{className:"broadcast-vip-menu",xposition:"left",yposition:"auto",show:"default",keepState:t}))},onGiveOwnershipClick:function(){function t(){n.trigger("lightbox:close","broadcastListeners")}if(this.isArtist)return;var e=this.options.grid.options.broadcast;n.trigger("lightbox:open","broadcastTransferOwnership",{user:this.useModel,broadcast:e,endBroadcast:this.endBroadcastOnTransfer,onSuccess:t})}}),n.Views.Modules.MutualFriendRow=n.Views.Modules.Base.extend({className:"module module-row user mutual-friend tall",cacheKey:"MutualFriendRow",templateFile:"mutualFriendRow",changeModelSelectors:{"&":function(e,t){_.$one(t).data("userId",this.model.get("UserID"))},".img-container":function(e,t){_.$one(t).attr("href",this.model.toUrl())},".img":function(e,t){_.$one(t).attr({src:this.model.getImageURL(40),alt:this.model.escape("Name")})},".metadata":function(e,t){this.model.get("Location")?_.$one(t).addClass("has-byline"):_.$one(t).removeClass("has-byline")},".title":function(e,t){_.$one(t).attr("href",this.model.toUrl()).data("userId",this.model.get("UserID")).text(this.model.get("Name"))},".meta-inner":function(e,t){_.$one(t).text(_.getString("USER_BYLINE",{location:this.model.get("Location")}))}}}),n.Views.Modules.VIPUser=n.Views.Modules.UserRowTall.extend({className:"module module-row user vip tall grid-item"}),n.Views.Modules.SidebarUser=n.Views.Modules.Base.extend({className:"sidebar-user grid-item",cacheKey:"SidebarUser",templateFile:"sidebarUser",changeModelSelectors:{"&":function(e,t){this.isArtist=this.model.id<-100,this.correctModel=this.isArtist?this.model.get("artist"):this.model;var r=this.correctModel.attributes.currentBroadcastID,i={userId:null,artistId:null,broadcastId:r},s=["now-playing","user-offline","user-online","broadcast-owner","broadcast-listener","show-broadcast-tooltip","show-user-tooltip","tall"],o=n.Views.Modules.SidebarUser.getClassesToAdd(this.correctModel,this,this.options.grid);this.isArtist?i.artistId=this.correctModel.id:i.userId=this.correctModel.id,_.$one(t).removeClass(s.join(" ")).addClass(o.join(" ")).data(i),n.Views.Modules.SidebarUser.isModelOnline(this.correctModel)?this.nowPlaying=this.correctModel.attributes.nowPlayingSong:this.nowPlaying=null,this.trigger("resized")},".song-link":function(e,t){this.nowPlaying&&_.$one(t).data("songId",this.nowPlaying.get("SongID"))},".user-song-name":function(e,t){this.nowPlaying&&_.$one(t).innerText(this.nowPlaying.get("SongName"))},".user-artist-name":function(e,t){this.nowPlaying&&_.$one(t).innerText(this.nowPlaying.get("ArtistName"))},".play":function(e,t){this.nowPlaying&&_.$one(t).data("songId",this.nowPlaying.get("SongID"))},".user-name":function(e,t){this.correctModel.attributes.isOwnerOfCurrentBroadcast&&this.nowPlaying?_.$one(t).innerText(this.correctModel.get("currentBroadcastName")):_.$one(t).innerText(this.correctModel.get("Name")||this.correctModel.get("ArtistName")||"")},".title":function(e,t){this.correctModel.attributes.isOwnerOfCurrentBroadcast&&this.nowPlaying?_.$one(t).attr("href",this.correctModel.toUrl("broadcast")).data("broadcastId",this.correctModel.attributes.currentBroadcastID):_.$one(t).attr("href",this.correctModel.toUrl()).data("userId",this.correctModel.id)},".user-img-link":function(e,t){_.$one(t).attr("href",this.correctModel.toUrl()).data("userId",this.correctModel.id)},".user-img":function(e,t){var r,i={artistId:null,userId:null};this.correctModel.attributes.isOwnerOfCurrentBroadcast&&this.correctModel.attributes.currentBroadcastPicture?r=n.Models.Broadcast.getBroadcastImageURL(this.correctModel.attributes.currentBroadcastPicture,30):r=this.correctModel.getImageURL(30),this.isArtist?i.artistId=this.correctModel.id:i.userId=this.correctModel.id,_.$one(t).attr("src",r).data(i)},".suggest-song":function(e,t){_.$one(t)[this.nowPlaying?"addClass":"removeClass"]("hide")},".icon.station":function(e,t){var n=this.correctModel.attributes.isOwnerOfCurrentBroadcast&&this.nowPlaying?"removeClass":"addClass";_.$one(t)[n]("hide")},".bc-user-link":function(e,t){var n={artistId:null,userId:null};this.isArtist?n.artistId=this.correctModel.id:n.userId=this.correctModel.id,_.$one(t).attr("href",this.correctModel.toUrl()).data(n)},".bc-user-name":function(e,t){_.$one(t).innerText(this.correctModel.get("Name")||this.correctModel.get("ArtistName")||"")},".bc-invite":function(e,t){var n=r.model.get("user").attributes.currentBroadcastID,i=this.correctModel.attributes.currentBroadcastID,s=this.correctModel.attributes.canBroadcastInvite;if(!this.correctModel.attributes.isFollower){_.$one(t).addClass("hide");return}_.$one(t).removeClass("hide"),s?(_.$one(t).removeClass("disabled present"),_.$one(t).attr("title","Invite to Broadcast")):!s&&n===i?_.$one(t).addClass("disabled present"):_.$one(t).addClass("disabled").removeClass("present");var o=i&&!this.correctModel.attributes.isOwnerOfCurrentBroadcast;o?_.$one(t).addClass("btn-small"):_.$one(t).removeClass("btn-small");var u={artistId:null,userId:null};this.isArtist?u.artistId=this.correctModel.id:u.userId=this.correctModel.id,_.$one(t).data(u)}},initialize:function(e){this.$el.data({tooltipCacheKey:"sidebarUser"}),this._super.call(this,"initialize",e),this.changeModelSelectors["&"].call(this,0,this.el)},acceptDrop:function(e){if(e.draggedItemsType=="song"&&e.draggedItems[0].get("isCallout")||!(this.correctModel instanceof n.Models.User))return!1;var t;return e.draggedItemsType==="song"&&e.draggedItems[0].hasOwnProperty("_wrapped")?t=e.draggedItems[0]._wrapped:t=e.draggedItems[0],n.trigger("lightbox:open","share",{service:"grooveshark",serviceLock:!0,toUserID:this.model.get("UserID"),type:e.draggedItemsType,model:t}),!0}},{getClassesToAdd:function(e,t,r){var i=e.attributes.nowPlayingSong,s=e.attributes.currentBroadcastID,o=e.attributes.isOwnerOfCurrentBroadcast,u=s&&!o,a=[],f=!0;if(e.attributes.currentBroadcastID&&e.attributes.currentBroadcastOwner){var l=e.attributes.currentBroadcastOwner;l&&(i=l.attributes.nowPlayingSong,l.attributes.currentBroadcastID!=s&&(u=!1))}return n.Views.Modules.SidebarUser.isModelOnline(e)?a.push("user-online"):a.push("user-offline"),i&&(o?(f=!1,a.push("broadcast-owner","show-broadcast-tooltip","tall")):u?a.push("broadcast-listener"):a.push("now-playing")),f&&a.push("show-user-tooltip"),a},isModelOnline:function(e){return e.attributes.onlineStatus||e instanceof n.Models.Artist&&e.attributes.isOwnerOfCurrentBroadcast},estimateSize:function(e,t){var r=n.Views.Modules.SidebarUser.getClassesToAdd(e,null,t);return _.indexOf(r,"broadcast-listener")!==-1?29:_.indexOf(r,"broadcast-owner")!==-1?61:46}}),n.Views.Modules.SuggestedUserRowTall=n.Views.Modules.UserRowTall.extend({className:"module module-row user tall suggested",cacheKey:"SuggestedUserRowTall",templateFile:"suggestedUserRowTall",events:{"click .explanation a":"clickExplanation"},changeModelSelectors:{"&":function(e,t){_.$one(t).data("userId",this.model.get("UserID"))},".img-container":function(e,t){var n=_.$one(t);n.attr("href",this.model.toUrl()),n.data("userId",this.model.get("UserID"))},".img":function(e,t){_.$one(t).attr("src",this.model.getImageURL(70))},".title":function(e,t){var n=_.$one(t);n.attr("href",this.model.toUrl()),n.innerText(this.model.get("Name")),n.data("userId",this.model.get("UserID"))},".favorite":function(e,t){var n=_.$one(t),r=n.find(".favorite-label"),i=n.find(".icon");n.data("userId",this.model.get("UserID")),this.model.get("isFavorite")?(n.addClass("btn-success"),r.attr("data-translate-text","FOLLOWING").text(_.getString("FOLLOWING")),i.removeClass("plus icon-plus-small-gray-flat").addClass("check icon-check-white-flat")):(n.removeClass("btn-success"),r.attr("data-translate-text","FOLLOW").text(_.getString("FOLLOW")),i.removeClass("check icon-check-white-flat").addClass("plus icon-plus-small-gray-flat"))},".explanation":function(e,t){var n=this.model.get("SimilarFriendsCount");_.$one(t).html(_.getStringPluralized("YOU_HAVE_MUTUAL_FRIEND","YOU_HAVE_MUTUAL_FRIENDS",n,{num:n}))},".remove-suggestion":function(e,t){_.$one(t).data("userId",this.model.get("UserID"))}},initialize:function(){this.$el.data("userId",this.model.get("UserID")),this._super.apply(this,["initialize"].concat(_.toArray(arguments)))},clickExplanation:function(e){n.trigger("lightbox:open","mutualFriends",{userID:this.model.get("UserID"),showHeaderCount:!1})}}),n.Views.Modules.ArtistDashboardTopFanCell=n.Views.Modules.Base.extend({className:"module module-row user tall grid-item dashboard-list digest",cacheKey:"ArtistDashboardTopFanCell",templateFile:"artistDashboardTopFanCell",events:{},changeModelSelectors:{"&":function(e,t){_.$one(t).data("userId",this.model.get("UserID"))},".user-name":function(e,t){_.$one(t).attr("href",this.model.toUrl()).innerText(this.model.get("Name"))},".img":function(e,t){_.$one(t).attr("src",this.model.getImageURL(40))}},initialize:function(){this.$el.data("userId",this.model.get("UserID")),this._super.apply(this,["initialize"].concat(_.toArray(arguments)))}}),n.Views.Modules.InviteUserCell=n.Views.Modules.Base.extend({className:"module module-cell invite-user grid-item",cacheKey:"InviteUserCell",templateFile:"inviteUser",events:{},changeModelSelectors:{"&":function(e,t){_.$one(t).data("userId",this.model.get("UserID")),this.update()},".title":function(e,t){_.$one(t).attr("href",this.model.toUrl()).innerText(this.model.get("Name"))},".img":function(e,t){_.$one(t).attr("src",this.model.getImageURL(30))}},initialize:function(){this.$el.data("userId",this.model.get("UserID")),this._super.apply(this,["initialize"].concat(_.toArray(arguments))),this.update()},update:function(){var e=this.model.get("canBroadcastInviteEmail");this.model.get("canBroadcastInviteEmail")?(this.$el.removeClass("disabled"),this.disabled=!1):(this.$el.addClass("disabled"),this.disabled=!0)}}),n.Views.Modules.ShareUserCell=n.Views.Modules.InviteUserCell.extend({update:function(){}}),n.Views.Modules.ArtistCellVertical=n.Views.Modules.Base.extend({className:"module module-cell artist grid-item",cacheKey:"ArtistCellVertical",templateFile:"artistCellVertical",events:{"click .artist-cell-dropdown":"onDropDownGearClick"},changeModelSelectors:{"&":function(e,t){_.$one(t).data("artistId",this.model.get("ArtistID"))},".artist-link":function(e,t){_.$one(t).attr("href",this.model.toUrl())},".title":function(e,t){_.$one(t).innerText(this.model.get("ArtistName"))},".img":function(e,t){_.$one(t).attr("src",this.model.getImageURL(120))},".btn.artist-cell-follow":function(e,t){_.$one(t).data("artistId",this.model.get("ArtistID"))},".btn.artist-cell-dropdown":function(e,t){_.$one(t).data("artistId",this.model.get("ArtistID"))},".btn.artist-cell-share":function(e,t){_.$one(t).data("artistId",this.model.get("ArtistID"))},".btn.favorite .icon":function(e,t){this.model.get("isFavorite")?_.$one(t).removeClass("icon-plus-gray").addClass("icon-check-white-active"):_.$one(t).removeClass("icon-check-white-active").addClass("icon-plus-gray")}},initialize:function(e){this.$el.data("artist",this.model),this._super.apply(this,["initialize"].concat(_.toArray(arguments)))},onDropDownGearClick:function(e){var t=$(e.currentTarget),n=this.model;return!1}}),n.Views.Modules.ArtistRowMini=n.Views.Modules.Base.extend({className:"module module-row mini artist grid-item",cacheKey:"ArtistRowMini",templateFile:"artistRowMini",changeModelSelectors:{"&":function(e,t){_.$one(t).data("artistId",this.model.get("ArtistID"))},".artist-link":function(e,t){_.$one(t).attr("href",this.model.toUrl()).innerText(this.model.get("ArtistName"))},".btn.favorite":function(e,t){this.model.get("isFavorite")?_.$one(t).addClass("btn-success"):_.$one(t).removeClass("btn-success"),_.$one(t).data("artistId",this.model.get("ArtistID"))},".btn.favorite .icon":function(e,t){this.model.get("isFavorite")?_.$one(t).removeClass("plus icon-plus-gray").addClass("check icon-check-white-active"):_.$one(t).removeClass("check icon-check-white-active").addClass("plus icon-plus-gray")}},initialize:function(e){this.$el.data("artist",this.model),this._super.apply(this,["initialize"].concat(_.toArray(arguments)))}}),n.Views.Modules.ArtistRowTall=n.Views.Modules.Base.extend({className:"module module-row tall artist grid-item",cacheKey:"ArtistRowTall",templateFile:"artistRowTall",changeModelSelectors:{"&":function(e,t){_.$one(t).data("artistId",this.model.get("ArtistID"))},".artist-link":function(e,t){_.$one(t).attr("href",this.model.toUrl())},".btn.favorite":function(e,t){this.model.get("isFavorite")?_.$one(t).addClass("btn-success"):_.$one(t).removeClass("btn-success"),_.$one(t).data("artistId",this.model.get("ArtistID"))},".btn.favorite .icon":function(e,t){this.model.get("isFavorite")?_.$one(t).removeClass("icon-plus-gray").addClass("icon-check-white-active"):_.$one(t).removeClass("icon-check-white-active").addClass("icon-plus-gray")},".btn.favorite .favorite-label":function(e,t){this.changeFavoriteLabel(e,t)},".title":function(e,t){_.$one(t).innerText(this.model.get("ArtistName"))},".img":function(e,t){_.$one(t).attr("src",this.model.getImageURL(40))}},initialize:function(e){this.$el.data("artist",this.model),this._super.apply(this,["initialize"].concat(_.toArray(arguments)))},changeFavoriteLabel:function(e,t){this.model.get("isFavorite")?_.$one(t).attr("data-translate-text","FOLLOWING").text(_.getString("FOLLOWING")):_.$one(t).attr("data-translate-text","FOLLOW").text(_.getString("FOLLOW"))}}),n.Views.Modules.ArtistProfileCard=n.Views.Modules.Base.extend({className:"module module-profile-card artist grid-item",cacheKey:"ArtistProfileCard",templateFile:"artistProfileCard",changeModelSelectors:{"&":function(e,t){this.pageNameData=this.model.get("pageNameData")||{},_.$one(t).data("artist",this.model)},".img":function(e,t){_.$one(t).attr("src",this.model.getImageURL(120))},".artist-name a":function(e,t){_.$one(t).attr("href",this.model.toUrl()).innerText(this.model.get("ArtistName"))},".btn.favorite":function(e,t){this.model.get("isFavorite")?_.$one(t).addClass("btn-success"):_.$one(t).removeClass("btn-success")},".btn.favorite .icon":function(e,t){this.model.get("isFavorite")?_.$one(t).removeClass("icon-plus-gray").addClass("icon-check-white-active"):_.$one(t).removeClass("icon-check-white-active").addClass("icon-plus-gray")},".btn.favorite .favorite-label":function(e,t){this.changeFavoriteLabel(e,t)},".metadata":function(e,t){_.$one(t)[_.isUndefined(this.pageNameData.FavoriteCount)?"addClass":"removeClass"]("hide")},".metadata-link":function(e,t){_.$one(t).attr("href",this.model.toUrl("followers"))},".followers-num":function(e,t){_.$one(t).text(this.pageNameData.FavoriteCount||"-")},".description":function(e,t){var n=this.pageNameData.Bio||"",r=_.$one(t),i='<a class="description-more" data-translate-text="MORE_ELLIPSIS" data-artist-id="'+this.model.get("ArtistID")+'">'+_.getString("MORE_ELLIPSIS")+"</a>"},".tags":function(e,t){this.model.get("Tags")&&this.fetchTemplate("/shared/genreTags").done(_.bind(function(e){var n=_.clone(this.options);n.tags=this.model.get("Tags"),_.$one(t).html(this.renderTemplate(e,n))},this))}},initialize:function(e){this.$el.data("artist",this.model).attr("id","artist-"+this.model.get("ArtistID")),this._super.apply(this,["initialize"].concat(_.toArray(arguments)))},changeFavoriteLabel:function(e,t){this.model.get("isFavorite")?_.$one(t).attr("data-translate-text","FOLLOWING").text(_.getString("FOLLOWING")):_.$one(t).attr("data-translate-text","FOLLOW").text(_.getString("FOLLOW"))}}),n.Views.Modules.PlaylistCell=n.Views.Modules.Base.extend({className:"module module-cell playlist grid-item",cacheKey:"PlaylistCell",templateFile:"playlistCell",changeModelSelectors:{"&":function(e,t){_.$one(t).data("playlist",this.model)},".btn.play":function(e,t){_.$one(t).data("playlistId",this.model.get("PlaylistID"))},".title":function(e,t){_.$one(t).attr("href",this.model.toUrl()).innerText(this.model.get("PlaylistName"))},".byline a":function(e,t){_.$one(t).attr("href",this.model.toUserUrl()).innerText(this.model.get("UserName"))},".img":function(e,t){_.$one(t).attr("src",this.model.getImageURL(200))},"a.img-container":function(e,t){_.$one(t).attr("href",this.model.toUrl())}},initialize:function(e){this.$el.data("playlist",this.model),this._super.apply(this,["initialize"].concat(_.toArray(arguments)))},acceptDrop:function(e){return n.Models.Playlist.acceptDrop(this.model,e)}}),n.Views.Modules.PlaylistCellSmall=n.Views.Modules.Base.extend({className:"module module-cell playlist small grid-item",cacheKey:"PlaylistCellSmall",templateFile:"playlistCellSmall",changeModelSelectors:{"&":function(e,t){_.$one(t).data("playlist",this.model)},".btn.play":function(e,t){_.$one(t).data("playlistId",this.model.get("PlaylistID"))},".title":function(e,t){_.$one(t).attr("href",this.model.toUrl()).innerText(this.model.get("PlaylistName"))},".user-link":function(e,t){_.$one(t).data("userId",this.model.get("UserID")).innerText(this.model.get("UserName"))},".img":function(e,t){_.$one(t).attr("src",this.model.getImageURL(200))},"a.img-container":function(e,t){_.$one(t).attr("href",this.model.toUrl())}},initialize:function(e){this.$el.data("playlist",this.model),this._super.apply(this,["initialize"].concat(_.toArray(arguments)))},acceptDrop:function(e){return n.Models.Playlist.acceptDrop(this.model,e)}}),n.Views.Modules.SidebarPlaylist=n.Views.Modules.Base.extend({className:"module sidebar-playlist grid-item sidebar-row",cacheKey:"SidebarPlaylist",templateFile:"sidebarPlaylist",changeModelSelectors:{"&":function(e,t){_.$one(t).data("playlist",this.model)},".inner":function(e,t){_.$one(t).data("playlistId",this.model.get("PlaylistID"))},".btn.play":function(e,t){_.$one(t).data("playlistId",this.model.get("PlaylistID"))},".playlist-link":function(e,t){_.$one(t).attr("href",this.model.toUrl())},".name":function(e,t){_.$one(t).innerText(this.model.get("PlaylistName"))}},events:{contextmenu:"handleContextMenuClick"},initialize:function(e){this.$el.data("playlist",this.model),this._super.call(this,"initialize",e)},acceptDrop:function(e){return n.Models.Playlist.acceptDrop(this.model,e)},handleContextMenuClick:function(e){e.preventDefault();var t=$(e.currentTarget),n={onMouse:!0};i(e,this.model,n),t.addClass("active-context")}}),n.Views.Modules.PlaylistRowTall=n.Views.Modules.Base.extend({className:"module module-row tall playlist grid-item",cacheKey:"PlaylistRowTall",templateFile:"playlistRowTall",changeModelSelectors:{"&":function(e,t){_.$one(t).data("artistId",this.model.get("PlaylistID"))},".playlist-link":function(e,t){_.$one(t).attr("href",this.model.toUrl())},".title":function(e,t){_.$one(t).innerText(this.model.get("PlaylistName"))},".meta-text":function(e,t){_.$one(t).innerText(this.model.get("UserName")),_.$one(t).attr("href",this.model.toUserUrl())},".img":function(e,t){_.$one(t).attr("src",this.model.getImageURL(70))},".btn.favorite":function(e,t){this.model.get("isFavorite")?_.$one(t).addClass("btn-success"):_.$one(t).removeClass("btn-success")},".btn.favorite .icon":function(e,t){this.model.get("isFavorite")?_.$one(t).removeClass("icon-plus-gray").addClass("icon-check-white-active"):_.$one(t).removeClass("icon-check-white-active").addClass("icon-plus-gray")},".btn.favorite .favorite-label":function(e,t){this.changeFavoriteLabel(e,t)}},initialize:function(e){this.$el.data("playlist",this.model),this._super.apply(this,["initialize"].concat(_.toArray(arguments)))},changeFavoriteLabel:function(e,t){this.model.get("isFavorite")?_.$one(t).attr("data-translate-text","SUBSCRIBED").text(_.getString("SUBSCRIBED")):_.$one(t).attr("data-translate-text","SUBSCRIBE").text(_.getString("SUBSCRIBE"))}}),n.Views.Modules.PlaylistCellBlock=n.Views.Modules.Base.extend({className:"module module-cell playlist block grid-item",cacheKey:"PlaylistCellBlock",templateFile:"playlistCellBlock",changeModelSelectors:{"&":function(e,t){_.$one(t).data("playlist",this.model)},".playlist-link":function(e,t){_.$one(t).attr("href",this.model.toUrl())},".title":function(e,t){_.$one(t).innerText(this.model.get("PlaylistName"))},".img":function(e,t){_.$one(t).attr("src",this.model.getImageURL(200))},".user-link":function(e,t){_.$one(t).attr("href",this.model.toUserUrl()).innerText(this.model.get("UserName"))}},initialize:function(e){this.$el.data("playlist",this.model),this._super.apply(this,["initialize"].concat(_.toArray(arguments)))}}),n.Views.Modules.BroadcastCell=n.Views.Modules.Base.extend({className:"module module-cell broadcast grid-item",cacheKey:"BroadcastCell",templateFile:"broadcastCell",changeModelSelectors:{"&":function(e,t){_.$one(t).data("broadcast",this.model),this.model.get("activeStatus")===0?_.$one(t).addClass("bc-inactive"):_.$one(t).removeClass("bc-inactive")},".join-toggle":function(e,t){var i=r.model.get("user"),s=this.model.getOwner();if(s===i)_.$one(t).addClass("hide");else{var o=this.model.get("BroadcastID"),u=n.getCurrentBroadcastID()==o,a=u?"LEAVE":"JOIN_NOW",f=_.$one(t);this.grid&&this.grid.options.joinViaUserPage&&(o=null),u?f.removeClass("hide").data("broadcastId",o).data("userId",s&&s.get("UserID")).addClass("join-broadcast"):f.removeClass("hide").data("broadcastId",o).addClass("leave-broadcast"),f.attr("data-translate-text",a).text(_.getString(a))}},".title":function(e,t){this.model.get("activeStatus")===0?_.$one(t).removeAttr("href"):_.$one(t).attr("href",this.model.toUrl()),_.$one(t).attr("title",this.model.get("Name")).innerText(this.model.get("Name"))},".user-link":function(e,t){var r=this.model.getOwner();r instanceof n.Models.User?_.$one(t).data("userId",r.get("UserID")).innerText(r.get("Name")||""):_.$one(t).attr("href",r.toUrl()).innerText(r.get("ArtistName")||"")},".bc-img-container .img":function(e,t){_.$one(t).attr("src",this.model.getImageURL(120))},".bc-image":function(e,t){this.model.get("listenersCount")?_.$one(t).removeClass("no-count"):_.$one(t).addClass("no-count")},".listeners .num":function(e,t){_.$one(t).innerText(_.truncateNumber(this.model.get("listenersCount"),1e4))},".listeners .label":function(e,t){_.$one(t).innerText(_.getStringPluralized("LISTENER","LISTENERS",this.model.get("listenersCount")))},".bc-now-playing":function(e,t){var n=this.model.get("activeSong");n?_.$one(t).removeClass("hide"):_.$one(t).addClass("hide")},".active-song":function(e,t){var n=this.model.get("activeSong");n?_.$one(t).html(_.getString("QUEUE_CURRENT_SONG_NO_ALBUM",{song:n.getAnchorTag(null,null,"link"),artist:this.model.get("activeSong").getArtistAnchorTag(null,null,"link")})):_.$one(t).html("N/A")},".tag":function(e,t){var n=this.model.get("Tag");if(n)_.$one(t).text(n.n);else{var r=_.getString("BROADCAST_DEFAULT_TAG");_.$one(t).text(r)}},".genre-link":function(e,t){var n=this.model.get("Tag");n&&n.n!=="multi-genre"?_.$one(t).data({tag:n.n,tagId:n.i}).attr({"data-tag":n.n,"data-tag-id":n.i}):_.$one(t).data({tagId:null,tag:_.getString("BROADCAST_DEFAULT_TAG")}).attr({"data-tag":_.getString("BROADCAST_DEFAULT_TAG"),"data-tag-id":null})},".plays":function(e,t){var n=this.model.getOwner(),r=n&&n.get("estimatedBroadcastListens");_.isNumber(r)&&r!==0?_.$one(t).removeClass("hide").find(".num-plays").text(_.getStringPluralized("ONE_PLAY","NUM_PLAYS",r,{num:_.addCommaSeparators(r)})):_.$one(t).addClass("hide")},".followers":function(e,t){var n=this.model.getOwner(),r;n&&n.attributes.pageNameData&&n.attributes.pageNameData.FollowedCount?(r=_.addCommaSeparators(_.toInt(n.attributes.pageNameData.FollowedCount)),_.$one(t).removeClass("hide").find(".num-followers").text(_.getStringPluralized("ONE_FOLLOWER","NUM_FOLLOWERS",r,{num:_.addCommaSeparators(r)}))):_.$one(t).addClass("hide")},".start-time":function(e,t){_.$one(t).html(_.getString("STARTING_IN",{duration:_.getFormattedDate(this.model.get("TSCreated"))}))}},initialize:function(e){this.$el.data("broadcast",this.model),e.grid&&e.grid.options.featuredBroadcasts&&this.$el.addClass("featured");var t=this.model.getOwner();t&&(t.on("change:pageNameData",this.onOwnerPageNameDataChange,this),t.on("change:isFavorite",this.handleModelChange,this)),r.model.get("player").on("change:currentQueue",this.onPlayerChange,this),this.onPlayerChange(),this._super.call(this,"initialize",e)},onDestroy:function(){r.model.off(null,null,this),this.queue&&this.queue.off(null,null,this);var e=this.model.getOwner();e&&e.off(null,null,this)},completeRender:function(e,t){this._super.call(this,"completeRender",e,t);var n=r.model.get("user"),i=this.model.getOwner();i===n&&this.$el.find(".join-toggle").addClass("hide")},onPlayerChange:function(){this.queue&&this.queue.off(null,null,this),this.queue=r.model.get("player").get("currentQueue"),this.queue&&this.queue.on("change:currentBroadcast",this.onCurrentBroadcastChange,this),this.renderDfd&&this.handleModelChange()},changeModel:function(e){if(this.model){var t=this.model.getOwner();t&&t.off(null,null,this)}var n=e.getOwner();n&&(n.on("change:pageNameData",this.onOwnerPageNameDataChange,this),n.on("change:isFavorite",this.handleModelChange,this)),this._super.apply(this,["changeModel"].concat(_.toArray(arguments)))},onOwnerPageNameDataChange:function(e,t){this.handleModelChange()},onCurrentBroadcastChange:function(){this.handleModelChange()}}),n.Views.Modules.BroadcastRowLarge=n.Views.Modules.BroadcastCell.extend({className:"module module-row broadcast large grid-item",cacheKey:"BroadcastRowLarge",templateFile:"broadcastRowLarge",events:{click:"viewBroadcast"},changeModelSelectors:_.extend({},n.Views.Modules.BroadcastCell.prototype.changeModelSelectors,{".bc-img-container .img":function(e,t){_.$one(t).attr("src",this.model.getImageURL(80))},".title":function(e,t){_.$one(t).attr("href",this.model.toUrl()).innerText(this.model.get("Name"))},".open-profile-card":function(e,t){_.$one(t).attr("href",this.model.getOwner().toUrl())},".join-toggle":function(e,t){var i=r.model.get("user"),s=this.model.getOwner(),o=this.model.get("BroadcastID"),u=n.getCurrentBroadcastID()==o,a=u?"LEAVE":"JOIN_NOW",f=_.$one(t);i===s?f.addClass("hide"):(this.grid&&this.grid.options.joinViaUserPage&&(o=null),f.removeClass("hide").data("broadcastId",o).data("userId",s&&s.get("UserID")),f.find(".label").data("translateText",a).text(_.getString(a)),u?f.addClass("leave-broadcast").removeClass("join-broadcast btn-primary"):f.addClass("join-broadcast btn-primary").removeClass("leave-broadcast"))},".follow-broadcaster":function(e,t){var r=_.$one(t),i=this.model.getOwner(),s=i.get("isFavorite"),o=s?"btn-primary":"btn-success",u=s?"btn-success":"btn-primary",a=s?"plus icon-plus-white-active":"check icon-check-white-active",f=s?"check icon-check-white-active":"plus icon-plus-white-active",l;this.model.get("ArtistID")?s?l="FOLLOWING":l="FOLLOW_ARTIST":s?l="FOLLOWING":l="FOLLOW",i.get("UserID")===n.getLoggedInUserID()?u+=" hide":o+=" hide",r.removeClass(o).addClass(u),r.data("userId",i.get("UserID")),r.find(".label").data("translateText",l).text(_.getString(l)),r.find(".icon").removeClass(a).addClass(f)}}),viewBroadcast:function(e){if(this.model.get("activeStatus")===0){e.preventDefault();return}var t=$(e.target);!t.is("a")&&!t.parent("a").length&&n.router.setHash(this.model.toUrl())}}),n.Views.Modules.BroadcastCellSmall=n.Views.Modules.Base.extend({className:"module module-cell broadcast small grid-item",cacheKey:"BroadcastCellSmall",templateFile:"broadcastCellSmall",changeModelSelectors:{"&":function(e,t){_.$one(t).data("broadcast",this.model)},".btn.play":function(e,t){_.$one(t).data("broadcastId",this.model.get("BroadcastID"))},".title":function(e,t){_.$one(t).attr("href",this.model.toUrl()).innerText(this.model.get("Name"))},".byline a":function(e,t){var r=this.model.getOwner()||n.Models.User.getCached(this.model.get("UserID"));r&&_.$one(t).attr("href",this.model.toOwnerUrl()).innerText(r.get("Name")||"")},".img":function(e,t){_.$one(t).attr("src",this.model.getImageURL(80))},"a.img-container":function(e,t){_.$one(t).attr("href",this.model.toUrl())}},initialize:function(e){this.$el.data("broadcast",this.model),this._super.apply(this,["initialize"].concat(_.toArray(arguments)))}}),n.Views.Modules.BroadcastCellBlock=n.Views.Modules.Base.extend({className:"module module-cell broadcast block grid-item",cacheKey:"BroadcastCellBlock",templateFile:"broadcastCellBlock",changeModelSelectors:{"&":function(e,t){_.$one(t).data("broadcast",this.model)},".btn.play":function(e,t){_.$one(t).data("broadcastId",this.model.get("BroadcastID"))},".title":function(e,t){_.$one(t).attr("href",this.model.toUrl()).innerText(this.model.get("Name"))},".byline a":function(e,t){var r=this.model.getOwner()||n.Models.User.getCached(this.model.get("UserID"));r&&_.$one(t).attr("href",this.model.toOwnerUrl()).innerText(r.get("Name")||"")},".img":function(e,t){_.$one(t).attr("src",this.model.getImageURL(120))},"a.img-container":function(e,t){_.$one(t).attr("href",this.model.toUrl())}},initialize:function(e){this.$el.data("broadcast",this.model),e.grid&&e.grid.options&&(e.grid.options.smallGrid?this.$el.addClass("small"):e.grid.options.mediumGrid&&this.$el.addClass("medium")),this._super.call(this,"initialize",e)}}),n.Views.Modules.SidebarBroadcast=n.Views.Modules.Base.extend({className:"module sidebar-broadcast grid-item sidebar-row",cacheKey:"SidebarBroadcast",templateFile:"sidebarBroadcast",changeModelSelectors:{"&":function(e,t){_.$one(t).data("broadcast",this.model)},".btn.play":function(e,t){_.$one(t).data("broadcastId",this.model.get("BroadcastID"))},".broadcast-link":function(e,t){_.$one(t).attr("href",this.model.toUrl())},".name":function(e,t){_.$one(t).innerText(this.model.get("Name"))}},events:{contextmenu:"handleContextMenuClick"},initialize:function(e){this.$el.data("broadcast",this.model),this._super.call(this,"initialize",e)},acceptDrop:function(e){return!1},handleContextMenuClick:function(e){return e.preventDefault(),!1}}),n.Views.Modules.VideoCell=n.Views.Modules.Base.extend({className:"module module-cell video block grid-item",cacheKey:"VideoCell",templateFile:"videoCell",events:{"click .btn.play":"playVideo","click .title":"playVideo"},changeModelSelectors:{"&":function(e,t){_.$one(t).data("videoId",this.model.get("VideoID"))},".video-link":function(e,t){_.$one(t).data("videoId",this.model.get("VideoID"))},".artist-link":function(e,t){_.$one(t).attr("href",this.model.toArtistUrl()).innerText(this.model.get("ArtistName"))},".attributor":function(e,t){_.$one(t).innerText(this.model.get("attributor"))},".title":function(e,t){_.$one(t).innerText(this.model.get("title"))},".btn.video-cell-dropdown":function(e,t){_.$one(t).data("videoId",this.model.get("VideoID"))},".img":function(e,t){_.$one(t).attr("src",this.model.getImageURL(120))}},initialize:function(e){this.$el.data("videoId",this.model.get("VideoID")),e.grid&&e.grid.options&&(e.grid.options.smallGrid?this.$el.addClass("small"):e.grid.options.mediumGrid&&this.$el.addClass("medium")),this._super.apply(this,["initialize"].concat(_.toArray(arguments)))},playVideo:function(e){var t=!0;this.model.get("clickToPlay")=="true"&&(t=!1),n.trigger("lightbox:open","video",{videos:[{type:this.model.get("type"),id:this.model.get("VideoID"),title:this.model.get("title"),width:this.model.get("width"),height:this.model.get("height"),autoplay:t}],hideHeader:!0})}}),n.Views.Modules.EventRowTall=n.Views.Modules.Base.extend({className:"module module-row event tall grid-item",cacheKey:"EventRowTall",templateFile:"eventRowTall",changeModelSelectors:{"&":function(e,t){_.$one(t).data("eventId",this.model.get("EventID"))},".event-link":function(e,t){_.$one(t).attr("href",this.model.get("TicketsURL")).innerText(this.model.get("EventName"))},".meta-inner":function(e,t){_.$one(t).innerText(this.model.get("VenueName")+" "+this.model.get("City"))},".month":function(e,t){_.$one(t).innerText(_.getDateFormatChars(this.model.get("StartTime")).M)},".day":function(e,t){_.$one(t).innerText(_.getDateFormatChars(this.model.get("StartTime")).j)}},initialize:function(e){this.$el.data("eventId",this.model.get("EventID")),this._super.apply(this,["initialize"].concat(_.toArray(arguments)))}}),n.Views.Modules.StationRow=n.Views.Modules.Base.extend({className:"module module-row station grid-item",cacheKey:"StationRow",templateFile:"stationRow",changeModelSelectors:{"&":function(e,t){_.$one(t).data("tagId",this.model.get("TagID"))}},initialize:function(){this.$el.data("tagId",this.model.get("TagID"))}}),n.Views.Modules.QueueSongCell=n.Views.Modules.Base.extend({className:"module module-cell queue-item grid-item",cacheKey:"QueueSongCell",templateFile:"queueSongCell",events:{"click .remove":function(){n.trigger("player:removeSongs",[this.model])},"click .play":function(){n.trigger("player:togglePlay",this.model.get("queueSongID"))}},changeModelSelectors:{"&":function(e,t){_.$one(t)[this.model.get("active")?"addClass":"removeClass"]("queue-item-active").data("queueSongId",this.model.get("queueSongID"))},".queue-song":function(e,t){_.$one(t)[this.model.get("suggestion")?"addClass":"removeClass"]("suggestion"),_.$one(t)[this.model.get("broadcastPlayed")?"addClass":"removeClass"]("dj-locked")},".queue-radio-options":function(e,t){_.$one(t)[this.model.get("songQueueHelper").autoplayEnabled?"addClass":"removeClass"]("active"),_.$one(t)[this.model.get("isCallout")?"addClass":"removeClass"]("hide")},".smile":function(e,t){_.$one(t)[this.model.get("smile")?"addClass":"removeClass"]("active")},".frown":function(e,t){_.$one(t)[this.model.get("frown")?"addClass":"removeClass"]("active")},".queue-song-options":function(e,t){_.$one(t)[this.model.get("isCallout")?"addClass":"removeClass"]("hide"),_.$one(t)[this.model.get("fromLibrary")?"addClass":"removeClass"]("inLibrary")[this.model.get("isFavorite")?"addClass":"removeClass"]("isFavorite")},".paused, .play":function(e,t){_.$one(t)[this.model.get("paused")?"addClass":"removeClass"]("paused")},img:function(e,t){_.$one(t).attr("src",this.model.getImageURL(this.model.get("songQueueHelper").queueImageSize))},".queue-song-name":function(e,t){var n=this.model.get("SongName");_.$one(t).data("songId",this.model.get("SongID")).data("calloutId",this.model.get("CalloutID")).innerText(n)},".queue-song-artist":function(e,t){var n=this.model.get("ArtistName");_.$one(t).attr("title",n).attr("href",this.model.toArtistUrl()).innerText(n)}}}),n.Views.Modules.Comment=n.Views.Modules.Base.extend({className:"module module-comment",cacheKey:"Comment",templateFile:"comment",events:{"click .respond-cta":"openResponseInput","click .delete-response-cta":"deleteResponse","click .report-response-cta":"reportResponse","click .comment-options":"onOptionClick"},initialize:function(e){this.$el.data("comment",this.model),this.commentStyleType=_.orEqual(this.options.commentStyleType,"sidebar"),this.getUserPicture=_.orEqual(this.options.getUserPicture,_.bind(n.getLoggedInUserPicture,n)),this.isParentPage=this.model.get("ItemID")!=this.options.pageItemID||this.model.get("TypeID")!=this.options.pageTypeID,this.model.get("Responses").on("add",this.renderNewResponse,this),this.model.get("Responses").on("remove",this.removeResponse,this),this.model.on("commentRemoved",this.destroy,this),this._super.call(this,"initialize",e)},completeRender:function(e,t){if(this.isParentPage&&!this.model.getChildMetadata()){this.$el.addClass("empty");return}this.$el.removeClass("empty"),this._super.call(this,"completeRender",e,t),this.responseModules=[],this.$responsesEl=this.$el.find(".comment-responses"),this.renderResponses(),this.options.highlighted&&this.$el.addClass("reply").find(".comment-response-container").removeClass("hide")},renderResponses:function(){var e=this.model.get("Responses").length;if(!e)return;this.$responsesEl.empty();var t=[],r=this.responseModules;this.model.get("Responses").each(function(e){if(!e.get("author"))return;var i=new n.Views.Modules.CommentResponse({model:e});i.render(),r.push(i),t.push(i.$el[0])}),this.$responsesEl.append(t).show(),this.$el.find(".module-item-respond").show(),this.$el.find(".comment-replies-num").text(e)},renderNewResponse:function(e){if(!this.$responsesEl||!e.get("author"))return;var t=new n.Views.Modules.CommentResponse({model:e});t.render(),this.responseModules.push(t),this.$responsesEl.append(t.$el[0]).show(),this.$el.find(".module-item-respond").show(),setTimeout(_.bind(function(){var e=this.model.getResponsesCount();e===1&&(this.render(),this.$el.find(".comment-response-container").removeClass("hide")),this.$el.find(".comment-replies-num").text(e)},this),0)},removeResponse:function(e){if(!this.$responsesEl)return;var t=e.get("ResponseID");_.each(this.responseModules,function(e){e.model.get("ResponseID")===t&&e.destroy()});var n=this.model.get("Responses").length;this.$el.find(".comment-replies-num").text(n)},openResponseInput:function(e){e.preventDefault();var t=this.$el,n=function(){t.addClass("reply").find(".comment-response-container").removeClass("hide"),$(".reply-input",t).focus()};this.model.get("ResponsesLoaded")?n():this.model.loadResponses().done(_.bind(function(){this.renderResponses(),n()},this))},deleteResponse:function(e){e.preventDefault();var t=$(e.currentTarget),n=t.parents(".response-row").data("response");n&&!t.hasClass("pending")&&n.deleteResponse().fail(function(){t.removeClass("pending")}),t.addClass("pending")},reportResponse:function(e){e.preventDefault();var t=$(e.currentTarget),n=t.parents(".response-row").data("response");n&&!t.hasClass("pending")&&n.reportResponse().done(function(){t.replaceWith('<span class="module-footer-link">'+_.getString("REPORTED")+"</span>")}).always(function(){t.removeClass("pending")}),t.addClass("pending")},onOptionClick:function(e){var t=$(e.currentTarget);t.jjmenu(e,this.getCommentMenu(t),null,{xposition:"left",yposition:"auto",show:"default",className:"contextmenu",keepState:t}),t.addClass("active-context")},getCommentMenu:function(e){var t=[],r=this.model,i=this.collection;return r.get("author").UserID!=n.getLoggedInUserID()&&t.push({key:r.get("reportedByUser")?"REPORTED":"REPORT",title:r.get("reportedByUser")?_.getString("REPORTED"):_.getString("REPORT"),customClass:r.get("reportedByUser")?"jj_menu_item_disabled":"jj_menu_item_comment_report",action:{type:"fn",callback:function(){r&&!r.get("reportedByUser")&&r.reportComment().done(function(){r.set("reportedByUser",!0)})}}}),r.canDelete()&&t.push({key:"DELETE",title:_.getString("DELETE"),customClass:"jj_menu_item_comment_delete",action:{type:"fn",callback:function(){r&&r.deleteComment().done(function(e){e?r.destroy():n.trigger("notification:add",{description:_.getString("POPUP_ERROR_COMMENT_DELETE_FAILED"),type:"error",duration:5e3})}).fail(function(){n.trigger("notification:add",{description:_.getString("POPUP_ERROR_COMMENT_DELETE_FAILED"),type:"error",duration:5e3})})}}}),t}}),n.Views.Modules.CommentResponse=n.Views.Modules.Base.extend({className:"module response-row",cacheKey:"CommentResponse",templateFile:"commentResponse",initialize:function(e){this.$el.data("response",this.model),this._super.apply(this,["initialize"].concat(_.toArray(arguments)))}}),n.Views.Modules.TagProfileCard=n.Views.Modules.Base.extend({className:"module module-profile-card genre grid-item no-img",cacheKey:"TagProfileCard",templateFile:"tagProfileCard",changeModelSelectors:{"&":function(e,t){_.$one(t).data("tag",this.model)},".tag-name a":function(e,t){_.$one(t).attr("href",this.model.toUrl()).data({tagId:this.model.id,tag:this.model.get("Tag")}).innerText(this.model.get("DisplayName"))},".artist-links":function(e,t){var n=this.model.getRandomArtists(3);for(var r=0,i=n.length;r<i;r++)n[r]=n[r].getAnchorTag();_.$one(t).html(n.join(", "))}},initialize:function(e){this.$el.data("tag",this.model).attr("id","tag-"+this.model.get("TagID")),this.on("rendered",_.bind(function(){var e=this.$el.find(".artist-links");if(!e.length)return;var t=this.model.id;this.model.get("pageInfoLoaded")?this.changeModelSelectors[".artist-links"].call(this,0,e[0]):this.model.getArtists().done(_.bind(function(){this.model.id==t&&this.changeModelSelectors[".artist-links"].call(this,0,e[0])},this))},this)),this._super.apply(this,["initialize"].concat(_.toArray(arguments)))}}),n.Views.Modules.TagRow=n.Views.Modules.Base.extend({className:"module module-row tall genre grid-item",cacheKey:"TagRow",templateFile:"tagRow",changeModelSelectors:{"&":function(e,t){_.$one(t).data("tag",this.model)},"a.title":function(e,t){_.$one(t).attr("href",this.model.toUrl()).data({tagId:this.model.id,tag:this.model.get("Tag")}).innerText(this.model.get("DisplayName"))},".artist-links":function(e,t){var n=this.model.getRandomArtists(3),r=[];for(var i=0,s=Math.min(n.length,3);i<s;i++)r[i]=n[i].getAnchorTag();_.$one(t).html(r.join(", "))}},initialize:function(e){this.$el.data("tag",this.model).attr("id","tag-"+this.model.get("TagID")),this.on("rendered",_.bind(function(){this.changeModelSelectors["&"].call(this,0,this.el)},this)),this._super.apply(this,["initialize"].concat(_.toArray(arguments)))}}),n.Views.Modules.ThemeCell=n.Views.Modules.Base.extend({className:"module module-cell theme grid-item",cacheKey:"ThemeCell",templateFile:"themeCell",user:null,events:{"click .theme-select":"onThemeClick"},changeModelSelectors:{"&":function(e,t){_.$one(t).data("themeID",this.model.get("themeID"))},".title":function(e,t){_.$one(t).innerText(this.model.get("title"))},".img":function(e,t){_.$one(t).attr("src","themes/"+this.model.get("location")+"/preview.jpg")}},initialize:function(e){this.user=e.grid.user;var t=this.model.get("themeID");this.$el.data("themeID",t).attr("data-theme-id",t),t==e.grid.selected&&this.$el.addClass("active"),this._super.apply(this,["initialize"].concat(_.toArray(arguments)))},onThemeClick:function(e){var t=$(e.currentTarget),r=t.attr("data-theme-id");$("#page-content .save").removeClass("btn-success").removeClass("disabled"),$("#page-content .cancel").removeClass("disabled"),this.user.get("subscription").isPremium()?(n.trigger("theme:set",{themeID:r,temporary:!0}),$(".theme").removeClass("active"),$('.theme[data-theme-id="'+r+'"]').addClass("active")):n.trigger("lightbox:open","vipOnlyFeature")}}),n.Views.Modules.ThemeUserCell=n.Views.Modules.Base.extend({className:"module module-cell user-theme grid-item",cacheKey:"ThemeUserCell",templateFile:"themeUserCell",user:null,events:{"click .theme-select":"onThemeClick"},changeModelSelectors:{"&":function(e,t){_.$one(t).data("themeID",this.model.get("themeID"))},".img":function(e,t){_.$one(t).attr("src","themes/"+this.model.get("location")+"/preview.jpg")}},initialize:function(e){this.user=e.grid.user;var t=this.model.get("themeID");this.$el.data("themeID",t).attr("data-theme-id",t),t==e.grid.selected&&this.$el.addClass("active"),this._super.apply(this,["initialize"].concat(_.toArray(arguments)))},onThemeClick:function(e){var t=$(e.currentTarget),r=t.attr("data-theme-id");$("#lightbox-content .submit").removeClass("btn-success").removeClass("disabled"),this.user.get("subscription").isPremium()?(n.trigger("theme:set",{themeID:r,temporary:!0}),$(".theme").removeClass("active"),$('.theme[data-theme-id="'+r+'"]').addClass("active")):n.trigger("lightbox:open","vipOnlyFeature")}}),n.Views.Modules.AlbumEditor=n.Views.Modules.Base.extend({className:"module edit-entity-container album",cacheKey:"AlbumEditor",templateFile:"albumEditor",events:{"mousemove .button-upload-form":"uploadMousemove","change .uploader":"onNewUpload"},initialize:function(e){this.artist=e.artist,this.creatingNew=_.orEqual(e.creatingNew,!1),this.hideArt=_.orEqual(e.hideArt,!1),this._super.apply(this,["initialize"].concat(_.toArray(arguments)))},render:function(){var e=_.toArray(arguments);if(!this.creatingNew){var t=$.Deferred();return this.model.getAlbumDetails().done(_.bind(function(){this._super.apply(this,["render"].concat(e)).done(_.bind(t.resolve,t)).fail(_.bind(t.fail,t))},this)),t.promise()}return this._super.apply(this,["render"].concat(e))},submit:function(e){var t=_.chainLoading({ignoreFails:!0}),r=$.Deferred(),i=this.$el.find(".album-name"),s=this.$el.find(".album-year"),o=this.$el.find(".album-type"),u=this.artist,a={},f={Name:i.val(),Year:_.toInt(s.val()),ReleaseType:_.toInt(o.val()),IsVerified:1,ArtistID:u.get("ArtistID"),ReleaseStatus:_.toInt(this.$el.find(".album-status:checked").val())};if(!f.Name||f.Name=="")return i.parent().addClass("field-error"),r.reject(0),r.promise();var l=s.val();if(l!==""&&f.Year<1900)return s.parent().addClass("field-error"),r.reject(0),r.promise();l===""&&(f.Year="");if(f.ReleaseStatus&&!f.ReleaseType)return o.parent().addClass("field-error"),r.reject(-1),r.promise();if(e)return r.resolve(f),r.promise();if(!this.creatingNew){var c=this.model;f.Name!==c.get("AlbumName")&&(a.changedAlbumName=!0),f.ReleaseType!==c.get("ReleaseType")&&(a.originalAlbumReleaseType=c.get("ReleaseType"),a.changedAlbumReleaseType=f.ReleaseType),f.Year!==c.get("Year")&&(a.originalAlbumReleaseYear=c.get("Year"),a.changedAlbumReleaseYear=f.Year),a.editedAlbum=c.get("AlbumID"),t.push(this.model.updateInfo(f).fail(t.bind(r.reject,r,1))),this.submitArtUpload(r,t,this.model),t.done(_.bind(r.resolve,r,this.model)),n.trigger("guts:log","editAlbum",a),n.trigger("guts:gatrack","artist","editAlbum",c.get("AlbumID"))}else t.push(n.Services.API.artistCreateAlbum(f).done(t.bind(function(e){if(!e||!e.success){r.reject(1);return}f.AlbumID=_.toInt(e.albumID),f.ArtistName=u.get("ArtistName");var i=n.Models.Album.newOrUpdate(f);u.getAllAlbums().done(function(){u.get("albums").add(i)}),this.submitArtUpload(r,t,i),t.done(_.bind(r.resolve,r,i)),n.trigger("guts:log","createAlbum",{newAlbumID:f.AlbumID,onArtistID:u.get("ArtistID")}),n.trigger("guts:gatrack","artist","newAlbum",u.get("ArtistID"))},this)).fail(t.bind(r.reject,r,1)));return r.promise()},submitArtUpload:function(t,r,i){var s=$("#upload-entity-art"),o=s.val();if(!this.hideArt&&o&&o.length){var u,a=new $.Deferred;r.push(a.fail(r.bind(t.reject,t,2)));var f=_.bind(function(e,t){switch(e){case"complete":i.set("CoverArtFilename",t.filename+"?"+(new Date).getTime()),$(".entity-art",this.$el).find("img").attr("src",i.getImageURL(120)),s.val(""),a.resolve(),n.trigger("guts:log","editAlbumArt",{editedAlbumID:i.get("AlbumID"),editedAlbumArtistID:i.get("ArtistID")}),n.trigger("guts:gatrack","artist","editAlbumArt",i.get("ArtistID"));break;case"error":a.reject()}},this);if(e.FormData){u=new e.XMLHttpRequest;var l=new FormData;l.append("albumArt",s.data("file")),l.append("albumID",i.get("AlbumID")),u.addEventListener("load",function(e){var t=e.currentTarget.response;try{t=$.parseJSON(t)}catch(e){t=null}f&&t&&t.filename?f("complete",t):f("error",t)},!1),u.addEventListener("error",function(e){f&&f("error",e)},!1),u.open("POST","/upload.php?albumArt=1"),u.send(l)}else{var c="uploadAlbumArt_"+i.get("AlbumID"),h=c+"_Frame";e[c]=function(t){f&&(t&&t.filename?f("complete",t):f("error",t),_.defer(function(){$("#"+h).remove(),delete e[c]}))};var p=document.createElement("iframe");p.src="empty.html",p.id=h,p.name=h,p.setAttribute("style","visiblity: hidden; display: none;"),document.body.appendChild(p);var d=$(".button-upload-form",this.$el);d.find(".upload-albumID").val(i.get("AlbumID")),d.attr("action","/upload.php?albumArt=1&callback="+c).attr("target",h).submit()}}},uploadMousemove:function(e){typeof e.pageY=="undefined"&&typeof e.clientX=="number"&&document.documentElement&&(e.pageX=e.clientX+document.documentElement.scrollLeft,e.pageY=e.clientY+document.documentElement.scrollTop);var t=$(e.currentTarget),n=t.offset(),r=$(t).find(".uploader").removeClass("hide");r.css("top",e.pageY-n.top-Math.abs(r.height()/2)+"px"),r.css("left",e.pageX-n.left-Math.abs(r.width()-50)+"px")},onNewUpload:function(t){var n=$(t.currentTarget),r=t.target&&t.target.files?t.target.files:null,i;if(r&&r.item(0)){var s=r.item(0);s.getAsDataURL?i=s.getAsDataURL():e.URL&&e.URL.createObjectURL?i=e.URL.createObjectURL(s):e.webkitURL&&e.webkitURL.createObjectURL&&(i=e.webkitURL.createObjectURL(s)),n.data("file",s)}if(i){var o=$(".entity-art",this.$el).find("img").css({height:"auto",width:"auto",left:0,top:0}),u=function(){try{o.width()>o.height()?(o.css("height","120px"),o.css("left",-1*Math.floor((o.width()-120)/2)+"px")):(o.css("width","120px"),o.css("top",-1*Math.floor((o.height()-120)/2)+"px")),e.URL?e.URL.revokeObjectURL(this.src):e.webkitURL&&e.webkitURL.revokeObjectURL(this.src),o.off("load",u)}catch(t){}};o.on("load",u).attr("src",i)}var a=_.last(_.last(n.val().split("\\")).split("/"));$(".art-filename",this.$el).text(a)}}),n.Views.Modules.UserArtistCell=n.Views.Modules.Base.extend({className:"module module-cell user-artist grid-item",cacheKey:"UserArtistCell",templateFile:"userArtistCell",changeModelSelectors:{"&":function(e,t){var r=_.$one(t);this.model instanceof n.Models.User?r.data({userId:this.model.id,artistId:null}):r.data({artistId:this.model.id,userId:null})},".title":function(e,t){this.model instanceof n.Models.User?_.$one(t).attr({href:this.model.toUrl()}).innerText(this.model.get("Name")):_.$one(t).attr({href:this.model.toUrl()}).innerText(this.model.get("ArtistName"))},".user-city":function(e,t){this.model instanceof n.Models.User&&this.model.get("City")?_.$one(t).innerText(this.model.get("City")+", "):_.$one(t).innerText("")},".user-state":function(e,t){this.model instanceof n.Models.User&&this.model.get("State")?_.$one(t).innerText(this.model.get("State")+", "):_.$one(t).innerText("")},".user-country":function(e,t){this.model instanceof n.Models.User&&this.model.get("Country")?_.$one(t).innerText(this.model.get("Country")):_.$one(t).innerText("")},".img-container":function(e,t){_.$one(t).attr({href:this.model.toUrl(),title:this.model.get("Name")})},".img":function(e,t){_.$one(t).attr("src",this.model.getImageURL(120))},".btn.favorite":function(e,t){var r=_.$one(t)[this.model.get("isFavorite")?"addClass":"removeClass"]("btn-success");this.model instanceof n.Models.User?(r.data({userId:this.model.id,artistId:null}),_.$one(t)[this.model.id==n.getLoggedInUserID()?"addClass":"removeClass"]("hide"),_.$one(t).removeAttr("data-artist-id").attr("data-user-id",this.model.id)):(r.data({artistId:this.model.id,userId:null}),_.$one(t).removeAttr("data-user-id").attr("data-artist-id",this.model.id))},".btn.favorite .icon":function(e,t){this.model.get("isFavorite")?_.$one(t).removeClass("icon-plus-gray").addClass("icon-check-white-active"):_.$one(t).removeClass("icon-check-white-active").addClass("icon-plus-gray")},".btn.play-station":function(e,t){this.model instanceof n.Models.User?_.$one(t).removeAttr("data-artist-id").attr("data-user-id",this.model.id):_.$one(t).removeAttr("data-user-id").attr("data-artist-id",this.model.id)}},initialize:function(e){this._super.apply(this,["initialize"].concat(_.toArray(arguments)))}}),n.Views.Modules.TagCellVertical=n.Views.Modules.Base.extend({className:"module module-cell genre block grid-item",cacheKey:"TagCellVertical",templateFile:"tagCellVertical",events:{"click .tag-cell-dropdown":"onDropDownGearClick"},changeModelSelectors:{"&":function(e,t){_.$one(t).data("albumId",this.model.get("TagID"))},".tag-link":function(e,t){_.$one(t).attr("href",this.model.toUrl())},".title":function(e,t){_.$one(t).innerText(this.model.get("DisplayName"))},".img":function(e,t){_.$one(t).attr("src",this.model.getImageURL(142))},".btn.tag-cell-share":function(e,t){_.$one(t).data("tagId",this.model.get("TagID"))},".btn.tag-cell-dropdown":function(e,t){_.$one(t).data("tagId",this.model.get("TagID"))}},initialize:function(e){this.$el.data("tagId",this.model.get("TagID")),e.grid&&e.grid.options&&(e.grid.options.smallGrid?this.$el.addClass("small"):e.grid.options.mediumGrid&&this.$el.addClass("medium")),this._super.apply(this,["initialize"].concat(_.toArray(arguments)))},onDropDownGearClick:function(e){return this.model&&i(e,this.model,{}),!1}}),n.Views.Modules.SuggestedFriends=n.Views.Modules.Base.extend({className:"module snapshot suggested-friends",cacheKey:"SuggestedFriends",templateFile:"suggestedFriends",defaultVisibleCount:6,events:{"click .remove-suggestion":"hideSuggestion"},initialize:function(e){this._super.apply(this,["initialize"].concat(_.toArray(arguments))),this.visibleCount=_.orEqual(e.visibleCount,this.defaultVisibleCount)},render:function(){var e=_.toArray(arguments),t=_.chainLoading(),n=$.Deferred();return t.fail(_.bind(n.reject,n)),t.push(this.model.getFavoritesByType("Users")),t.push(this.model.getRecommendedUsers().done(t.bind(this.onRecommendedUsers,this))),t.push(this._super.apply(this,["render"].concat(e)).done(t.bind(this.renderRecommendedUsers,this))),t.done(_.bind(function(){n.resolve(this.recommendations)},this)),n.promise()},destroy:function(e){this.grid&&this.grid.destroy(),this._super.call(this,"destroy",e)},onRecommendedUsers:function(e){if(!e||!e.models)return;var t=this.model.get("favoriteUsers");t?(e=_.difference(e.models,t.models),t.on("add",this.onNewFavoriteUser,this)):e=e.models,e=_.shuffle(e),this.recommendations=new n.Models.Collections.Users(e)},renderRecommendedUsers:function(){if(!this.recommendations||!this.recommendations.models||!this.recommendations.length)return;var e=[];while(this.recommendations.length&&e.length<this.visibleCount)e.push(this.recommendations.shift());e=new n.Models.Collections.Users(e);var t=this.$el.find(".suggested-friends-grid").empty();this.grid=new n.Views.SuggestedUserGridTall({el:t[0],collection:e}),this.visibleUserIDs=e.pluck("UserID"),this.grid.render()},onNewFavoriteUser:function(e){if(!this.grid||_.indexOf(this.visibleUserIDs,e.id)===-1)return;_.delay(_.bind(this.removedSuggestion,this,e.id),2e3)},hideSuggestion:function(e){var t=$(e.currentTarget),r=t.data("userId");r&&n.Services.API.userHideRecommendedUser(r).done(_.bind(this.removedSuggestion,this,r)).fail(function(){n.trigger("notification:add",{description:_.getString("ERROR_HIDE_SUGGESTION"),type:"error",duration:5e3})})},removedSuggestion:function(e){this.grid.collection.remove(e),this.recommendations.remove(e);if(this.recommendations.length&&this.grid.collection.length<this.defaultVisibleCount){var t=this.recommendations.shift();this.grid.collection.add(t),this.visibleUserIDs.push(t.id)}}}),n.Views.Modules.BroadcastRowTall=n.Views.Modules.Base.extend({className:"module module-row broadcast tall grid-item",cacheKey:"BroadcastRowTall",templateFile:"broadcastRowTall",changeModelSelectors:{"&":function(e,t){_.$one(t).data("broadcastId",this.model.get("BroadcastID")),this.model.get("activeStatus")===1?_.$one(t).removeClass("inactive"):_.$one(t).addClass("inactive")},".img":function(e,t){_.$one(t).attr("src",this.model.getImageURL(40))},".join-broadcast":function(e,t){var n=this.model.get("BroadcastID"),r=this.user&&this.user.get("currentBroadcastID")===n;r?_.$one(t).data("broadcastId",n).addClass("hide"):_.$one(t).data("broadcastId",n).removeClass("hide")},".leave-broadcast":function(e,t){var n=this.model.get("BroadcastID"),r=this.user&&this.user.get("currentBroadcastID")===n;r?_.$one(t).data("broadcastId",n).removeClass("hide"):_.$one(t).data("broadcastId",n).addClass("hide")},".title":function(e,t){_.$one(t).attr("href",this.model.toUrl()).innerText(this.model.get("Name"))},".broadcaster":function(e,t){var n=this.model.getOwner();n&&_.$one(t).attr("href",n.toUrl()).innerText(n.get("Name"))},".listeners":function(e,t){var n=_.toInt(this.model.get("PeakSubscribers")||this.model.get("listenersCount"));_.$one(t).html(_.getStringPluralized("ONE_LISTENER","NUM_LISTENERS",n,{num:n}))},".num-date":function(e,t){_.$one(t).innerText(_.getFormattedDate(this.model.get("TSCreated")))}},initialize:function(e){this.user=r.model.get("user"),this.$el.data("broadcastId",this.model.get("BroadcastID")),this._super.apply(this,["initialize"].concat(_.toArray(arguments)))}}),n.Views.Modules.BroadcastRow=n.Views.Modules.Base.extend({className:"module module-row broadcast grid-item",cacheKey:"BroadcastRow",templateFile:"broadcastRow",changeModelSelectors:{"&":function(e,t){_.$one(t).data("broadcastId",this.model.get("BroadcastID"))},".btn.play":function(e,t){_.$one(t).data("broadcastId",this.model.get("BroadcastID"))},".single-date":function(e,t){_.$one(t).attr("href",this.model.toUrl(!0)).innerText(_.getFormattedDate(this.model.get("TSCreated")))}},initialize:function(e){this.$el.data("broadcastId",this.model.get("BroadcastID")),this._super.apply(this,["initialize"].concat(_.toArray(arguments)))}}),n.Views.Modules.LeaderboardRowTall=n.Views.Modules.Base.extend({className:"module module-row leaderboard tall grid-item",cacheKey:"LeaderboardRowTall",templateFile:"leaderboardRowTall",templateConverted:!0,events:{"click .join-broadcast":"onJoinClick","mouseenter .tooltip-target":"showTooltip"},changeModelSelectors:{"&":function(e,t){},".row-number":function(e,t){_.$one(t).innerText(this.grid.collection.indexOf(this.model)+1+".")},".img":function(e,t){_.$one(t).attr("src",this.concreteModel.getImageURL(40))},".title":function(e,t){_.$one(t).attr("href",this.concreteModel.toUrl()).text(this.concreteModel.escape("Name"))},".plays":function(e,t){var n=_.toInt(this.model.get("periodPlays"));_.$one(t).text(_.getStringPluralized("ONE_PLAY","NUM_PLAYS",n,{num:_.addCommaSeparators(n)}))},".followers":function(e,t){var n=this.concreteModel.get("pageNameData"),r=_.toInt(n&&n.FollowedCount);_.$one(t).html(_.getStringPluralized("ONE_FOLLOWER","NUM_FOLLOWERS",r,{num:_.addCommaSeparators(r)}))},".join-broadcast":function(e,t){var n=this.concreteModel.get("currentBroadcastID"),r=n&&this.concreteModel.get("isOwnerOfCurrentBroadcast");r&&this.user.get("currentBroadcastID")!==n?_.$one(t).removeClass("hide"):_.$one(t).addClass("hide")},".icon.now-broadcasting":function(e,t){var n=this.concreteModel.get("currentBroadcastID")&&this.concreteModel.get("isOwnerOfCurrentBroadcast");n?_.$one(t).removeClass("hide"):_.$one(t).addClass("hide")},".favorite":function(e,t){this.concreteModel.has("UserID")?_.$one(t).removeData("artistId").data("userId",this.concreteModel.get("UserID")):_.$one(t).removeData("userId").data("artistId",this.concreteModel.get("ArtistID")),this.concreteModel.get("isFavorite")?_.$one(t).addClass("btn-success").data("tooltipText","FOLLOWING").find(".icon").removeClass("icon-plus-gray").addClass("icon-check-white-active"):_.$one(t).removeClass("btn-success").data("tooltipText","FOLLOW").find(".icon").addClass("icon-plus-gray").removeClass("icon-check-white-active")}},initialize:function(){this.user=r.model.get("user"),this._super.apply(this,["initialize"].concat(_.toArray(arguments)))},onJoinClick:function(e){return e.stopPropagation(),this.concreteModel.getCurrentStatus().done(_.bind(function(){var t=this.concreteModel.get("isOwnerOfCurrentBroadcast")&&this.concreteModel.get("currentBroadcastID");t&&r.joinBroadcast(t,this.concreteModel.get("UserID"),this.concreteModel.get("ArtistID"),_.eventToGUTSCoords(e))},this)),!1},showTooltip:function(e){var t=$(e.currentTarget),r=t.data("tooltipText"),i=new n.Views.Tooltips.Helper({text:_.getString(r)});n.Views.Tooltips.Helper.simpleTooltip(e,i)},addModelListeners:function(){var e=this.model.has("UserID")?n.Models.User:n.Models.Artist;this.concreteModel=e.newOrUpdate(this.model.attributes),this.model.set(this.concreteModel.attributes),this.concreteModel.on("change",function(){this.model.trigger("change")},this),this._super("addModelListeners")},removeModelListeners:function(){this.concreteModel.off(null,null,this),this._super("removeModelListeners")}}),n.Views.Modules.BroadcastGroupRow=n.Views.Modules.Base.extend({className:"module module-nested bc-group grid-item",cacheKey:"BroadcastGroupRow",templateFile:"broadcastGroupRow",events:{"click .show-all":"showAllBroadcasts"},changeModel:function(e){this._super.apply(this,["changeModel"].concat(_.toArray(arguments))),this.model.get("Broadcasts").length>this.model.get("visibleBroadcasts").length?this.model.set("shownAll",!1,{silent:!0}):this.model.set("shownAll",!0,{silent:!0})},changeModelSelectors:{"&":function(e,t){var r=_.$one(t),i=this.model.get("Broadcasts"),s=this.model.get("visibleBroadcasts");this.model.get("shownAll")?r.addClass("shown-all"):r.removeClass("shown-all"),i.length>1?r.removeClass("single"):r.addClass("single");var o=this.constructor.estimateSize(this.model,this.grid,!1);this.size!==o&&this.tmpSize!==o&&(r.outerHeight(o),this.tmpSize=o),this.broadcastGrid?(s&&this.broadcastGrid.collection.reset(s.models),this.broadcastGrid.options.playContext=new n.Models.PlayContext(this.model)):this.rendered&&this.makeChildGrid()},".bc-name":function(e,t){var n=this.model.get("Broadcasts");n.length>1?_.$one(t).removeAttr("href").innerText(n.first().get("Name")):_.$one(t).attr("href",n.first().toUrl(!0)).innerText(n.first().get("Name"))},".single-date":function(e,t){_.$one(t).attr("href",this.model.get("Broadcasts").first().toUrl()).innerText(_.getFormattedDate(this.model.get("Broadcasts").first().get("TSCreated")))},".img":function(e,t){_.$one(t).attr("src",this.model.get("BroadcastImage"))},".genre-link":function(e,t){var n=this.model.get("Tag");n&&n.n!=="multi-genre"?_.$one(t).data({tag:n.n,tagId:n.i}).attr({"data-tag":n.n,"data-tag-id":n.i}):_.$one(t).data({tagId:null,tag:_.getString("BROADCAST_DEFAULT_TAG")}).attr({"data-tag":_.getString("BROADCAST_DEFAULT_TAG"),"data-tag-id":null})},".tag":function(e,t){var n=this.model.get("Tag");if(n)_.$one(t).text(n.n);else{var r=_.getString("BROADCAST_DEFAULT_TAG");_.$one(t).text(r)}},".btn.play":function(e,t){_.$one(t).data("broadcastId",this.model.get("Broadcasts").first().get("BroadcastID"))}},initialize:function(e){var t=this.model.get("Broadcasts"),n=this.model.get("visibleBroadcasts");this.model.set("shownAll",t.length>n.length?!1:!0,{silent:!0}),this.size=this.constructor.estimateSize(this.model),this.$el.outerHeight(this.size),t.length>1?this.$el.removeClass("single"):this.$el.addClass("single"),this.model.get("shownAll")?this.$el.addClass("shown-all"):this.$el.removeClass("shown-all"),this._super.call(this,"initialize",e)},destroy:function(e){this.broadcastGrid&&this.broadcastGrid.off("resized",null,this),this._super.call(this,"destroy",e),this.rendered=!1},completeRender:function(e){this._super.apply(this,["completeRender"].concat(_.toArray(arguments))),this.rendered=!0,_.defer(_.bind(this.makeChildGrid,this))},makeChildGrid:function(){this.broadcastGrid&&(this.broadcastGrid.selectedItems.off("add remove reset sort",null,this),this.broadcastGrid.off("resized",null,this),this.broadcastGrid.destroy(!1));var e=this.model.get("Broadcasts"),t=this.model.id;e.comparator=function(e){return e.attributes.TSCreated*-1},e.sort(),this.broadcastGrid=new n.Views.BroadcastDateGrid({el:this.$el.find(".broadcast-grid")[0],collection:new n.Models.Collections.Broadcasts(this.model.get("visibleBroadcasts").models),playContext:new n.Models.PlayContext(this.model),header:!1,parentGrid:this.grid,parentModel:this.model,addStreamType:this.grid.options.addStreamType}),this.broadcastGrid.on("resized",this.childResized,this),this.broadcastGrid.render(),this.childViews=[this.broadcastGrid]},showAllBroadcasts:function(e){this.model.get("visibleBroadcasts").reset(this.model.get("Broadcasts").models),$(e.currentTarget).addClass("hide"),this.model.set("shownAll",!0),n.trigger("page:redrawUpdate")},childResized:function(){var e=this.model.get("Broadcasts"),t;e.length>1?(t=Math.max(112,this.broadcastGrid.$el.height()+35+32),this.model.get("shownAll")||(t+=30)):t=112,this.size!==t&&(this.size=t,this.tmpSize!=t&&(this.$el.outerHeight(t),this.tmpSize=null),this.trigger("resized"))}},{estimateSize:function(e,t){var n=e.attributes.Broadcasts;return n.length>1&&e.attributes.shownAll?Math.max(112,n.length*31+35+32):n.length>1&&!e.attributes.shownAll?Math.max(112,222):112}}),n.Views.Modules.ChatActivity=n.Views.Modules.Base.extend({className:"module chat-activity",cacheKey:"ChatActivity",templateFile:"chatActivity",events:{"click .upvote-btn":"onUpvoteClick","click .downvote-btn":"onDownvoteClick","click .approve-btn":"onApproveClick","click .user-broadcast-actions":"onBroadcastUserOptionsClick","click .enable-chat":"onEnableChatClick","click .play":"onPlayClick"},changeModelSelectors:{"&":function(e,t){_.$one(t).data("chatActivityId",this.model.get("ChatActivityID"));var n=this.model.get("type"),r=n!==this.type;this.update(!r)},".img":function(e,t){var r,i=this.model.get("infoType");this.model.get("type")==="message"?r=this.model.get("user")||this.model.get("artist"):!i||i!==n.Models.ChatActivity.SONGS_ADDED_BY_VIP&&i!==n.Models.ChatActivity.SONG_ADDED_BY_VIP?r=this.model.get("song"):r=this.model.get("user"),_.$one(t).attr("src",r&&r.getImageURL(30)||"")},".user-name":function(e,t){if(this.model.get("type")==="message"){var n=this.model.get("user");n&&_.$one(t).attr("href",n.toUrl()).innerText(n.get("Name"))}},".artist-name":function(e,t){if(this.model.get("type")==="message"){var n=this.model.get("artist");n&&_.$one(t).attr("href",n.toUrl()).innerText(n.get("ArtistName"))}},".block-user":function(e,t){this.model.get("type")==="message"&&_.$one(t).data("userId",this.model.get("user").get("UserID"))},".message":function(e,t){_.$one(t).html(this.model.getText())},".timestamp":function(e,t){_.$one(t).innerText(this.model.getFormattedTimestamp())},".user-broadcast-actions":function(e,t){var n=this.model.get("user");this.canShowUserActions()?_.$one(t).removeClass("hide").data("userId",n.get("UserID")):_.$one(t).addClass("hide")},".upvote-btn":function(e,t){var n=this.model.get("song");n&&(n.get("userVote")>0?_.$one(t).addClass("btn-success").find(".icon").removeClass("icon-upvote-gray").addClass("icon-upvote-white-active"):_.$one(t).removeClass("btn-success").find(".icon").removeClass("icon-upvote-white-active").addClass("icon-upvote-gray"))},".downvote-btn":function(e,t){var n=this.model.get("song");n&&(n.get("userVote")<0?_.$one(t).addClass("btn-danger").find(".icon").removeClass("icon-downvote-gray").addClass("icon-downvote-white-active"):_.$one(t).removeClass("btn-danger").find(".icon").removeClass("icon-downvote-white-active").addClass("icon-downvote-gray"))},".info-icon":function(e,t){_.$one(t).attr("class",["icon",this.iconClass].join(" "))}},initialize:function(e){this.$el.data("chatActivityId",this.model.get("ChatActivityID")),this.classes=[],e&&e.persistent&&(this.persistent=!0);var t=r.model.get("player");t.on("change:currentQueue",this.currentQueueChange,this),this.currentQueueChange(t,t.get("currentQueue")),this.update(!0),this._super.call(this,"initialize",e)},addModelListeners:function(){var e=this.model.get("infoType");if(this.model.get("type")=="message")this.author=this.model.get("user"),this.author.on("change:Name",this.handleModelChange,this),this.author.on("change:isFavorite",this.onFavChange,this),this.model.on("change:user",this.onAuthorChanged,this);else if(e==n.Models.ChatActivity.SONG_CHANGED||e==n.Models.ChatActivity.SUGGESTION_ADDED)this.song=this.model.get("song"),this.song.on("change",this.handleModelChange,this),this.model.on("change:song",this.onSongChanged,this);this._super.call(this,"addModelListeners")},removeModelListeners:function(){this.author&&(this.author.off(null,null,this),this.author=null),this.song&&(this.song.off(null,null,this),this.song=null),this.model.off("change:user",this.onAuthorChanged,this),this.model.off("change:song",this.onSongChanged,this),this._super.call(this,"removeModelListeners")},onAuthorChanged:function(e,t){var n=e.previous("user");n&&n.off(null,null,this),this.author=t,this.author.on("change:Name",this.handleModelChange,this),this.author.on("change:isFavorite",this.onFavChange,this),this.onFavChange()},onSongChanged:function(e,t){var n=e.previous("song");n&&n.off(null,null,this),this.song=t,this.song.on("change",this.handleModelChange,this)},currentQueueChange:function(e,t){this.currentQueue&&this.currentQueue.off(null,null,this),this.currentQueue=t,this.currentQueue.on("change:isBroadcasting",this.onBroadcastingChanged,this),this.onBroadcastingChanged(t,t.get("isBroadcasting"))},onBroadcastingChanged:function(e,t){var n=e?e.get("currentBroadcast"):null;t&&e&&n&&n.get("BroadcastID")===this.model.get("broadcastID")?this.isBroadcasting=t:this.isBroadcasting=!1,this.renderDfd&&this.renderDfd.state()==="resolved"&&this.render()},destroy:function(e){r.model.get("player").off(null,null,this),this.currentQueue&&this.currentQueue.off(null,null,this),this._super.call(this,"destroy",e)},update:function(e){var t=this.model.get("type"),i=this.model.get("infoType"),s=["chat-"+t];i&&s.push(i),this.type&&this.type!==t&&(this.classes+=" chat-"+this.type),this.type=t,this.classes.length&&this.$el.removeClass(this.classes);if(t=="info")switch(this.model.get("infoType")){case n.Models.ChatActivity.LEFT_BROADCAST:this.iconClass="user icon-user-remove-gray-flat";break;case n.Models.ChatActivity.JOINED_BROADCAST:this.iconClass="user icon-user-add-gray-flat";break;case n.Models.ChatActivity.LEFT_JOINED_BROADCAST:this.iconClass="user icon-user-add-gray-flat";break;case n.Models.ChatActivity.JOINED_LEFT_BROADCAST:this.iconClass="user icon-user-remove-gray-flat";break;case n.Models.ChatActivity.SUGGESTION_ADDED:break;case n.Models.ChatActivity.SUGGESTION_APPROVED:this.iconClass="upvote icon-upvote-color-flat";break;case n.Models.ChatActivity.SONG_CHANGED:var o=this.model.get("song"),u=r.model.get("player").get("currentQueue");o.get("isActiveSong")&&u&&!u.get("isBroadcasting")&&s.push("has-buttons")}var a=this.model.get("specialFlag");a&&s.push("chat-"+a),this.model.get("closeable")&&s.push("closeable"),this.isAdminLoggedIn=n.Models.Comment.ADMINS[n.getLoggedInUserID()],this.classes=s.join(" "),this.$el.addClass(this.classes),e||this.render()},onDownvoteClick:function(e){var t=r.model.get("player").get("currentQueue"),i=t.get("currentBroadcast"),s=this.model.get("song");if(!i)return;if(t.get("isBroadcasting"))return;var o=i.get("activeSong");s instanceof n.Models.BroadcastSong&&o&&s.get("queueSongID")===o.get("queueSongID")&&(s.get("userVote")===-1?i.voteActiveSong(0):i.voteActiveSong(-1))},onUpvoteClick:function(e){var t=r.model.get("player").get("currentQueue"),i=t.get("currentBroadcast"),s=this.model.get("song");if(!i)return;if(t.get("isBroadcasting"))return;var o=i.get("activeSong");s instanceof n.Models.BroadcastSong&&o&&s.get("queueSongID")===o.get("queueSongID")?s.get("userVote")===1?i.voteActiveSong(0):i.voteActiveSong(1):s instanceof n.Models.BroadcastSuggestion&&(s.get("userVote")<1?i.suggestSong(s):i.removeSuggestion(s))},onApproveClick:function(e){var t=r.model.get("player").get("currentQueue"),n=t.get("currentBroadcast"),i=this.model.get("song");if(!n)return;t.get("isBroadcasting")&&n.approveSuggestedSong(i)},onPlayClick:function(e){e.preventDefault(),e.stopPropagation();var r=this.model.get("song");if(!r)return;return n.trigger("player:addSongs",[r._wrapped||r],t,!0,new n.Models.PlayContext),!1},onEnableChatClick:function(e){var t=$(e.currentTarget),i=r.model.get("player").get("currentQueue"),s=i?i.get("currentBroadcast"):null,o=_.eventToGUTSCoords(e);o.broadcastID=s?s.get("BroadcastID"):"",s&&!s.get("chatEnabled")&&(s.updateBroadcastPreferences(!0,s.get("suggestionsEnabled")),n.trigger("guts:log","broadcastEnableChatClicked",o))},onBroadcastUserOptionsClick:function(e){var t=$(e.currentTarget),n=this.model.get("user"),i=r.model.get("player").get("currentQueue"),s=this.model.get("type")=="message"?this.model.get("message"):null,o=i?i.get("currentBroadcast"):null;o&&n&&t.jjmenu(e,n.getBroadcastOptionMenu(o,!1,this.model.get("specialFlag"),s),null,{xposition:"left",yposition:"auto",show:"default",keepState:t})},onFavChange:function(){var e=this.author.get("isFavorite"),t=this.$el.find(".favorite"),n=t?t.find(".icon"):null;e?(t.addClass("btn-success"),n.removeClass("icon-plus-small-gray-flat"),n.addClass("icon-check-white-flat")):(t.removeClass("btn-success"),n.removeClass("icon-check-white-flat"),n.addClass("icon-plus-small-gray-flat"))},canShowUserActions:function(){var e=this.model.get("user"),t=e&&e.get("UserID"),r=n.getCurrentBroadcast(),i=r&&r.checkPermissionsForUserID(n.getLoggedInUserID(),n.Models.Broadcast.VIP_PERM_CHAT_MODERATE),s=this.model.get("specialFlag")==="owner",o=n.Models.Comment.ADMINS[t],u=r&&r.isUserVIP(t);if(!e||this.model.get("type")!=="message")return!1;if(this.isBroadcasting||this.isAdminLoggedIn||i){if(s||o)return!1;if(i&&!u)return!0;if(this.isBroadcasting||this.isAdminLoggedIn)return!0}return!1}}),n.Views.Modules.CalloutRow=n.Views.Modules.Base.extend({className:"module module-row callout grid-item",cacheKey:"CalloutRow",templateFile:"calloutRow",changeModelSelectors:{"&":function(e,t){},".title":function(e,t){_.$one(t).innerText(this.model.get("Name"))},".play-btn-container":function(e,t){_.$one(t)[this.model.get("transcoded")?"removeClass":"addClass"]("hide")},".spinner":function(e,t){_.$one(t)[this.model.get("transcoded")?"addClass":"removeClass"]("hide")},".duration":function(e,t){_.$one(t).innerText(_.millisToMinutesSeconds(this.model.get("EstimateDuration")*1e3))},".module-progress":function(e,t){_.$one(t)[this.model.get("transcoded")?"addClass":"removeClass"]("hide")},".progress-complete":function(e,t){_.$one(t).width(Math.min(this.model.get("uploadPercent")/100,1)*100+"%")}},initialize:function(e){this._super.apply(this,["initialize"].concat(_.toArray(arguments)));var t=this.changeModelSelectors[".progress-complete"];_.isFunction(t)&&t.call(this,0,this.$el.find(".progress-complete"))}}),n.Views.Modules.Dropdown=n.Views.Modules.Base.extend({className:"module dropdown",cacheKey:"Dropdown",templateFile:"dropdown",events:{"click .btn":"dropdownClick"},options:{items:[{value:"",title:"",selected:!0}],tooltipOptions:{},onSelect:function(){}},initialize:function(){this.model=new Backbone.Model,this.tooltipOpen=!1,this.tooltipOptions=_.defaults(this.options.tooltipOptions,{width:150,persist:!0,scrollable:$("body"),tooltipKey:"generic-tooltip",tooltipClass:"menu"}),this.tooltip=new n.Views.Tooltips.Menu({items:this.options.items,tooltipKey:this.tooltipOptions.tooltipKey,onItemClick:_.bind(this.itemClick,this)}),this.tooltipOptions.views=[this.tooltip];var e=_.findWhere(this.options.items,{selected:!0});e||(this.options.items[0].selected=!0),$(document).on("click."+this.cid,_.bind(function(e){var t=this.$el.has(e.target).length>0,n=this.tooltip&&this.tooltip.$el.has(e.target).length>0;!t&&!n&&this.hideTooltip()},this))},onDestroy:function(){$(document).off("click."+this.cid),this.hideTooltip(),this.tooltip=null},render:function(){var e=this._super.apply(this,["render"].concat(_.toArray(arguments)));return e.done(_.bind(this.showSelection,this)),e},select:function(e){var t=_.findWhere(this.options.items,{value:e});t&&(_.each(this.options.items,function(e){e.selected=!1}),t.selected=!0,this.showSelection(),this.options.onSelect(e))},selected:function(){return _.findWhere(this.options.items,{selected:!0}).value},showSelection:function(){var e=_.findWhere(this.options.items,{selected:!0});this.$el.find(".title").text(e.title)},itemClick:function(e){this.select(e.value),this.hideTooltip()},dropdownClick:function(e){this.tooltipOpen?this.hideTooltip():this.showTooltip()},showTooltip:function(){var e=this.$(".btn");n.trigger("tooltip:open",_.extend(this.tooltipOptions,{$attached:e})),e.addClass("active"),this.tooltipOpen=!0},hideTooltip:function(){this.tooltip&&this.tooltip.closeTooltip(),this.$(".btn").removeClass("active"),this.tooltipOpen=!1}}),n.Views.Modules.TagDropdown=n.Views.Modules.Base.extend({className:"module tag-dropdown",cacheKey:"TagDropdown",templateFile:"tagDropdown",events:{"click #broadcast-tag":"onBroadcastTagClick"},changeModelSelectors:{"&":function(e,t){},"#broadcast-tag":function(e,t){this.updateSelectedTag()}},initialize:function(){$(document).click(_.bind(this.onDocumentClick,this)),this.model=_.orEqual(this.model,new Backbone.Model),this.options.saveOnSelection=_.orEqual(this.options.saveOnSelection,!0),this.options.onSelection=_.orEqual(this.options.onSelection,function(){}),this.options.defaultTagName=_.orEqual(this.options.defaultTagName,_.getString("BROADCAST_DEFAULT_TAG")),this.options.tooltipKey=_.orEqual(this.options.tooltipKey,"broadcast-tag-tooltip"),this.options.defaultTags=_.orEqual(this.options.defaultTags,!1),this.options.capitalize=_.orEqual(this.options.capitalize,!1),this._super.apply(this,["initialize"].concat(_.toArray(arguments)))},render:function(){var e=this._super.apply(this,["render"].concat(_.toArray(arguments)));return e.done(_.bind(this.updateSelectedTag,this)),e},onDestroy:function(){this.closeTooltip()},onDocumentClick:function(e){var t=this.$el.has(e.target).length>0,n=this.tagTooltip&&this.tagTooltip.$el.has(e.target).length>0;!t&&!n&&this.closeTooltip()},closeTooltip:function(){this.tagTooltip&&this.tagTooltip.closeTooltip()},getNamedTag:function(e){if(e&&this.tags&&this.tags[e])return{n:e,i:this.tags[e]};if(e===_.getString("BROADCAST_DEFAULT_TAG"))return null},getSelectedTag:function(){var e=this.$el.find("#broadcast-tag").data("tag");return this.getNamedTag(e)},updateSelectedTag:function(){var e=this.model.get("Tag"),t=e?e.n:this.options.defaultTagName;this.$el.find("#broadcast-tag").data("tag",t).find(".name").text(t)},showBroadcastTagTooltip:function(e,i){this.tags=_.clone(i);var s=r.model.get("player").get("currentQueue"),o=s&&s.get("songs"),u=o&&_.filter(o.pluck("Tags"),function(e){return!!e}),a={},f,l,c;_.each(u,function(e){e.each(function(e){var t=e.get("TagID");a[t]?a[t][1]+=1:a[t]=[e,1]})}),f=_.pluck(_.sortBy(a,"1").slice(0,3),"0"),f=new n.Models.Collections.Tags(f),l=f.map(function(e){return(e.get("Tag")||"").toLowerCase()}),this.options.defaultTags?c=this.options.defaultTags:(c=[],c.unshift(_.getString("BROADCAST_DEFAULT_TAG")),this.options.defaultTagName!==_.getString("BROADCAST_DEFAULT_TAG")&&c.unshift(this.options.defaultTagName),c=c.concat(l),c=c.concat(_.difference(_.pluck(n.Models.Tag.topGenres,"tag"),l))),_.each(n.Models.Tag.topGenres,_.bind(function(e){this.tags[e.tag]=e.tagID},this)),f.each(_.bind(function(e){this.tags[e.get("Tag").toLowerCase()]=e.get("TagID")},this)),this.tagTooltip=new n.Views.Tooltips.BroadcastTag({model:this.model instanceof n.Models.Broadcast?this.model:t,tooltipKey:this.options.tooltipKey,tags:this.tags,defaultTags:c,capitalize:this.options.capitalize,submit:_.bind(this.onNewTagChosen,this)}),n.trigger("tooltip:open",{views:[this.tagTooltip],$attached:e,persist:!0,y:"bottom",notch:"top",tooltipClass:this.options.tooltipKey,tooltipKey:this.options.tooltipKey,width:_.max([e.outerWidth(),150])}),e.addClass("active"),$(document).on("keydown."+this.cid,_.bind(this.focusFilterInput,this));var h=this.tagTooltip.onDestroy;this.tagTooltip.onDestroy=_.bind(function(){e.removeClass("active"),$(document).off("keydown."+this.cid),h.apply(this.tagTooltip,_.toArray(arguments)),this.tagTooltip=null},this)},focusFilterInput:function(e){var t=e.which.toString(),n=e.metaKey||e.ctrlKey,r=_.keys(_.playerShortcuts),i=_.keys(_.specialKeys);_.indexOf(r,t)===-1&&_.indexOf(i,t)===-1&&!n&&$(".broadcast-tag-tooltip .tag-filter").focus()},onNewTagChosen:function(e){e=e.toLowerCase();var t=this.getNamedTag(e);if(_.isUndefined(t)){console.warn("tag missing!",e,t,this.tags);return}this.options.saveOnSelection&&this.model instanceof n.Models.Broadcast?this.model.updateBroadcastDetails(null,t):(this.$el.find("#broadcast-tag").data("tag",e).find(".name").text(this.options.capitalize?_.ucwords(e):e),this.options.onSelection(e,t?t.i:null))},onBroadcastTagClick:function(e){if(this.tagTooltip){this.tagTooltip.closeTooltip();return}var t=$(e.currentTarget);this.tagsDfd||(this.tagsDfd=n.Models.Tag.getTagList()),this.tagsDfd.done(_.bind(this.showBroadcastTagTooltip,this,t)).fail(function(){n.trigger("notification:add",{title:_.getString("POPUP_FAILED_TO_GET_TAGS"),type:"error"})})}}),n.Views.Modules.GenreSelector=n.Views.Modules.Base.extend({templateFile:"genreSelector",events:{"click .genre-btns > .btn":"genreBtnClick"},initialize:function(){this.model=new Backbone.Model({genres:this.options.genres,tag:"all",tagID:"all"}),this.childViews=[]},render:function(){return this.fetchTemplate(this.templateFile).always(_.bind(this.onTemplate,this))},onTemplate:function(e){this.$el.html(this.renderTemplate(e,{})),this.renderButtons().done(_.bind(function(){this.renderCurrentSelection(),this.model.on("change",this.renderCurrentSelection,this)},this))},renderButtons:function(){var e=this.$(".genre-btns"),t=$('<a class="btn"></a>'),r=e.find(".module.tag-dropdown"),i=this.$el.width(),s=_.clone(this.model.get("genres")),o;return r.before(t.clone().text(_.getString("ALL_GENRES")).data({tag:"all",tagID:"all"})),_.each(_.clone(s),function(n){r.before(t.clone().text(_.ucwords(n.tag)).data(n));if(e.outerWidth()>=i)return r.prev().remove(),!1;s.shift()}),o=new n.Views.Modules.TagDropdown({el:r,tooltipKey:"broadcast-tag-tooltip broadcasts-page-tooltip",saveOnSelection:!1,onSelection:_.bind(this.genreDropdownSelect,this),defaultTagName:_.getString("CHOOSE_ONE"),defaultTags:_.pluck(s,"tag"),capitalize:!0}),this.childViews.push(o),o.render()},renderCurrentSelection:function(e,t){var n=this.$(".btn"),r=this.model.get("tag"),i=this.model.get("tagID");if(t&&_.isBoolean(t.render)&&!t.render)return;n.removeClass("selected"),n.each(function(e,t){var n=$(t);if(n.data("tagID")==i)return n.addClass("selected"),!1;if(n.hasClass("dropdown"))return n.addClass("selected").find(".name").text(_.ucwords(r)),!1})},genreBtnClick:function(e){var t=this.$(".btn"),n=$(e.currentTarget);t.removeClass("selected"),n.addClass("selected"),this.model.set(n.data(),{render:!1})},genreDropdownSelect:function(e,t){var n=this.$(".btn"),r=this.$(".btn.dropdown");t&&(n.removeClass("selected"),r.addClass("selected"),this.model.set({tag:e,tagID:t},{render:!1}))}})}(),function(){n.Views=n.Views||{},n.Views.Modules=n.Views.Modules||{},n.Views.Modules.FeedEvent=n.Views.Modules.Base.extend({className:"module-feed-event",cacheKey:"FeedEvent",templateFile:"feedEvent",maxItems:12,canComment:!0,useObjectNames:!1,skipComments:!1,events:{"click .feed-options":"onFeedOptionClick","click .feed-play":"onFeedPlayClick","click .feed-add":"onFeedAddClick","click .feed-content":"onFeedEventClick","click .feed-favorite":"onFeedFavoriteClick","click .feed-respond-cta":"feedCommentOpen","submit .module-item-respond":"commentSubmit","click .delete-response-cta":"deleteComment","click .delete-event-cta":"deleteEvent","click .open-user-profile":"openUser"},initialize:function(e){this.$el.data("event",this.model),this.user=_.orEqual(e.user,r.model.get("user")),this.maxItems=_.orEqual(e.maxItems,this.maxItems),this.canComment=_.orEqual(e.canComment,!0),this.canRemove=_.orEqual(e.canRemove,this.model.canRemove()),this.useObjectNames=_.orEqual(e.useObjectNames,this.useObjectNames),this.feedCommentsOpened=!1,this.isShare=!1;var t=this.model.get("data");if(this.model.get("activityName")=="broadcast"&&t&&(t.users||t.people)){var i=new n.Models.Collections.Users(t.users||t.people,{updateProfile:!1});i.length==1&&i.get(n.getLoggedInUserID())&&(this.isShare=!0)}this.model.on("change:comments",this.renderNewComment,this),this.model.on("destroy",this.destroy,this),n.on("locale:changed",this.render,this),(this.templateFile=="communityFeedEvent"||this.templateFile=="singleFeedEvent")&&n.on("manatee:broadcastEnded",this.render,this)},destroy:function(){n.off("locale:changed",null,this),n.off("manatee:broadcastEnded",null,this),this._super.apply(this,["destroy"].concat(_.toArray(arguments)))},renderNewComment:function(){this.render(),this.feedCommentsOpened&&this.feedCommentOpen()},render:function(){var e=_.toArray(arguments);return this.model.getNormalizedObject(this.useObjectNames,!1,this.skipComments).done(_.bind(function(t){t&&(this.templateData=t,this._super.apply(this,["render"].concat(e)))},this))},completeRender:function(e){this.templateData.maxItems=this.maxItems,this.templateData.addStreamType="TYPE_ACTIVITY",this.isShare&&(this.templateData.addStreamType+=",TYPE_SHARE"),r.model.get("user").getFollowers().done(_.bind(function(){this.templateData.canComment=this.canComment&&this.model.canComment(),this.templateData.canRemove=this.canRemove&&this.model.canRemove(),this.$el.html(this.renderTemplate(e,this.templateData))},this)),this.checkButton()},checkButton:function(){var e=this.model.get("playlistID"),t=this.model.get("artistID"),r=this.model.get("userID");if(e||t||r){var i,s,o,u=this.$(".feed-favorite");e?(i="Playlist",s=e):t?(i="Artist",s=t):r&&(i="User",s=r),o=n.Models[i].getCached(s),o&&this.updateButton(u,i,o.get("isFavorite"))}},updateButton:function(e,t,n){var r="",i=e.find("span");if(t==="Playlist")r=n?"SUBSCRIBED":"SUBSCRIBE";else if(t==="Artist"||t==="User")r=n?"FOLLOWING":"FOLLOW";i.text(_.getString(r)),i.data("translateText",r),n?(e.addClass("btn-success"),e.find(".icon").addClass("icon-check-white-active").removeClass("icon-plus-gray")):(e.removeClass("btn-success"),e.find(".icon").removeClass("icon-check-white-active").addClass("icon-plus-gray"))},feedCommentOpen:function(e){var t=this.$el.find(".module-item-respond").removeClass("hide");e&&(e.preventDefault(),$("input",t).focus(),this.feedCommentsOpened=!0)},commentSubmit:function(e){function o(){s.storeComment(i).done(function(){r.val(""),r.removeClass("pending")})}e.preventDefault();var t=$(e.currentTarget),r=$("input",t),i=r.val(),s=this.model;if(r.hasClass("pending")||!i)return;n.getLoggedInUserID()>0?o.call(this):n.trigger("lightbox:open","login",{message:_.getString("LB_LOGIN_MUST_LOGIN_TO_COMMENT"),onLogin:_.bind(o,this),onClose:function(){r.removeClass("pending")}}),r.addClass("pending")},deleteEvent:function(e){e.preventDefault();var t=$(e.currentTarget);this.model.hideEvent()},deleteComment:function(e){e.preventDefault();var t=$(e.currentTarget),n=t.parents(".response-content").data("commentId");this.model.hideComment(n)},openUser:function(e){var t=$(e.currentTarget).data("userId");n.Models.User.get(t).done(function(e){n.router.setHash(e.toUrl())})},onFeedFavoriteClick:function(e){var t=$(e.currentTarget),r=t.data("playlistId"),i=t.data("artistId"),s=t.data("userId"),o,u;r?(o="Playlist",u=r):i?(o="Artist",u=i):s&&(o="User",u=s),n.Models[o].get(u).done(_.bind(function(e){var n="favorite";e.get("isFavorite")&&(n="unfavorite"),this.user[n](o+"s",u).done(_.bind(function(){this.updateButton(t,o,e.get("isFavorite"))},this))},this))},onFeedOptionClick:function(e){var t=$(e.currentTarget);t.jjmenu(e,this.getOptionMenu(),null,{xposition:"left",yposition:"auto",show:"default",className:"feed-option",keepState:t})},onFeedAddClick:function(e){var t=$(e.currentTarget);t.jjmenu(e,this.getAddMenu(),null,{xposition:"left",yposition:"auto",show:"default",className:"feed-add",keepState:t})},onFeedPlayClick:function(e){var t=$(e.currentTarget);t.jjmenu(e,this.getPlayMenu(),null,{xposition:"left",yposition:"auto",show:"default",className:"feed-play",keepState:t})},getPlayMenu:function(e){var t=this.isShare,r,i=_.bind(function(){var e=$.Deferred();if(this.templateData.itemType==="song"){var i=[],s=this.model.get("data").songs;for(var o=0;o<s.length;o++)i.push(_.orEqual(s[o].SongID,s[o].songID));r=new n.Models.PlayContext,r.addStreamType(n.Models.PlayContext.TYPE_ACTIVITY),t&&r.addStreamType(n.Models.PlayContext.TYPE_SHARE),e.resolve({songIDs:i,context:r})}else if(this.templateData.itemType==="playlist"){if(this.model.get("data").playlists){var u=n.Models.Playlist.wrapFeedData(this.model.get("data").playlists[0]);if(!u)return;r=new n.Models.PlayContext(u),r.addStreamType(n.Models.PlayContext.TYPE_ACTIVITY),t&&r.addStreamType(n.Models.PlayContext.TYPE_SHARE),u.getSongs().done(function(){if(u.get("songs")){var t=u.get("songs").pluck("SongID");e.resolve({songIDs:t,context:r})}})}}else if(this.templateData.itemType==="album"){var a=n.Models.Album.getCached(this.templateData.item.id);if(!a)return;r=new n.Models.PlayContext(a),r.addStreamType(n.Models.PlayContext.TYPE_ACTIVITY),t&&r.addStreamType(n.Models.PlayContext.TYPE_SHARE),a.getSongs().done(function(){if(a.get("songs")){var t=a.get("songs").pluck("SongID");e.resolve({songIDs:t,context:r})}})}return e.promise()},this),s=[];return this.templateData.itemType==="song"?s.push({key:"PLAY_NOW",title:_.getString("PLAY_NOW"),action:{type:"fn",callback:function(){i().done(function(e){n.trigger("player:addSongs",e.songIDs,n.Services.SWF.playSpecialIndexes.DEFAULT,!0,e.context)})}},customClass:"jj_menu_item_play"},{key:"PLAY_NEXT",title:_.getString("PLAY_NEXT"),action:{type:"fn",callback:function(){i().done(function(e){n.trigger("player:addSongs",e.songIDs,n.Services.SWF.playSpecialIndexes.NEXT,!1,e.context)})}},customClass:"jj_menu_item_play_next"},{key:"PLAY_LAST",title:_.getString("PLAY_LAST"),action:{type:"fn",callback:function(){i().done(function(e){n.trigger("player:addSongs",e.songIDs,n.Services.SWF.playSpecialIndexes.LAST,!1,e.context)})}},customClass:"jj_menu_item_play_last"}):this.templateData.itemType==="playlist"?s.push({key:"PLAY_PLAYLIST",title:_.getString("PLAY_PLAYLIST"),action:{type:"fn",callback:function(){i().done(function(e){n.trigger("player:addSongs",e.songIDs,n.Services.SWF.playSpecialIndexes.DEFAULT,!0,e.context)})}},customClass:"jj_menu_item_play"}):this.templateData.itemType==="album"&&s.push({key:"PLAY_ALBUM",title:_.getString("PLAY_ALBUM"),action:{type:"fn",callback:function(){i().done(function(e){n.trigger("player:addSongs",e.songIDs,n.Services.SWF.playSpecialIndexes.DEFAULT,!0,e.context)})}},customClass:"jj_menu_item_play"}),s.push({customClass:"separator"},{key:"REPLACE_QUEUE",title:_.getString("REPLACE_QUEUE"),action:{type:"fn",callback:function(){i().done(function(e){n.trigger("player:addSongs",e.songIDs,n.Services.SWF.playSpecialIndexes.REPLACE,!0,e.context)})}},customClass:"jj_menu_item_replace_playlist"},{key:"START_RADIO",title:_.getString("START_RADIO"),action:{type:"fn",callback:function(){i().done(function(e){n.trigger("player:startRadioWithSongs",e.songIDs,e.context)})}},customClass:"jj_menu_item_sucks"}),s},getAddMenu:function(){var e=[],t=this.model.get("data").songs,r=n.Models.User.getCached(n.getLoggedInUserID()),i=this.isShare;for(var s=0;s<t.length;s++)n.Models.Song.newOrUpdate(t[s]),e.push(t[s].SongID||t[s].songID);var o=[{key:"CONTEXT_ADD_TO_QUEUE",title:_.getString("CONTEXT_ADD_TO_QUEUE"),action:{type:"fn",callback:function(){var t=new n.Models.PlayContext;t.addStreamType(n.Models.PlayContext.TYPE_ACTIVITY),i&&t.addStreamType(n.Models.PlayContext.TYPE_SHARE),n.trigger("player:addSongs",e,n.Services.SWF.playSpecialIndexes.LAST,!1,t)}},customClass:"jj_menu_item_now_playing"},{key:"ADD_TO_COLLECTION",title:_.getString("ADD_TO_COLLECTION"),action:{type:"fn",callback:function(){r.addSongsToLibrary(e)}},customClass:"jj_menu_item_music"}];return t.length==1&&!t[0].isFavorite&&o.push({key:"CONTEXT_ADD_TO_FAVORITES",title:_.getString("CONTEXT_ADD_TO_FAVORITES"),action:{type:"fn",callback:function(){r.favorite("Songs",e)}},customClass:"jj_menu_item_favorites"}),o.push({key:"CONTEXT_ADD_TO_PLAYLIST",title:_.getString("CONTEXT_ADD_TO_PLAYLIST"),type:"sub",src:r.getPlaylistsMenu(!1,!0,{songs:e},function(t){t.addSongs(e,null,!0)}),customClass:"jj_menu_item_add_playlist jj_menu_item_more"}),o},onFeedEventClick:function(e){var t=$(".module-feed-event").index($(e.target).closest(".module-feed-event"))+1,r=$(e.target).closest(".feed-content").data("type");n.trigger("guts:log","feedEventClick",{rank:t,eventType:r})},getOptionMenu:function(){var e=[],t=this.isShare,r;return this.templateData.itemType==="song"?e.push({key:"SELECTION_PLAY_ALL",title:_.getString("SELECTION_PLAY_ALL"),customClass:"jj_menu_item_play_all",action:{type:"fn",callback:_.bind(function(){var e=[],i=this.model.get("data").songs;r=new n.Models.PlayContext,r.addStreamType(n.Models.PlayContext.TYPE_ACTIVITY),t&&r.addStreamType(n.Models.PlayContext.TYPE_SHARE);for(var s=0;s<i.length;s++)e.push(_.orEqual(i[s].SongID,i[s].songID));n.trigger("player:addSongs",e,n.Services.SWF.playSpecialIndexes.DEFAULT,!0,r)},this)}}):this.templateData.itemType==="album"?e.push({key:"PLAY_ALBUM",title:_.getString("PLAY_ALBUM"),customClass:"jj_menu_item_play_all",action:{type:"fn",callback:_.bind(function(){var e=n.Models.Album.getCached(this.templateData.item.id);if(!e)return;r=new n.Models.PlayContext(e),r.addStreamType(n.Models.PlayContext.TYPE_ACTIVITY),t&&r.addStreamType(n.Models.PlayContext.TYPE_SHARE),e.getSongs().done(function(){if(e.get("songs")){var t=e.get("songs").pluck("SongID");n.trigger("player:addSongs",t,n.Services.SWF.playSpecialIndexes.DEFAULT,!0,r)}})},this)}}):this.templateData.itemType==="playlist"&&e.push({key:"PLAY_PLAYLIST",title:_.getString("PLAY_PLAYLIST"),customClass:"jj_menu_item_play_all",action:{type:"fn",callback:_.bind(function(){if(this.model.get("data").playlists){var e=n.Models.Playlist.wrapFeedData(this.model.get("data").playlists[0]);if(!e)return;r=new n.Models.PlayContext(e),r.addStreamType(n.Models.PlayContext.TYPE_ACTIVITY),t&&r.addStreamType(n.Models.PlayContext.TYPE_SHARE),e.getSongs().done(function(){if(e.get("songs")){var t=e.get("songs").pluck("SongID");n.trigger("player:addSongs",t,n.Services.SWF.playSpecialIndexes.DEFAULT,!0,r)}})}},this)}}),n.getLoggedInUserID()>0&&e.push({key:this.model.getIsUserOnEvent(n.getLoggedInUserID())?"REMOVE":"HIDE",title:this.model.getIsUserOnEvent(n.getLoggedInUserID())?_.getString("REMOVE"):_.getString("HIDE"),customClass:"jj_menu_item_delete",action:{type:"fn",callback:_.bind(function(){this.model.hideEvent(this.model.get("EventID"))},this)}}),e}}),n.Views.Modules.InterestingFeedEvent=n.Views.Modules.FeedEvent.extend({className:"module-feed-event",cacheKey:"CommunityFeedEvent",templateFile:"communityFeedEvent",maxItems:20,canComment:!1}),n.Views.Modules.CommunityFeedEvent=n.Views.Modules.FeedEvent.extend({className:"module-feed-event",cacheKey:"CommunityFeedEvent",templateFile:"communityFeedEvent"}),n.Views.Modules.CommunityCommentTypeFeedEvent=n.Views.Modules.CommunityFeedEvent.extend({className:"module-feed-event",cacheKey:"CommunityCommentTypeFeedEvent",templateFile:"communityCommentTypeFeedEvent"}),n.Views.Modules.SmallFeedEvent=n.Views.Modules.FeedEvent.extend({className:"module-feed-event module-small-feed-event",cacheKey:"SmallFeedEvent",templateFile:"smallFeedEvent",useObjectNames:!0,skipComments:!0,feedCommentOpen:function(e){var t=this.$el.find(".feed-comments-container").removeClass("hide");e&&(e.preventDefault(),$("input",t).focus(),this.feedCommentsOpened=!0)}}),n.Views.Modules.SingleFeedEvent=n.Views.Modules.FeedEvent.extend({className:"module-feed-event",cacheKey:"SingleFeedEvent",templateFile:"singleFeedEvent",initialize:function(e){this.$relatedContentEl=e.$relatedContentEl,this._super.apply(this,["initialize"].concat(_.toArray(arguments)))},completeRender:function(){this.loadRelatedContent(),this._super.apply(this,["completeRender"].concat(_.toArray(arguments)))},loadRelatedContent:function(){if(!this.templateData||!this.$relatedContentEl)return;var e=$.Deferred(),t=this.templateData,r,i,s;switch(t.itemType){case"playlist":if(!t.items&&t.item){var o=t.item.model;if(o){var u=n.Models.User.newOrUpdate({UserID:o.get("UserID"),Name:o.get("UserName")},{updateProfile:!1});r="playlist",s=u.getPlaylists(100),i={playlist:o,owner:u}}}break;case"artist":if(!t.items&&t.item){var a=n.Models.Artist.getCached(t.item.id);a&&(r="similarArtists",s=a.getSimilarArtists(),i={artist:a})}break;case"album":if(!t.items&&t.item){var f=n.Models.Album.getCached(t.item.id);f&&(r="topAlbumSongs",s=f.getSongs(),i={album:f})}break;case"song":if(!t.items&&t.item){var l=n.Models.Song.getCached(t.item.id);if(l){var c=n.Models.Artist.newOrUpdate({ArtistID:l.get("ArtistID"),ArtistName:l.get("ArtistName")});r="topArtistSongs",s=c.getSongs(),i={song:l,artist:c}}}}if(!!r){var h=_.chainLoading();h.push(this.fetchTemplate("/shared/digests/"+r+"Digest").done(h.bind(function(e){i.template=e}))),h.push(s.done(h.bind(this.renderRelatedContent,this,r,i)))}},renderRelatedContent:function(e,t,r){if(!t.template||!r||!this.$relatedContentEl)return;var i,s,o;switch(e){case"topArtistSongs":var u=t.artist;i=u.get("songs"),t.songs=(i&&i.models||[]).sort(n.Models.Song.popularSort).slice(0,3);if(!t.songs.length)return;break;case"topAlbumSongs":var a=t.album;i=a.get("songs"),t.songs=(i&&i.models||[]).sort(n.Models.Song.popularSort).slice(0,3);if(!t.songs.length)return;break;case"playlist":var f=t.owner;s=f.get("playlists"),t.playlists=(s&&s.models||[]).slice(0,3);if(!t.playlists.length)return;break;case"similarArtists":o=t.artist.get("similarArtists"),t.artists=(o&&o.models||[]).slice(0,3);if(!t.artists.length)return}var l=t.template;delete t.template,this.$relatedContentEl.html(this.renderTemplate(l,t))}})}();var n=typeof n!="undefined"?n:{};(function(){n.Views=n.Views||{};var e=function(e){var t=document.createElement("div").style,n=["ms","Webkit","Moz","O"],r=n.length,i,s;if(e in t)return e;while(r--){i=n[r]+e;if(i in t){s=i;break}}return s},i=e("Transform"),s={dimension:["width","height"],item:["itemWidth","itemHeight"],outer:["outerWidth","outerHeight"],inner:["innerWidth","innerHeight"],direction:["left","top"],scrollDir:["scrollLeft","scrollTop"]},o=.75;$.browser.msie&&$.browser.version<9&&(o=.4),n.Views.Grid=Backbone.View.extend({templatePath:"grid",events:{"click .grid-column":"handleColumnClick","click .grid-resize.resizable":"handleResizeClick","click .grid-item":"handleItemClickProxy","dblclick .grid-item":"handleItemDblclick","selectstart .grid-column":"handleSelectStart","selectstart .grid-item":"handleSelectStart","mousedown .grid-resize.resizable":"handleResizeEvents","contextmenu .grid-item":"handleContextMenuClick"},defaults:{axis:"y",itemHeight:15,bufferBefore:o,bufferAfter:o,itemsPerRow:1,header:!0,multiSelect:!1,allowMultiSelect:!1,keepSelectionOnFilter:!1,pageEl:"#page-wrapper",variableSize:!1,ignorePageClick:!1},rendered:!1,initialize:function(){_.defaults(this.options,this.defaults),this.options.axis=this.options.axis=="x"?"x":"y";var e=this.options.axis=="x"?0:1,t=this.options.axis=="x"?1:0,r={},i={};_.each(s,function(n,s){r[s]=n[e],i[s]=n[t]}),this.axisTranslations=r,this.axisTranslationsAntonyms=i,this.createdHeaders=!1,this.renderers=[],this.rendererDfds=[];var o=this.options.parentGrid;this.selectedItems=o?o.selectedItems:new Backbone.Collection,this.$viewport=$('<div class="grid-viewport" style="position: relative;"><div class="grid-canvas" style="position: absolute;"></div></div>'),this.$canvas=$(this.$viewport[0].childNodes[0]),this.options.header&&(this.$header=$('<div class="grid-header module-row-header"></div>')),this.options.variableSize&&this.$el.addClass("variable");var u=Math.ceil(screen[this.axisTranslations.dimension]/this.options[this.axisTranslations.item]*this.options.itemsPerRow);this.options.maximumVisibleItems?(this.maximumVisibleItems=this.options.maximumVisibleItems,this.bufferBefore=0,this.bufferAfter=0,this.blockSize=this.options.maximumVisibleItems):(this.maximumVisibleItems=Math.ceil(u*(1+this.options.bufferBefore+this.options.bufferAfter)),this.bufferBefore=Math.floor(u*this.options.bufferBefore),this.bufferAfter=Math.floor(u*this.options.bufferAfter),this.blockSize=Math.floor((this.maximumVisibleItems-this.bufferBefore)/2)),this.options.scrollElement?this.$scrollElement=this.options.scrollElement:this.$scrollElement=_.getScrollableParent(this.$el),this.scrollOffset=0,this.selectedItems.on("reset sort",function(e,t){var n=t&&t.removed,r,i;if(!n||this.parentGrid)n=_.difference(t.previousModels,e.models);if(n&&n.length)for(r=0,i=n.length;r<i;r++)n[r].trigger(this.cid+":deselect");for(r=0,i=e.models.length;r<i;r++)e.models[r].trigger(this.cid+":select")},this),this.selectedItems.on("add",function(e,t,n){e.trigger(this.cid+":select")},this),this.selectedItems.on("remove",function(e,t,n){e.trigger(this.cid+":deselect")},this),$("body").on("keydown."+this.cid,_.bind(this.handleKeydown,this)),this.options.ignorePageClick||$(this.options.pageEl).on("click."+this.cid,_.bind(this.handlePageElClick,this)),this.$scrollElement.on("scroll."+this.cid,_.animationThrottle(this.handleScroll,this)),this.visibleCollection=new this.collection.constructor(this.collection.models),this.collection.on("add",function(e,t,n){n.at=n.at||t.indexOf(e),this.visibleCollection.add(e,n)},this),this.collection.on("remove",function(e,t,n){this.visibleCollection.remove(e,n)},this),this.collection.on("reset sort",function(e,t){this.visibleCollection.reset(e.models)},this),this.visibleCollection.on("reset sort",function(e,t){this.handleScroll({force:!0})},this),this.options.keepSelectionOnFilter||this.visibleCollection.on("remove reset sort",_.bind(function(){var e=this.selectedItems.toArray(),t=_.intersection(e,this.visibleCollection.toArray()),n=_.difference(e,t);this.selectedItems.remove(n)},this)),this.$el.data({view:this});var a=this;this.visibleCollection.on("add remove reset",_.debounce(_.bind(a.resize,a),100),this),this.visibleCollection.on("add remove",_.debounce(_.bind(a.handleScroll,a,{force:!0}),100),this),n.on("page:redrawUpdate",this.recalculateScrollOffset,this)},onDestroy:function(){this.collection.off("add remove reset sort",null,this),this.visibleCollection.off("add remove reset sort",null,this),this.selectedItems.off("add remove reset sort",null,this),this.$el.removeClass("grid-"+this.cid),this.$style&&this.$style.remove(),_.$one("body").off("keydown."+this.cid),_.$one(this.options.pageEl).off("click."+this.cid),this.$scrollElement.off("scroll."+this.cid),this.$el.data({view:t});var e=this.options.variableSize;_.each(this.renderers,function(t){e&&t.off("resized",null,this),t.destroy&&t.destroy()}),_.$one(document).off("mousemove."+this.cid),_.$one(document).off("mouseup."+this.cid),_.$one(document).off("selectstart."+this.cid),n.off("page:redrawUpdate",null,this)},getRenderer:function(e,t){var n;if(this.renderers[e])return n=this.renderers[e],t&&!n.changeModel?n.model=t:t&&t!==n.model&&n.changeModel&&n.changeModel(t,{selected:this.selectedItems.indexOf(t)!==-1}),n;if(t&&this._firstRender)n=new this.options.itemRenderer({grid:this,model:t,addClass:this.options.addRowClass}),this.options.variableSize&&n.on("resized",_.debounce(_.bind(this.moduleResized,this),100),this),this.renderers[e]=n,this.$canvas.append(n.$el),n.render();else if(t)return n={status:1,model:t,grid:this,options:{grid:this},renderDfd:$.Deferred(),show:function(){this.status=1},hide:function(){this.status=0},renderTemplate:Backbone.View.prototype.renderTemplate},this.renderers[e]=n,this.rendererDfds[e]=n.renderDfd,n;return null},renderRenderers:function(e){var t=0,n=this.renderers.length,r=this.options.itemRenderer||{},i=r.prototype||{},s=i.className,o="",u=[],a,f,l,c;for(;t<n;t++)a=this.renderers[t],a.model?o=a.renderTemplate(_.bind(e,a)):o="",u.push('<div class="'+s+'">'+o+"</div>");c=$(u.join("")),this.$canvas.append(c),c=c.toArray();for(t=0;t<n;t++){f=this.renderers[t];if(!f.model||f instanceof r)continue;l=c.shift(),l||(l=$('<div class="'+s+'"></div>'),this.$canvas.append(l)),a=new this.options.itemRenderer({el:l,grid:this,model:f.model,addClass:this.options.addRowClass}),this.options.variableSize&&a.on("resized",_.debounce(_.bind(this.moduleResized,this),100),this),this.renderers[t]=a,a.renderDfd||(a.renderDfd=this.rendererDfds[t]),a.completeRender(e,{skipHTML:!0}),f.status||a.hide()}this._firstRender=!0},recalculateScrollOffset:function(){if(this.destroyed)return;try{var e=0,t=this.$el,n=this.$el,r=0;do r++,t[0]&&t[0]==n[0]&&(e+=t.position()[this.axisTranslations.direction],n=n.offsetParent()),t=t.parent();while(t[0]!=this.$scrollElement[0]&&r<1e4);e+=this.$scrollElement[this.axisTranslations.scrollDir](),this.scrollOffset=e}catch(i){console.error("failed to recalculateScrollOffset: grid"+this.cid,this.$el[0].className,i)}},render:function(){var e=0,n=[];_.each(this.visibleCollection.first(this.maximumVisibleItems),_.bind(function(t){var r=this.getRenderer(e,t);n.push(r.renderDfd),e++},this));var r=this.options.itemRenderer.prototype,i=r.cacheKey,s=r.templateFile,o=r.templatePath;this.options.itemRenderer.precacheTemplate(i,s,o).done(_.bind(this.renderRenderers,this)),this.recalculateScrollOffset(),this.$el.addClass("grid-"+this.cid),this.createHeaders(),this.$el.append(this.options.header?this.$header:t,this.$viewport),this.resize(),this.writeCSS(),$.after(n).done(_.bind(function(){this.rendered||(this.rendered=!0,this.trigger("rendered"),this.writeCSS())},this))},refresh:function(){var e=0,t=this.maximumVisibleItems,n;for(;e<t;e++)n=this.getRenderer(e),n&&n.renderDfd.then(_.bind(n.handleModelChange,n))},resize:function(){var e=Math.ceil(this.visibleCollection.length/this.options.itemsPerRow),t={position:"relative"},n=0,r;if(this.options.variableSize){var i=this.options.itemRenderer.estimateSize;for(var s=0,o=this.visibleCollection.length;s<o;s++)n+=i(this.visibleCollection.at(s),this,!1)}else n=e*this.options[this.axisTranslations.item];r=n+(this.options.header?this.$header[this.axisTranslations.dimension]():0),r!=this.lastDimensionSize&&(t[this.axisTranslations.dimension]=r,this.lastDimensionSize=r),this.$el.css(t),this.trigger("resized")},moduleResized:function(){this.resize(),this.options.overrideScroll||this.handleScroll({force:!0})},writeCSS:function(){var e=[],t=this.cid,n=0,r=this.renderers.length&&this.renderers[0].$el,i=function(e,t){if($("body").hasClass("is-ie7")){if(!r)return;var n=(r.find(t).css("padding")||"").replace(/px/g,"").split(" ");switch(n.length){case 1:e-=(n[0]-0)*2;break;case 2:e-=(n[1]-0)*2;break;case 4:e-=n[1]-0+(n[3]-0)}}return e};if(this.$columns)this.$columns.each(function(r,s){var o=_.$one(s).data(),u=_.$one(s).width(),a=i(u,o.resizeSelector);e.push([".grid-",t," ",o.resizeSelector," { width:",a,"px !important;left: "+n+"px !important; }"].join("")),n+=u});else if(this.columns){var s;_.each(this.columns,function(r){s=i(r.width,r.selector),e.push([".grid-",t," ",r.selector," { width:",s,"px !important;left: "+n+"px !important; }"].join("")),n+=r.width})}if(e.length||this.$style){this.$style||(this.$style=$('<style type="text/css"></style>'),$("head").append(this.$style));var o=e.join("\n");o!=this._lastCSSRules&&(this._lastCSSRules=o,this.$style[0].styleSheet?this.$style[0].styleSheet.cssText=this._lastCSSRules:this.$style[0].appendChild(document.createTextNode(this._lastCSSRules)))}},createHeaders:function(){if(!this.options.columns||!this.options.columns.length||this.createdHeaders)return;this.columns=[];var e=this.options.header!==!1,t=[],n=[],r=this.columns||[],i=this.options.columns||[],s=this.$el.width(),o=0,u,a,f,l,c,h,p,d,v,m,g,y;for(l=0,c=i.length;l<c;l++)h=_.clone(i[l]),r[l]=h,h.resizable=h.resizable!==!1,h.minimumSize=h.minimumSize||10,h.width=Math.max(h.minimumSize,h.width||h.percent*s||10),o+=h.width;u=Math.max(0,o-s),a=Math.abs(Math.min(0,o-s));for(l=0,c=r.length;l<c;l++)h=r[l],p=h.resizable,d=h.minimumSize,v=h.width,p&&u&&d<v?(m=r[l+1]||{},g=u,y=Math.floor(g/2),m.resizable&&m.minimumSize<m.width-y&&(g=Math.ceil(g/2)),g>d&&(g=v-d),v-=g,u-=g):p&&a&&(m=r[l+1]||{},g=a,m.resizable&&(g=Math.ceil(g/2)),v+=g,a-=g),h.width=v,e&&(f='<div class="module-row-column grid-column" style="width:'+v+'px;float:left;"><a class="header-link"><span'+(h.locale?' data-translate-text="'+h.locale+'"':"")+">"+(_.getString(h.locale)||"&nbsp;")+'<i class="caret"></i></span></a><div class="grid-resize drag-handle '+(p?"resizable":"")+'"></div></div>',n.push(f),t.push({columnKey:l,sortKey:h.sortKey,resizable:p,minimumSize:d,resizeSelector:h.selector}));if(e){this.$columns=$(n.join(""));for(l=0,c=this.$columns.length;l<c;l++)_.$one(this.$columns[l]).data(t[l]);this.$header.append(this.$columns)}this.createdHeaders=!0},getScrollPositionToShowItem:function(e,t){t=_.orEqual(t,!1);if(!this.visibleCollection)return-1;e=this.visibleCollection.find(function(t){return t.id==e.id});var n=this.visibleCollection.indexOf(e);if(n==-1)return-1;this.options.itemsPerRow>1&&(n+=n%this.options.itemsPerRow);var r=this.$scrollElement[this.axisTranslations.dimension](),i=Math.max(0,this.options[this.axisTranslations.item]*this.visibleCollection.length-r),s=Math.floor(r/this.options[this.axisTranslations.item]);return t&&(n=Math.max(0,n-s/2)),Math.min(i,n*this.options[this.axisTranslations.item])},getMaxScrollPos:function(){var e=this.$scrollElement[this.axisTranslations.dimension]();return Math.max(0,this.options[this.axisTranslations.item]*this.visibleCollection.length-e)},indexFromScrollPosition:function(e){if(this.options.variableSize){var t=this.options.itemRenderer.estimateSize,n=0,r=0,i=this.visibleCollection.length;for(;r<i;r++){n+=t(this.visibleCollection.at(r),this);if(n>=e)return r}}return Math.floor(e/this.options[this.axisTranslations.item])*this.options.itemsPerRow},offsetFromIndex:function(e){if(this.options.variableSize){var t=this.options.itemRenderer.estimateSize,n=0,r=0;for(;r<e;r++)n+=t(this.visibleCollection.at(r),this);return n}return Math.ceil(e*this.options[this.axisTranslations.item]/this.options.itemsPerRow)},handleScroll:function(e){var t;this.options.overrideScrollPos&&(t=this.options.overrideScrollPos()),t=t||e&&(e.overrideScrollPos||e.overrideScrollPos===0&&.1)||this.$scrollElement[this.axisTranslations.scrollDir]()-this.scrollOffset;var n=this.indexFromScrollPosition(_.toInt(t)),r,s;n=Math.max(0,Math.floor(Math.min(n,this.visibleCollection.length-this.bufferAfter)/this.blockSize)*this.blockSize),this.options.itemsPerRow>1&&(n-=n%this.options.itemsPerRow);if(this.lastScrollIndex==n&&(e&&e.force!==!0||!e))return;this.lastScrollIndex=n;for(var o=0,u=this.maximumVisibleItems,a=n;o<u;o++,a++){s=this.visibleCollection.models[a],r=this.getRenderer(o,s);if(!r)continue;s?r.show():r.hide()}var f=this.offsetFromIndex(n);if(f!=this.lastOffset){if(i){var l;this.axisTranslations.direction==="top"?l=["translate(0, ",this.offsetFromIndex(n),"px)"].join(""):l=["translate(",this.offsetFromIndex(n),"px, 0)"].join(""),this.$canvas.css(i,l)}else this.$canvas.css(this.axisTranslations.direction,this.offsetFromIndex(n));this.lastOffset=f}this.visibleCollection.length&&!this.rendered&&(this.rendered=!0,this.trigger("rendered"))},handleItemClick:function(e){if(!$(e.target).is("a")&&!$(e.target).parents("a").length){e.preventDefault();var t=jQuery.data(e.currentTarget,"module"),n=t.model;this.handleItemEvent(e,n)}},handleItemClickProxy:function(e){var t=jQuery.data(e.currentTarget,"module");if(!this.lastClick||this.lastClick[0]!=t||e.timeStamp-this.lastClick[1]>300)this.lastClick=[t,e.timeStamp],this.handleItemClick(e)},handleItemDblclick:function(e){f(e)},handleColumnClick:function(e){e.stopPropagation(),e.preventDefault();var t=$(e.currentTarget),n=t.data(),r=n.sortKey;if(!r)return;this.sort(r)},handleContextMenuClick:function(e){var t=$(e.currentTarget),r=t.data("module"),i=r.model,s={},o,u,a,f,l;(!this.selectedItems.length||this.selectedItems.indexOf(i)==-1)&&this.handleItemEvent(e,i),a=this.selectedItems.length;if(t.hasClass("song"))l="Song";else if(t.hasClass("queue-item"))f="Song",l="QueueSong";else if(t.hasClass("artist"))l="Artist";else if(t.hasClass("album"))l="Album";else if(t.hasClass("playlist"))l="Playlist";else{if(!t.hasClass("user"))return!1;l="User"}f=f||l,this.options.playContext&&(s.playContext=this.options.playContext);if(this.contextMenuExtra||this.options.contextMenuExtra)s=_.extend(s,this.contextMenuExtra?this.contextMenuExtra:this.options.contextMenuExtra);if(a==1){if(l=="QueueSong"||s.source=="nowPlaying"){s.isQueue=!0,s.queueSongClickedID=i.get("queueSongID"),s.queueSongClickedQueueSongID=i.get("queueSongID"),s.autoplayEnabled=i.get("songQueueHelper").autoplayEnabled;function c(){n.trigger("player:removeSongs",[i])}s.onRemoveFromQueue=c}if(!i)return!1;this.options.playlist&&(s.playlist=this.options.playlist,s.playlistSongID=i.get("playlistSongID")),u="getContextMenuFor"+f,o=i}else if(l=="Song"){this.options.playContext&&this.options.playContext.type=="playlist"&&(s.playlist=this.options.playlist,s.playlistSongIDS=this.selectedItems.pluck("playlistSongID"));if(s.source=="nowPlaying"){var h=this.selectedItems.toArray();function p(){n.trigger("player:removeSongs",h)}s.onRemoveFromQueue=p}u="getMultiContextMenuFor"+f+"s",o=this.selectedItems.toArray()}var d={extra:s,menuOptions:{xposition:"mouse",yposition:"mouse",show:"show",className:"contextmenu",shouldLog:!0}};return _.asyncMenu(e,t,d,o,u),!1},sort:function(e,t,r,i){if(i){i.songStats.sort(function(e,t){return i.sortKey===i.lastMetric&&!i.reversed?_.toInt(e[i.sortKey])-_.toInt(t[i.sortKey]):_.toInt(t[i.sortKey])-_.toInt(e[i.sortKey])}),i.gridOptions.selectedStatColumn=i.columnSelected,songs=new n.Models.Collections.Songs(i.songStats),this.collection.reset(songs.models),i.filterVal&&this.filter(i.filterVal),_.each(this.renderers,function(e){e.handleModelChange()}),i.sortKey===i.lastMetric&&!i.reversed?this.options.reversed=!0:this.options.reversed=!1,this.options.lastMetric=i.sortKey;return}this.lastSortColumn&&($(this.lastSortColumn).removeClass("desc asc"),this.lastSortColumn=null);if(_.isArray(e)){this.visibleCollection.comparator=null,this.lastSortKey=null,this.visibleCollection.reset(e,{sorted:!0});return}t||(this.lastSortKey!=e?r?t=r:t="asc":this.lastSortDir?t=this.lastSortDir=="desc"?"asc":"desc":t="asc"),!this.lastSortKey&&e=="default"&&(t="desc");if(e==="default"){this.visibleCollection.comparator=null,models=_.intersection(this.collection.models,this.visibleCollection.models),this.resetSortCaret(),t==="desc"&&models.reverse(),this.visibleCollection.reset(models,{sorted:!0}),this.lastSortKey=e,this.lastSortDir=t;return}var s=t=="asc"?1:-1,o=t=="asc"?-1:1,u=this.options.sortType;!u&&e=="TrackNum"?u="number":!u&&e=="TSAdded"&&(u="date");var a=function(t,n){var r=t.get(e),i=n.get(e);return _.isString(r)&&(r=r.toLowerCase()),_.isString(i)&&(i=i.toLowerCase()),r>i?s:o},f=function(t,n){var r=t.get(e),i=n.get(e);return r=_.toInt(r),i=_.toInt(i),r>i?s:o},l=function(t,n){var r=t.get(e),i=n.get(e);return r<i?s:o},c=null;this.options.getSortComparator&&(c=this.options.getSortComparator(e,t=="asc")),c?this.visibleCollection.comparator=c:u=="number"?this.visibleCollection.comparator=f:u=="date"?this.visibleCollection.comparator=l:this.visibleCollection.comparator=a;var h=0,p=this.$columns&&this.$columns.length,d;for(;h<p;h++)_.$one(this.$columns[h]).data("sortKey")==e&&(d=$(this.$columns[h]));d&&(d.removeClass(t=="asc"?"desc":"asc").addClass(t),this.lastSortColumn=d[0]),this.lastSortKey=e,this.lastSortDir=t,this.visibleCollection.sort({sorted:!0})},resetSortCaret:function(){$(".desc",this.$el).removeClass("desc"),$(".asc",this.$el).removeClass("asc"),this.lastSortDir=t,this.lastSortKey=t},filter:function(e,t){e=_.orEqual(e,"").toLowerCase(),t=_.defaults(_.orEqual(t,{}),{sorted:!0}),this.visibleCollection.reset(this.collection.filter(function(t){var n=t.get("searchText");return n&&n.indexOf(e)>-1}),t)},handleResizeClick:function(e){e.stopPropagation()},handleKeydown:function(e){if(this.options.isParentGrid||!this.selectedItems.length||$(e.target).is("input,textarea,select"))return!0;if(this.options.parentGrid)return!0;var t=this.visibleCollection.indexOf(this.selectedItems.lastSelect),n;switch(e.which){case 8:case 46:if(_.isFunction(this.options.onDelete)&&this.selectedItems.length){e.stopPropagation(),e.preventDefault(),this.options.onDelete(this.selectedItems);return}break;case 38:!e.metaKey&&!e.ctrlKey&&(n=Math.max(0,t-1));break;case 40:!e.metaKey&&!e.ctrlKey&&(n=Math.min(this.visibleCollection.length,t+1));break;case 65:if(e.metaKey||e.ctrlKey){e.stopPropagation(),e.preventDefault(),this.selectedItems.reset(this.visibleCollection.models);return}}if(typeof n!="undefined"){e.metaKey=e.ctrlKey=!1,e.stopPropagation(),e.preventDefault();var r=this.visibleCollection.models[n],i;if(!r)return;for(var s=0,o=this.renderers.length;s<o;s++)if(this.renderers[s].model==r){i=this.renderers[s];break}this.handleItemEvent(e,r);if(i){var u=i.$el.offset()[this.axisTranslations.direction],a=i.$el[this.axisTranslations.dimension](),f=this.$scrollElement.offset()[this.axisTranslations.direction],l=this.$scrollElement[this.axisTranslations.outer](),c=u-f,h=u-f+a-l,p;h>0?(p=this.$scrollElement[this.axisTranslations.scrollDir](),this.$scrollElement[this.axisTranslations.scrollDir](p+h)):c<0&&(p=this.$scrollElement[this.axisTranslations.scrollDir](),this.$scrollElement[this.axisTranslations.scrollDir](p+c))}}},handleItemEvent:function(e,t){if(this.options.isParentGrid)return;var n=this.visibleCollection.indexOf(t),r=this.selectedItems.lastSelect,i=this.selectedItems.lastSelectParent,s=$(e.currentTarget).data("module");this.selectedItems.lastSelect=t,this.options.parentModel&&(this.selectedItems.lastSelectParent=this.options.parentModel);if(s&&s.disabled)return;if((e.metaKey||e.ctrlKey||this.options.multiSelect)&&this.selectedItems.indexOf(t)!==-1){if(this.selectedItems.anchor){var o=this.visibleCollection.at(n+1),u=this.visibleCollection.at(n-1);this.selectedItems.indexOf(o)!==-1?this.selectedItems.anchor=o:this.selectedItems.indexOf(u)!==-1?this.selectedItems.anchor=u:this.selectedItems.anchor=null}this.selectedItems.remove(t);return}if(this.options.allowMultiSelect&&e.shiftKey&&this.selectedItems.anchor){var a=this.visibleCollection.indexOf(this.selectedItems.anchor),f=this.visibleCollection.indexOf(r),l=Math.min(n,a),c=Math.max(n,a),h=[],p=[],d;i?(d=this.options.getModelsBetweenPoints(i,r,this.options.parentModel,t),d&&d.length&&p.push.apply(p,d)):f<a?p.push.apply(p,this.visibleCollection.slice(f,a+1)):f>a&&p.push.apply(p,this.visibleCollection.slice(a+1,f+1)),this.options.parentGrid&&this.selectedItems.anchorParentModel!=this.options.parentModel&&(d=this.options.getModelsBetweenPoints(this.selectedItems.anchorParentModel,this.selectedItems.anchor,this.options.parentModel,t),d&&d.length&&(h.push.apply(h,d),l=0,c=-1)),l<=c&&h.push.apply(h,this.visibleCollection.slice(l,c+1)),this.selectedItems.remove(p),this.selectedItems.add(h);return}e.shiftKey||(this.selectedItems.anchor=t,this.selectedItems.anchorParentModel=this.options.parentModel),this.selectedItems.length&&(!this.options.allowMultiSelect||!e.metaKey&&!e.ctrlKey&&!e.shiftKey&&!this.options.multiSelect)?this.selectedItems.length>1||this.selectedItems.indexOf(t)==-1?this.selectedItems.reset(t,{removed:[].concat(this.selectedItems.models)}):this.selectedItems.reset([],{removed:[].concat(this.selectedItems.models)}):this.selectedItems.add(t)},handlePageElClick:function(e){if(!this.selectedItems.length||this.options.isParentGrid)return;var t=[this.$el.parent()[0]],n=$(e.target),r=!0;this.options.dontDeselectFor&&(t=t.concat(this.options.dontDeselectFor));while(n.length){if(_.indexOf(t,n[0])!=-1){r=!1;break}if(t.length===1&&_.$one(n[0]).hasClass("grid-viewport")&&n[0]!=this.$viewport[0])break;n=n.parent()}r&&this.selectedItems.reset([],{removed:this.selectedItems.models})},handleSelectStart:function(e){return e.preventDefault(),!1},handleResizeEvents:function(){var e=arguments[arguments.length-1],t=arguments.length>1?arguments[arguments.length-2]:null,n=t&&$(t)||$(e.currentTarget),r=n.parent(".grid-column"),i=r.next();switch(e.type){case"mousedown":n.data({resizeStart0:r.width(),resizeStart1:i.width(),resizeStartX:e.pageX}),_.$one(document).on("mousemove."+this.cid,_.bind(this.handleResizeEvents,this,e.currentTarget)),_.$one(document).on("mouseup."+this.cid,_.bind(this.handleResizeEvents,this,e.currentTarget)),_.$one(document).on("selectstart."+this.cid,_.bind(this.handleSelectStart,this));break;case"mousemove":var s=n.data();if(!s.resizeStart0)return;var o=e.pageX-s.resizeStartX,u=s.resizeStart0+o,a=s.resizeStart1-o,f=r.data(),l=i.data(),c=f&&f.minimumSize&&f.minimumSize-u,h=l&&l.minimumSize&&l.minimumSize-a,p=Math.max(0,c)||Math.min(0,h*-1);o+=p,r.width(s.resizeStart0+o),i.width(s.resizeStart1-o),this.writeCSS();break;case"mouseup":n.data("resizeStart0",null),_.$one(document).off("mousemove."+this.cid),_.$one(document).off("mouseup."+this.cid),_.$one(document).off("selectstart."+this.cid)}},onActiveSongChange:function(){}});var u={events:$.extend({},n.Views.Grid.prototype.events),defaults:$.extend({},n.Views.Grid.prototype.defaults,{canDragFrom:!1,canDragTo:!1,dropIndicatorType:"betweenRows",dropIsValid:null,acceptDrop:null,$dragListenOn:null,$dropListenOn:null}),initialize:function(){this._super.apply(this,["initialize"].concat(_.toArray(arguments))),this.createDragListeners()},onDestroy:function(){this._super.apply(this,["onDestroy"].concat(_.toArray(arguments))),this.removeDragListeners()},createDragListeners:function(e){var t=e||{};this.$dragListenOn=t.dragListenOn||this.options.dragListenOn||this.$el,this.$dropListenOn=t.dropListenOn||this.options.dropListenOn||this.$el,this.$dragListenOn.on("draginit."+this.cid,_.bind(this.handleDragInit,this)),this.$dragListenOn.on("dragstart."+this.cid,_.bind(this.handleDragStart,this)),this.$dragListenOn.on("drag."+this.cid,_.bind(this.handleDrag,this)),this.$dragListenOn.on("dragend."+this.cid,_.bind(this.handleDragEnd,this)),this.$dropListenOn.on("dropinit."+this.cid,_.bind(this.handleDropInit,this)),this.$dropListenOn.on("dropstart."+this.cid,_.bind(this.handleDropStart,this)),this.$dropListenOn.on("drop."+this.cid,_.bind(this.handleDrop,this)),this.$dropListenOn.on("dropend."+this.cid,_.bind(this.handleDropEnd,this))},removeDragListeners:function(){this.$dragListenOn.off("draginit."+this.cid),this.$dragListenOn.off("dragstart."+this.cid),this.$dragListenOn.off("drag."+this.cid),this.$dragListenOn.off("dragend."+this.cid),this.$dropListenOn.off("dropinit."+this.cid),this.$dropListenOn.off("dropstart."+this.cid),this.$dropListenOn.off("drop."+this.cid),this.$dropListenOn.off("dropend."+this.cid)},handleDragInit:function(e,t){var n=_.isFunction(this.options.canDragFrom)?this.options.canDragFrom.call(this):!!this.options.canDragFrom;if(!n)return!1},handleDragStart:function(e,t){var r=$(e.target);r.hasClass("grid-item")||(r=r.parents(".grid-item"));if(r.length){var i=r.data("module").model;this.selectedItems.indexOf(i)==-1&&r.click()}if(!this.selectedItems.length||!r.length)return!1;t.draggedItemsContext=this.options.playContext,t.draggedItems=this.selectedItems.toArray(),t.draggedItemsSource=this.cid;var s=$('<div class="grid-drag-proxy"/>').appendTo("body").mousewheel(_.globalDragProxyMousewheel);return s.html(this.itemsToDragProxy(t.draggedItems)),n.trigger("drag:start",t),s},handleDrag:function(e,t){_.globalDragHandler(e,t)},handleDragEnd:function(e,t){_.globalDragCleanup(e,t),n.trigger("drag:end",t)},handleDropInit:function(e,t){e.currentTarget.updateDropOnDrag=_.bind(this.handleDragOver,this)},handleDropStart:function(e,t){var n=_.isFunction(this.options.canDragTo)?this.options.canDragTo.call(this):!!this.options.canDragTo;if(!n||!t.draggedItems||t.draggedItems.length===0)return delete e.currentTarget.updateDropOnDrag,!1;if(this.options.dropIndicatorType=="betweenRows"){var r={display:"none"};r[this.options.axis]=0,r[this.axisTranslations.dimension]=2,r[this.axisTranslationsAntonyms.dimension]=this.$canvas[this.axisTranslationsAntonyms.inner](),this.lastDropIndex=-1,this.$dropIndicator=$("<div class='grid-drop-indicator'/>").css(r).appendTo(this.$viewport)}},handleDragOver:function(e,t){var n=this.dropIsValid(e,t);this.$dropListenOn.data("valid-drop",n),this.updateDropIndicator(e,t,n)},dropIsValid:function(e,t){return _.isFunction(this.options.dropIsValid)?this.options.dropIsValid.call(this,e,t):!1},updateDropIndicator:function(e,n,r){if(!r)this.lastDropIndex=-1,this.$dropIndicator&&this.$dropIndicator.hide();else switch(this.options.dropIndicatorType){case"onRow":$(".grid-item.drop-active",this.$viewport).removeClass("drop-active"),$(".grid-item",this.$viewport).within(e.clientX,e.clientY).eq(0).addClass("drop-active");break;case"betweenRows":var i,s=this.axisTranslations.direction;if(this.currentInsertIndex!==t)i=this.currentInsertIndex,delete this.currentInsertIndex;else{var o="client"+this.options.axis.toUpperCase(),u=e[o]-this.$viewport.offset()[s];i=Math.max(0,Math.min(Math.round(u/this.options[this.axisTranslations.item]),this.visibleCollection.length))}i!==this.lastDropIndex&&(this.lastDropIndex=i,this.$dropIndicator&&(this.$dropIndicator.css(s,i*this.options[this.axisTranslations.item]),this.$dropIndicator.show()))}},handleDropEnd:function(e,t){switch(this.options.dropIndicatorType){case"onRow":this.$viewport.find(".grid-item.drop-active").removeClass("drop-active");break;case"betweenRows":this.$dropIndicator&&(this.$dropIndicator.remove(),delete this.$dropIndicator)}},handleDrop:function(e,t){t.draggedItemsType=t.draggedItemsType||_.getCollectionType(t.draggedItems);var n=this.dropIsValid(e,t);if(!n||t.dropHandled)return;if(this.options.dropIndicatorType=="onRow"){var r=$(".grid-item",this.$viewport).within(e.clientX,e.clientY).eq(0);if(r.length){var i=r.data("module");if(i&&i.acceptDrop(t)){t.dropHandled=!0;return}}}t.dropHandled=this.acceptDrop(t)},itemsToDragProxy:function(e){var t="";if(_.isArray(e)&&e.length){var r=e[0];e.length>1?r instanceof n.Models.Song||r instanceof n.Models.PlaylistSong||r instanceof n.Models.QueueSong?t=_.getString("SELECTION_SONGS_COUNT",{count:e.length}):r instanceof n.Models.Playlist?t=_.getString("SELECTION_PLAYLIST_COUNT",{count:e.length}):r instanceof n.Models.Album?t=_.getString("SELECTION_ALBUM_COUNT",{count:e.length}):r instanceof n.Models.Artist?t=_.getString("SELECTION_ARTIST_COUNT",{count:e.length}):r instanceof n.Models.Broadcast?t=_.getString("SELECTION_ARTIST_COUNT",{count:e.length}):t=e.length+" Items":_.isFunction(r.toProxyLabel)?t=r.toProxyLabel():t=r.toString()}else t=e.toString();return['<div class="status"></div><span class="info"><span class="text">',t,"</span></span>"].join("")},acceptDrop:function(e){return _.isFunction(this.options.acceptDrop)?this.options.acceptDrop.call(this,e):!1}},a;a=$.extend({},u),a.defaults.canDragFrom=!0,n.Views.DraggableGrid=n.Views.Grid.extend(a),a=$.extend({},u),a.defaults.canDragTo=!0,n.Views.DroppableGrid=n.Views.Grid.extend(a),a=$.extend({},u),a.defaults.canDragFrom=!0,a.defaults.canDragTo=!0,n.Views.DraggableDroppableGrid=n.Views.Grid.extend(a);var f=function(e){if(!$(e.target).is("a")&&!$(e.target).parents("a").length){e.preventDefault(),e.stopPropagation();var t=jQuery.data(e.currentTarget,"module"),r=t.model,i=this.options.playContext;n.trigger("player:addSongs",[r],-1,!0,i)}return!1},l=function(e){var t=$(e.currentTarget),r=t.data("songId"),i=n.Models.Song.getCached(r),s=t.closest(".grid-item"),o;return s&&s[0]&&(o={currentTarget:s[0]}),{songID:r,song:i,gridItem:s,$el:t,fakeEvent:o}},c=function(e){var t=l(e);t.song&&!t.song.get("fromLibrary")&&t.fakeEvent&&n.trigger("guts:logsearch","OLlibraryClick",this,t.fakeEvent)},h=function(e){var t=l(e);t.fakeEvent&&n.trigger("guts:logsearch","OLartistPageLoad",this,t.fakeEvent)},p=function(e){var t=l(e);t.fakeEvent&&n.trigger("guts:logsearch","OLalbumPageLoad",this,t.fakeEvent)},d=function(e){var t=l(e);t.fakeEvent&&n.trigger("guts:logsearch","OLsongPageLoad",this,t.fakeEvent)},v=function(e){try{var t=l(e),i=r.model.get("player").get("currentQueue").get("songs").length;t.fakeEvent&&i===0?n.trigger("guts:logsearch","OLplayButton",this,t.fakeEvent):t.fakeEvent&&i===0&&n.trigger("guts:logsearch","OLaddButton",this,t.fakeEvent)}catch(s){console.log(s)}},m=function(e){var t=l(e);t.fakeEvent&&n.trigger("guts:logsearch","OLshareClick",this,t.fakeEvent)},g=function(e){var t=l(e);t.fakeEvent&&n.trigger("guts:logsearch","OLfavoriteClick",this,t.fakeEvent)},y=[{title:"",selector:".primary",minimumSize:41,visible:!1,resizable:!1},{title:"Song Name",selector:".module-row-cell.song",minimumSize:120,locale:"SONG_NAME",sortKey:"SongName"},{title:"Artist Name",selector:".artist",minimumSize:120,locale:"ARTIST_NAME",sortKey:"ArtistName"},{title:"Album Name",selector:".album",minimumSize:100,locale:"ALBUM_NAME",sortKey:"AlbumName"},{title:"Track",selector:".track-num",minimumSize:60,resizable:!1,locale:"TRACK",sortKey:"TrackNum",sortType:"number"},{title:"",selector:".secondary",minimumSize:95,visible:!1,resizable:!1}],b=y.slice(0,3).concat(y.slice(4)),w=y.slice(0,2).concat(y.slice(3)),E=y.slice(0),S=b.concat([]),x=w.concat([]),T=b.concat([]);S.splice(3,1),x.splice(3,1),E.splice(4,1),T.splice(2,1),n.Views.SongGrid=n.Views.DraggableDroppableGrid.extend({defaults:$.extend({},n.Views.DraggableDroppableGrid.prototype.defaults,{getSortComparator:n.Models.Song.getLayeredSort,itemRenderer:n.Views.Modules.SongRow,itemHeight:31,itemsPerRow:1,allowMultiSelect:!0,showCount:!0,columns:y,playlist:!1}),handleItemClick:function(e){this._super("handleItemClick",e)},handleItemDblclick:f,onLibraryClick:c,onArtistLinkClick:h,onAlbumLinkClick:p,onSongLinkClick:d,onSongPlayClick:v,onSongShareClick:m,onSongFavoriteClick:g}),n.Views.SongGrid.columnsNoAlbum=b,n.Views.SongGrid.columnsNoArtist=w,n.Views.SongGrid.columnsNoTrack=E,n.Views.SongGrid.columnsNoAlbumTrack=S,n.Views.SongGrid.columnsNoArtistTrack=x,n.Views.SongGrid.columnsNoAlbumArtist=T,n.Views.SongGridTall=n.Views.DraggableGrid.extend({defaults:$.extend({},n.Views.DraggableDroppableGrid.prototype.defaults,{getSortComparator:n.Models.Song.getLayeredSort,itemRenderer:n.Views.Modules.SongRowTall,itemHeight:51,itemsPerRow:1,allowMultiSelect:!0,showCount:!1}),handleItemDblclick:f,onLibraryClick:c,onArtistLinkClick:h,onAlbumLinkClick:p,onSongLinkClick:d,onSongPlayClick:v,onSongShareClick:m,onSongFavoriteClick:g}),n.Views.SongGridBlock=n.Views.DraggableGrid.extend({defaults:$.extend({},n.Views.DraggableDroppableGrid.prototype.defaults,{itemRenderer:n.Views.Modules.SongCell,itemHeight:178,itemsPerRow:3,header:!1}),handleItemDblclick:f,onLibraryClick:c,onArtistLinkClick:h,onAlbumLinkClick:p,onSongLinkClick:d,onSongPlayClick:v,onSongShareClick:m,onSongFavoriteClick:g}),n.Views.CalloutGrid=n.Views.Grid.extend({defaults:$.extend({},n.Views.Grid.prototype.defaults,{itemRenderer:n.Views.Modules.CalloutRow,itemHeight:32,itemsPerRow:1,allowMultiSelect:!1,header:!1}),handleItemClick:function(){}}),n.Views.ArtistDashboardSongsGrid=n.Views.Grid.extend({defaults:$.extend({},n.Views.Grid.prototype.defaults,{itemRenderer:n.Views.Modules.ArtistDashboardSongCell,itemHeight:51,itemsPerRow:1,header:!1})}),n.Views.ArtistDashboardSongsGridSmall=n.Views.DraggableGrid.extend({defaults:$.extend({},n.Views.DraggableGrid.prototype.defaults,{itemRenderer:n.Views.Modules.ArtistDashboardSongCellSmall,itemHeight:31,itemsPerRow:1,header:!1,allowMultiSelect:!0})}),n.Views.SongSuggestGrid=n.Views.DraggableGrid.extend({defaults:$.extend({},n.Views.DraggableDroppableGrid.prototype.defaults,{itemRenderer:n.Views.Modules.SongRowTall,itemHeight:51,itemsPerRow:1,allowMultiSelect:!0,showCount:!1}),handleItemClick:function(e){this.options.isBroadcastOwner&&this._super("handleItemClick",e)},handleItemDblclick:f}),n.Views.AlbumGrid=n.Views.DraggableGrid.extend({defaults:$.extend({},n.Views.DraggableGrid.prototype.defaults,{itemRenderer:n.Views.Modules.AlbumCellVertical,itemHeight:207,itemsPerRow:4,header:!1})}),n.Views.AlbumGridTall=n.Views.DraggableGrid.extend({defaults:$.extend({},n.Views.DraggableGrid.prototype.defaults,{itemRenderer:n.Views.Modules.AlbumRowTall,itemHeight:51,itemsPerRow:1,header:!1})}),n.Views.ArtistAlbumGrid=n.Views.Grid.extend({defaults:$.extend({},n.Views.Grid.prototype.defaults,{itemRenderer:n.Views.Modules.ArtistAlbumRow,variableSize:!0,itemHeight:157,itemsPerRow:1,header:!1,isParentGrid:!0})}),n.Views.PromotionAlbumBlock=n.Views.Grid.extend({defaults:$.extend({},n.Views.Grid.prototype.defaults,{itemRenderer:n.Views.Modules.PromotionAlbumCell,itemHeight:178,itemsPerRow:3,header:!1})}),n.Views.PromotionSongBlock=n.Views.Grid.extend({defaults:$.extend({},n.Views.Grid.prototype.defaults,{itemRenderer:n.Views.Modules.SongCell,itemHeight:178,itemsPerRow:4,header:!1})}),n.Views.TagGridBlock=n.Views.DraggableGrid.extend({defaults:$.extend({},n.Views.DraggableGrid.prototype.defaults,{itemRenderer:n.Views.Modules.TagCellVertical,itemHeight:151,itemsPerRow:4,header:!1})}),n.Views.UserArtistGrid=n.Views.Grid.extend({defaults:$.extend({},n.Views.Grid.prototype.defaults,{itemRenderer:n.Views.Modules.UserArtistCell,itemHeight:135,itemsPerRow:2,header:!1})}),n.Views.UserGridTall=n.Views.Grid.extend({defaults:$.extend({},n.Views.Grid.prototype.defaults,{itemRenderer:n.Views.Modules.UserRowTall,itemHeight:52,itemsPerRow:1,header:!1})}),n.Views.SuggestedUserGridTall=n.Views.UserGridTall.extend({defaults:$.extend({},n.Views.UserGridTall.prototype.defaults,{itemRenderer:n.Views.Modules.SuggestedUserRowTall,itemHeight:80})}),n.Views.MutualFriendGridTall=n.Views.UserGridTall.extend({defaults:$.extend({},n.Views.UserGridTall.prototype.defaults,{itemRenderer:n.Views.Modules.MutualFriendRow,itemHeight:64})}),n.Views.BroadcastUserGridTall=n.Views.Grid.extend({defaults:$.extend({},n.Views.Grid.prototype.defaults,{itemRenderer:n.Views.Modules.UserRowTall,itemHeight:52,itemsPerRow:1,header:!1}),handleItemClick:function(){},handleContextMenuClick:function(){}}),n.Views.ArtistAlbumGrid=n.Views.Grid.extend({defaults:$.extend({},n.Views.Grid.prototype.defaults,{itemRenderer:n.Views.Modules.ArtistAlbumRow,variableSize:!0,itemHeight:157,itemsPerRow:1,header:!1,isParentGrid:!0})}),n.Views.InviteUserGridCell=n.Views.Grid.extend({defaults:$.extend({},n.Views.Grid.prototype.defaults,{itemRenderer:n.Views.Modules.InviteUserCell,itemHeight:45,itemsPerRow:2,header:!1,multiSelect:!0,allowMultiSelect:!0})}),n.Views.ArtistDashboardTopFansGrid=n.Views.Grid.extend({defaults:$.extend({},n.Views.Grid.prototype.defaults,{itemRenderer:n.Views.Modules.ArtistDashboardTopFanCell,itemHeight:51,itemsPerRow:1,header:!1})}),n.Views.ArtistGrid=n.Views.DraggableGrid.extend({defaults:$.extend({},n.Views.DraggableGrid.prototype.defaults,{itemRenderer:n.Views.Modules.ArtistCellVertical,itemHeight:172,itemsPerRow:4,header:!1})}),n.Views.ArtistGridMini=n.Views.Grid.extend({defaults:$.extend({},n.Views.DraggableGrid.prototype.defaults,{itemRenderer:n.Views.Modules.ArtistRowMini,itemHeight:30,itemsPerRow:1,header:!1})}),n.Views.ArtistGridTall=n.Views.DraggableGrid.extend({defaults:$.extend({},n.Views.DraggableGrid.prototype.defaults,{itemRenderer:n.Views.Modules.ArtistRowTall,itemHeight:51,itemsPerRow:1,header:!1})}),n.Views.ArtistGridProfileCard=n.Views.Grid.extend({defaults:$.extend({},n.Views.Grid.prototype.defaults,{itemRenderer:n.Views.Modules.ArtistProfileCard,itemHeight:162,itemsPerRow:1,header:!1})}),n.Views.PlaylistGrid=n.Views.DraggableDroppableGrid.extend({defaults:$.extend({},n.Views.DraggableDroppableGrid.prototype.defaults,{itemRenderer:n.Views.Modules.PlaylistCell,itemHeight:140,itemsPerRow:2,dropIndicatorType:"onRow"}),dropIsValid:function(e,t){t.draggedItemsType=t.draggedItemsType||_.getCollectionType(t.draggedItems);var n=$(".grid-item",this.$viewport).within(e.clientX,e.clientY).eq(0);if(n.length&&t.draggedItemsType!=="playlist"){var r=n.data("module").model;if(r&&r.isEditable())return!0}return!1}}),n.Views.PlaylistGridSmall=n.Views.DraggableDroppableGrid.extend({defaults:$.extend({},n.Views.DraggableDroppableGrid.prototype.defaults,{itemRenderer:n.Views.Modules.PlaylistCellSmall,itemHeight:95,itemsPerRow:2,dropIndicatorType:"onRow"}),dropIsValid:function(e,t){t.draggedItemsType=t.draggedItemsType||_.getCollectionType(t.draggedItems);var n=$(".grid-item",this.$viewport).within(e.clientX,e.clientY).eq(0);if(n.length&&t.draggedItemsType!=="playlist"){var r=n.data("module").model;if(r&&r.isEditable())return!0}return!1}}),n.Views.BroadcastGridSmall=n.Views.Grid.extend({defaults:$.extend({},n.Views.Grid.prototype.defaults,{itemRenderer:n.Views.Modules.BroadcastCellSmall,itemHeight:95,itemsPerRow:2})}),n.Views.BroadcastRowTallGrid=n.Views.Grid.extend({defaults:$.extend({},n.Views.Grid.prototype.defaults,{itemRenderer:n.Views.Modules.BroadcastRowTall,itemHeight:51,itemsPerRow:1,header:!1,showCount:!1}),handleItemClick:function(){},handleContextMenuClick:function(){}}),n.Views.BroadcastGroupGrid=n.Views.Grid.extend({defaults:$.extend({},n.Views.Grid.prototype.defaults,{itemRenderer:n.Views.Modules.BroadcastGroupRow,variableSize:!0,itemHeight:112,itemsPerRow:1,header:!1,isParentGrid:!0})}),n.Views.BroadcastDateGrid=n.Views.Grid.extend({defaults:$.extend({},n.Views.Grid.prototype.defaults,{itemRenderer:n.Views.Modules.BroadcastRow,itemHeight:31,itemsPerRow:1,allowMultiSelect:!1,showCount:!0,columns:[{title:"",selector:".primary",minimumSize:26,visible:!1,resizable:!1},{title:"Date",selector:".module-row-cell.date",minimumSize:120,visible:!0,resizable:!0}],playlist:!1,handleItemClick:function(){},handleContextMenuClick:function(){}})}),n.Views.BroadcastSongRowTallGrid=n.Views.SongGridTall.extend({defaults:$.extend({},n.Views.Grid.prototype.defaults,{itemRenderer:n.Views.Modules.SongRowTall,itemHeight:51,itemsPerRow:1,header:!1}),handleContextMenuClick:function(e){var t=$(e.currentTarget),n=t.data("module"),r=n.model;return r.get("isCallout")?!1:this._super.apply(this,["handleContextMenuClick"].concat(_.toArray(arguments)))}}),n.Views.BroadcastGrid=n.Views.Grid.extend({defaults:$.extend({},n.Views.Grid.prototype.defaults,{itemRenderer:n.Views.Modules.BroadcastCell,itemHeight:180,itemsPerRow:3,header:!1}),initialize:function(){this._super.apply(this,["initialize"].concat(_.toArray(arguments))),this.collection.on("reset sort",_.bind(this.filterVisibleCollection,this))},filter:function(e){this.filterSearchText=_.orEqual(e,"").toLowerCase(),this.filterVisibleCollection()},filterByTag:function(e){this.filterTagID=e,this.filterVisibleCollection()},filterVisibleCollection:function(){var e={silent:!!this.filterTagID};this._super.apply(this,["filter",this.filterSearchText,e]),this.filterTagID&&this.visibleCollection.reset(this.visibleCollection.getForTag(this.filterTagID),{sorted:!0})}}),n.Views.BroadcastRowLargeGrid=n.Views.BroadcastGrid.extend({defaults:$.extend({},n.Views.BroadcastGrid.prototype.defaults,{itemRenderer:n.Views.Modules.BroadcastRowLarge,itemHeight:111,itemsPerRow:1,header:!1}),handleItemClick:function(){},handleContextMenuClick:function(){}}),n.Views.LeaderboardGrid=n.Views.BroadcastGrid.extend({defaults:$.extend({},n.Views.Grid.prototype.defaults,{itemRenderer:n.Views.Modules.LeaderboardRowTall,itemHeight:51,itemsPerRow:1,header:!1}),handleItemClick:function(){},handleContextMenuClick:function(){}}),n.Views.BroadcastsSidebarGrid=n.Views.DraggableDroppableGrid.extend({defaults:$.extend({},n.Views.DraggableDroppableGrid.prototype.defaults,{itemRenderer:n.Views.Modules.SidebarBroadcast,itemHeight:25,itemsPerRow:1,dropIndicatorType:"onRow",header:!1}),dropIsValid:function(e,t){return!1},handleDropInit:function(e,t){var n="dropinitScrollbarHandler",r=this.$el.parents(".scrollable"),i=r.data(n);t.$tinyScrollbars=t.$tinyScrollbars||[],r&&(!i||t.drop!==i)&&(t.$tinyScrollbars.push(r),r.data(n,t.drop)),this._super("handleDropInit",e,t)}}),n.Views.UserSidebarGrid=n.Views.DroppableGrid.extend({defaults:$.extend({},n.Views.Grid.prototype.defaults,{itemRenderer:n.Views.Modules.SidebarUser,itemHeight:40,itemsPerRow:1,canDragTo:!0,dropIndicatorType:"onRow",header:!1,variableSize:!0}),dropIsValid:function(e,t){t.draggedItemsType=t.draggedItemsType||_.getCollectionType(t.draggedItems);var n=["song","artist","album","playlist"];return t.draggedItems.length==1&&_.indexOf(n,t.draggedItemsType)!=-1},handleDropInit:function(e,t){var n="dropinitScrollbarHandler",r=this.$el.parents(".scrollable"),i=r.data(n);t.$tinyScrollbars=t.$tinyScrollbars||[],r&&(!i||t.drop!==i)&&(t.$tinyScrollbars.push(r),r.data(n,t.drop)),this._super("handleDropInit",e,t)}}),n.Views.PlaylistsSidebarGrid=n.Views.DraggableDroppableGrid.extend({defaults:$.extend({},n.Views.DraggableDroppableGrid.prototype.defaults,{itemRenderer:n.Views.Modules.SidebarPlaylist,itemHeight:25,itemsPerRow:1,dropIndicatorType:"onRow",header:!1}),dropIsValid:function(e,t){t.draggedItemsType=t.draggedItemsType||_.getCollectionType(t.draggedItems);var n=$(".grid-item",this.$viewport).within(e.clientX,e.clientY).eq(0);if(n.length&&t.draggedItemsType!=="playlist"&&t.draggedItemsType!=="broadcast"){var r=n.data("module").model;if(r&&r.isEditable())return!0}return!1},handleDropInit:function(e,t){var n="dropinitScrollbarHandler",r=this.$el.parents(".scrollable"),i=r.data(n);t.$tinyScrollbars=t.$tinyScrollbars||[],r&&(!i||t.drop!==i)&&(t.$tinyScrollbars.push(r),r.data(n,t.drop)),this._super("handleDropInit",e,t)}}),n.Views.PlaylistGridTall=n.Views.DraggableGrid.extend({defaults:$.extend({},n.Views.DraggableGrid.prototype.defaults,{itemRenderer:n.Views.Modules.PlaylistRowTall,itemHeight:51,itemsPerRow:1,header:!1})}),n.Views.PlaylistsFeaturedGrid=n.Views.DraggableGrid.extend({defaults:$.extend({},n.Views.DraggableGrid.prototype.defaults,{itemRenderer:n.Views.Modules.PlaylistCellBlock,itemHeight:140,itemsPerRow:7,header:!1})}),n.Views.EventGridTall=n.Views.DraggableGrid.extend({defaults:$.extend({},n.Views.DraggableGrid.prototype.defaults,{itemRenderer:n.Views.Modules.EventRowTall,itemHeight:51,itemsPerRow:1,header:!1})}),n.Views.VideoGrid=n.Views.Grid.extend({defaults:$.extend({},n.Views.Grid.prototype.defaults,{itemRenderer:n.Views.Modules.VideoCell,itemHeight:178,itemsPerRow:7,header:!1})}),n.Views.StationGrid=n.Views.Grid.extend({defaults:$.extend({},n.Views.Grid.prototype.defaults,{itemRenderer:n.Views.Modules.StationRow,itemHeight:30,itemsPerRow:1,header:!1}),handleItemClick:function(){},handleContextMenuClick:function(){},handleItemDblclick:function(e){var t=$(e.currentTarget).data("tagId");n.trigger("player:radio",!0,t),n.trigger("lightbox:close")}}),n.Views.TagGrid=n.Views.DraggableGrid.extend({defaults:$.extend({},n.Views.DraggableGrid.prototype.defaults,{itemRenderer:n.Views.Modules.TagRow,itemHeight:51,itemsPerRow:1,header:!1,hideRelatedGenresButton:!1}),handleItemClick:function(){},handleContextMenuClick:function(){},dropIsValid:function(e,t){return t.draggedItemsType=t.draggedItemsType||_.getCollectionType(t.draggedItems),console.log(e,t),!1}}),n.Views.ThemeGrid=n.Views.Grid.extend({defaults:$.extend({},n.Views.Grid.prototype.defaults,{itemRenderer:n.Views.Modules.ThemeCell,itemHeight:122,itemsPerRow:4,header:!1})}),n.Views.ThemeUserGrid=n.Views.Grid.extend({defaults:$.extend({},n.Views.Grid.prototype.defaults,{itemRenderer:n.Views.Modules.ThemeUserCell,itemHeight:49,itemsPerRow:4,header:!1})}),n.Views.QueueGrid=n.Views.DraggableDroppableGrid.extend({defaults:$.extend({},n.Views.DraggableDroppableGrid.prototype.defaults,{axis:"x",itemRenderer:n.Views.Modules.QueueSongCell,itemWidth:86,header:!1}),isObjectDropable:function(e){var t=this.model,r=t.get("currentQueue"),i=r?r.get("currentBroadcast"):null,s=r?r.get("isBroadcasting"):!1,o=r&&!0;if(o&&s&&e){var u=t.get("position"),a=t.get("duration");i.get("listenersCount")>n.Services.SWF.largeBroadcastThreshold&&r.get("nextSong")===e&&a&&a-u<n.Services.SWF.broadcastNextPreventPosition?o=!1:e.get("broadcastPlayed")&&(o=!1)}return o},isPositionDropable:function(e){var t=this.model.get("currentQueue"),n=t?t.get("isBroadcasting"):!1;if(n&&e){var r=t.get("songs");if(r&&e<=r.lastIndexOf(t.get("activeSong")))return!1}return!0},dropIsValid:function(e,t){t.draggedItemsType=t.draggedItemsType||_.getCollectionType(t.draggedItems);if(t.draggedItemsType==="song"&&t.draggedItems&&t.draggedItems.length){if(!this.isObjectDropable(t.draggedItems[0]))return!1}else if(!this.isObjectDropable())return!1;var n="client"+this.options.axis.toUpperCase(),r=this.axisTranslations.direction,i=e[n]-this.$viewport.offset()[r];return this.currentInsertIndex=Math.max(0,Math.min(Math.round(i/this.options[this.axisTranslations.item]),this.visibleCollection.length)),this.isPositionDropable(this.currentInsertIndex)},handleDropInit:function(e,t){var n="dropinitScrollbarHandler",r=this.$el.parents("#queue"),i=r.data(n);t.$tinyScrollbars=t.$tinyScrollbars||[],r&&(!i||t.drop!==i)&&(t.$tinyScrollbars.push(r),r.data(n,t.drop));var s=$(e.srcElement).closest(".queue-item"),o=this.isObjectDropable(s.length===1?s.data("module").model:null);this.$dropListenOn.data("valid-drop",o),this._super("handleDropInit",e,t)},acceptDrop:function(e){function u(e){return function(r){n.trigger("player:addSongs",r.toArray(),t+i,!1,e),i++}}e.draggedItemsType=e.draggedItemsType||_.getCollectionType(e.draggedItems);var t=this.lastDropIndex,i=0,s,o;switch(e.draggedItemsType){case"song":e.draggedItemsSource==this.cid?n.Services.SWF.moveSongsTo(_.pluck(e.draggedItems,"id"),t):n.trigger("player:addSongs",e.draggedItems,t,!1,e.draggedItemsContext);break;case"tag":var a=e.draggedItems[0];r.playGenre(a.get("DisplayName"),a.get("TagID"));break;case"album":case"artist":case"playlist":for(s=0;s<e.draggedItems.length;s++)o=e.draggedItems[s],_.isFunction(o.getSongs)&&o.getSongs().then(u(new n.Models.PlayContext(o)));break;case"user":for(s=0;s<e.draggedItems.length;s++)o=e.draggedItems[s],_.isFunction(o.getFavorites)&&o.getFavorites("Songs").then(u(new n.Models.PlayContext(o)));break;default:return!1}return!0}}),n.Views.NowPlayingGrid=n.Views.QueueGrid.extend({defaults:$.extend({},n.Views.QueueGrid.prototype.defaults,{itemRenderer:n.Views.Modules.SongRowTall,itemHeight:51,itemsPerRow:1,allowMultiSelect:!0,hidePlayButton:!0,axis:"y",itemWidth:null}),dropIsValid:function(e,t){return n.isBroadcaster()?!1:this._super("dropIsValid",e,t)},handleItemDblclick:function(e){if(!$(e.target).is("a")&&!$(e.target).parents("a").length){var t=$.data(e.currentTarget,"queueSongId");n.trigger("player:playSong",t)}},onLibraryClick:c,onArtistLinkClick:h,onAlbumLinkClick:p,onSongLinkClick:d,onSongPlayClick:v,onSongShareClick:m,onSongFavoriteClick:g})})(),function(){n.Views=n.Views||{},n.Views.GridToolbar=Backbone.View.extend({templatePath:"shared",events:{"click .btn":"onButtonClick","click .play-button":"onPlayClick","click .suggest-button":"onSuggestClick","click .play-menu":"onPlayMenuClick","click .add-button":"onAddClick","click .add-menu":"onAddMenuClick","click .sort-button":"onSortClick","click .playlist-new-button":"newPlaylist","click .all-music":"onAllMusicClick","click .favorites":"onFavoritesClick","keyup input.filter":"onFilterChange","submit form.search-bar":"onFilterSubmit","click .search-bar":"onSearchBarClick","click input.filter":"onFilterClick","click .clear-filter":"onClearFilterClick","focus input.search":"onFilterFocus","blur input.search":"onFilterBlur","click .delete-button":"onDeleteClick","click .invite-friends":"onInviteFriendsClick"},initialize:function(){this.$el._isSticky=!1,this.gridView=this.options.gridView,_.isArray(this.gridView)||(this.gridView=[this.gridView]),this.page=this.options.page,this.childViews=[],this.playContext=this.options.playContext,this.buttons={},_.isFunction(this.options.onButtonClick)&&(this.onButtonClick=this.options.onButtonClick),this.popularTimeRange=this.options.popularTimeRange,this.lastSort={type:this.page!="album"?"original":"track",dir:"asc"};switch(this.page){case"playlist":this.lastSort.label="PLAYLIST_ORDER";break;case"playlists":case"subscribedPlaylists":this.lastSort.label="PLAYLIST_LAST_EDITED";break;case"artist":this.lastSort.label="POPULARITY";break;case"album":this.lastSort.label="TRACK_NUM";break;case"tag":case"search":this.lastSort.label="RELEVANCE";break;case"userMusic":case"userMusicFavorites":this.lastSort.label="DATE_ADDED";break;case"dashboardAlbums":this.lastSort.label="PLAYS";break;default:this.lastSort.label=""}var e=this.options.buttons,t,r;for(t=0,r=e.length;t<r;t++)this.buttons[e[t]]=!0;(this.buttons.sort||this.buttons.filterSearch)&&this.changeGridView(this.gridView),this.buttons.btnGroupNav&&(this.btnGroupNavInfo=this.options.btnGroupNavInfo),this.buttons.primaryBtnGroupNav&&(this.primaryBtnGroupNavInfo=this.options.primaryBtnGroupNavInfo),this.buttons.dropdown&&(this.dropdownItems=this.options.dropdownItems),this.$scrollElem=$("#page-wrapper"),this.$scrollElem.on("scroll."+this.cid,_.animationThrottle(this.handleScroll,this)),n.on("page:redrawUpdate",this.calculateOffsetPosition,this),n.on("manatee:broadcastEnded",this.onBroadcastEnded,this)},onDestroy:function(){this.changeGridView(),this.gridView=[],this.$scrollElem&&this.$scrollElem.off("scroll."+this.cid),n.off("page:redrawUpdate",null,this),n.off("manatee:broadcastEnded",null,this)},changeGridView:function(e,t){t||this.clearFilter();var r,i,s;for(r=0,i=this.gridView.length;r<i;r++)s=this.gridView[r],s.selectedItems.off(null,null,this),s.visibleCollection.off(null,null,this),s.collection.off(null,null,this),s.off(null,null,this);if(e){this.currentOrder=[],_.isArray(e)||(e=[e]),this.gridView=e;for(r=0,i=this.gridView.length;r<i;r++)s=this.gridView[r],this.currentOrder.push(new s.collection.constructor(s.collection.models)),s.selectedItems.on("add remove reset",this.updateSelectionCount,this),s.visibleCollection.on("add remove reset sort",this.updateSortLabel,this),s.on("resized",function(){n.trigger("page:resize")},this);this.updateSelectionCount(),this.updateSortLabel()}this.onFilterChange()},render:function(){return this.fetchTemplate("gridToolbar").always(_.bind(this.onTemplate,this))},onTemplate:function(e){if(this.destroyed)return;this.$el.html(this.renderTemplate(e,this)),this.options.page=="userMusicFavorites"&&this.resetCollection(!0),this.buttons.tagDropdown&&(this.tagDropdown=new n.Views.Modules.TagDropdown({el:this.$el.find(".module.tag-dropdown")[0],tooltipKey:"broadcast-tag-tooltip",saveOnSelection:!1,onSelection:_.bind(this.onTagFilterChange,this),defaultTagName:_.getString("SEE_ALL_GENRES").toLowerCase()}),this.tagDropdown.render(),this.childViews.push(this.tagDropdown)),this.buttons.dropdown&&(this.dropdown=new n.Views.Modules.Dropdown({el:this.$el.find(".module.dropdown")[0],items:this.dropdownItems,tooltipOptions:{tooltipKey:"grid-toolbar-dropdown"},onSelect:this.options.dropdownSelect||function(){}}),this.dropdown.render(),this.childViews.push(this.dropdown)),this.updateSortLabel(),this.$el.show(),this.trigger("rendered"),this.calculateOffsetPosition(),this.trigger("rendered")},onTagFilterChange:function(e){e===this.tagDropdown.options.defaultTagName&&(e=!1);for(var t=0,n=this.gridView.length;t<n;t++)this.gridView[t].filterByTag(e)},calculateOffsetPosition:function(){if(!this.$el._isSticky)try{var e=0,t=this.$el,n=this.$el,r=0;do r++,t[0]&&t[0]==n[0]&&(e+=t.position().top,n=n.offsetParent()),t=t.parent();while(t[0]!=this.$scrollElem[0]&&r<1e4);e+=this.$scrollElem.scrollTop(),this.offset=e}catch(i){console.error("failed to calculateOffsetPosition: gridToolbar"+this.cid,this.$el[0].className,i)}},onBroadcastEnded:function(){this.$el.find(".suggest-button").addClass("hide"),this.$el.find("li>.add-menu").addClass("hide"),this.$el.find(".play-button").removeClass("hide"),this.$el.find(".play-menu").removeClass("hide"),this.$el.find(".add-button").removeClass("hide"),this.$el.find(".btn-group>.add-menu").removeClass("hide")},updateSelectionCount:function(){var e=0,t,n,r,i,s;for(var o=0,u=this.gridView.length;o<u;o++)e+=this.gridView[o].selectedItems.length;var a=e?" ("+e+")":"";e?(s="EDIT_COUNT",t=_.getString("ADD"),n=_.getString("PLAY"),r=_.getString("EDIT_COUNT",{count:e}),i=_.getString("SELECTION_DELETE")):(s="EDIT_ALL",t=_.getString("SELECTION_ADD_ALL"),n=_.getString("SELECTION_PLAY_ALL"),r=_.getString("EDIT_ALL"),i=_.getString("SELECTION_DELETE_ALL"));var f=$(".add-label"),l=$(".play-label"),c=$(".edit-label"),h=$(".delete-label");f.text(t+a),f.attr("data-translate-text",t),l.text(n+a),l.attr("data-translate-text",n),c.text(r),c.data({translateText:s,count:e}),h.text(i+a),h.attr("data-translate-text",i),a?($(".delete-button").removeClass("hide").addClass("show"),$(".suggest-button").removeClass("disabled")):($(".delete-button").addClass("hide").removeClass("show"),$(".suggest-button").addClass("disabled"))},updateSortLabel:function(){if(this.gridView&&this.gridView[0]&&!this.bypassGridSort)switch(this.gridView[0].lastSortKey){case"SongName":this.lastSort.label="SONG";break;case"ArtistName":this.lastSort.label="ARTIST";break;case"AlbumName":this.lastSort.label="ALBUM";break;case"TrackNum":this.lastSort.label="TRACK_NUM"}var e=$(".sort-label"),t=this.lastSort.label;e.attr("data-translate-text",t),e.text(_.getString(t))},resetCollection:function(e){var t,n=_.isFunction(this.options.favFilterFunction)?this.options.favFilterFunction:function(e){return e.get("isFavorite")};for(var r=0,i=this.gridView.length;r<i;r++)e?t=this.currentOrder[r].filter(n):t=this.currentOrder[r].models,this.gridView[r].collection.reset(t);var s=this.$el.find("input.filter").val("");s.siblings(".clear-filter").css({visibility:"hidden"})},clearFilter:function(){this.$el.find(".filter").val(""),this.onFilterChange()},onClearFilterClick:function(e){this.clearFilter(),n.trigger("guts:log","filterTextCancelClicked"),n.trigger("guts:gatrack","user","filterTextCancelClicked")},onDeleteClick:function(e){for(var t=0;t<this.gridView.length;t++){var n;this.gridView[t].selectedItems.length?n=this.gridView[t].selectedItems.toArray():n=this.gridView[t].visibleCollection.toArray(),n.length&&_.isFunction(this.gridView[t].options.onDelete)&&this.gridView[t].options.onDelete(n)}},newPlaylist:function(e){this.model.get("appModel").get("user").id>0?n.trigger("lightbox:open","createPlaylist"):n.trigger("lightbox:open","login",{message:_.getString("LB_LOGIN_MUST_LOGIN_TO_CREATE_PLAYLIST"),onLogin:function(e){n.trigger("lightbox:open","createPlaylist")}})},onPlayClick:function(e){e.preventDefault();var t=this.playContext?this.playContext.clone():new n.Models.PlayContext,r=this.getRelevantModels("song"),i=r.models,s=["search","artist","tag","popular"];!r.selectedModels.length&&_.indexOf(s,t.type)!=-1&&t.addStreamType(n.Models.PlayContext.TYPE_PLAY_ALL),n.trigger("player:addSongs",i,n.Services.SWF.playSpecialIndexes.DEFAULT,!0,t)},onPlayMenuClick:function(e){e.preventDefault();var t=$(e.currentTarget),n=this.getRelevantModels("song"),r={xposition:"left",yposition:"auto",show:"default",className:"contextmenu",keepState:t},i={extra:{selectedModels:n.selectedModels,playContext:this.playContext},menuOptions:r};_.asyncMenu(e,t,i,n.models,"getGridToolbarPlayMenu")},onSuggestClick:function(e){e.preventDefault();var t=$(e.currentTarget);if(t.hasClass("disabled"))return;var r=this.playContext,i=this.getRelevantModels("song"),s=i.models;n.trigger("player:addSongs",s,n.Services.SWF.playSpecialIndexes.LAST,!1,r)},onAddClick:function(e){e.preventDefault();var t=this.playContext,r=this.getRelevantModels("song"),i=r.models;n.trigger("player:addSongs",i,n.Services.SWF.playSpecialIndexes.LAST,!1,t)},onAddMenuClick:function(e){var t=$(e.currentTarget),n=this.getRelevantModels("song"),r={xposition:"left",yposition:"auto",show:"default",className:"contextmenu",keepState:t},i={extra:{selectedModels:n.selectedModels,playContext:this.playContext,fromQueue:_.orEqual(this.options.fromQueue,!1)},menuOptions:r};e.preventDefault(),_.asyncMenu(e,t,i,n.models,"getGridToolbarAddMenu")},onSortClick:function(e){var t=$(e.currentTarget),n={collection:this.options.gridView.collection,onSortItemClick:this.onSortItemClick,toolbar:this,page:this.page},r={xposition:"left",yposition:"auto",show:"default",className:"contextmenu",keepState:t},i={extra:n,menuOptions:r};_.asyncMenu(e,t,i,this.model,"getSortMenu")},onAllMusicClick:function(e){if(!this.currentOrder)return!1;this.resetCollection(!1);var t=$(e.currentTarget);t.siblings().removeClass("active"),t.addClass("active")},onFavoritesClick:function(e){if(!this.currentOrder)return!1;this.resetCollection(!0);var t=$(e.currentTarget);t.siblings().removeClass("active"),t.addClass("active")},onButtonClick:function(){},onFilterChange:function(e){var t=e?$(e.currentTarget):this.$el.find("input.filter"),r=t.val(),i=!0;if(!t.length)return;t.siblings(".clear-filter").css({visibility:r.length?"visible":"hidden"});for(var s=0,o=this.gridView.length;s<o;s++)this.gridView[s].filter(r),this.gridView[s].visibleCollection.length&&(i=!1);this.trigger("filterChanged",r);if(e&&e.which==_.keyboard.ENTER&&r.length&&$.trim(r)!==""&&i){n.router.performSearch("",r);return}},onFilterSubmit:function(e){return!1},onFilterClick:function(){n.trigger("guts:log","filterTextClicked"),n.trigger("guts:gatrack","user","filterTextClicked")},onSearchBarClick:function(e){$(".search-bar .placeholder",this.$el).hide(),$("#filter-search",this.$el).focus()},onFilterFocus:function(e){$(".search-bar .placeholder",this.$el).hide()},onFilterBlur:function(e){e.currentTarget.value===""&&$(".search-bar .placeholder",this.$el).show()},onSortItemClick:function(e,t,n,r){e==="default"?this.bypassGridSort=!0:this.bypassGridSort=!1;var s=this.$el.find("input.filter"),o=s.val();for(i=0,l=this.gridView.length;i<l;i++){var u=null;if(r)var a=this.gridView[i].options,f=a.columns,u={sortKey:r,gridOptions:a,songStats:this.model.get("songStats0"),columnSelected:_.indexOf(f,r),lastMetric:a.lastMetric?a.lastMetric:f[0],reversed:a.reversed,filterVal:o};this.gridView[i].sort(e,null,n,u)}this.lastSort.label=t,this.updateSortLabel()},handleScroll:function(){if(!this.offset)return;var e=this.$scrollElem.scrollTop(),t=$("#header-container"),n=t.outerHeight()+t.offset().top;e>this.offset-15?this.$el._isSticky||(this.$el.addClass("sticky"),this.$el._isSticky=!0,this.$el[0].style.top=n+"px"):this.$el._isSticky&&(this.$el.removeClass("sticky").css("top","auto"),this.$el._isSticky=!1)},getRelevantModels:function(e){var t=_.getCollectionType(this.gridView[0].collection),r=[],i=[],s=!1,o=0,u=this.gridView.length;e=e||t;for(;o<u;o++)this.gridView[o].selectedItems.length?(s=!0,i.push.apply(i,this.gridView[o].selectedItems.models)):s||r.push.apply(r,this.gridView[o].visibleCollection.models);s&&(r=i);if(e!==t&&e==="song"&&t=="album"){if(!(r[0]instanceof n.Models.Song)){var a=[];_.each(r,function(e){var t=e.get("songs");t&&t.models&&a.push.apply(a,t.models)}),r=a}t="song"}return e!==t&&(r=[]),{models:r,selectedModels:s?r:[]}},onInviteFriendsClick:function(){n.trigger("lightbox:open","invite")}},{})}(),function(){n.Views=n.Views||{},n.Views.FeedPost=Backbone.View.extend({templatePath:"shared/feedPost",events:{"focus .post-feed-msg":"onPostFocus","blur .post-feed-msg":"onPostBlur","focus .post-item":"onSearchFocus","blur .post-item":"onSearchBlur","mousedown .attach-music":"onAttachMusicMouseDown","keydown .post-item-input":"onSearchKeydown","focus .post-item-input":"onAddSongFocus","keyup .post-feed-msg":"onMessageKeyup","click .selected-item .icon":"clearSelectedItem","click .share-post":"postToFeed"},initialize:function(e){this.params=e,this.rendered=!1,this.postType=_.orEqual(e.postType,"feed"),this.posterType=e.posterType,this.poster=e.poster,this.closeTimeout=null,this.$postMsg=this.$el.find(".post-feed-msg"),this.model.on("change:collectionType",this.onTypeChange,this)},onDestroy:function(){return this.clearTooltip(),this._super.apply(this,["onDestroy"].concat(_.toArray(arguments)))},render:function(){if(this.rendered)return;switch(this.postType){case"share":this.fetchTemplate("sharePost").done(_.bind(this.onTemplate,this));break;default:this.fetchTemplate("feedPost").done(_.bind(this.onTemplate,this))}},onTemplate:function(e){if(this.destroyed)return;this.posterType==="artist"&&this.postType=="feed"?this.placeholderText=_.getString("PLACEHOLDER_ARTIST_FEED_SHARE"):this.postType=="feed"?this.placeholderText=_.getString("PLACEHOLDER_USER_FEED_SHARE"):this.postType=="share"&&(this.placeholderText=_.getString("PLACEHOLDER_SUGGEST_MUSIC_MSG")),this.$el.html(this.renderTemplate(e,this)),this.$attachBtn=_.orEqual(this.params.attachBtn,this.$el.find(".attach-music")),this.$attachBtn.on("click",_.bind(this.onAttachMusicClick,this)),this.rendered=!0},onPostFocus:function(e){var t=$(e.currentTarget);t.val()===this.placeholderText&&t.val(""),this.$el.addClass("stage-1")},onPostBlur:function(e){var t=$(e.currentTarget);this.closeTimeout=setTimeout(_.bind(function(){t.val()||(t.val(this.placeholderText),!this.attachMusicDown&&!this.model.get("selectedItem")&&this.$el.removeClass("stage-1"))},this),300)},onMessageKeyup:function(e){this.model.set({msg:$(e.currentTarget).val()})},onAttachMusicMouseDown:function(e){e.preventDefault(),this.attachMusicDown=!0,clearTimeout(this.closeTimeout)},onAttachMusicClick:function(e){e.preventDefault(),this.attachMusicDown=!1;var t=$(e.currentTarget);t.jjmenu(e,this.getItemTypeMenu(),null,{xposition:"left",yposition:"bottom",orientation:"bottom",show:"show",className:"attach-music-menu",keepState:t})},onTypeChange:function(){this.clearTooltip(),this.$search=$(".post-item-input"),this.$search.focus(),this.clearSelectedItem()},onSearchFocus:function(e){var t=$(e.currentTarget);t.length&&(t[0].selectionStart=-1,t[0].selectionEnd=-1),t.val()&&setTimeout(function(){t.select()},50),this.doAutocomplete(t)},onAddSongFocus:function(e){this.doAutocomplete($(e.currentTarget))},onSearchBlur:function(e){var t=$(e.currentTarget);this.autocompleteTooltip&&setTimeout(_.bind(function(){this.autocompleteTooltip=null,n.trigger("tooltip:close")},this),200)},onSearchKeydown:function(e){var t,r,i=$(e.currentTarget);this.autocompleteTooltip&&(t=this.autocompleteTooltip.$el,r=$("li.selected",t));switch(e.which){case _.keyboard.ENTER:r=r?r.find(".ac-item-link"):null;if(r)return this.onSelectedItem(r),!1;return;case _.keyboard.UP:e.preventDefault(),t&&(!r.length||r.is(":first-child")?$("li:last",t).addClass("selected"):r.prev().addClass("selected"),r.removeClass("selected"));return;case _.keyboard.DOWN:e.preventDefault(),t&&(!r.length||r.is(":last-child")?$("li:first",t).addClass("selected"):r.next().addClass("selected"),r.removeClass("selected"));return;case _.keyboard.ESC:e.preventDefault(),t&&(this.autocompleteTooltip=null,n.trigger("tooltip:close"));return}this.doAutocompleteDebounced(i)},doAutocompleteDebounced:_.debounce(function(e){return this.doAutocomplete(e)},300),doAutocomplete:function(e){var t=$.trim(e.val().toLowerCase());if(t.length>1&&this.autocompleteTooltip)this.autocompleteTooltip.changeQuery(t);else if(t.length>1){var r={sticky:!0,notchX:30,notch:"top",x:0,y:31,width:333,$attached:$(".post-item-search",this.$el),tooltipKey:"autocomplete",fixPosition:!1,tooltipClass:"ac"},i,s,o;if(this.posterType==="user"&&this.poster)switch(this.model.get("collectionType")){case"Songs":i=this.poster.get("library"),s="SongName";break;case"Playlists":i=this.poster.get("playlists"),this.poster.get("subscribedPlaylists")&&i.add(this.poster.get("subscribedPlaylists").models),s="PlaylistName"}else if(this.posterType==="artist"&&this.poster)switch(this.model.get("collectionType")){case"Songs":i=this.poster.get("songs"),s="SongName"}i&&i.length&&s&&(o=function(e){return i.filter(function(t){return _.startsWith(t.attributes[s],e)})}),this.autocompleteTooltip=new n.Views.Tooltips.Autocomplete({query:t,showAllLink:!1,sections:[{type:this.model.get("collectionType"),filterFunction:o,search:!0}],handleResultClick:_.bind(this.onSelectedItem,this)}),r.views=[this.autocompleteTooltip],n.trigger("tooltip:open",r),r.dfd.done(_.bind(function(){this.autocompleteTooltip=null},this))}else this.clearTooltip()},clearTooltip:function(){this.autocompleteTooltip&&(this.autocompleteTooltip=null,n.trigger("tooltip:close"))},onSelectedItem:function(e){var t,r,i;switch(this.model.get("collectionType")){case"Songs":t=n.Models.Song.getCached(e.data("songId")),r="song",i=e.data("songId");break;case"Artists":t=n.Models.Artist.getCached(e.data("artistId")),r="artist",i=e.data("artistId");break;case"Albums":t=n.Models.Album.getCached(e.data("albumId")),r="album",i=e.data("albumId");break;case"Playlists":t=n.Models.Playlist.getCached(e.data("playlistId")),r="playlist",i=e.data("playlistId")}if(!t)return;this.clearTooltip(),this.model.set({selectedItem:t,selectedItemID:i,selectedItemType:r});var s=$(".selected-item");s.find(".item-image").attr("src",t.getImageURL(r==="playlist"?70:40)),s.find(".item-name").text(t.get(_.ucwords(r)+"Name")).removeClass("hide"),r==="playlist"?s.find(".item-subtext").text(t.get("UserName")).removeClass("hide"):r==="song"?s.find(".item-subtext").html(t.escape("ArtistName")+" &bull; "+t.escape("AlbumName")).removeClass("hide"):r==="album"?s.find(".item-subtext").text(t.get("ArtistName")).removeClass("hide"):s.find(".item-subtext").addClass("hide"),this.$el.addClass("stage-3")},clearSelectedItem:function(){this.model.unset("selectedItem"),this.$search&&this.$search.val(""),this.$el.removeClass("stage-3").addClass("stage-2")},getItemTypeMenu:function(){var e=[{key:"SONG",title:_.getString("SONG"),action:{type:"fn",callback:_.bind(function(){this.model.set("collectionType","Songs"),$(".label",this.$attachBtn).text(_.getString("SONG")).data("translateText",_.getString("SONG"))},this)}},{key:"ALBUM",title:_.getString("ALBUM"),action:{type:"fn",callback:_.bind(function(){this.model.set("collectionType","Albums"),$(".label",this.$attachBtn).text(_.getString("ALBUM")).data("translateText",_.getString("ALBUM"))},this)}},{key:"ARTIST",title:_.getString("ARTIST"),action:{type:"fn",callback:_.bind(function(){this.model.set("collectionType","Artists"),$(".label",this.$attachBtn).text(_.getString("ARTIST")).data("translateText",_.getString("ARTIST"))},this)}},{key:"PLAYLIST",title:_.getString("PLAYLIST"),action:{type:"fn",callback:_.bind(function(){this.model.set("collectionType","Playlists"),$(".label",this.$attachBtn).text(_.getString("PLAYLIST")).data("translateText",_.getString("PLAYLIST"))},this)}}];return e},postToFeed:function(){var e=$.trim($(".post-feed-msg").val());e==this.placeholderText&&(e="");if(!this.model.get("selectedItem")&&!e)return;if(e.length>3e3){n.trigger("notification:add",{title:_.getString("POPUP_FEED_POST_TOO_LONG"),type:"error"});return}this.posterType==="user"?this.model.get("selectedItem")&&this.model.get("selectedItemType")?n.Services.API.sendFeedBroadcast(this.model.get("selectedItemType"),this.model.get("selectedItem").id,[],e).always(_.bind(this.onFeedSuccess,this)):n.trigger("notification:add",{title:_.getString("POPUP_FEED_POST_NO_ITEM_FAILED"),type:"error"}):this.model.get("selectedItem")&&this.model.get("selectedItemType")?n.Services.API.sendArtistFansUpdate(this.poster.id,e,this.model.get("selectedItem").getDetailsForFeeds(),this.model.get("selectedItemType")).always(_.bind(this.onFeedSuccess,this)):n.Services.API.sendArtistFansUpdate(this.poster.id,e).always(_.bind(this.onFeedSuccess,this))},onFeedSuccess:function(e){if(!e||e!==!0&&!e.Success){n.trigger("notification:add",{title:_.getString("POPUP_FEED_POST_FAILED"),type:"error"});return}this.clearTooltip(),this.clearSelectedItem(),$(".post-feed-msg").val(""),$(".post-item-input").val(""),this.$el.removeClass("stage-1 stage-2"),$(".title",this.$attachBtn).text(_.getString("ATTACH_MUSIC")).data("translateText",_.getString("ATTACH_MUSIC")),n.trigger("notification:add",{title:_.getString("POPUP_FEED_POST_SUCCESS"),icon:"user icon-user-white-active",type:"success"})}})}(),function(){n.Views=n.Views||{},n.Views.Tooltips=n.Views.Tooltips||{},n.Views.ManagedTooltip=Backbone.View.extend({templatePath:"tooltip",className:"tooltip-container",hideTimeout:null,options:{sensitivity:"normal",hideDelay:300,sticky:!1,persist:!1,metadata:null,views:null,delay:0,zIndex:12999,width:320,x:0,y:"bottom",notch:"top",notchX:12,notchY:12,notchSize:6,notchBorder:1,notchBorderColor:!1,notchBackgroundColor:!1,tooltipClass:"",destroyViewOnClose:!0,closeOthers:!0,fixPosition:!0},initialize:function(e){var t=e.dfd;t||(t=$.Deferred(),e.dfd=t),this.dfd=t,this.options.metadata=[];var n=_.defaults(e,this.options);this.$caret0=$(document.createElement("div")).addClass("tooltip-caret"),this.$caret1=$(document.createElement("div")).addClass("tooltip-caret"),this.$contents=$(document.createElement("div")),this.$el.append([this.$caret0[0],this.$contents[0],this.$caret1[0]]),this.uniqueClass="gs-tooltip"+Math.floor(Math.random()*1e7),n.$attached||(console.log("Tooltip not attached to anything, attaching to body",n),n.$attached=$(document.body)),this.options=n},render:function(){if(!this.options||this.destroyed)return;this.lastTimeout=null,this.options.$attached.off("mouseleave.tooltips"),this.$contents.attr("class","tooltip gs-tooltip "+this.options.tooltipClass+" "+this.uniqueClass);if(this.options.views){var e=[],t=[],r,i;for(var s=0,o=this.options.views.length;s<o;s++){i=this.options.views[s],e.push(i.$el[0]),r=i.render(this);if(!this.options)return;if(!r||!r.done){console.log("No dfd for tooltip view",this,i);continue}t.push(r)}var u=_.bind(function(){this.$contents.empty().append(e),this.onRendered()},this);this.dfd.notify("loading",this,t),t.length?$.after(t).done(u).fail(function(){n.trigger("tooltip:close")}):u()}},onRendered:function(){if(this.destroyed)return;this.hideTimeout=null,$.browser.mozilla&&_.toInt($.browser.version)<6?$("#theme_home .flash object").each(function(e,t){t.style.visibility="hidden"}):$("#theme_home .flash object").hide(),$("div.capital iframe").hide().parent().hide(),this.options.scrollable||(this.options.scrollable=_.getScrollableParent(this.options.$attached)),this.attachedToDOM||(this.options.scrollable.append(this.$el),this.attachedToDOM=!0);var e={};this.options.width?e.width=this.options.width:e.maxWidth=this.options.maxWidth,this.$el.css({position:"absolute",top:0,left:0}),this.$contents.css(e),this.adjustPosition(),this.$el.show(),this.dfd.notify("rendered",this),this.trigger("rendered")},onDestroy:function(){if(this.options.views)for(var e=0,t=this.options.views.length;e<t;e++)this.options.views[e].destroy(this.options.destroyViewOnClose);clearTimeout(this.hideTimeout),clearTimeout(this.lastTimeout),this.hideTimeout=null,this.lastTimeout=null},adjustPosition:function(){var e=this.options;if(!e.$attached||!e.$attached.length)return;var t=e.scrollable,n=e.$attached.offset(),r=t.offset(),i=t.scrollTop(),s=e.x,o=e.y,u=e.adjustX||0,a=e.adjustY||0,f=e.notchBorder||0,l=_.toInt(e.notchSize),c,h,p,d,v,m,g={zIndex:e.zIndex},y=_.memoize(function(t,n){if(t=="height")return e.$attached.outerHeight();if(t=="width")return e.$attached.outerWidth();if(t=="offset")return e.$attached.offset();if(t=="offsetTo")return e.$attached.offsetTo(n)});n={top:n.top-r.top+i,left:n.left-r.left};if(e.fixPosition){m=y("offsetTo",t);var b=m&&m.top-i,w=t.height(),E=this.$contents.height(),S=y("height");p=b+E,o=="bottom"&&e.notch=="top"&&(p+=f+l+S),b<=0?_.isNumber(o)?(e.y=o=3,e.notchY=10):o=="top"&&(e.y=o="bottom",e.notch=="bottom"&&(e.notch="top")):p>w&&(_.isNumber(o)?(e.y=o="top",e.notchY=E-S/2+6,a=S-6):o=="bottom"&&(e.y=o="top",e.notch=="top"&&(e.notch="bottom")))}if(e.fixPosition){m=y("offsetTo",t);var x=m&&m.left,T=this.$contents.width(),N=y("width");if(m&&_.isNumber(e.notchX)){d=x-(T-e.notchX);if(d<0)e.notchX=Math.max(11,e.notchX+d)-4;else{var C=t.width();s=="center"||s=="middle"?v=C-(N/2+x+T-e.notchX):_.isNumber(s)&&(v=C-(s+x+T-e.notchX)),v<0&&(e.notchX=Math.max(11,e.notchX-v)-4)}}}this.writeNotchCSS();if(_.isNumber(o))c=n.top+o+a;else if(o=="bottom")c=n.top+y("height"),e.notch=="top"&&(c+=(e.notchInfluenceY||0)+a);else if(o=="middle"||o=="center"){c=n.top+y("height")/2+a;if(e.notch=="left"||e.notch=="right")c-=e.notchInfluenceY||0}else o=="top"&&(c=n.top-this.$contents.height()+a,e.notch=="bottom"&&(c+=e.notchInfluenceY||0));if(_.isNumber(s))h=n.left+s+u;else if(s=="right")h=n.left+y("width"),e.notch=="left"&&(h-=e.notchInfluenceX||0);else if(s=="center"||s=="middle"){h=n.left+y("width")/2+u;if(e.notch=="top"||e.notch=="bottom")h-=e.notchInfluenceX||0}else s=="left"&&(h=n.left-this.$contents.width()+u,e.notch=="right"&&(h-=e.notchInfluenceX||0));g.top=c,g.left=h,this.$el.css(g)},writeNotchCSS:function(){var e=this.options,t=e.notchBorder||0,n=_.toInt(e.notchSize),r={},i={},s,o,u,a,f,l,c,h,p;if(n&&e.notch){var d={top:"bottom",bottom:"top",left:"right",right:"left"};d[e.notch]&&(s=d[e.notch],u=e.notch),s&&(s=="bottom"||s=="top"?(o="left",this.options.notchInfluenceX=e.notchX+t,this.options.notchInfluenceY=(n+t)*(s=="bottom"?1:-1)):(o="top",this.options.notchInfluenceX=(n+t)*(s=="left"?1:-1),this.options.notchInfluenceY=e.notchY+t),c=o=="left"?e.notchX:e.notchY,h=n*2-1,a=_.ucwords(s),f=_.ucwords(o),l=_.ucwords(u),r[s]="100%",r[o]=c+"px",r["border"+a+"Color"]=this.options.notchBackgroundColor||this.$contents.css("backgroundColor"),r.borderWidth=n+"px",r["margin"+f]=n*-1+"px",r["margin"+a]="-1px",r.zIndex=99999999,t&&(p=n+Math.round(t*1.41421),i[s]="100%",i[o]=c+"px",i["border"+a+"Color"]=this.options.notchBorderColor||this.$contents.css("border"+_.ucwords(u)+"Color"),i.borderWidth=p+"px",i["margin"+f]=p*-1+"px",i["margin"+a]="-1px"))}this.$caret0.css(r),this.$caret1.css(i)}}),n.Views.Tooltip=Backbone.View.extend({templatePath:"tooltip",className:"tooltip-container",initialize:function(){this.tooltips={},this.model.set("tooltipOptionsCache",{}),n.on("tooltip:open",_.bind(this.open,this)),n.on("tooltip:close",_.bind(this.close,this)),n.on("router:change",_.bind(function(){this.close(null,"routerChange")},this)),$(document).on("mouseenter.tooltips","*",_.bind(this.onMouseEvent,this)),$(document).on("click.tooltips","*",_.bind(this.onMouseEvent,this))},open:function(e){e.tooltipKey||(e.tooltipKey=+(new Date));if(this.tooltips[e.tooltipKey])return this.tooltips[e.tooltipKey].dfd;var t=new n.Views.ManagedTooltip(e,{clone:!1});e.tooltip=t,e.dfd=t.dfd,t.options.closeOthers&&this.close();var r=function(){_.each($(".capital, .theme-capital-placeholder"),function(e,t){$("#"+$(e).attr("data-capital-id")).hide()})};return this.tooltips[e.tooltipKey]=t,t.options.delay?(t.lastTimeout=setTimeout(_.bind(function(e){e.options.shouldHideAds&&r(),e.render()},this,t),t.options.delay),!t.options.persist&&!t.options.sticky&&t.options.$attached.on("mouseleave.tooltips",_.bind(function(){this.close(e.tooltipKey)},this))):t.render(),t.dfd},close:function(e,t){_.each(this.tooltips,_.bind(function(n,r){if(e&&r!=e||!e&&n.options.persist||t=="routerChange"&&n.options.persistOnRouterChange)return;n.options.shouldHideAds&&_.each($(".capital, .theme-capital-placeholder"),function(e,t){$("#"+$(e).attr("data-capital-id")).show()}),n.destroy(),n.options.$attached&&n.options.$attached.off("mouseleave.tooltips"),n.dfd&&n.dfd.state()!="resolved"&&n.dfd.resolve(),delete this.tooltips[r],_.isNumber(n.lastTimeout)&&clearTimeout(n.lastTimeout),_.isNumber(n.hideTimeout)&&clearTimeout(n.hideTimeout)},this)),!_.size(this.tooltips)&&!r.lightbox.isOpen&&n.Models.Ad.showFlashElements()},onMouseEvent:function(e){_.each(this.tooltips,_.bind(function(t,n){if(t.options.persist||t.options.sticky&&e.type=="mouseenter")return;var r=t.options.$attached,i=e.target===r[0],s=t.options.sensitivity,o=t.options.hideDelay,u=[];u.push(r[0]),s!=="mouseout"&&(i=i||e.target===t.$el[0],u.push(t.$el[0]));if(!i){var a=$(e.target).parents();for(var f=0,l=a.length;f<l;f++)if(_.indexOf(u,a[f])!=-1){i=!0;break}}t.hideTimeout&&i?(clearTimeout(t.hideTimeout),t.hideTimeout=null):!t.hideTimeout&&!i&&!t.lastTimeout&&!t.options.sticky?t.hideTimeout=setTimeout(_.bind(this.close,this,n),o):!t.hideTimeout&&!i&&this.close(n)},this))}}),n.Views.Tooltips.SongClaimHelper=Backbone.View.extend({templatePath:"tooltip",events:{},render:function(){return this.renderDfd=$.Deferred(),this.fetchTemplate("songClaimHelper").always(_.bind(this.onTemplate,this)),this.renderDfd},onTemplate:function(e){this.$el.html(this.renderTemplate(e,this.options)),this.renderDfd.resolve()}}),n.Views.Tooltips.Flattr=Backbone.View.extend({templatePath:"tooltip",events:{"click .flattr-video":"onFlattrVideoClick"},render:function(){return this.renderDfd=$.Deferred(),this.fetchTemplate("flattr").always(_.bind(this.onTemplate,this)),this.renderDfd},onTemplate:function(e){this.$el.html(this.renderTemplate(e,this.options)),this.renderDfd.resolve()},onFlattrVideoClick:function(){n.trigger("lightbox:open","video",{videos:[{type:"youtube",title:"This is Flattr",id:"9zrMlEEWBgY",width:640,height:360}],hideHeader:!0})}}),n.Views.Tooltips.SingleSong=Backbone.View.extend({templatePath:"tooltip",className:"single-song",currentTooltip:{},events:{"click .song-add":"onLibraryClick","click .suggest-tags":"onSuggestTagsClick"},render:function(e){if(this.destroyed)return;return this.template?(this.redraw(),this.renderDfd.resolve(),$.Deferred().resolve()):(e&&(this.currentTooltip=e.options),this.songDfd=$.Deferred(),this.dataDfd=$.Deferred(),this.renderDfd=$.Deferred(),n.Models.Song.get(this.options.songID).done(_.bind(function(e){this.song=e,this.songDfd.resolve(e),this.currentTooltip.mini||this.dataDfd.resolve(e)},this)),setTimeout(_.bind(this.getPageNameData,this),this.currentTooltip.pageNameWait||450),this.fetchTemplate("song").always(_.bind(this.onTemplate,this)),this.renderDfd)},getPageNameData:function(){if(this.destroyed)return;if(!this.song){this.songDfd.done(_.bind(this.getPageNameData,this));return}if(this.song&&this.song.get("pageNameData")){this.currentTooltip.mini&&this.dataDfd.resolve(this.song);return}var e=_.chainLoading();e.push(this.fetchTemplate("/shared/genreTags")),e.push(this.song.getPageNameData().done(e.bind(function(){this.redraw(),this.currentTooltip.mini&&this.dataDfd.resolve(this.song)},this)))},onTemplate:function(e){this.template=e,this.dataDfd.done(_.bind(function(e){e.on("change",function(){this.render()},this),this.redraw(),this.renderDfd.resolve()},this))},remove:function(){return this.$el.remove(),this.destroyed=!0,this.song&&(this.song.off(null,null,this),delete this.song),this._super.apply(this,["remove"].concat(_.toArray(arguments)))},redraw:function(){if(!this.song)return;var e=this.song.get("Tags");this.$el.html(this.renderTemplate(this.template,{song:this.song,mini:this.currentTooltip.mini,addStreamType:this.options.addStreamType})),e&&this.fetchTemplate("/shared/genreTags").done(_.bind(function(t){setTimeout(_.bind(function(){var n=this.$el.find(".tags-wrapper"),r,i,s;n.html(this.renderTemplate(t,{tags:e,song:this.song})),r=n.find(".genre-link"),r.length&&n.removeClass("hide");for(i=0,s=r.length;i<s&&n.height()>30;i++)_.$one(r[s-i-1]).remove()},this),50)},this))},onLibraryClick:function(e){var t=$(e.currentTarget),r=$(t).data(),i=r&&r.songId;if(i&&this.song){var s=n.getLoggedInUserID(),o=n.Models.User.getCached(s);this.song.get("fromLibrary")?o.removeSongsFromLibrary([i]):o.addSongsToLibrary([i])}},onSuggestTagsClick:function(){n.trigger("lightbox:open","suggestTags",{id:this.song.get("SongID"),type:"song"})}}),n.Views.Tooltips.User=Backbone.View.extend({templatePath:"tooltip",className:"user",render:function(){if(this.destroyed)return;return this.template?(this.redraw(),this.renderDfd.resolve(),$.Deferred().resolve()):(this.dataDfd=$.Deferred(),this.renderDfd=$.Deferred(),n.Models.User.get(this.options.userID).done(_.bind(function(e){this.user=e,this.dataDfd.resolve(e)},this)),setTimeout(_.bind(this.getPageNameData,this),450),this.fetchTemplate("user").always(_.bind(this.onTemplate,this)),this.renderDfd)},getPageNameData:function(){if(this.destroyed)return;if(!this.user){this.dataDfd.done(_.bind(this.getPageNameData,this));return}if(this.user&&this.user.get("pageNameData"))return;this.user.getPageNameData().done(_.bind(function(){this.redraw()},this))},onTemplate:function(e){this.template=e,this.dataDfd.done(_.bind(function(e){e.on("change",function(){this.render()},this),this.redraw(),this.renderDfd.resolve()},this))},remove:function(){return this.$el.remove(),this.destroyed=!0,this.user&&(this.user.off(null,null,this),delete this.user),this._super.apply(this,["remove"].concat(_.toArray(arguments)))},redraw:function(){if(!this.user)return;var e=this.user.get("pageNameData");this.user.get("nowPlayingSong")&&this.$el.addClass("is-playing-song"),this.$el.html(this.renderTemplate(this.template,{user:this.user,mini:!1}))}}),n.Views.Tooltips.Broadcast=Backbone.View.extend({templatePath:"tooltip",className:"broadcast",events:{},initialize:function(){this.broadcastID=this.options.broadcastID,this.userID=this.options.userID,this.dataDfd=$.Deferred(),this.renderDfd=$.Deferred(),n.Models.Broadcast.fetchRealtimeBroadcast(this.broadcastID,!1,!0).done(_.bind(function(e){this.broadcast=e,this.user=n.Models.User.getCached(this.userID),this.broadcast.getOwner()!==this.user&&this.broadcast.handleUserCached(this.userID,this.user),this.user.on("change:isFavorite",this.updateFollowBtn,this),this.dataDfd.resolve()},this)).fail(_.bind(function(){this.closeTooltip()},this)),this._super.apply(this,["initialize"].concat(_.toArray(arguments)))},updateFollowBtn:function(){if(this.user){var e=this.$el.find(".btn.favorite");this.user.get("isFavorite")?(e.addClass("btn-success"),e.find(".icon").addClass("icon-plus-white-active").removeClass("icon-plus-gray"),e.find("span").text(_.getString("FOLLOWING_USER",{user:this.user.getShortName()}))):(e.removeClass("btn-success"),e.find(".icon").removeClass("icon-plus-white-active").addClass("icon-plus-gray"),e.find("span").text(_.getString("LB_FOLLOW_USER_TITLE",{user:this.user.getShortName()})))}},render:function(){if(this.destroyed)return;return this.template?(this.redraw(),$.Deferred().resolve()):(this.fetchTemplate("broadcast").done(_.bind(this.onTemplate,this)),this.renderDfd)},onTemplate:function(e){this.template=e,this.dataDfd.done(_.bind(function(){this.user.getPageNameData(),this.redraw(),this.broadcastModule=new n.Views.Modules.BroadcastCell({model:this.broadcast,el:this.$el.find(".module.broadcast")[0]}),this.broadcastModule.render(),this.renderDfd.resolve()},this))},remove:function(){return this.$el.remove(),this.destroyed=!0,this.user&&(this.user.off(null,null,this),delete this.user),this.renderDfd=$.Deferred(),this._super.apply(this,["remove"].concat(_.toArray(arguments)))},redraw:function(){if(!this.broadcast)return;this.$el.html(this.renderTemplate(this.template,this))},closeTooltip:function(){n.trigger("tooltip:close",this.options.tooltipKey)}}),n.Views.Tooltips.Artist=Backbone.View.extend({templatePath:"tooltip",className:"artist",currentTooltip:{},events:{"click .play-station":"onPlayStationClick","click .suggest-tags":"onSuggestTagsClick"},render:function(e){if(this.destroyed)return;return this.template?(this.redraw(),this.renderDfd.resolve(),$.Deferred().resolve()):(e&&(this.currentTooltip=e.options),this.artistDfd=$.Deferred(),this.renderDfd=$.Deferred(),n.Models.Artist.get(this.options.artistID).done(_.bind(function(e){this.artist=e,this.artistDfd.resolve(e)},this)),setTimeout(_.bind(this.getPageNameData,this),this.currentTooltip.pageNameWait||450),this.fetchTemplate("artist").always(_.bind(this.onTemplate,this)),this.renderDfd)},getPageNameData:function(){if(this.destroyed)return;if(!this.artist){this.artistDfd.done(_.bind(this.getPageNameData,this));return}if(this.artist&&this.artist.get("pageNameData"))return;var e=_.chainLoading();e.push(this.fetchTemplate("/shared/genreTags")),e.push(this.artist.getPageNameData().done(e.bind(function(){this.redraw()},this)))},onTemplate:function(e){this.template=e,this.artist.on("change",function(){this.render()},this),this.redraw(),this.renderDfd.resolve()},remove:function(){return this.$el.remove(),this.destroyed=!0,this.artist&&(this.artist.off(null,null,this),delete this.artist),this._super.apply(this,["remove"].concat(_.toArray(arguments)))},redraw:function(){if(!this.artist)return;this.$el.html(this.renderTemplate(this.template,{artist:this.artist}));var e=this.artist.get("Tags");e&&this.fetchTemplate("/shared/genreTags").done(_.bind(function(t){setTimeout(_.bind(function(){var n=this.$el.find(".tags-wrapper"),r,i,s;n.html(this.renderTemplate(t,{tags:e})),r=n.find(".genre-link"),r.length&&n.removeClass("hide");for(i=0,s=r.length;i<s&&n.height()>30;i++)_.$one(r[s-i-1]).remove()},this),50)},this))},onPlayStationClick:function(e){n.trigger("player:radio",!0,null,{seeds:[this.artist.get("ArtistID")],seedArtistWeightRange:[110,130],secondaryArtistWeightModifier:.75}),n.trigger("guts:gatrack","player","autoplayOn","artist"),n.trigger("guts:forcelog","autoplayOn",{autoplay:0,autoplayType:"artist"}),n.trigger("guts:begincontext",{autoplay:0,autoplayType:"artist"})},onSuggestTagsClick:function(){if(!this.artist)return;n.trigger("lightbox:open","suggestTags",{id:this.artist.get("ArtistID"),type:"artist"})}}),n.Views.Tooltips.QueueOptions=Backbone.View.extend({templatePath:"tooltip",className:"queue-options",events:{"click .toggle-radio":"onRadioClick","click .genre.tall":"onTagClick","click .menu-item":"onItemClick"},render:function(e){if(this.destroyed)return;return this.template?(this.redraw(),this.renderDfd.resolve(),$.Deferred().resolve()):(e.on("rendered",function(){this.tooltipRendered=!0,this.trigger("rendered")},this),this.sortedGenres=_.clone(n.Models.Tag.topGenres),this.sortedGenres.sort(function(e,t){return e.title>t.title?1:e.title<t.title?-1:0}),this.model.set("genres",this.sortedGenres),this.childViews=[],this.renderDfd=$.Deferred(),this.fetchTemplate("queueOptions").always(_.bind(this.onTemplate,this)),this.renderDfd)},onTemplate:function(e){this.template=e;var t=this.model.get("player"),n,r=function(){n&&n.off("change",null,this),n=t.get("currentQueue"),n.on("change",function(){this.redraw()},this)};t.on("change:currentQueue",r,this),r.call(this),this.redraw(),this.renderDfd.resolve()},remove:function(){this.$el.remove(),this.destroyed=!0;for(var e=0,t=this.childViews.length;e<t;e++)this.childViews.destroy();var n=this.model.get("player"),r=n.get("currentQueue");return n.off("change:currentQueue",null,this),r.off("change",null,this),this._super.apply(this,["remove"].concat(_.toArray(arguments)))},redraw:function(){var e=this.model.get("player"),t=e.get("currentQueue"),n=this.model.get("user");this.$el.html(this.renderTemplate(this.template,{player:e,queue:t}))},onPlaylistSelected:function(e){e.getSongs().done(function(t){var r=new n.Models.PlayContext(e);n.trigger("player:addSongs",t,n.Services.SWF.playSpecialIndexes.DEFAULT,!1,r),n.trigger("tooltip:close")})},onItemClick:function(e){var t=$(e.currentTarget)},onRadioClick:function(){var e=this.model.get("player").get("currentQueue"),t=e.get("clientRadioEnabled");t?(e.get("clientRadio").disable(),n.trigger("guts:clearAllAutoplayContexts")):n.trigger("player:radio")},onTagClick:function(e){var t=$(e.currentTarget),r=t.data(),i=this.model.get("player");n.Views.Application.prototype.playTagRadio(r.tag,r.tagId,i)},onLibraryClick:function(e){var t=$(e.currentTarget),r=$(t).data(),i=r&&r.songId;if(i&&this.song){var s=n.getLoggedInUserID(),o=n.Models.User.getCached(s);this.song.get("fromLibrary")?o.removeSongsFromLibrary([i]):o.addSongsToLibrary([i])}}}),n.Views.Tooltips.Autocomplete=Backbone.View.extend({templatePath:"tooltip",events:{"click .ac-item-link":"onResultClick","click .see-all":"showSearchResults","click .btn.play":"onPlayClick","click .bc-add":"onSuggestClick","mouseenter .ac-list-item":"onListItemMouseenter"},initialize:function(){this.sections=_.orEqual(this.options.sections,[{}]);var e,t,n;for(t=0,n=this.sections.length;t<n;t++)e=this.sections[t],e.type=_.orEqual(e.type,"Artists"),e.filterFunction=_.orEqual(e.filterFunction,null),e.search=_.orEqual(e.search,!0);this.showAllLink=_.orEqual(this.options.showAllLink,!0),this.handleResultClick=_.orEqual(this.options.handleResultClick,null),this.maxResults=_.orEqual(this.options.maxResults,0),this.options.type=="broadcastSearch"&&this.$el.addClass("broadcast-search"),this._super.apply(this,["initialize"].concat(_.toArray(arguments)))},render:function(e){e&&e.dfd&&(this.tooltipDfd=e.dfd),this.renderDfd=$.Deferred();var t,r,i;for(r=0,i=this.sections.length;r<i;r++)t=this.sections[r],t.type=_.orEqual(t.type,"Artists"),t.filterFunction=_.orEqual(t.filterFunction,null),t.search=_.orEqual(t.search,!0),t.filterResults=[],t.results=new n.Models.Collections[t.type],t.lastDfd=null;return this.template=null,this.hasAnyResults=!1,this.changeQuery(this.options.query),this.renderDfd},cancelPendingRequests:function(){var e,t,n;for(t=0,n=this.sections.length;t<n;t++)e=this.sections[t],e.lastDfd&&(e.lastDfd.abort(),e.lastDfd=null)},changeQuery:function(e){function t(){this.pendingResults=Math.max(0,this.pendingResults-1)}if(e==this.query){if(this.hasAnyResults&&this.template){this.onResultsChange();return}if(this.pendingResults>0)return}e=$.trim(e),this.query=e,this.hasAnyResults=!1,this.pendingResults=0;var r,i,s,o,u,a,f=this.options.$searchIco;f&&f.addClass("searching");for(i=0,s=this.sections.length;i<s;i++){r=this.sections[i],r.lastDfd&&r.lastDfd.abort(),o=r.search;if(r.filterFunction){r.filterResults=r.filterFunction(e),r.filterResults.length>0&&(this.hasAnyResults=!0);if(r.filterResults.length>3||!o)r.results.reset(r.filterResults),o=!1}o&&(u=r.type.toLowerCase().substr(0,r.type.length-1),this.pendingResults++,r.useCombinedResults?a?r.lastDfd=a.done(_.bind(this.onAutocompleteResults,this,r,u)):a=r.lastDfd=n.Services.API.getAutocompleteEx(e,"combined").done(_.bind(this.onAutocompleteResults,this,r,u)).fail(_.bind(t,this)):r.lastDfd=n.Services.API.getAutocompleteEx(e,u).done(_.bind(this.onAutocompleteResults,this,r,u)).fail(_.bind(t,this)))}if(!this.template)this.fetchTemplate("autocomplete").done(_.bind(this.onTemplate,this));else if(!this.pendingResults){this.onResultsChange();return}setTimeout(function(){$(".ac-list").length&&n.Models.Ad.hideFlashElements()},250)},onTemplate:function(e){this.template=e,(this.hasAnyResults||!this.pendingResults)&&this.onResultsChange()},onAutocompleteResults:function(e,t,n){this.pendingResults--,t&&n?n=n[t]:n=_.isArray(n.result)?n.result:n;if(!n||!n.length){e.results.reset(e.filterResults||[]),this.onResultsChange();return}this.hasAnyResults=!0,n=e.filterResults.concat(n),e.results.reset(n),this.onResultsChange()},onResultsChange:function(){if(!this.template)return;var e=!1,t=this.options.type=="broadcastSearch",r=this.options.$searchIco;r&&r.removeClass("searching");if(!this.hasAnyResults){this.pendingResults||(t?e=!0:n.trigger("tooltip:close"));if(!e)return}var i,s,o=0,u=0;if(this.maxResults){for(i=0,s=this.sections.length;i<s;i++)this.sections[i].results.length&&o++;u=Math.round(this.maxResults/o)}this.$el.html(this.renderTemplate(this.template,{sections:e?!1:this.sections,showAll:e?!1:this.showAllLink,maxPerType:u,type:this.options.type})),this.tooltipDfd&&this.tooltipDfd.notify("resultsChanged",this),this.renderDfd.resolve()},showSearchResults:function(){this.query&&this.query.length&&($("input[name=q]",this.$attached).blur().val(""),n.trigger("tooltip:close"),n.router.performSearch("",this.query))},onResultClick:function(e){if(this.handleResultClick)return e.preventDefault(),e.stopImmediatePropagation(),this.handleResultClick($(e.currentTarget))},onPlayClick:function(e){e.stopImmediatePropagation();var t=$(e.currentTarget).data("songId"),i=n.Models.Song.getCached(t),s=new n.Models.PlayContext,o=r.model.get("player").get("currentQueue"),u=o?o.get("activeSong"):null;return s.addStreamType(n.Models.PlayContext.TYPE_DEFAULT),$(e.currentTarget).hasClass("play-select")?(n.trigger("player:addSongs",[t],n.Services.SWF.playSpecialIndexes.LAST,!0,s,!1,!0),this.onResultClick(e)):i&&(u||n.isBroadcastListener())?n.trigger("lightbox:open","previewSong",{songs:[i],playContext:s,showPlayerControls:!0,_showPlayerControls:!0}):n.trigger("player:addSongs",[t],n.Services.SWF.playSpecialIndexes.LAST,!1,s,!1,!0),n.trigger("tooltip:close"),!1},onSuggestClick:function(e){e.stopImmediatePropagation();var t=$(e.currentTarget),i=n.Models.Song.getCached(t.data("songId")),s=r.model.get("player").get("currentQueue"),o=s?s.get("currentBroadcast"):{},u=new n.Models.PlayContext,a=_.eventToGUTSCoords(e);return a.songID=i.get("SongID"),u.addStreamType(n.Models.PlayContext.TYPE_DEFAULT),s&&(s.get("isBroadcasting")?n.trigger("player:addSongs",[i.get("SongID")],n.Services.SWF.playSpecialIndexes.LAST,!1,u,!1,!0):(o.suggestSong(i),a.suggesterID=n.getLoggedInUserID(),n.trigger("guts:log","broadcastSuggestClick",a))),!1},onListItemMouseenter:function(e){$(".ac-list-item.selected").removeClass("selected"),$(e.currentTarget).addClass("selected")}}),n.Views.Tooltips.Menu=Backbone.View.extend({templatePath:"tooltip",newHTML:null,newModules:null,render:function(e){return this.tooltip=e,e&&e.dfd&&(this.tooltipDfd=e.dfd),this.$el.on("click",".menu-item",_.bind(this.clickItem,this)),this.renderDfd=$.Deferred(),this.template=null,this.updateVisibleOptions(),this.updateDOM(),this.renderDfd.resolve(),this.renderDfd},updateVisibleOptions:function(){var e=[],t=0,n=this.options.items.length,r=[],i,s,o;for(;t<n;t++)i=this.options.items[t],i.type&&i.type=="divider"?s=['<div class="divider"></div>']:i.type&&i.type=="title"?s=['<div class="section-title">'+i.title+"</div>"]:i.type&&i.type=="html"?s=[i.html]:i.type&&i.type=="module"?(o="div",i.url&&(o="a"),s=["<",o,' class=" ',_.orEqual(i.itemClass,"")," menu-item item-module-",r.length,'"',i.url?'href="'+i.url+'"':"",' data-menu-item-key="',t,'">',_.orEqual(i.beforeHTML,""),"</",o,">"],i.module.render(),r.push(i.module.$el[0])):(s=['<a class="',"menu-item ",_.orEqual(i.itemClass,""),'" ',i.url?'href="'+i.url+'"':"",' data-menu-item-key="',t,'"><span class="menu-title"'],i.localeKey?s.push('data-translate-text="',i.localeKey,'">',_.getString(i.localeKey)):i.title&&s.push(">",i.title),s.push("</span>"),s.push("</a>")),e.push(s.join(""));this.newHTML=e,this.newModules=r},updateDOM:function(){this.newHTML&&(n.Models.Ad.hideFlashElements(),this.$el.html(this.newHTML.join("")),this.newHTML=null);if(this.newModules){var e=this.newModules;for(var t=0,r=e.length;t<r;t++)this.$el.find(".item-module-"+t).append(e[t]);this.newModules=null}},clickItem:function(e){var t=$(e.currentTarget),r=t.data(),i=r.menuItemKey,s=this.options.items&&this.options.items[i];s&&s.click&&s.click.apply(this,_.toArray(arguments)),s&&this.options.onItemClick&&this.options.onItemClick(s);var t=$(e.currentTarget),o=t.prevAll(".divider, .section-title").length,u=t.index()-o,a=t.attr("data-translate-text")?t.attr("data-translate-text"):t.find("[data-translate-text]").first().attr("data-translate-text");textFlag=!1,a||(a=t.text(),textFlag=!0),n.trigger("guts:log","contextMenuItemClicked",{name:a,pretranslated:textFlag,index:u})},updateMenuOptions:function(e){this.options.items=e,this.updateVisibleOptions(),this.el.parentNode&&this.updateDOM()},closeTooltip:function(){this.options&&this.options.tooltipKey&&n.trigger("tooltip:close",this.options.tooltipKey)}}),n.Views.Tooltips.Helper=Backbone.View.extend({templatePath:"tooltip",initialize:function(){var e=_.calculateTextWidth(this.options.text.substring(0,63)),t=this.options.minWidth||e+30;this.tooltipOptions={delay:500,notchSize:6,notchX:t/2+2,notch:"top",x:"center",y:"bottom",width:t,tooltipClass:"dark "+this.options.extraClass,sensitivity:"mouseout",closeOthers:!1,hideDelay:0,isHelper:!0},_.each(r.tooltip.tooltips,function(e,t){e.options.isHelper&&!e.options.persist&&n.trigger("tooltip:close",t)})},render:function(){var e=this.options.addClasses||"",t=$('<div class="tooltip-helper-text '+e+'"></div>');return t.text(this.options.text),this.options.minWidth&&t.css({minWidth:this.options.minWidth}),this.options.maxWidth&&t.css({maxWidth:this.options.maxWidth}),this.options.width&&t.css({width:this.options.width}),this.renderDfd=$.Deferred(),this.$el.append(t[0]),this.renderDfd.resolve(),this.renderDfd}},{simpleTooltip:function(e,t){var r=$(e.currentTarget),i=r.data();i||(i={}),i.tooltipKey||(i.tooltipKey=+(new Date));var s=r.offset();!t.tooltipOptions.notchX&&s.left<t.tooltipOptions.width&&(t.tooltipOptions.notchX=18);var o=t.tooltipOptions;o.helperTooltip=!0,o.views=[t],o.$attached=r,o.zIndex=999999,o.tooltipKey||(o.tooltipKey=i.tooltipKey),n.trigger("tooltip:open",o)}}),n.Views.Tooltips.ReportAd=Backbone.View.extend({templatePath:"tooltip",className:"report-ad",events:{"click .feedback-placeholder":"clickFeedbackPlaceholder","click .cancel-report":"onCancel","blur .feedback":"showFeedbackTooltip","focus .feedback":"hideFeedbackTooltip","click .submit-report":"submitReport"},initialize:function(e){this.reportedAdInfo=e.info},render:function(e){if(this.destroyed)return;return this.reported=!1,this.tooltip=e,this.template?(this.redraw(),this.renderDfd.resolve(),$.Deferred().resolve()):(this.renderDfd=$.Deferred(),this.fetchTemplate("reportAd").always(_.bind(this.onTemplate,this)),this.renderDfd)},onTemplate:function(e){this.template=e,this.redraw(),this.renderDfd.resolve()},redraw:function(){this.$el.html(this.renderTemplate(this.template,{}))},clickFeedbackPlaceholder:function(e){$(e.currentTarget).addClass("hide"),$(".feedback",this.$el).focus()},hideFeedbackTooltip:function(e){$(".feedback-placeholder",this.$el).addClass("hide"),this.tooltip&&(this.tooltip.options.persist=!0)},showFeedbackTooltip:function(e){$(e.currentTarget).val()||$(".feedback-placeholder",this.$el).removeClass("hide")},onCancel:function(){this.tooltip&&n.trigger("tooltip:close",this.tooltip.options.tooltipKey)},submitReport:function(){if(!this.reportedAdInfo||!this.tooltip||this.reported)return;var e=this.reportedAdInfo.unitName,t=this.reportedAdInfo.itemID,i=this.reportedAdInfo.capitalID,s=this.reportedAdInfo.extra?this.reportedAdInfo.extra:"",o=$(".feedback",this.$el).val(),u=$(".ad-select-reason",this.$el).val();n.Services.API.reportBadAd(e,o,s,u,t),this.reported=!0,this.onCancel(),r.ad.reportedAd(i),r.ad.updateAll(i),n.trigger("guts:forcelog","reportedAd",{placement:e,country:gsConfig.country.ID}),n.trigger("guts:gatrack","site","reportedAd",e+"_"+gsConfig.country.ID)}}),n.Views.Tooltips.Tour=Backbone.View.extend({templatePath:"tooltip",className:"tooltip-tour",events:{"click .next":"showNextTourTooltip","click .signUp":"signUp","click .signIn":"signIn","click #tooltip-close":"endTour","click .more-broadcast":"openAboutBroadcastLB","click .more-player":"openPlayerPost"},showNextTourTooltip:function(){n.trigger("guts:log","tourShowNext",{tourType:this.tourType,tourVisibleStep:this.current+1}),n.trigger("guts:gatrack","site","tour_"+this.tourType,"showNext_"+this.current+1),this.current++,this.redraw()},initialize:function(){var e=n.getLoggedInUserID(),i=n.Models.User.getCached(e),s;n.on("router:change",this.onRouterChange,this),n.on("lightbox:ready",this.onLightboxOpen,this),n.on("lightbox:destroyed",this.onLightboxDestroyed,this),i.get("isLoggedIn")?s="LOGGEDIN":s="LOGGEDOUT";var o={};o.homeIntro={name:"home",title:_.getString("TOUR_TITLE_HOMEINTRO_"+s),description:_.getString("TOUR_DESC_HOMEINTRO_"+s),setup:function(e){var t=i.getRawLocalRecentListens();!t.length&&s=="LOGGEDIN"&&(this.title=_.getString("TOUR_TITLE_HOMEINTRO_LOGGEDOUT"),this.description=_.getString("TOUR_TITLE_HOMEINTRO_LOGGEDOUT"));var o=r.page.getCurrentPageView();_.isInstance(o,n.Views.Pages.Home)?(e.y=0,e.x=320,e.notch="left",e.notchX=0,e.notchY=20,e.$attached=$($(".home-section")[0])):(e.y="bottom",e.x="center",e.notch="top",e.notchX=20,e.notchY=0,e.$attached=$("#logo"))}},o.profileMusic={name:"profile",title:_.getString("TOUR_TITLE_PROFILE"),description:_.getString("TOUR_DESC_PROFILE"),setup:function(e){e.y="bottom",e.x="center",e.notch="top",e.notchX=225,e.notchY=0,e.$attached=$("#profile-button")}},o.sidebar={name:"sidebar",title:_.getString("TOUR_TITLE_SIDEBAR"),description:_.getString("TOUR_DESC_SIDEBAR"),setup:function(e){e.y="middle",e.x=-265,e.notch="right",e.notchX=0,e.notchY=40,e.$attached=$("#sidebar")}},o.queue={name:"queue",title:_.getString("TOUR_TITLE_QUEUE"),description:_.getString("TOUR_DESC_QUEUE"),setup:function(e){var i=[{A:7183842,B:"Hundred Waters",C:2198980,D:"Hundred Waters",E:"7183842.jpg",F:0,H:1231210954,I:34804020,J:"Visitor",L:2,M:"0",N:0,P:[75,678],G:0},{A:7183842,B:"Hundred Waters",C:2198980,D:"Hundred Waters",E:"7183842.jpg",F:0,H:1231208126,I:34804016,J:"Sonnet",L:1,M:"0",N:0,P:[75,678,3489,7120,7518],G:0},{A:7183842,B:"Hundred Waters",C:2198980,D:"Hundred Waters",E:"7183842.jpg",F:0,H:1231206805,I:34804044,J:"Gather",L:11,M:"0",N:0,P:[75],G:0},{A:7183842,B:"Hundred Waters",C:2198980,D:"Hundred Waters",E:"7183842.jpg",F:0,H:1231206259,I:34804023,J:"Me & Anodyne",L:3,M:"0",N:0,P:[75],G:0}],s=$("#now-playing"),o=r.model.get("player"),u=o.get("currentQueue"),a=u&&u.get("songs");e.y="top",e.adjustY=-4,e.x=s.outerWidth()-160,e.notch="bottom",e.notchX=100,e.notchY=0,e.$attached=s;var f=r.queue;f.queueSize==="c"&&(e.hadToOpenQueue=!0,e.hadOpenedOnce=f.openedOnce,n.trigger("queue:setSize",f.lastUserQueueSize||f.bestQueueSize,!1,!1)),a&&!a.length&&(i=new n.Models.Collections.Songs(i),e.addedSongs=i,n.trigger("player:addSongs",i,t,!1,{type:"tour"}))},teardown:function(e){var t=r.queue,i=r.model.get("player"),s=i.get("currentQueue"),o=s&&s.get("songs"),u=[];if(e.addedSongs&&i.get("playStatus")===0&&o.length){var a=e.addedSongs.pluck("SongID");u=o.filter(function(e){return _.indexOf(a,e.get("SongID"))!=-1})}e.hadToOpenQueue&&u.length==o.length&&(n.trigger("queue:setSize","c",!1,!1),e.hadOpenedOnce||(t.openedOnce=!1)),u.length&&n.trigger("player:removeSongs",u)}},o.signUp={name:"signup",title:_.getString("TOUR_TITLE_SIGNUP"),description:_.getString("TOUR_DESC_SIGNUP"),setup:function(e){e.y="bottom",e.x="center",e.notch="top",e.notchX=225,e.notchY=0,e.$attached=$("#header-signup-btn")}},o.newPlayer={name:"newPlayer",title:_.getString("TOUR_NEW_PLAYER"),description:_.getString("TOUR_NEW_PLAYER_DESC"),setup:function(e){e.y="top",e.x=40,e.notch="bottom",e.notchX=30,e.notchY=0,e.$attached=$("#player-container")}},o.leapMotion={name:"leapMotion",title:_.getString("TOUR_TITLE_LEAP_MOTION"),description:_.getString("TOUR_DESC_LEAP_MOTION"),setup:function(e){e.y="top",e.x=40,e.notch="bottom",e.notchX=30,e.notchY=0,e.$attached=$("#player-container")}},this.renderDfd=$.Deferred(),this.options.type=="broadcast"?this.tour=[o.broadcast]:this.options.type=="newPlayer"?this.tour=[o.newPlayer]:this.options.type=="leapMotion"?this.tour=[o.leapMotion]:(this.tour=[o.homeIntro],s=="LOGGEDIN"?(this.tour.push(o.profileMusic,o.sidebar,o.queue),this.tourType="GENERAL_LOGGEDIN"):(this.tour.push(o.queue,o.signUp),this.tourType="GENERAL_LOGGEDOUT")),this.current=0,n.trigger("guts:log","tourStart",{tourType:this.tourType,tourLength:this.tour.length}),n.trigger("guts:gatrack","site","tour_"+this.tourType,"tourStart")},render:function(e){return this.manager=e,this.fetchTemplate("tour").always(_.bind(this.onTemplate,this)),this.renderDfd.promise()},redraw:function(){var e=this.current-1;this.tour[e]&&this.tour[e].teardown&&this.tour[e].teardown(this.manager.options);if(!this.tour[this.current]){this.endTour();return}this.tour[this.current].setup&&this.tour[this.current].setup(this.manager.options),this.$el.html(this.renderTemplate(this.template,{title:this.tour[this.current].title,description:this.tour[this.current].description,step:this.current+1,steps:this.tour.length,type:this.options.type})),this.currentName=this.tour[this.current].name,this.hasDrawn&&this.manager.onRendered(),this.hasDrawn=!0},onTemplate:function(e){this.template=e,this.redraw(),this.renderDfd.resolve()},onRouterChange:function(){this.currentName&&this.currentName=="home"&&this.redraw()},onLightboxOpen:function(){this.manager&&this.manager.$el.addClass("hide")},onLightboxDestroyed:function(){this.manager&&this.manager.$el.removeClass("hide")},onDestroy:function(){n.off("router:change",this.onRouterChange),n.off("lightbox:ready",this.onLightboxOpen),n.off("lightbox:destroyed",this.onLightboxDestroyed),n.off("queue:setSize",null,this)},endTour:function(){n.trigger("tooltip:close","tour");if(this.options.type=="newPlayer"){var e=n.getLoggedInUserID();n.Services.Local.set("newPlayerTooltip"+e,1)}else this.options.type!=="leapMotion"&&_.defer(function(){var e=new n.Views.Tooltips.Helper({text:_.getString("TOUR_FOLLOWUP")}),t={currentTarget:$("#settings-button")[0]};e.tooltipOptions.persist=!0,e.tooltipOptions.tooltipKey="tourFollowup",n.Views.Tooltips.Helper.simpleTooltip(t,e),setTimeout(function(){n.trigger("tooltip:close","tourFollowup")},6e3)});n.trigger("guts:log","tourEnd",{tourType:this.tourType}),n.trigger("guts:gatrack","site","tour_"+this.tourType,"end_"+this.current)},signIn:function(){n.trigger("tooltip:close","tour"),n.trigger("lightbox:open","login"),n.trigger("guts:log","tourTriggerSignInLB",{tourType:this.tourType}),n.trigger("guts:gatrack","site","tour_"+this.tourType,"triggerSignInLB")},signUp:function(){n.trigger("tooltip:close","tour"),n.trigger("lightbox:open","signup"),n.trigger("guts:log","tourTriggerSignUpLB",{tourType:this.tourType}),n.trigger("guts:gatrack","site","tour_"+this.tourType,"triggerSignUpLB")},openAboutBroadcastLB:function(){this.endTour(),n.trigger("lightbox:open","broadcastAbout")},openPlayerPost:function(){this.endTour(),e.open("http://blog.grooveshark.com/private/54365323281/tumblr_mp9u8xmhoz1qz9si0","_blank")}}),n.Views.Tooltips.Tutorial=Backbone.View.extend({templatePath:"tooltip",className:"tooltip-tutorial-inner",events:{click:"doTutorialAction","click .close":"showNextTutorialTooltip"},showNextTutorialTooltip:function(){return this.current++,this.redraw(),!1},initialize:function(){n.on("router:change",this.onRouterChange,this),n.on("lightbox:ready",this.onLightboxOpen,this),n.on("lightbox:destroyed",this.onLightboxDestroyed,this),this.tutorial=this.options.tooltips,this.renderDfd=$.Deferred(),this.current=0,this.on("all",function(){var e=this.options.onTutorialAction;e&&e.apply(this,_.toArray(arguments));var t=this.options.onTutorialActionComplete;t&&t.apply(this,_.toArray(arguments))},this)},render:function(e){return this.manager=e,this.fetchTemplate("tutorial").always(_.bind(this.onTemplate,this)),this.renderDfd.promise()},redraw:function(){var e=this.current-1;this.manager&&this.tutorial[e]&&this.tutorial[e].teardown?this.tutorial[e].teardown(this.manager.options):this.manager||console.trace();if(!this.tutorial[this.current]){this.endTutorial();return}this.tutorial[this.current].setup&&this.tutorial[this.current].setup(this.manager.options),this.$el.html(this.renderTemplate(this.template,{title:this.tutorial[this.current].title})),this.currentName=this.tutorial[this.current].name,this.hasDrawn&&this.manager.onRendered(),this.hasDrawn=!0,this.manager.$el.removeClass("hide")},onTemplate:function(e){this.template=e,this.redraw(),this.renderDfd.resolve()},doTutorialAction:function(){this.tutorial[this.current].action&&this.tutorial[this.current].action(),this.showNextTutorialTooltip()},onRouterChange:function(){this.redraw()},onLightboxOpen:function(){this.manager&&this.manager.$el.addClass("hide")},onLightboxDestroyed:function(){this.manager&&this.manager.$el.removeClass("hide")},onDestroy:function(){n.off("router:change",this.onRouterChange),n.off("lightbox:ready",this.onLightboxOpen),n.off("lightbox:destroyed",this.onLightboxDestroyed)},endTutorial:function(){n.Services.Local.set("broadcastTutorialComplete",!0),n.trigger("tooltip:close","tutorial")},closeTooltip:function(){n.trigger("tooltip:close","tutorial")}}),n.Views.Tooltips.Comment=Backbone.View.extend({templatePath:"tooltip",events:{"submit #tooltip-comment-submit":"onSubmit","click .btn.close":"closeTooltip"},initialize:function(e){this.options=e,this.model=e.model||{},this.user=e.user,this.placeholderTextKey=e.placeholderTextKey||"COMMENT_TOOLTIP_SONG",this.originalSongID=this.model.get("SongID"),this.userID=this.user.get("UserID"),n.on("app:resize",this.closeTooltip,this)},render:function(){return this.renderDfd=$.Deferred(),this.fetchTemplate("comment").always(_.bind(this.onTemplate,this)),this.renderDfd},onDestroy:function(){n.off("app:resize",null,this)},onTemplate:function(e){this.$el.html(this.renderTemplate(e,this)),this.renderDfd.resolve()},onSubmit:function(e){function o(){n.Models.Comment.storeComment("song",i,r).always(function(){n.trigger("tooltip:close",s)})}e.stopPropagation(),e.preventDefault();var t=$("input",e.currentTarget),r=t.val(),i=this.originalSongID,s=this.options.tooltipKey;this.userID>0?o():n.trigger("lightbox:open","login",{message:_.getString("LB_LOGIN_MUST_LOGIN_TO_COMMENT"),onLogin:_.bind(o,this)})},closeTooltip:function(){n.trigger("tooltip:close",this.options.tooltipKey)},hasUserInteracted:function(){var e=this.$el.find(".tooltip-comment-input");return e.length>0&&(e.is(":focus")||e.val())?!0:!1}}),n.Views.Tooltips.BroadcastTag=Backbone.View.extend({templatePath:"tooltip",events:{"keyup .tag-filter":"filterTagsDebounced","click .tag-item":"onClickTag"},initialize:function(e){this.options=e,this.filteredResults={};if(typeof this.options.tags=="object"){var t=[];for(var r in this.options.tags)this.options.tags.hasOwnProperty(r)&&t.push(r);this.options.tags=t}if(this.options.defaultTags==="object"){var i=[];for(var s in this.options.tags)this.options.tags.hasOwnProperty(s)&&i.push(s);this.options.defaultTags=i}this.filterTagsDebounced=_.debounce(_.bind(this.filterTags,this),5),n.on("app:resize",this.closeTooltip,this)},onDestroy:function(){n.off("app:resize",null,this)},render:function(){return this.renderDfd=$.Deferred(),this.fetchTemplate("broadcastTag").always(_.bind(this.onTemplate,this)),this.renderDfd},onTemplate:function(e){this.$el.html(this.renderTemplate(e,this)),this.displayTags(this.options.tags,!0);var t=this.$el.find(".tag-filter"),n=this.$el.find(".tag-list");_.delay(function(){n.tinyscrollbar()},10),this.renderDfd.resolve()},displayTags:function(e,t){var n=this.$el.find(".tag-list-overview").empty(),r;t&&this.options.defaultTags&&(e=this.options.defaultTags);for(var i=0,s=e.length;i<s;i++)r=document.createElement("a"),r.className="tag-item",r.innerHTML=_.escape(this.options.capitalize?_.ucwords(e[i]):e[i]),n.append(r);this.$el.find(".tag-list").tinyscrollbar_update()},filterTags:function(e){var t=$(e.currentTarget),n=t.val().toLowerCase(),r=n.length;if(!n||!r){this.displayTags(this.options.tags,!0);return}if(this.filteredResults[n]){this.displayTags(this.filteredResults[n]);return}var i=[],s=[],o,u;for(var a=0,f=this.options.tags.length;a<f;a++)o=this.options.tags[a],u=o.toLowerCase().indexOf(n),u>0?i.push(o):u===0&&s.push(o);s=_.sortBy(s,function(e){return e.length}),i=s.concat(i),this.filteredResults[n]=i,this.displayTags(i)},filterTagsDebounced:function(){},onClickTag:function(e){var t=$(e.currentTarget),n=t.text();this.options.submit&&this.options.submit(n.toLowerCase()),this.closeTooltip()},closeTooltip:function(){n.trigger("tooltip:close",this.options.tooltipKey)}}),n.Views.Tooltips.DisplayName=Backbone.View.extend({templatePath:"tooltip",events:{"submit .display-name-form":"onSubmit","click .close":"closeTooltip"},initialize:function(e){this.options=e,this.submitDeferred=e.onSubmitDeferred,n.on("app:resize",this.closeTooltip,this)},onDestroy:function(){this.options.$attached&&this.options.$attached.removeClass("pending"),n.off("app:resize",null,this)},render:function(){return this.renderDfd=$.Deferred(),this.fetchTemplate("displayName").always(_.bind(this.onTemplate,this)),this.renderDfd},onTemplate:function(e){var t=r.model.get("user"),n="";t.get("hasDefaultName")||(n=t.get("Name")),this.$el.html(this.renderTemplate(e,{name:n}));var i=this.$el.find(".placeholder-input");setTimeout(function(){i.focus()},0),this.renderDfd.resolve()},onSubmit:function(e){e.stopPropagation(),e.preventDefault();var t=$.trim(this.$el.find(".placeholder-input").val()),i=r.model.get("user"),s=this.$el.find(".control");if(!t)return this.$el.find(".tooltip-desc").data("translateText","ENTER_NAME_BEFORE_CHAT").text(_.getString("ENTER_NAME_BEFORE_CHAT")),this.$el.find(".info-tooltip").addClass("hide"),s.addClass("error"),!1;s.removeClass("error"),i.changeUserInfo({FName:t}).always(_.bind(function(e){if(e&&e.statusCode===1)this.closeTooltip(),this.submitDeferred&&this.submitDeferred.resolve();else{var r="SAVE_PROFILE_FAILED";if(e&&e.statusCode===-17){r="POPUP_SETTINGS_RESERVED_WORDS";var i=this.$el.find(".info-tooltip"),s={word:"grooveshark"};t.indexOf("shark")>-1||t.indexOf("adm")>-1&&(s.word="admin"),i.attr("title",_.getString("WORD_IS_RESERVED",s)),this.$el.find(".tooltip-desc").data("translateText","CHANGE_NAME_BEFORE_CHAT").text(_.getString("CHANGE_NAME_BEFORE_CHAT")),i.removeClass("hide")}n.trigger("notification:add",{description:_.getString(r),type:"error",duration:5e3})}},this))},closeTooltip:function(){n.trigger("tooltip:close",this.options.tooltipKey)}}),n.Views.Tooltips.Clipboard=Backbone.View.extend({templatePath:"tooltip",events:{"click .btn-copy":"clickCopyBtn","click .current-url":"clickCurrentURL"},render:function(){return this.renderDfd=$.Deferred(),this.destroyDfd=$.Deferred(),this.fetchTemplate("clipboard").always(_.bind(this.onTemplate,this)),this.renderDfd},onTemplate:function(t){this.$el.html(this.renderTemplate(t,{url:e.location.toString()})),this.renderDfd.resolve()},onDestroy:function(){this.destroyDfd.resolve()},clickCopyBtn:function(t){var r=e.location.toString();n.External.DesktopBridge.trigger("clipboard",r),this.$(".btn-copy").data("translateText","COPIED").text(_.getString("COPIED"))},clickCurrentURL:function(e){$(e.currentTarget).select()}})}(),function(){n.Views=n.Views||{},n.Views.Notifications=n.Views.Notifications||{};var t=1,r=Backbone.Model.extend({defaults:{notifID:0,name:"generic",type:"",duration:6500,slots:[1],timeout:!1,listenersSet:!1,timestamp:null,priority:5,template:"generic",title:"",description:"",image:"",url:"",className:"",target:"_self",options:null,data:{}}});n.Views.Notification=Backbone.View.extend({el:document.getElementById("notifications"),events:{mouseover:"stopTimers",mouseout:"startTimers"},initialize:function(){this.notifications=[],this.notifsQueue=[],this.maxOpenNotifs=3,this.pauseNotifications=!1,n.on("notification:add",this.addNotification,this),n.on("notification:close",this.closeNotification,this)},addNotification:function(e){var t=new n.Views.Notifications.Base({model:new r(e)});this.notifsQueue.push(t),this.notifsQueue.sort(function(e,t){return t.model.get("priority")-e.model.get("priority")}),this.renderNotification(),n.trigger("notification:opened",t)},renderNotification:_.throttle(function(){if(this.notifications.length>=this.maxOpenNotifs||this.pauseNotifications){setTimeout(_.bind(this.renderNotification,this),1e3);return}var e=this.notifsQueue.shift();if(!e)return;e.on("notification:rendered",function(){this.$el.prepend(e.$el),e.$el.fadeTo(650,1),this.startTimers([e])},this),e.render(),this.notifications.push(e),e.trigger("notification:rendered",e),this.notifsQueue.length&&this.renderNotification()},2e3),startTimers:function(e){this.pauseNotifications=!1;var t=e&&e.length?e:this.notifications;for(var n=0;n<t.length;n++)t[n].model.get("duration")&&(t[n].timeout||(t[n].timeout=setTimeout(_.bind(this.closeNotification,this,t[n]),t[n].model.get("duration"))))},stopTimers:function(e){e.length||(this.pauseNotifications=!0);var t=e.length?e:this.notifications;for(var n=0;n<t.length;n++)clearTimeout(t[n].timeout),t[n].timeout=null},closeNotification:function(e){if(!e.closing){e.closing=!0;var t=null,n=this,r=_.once(function(){clearTimeout(t);var r=_.indexOf(n.notifications,e);n.notifications.splice(r,1),e.destroy(),n.startTimers(),n.renderNotification(),e.closing=!1});e.$el.fadeOut(400,r),t=setTimeout(r,1e3)}}},{}),n.Views.Notifications.Base=Backbone.View.extend({templatePath:"notifications",tagName:"div",className:"notification",events:{"click .close":"close","click .action":"onHandleClick"},initialize:function(){var t=this.generateNotificationID();this.model.set("notifID",t),this.model.set("timestamp",new Date),this.$el.attr("id","notif-"+t),this.$el.data("view",this),this.$el.data(this.model.get("data")),this.model.get("className")&&this.$el.addClass(this.model.get("className")),this.model.get("click")&&this.$el.on("click",_.bind(function(e){this.model.get("url")||e.preventDefault(),this.model.get("click")(this),this.close()},this));if(this.model.get("activeDuration")){var n=this.model.get("rate")||1e3,r=this.model.get("activeDuration"),i=!0;$(e).focus(function(){i=!0}).blur(function(){i=!1}),this.timer=setInterval(_.bind(function(){i&&(r--,r<=0&&this.close())},this),n)}var s=this.model.get("initFunc");_.isFunction(s)&&s(this)},onDestroy:function(){this.model.get("closeAction")&&this.model.get("closeAction")(),this.timer&&clearInterval(this.timer)},render:function(){var e=this.model.get("template")?this.model.get("template"):this.model.get("name");this.fetchTemplate(e).done(_.bind(this.openNotification,this))},openNotification:function(e){this.$el.append(this.renderTemplate(e));var t=this.model.get("onOpened");t&&t(this)},generateNotificationID:function(){return t++},onHandleClick:function(e){this.model.get("clickAction")?this.model.get("clickAction")(this,e):this.close()},close:function(e){e&&(e.preventDefault(),e.stopPropagation()),n.trigger("notification:close",this)}})}(),function(){n.Views=n.Views||{},n.Views.Theme=n.Views.Theme||{},n.Views.Theme=Backbone.View.extend({currentTheme:null,lastTheme:null,themesLocation:"themes",templatePathBase:"themes/",templatePath:null,themeRegex:/^#!\/(theme)\/(.*)\/?/,promoRegex:/^#!\/(promotion)\/(.*)\/?/,defaultID:814,premiumID:814,themeNotifRateLimit:864e5,lastThemeNotification:null,themeSetByURL:!1,isFirstVisit:!1,currentPage:null,isFirstVisitPending:!1,themePreferences:{},activeSong:null,user:null,getFromServerTimeoutID:null,takeoverPreview:null,themePending:!1,lastPage:null,isPremium:!1,initializaed:!1,isHome:!1,isTemporary:!1,lastUser:null,lastArtist:null,customID:999,isPersonalized:!1,events:{},initialize:function(){this.$pageWrapper=$("#page-wrapper"),this.$stage=$("#stage"),n.on("theme:set",_.bind(this.getFromServer,this)),this.model.get("player").on("change:currentQueue",function(){this.model.get("player").get("currentQueue").on("change:activeSong",this.onActiveSongChange,this)},this),n.on("change:page",_.bind(this.onPageChange,this)),n.on("change:page:type",_.bind(this.onPageChange,this)),n.on("notification:opened",_.bind(this.onOpenNotification,this)),n.on("theme:notification",_.bind(this.onHandleNotification,this)),n.on("locale:change",_.bind(this.onLocaleChange,this)),n.on("theme:click",_.bind(this.onThemeClick,this)),n.on("theme:video",_.bind(this.onPlayVideo,this)),n.on("theme:videoheader",_.bind(this.onVideoHeader,this)),n.on("theme:interactiontimeout",_.bind(this.onInteractionTimeout,this)),n.on("theme:userchange",_.bind(this.onThemeUserChange,this)),this.themePreferences=n.Services.Local.get("themePreferences")||{},n.ready.done(_.bind(this.onAppReady,this))},onAppReady:function(){location.hash&&(location.hash.match(this.themeRegex)||location.hash.match(this.promoRegex))&&(this.themeSetByURL=!0),n.Models.Theme.getThemeDefinitions().always(_.bind(function(){this.model.on("change:user",this.onUserChange,this),_.delay(_.bind(this.onUserChange,this))},this))},onUserChange:function(){var e=!this.user;this.user=this.model.get("user"),this.isPremium=this.user.get("subscription").isPremium(),this.onThemeUserChange();if(this.isPremium)this.initialized=!0,this.isFirstVisit=!1,this.currentPage&&this.setLastOrDefault();else if(e){var t=$.Deferred(),r=new Date;this.themeSetByURL?(n.Services.Local.set("isFirstVisit",!1),n.Services.Local.set("firstVisitCount",5),this.isFirstVisit=!1,this.initialized=!0,n.Services.API.isFirstVisit().always(function(){},this,t)):(this.isFirstVisit=!(this.user.get("UserID")>0||_.defined(n.Services.Local.get("isFirstVisit"))&&n.Services.Local.get("firstVisitCount")>=2),this.isFirstVisit?n.Services.API.isFirstVisit().always(_.bind(this.onIsFirstVisitCheck,this,t)):(n.Services.Local.set("isFirstVisit",!1),n.Services.Local.set("firstVisitCount",5),this.currentPage&&(this.currentPage.canTheme?this.getFromServer():this.hideThemeComponents()),this.initialized=!0))}else this.themeChangeGracePeriod()&&!this.isFirstVisit&&(this.currentPage&&this.currentPage.canTheme?this.getFromServer():this.hideThemeComponents());e&&(this.user.on("change:subscription",_.bind(function(){var e=this.isPremium!=this.user.getIsPremium();this.isPremium=this.user.getIsPremium(),e&&this.setLastOrDefault()},this)),this.user.on("change:isArtist",_.bind(function(){this.isArtist=this.user.get("isArtist"),this.contextChanged=!0},this)),this.callPageChangeOnUserSet&&this.onPageChange.apply(this,this.callPageChangeOnUserSet))},onIsFirstVisitCheck:function(e,t){this.isFirstVisit=t,n.Services.Local.set("isFirstVisit",!1);if(this.isFirstVisit)_.defined(n.Services.Local.get("firstVisitCount"))||n.Services.Local.set("firstVisitCount",1),this.canShowThemeByID(this.defaultID)&&!this.currentTheme&&this.setCurrentTheme(this.defaultID),this.trackFirstVisit(),n.Services.GUTS.beginContext({isFirstVisit:!0}),n.Services.GUTS.gaSetCustomVariable(1,"User",this.user.getUserStringForAnalytics()+",N:Y");else{if(!_.defined(n.Services.Local.get("firstVisitCount")))n.Services.Local.set("firstVisitCount",5);else{var r=n.Services.Local.get("firstVisitCount");this.isFirstVisit=++r<2,n.Services.Local.set("firstVisitCount",r)}this.themeChangeGracePeriod()&&!this.isFirstVisit&&this.currentPage&&(this.currentPage.canTheme?this.getFromServer():this.hideThemeComponents())}this.initialized=!0},setLastOrDefault:function(){if(this.themeSetByURL)return;n.Models.Theme.getThemeDefinitions().always(_.bind(function(){this.isArtist?n.Models.Artist.getCached(this.user.get("artistID")).getPageNameData().always(_.bind(function(e){e.ThemeOptions?(e.ThemeOptions.themeFolder="/artistthemes/",this.setCurrentTheme(e.ThemeOptions.ThemeID,{savePreference:!0,options:{ThemeOptions:e.ThemeOptions}})):this.setCurrentTheme(this.defaultID,{savePreference:!0})},this)):this.isPremium?this.user.getPageNameData().always(_.bind(function(e){e&&e.ThemeOptions?this.setCurrentTheme(e.ThemeOptions.ThemeID,{savePreference:!0,options:{ThemeOptions:e.ThemeOptions}}):this.setCurrentTheme(this.defaultID,{savePreference:!0})},this)):this.canShowThemeByID(this.defaultID)&&this.isHome&&this.setCurrentTheme(this.defaultID)},this))},onPremiumPageChange:function(e,t,r){this.lastPage&&this.lastPage.type=="settings"&&this.lastPage.subpage=="design"?n.trigger("theme:set",{last:!0}):!this.currentTheme||this.currentTheme&&this.currentTheme.get("promotion")||this.isTemporary?(this.setLastOrDefault(),this.isTemporary=!1):this.currentTheme.trigger("theme:pageChange",this.currentPage)},onPageChange:function(e,t,r){if(e=="profile")return;if(!this.user){this.callPageChangeOnUserSet=_.toArray(arguments);return}delete this.callPageChangeOnUserSet,this.lastPage=this.currentPage,this.currentPage={type:e,params:t,view:r,subpage:t?t.subpage:null,section:t?t.section:null,canTheme:n.Models.Theme.themePageCheck(e,{section:t?t.section:null})},this.currentPage.key=this.currentPage.type+(this.currentPage.params.artistID||this.currentPage.params.id)+(this.currentPage.section&&this.currentPage.section=="broadcast"?null:this.currentPage.subpage)+this.currentPage.section,this.currentPage.key+=this.currentPage.type=="search"?this.currentPage.params.type:"",this.isHome=this.currentPage.type=="home";if(this.lastPage&&this.lastPage.key==this.currentPage.key||this.themeSetByURL||this.themePending)return;if(this.contextChanged){this.setLastOrDefault(),this.contextChanged=!1;return}switch(this.currentPage.type){case"user":case"artist":case"playlist":case"album":case"song":this.handleUserThemePages();return}if(this.isPremium){this.onPremiumPageChange(e,t,r);return}if(this.currentTheme){if(this.currentPage.canTheme&&this.getTime()-this.takeoverPreview<18e4){this.currentTheme.trigger("theme:pageChange",this.currentPage);return}this.takeoverPreview=null;if(!this.isHome&&this.lastPage.type!="home"&&this.currentPage.canTheme&&this.currentTheme.get("sitetakeover")){this.currentTheme.trigger("theme:pageChange",this.currentPage),this.loadThemeImpression();return}this.currentPage.type=="artist"&&(this.currentPage.artistID=t.artistID);if(this.currentTheme.get("artist")&&this.currentTheme.get("artistID")==this.currentPage.artistID){this.currentTheme.trigger("theme:pageChange",this.currentPage),this.loadThemeImpression();return}}if(!this.initialized)return;if(!this.currentPage.canTheme){this.setCurrentTheme(this.defaultID);return}this.isHome&&this.hideThemeComponents();if(this.isHome&&this.isFirstVisit){this.setCurrentTheme(this.defaultID);return}if(location.hash.match(this.promoRegex))return;this.getFromServer()},handleUserThemePages:function(){var e=this.currentPage.view.getCurrentPageView(),t,r,i;switch(this.currentPage.type){case"artist":i=this.currentPage.params.artistID;if(i==442780&&gsConfig.country.ID==223&&!this.isPremium){this.setCurrentTheme(1495,{temporary:!0,manual:!0});return}if(this.lastArtist!=i||this.lastPage&&this.lastPage.type!="artist")t=n.Models.Artist.getCached(i),t=t&&n.Models.User.getCached(t.get("profileID")),t?this.handleThemeOptions(t,!0):(r=e.model,r.on("change:artist",function(e){this.handleThemeOptions(e.get("artist"),!0),r.off("change:artist",null,this)},this));this.lastArtist=i;break;case"user":i=this.currentPage.params.id,(this.lastUser!=i||this.lastPage&&this.lastPage.type!="user")&&this.handleThemeOptions(n.Models.User.getCached(i)),this.lastUser=i;break;case"playlist":r=e.model,r.on("change:owner",function(e){this.handleThemeOptions(e.get("owner")),r.off("change:owner",null,this)},this);break;case"album":case"song":r=e.model,r.get("artist")?r.get("artist").get("profileID")?this.handleThemeOptions(n.Models.User.getCached(r.get("artist").get("profileID")),!0):n.Models.Profile.get(null,r.get("artist").get("ArtistID")).done(_.bind(function(e){this.handleThemeOptions(n.Models.User.getCached(e.get("ProfileID")),!0)},this)):r.on("change:artist",function(e){r.get("artist").get("profileID")?this.handleThemeOptions(n.Models.User.getCached(r.get("artist").get("profileID")),!0):n.Models.Profile.get(null,r.get("artist").get("ArtistID")).done(_.bind(function(e){this.handleThemeOptions(n.Models.User.getCached(e.get("ProfileID")),!0)},this)),r.off("change:artist",null,this)},this)}},handleThemeOptions:function(e,t){e&&e.getPageNameData().always(_.bind(function(n){if(n.ThemeOptions){var r=this.isArtist&&this.user.get("artistID")==e.id||this.user.get("UserID")==e.id;n.ThemeOptions.themeFolder=t&&!1?"/artistthemes/":"/userthemes/",this.setCurrentTheme(n.ThemeOptions.ThemeID||999,{savePreference:r,temporary:!r,manual:!0,options:{ThemeOptions:n.ThemeOptions}})}else!this.isPremium&&this.currentPage.params&&this.currentPage.params.section=="broadcast"?this.getFromServer():this.setCurrentTheme(this.defaultID,{temporary:!0})},this))},getFromServer:function(e){if(e&&e.themeID&&n.Models.Theme.themes[e.themeID]&&(n.Models.Theme.themes[e.themeID].premium||n.Models.Theme.themes[e.themeID].user)){this.setCurrentTheme(e.themeID,e);return}var t=$.Deferred(),r;n.Models.Theme.getThemeDefinitions().always(_.bind(function(){if(!this.currentPage)r="grooveshark.home";else switch(this.currentPage.type){case"home":r="grooveshark.home";break;default:r="grooveshark.ros"}if(e){if(e.last)this.setLastOrDefault();else if((e.manual||e.temporary)&&e.themeID){n.trigger("ad:handleHomeCapital","remove"),this.currentPage=this.currentPage=this.currentPage?this.currentPage:{type:"home"},this.themeSetByURL=!0;var i=["id="+e.themeID,"m=1","dcmt=text/json","sz=777x777",this.getTime()+"="+this.getTime()],s=";"+i.join(";");n.Services.API.getThemeFromDFP(r,s).done(_.bind(this.onHandleFromServer,this,t,e))}}else{e=e||{};var o={failed:!0};$.extend(o,e),this.getFromServerTimeoutID=setTimeout(_.bind(function(){this.setLastOrDefault(),this.isHome&&$(".decoupledCapital, .theme-capital").remove()},this),12e3),n.Services.API.getThemeFromDFP(r,this.getParams(e)).done(_.bind(this.onHandleFromServer,this,t,e)).fail(_.bind(this.onHandleFromServer,this,t,o))}},this)),this.isHome&&(this.themePending=!0,n.trigger("theme:pending",!0))},onHandleFromServer:function(e,t,r){clearTimeout(this.getFromServerTimeoutID);if(t.failed){this.setLastOrDefault();return}if(!r){this.setLastOrDefault();return}try{r=$.parseJSON(r)}catch(i){console.log("Invalid JSON from theme server",i);if(!t||t&&!t.manual){this.setLastOrDefault();return}}n.Models.Theme.getThemeDefinitions().always(_.bind(function(){if(t&&(t.manual||t.temporary)){if(!n.Models.Theme.themes[t.themeID]&&t.themeID==r.themeID)n.Models.Theme.themes[t.themeID]=r;else if(!n.Models.Theme.themes[t.themeID]){console.log("Theme: Could not find theme"),$.ajax({url:"themes/"+t.name+"/theme.css",cache:!0}).done(_.bind(function(){n.Models.Theme.themes[t.themeID]={themeID:t.themeID,location:t.name,sections:["#theme-wall","#theme-header"],capital:{source:"source.html",width:300,height:250}},this.setCurrentTheme(t.themeID,t)},this)).fail(_.bind(function(){this.setLastOrDefault()},this));return}if(t.themeID&&t.themeID!=r.themeID){this.setCurrentTheme(t.themeID,t);return}}else if(r.themeID<0){this.trackDefault(r.themeID,r.tracking),this.setLastOrDefault();return}n.Models.Theme.themes[r.themeID]?$.extend(n.Models.Theme.themes[r.themeID],r):n.Models.Theme.themes[r.themeID]=r,n.Models.Theme.themes[r.themeID].tracking&&n.Models.Theme.themes[r.themeID].tracking.length&&(n.Models.Theme.themes[r.themeID].sponsored=!0),(this.canShowThemeByID(r.themeID)||t&&(t.manual||t.temporary))&&this.setCurrentTheme(r.themeID,t)},this))},getParams:function(){var e=["dcmt=text/json","sz=777x777"],t=";",r=";";return n.Models.Ad.getParams(e,t,r,this)},lastThemeSetTS:null,setCurrentTheme:function(e,t){n.Models.Theme.getThemeDefinitions().always(_.bind(function(){if(!n.Models.Theme.themes[e])return;if(this.lastThemeSetTS&&this.getTime()-this.lastThemeSetTS<1e3)return;this.lastThemeSetTS=this.getTime(),this.lastTheme=this.currentTheme,this.lastTheme&&this.lastTheme.trigger("theme:destroy"),this.currentTheme=new n.Models.Theme(n.Models.Theme.themes[e]),this.lastTheme&&this.currentTheme.get("themeID")!=this.lastTheme.get("themeID")&&this.hideThemeComponents(),this.model.get("theme").off(),this.model.set({theme:this.currentTheme}),this.currentTheme.set("view",this),this.currentTheme.set("options",t?t.options:null);if(this.isHome||this.themePending)this.themePending=!1,n.trigger("theme:change",this.currentTheme,this.isFirstVisit);this.templatePath=this.templatePathBase+this.currentTheme.get("location"),this.render().done(_.bind(function(){n.trigger("page:redrawUpdate"),setTimeout(_.bind(function(){this.showThemeComponents()},this),0)},this)),t&&(t.savePreference&&!t.temporary&&this.setLastTheme(e),this.isTemporary=t.temporary,t.name=="sitetakeover"&&!this.isPremium&&(this.takeoverPreview=this.getTime())),this.themeSetByURL=!1,this.loadThemeImpression()},this))},render:function(){var e=$.Deferred();if(this.currentTheme){$("#themeStyleSheet").attr("href",[gsConfig.assetHost,this.themesLocation,this.currentTheme.get("location"),"theme.css"].join("/")+"?ver="+_.orEqual(this.currentTheme.get("version"),1));var t=$("#page");$(".theme-component").remove();if(!this.currentTheme.get("sections")||this.currentTheme.get("sections")&&_.indexOf(this.currentTheme.get("sections"),"#theme-theme")>=0)this.fetchTemplate("theme").always(_.bind(function(n){if(this.destroyed)return;var r={view:this,section:"#page-wrapper",currentTemplate:"theme"};t.before(this.renderTemplate(n,r)),this.currentTheme.trigger("theme:theme"),e.resolve()},this));else{t.before('<div id="theme-wall" class="theme-component"></div><div id="theme-header" class="theme-component"></div><div id="theme-expand" class="theme-component"></div>');var n=this.currentTheme.get("sections"),r=[],i,s=n.length,o;for(i=0;i<s;i++)o=n[i],o!="#theme-videoheader"&&o!="#theme-notif"&&o!="#theme-interactiontimeout"&&r.push(this.renderSection(o));$.after(r).done(_.bind(e.resolve,e))}}return e.promise()},renderSection:function(e){$(e).show();var t=e.replace("#theme-",""),n=$.Deferred();return this.fetchTemplate(t).always(_.bind(function(r){if(this.destroyed)return;var i=$(e);if(i.length){var s={view:this,section:e,currentTemplate:t};i.html(this.renderTemplate(r,s))}this.currentTheme.trigger("theme:"+t),n.resolve()},this)),n.promise()},canShowThemeByID:function(e){return e&&n.Models.Theme.themes[e]&&this.currentPage?this.currentPage.canTheme||this.currentPage.isThemeSubPage:!1},themeChangeGracePeriod:function(){if(this.currentTheme){var e=this.currentTheme.get("gracePeriod");if(e)return this.getTime()-e.timeOfAction>e.period}return!0},trackDefault:function(e,t){this.currentPage&&this.currentPage.type=="home"&&(n.Models.Ad.loadTracking(["http://ad.doubleclick.net/ad/grooveshark.home/;id="+e+";d=1;sz=1x1;ord="+this.getTime()]),n.Models.Ad.loadTracking(t),n.Services.API.logTargetedThemeImpression(e),n.Services.GUTS.logEvent("trackDefaultTheme",{id:e}))},trackFirstVisit:function(){},onLocaleChange:function(e){this.currentTheme&&this.currentTheme.trigger("locale:change",e)},onThemeClick:function(e){e&&e.currentTarget&&this.currentTheme&&(e.data={currentTheme:this.currentTheme},n.Models.Theme.handleClick(e))},onPlayVideo:function(e){this.currentTheme&&(index=_.orEqual(e.index,0),n.trigger("lightbox:open","video",{videos:this.currentTheme.get("videos"),index:index}))},onVideoHeader:function(){this.currentTheme.trigger("theme:videoheader"),this.currentTheme&&this.currentTheme.get("videoheader")&&this.currentTheme.get("videoheader").tracking&&n.Models.Ad.loadTracking(this.currentTheme.get("videoheader").tracking)},onInteractionTimeout:function(){this.currentTheme.trigger("theme:interactiontimeout"),this.currentTheme&&this.currentTheme.get("interactiontimeout")&&this.currentTheme.get("interactiontimeout").tracking&&n.Models.Ad.loadTracking(this.currentTheme.get("interactiontimeout").tracking)},onThemeUserChange:function(){this.currentTheme&&this.currentTheme.trigger("theme:user")},onActiveSongChange:function(){var e=this.model.get("player").get("currentQueue").get("activeSong");this.currentThemeNotification&&(n.trigger("notification:close",this.currentThemeNotification),this.currentThemeNotification=null),e&&this.onHandleNotification({artistID:e.get("ArtistID"),artistName:e.get("ArtistName")})},onHandleNotification:function(e){var t=this.getTime(),r=n.Models.Theme.notification&&(n.Models.Theme.notification.options.themeID==1279||n.Models.Theme.notification.options.themeID==1280||n.Models.Theme.notification.options.themeID==1297);if(r&&Math.random()<=.1&&!this.isHome&&e.artistID&&n.Models.Theme.notification&&(!this.lastThemeNotification||t-this.lastThemeNotification>this.themeNotifRateLimit)&&(!this.currentTheme||!this.currentTheme.get("sitetakeover"))&&(n.Models.Theme.notification.themeID!=this.currentTheme.get("themeID")||n.Models.Theme.notification.selfOverride)){setTimeout(_.bind(function(){this.notifReplacements(n.Models.Theme.notification,e),n.trigger("notification:add",n.Models.Theme.notification),this.lastThemeNotification=t,n.Models.Theme.notification=null},this),e.timeout||0);return}!this.isHome&&e.artistID&&n.Models.Theme.notification&&n.Models.Theme.notification.options.artistIDs&&_.indexOf(n.Models.Theme.notification.options.artistIDs,e.artistID)>=0&&(!this.lastThemeNotification||t-this.lastThemeNotification>this.themeNotifRateLimit)&&(!this.currentTheme||!this.currentTheme.get("sitetakeover"))&&(n.Models.Theme.notification.themeID!=this.currentTheme.get("themeID")||n.Models.Theme.notification.selfOverride)&&setTimeout(_.bind(function(){this.notifReplacements(n.Models.Theme.notification,e),n.trigger("notification:add",n.Models.Theme.notification),this.lastThemeNotification=t,n.Models.Theme.notification=null},this),e.timeout||0)},notifReplacements:function(e,t){e.title&&(e.title=e.title.replace("{artistName}",t.artistName)),e.description&&(e.description=e.description.replace("{artistName}",t.artistName))},onOpenNotification:function(e){e.model.get("type")&&e.model.get("type")=="theme"&&(this.currentThemeNotification=e,n.Models.Ad.loadTracking(e.model.get("options").tracking))},setLastTheme:function(e){var t=this.user.get("UserID");this.themePreferences[t]?this.themePreferences[t].lastTheme=e:this.themePreferences[t]={lastTheme:e,lastSeen:{}},this.savePreferences()},getLastTheme:function(){var e=this.user.get("UserID");return this.themePreferences[e]&&this.themePreferences[e].lastTheme?this.themePreferences[e].lastTheme:null},loadThemeImpression:function(){this.currentTheme&&this.currentTheme.get("sponsored")&&this.currentTheme.get("tracking")&&(n.Services.API.logTargetedThemeImpression(this.currentTheme.get("themeID")),n.Models.Ad.loadTracking(this.currentTheme.get("tracking")))},showThemeComponents:function(){this.$pageWrapper.addClass("theme"),this.$stage.addClass("theme"),$(".theme-component").show()},hideThemeComponents:function(){$("#themeStyleSheet").attr("href",""),this.$pageWrapper.removeClass("theme"),this.$stage.removeClass("theme"),$(".theme-component").hide()},savePreferences:function(){n.Services.Local.set("themePreferences",this.themePreferences)},getTime:function(){return(new Date).getTime()}}),n.Views.Theme.Base=Backbone.View.extend({})}(),function(){n.Views=n.Views||{},n.Views.Ad=n.Views.Ad||{};var t=0,i=0;n.Views.Ad=Backbone.View.extend({rotateTimer:0,defaultRotationTime:3e4,maxIdleTime:18e4,currentPage:null,lastPage:null,currentTheme:null,themePending:!1,IS_IDLE:!1,IDLE_COUNT:3e4,theme:null,user:null,isFirst:!1,placements:{},isHome:!1,isPremium:!1,adHost:null,events:{},initialize:function(){n.on("page:ready",_.bind(this.onPageReady,this)),n.on("theme:pending",_.bind(this.onThemePending,this)),n.on("theme:change",_.bind(this.onThemeChange,this)),n.on("ad:createPlacements",_.bind(this.createAll,this)),n.on("ad:killRotation",_.bind(this.stopRotation,this)),this.model.on("change:user",this.onUserChange,this),$(e).resize(_.bind(this.repositionAll,this)),n.on("authUser:personalizedSongsLoaded",_.bind(this.setGenreTagsForUser,this)),n.on("ad:updatePositions",_.bind(this.repositionAll,this)),n.on("ad:resetRotation",_.bind(this.resetRotation,this)),n.on("ad:handleHomeCapital",_.bind(this.handleHomeCapital,this)),n.on("change:page",_.bind(this.onPageChange,this)),n.ready.done(_.bind(this.onAppReady,this)),gsConfig.country.ID==38&&(this.maxIdleTime=18e4),gsConfig.country.ID==177&&(this.defaultRotationTime=this.IDLE_COUNT=12e4)},onAppReady:function(){this.onUserChange(),this.adHost=gsConfig.runMode!="production"?gsConfig.assetHost:"http://ads-grooveshark.com",this.adHost&&$.receiveMessage(this.adHost).progress(_.bind(this.handlePostMessage,this)),$.receiveMessage(e.location.protocol+"//"+e.location.host).progress(_.bind(this.handlePostMessage,this))},onUserChange:function(){this.user&&(this.user.off(null,null,this),this.user.get("subscription").off(null,null,this)),this.user=this.model.get("user"),this.isPremium=this.user.get("subscription").canHideAds();var e=this,t=function(){e.user.get("subscription").canHideAds()&&(clearInterval(e.rotateTimer),e.rotateTimer=null,$("body").off("mousemove."+e.cid),$("#page-wrapper").off("scroll."+e.cid),e.removeAll(),$(".capital").height(0))};this.user.on("change:subscription",function(){this.user.get("subscription").on("adUpdate",t,this),t()},this),this.user.get("subscription").on("adUpdate",t,this),this.isPremium?(clearInterval(this.rotateTimer),this.rotateTimer=null,$("body").off("mousemove."+this.cid),this.removeAll()):this.currentPage&&(this.removeAll(),this.currentPage=null)},onPageChange:function(e){if(this.isPremium)return;this.hideAll()},onPageReady:function(e){this.lastPage=this.currentPage,this.currentPage={type:e.pageType,subpage:e.pageType=="search"?e.searchType:e.model.get("subpage"),section:e.model.get("section"),isThemePage:n.Models.Theme.themePageCheck(e.pageType),view:e},this.currentPage.key=this.currentPage.type+this.currentPage.id+this.currentPage.subpage+this.currentPage.section,this.isHome=this.currentPage.type=="home";if(this.isPremium)return;if(this.lastPage&&this.lastPage.key==this.currentPage.key)return;if(this.isHome&&(!this.currentTheme||this.isFirst)){this.removeAll();return}if(n.Views.Pages.Broadcast&&_.isInstance(e,n.Views.Pages.Broadcast)){var t=e.model.get("broadcast");if(t&&t.get("activeStatus")){this.removeAll();return}}if(this.themePending){this.removeAll();return}this.isHome&&this.removeAll();if(this.lastPage)switch(this.lastPage.type){case"popular":case"tags":this.removeAll(!0);break;case"artist":page.section=="albums"&&this.removeAll(!0);break;case"album":page.subpage=="related-albums"&&this.removeAll(!0)}this.render()},onThemeChange:function(e,t){this.isFirst=t,this.currentTheme=this.model.get("theme"),this.onThemePending(!1)},onThemePending:function(e){this.themePending=e;if(!this.themePending&&this.isHome){if(this.isFirst){this.removeAll();return}this.isPremium||this.handleHomeCapital(this.currentTheme&&this.currentTheme.get("capital")?null:"remove")}},createAll:function(e,t){_.each(e||$(".capital"),_.bind(function(e,r){var i=$(e),s="#"+i.data("capitalId"),o=parseFloat(i.attr("data-capital-width")),u=parseFloat(i.attr("data-capital-height")),a={isHome:this.isHome,preventRotation:t&&t.preventRotation,isThemeCapital:t&&t.isThemeCapital,width:o,height:u,user:this.user,currentTheme:this.model.get("theme"),currentPage:t&&t.currentPage?t.currentPage:this.currentPage};$(s).length&&this.placements[s]?(_.extend(this.placements[s],a),this.placements[s].update()):this.placements[s]=new n.Models.Ad(a)},this)),!e&&$(".capital").length&&(n.trigger("guts:log","adRotation",{pageChange:!0}),n.Models.Ad.adRotationCount++)},updateAll:function(e){var t={},r=e&&this.placements["#"+e]?[this.placements["#"+e]]:null;_.each(r||this.placements,_.bind(function(e){e.preventRotation=r?!1:e.preventRotation,e.update()&&!e.preventRotation&&(t[e.dimensions]=!0)},this)),_.isEmpty(t)||(n.trigger("guts:log","adRotation",t),delete t["728x90"],_.isEmpty(t)||n.Models.Ad.adRotationCount++)},repositionAll:function(){_.each(this.placements,function(e){e.reposition()})},refreshAll:function(){_.each(this.placements,function(e){e.refresh()})},hideAll:function(){_.each(this.placements,function(e){e.hide()})},removeAll:function(e){this.isHome&&this.handleHomeCapital("remove"),_.each(this.placements,function(t){if(e&&t.isThemeCapital)return;t.remove()}),this.placements={}},resetRotation:function(){clearInterval(this.rotateTimer),(!this.isHome||this.currentTheme&&this.currentTheme.get("rotateOnHome"))&&gsConfig.country.ID!=106&&(this.rotateTimer=setInterval(_.bind(this.onRotation,this),this.defaultRotationTime))},onRotation:function(e){var t=$.now(),n=t-r.lastActive;n<=this.maxIdleTime&&(this.IS_IDLE=n>=this.IDLE_COUNT,this.updateAll())},stopRotation:function(){clearInterval(this.rotateTimer)},render:function(){this.isHome||n.trigger("guts:log","adRotation",{pageChange:!0}),clearInterval(this.rotateTimer),this.rotateTimer=setInterval(_.bind(this.onRotation,this),this.defaultRotationTime),this.hideAll(),this.createAll()},setGenreTagsForUser:function(){if(!this.user)return;this.user.getPersonalizedTags({}).done(_.bind(function(e){if(e&&e.length){var t=n.Services.Local.get("personalizedTags")||{};t[this.user.get("UserID").toString()]=_.pluck(e,"0").splice(0,5),n.Models.Ad.personalizedTags=t,n.Services.Local.set("personalizedTags",t)}},this))},handleHomeCapital:function(e){var t=$("#column1");e=this.isPremium?"remove":e;if(e=="remove"){$(".decoupledCapital").remove();var r=$($("#column1 .home-section")[0]);t.removeClass("has-capital"),$(".home-capital").remove(),r.removeClass("small-home-section spaced-home-section")}else if(!this.themePending&&this.currentTheme&&this.currentTheme.get("capital")&&!$(".home-capital").length&&$(".home-section").length>=3){var r=$($("#column1 .home-section")[0]);r.addClass("small-home-section first-home-section"),t.addClass("has-capital").prepend('<div class="capital-column home-capital"><div id="capital-300x250-placeholder" class="capital" data-capital-width="300" data-capital-height="250" data-capital-id="capital-300x250"></div></div>'),n.trigger("guts:log","adRotation",{pageChange:!0}),this.createAll($("#capital-300x250-placeholder"))}},handlePostMessage:function(t){_.each(t,_.bind(function(t,r){switch(t.action){case"preventRotation":this.placements[t.unit]&&(this.placements[t.unit].preventRotation=!0);break;case"loadTracking":n.Models.Ad.loadTracking(t.tracking);break;case"location":e.location.hash=t.hash;break;case"lightbox":n.trigger("lightbox:open",t.name,t.options);break;case"adLoaded":t.itemID&&t.unitDimensions&&$("iframe","#capital-"+t.unitDimensions).data("adInfo",t);break;case"logOutbound":n.Services.API.logThemeOutboundLinkClick(t.themeID,t.clickID);break;case"theme":var i=$("<a></a>").attr("data-click-id",t.clickID).attr("data-click-action",t.themeAction).attr("data-"+t.themeAction+"-id",t.themeActionID);t.themeID&&i.attr("data-theme-id",t.themeID),n.Models.Theme.handleClick({currentTarget:i[0],data:{currentTheme:this.currentTheme}});break;case"themeEvent":this.currentTheme&&t.event&&this.currentTheme.trigger(t.event);break;case"updateDimensions":if(this.isHome)return;if(this.placements[t.unit]){var s=this.placements[t.unit];s.width=t.width,s.height=t.height,s.$capital.find("iframe").css({width:t.width,height:t.height}),t.noAnim?(s.$placeholder.css({width:t.width,height:t.height+s.footerHeight}),s.$capital.css({width:t.width,height:t.height+s.footerHeight})):(s.$capital.animate({height:t.height+s.footerHeight},250),s.$placeholder.animate({height:t.height+s.footerHeight},250))}}},this))},reportedAd:function(e){e="#"+e,$(e).length&&this.placements[e]&&(this.placements[e].reportCount++,this.placements[e].firstReport=$.now())}},{}),n.Views.Ad.Base=Backbone.View.extend({})}(),function(){function i(e){if(e&&e.item===this.itemID&&e.type===this.typeID&&e.result){var t=e.result.comment;n.Models.Comment.handleUsersArtistsInResult([e.result.comment],e.result.users,e.result.artists),t=new n.Models.Comment(t,{dontCache:!0}),t.UserID!==n.getLoggedInUserID()&&this.collection.unshift(t);if(t.get("ParentID")){var r=n.Models.Artist.getCached(t.get("ParentID"));r&&r.get("comments")&&r.get("comments").unshift(t)}}}function s(e){if(e&&e.item===this.itemID&&e.type===this.typeID&&e.result){var t=this.collection.get(e.commentID),r=e.result.response;if(r.UserID===n.getLoggedInUserID())return;n.Models.Comment.handleUsersArtistsInResult([e.result.response],e.result.users,e.result.artists),t.addResponse(r)}}n.Views=n.Views||{};var e=400,t=400;n.Views.Comments=Backbone.View.extend({events:{"submit #comment-submit":"commentSubmit","keydown .comment-input":"onCommentInputKeyBlur","click .form-placeholder-comments":"focusOnCommentInput","blur .comment-input":"onCommentInputKeyBlur","submit .module-item-respond":"responseSubmit","input .comment-input":"checkCommentLength","input .module-item-respond":"checkReplyLength"},initialize:function(){this.rendered=!1,this.modelBindings=[],this.commentModules=[],this.subscribed=!1,this.highlightComment=null,this.commentStyleType=this.options.commentStyleType,this.isDashboard=_.orEqual(this.options.isDashboard,!1),this.options.comment?(this.subscribed=!0,this.collection=new n.Models.Collections.Comments([this.options.comment],{modelOptions:{dontCache:!0}})):this.options.highlightComment&&(this.highlightComment=this.options.highlightComment),this.item=this.options.item,this.itemID=_.toInt(this.options.itemID),this.typeID=_.toInt(this.options.typeID),this.showPostBox=_.orEqual(this.options.showPostBox,!0),this.itemName=_.orEqual(this.options.itemName,""),this.getUserPicture=_.bind(n.getLoggedInUserPicture,n),this.visibleComments=0,this.modelBindings.push(this.collection.on("add",this.renderNewComment,this)),this.modelBindings.push(this.collection.on("remove",this.removeCommentFromPage,this)),this.modelBindings.push(n.on("manatee:newComment",i,this)),this.modelBindings.push(n.on("manatee:newResponse",s,this))},onDestroy:function(){_.each(this.modelBindings,_.bind(function(e){e.off(null,null,this)},this)),_.each(this.commentModules,function(e){e.destroy()}),this.subscribed&&n.Services.SWF.ready.done(_.bind(function(){n.Services.SWF.unsubscribeFromItemComments(this.itemID,this.typeID)},this)),this.commentNameTooltip&&!this.commentNameTooltip.destroyed&&(this.commentNameTooltip.closeTooltip(),this.commentNameTooltip=null)},subscribe:function(){if(this.subscribed)return;n.Services.SWF.ready.done(_.bind(function(){n.Services.SWF.subscribeToItemComments(this.itemID,this.typeID)},this)),this.subscribed=!0},render:function(){if(this.rendered)return;this.subscribe(),this.fetchTemplate("shared/comments").always(_.bind(this.renderComments,this))},renderComments:function(e){if(this.destroyed)return;this.rendered=!0;var t=[],r=this.highlightComment?this.highlightComment.id:0,i=0,s=this.isDashboard,o;this.collection.each(_.bind(function(e){if(!e.get("author")||e.get("Reports")>=3&&!s)return;if(e.id===r){i++;return}var o=new n.Views.Modules.Comment({model:e,pageItemID:this.itemID,pageTypeID:this.typeID,commentStyleType:this.commentStyleType,getUserPicture:this.getUserPicture});this.commentModules.push(o),o.render(),t.push(o.$el[0]),i++},this)),this.visibleComments=i,this.$el.html(this.renderTemplate(e,this)),!i&&s&&this.$el.find(".empty-page").removeClass("hide");if(this.highlightComment!==-1&&this.highlightComment){var u=new n.Views.Modules.Comment({model:this.highlightComment,highlighted:!0,pageItemID:this.itemID,pageTypeID:this.typeID,commentStyleType:this.commentStyleType,getUserPicture:this.getUserPicture});this.commentModules.unshift(u),u.render(),o=u.$el,t.unshift(o[0]),o.addClass("highlight")}this.$el.find(".page-loading").remove(),this.$commentsEl=this.$el.find("#comments-grid"),this.$commentsEl.append(t)},addComments:function(e){var t=[],r=this.isDashboard;e.each(_.bind(function(e){if(!e.get("author")||e.get("Reports")>=3&&!r)return;var i=new n.Views.Modules.Comment({model:e,pageItemID:this.itemID,pageTypeID:this.typeID,commentStyleType:this.commentStyleType,getUserPicture:this.getUserPicture});this.commentModules.push(i),i.render(),t.push(i.$el[0])},this)),this.$el.find("#comments-grid").append(t),this.collection.add(e,{dontCache:!0,silent:!0})},renderNewComment:function(e){if(!this.rendered||!this.$commentsEl)return;if(!e.get("author"))return;var t=new n.Views.Modules.Comment({model:e,pageItemID:this.itemID,pageTypeID:this.typeID,commentStyleType:this.commentStyleType,getUserPicture:this.getUserPicture});this.commentModules.push(t),t.render(),this.$commentsEl.prepend(t.$el[0]),$(".first-comment-message").hide()},removeCommentFromPage:function(e){_.each(this.commentModules,function(t){t.model.id===e.id&&t.destroy()})},responseSubmit:function(e){e.preventDefault();var n=$("input",e.currentTarget),r=n.val();if(n.hasClass("pending")||!r)return;var i=$(e.currentTarget).data("parentId"),s=this.collection.get(i);if(!(n.val().length<=t))return;s.storeResponse(r).done(function(){n.val(""),n.removeClass("pending")}).fail(function(){n.removeClass("pending")}),n.addClass("pending")},commentSubmit:function(t){function a(){var e=r.model.get("user");if(e.get("hasDefaultName")||e.get("Name").replace(/\s/g,"").match(/(gr[o0]{2}veshark)/i)){var t=$.Deferred();t.done(_.bind(a,this)),this.commentNameTooltip=new n.Views.Tooltips.DisplayName({onSubmitDeferred:t,tooltipKey:"displayNameTooltip",$attached:i}),n.trigger("tooltip:open",{delay:0,notchSize:6,width:280,notch:"bottom",notchX:150,views:[this.commentNameTooltip],x:-135,y:"top",$attached:i,tooltipClass:"display-name",tooltipKey:"displayNameTooltip",persist:!0})}else n.Services.API.storeCommentForItem(this.itemID,this.typeID,s,u).done(function(e){e&&e.CommentID?(e.user=n.Models.User.getCached(n.getLoggedInUserID()),o.unshift(e),i.val("")):(n.trigger("notification:add",{description:_.getString("POPUP_ERROR_COMMENT_FAILED"),type:"error",duration:5e3}),n.trigger("guts:log","commentFailNoComment"),n.trigger("guts:gatrack","site","commentFailNoComment")),i.removeClass("pending")}).fail(function(){n.trigger("notification:add",{description:_.getString("POPUP_ERROR_COMMENT_FAILED"),type:"error",duration:5e3}),i.removeClass("pending"),n.trigger("guts:log","commentFailDeferred"),n.trigger("guts:gatrack","site","commentFailDeferred")})}t.preventDefault();var i=$("input",t.currentTarget),s=i.val(),o=this.collection;if(i.hasClass("pending")||!s)return;var u=null;typeof this.item.getDetailsForFeeds=="function"&&(u=this.item.getDetailsForFeeds());if(n.getLoggedInUserID()>0){if(!(i.val().length<=e))return;a.call(this)}else n.trigger("lightbox:open","login",{message:_.getString("LB_LOGIN_MUST_LOGIN_TO_COMMENT"),preventRedirect:!0,onClose:function(){i.removeClass("pending")}});i.addClass("pending")},onCommentInputKeyBlur:function(e){var t=$("#comment-submit");e.which?t.addClass("focused"):$(e.currentTarget).val()||t.removeClass("focused")},focusOnCommentInput:function(e){$("#comments .comment-input").focus()},checkCommentLength:function(t){var n=$("#comment-submit .comment-input");n.val().length>e?n.addClass("comment-input-error"):n.val().length<=e&&n.removeClass("comment-input-error")},checkReplyLength:function(e){var n=$("input",e.currentTarget);n.val().length>t?n.addClass("reply-input-error"):n.val().length<=t&&n.removeClass("reply-input-error")}})}(),function(){n.Views=n.Views||{},n.Views.ActivityFeed=Backbone.View.extend({events:{},initialize:function(){this.rendered=!1,this.modelBindings=[],this.feedEventModules=[],this.highlightFeedEvent=null,this.options.highlightFeedEvent&&(this.highlightFeedEvent=this.options.highlightFeedEvent),this.collection=new n.Models.Collections.FeedEvents(this.collection.models,{feedType:"model",ownerModel:this.model}),this.modelBindings.push(this.collection.on("remove",this.removeFeedEventFromPage,this))},onDestroy:function(){_.each(this.modelBindings,_.bind(function(e){e.off(null,null,this)},this)),_.each(this.feedEventModules,function(e){e.destroy()})},render:function(){if(this.rendered)return;var e=_.chainLoading();e.push(this.collection.setPerPage(10)),e.push(this.fetchTemplate("shared/smallActivityFeed").always(_.bind(this.renderFeed,this)))},renderFeed:function(e){if(this.destroyed)return;this.rendered=!0;var t=[],r=this.feedEventModules,i=this.highlightFeedEvent?this.highlightFeedEvent.id:0,s;this.collection.getCurrentPage().each(function(e){if(!e.getNormalizedObject(!1,!1,!0)||e.id===i)return;var s=new n.Views.Modules.SmallFeedEvent({model:e});r.push(s),s.render(),t.push(s.$el[0])}),this.$el.html(this.renderTemplate(e));if(this.highlightFeedEvent!==-1&&this.highlightFeedEvent){var o=new n.Views.Modules.SmallFeedEvent({model:this.highlightFeedEvent,highlighted:!0});r.unshift(o),o.render(),s=o.$el,t.unshift(s[0]),s.addClass("highlight"),s.find(".feed-comments-container").removeClass("hide")}this.$el.find(".page-loading").remove(),this.$feedEventsEl=this.$el.find("#small-activity-grid"),this.$feedEventsEl.append(t),s&&setTimeout(function(){s.stop().animate({backgroundColor:"#fff"},5e3)},1e3)},removeFeedEventFromPage:function(e){_.each(this.feedEventModules,function(t){t.model.id===e.id&&t.destroy()})}})}(),define("/gs/views/pages/home.js",function(){function o(){(r.height()-e.scrollTop()<i||this.renderedSections&&this.renderedSections.length<2)&&this.attemptRenderSections(!0)}function u(){e[0].scrollHeight<=e[0].clientHeight+120&&this.attemptRenderSections(!0)}function a(e,t){var r=new n.Models.Collections.Songs(e),i=new n.Models.Collections.Songs(t),s=_.difference(r.pluck("SongID"),i.pluck("SongID"));return _.filter(e,function(e){return _.contains(s,e.get("SongID"))})}n.Views=n.Views||{},n.Views.Pages=n.Views.Pages||{};var e,r,i,s,f=Backbone.View.extend({className:"content home-section",events:{"mouseenter .home-content":"onMouseenterContent","mouseleave .home-content":"onMouseleaveContent","click .play-section":"playSection","click .previous-pageable-nav":"pageablePrevious","click .next-pageable-nav":"pageableNext","click .broadcast-about-link":"onBroadcastAboutClick","selectstart .home-pageable-nav":"cancelSelect"},initialize:function(e){var t={addClass:"",title:"",titleKey:"",taglineKey:"",titleOptions:{},taglineOptions:{},canPlay:!1,pageable:!1};this.options=_.defaults({},e,t),this.currentPage=0},render:function(e,t){this.options.addClass&&this.$el.addClass(this.options.addClass),this.$el[0].innerHTML=this.renderTemplate(this.template,this.options);if(this.options.pageable||e===0){var n=this.$el.find(".home-grid-container");n.addClass("pagable")}_.isFunction(this.options.render)&&this.options.render.call(this,e,t),this.grid&&(this.grid.$scrollElement.off("scroll."+this.grid.cid),this.$gridContainer=this.grid.$el.parent(),this.pageableAdjust())},onMouseenterContent:function(){this.$el.addClass("attention")},onMouseleaveContent:function(){this.$el.removeClass("attention")},pageablePrevious:function(e){this.pageableNext(e,-1)},pageableNext:function(e,t){if(this.grid){t=t||1;var r=this.$gridContainer.width(),i=this.grid.options.itemWidth,s=this.grid.$el.width()/i,o=Math.floor((r+20)/i),u=Math.ceil(s/o),a=this.grid,f=this.currentPage;this.options.section==="tag"?n.trigger("guts:log","homepageClick",{homepageAction:"onPageableNext",positionOnPage:this.options.positionOnPage,pageableNextDirection:t,pageableNextTagID:this.options.tag.tagID,pageableNextPage:this.currentPage,pageableNextItemsPerPage:o,pageableNextNumberOfItems:s}):n.trigger("guts:log","homepageClick",{homepageAction:"onPageableNext",positionOnPage:this.options.positionOnPage,pageableNextDirection:t,pageableNextSection:this.options.section.toLowerCase(),pageableNextPage:this.currentPage,pageableNextItemsPerPage:o,pageableNextNumberOfItems:s}),this.currentPage=this.currentPage+t,this.currentPage<0&&(this.currentPage=u-1),this.currentPage>u-1&&(this.currentPage=0);if(f==this.currentPage)return;var l=this.currentPage*o*i;o<7&&(l=Math.floor(l/i)*i),a.blockSize=Math.max(a.blockSize,(this.currentPage+1)*7),a.maximumVisibleItems=a.blockSize,a.handleScroll({force:!0,overrideScrollPos:l}),a.$el.stop(!0).animate({left:l*-1},{duration:275})}},pageableAdjust:function(){var e=this.$gridContainer.width(),t=this.grid.options.itemWidth,n=Math.floor((e+20)/t);$(".home-pageable-nav",this.el)[this.grid.collection.length<=n?"addClass":"removeClass"]("hide")},playSection:function(){var e=this.$gridContainer.width(),r=this.grid.options.itemWidth,i=this.grid.$el.width()/r,o=(e+20)/r,u=[],f=s.model.get("player"),l=f&&f.get("currentQueue");o%1<.3&&(o=Math.floor(o)),l.attributes.shuffleEnabled&&n.trigger("player:shuffle",!1);if(n.isBroadcastListener()){var c=f.get("currentQueue"),h=!1,p=_.bind(this.playSection,this),d=function(){var e=function(){if(h)return;h=!0,f.off("change:currentQueue",e),c.off("change",e),p()};n.Services.SWF.stopSong(),n.Services.SWF.clearQueue(),f.on("change:currentQueue",e),c.on("change",e)};n.trigger("lightbox:open","radioClearQueue",{startRadio:d,inBroadcast:!0});return}if(this.grid.collection instanceof n.Models.Collections.Songs){var v=new n.Models.PlayContext({contextType:"clientRadio",fromUserAction:!0});v.addStreamType(n.Models.PlayContext.TYPE_HOME_RADIO_SEEDS);var m=Math.floor(o)*this.currentPage,g=m+Math.ceil(o);u=this.grid.collection.models.slice(m,g),n.trigger("player:addSongs",u,n.Services.SWF.playSpecialIndexes.DEFAULT,!0,v);if(n.isBroadcaster())return;_.isFunction(this.options.getClientRadioSongs)||n.trigger("guts:startNewAutoplayContext","autoplay",0,"song",_.map(u,function(e){return e.get("SongID")}).toString())}_.delay(_.bind(function(){_.isFunction(this.options.getClientRadioSongs)&&this.options.getClientRadioSongs().done(_.bind(function(e){var r=s.model.get("player"),i=r&&r.get("currentQueue"),o=i&&i.get("clientRadio");u=(u||[]).concat(i.get("songs").models),e=a(e.models,u),o.disable().reset(e).enable(),o.onActiveSongChange(i,i.get("activeSong")),o.on("needSongs",function(e,t){var r=e.pluck("ArtistID"),i=e.frowns.pluck("ArtistID"),s={secondaryArtistWeightModifier:.1,seedArtistWeightRange:[80,90],weightModifierRange:[-9,9],seeds:r,frowns:i};n.trigger("guts:forcelog","clientRadioFallbackToServer",{fallbackSeedArtistIDs:r.toString(),fallbackSeedFrownArtistIDs:i.toString()}),n.trigger("guts:startAutoplayFallbackContext","autoplay",0,"artist",r.toString()),n.Services.SWF.setAutoplay(!0,0,s,"autoplayGetSongEx")},this),n.trigger("guts:startNewAutoplayContext",this.options.gutsType,this.options.gutsID,u.length?"song":t,u.length?_.map(u,function(e){return e.get("SongID")}).toString():t)},this))},this),750),this.options.section=="tag"?(n.trigger("guts:gatrack","site","onPlaySectionTag",this.options.tag.tagID),n.trigger("guts:log","homepageClick",{homepageAction:"onPlaySection",positionOnPage:this.options.positionOnPage,playSectionTagID:this.options.tag.tagID,playSectionPage:this.currentPage,playSectionItemsPerPage:o,playSectionNumberOfItems:i})):(n.trigger("guts:gatrack","site","onPlaySection",this.options.section.toLowerCase()),n.trigger("guts:log","homepageClick",{homepageAction:"onPlaySection",positionOnPage:this.options.positionOnPage,playSectionSection:this.options.section.toLowerCase(),playSectionPage:this.currentPage,playSectionItemsPerPage:o,playSectionNumberOfItems:i}))},cancelSelect:function(e){return e.preventDefault(),!1},onBroadcastAboutClick:function(e){e.preventDefault(),n.trigger("lightbox:open","broadcastAbout")}}),l=["ownerSubscribed"];n.Views.Pages.Home=n.Views.Pages.Base.extend({templatePath:"home",pageType:"home",currentTrendingGenre:"",currentPopularType:"daily",getMoreSectionsPos:0,defaultTags:[3773,156,2856,1748,1933,75,10,750,156,424,2360,7512],blacklist:[6994,8488],subscribedBroadcasts:null,events:{"click .listen-again-options":"onListenAgainOptions"},initialize:function(){s=this.model.get("gsApp"),this.rendered=!1,this.childViews=[],this.subscribedBroadcasts=new n.Models.Collections.Broadcasts([]),e=$("#page-wrapper"),r=$("#page"),i=(Math.ceil(e.height()/235)+1)*235,e.on("scroll."+this.cid,_.throttle(_.bind(o,this),50)),this.throttledOnResize=_.throttle(_.bind(u,this),50),n.on("app:resize",this.throttledOnResize),n.on("locale:change",this.setWelcomeMessage,this),this.model.get("appModel").on("change:user",function(){if(this.destroyed)return;this.pageReady=_.once(function(){n.trigger("page:ready",this)}),this.pageReady(),this.cleanupChildViews(),this.render()},this),this.pageReady=_.once(function(){n.trigger("page:ready",this)});var t=this.model.get("appModel").get("tooltipOptionsCache");t&&(t.songMini={mini:!0,pageNameWait:0,delay:250,notch:"left",notchSize:4,notchY:15,x:126,y:30,beforeRender:function(e,t,n){var r=0,i=e,s=e,o=_.getScrollableParent(e),u=0;do u++,i[0]==s[0]&&(r+=i.position().left,s=s.offsetParent()),i=i.parent();while(i[0]!=o[0]&&u<1e4);r+=o.scrollLeft();var a=o.width();r+320+120>=a&&(n.x="left",n.notch="right")}})},onDestroy:function(){var t=this.model.get("appModel").get("user");t&&t.off("change",this.updateUserStats,this),n.off("app:resize",this.throttledOnResize),n.off(null,null,this),e.off("scroll."+this.cid),this.model.get("appModel").off("change:user",null,this),this.subscribedBroadcasts.length&&(this.subscribedBroadcasts.unsubscribe(),this.subscribedBroadcasts.reset([]),this.subscribedBroadcasts.off())},render:function(){var e=this;this.rendered=!1,this.sections=[],this.renderedSections=[],this.timeoutExpired=!1,this.chain=_.chainLoading({ignoreFails:!0});var t=function(){e.timeoutExpired||(e.timeoutExpired=!0,_.bind(o,e)())},r=this.chain,i=_.debounce(t,1e3);if(this.options.params.notFound)r.push(this.fetchTemplate("not_found").always(r.bind(this.onTemplate,this)));else{var s=this.model.get("appModel").get("user");s.on("change",this.updateUserStats,this),r.push(this.fetchTemplate("section").done(r.bind(this.onSectionTemplate,this))),r.push(this.fetchTemplate("index").always(r.bind(this.onTemplate,this)).done(r.bind(this.updateUserStats,this,s,{force:!0}))),r.done(r.bind(this.renderSection,this));var u,a,f=function(e){u=e};r.push(s.getPersonalizedSongs(!0).done(r.bind(this.onPersonalizedSongs,this)).done(r.bind(f)).done(r.bind(this.attemptRenderSections,this,!0,!0)).done(r.bind(this.updateUserStats,this,s,{force:!0}))),r.done(r.bind(function(){i();var a=s.getPersonalizedTags({defaultTags:e.defaultTags,blacklist:e.blacklist});a.done(function(t){var i=["bcast"],s={};_.each(t,function(e){return s[e[0]]=!0,e[1]&&e[1].length>2&&i.push("bcast_genre_"+e[0]),i.length<5}),e.model.set("personalizedTags",s),r.add(n.Models.Broadcast.getTopBroadcastsForTags(i).done(r.bind(e.onTopBroadcastsForTags,e))),r.add(e.onRecentListens(r,t))});if(u){var f=s.get("dominateRecentArtistsSorted");if(f&&f.length){var l=_.pluck(f,0);r.add(n.Services.API.getRecommendedSongs(_.first(l,6),_.first(l,12)).always(r.bind(function(t){e.onRecommendedSongs(t)})))}}r.done(function(){setTimeout(t,100),_.bind(o,e)()})},this)),a=n.Services.API.featuredGetCurrentFeatured(),r.add(a.done(r.bind(this.onFeaturedContent,this))),a=n.Services.API.popularGetSongsPreview(),r.add(a.done(r.bind(this.onPopularSongs,this)))}this.setTitle("Listen to Free Music Online - Internet Radio - Free MP3 Streaming",!1)},getMoreSections:function(){if(this.getMoreSectionsDfd&&this.getMoreSectionsDfd.state()=="pending")return this.getMoreSectionsDfd;this.getMoreSectionsDfd=$.Deferred(),this.getMoreSectionsPos++;var e=this.model.get("appModel").get("user");if(this.getMoreSectionsPos==1){var t=_.bind(function(t){if(!t||!t.length){this.getMoreSectionsDfd.reject();return}var r={};t.each(function(e){var t=e.getSongsPlayed(),i=_.toInt(e.get("UserID")),s=(new n.Models.Collections.Songs(t)).pluck("AlbumID");for(var o=0,u=s.length,a;o<u;o++)a=s[o],r[a]?_.indexOf(r[a][1],i)==-1&&r[a][1].push(i):r[a]=[a,[i]]});var i=function(e){return e[1].length*-1},s=_.first(_.sortBy(r,i),14),o=[];for(var u=0,a=s.length,l;u<a;u++)l=n.Models.Album.getCached(s[u][0]),l&&o.push(l);o.length>1&&this.sections.push(new f({titleKey:"TOP_COMMUNITY_ALBUMS",weight:200,taglineKey:"TAGLINE_COMMUNITY",section:"topAlbums",canPlay:!1,pageable:!0,user:e,render:function(e,t){var r=new n.Models.Collections.Albums(o),i=this.$el.find(".home-content");i.empty(),this.grid=new n.Views.AlbumGrid({itemsPerRow:1,axis:"x",itemWidth:140,maximumVisibleItems:7,el:i[0],collection:r,mediumGrid:!0,showArtist:!0,addStreamType:"TYPE_RECOMMENDED"}),this.options.positionOnPage=e,t.childViews.push(this.grid),this.grid.render()}})),this.getMoreSectionsDfd.resolve()},this);e.get("isLoggedIn")?e.getFavoritesByType("Users").done(_.bind(function(n){n.length&&e.loadCommunityFeed().always(t)},this)).fail(_.bind(function(){this.getMoreSectionsDfd.reject()},this)):this.getMoreSectionsDfd.reject()}else{if(this.getMoreSectionsPos!=2)return;if(!this.moreGenreTags)return;var r=_.bind(function(t){if(t&&t.length>1){var r=e.getRawLocalRecentListens(),i=r.length?"TAGLINE_MORE_GENRES":"TAGLINE_MORE_GENRES_GENERIC";this.sections.push(new f({titleKey:"MORE_GENRES",weight:-1,taglineKey:i,section:"otherTags",canPlay:!1,pageable:!0,user:e,render:function(e,r){var i=new n.Models.Collections.Tags(t),s=this.$el.find(".home-content");this.$el.find(".home-grid-container").addClass("home-grid-short"),s.empty(),this.grid=new n.Views.TagGridBlock({itemsPerRow:1,axis:"x",itemWidth:140,maximumVisibleItems:7,el:s[0],collection:i,mediumGrid:!0,showArtist:!0}),this.options.positionOnPage=e,r.childViews.push(this.grid),this.grid.render()}}))}this.getMoreSectionsDfd.resolve()},this);n.Models.Tag.getMetaMulti(this.moreGenreTags).done(r)}return this.getMoreSectionsDfd},setWelcomeMessage:function(){var e=n.Models.AuthUser.getCached(n.getLoggedInUserID()),t=e.get("FName");e.get("isLoggedIn")&&$(".welcome-message").text(_.getString("WELCOME_BACK",{user:t}))},attemptRenderSections:function(t,n){var r=this.renderedSections.length==1&&_.indexOf(this.renderedSections,this.fakeListenAgain)!=-1;if(this.renderedSections.length>0&&!r&&this.sections.length<3&&this.timeoutExpired===!1)return!1;if(!this.sectionTemplate||this.destroyed||this.sections.length===0){if(!this.destroyed&&this.sections.length===0){var i=this.getMoreSections();i&&i.always(_.bind(this.attemptRenderSections,this))}return!1}return!t&&this.renderedSections.length<2?(o.call(this),!1):(this.renderSection(),(_.isUndefined(t)||t)&&!n&&this.attemptRenderSections(e[0].scrollHeight<=e[0].clientHeight),!0)},renderSection:function(){if(!this.sections.length||this.destroyed)return!1;var e=this.model.get("appModel").get("user"),t=this.$el.find("#column1"),r=this.sections,i,s,o;i=_.sortBy(r,function(e){return e.options&&e.options.alwaysFirst?-1e5:Math.random()*(e.options&&e.options.weight)*-1}),s=i[0],s.template=this.sectionTemplate,o=s.options&&s.options.alwaysFirst;if((o||this.missingPersonalizedSongs)&&this.fakeListenAgain&&s!=this.fakeListenAgain){var u=_.indexOf(this.sections,this.fakeListenAgain);u!=-1?this.sections.splice(u,1):(u=_.indexOf(this.renderedSections,this.fakeListenAgain),u!=-1&&this.renderedSections.splice(u,1)),this.fakeListenAgain.destroy(),delete this.fakeListenAgain,o=!0}return t[o?"prepend":"append"](s.el),s.render(this.renderedSections.length,this),r.splice(_.indexOf(r,s),1),this.renderedSections.push(s),this.childViews.push(s),this.pageReady(),n.trigger("page:resize"),n.trigger("ad:handleHomeCapital"),!0},updatePageParams:function(e){var t=this.options.params;this.options.params=e,t.notFound!==e.notFound&&(this.cleanupChildViews(),this.render())},updateUserStats:function(e,n){n=n||{};var r=e.changed,i=e.attributes,s,o;if(r.library||r.librarySongsCount||n.force)s=e.getLibraryCount(),s!==t&&($("#user-songs").text(_.addCommaSeparators(s)),$("#user-songs").siblings(".label").text(_.getString(s===1?"SONG":"SONGS")));if(r.favoriteSongs||r.favoriteSongsSongIDs||n.force)s=e.getFavoriteSongsCount(),s!==t&&($("#user-favorites").text(_.addCommaSeparators(s)),$("#user-favorites").siblings(".label").text(_.getString(s===1?"FAVORITE":"FAVORITES")));if(r.playlists||n.force&&i.playlists)$("#user-playlists").text(_.addCommaSeparators(i.playlists.length)),$("#user-playlists").siblings(".label").text(_.getString(i.playlists.length===1?"PLAYLIST":"PLAYLISTS"));(r.favoriteUsers||n.force&&i.favoriteUsers)&&$("#user-following").text(_.addCommaSeparators(i.favoriteUsers.length));if(r.followers||n.force&&i.followers)$("#user-followers").text(_.addCommaSeparators(i.followers.length)),$("#user-followers").siblings(".label").text(_.getString(i.followers.length===1?"FOLLOWER":"FOLLOWERS"));if(r.estimatedBroadcastListens||n.force&&i.estimatedBroadcastListens)o=_.toInt(i.estimatedBroadcastListens),$("#broadcast-listen-count").text(_.addCommaSeparators(o)),$("#broadcast-listen-count").siblings(".label").text(_.getString(o===1?"BROADCAST_PLAY":"BROADCAST_PLAYS")),o<1e3?$("#broadcast-listen-count").parent().addClass("hide").prev().addClass("last"):$("#broadcast-listen-count").parent().removeClass("hide").prev().removeClass("last")},onSectionTemplate:function(e){this.sectionTemplate=e;var t=this.model.get("appModel").get("user");this.fakeListenAgain=new f({titleKey:"LISTEN_AGAIN",weight:1e3,taglineKey:"TAGLINE_LISTEN_AGAIN",section:"music",canPlay:!0,pageable:!0,alwaysFirst:!0,user:t,render:function(e,t){this.options.positionOnPage=e}}),this.sections.push(this.fakeListenAgain)},onTemplate:function(e){if(this.destroyed)return;this.$el.html(this.renderTemplate(e)),this.rendered=!0,setTimeout(_.bind(this.setWelcomeMessage,this),100),this.focusSearch()},onPersonalizedSongs:function(e){var r=this.model.get("appModel").get("user");if(!e||!e.length)this.missingPersonalizedSongs=!0;var i=r.getLocalRecentListens(t,t,!0);i.length&&(e=new n.Models.Collections.Songs(_.intersection(e.models,i.models))),e&&e.length&&e.length>=4?(this.personalizedSongs=e,this.sections.push(new f({titleKey:"LISTEN_AGAIN",weight:1e3,taglineKey:"TAGLINE_LISTEN_AGAIN",section:"music",canPlay:!0,pageable:!0,alwaysFirst:!0,user:r,gutsType:"userRecent",gutsID:r.get("UserID"),getClientRadioSongs:function(){var t=$.Deferred();return t.resolve(e),t},render:function(e,t){var r=new n.Models.Collections.Songs(t.personalizedSongs.models),i=this.$el.find(".home-content"),s=new n.Models.PlayContext;s.addStreamType(n.Models.PlayContext.TYPE_RECOMMENDED),r=n.Models.Queue.sortSongsForRadio(r,{shuffle:!1}),i.empty(),this.grid=new n.Views.SongGridBlock({itemsPerRow:1,axis:"x",itemWidth:140,maximumVisibleItems:7,el:i[0],collection:r,playContext:s,mediumGrid:!0}),this.options.positionOnPage=e,t.childViews.push(this.grid),this.grid.render()}}))):this.missingPersonalizedSongs=!0},onPopularSongs:function(e){if(!e||!e.Songs||!e.Songs.length)return;var t=new n.Models.Collections.Songs(e.Songs),r=this.model.get("appModel").get("user");this.sections.push(new f({titleKey:"POPULAR_SONGS",weight:r.get("UserID")?30:80,taglineKey:"TAGLINE_POPULAR",section:"popular",canPlay:!0,pageable:!0,user:r,gutsType:"popular",gutsID:0,getClientRadioSongs:function(){var e=$.Deferred();return n.Services.API.popularGetSongs().done(_.bind(function(t){var r=n.Models.Collections.Songs(t&&t.Songs||[]);e.resolve(r)},this)),e},render:function(e,r){var i=this.$el.find(".home-content"),s=new n.Models.PlayContext({contextType:"popular"});i.empty(),this.grid=new n.Views.SongGridBlock({itemsPerRow:1,axis:"x",itemWidth:140,maximumVisibleItems:7,el:i[0],collection:t,playContext:s,mediumGrid:!0}),this.options.positionOnPage=e,r.childViews.push(this.grid),this.grid.render()}}))},onRecommendedSongs:function(e){if(!e||!e.length||e.length<7)return;e=new n.Models.Collections.Songs(e);var t=this.model.get("appModel").get("user");this.sections.push(new f({titleKey:"RECOMMENDED_SONGS",weight:300,taglineKey:"TAGLINE_RECOMMENDED",section:"recommended",canPlay:!0,pageable:!0,user:t,gutsType:"userRecommended",gutsID:t.get("UserID"),getClientRadioSongs:function(){var e=$.Deferred();return e.resolve([]),e},render:function(t,r){var i=this.$el.find(".home-content"),s=new n.Models.PlayContext;s.addStreamType(n.Models.PlayContext.TYPE_RECOMMENDED),i.empty(),this.grid=new n.Views.SongGridBlock({itemsPerRow:1,axis:"x",itemWidth:140,maximumVisibleItems:7,el:i[0],collection:e,playContext:s,mediumGrid:!0}),this.options.positionOnPage=t,r.childViews.push(this.grid),this.grid.render()}}))},onTopBroadcastsForTags:function(e){if(this.destroyed||!e||_.isEmpty(e))return;var r=this,i=[],o=[],u=[],a=[],l=[],c=this.model.get("personalizedTags");_.each(e,function(e,t){e&&e.length&&(i.push.apply(i,e),t!="bcast"&&e[0].Tag&&e[0].Tag.i&&u.push(new n.Models.Tag({TagID:e[0].Tag.i,Tag:e[0].Tag.n})))}),i=new n.Models.Collections.Broadcasts(i),i.filterBestBroadcasts();if(i.length>0){i.each(function(e){var t=e.get("Tag");t&&c[t.i]&&e.get("listenersCount")>14&&l.push(e)}),a=_.shuffle(l),a.length<6&&(a=_.shuffle(a.concat(i.first(6-a.length)))),a=_.first(a,3);var h=new n.Models.Collections.Broadcasts(a);i.remove(a),this.topBroadcasts=h,this.subscribedBroadcasts.add(a);var p=null,d=!1,v=function(){if(Date.now()-s.lastActive>6e4){d=!0;return}p=setTimeout(m,12e3)},m=function(){if(r.destroyed)return;var e=n.Models.Broadcast.fetchRealtimeBroadcasts(r.subscribedBroadcasts.pluck("BroadcastID"),["py","n","t","s","owner_subscribed","tl"]);e.always(v)},g=function(){d&&(m(),d=!1)};n.on("userActivity",g,this),v(),this.subscribedBroadcasts.on("change",_.bind(function(e,n){var r=e.get("activeStatus"),s=e.get("isPlaying");if(!this.topBroadcasts.contains(e))return;var u=!1,a=e.get("listenersCount"),f=e.get("tallies");if(f&&f.sub_tallies&&e.get("homepageArchive")!==this.cid){var l=f.sub_tallies;l.unsub_tally&&l.sub_tally/l.unsub_tally<=.6&&l.unsub_tally>a*.1&&(u=!0)}if(u||r!==t&&r===0||s!==t&&s===!1){this.subscribedBroadcasts.remove(e),this.topBroadcasts.remove(e),e.set("homepageArchive",this.cid),o.push(e);var c=i.first(1);c||(c=o.shift()),c&&(i.remove(c),this.subscribedBroadcasts.add(c),this.topBroadcasts.add(c))}},this))}var y={genres:[]},b="TAGLINE_TOP_BROADCASTS",w=i.length;console.log(r.topBroadcasts),this.sections.push(new f({titleKey:"LIVE_BROADCASTS",weight:4e3,taglineKey:b,taglineOptions:y,section:"topBroadcasts",canPlay:!1,pageable:!1,addClass:w?"broadcasts":"broadcasts-see-all",render:function(e,t){var i=this.$el.find(".home-content");i.empty(),w?(this.grid=new n.Views.BroadcastGrid({itemsPerRow:1,axis:"x",itemWidth:330,maximumVisibleItems:3,el:i[0],collection:r.topBroadcasts,joinViaUserPage:!0}),t.childViews.push(this.grid),this.grid.render()):(i.empty(),this.fetchTemplate("home/broadcastsSection").done(_.bind(function(e){this.$el.html(this.renderTemplate(e,this)),this.rendered=!0},this))),this.options.positionOnPage=e}}))},onFeaturedContent:function(e){if(!e||!e.Contents)return;var t=e.Contents,r=this.model.get("appModel").get("user"),i=0,s=t.length,o,u,a;for(;i<s;i++){o=t[i].items,!u&&o&&o.length&&o[0]&&o[0].VideoID&&(u=new n.Models.Collections.Videos(o)),!a&&o&&o.length&&o[0]&&t[i].name=="New Releases"&&(a=new n.Models.Collections.Albums(o));if(u&&a)break}u&&this.sections.push(new f({titleKey:"FEATURED_VIDEOS",weight:40,taglineKey:"TAGLINE_FEATURED_VIDEOS",section:"featured-videos",canPlay:!1,pageable:!0,user:r,render:function(e,t){var r=this.$el.find(".home-content");r.empty(),this.grid=new n.Views.VideoGrid({itemsPerRow:1,axis:"x",itemWidth:140,maximumVisibleItems:7,el:r[0],collection:u,mediumGrid:!0}),this.options.positionOnPage=e,t.childViews.push(this.grid),this.grid.render()}})),a&&this.sections.push(new f({titleKey:"NEW_RELEASES",weight:40,taglineKey:"TAGLINE_NEW_RELEASES",section:"new-releases",canPlay:!1,pageable:!0,user:r,render:function(e,t){var r=this.$el.find(".home-content");r.empty(),this.grid=new n.Views.AlbumGrid({itemsPerRow:1,axis:"x",itemWidth:140,maximumVisibleItems:7,el:r[0],collection:a,mediumGrid:!0,showArtist:!0,addStreamType:"TYPE_RECOMMENDED"}),this.options.positionOnPage=e,t.childViews.push(this.grid),this.grid.render()}}))},onRecentListens:function(e,t){var r=this.model.get("appModel").get("user"),i=this.defaultTags,o=i.slice(0),u=15,l=5,c,h,p;h=t.length;while(h<u&&o.length)t.push([o.shift(),[]]),h++;var d=_.first(t,20),v=[],m=[];for(c=0,h=d.length;c<h;c++)p=d[c][0],c<l&&(v[p]=d[c]),m.push(p);this.moreGenreTags=m.splice(5,m.length);var g=_.bind(function(e,t){if(e&&e.get("Songs")&&e.get("Songs").length){var r=this.model.get("appModel").get("user"),i=v[e.id]&&v[e.id][1].length,o=0,u={artists:[]},l="",c={3773:"TAGLINE_TAG_INDIE",156:"TAGLINE_TAG_ELECTRONIC",2856:"TAGLINE_TAG_ROCK",1748:"TAGLINE_TAG_RAP"},h={},p,d,m;typeof c[e.id]!="undefined"&&(l=c[e.id]);for(var g=0,y=i||0;g<y;g++){d=v[e.id][1][g],p=d.get("ArtistName");if(h[p])continue;m=['<a href="',d.toArtistUrl(),'" class="tagline-link">',d.escape("ArtistName"),"</a>"].join(""),g===0?u.artist=m:u.artists.push(m),o++,h[p]=1}o==1?l="TAGLINE_BASED_ON_ARTIST":o&&(l="TAGLINE_BASED_ON_ARTISTS",u.artists=_.first(u.artists,4).join(", "),o>2&&(u.artists+=", "));var b={title:e.get("DisplayName"),weight:30+Math.max(i*50,600),taglineKey:l,taglineOptions:u,section:"tag",addClass:"tag"+e.id,tag:{tagID:e.id,tagName:e.get("DisplayName")},canPlay:!0,pageable:!0,user:r,gutsType:"tag",gutsID:e.id,getClientRadioSongs:function(){function u(e){if(!e){t.reject();return}e=n.Models.Queue.shuffleSongsForRadio(e);var i=s.model.get("player"),o=i.get("currentQueue"),u=o.get("clientRadio");e=a(e.models,o.get("songs").models),u.setTypeTypeID("tag",r),u.disable().reset(e).enable(),u.onActiveSongChange(o,o.get("activeSong")),u.on("needSongs",function(e,t){e.switchToAutoplay({secondaryArtistWeightModifier:.7,seedArtistWeightRange:[80,100],weightModifierRange:[-14,9]}),n.trigger("guts:startAutoplayFallbackContext","autoplay",0)}),n.trigger("guts:startNewAutoplayContext","tag",r,"song",o.get("songs").pluck("SongID").toString()),t.reject()}var t=$.Deferred(),r=e.get("TagID"),i=e.get("sampleSongs"),o=e.get("Songs");return o?(i?n.Models.Tag.get(r).done(function(e){e.getSongs().done(u).fail(_.bind(t.reject,t))}):u(o),t):(t.reject(),t)},render:function(t,r){var i=e.get("Songs");if(!i||!i.length)return;i=i.toArray();if(i.length>3){var s=[],o=Math.ceil(i.length/3),u=0,a=i.length;for(;u<a;u+=o)s=s.concat(_.shuffle(i.slice(u,u+o)));i=s}var f=new n.Models.Collections.Songs(_.first(i,50)),l=this.$el.find(".home-content"),c=new n.Models.PlayContext;c.addStreamType(n.Models.PlayContext.TYPE_RECOMMENDED),l.empty(),f=n.Models.Queue.sortSongsForRadio(f,{shuffle:!1}),this.grid=new n.Views.SongGridBlock({itemsPerRow:1,axis:"x",itemWidth:140,maximumVisibleItems:7,el:l[0],collection:f,playContext:c,mediumGrid:!0}),this.options.positionOnPage=t,r.childViews.push(this.grid),this.grid.render()}};this.sections.push(new f(b))}},this),y=$.Deferred(),b=$.Deferred();b.done(e.bind(function(e){for(var t=0,n=e.length;t<n;t++)g(e[t],t)})),y.fail(_.bind(function(){n.Models.Tag.getTagsSampleSongs(m).done(_.bind(function(e){b.resolve(e)}))},this));if(_.intersection(m,_.first(i,l)).length==l){m=_.first(i,4),this.moreGenreTags=i.slice(4);var w=setTimeout(function(){y.reject()},2500),E=function(e){clearTimeout(w);if(!e.defaultTagSampleSongsSet){y.reject();return}var t=n.Models.Tag.convertPageNamesToTags(e.defaultTagSampleSongsSet,!0);b.resolve(t),delete e.defaultTagSampleSongsSet};typeof preloadedData!="undefined"?E(preloadedData):n.on("preloadedData",E)}else y.reject();return b},onListenAgainOptions:function(e){var t=$(e.currentTarget),r=[];r.push({key:"EDIT_COLLECTION",title:_.getString("EDIT_COLLECTION"),customClass:"jj_menu_item_gear",action:{type:"fn",callback:function(){var e=s.model.get("user");n.router.setHash(e.toUrl("collection"))}}},{key:"EDIT_LISTENS",title:_.getString("EDIT_LISTENS"),customClass:"jj_menu_item_gear",action:{type:"fn",callback:function(){var e=s.model.get("user");n.router.setHash(e.toUrl("listens"))}}}),t.jjmenu(e,r,null,{xposition:"left",yposition:"auto",show:"default",className:"contextmenu",keepState:t}),t.addClass("active-context")},focusSearch:function(){if(!n.Views.Lightbox.isOpen){var e=$("#header-search .search");e.data("isFakeFocusing",!0),e.focus()}}})}),define("/gs/views/pages/profile.js",function(){n.Views=n.Views||{},n.Views.Pages=n.Views.Pages||{};var e;n.Views.Pages.Profile=n.Views.Pages.ItemPage.extend({pageType:"profile",events:{},initialize:function(t){e=this.model.get("gsApp"),n.Views.Pages.ItemPage.prototype.initialize.call(this,t),this.rendered=!1,this.renderCalled=!1,this.childViews=[];var r=_.toInt(this.options.params.id),i=_.toInt(this.options.params.artistID);if(!i&&r<1){n.router.setHash("notFound");return}i?n.Models.Profile.get(r,i,!0,!0,{notifyCache:!0}).done(_.bind(this.onProfileLoad,this)).fail(_.bind(this.onProfileFail,this)):n.Models.Profile.get(r,null,!0,!0,{notifyCache:!0}).done(_.bind(this.onProfileLoad,this)).fail(_.bind(this.onProfileFail,this))},wasFirstPage:function(){},getOverridePageView:function(){return this.profileView||this},updatePageParams:function(e){var t={};this.lastUniqueObj=t;if(this.profileView){if(this.profileType=="artist"){var r=this.options.params.section=="dashboard",i=_.extend(this.options,{el:this.el,fromProfileView:!0}),s;e.id=this.artist.id,i.params=e,this.options.params=e;if(e.section=="dashboard"){if(!r){amdModules.requireDeferred("artistDashboardPage").done(_.bind(function(){if(this.lastUniqueObj!=t)return;this.profileView.destroy(!1),s=new n.Views.Pages.Artistdashboard(i),this.renderProfileView(s)},this));return}}else if(r){amdModules.requireDeferred("/gs/views/pages/artist.js").done(_.bind(function(){if(this.lastUniqueObj!=t)return;this.profileView.destroy(!1),s=new n.Views.Pages.Artist(i),this.renderProfileView(s)},this));return}}this.profileView.updatePageParams(e),this.options.params=e}},onProfileLoad:function(t){this.user=t.get("user");var r=t.get("artist");r?(this.artist=r,this.profileType="artist"):this.profileType="user",this.renderCalled&&this.render();var i=_.extend(this.options.params,{artistID:r&&r.id});n.trigger("change:page:type",this.profileType,i,e.page)},onProfileFail:function(){n.router.setHash("notFound")},onDestroy:function(){this.profileView&&this.profileView.destroy(!1)},render:function(){this.renderCalled=!0;if(this.rendered)return;this.profileView&&this.profileView.destroy(!1);var e=_.extend(this.options,{el:this.el,fromProfileView:!0});if(this.profileType=="artist"&&this.artist){var t=e.params;t.id=this.artist.id,t.section=="dashboard"?amdModules.requireDeferred("artistDashboardPage").done(_.bind(function(){var t=new n.Views.Pages.Artistdashboard(e);this.renderProfileView(t)},this)):amdModules.requireDeferred("/gs/views/pages/artist.js").done(_.bind(function(){var t=new n.Views.Pages.Artist(e);this.renderProfileView(t)},this))}else this.profileType=="user"&&amdModules.requireDeferred("/gs/views/pages/user.js").done(_.bind(function(){var t=new n.Views.Pages.User(e);this.renderProfileView(t)},this))},renderProfileView:function(e){this.rendered=!0,this.profileView=e,e.render()},renderCollection:function(e){var t=this.model.get("user"),r=t.get("library"),i,s,o,u;if(this.destroyed||this.collectionRendered||!t||!e||this.model.get("section")!="collection"&&this.model.get("subpage")!="favorites")return;if(!e.length){this.getEmptySuggestions();return}r.on("add",_.bind(function(e){this.libraryClone.add(e),e.set("removedFrom",!1)},this)),r.on("remove",_.bind(function(e){e.set("removedFrom",!0)},this));var a=new n.Models.PlayContext(t);t.id==n.getLoggedInUserID()?a.addStreamType(n.Models.PlayContext.TYPE_LIBRARY):a.addStreamType(n.Models.PlayContext.TYPE_DEFAULT),i=$("#profile-grid"),i.length&&(i.empty(),this.libraryClone=new n.Models.Collections.Songs(r.models),this.libraryClone.comparator=_.getModelSort("TSAdded"),this.libraryClone.sort(),s=new n.Views.SongGrid({el:i[0],collection:this.libraryClone,playContext:a}),this.childViews.push(s),s.render()),u=$(".grid-toolbar");if(s&&u.length){this.gridToolbarView=new n.Views.GridToolbar({el:u[0],model:this.model,gridView:s,page:this.model.get("subpage")!="favorites"?"userMusic":"userMusicFavorites",buttons:["play","add","sort","btnGroupNav","filterSearch"],btnGroupNavInfo:{pages:["userMusic","userMusicFavorites"],labels:["ALL_MUSIC","FAVORITES"],classNames:["all-music","favorites"]},onButtonClick:function(e){var r=$(e.currentTarget);r.hasClass("favorites")?n.router.setHash(t.toUrl("collection/favorites")):r.hasClass("all-music")&&n.router.setHash(t.toUrl("collection"))},playContext:a});if(t.id!==n.getLoggedInUserID()){var f=t.get("favoriteSongs");if(!f||!f.length)f=[];f instanceof Backbone.Collection&&(f=f.models),this.gridToolbarView.options.favFilterFunction=function(e){return _.indexOf(f,e)!==-1}}this.childViews.push(this.gridToolbarView),this.gridToolbarView.render(),this.subpage=="favorites"&&this.gridToolbarView.resetCollection(!0)}this.collectionRendered=!0},renderPlaylists:function(e){var t=this.model.get("section"),r=this.model.get("user"),i=this.model.get("appModel").get("user"),s,o;if(this.destroyed||!this.model.get("user")||this.playlistsRendered||t!="playlists")return;e=new n.Models.Collections.Playlists(e.models),e.comparator=n.Models.Playlist.modifiedSort,e.sort();var u=i.get("subscription").canHideAds()?3:2;s=$("#profile-grid"),s.length&&(s.empty(),this.playlistsGridView=new n.Views.PlaylistGridSmall({el:s[0],collection:e,itemsPerRow:u,header:!1}),this.childViews.push(this.playlistsGridView),this.playlistsGridView.render()),o=$(".grid-toolbar"),o.length&&(this.gridToolbarView=new n.Views.GridToolbar({el:o[0],model:this.model,gridView:this.playlistsGridView,page:this.model.get("subpage")=="subscribed"?"subscribedPlaylists":"playlists",buttons:this.model.get("user").id==n.getLoggedInUserID()?["newPlaylist","btnGroupNav","filterSearch","sort"]:["btnGroupNav","filterSearch"],btnGroupNavInfo:{pages:["playlists","subscribedPlaylists"],labels:["MY_PLAYLISTS","SUBSCRIBED"],classNames:["my-playlists","subscribed"]},onButtonClick:function(e){var t=$(e.currentTarget);return t.hasClass("my-playlists")?n.router.setHash(r.toUrl("playlists")):t.hasClass("subscribed")&&n.router.setHash(r.toUrl("playlists/subscribed")),!1}}),this.childViews.push(this.gridToolbarView),this.gridToolbarView.render()),(!e||!e.length)&&this.renderEmptyPlaylists(),this.playlistsRendered=!0},renderFollowing:function(e){if(this.destroyed||!this.model.get("user")||!this.indexRendered||this.model.get("section")!=="following")return;var t=this.model.get("section"),r=this.model.get("user"),i=this.model.get("appModel").get("user"),s=$("#profile-grid"),o=i.get("subscription").canHideAds()?3:2;e.comparator=_.getModelSort("searchText",!0),e.sort(),s.length&&(s.empty(),this.followingGridView=new n.Views.UserArtistGrid({el:s[0],collection:e,itemsPerRow:o}),this.childViews.push(this.followingGridView),this.followingGridView.render());var u=$(".grid-toolbar");if(u.length){var a=this.model.get("subpage");this.gridToolbarView=new n.Views.GridToolbar({el:u[0],model:this.model,gridView:this.followingGridView,page:"following",buttons:this.model.get("user").id==n.getLoggedInUserID()?["inviteFriends","filterSearch"]:["filterSearch"]}),this.childViews.push(this.gridToolbarView),this.gridToolbarView.render()}(!e||!e.length)&&this.fetchTemplate("/user/empty/following").done(_.bind(this.renderGenericEmpty,this,{user:r,subpage:this.model.get("subpage")}))},getEmptySuggestions:function(e,t){e=_.orEqual(e,"/user/empty/collection"),t=_.orEqual(t,$("#column1"));var r=this.model.get("user");n.getLoggedInUserID()==r.get("UserID")?r.getPersonalizedSongs(!0).done(_.bind(function(n){if(!n.length){this.getPopularSuggestions(e,t);return}this.fetchTemplate(e).done(_.bind(this.renderEmptySuggestions,this,n,t))},this)):this.fetchTemplate(e).done(_.bind(this.renderEmptySuggestions,this,[],t))},getPopularSuggestions:function(e,t){n.Services.API.popularGetSongsPreview().done(_.bind(function(r){var i=new n.Models.Collections.Songs(r.Songs.slice(0,5));this.fetchTemplate(e).done(_.bind(this.renderEmptySuggestions,this,i,t))},this))},renderEmptySuggestions:function(e,t,r){t.html(this.renderTemplate(r,{user:this.model.get("user")}));if(!e||!e.length)return;var i=5;this.model.get("section")!=="collection"&&(i=4);var s=new n.Views.SongGridBlock({itemsPerRow:1,axis:"x",itemWidth:140,maximumVisibleItems:i,el:t.find(".empty-suggestions"),collection:new n.Models.Collections.Songs(e.first(i)),mediumGrid:!0});this.childViews.push(s),s.render()},renderEmptyPlaylists:function(){var e=this.model.get("user");subpage=this.model.get("subpage"),this.fetchTemplate("/user/empty/playlists").done(_.bind(this.renderGenericEmpty,this,{user:e,subpage:subpage}))},renderGenericEmpty:function(e,t){$("#column1").append(this.renderTemplate(t,e))},renderNotifications:function(){if(this.destroyed||!this.model.get("user")||!this.indexRendered||this.model.get("section")!=="notifications")return;$("#comments").hide();var e=this.model.get("user").get("notifications");if(!e)return;e=e.getNormalized(this.model.get("user"));var t=_.getTimeBasedGroups();for(var n=0,r=e.length;n<r;n++){while(e[n].timestamp<t[0].time)t.shift();e[n].group=t[0].localeKey}var i=$("#profile-grid");i.length&&(i.empty(),this.fetchTemplate("/shared/notifications").always(_.bind(function(t){i.html(this.renderTemplate(t,{notifications:e}))},this)))},renderListens:function(){if(this.destroyed||!this.model.get("user")||!this.indexRendered||this.model.get("section")!=="listens")return;var t=this.model.get("user").get("listens");if(!t)return;var r=_.getTimeBasedGroups(),i=[],s={},o={},u=0,a=t.length,f=!0,l=null;for(;u<a&&r.length;u++){while(t[u].listenTime<r[0].time)r.shift(),f=!0;f?(i.push(r[0]),l=r[0],s[l.gridClass]=[t[u]],o[l.gridClass]=[]):s[l.gridClass].push(t[u]),o[l.gridClass][t[u].SongID]?o[l.gridClass][t[u].SongID].push(t[u].listenDataKey):o[l.gridClass][t[u].SongID]=[t[u].listenDataKey],f=!1}var c=$("#profile-grid"),h=[],p=this.model.get("user"),d=e.model.get("user");c.length&&(c.empty(),this.fetchTemplate("listens").done(_.bind(function(e){c.html(this.renderTemplate(e,{groups:i,listens:t})),t.length||this.getEmptySuggestions("empty/listens",this.$("#user-page-listens")),_.each(s,_.bind(function(e,r){e=new n.Models.Collections.Songs(e);var i=function(e){if(d&&p.get("UserID")==d.get("UserID")){var i=[],s={},u,f;e.each(function(e){i=i.concat(o[r][e.get("SongID")])}),n.Services.API.deleteUserListens(i),a.collection.remove(e.models);for(u=0,f=i.length;u<f;u++)s[i[u]]=1;for(u=0;u<t.length;u++)s[t[u].listenDataKey]&&t.splice(u--,1);n.trigger("guts:log","removeSongsFromListens",{removedSongs:e.pluck("SongID").toString()}),n.trigger("guts:gatrack","user","removeSongsFromListens",e.pluck("SongID"))}},s=new n.Models.PlayContext;s.addDefaultType();var u=this.$el.find("."+r),a=new n.Views.SongGrid({el:u[0],collection:e,header:!1,canDelete:p.get("UserID")==d.get("UserID"),onDelete:i,columns:n.Views.SongGrid.columnsNoTrack,excludeCells:["track-num"],playContext:s});if(p.get("UserID")==d.get("UserID")){var f=function(e){e=e.models?e:new n.Models.Collections.Songs(e),i(e)};a.contextMenuExtra={deleteListens:f}}var l=[],c=_.debounce(function(){i(new n.Models.Collections.Songs(l)),l=[]},1e3);a.$el.on("click",".song-row-delete",function(e){var t=$(e.currentTarget),r=t.data();if(r&&r.songId){var i=n.Models.Song.getCached(r.songId);l.push(i),a.collection.remove(i),c()}}),a.options.columns[4].minimumSize=113,this.childViews.push(a),h.push(a),a.render()},this))},this)));var v=$(".grid-toolbar");if(h.length&&v.length){var m=["filterSearch"];p.get("UserID")==d.get("UserID")&&(m=["filterSearch","extraOptions"]);var g=new n.Views.GridToolbar({el:v[0],gridView:h[0],page:"userListens",buttons:m});g.on("filterChanged",function(e){_.each(h,function(t){t instanceof n.Views.Grid&&(t.filter(e),t.$el.parent()[(t.visibleCollection.length?"remove":"add")+"Class"]("hide"))})}),this.childViews.push(g),g.render()}},handlePlaylistSubpageChange:function(e){if(!e||!this.playlistsGridView)return!1;var t=this.model.get("user"),r=this.model.get("subpage"),i=_.bind(function(e){if(this.destroyed||!this.model.get("user")||!e)return!1;e=new n.Models.Collections.Playlists(e.models),e.comparator=n.Models.Playlist.modifiedSort,e.sort(),this.playlistsGridView.collection.reset(e.models),this.$(".empty-page").remove(),(!e||!e.length)&&this.renderEmptyPlaylists()},this),s=_.bind(function(){if(this.destroyed)return!1;r=="subscribed"?($(".grid-toolbar .btn.my-playlists").removeClass("active"),$(".grid-toolbar .btn.subscribed").addClass("active")):($(".grid-toolbar .btn.my-playlists").addClass("active"),$(".grid-toolbar .btn.subscribed").removeClass("active"))},this);r=="subscribed"?t.getFavoritesByType("Playlists").done(i).done(s):t.getPlaylists().done(i).done(s)},showCurrentBroadcast:function(){if(this.destroyed||!this.indexRendered)return;var t=this.$el.find(".current-user-broadcast"),r=this.model.get("user"),i=n.getLoggedInUserID()==r.id,s=r.get("currentBroadcastID");if(s){var o=n.Models.Broadcast.getCached(s);if(o&&!this.destroyed){var u=e.model.get("player").get("currentQueue"),a=u?u.get("currentBroadcast"):null,f=new n.Views.Modules.BroadcastRowLarge({el:this.$("#current-broadcast")[0],model:o});this.childViews.push(f),f.render(),t.removeClass("hide")}else n.Models.Broadcast.fetchRealtimeBroadcast(s,!1,!0).done(_.bind(this.onBroadcastInfo,this))}else t.addClass("hide");n.trigger("page:redrawUpdate")},renderBroadcasts:function(e){if(this.destroyed||!this.model.get("user")||!this.indexRendered||this.model.get("section")!=="broadcasts")return;var t=$("#profile-grid");if(e.length){var r=this.model.get("user"),e=r.get("broadcasts"),i=e.first(),s={},o,u,a,f;i.get("activeStatus")>0?e.remove(i):i.on("change:activeStatus",this.onFirstBroadcastStatusChange,this),e.each(function(e){u=e.escape("Name"),f=e.get("Tag")?e.get("Tag"):{i:-1,n:_.getString("BROADCAST_DEFAULT_TAG")},a=u+f.n,s[a]||(s[a]=new Backbone.Model({Name:u,Tag:f,BroadcastImage:e.getImageURL(80),Broadcasts:new n.Models.Collections.Broadcasts([]),visibleBroadcasts:new n.Models.Collections.Broadcasts([])})),s[a].get("Broadcasts").add(e,{silent:!0}),s[a].get("Broadcasts").length<5&&s[a].get("visibleBroadcasts").add(e,{silent:!0})}),this.bcGroupCollection=new Backbone.Collection(_.toArray(s)),this.bcGroupCollection.comparator=function(e){return e.attributes.Broadcasts.first().attributes.TSCreated*-1},o=new n.Views.BroadcastGroupGrid({el:t[0],collection:this.bcGroupCollection,header:!1}),this.showCurrentBroadcast(),this.childViews.push(o),t.empty(),o.render(),n.trigger("page:redrawUpdate")}else t.addClass("hide"),this.fetchTemplate("/user/empty/broadcasts").done(_.bind(this.renderGenericEmpty,this,{user:r,subpage:this.model.get("subpage")}))},onFirstBroadcastStatusChange:function(e){var t=this.bcGroupCollection.first(),n=t.get("Broadcasts"),r=n.first();r.get("activeStatus")===1&&(n.length===1?this.bcGroupCollection.remove(t):t.get("Broadcasts").remove(r))}},{})}),define("/gs/views/pages/static.js",function(){n.Views=n.Views||{},n.Views.Pages=n.Views.Pages||{};var e="",t="",r;n.Views.Pages.Static=n.Views.Pages.Base.extend({templatePath:"static",pageType:"static",events:{"mouseenter .menu-dropdown":"showMenuDropdown","mouseleave .menu-dropdown":"hideMenuDropdown","submit #advertising-contact":"submitAdvertising"},initialize:function(){r=this.model.get("gsApp"),this.rendered=!1,this.menuTimer={},$(document.body).on("mouseenter.about-dropdown",".menu-dropdown",_.bind(this.stayShowingMenuDropdown,this,this.menuTimer)),$(document.body).on("mouseleave.about-dropdown",".menu-dropdown",_.bind(this.hideMenuDropdown,this,this.menuTimer)),this.model.set({subpage:_.orEqual(this.options.params.subpage,t),section:_.orEqual(this.options.params.section,e)})},onDestroy:function(){$(document.body).off(".about-dropdown")},render:function(){this.options.params.notFound?this.fetchTemplate("not_found").always(_.bind(this.onTemplate,this)):this.options.params.section&&this.options.params.subpage?this.fetchTemplate(this.options.params.section+"/"+this.options.params.subpage).done(_.bind(this.onTemplate,this)).fail(_.bind(function(){this.model.get("subpage")&&n.router.setHash("/"+this.model.get("section"))},this)):this.options.params.section&&this.fetchTemplate(this.options.params.section).always(_.bind(this.onTemplate,this)),this.setTitle(_.ucwords((this.options.params.section||"").toLowerCase().replace("_"," "))),this.rendered=!0},updatePageParams:function(n){var r=this.options.params;this.options.params=n;var i=_.orEqual(n.subpage,t),s=_.orEqual(n.section,e);r.notFound!==n.notFound&&this.render();if(i!=r.subpage||s!=r.section)this.model.set({subpage:_.orEqual(n.subpage,t),section:_.orEqual(n.section,e)}),this.render()},onTemplate:function(r){if(this.destroyed)return;if(!r){n.router.notFound();return}this.$el.html(this.renderTemplate(r,{subpage:_.orEqual(this.model.get("subpage"),t),section:_.orEqual(this.model.get("section"),e),pageNavOptions:this.getPageNavOptions()})),$(".about-slider").tinycarousel({interval:!0,duration:750,intervaltime:5e3,pager:!0})},showMenuDropdown:function(e){var t=$(e.currentTarget);this.menuTimer&&this.menuTimer.timer&&(clearTimeout(this.menuTimer.timer),this.menuTimer.timer=null),t.jjmenu(e,this.getMenuOptions(t),null,{xposition:"left",yposition:"bottom",show:"default",spill:"right",keepState:t,append:document.body,className:"menu-dropdown",shouldLog:!0})},hideMenuDropdown:function(e){this.menuTimer&&this.menuTimer.timer&&clearTimeout(this.menuTimer.timer),this.menuTimer.timer=setTimeout(_.bind(this.closeMenuDropDown,this),200)},stayShowingMenuDropdown:function(e){e&&e.timer&&clearTimeout(e.timer)},getPageNavOptions:function(){var e=this.model.get("subpage"),t=this.model.get("section");return{navItems:[{url:"#!/about",isActive:t==="about"||t==="",locale:"NAV_ABOUT",className:"menu-dropdown about"},{url:"#!/careers",isActive:t==="careers",locale:"NAV_CAREERS",className:"menu-dropdown careers"},{url:"#!/artists",isActive:t==="artists",locale:"NAV_ARTISTS"},{url:"#!/press",isActive:t==="press"||t=="logo",locale:"NAV_PRESS",className:"menu-dropdown press"},{url:"#!/contact",isActive:t==="contact",locale:"NAV_CONTACT"},{url:"#!/legal",isActive:t==="legal",locale:"NAV_LEGAL",className:"menu-dropdown legal"}]}},getMenuOptions:function(e){return e.hasClass("about")?this.menu=[{title:"The Team",action:{type:"gourl",url:"#!/about/team"}},{title:"Grooveshark University",action:{type:"gourl",url:"#!/about/university"}},{title:"Advertising",action:{type:"gourl",url:"#!/about/advertising"}},{title:"Grooveshark API",action:{type:"gourl",url:"http://developers.grooveshark.com/",target:"_blank"}}]:e.hasClass("careers")?this.menu=[{title:"Apply",action:{type:"gourl",url:"#!/careers/apply"}}]:e.hasClass("legal")?this.menu=[{title:"Terms",action:{type:"gourl",url:"#!/legal/terms"}},{title:"Artist Profile Terms",action:{type:"gourl",url:"#!/legal/artist_terms"}},{title:"Privacy",action:{type:"gourl",url:"#!/legal/privacy"}},{title:"Responsible Disclosure",action:{type:"gourl",url:"#!/legal/responsible_disclosure"}},{title:"DMCA Policy",action:{type:"gourl",url:"#!/legal/dmca"}},{title:"DMCA Form",action:{type:"gourl",url:"http://www.grooveshark.com/dmca_form",target:"_blank"}}]:e.hasClass("press")&&(this.menu=[{title:"Media Resources",action:{type:"gourl",url:"#!/logo"}}]),this.menu},closeMenuDropDown:function(e){$(".menu-dropdown").trigger("contextmenu")},submitAdvertising:function(e){e.preventDefault();var t=$(e.currentTarget),r=t.serializeArray(),i={},s=[];_.each(r,function(e){i[e.name]=e.value}),i["full-name"]==""&&s.push("full-name"),i.email==""&&s.push("email"),i.phone==""&&s.push("phone"),$(".control.error",t).removeClass("error");var o=$(".error-message");o.addClass("hide");if(s.length){_.each(s,function(e){$("#advertising-"+e,t).parent().addClass("error")});return}var u=function(){var e=$(".error-message");e.html("There was an error sending the email - please retry or contact us at advertising@grooveshark.com if this problem persists!"),e.removeClass("hide")};n.Services.API.sendAdvertisingEmail(i).done(function(e){if(!e){u();return}t.html('<p class="advertising-success">Sent! Look out for an email from us soon with more information.</p>')}).fail(u)}})}),define("/gs/views/pages/artists.js",function(){n.Views=n.Views||{},n.Views.Pages=n.Views.Pages||{};var e="",t="";n.Views.Pages.Artists=n.Views.Pages.Base.extend({templatePath:"artists",pageType:"artists",events:{},initialize:function(){this.rendered=!1,this.model.set({subpage:_.orEqual(this.options.params.subpage,t),section:_.orEqual(this.options.params.section,e)})},render:function(){this.options.params.notFound?this.fetchTemplate("not_found").always(_.bind(this.onTemplate,this)):this.options.params.section&&this.options.params.subpage?this.fetchTemplate(this.options.params.section+"/"+this.options.params.subpage).always(_.bind(this.onTemplate,this)):this.options.params.section?this.fetchTemplate(this.options.params.section).always(_.bind(this.onTemplate,this)):this.fetchTemplate("index").always(_.bind(this.onTemplate,this)),this.setTitle("Artists"),this.rendered=!0},updatePageParams:function(n){var r=this.options.params;this.options.params=n;var i=_.orEqual(n.subpage,t),s=_.orEqual(n.section,e);r.notFound!==n.notFound&&this.render();if(i!=r.subpage||s!=r.section)this.model.set({subpage:_.orEqual(n.subpage,t),section:_.orEqual(n.section,e)}),this.render()},onTemplate:function(n){if(this.destroyed)return;this.$el.html(this.renderTemplate(n,{subpage:_.orEqual(this.model.get("subpage"),t),section:_.orEqual(this.model.get("section"),e)}))}})}),define("/gs/views/pages/search.js",function(){function s(e){return _.ucwords(e)+"s"}n.Views=n.Views||{},n.Views.Pages=n.Views.Pages||{};var e="song",t={song:!0,playlist:!0,user:!0,event:!0,album:!0,artist:!0},r=["Songs","Artists","Albums"],i;n.Views.Pages.Search=n.Views.Pages.Base.extend({templatePath:"search",pageType:"search",events:{"click #did-you-mean-search-link":"trackSuggestionClick","click #did-you-mean-remove":"removeSuggestion","click .play-station":"onPlayStationClick"},initialize:function(){i=this.model.get("gsApp"),this.indexRendered=!1,this.prefetchedStreamKeys=!1,this.childViews=[],this.results={},this.searchType=this.options.params.type,this.query=_.orEqual(this.options.params.query,""),this.searchLoggingDFD=$.Deferred();if(!this.searchType||!t[this.searchType])this.searchType=e;var r=this.options.model.get("appModel");this.ppOverride=_.orEqual(_.orEqual(r.get("user").get("searchVersion"),r.get("searchVersion")),!1),this.ppOverride&&(this.overrideSearchVersion=this.ppOverride);var s=n.Services.GUTS.currentTest;if(s&&s.name){var o=s.name;o.indexOf("Interleaving_")==0&&(this.ppOverride=o,this.overrideSearchVersion=this.ppOverride)}if(this.query.indexOf("ppVersion:",0)===0){var u=this.query.split(/\s+/);this.ppOverride=u[0].split(":")[1],this.overrideSearchVersion=this.ppOverride,this.query=u.splice(1,u.length).join(" ")}this.query=$.trim(this.query.replace(/\s+/g," ")),this.cleanQuery=_.escape(this.query),this.queryAsTag=this.query.replace(/[\-\s]*/g,"").toLowerCase(),this.isTagSearch=!1,this.searchLoggingDFD.always(_.bind(function(e){this.reportGutsInformation(e)},this)),this.handleNoSongs=_.once(this.handleNoSongs)},updatePageParams:function(t){var n=this.searchType;this.searchType=t.type||e,this.searchType!==n&&(this.cleanupChildViews(),this.render())},render:function(){this.indexRendered=!1,this.leftToFetch=["Songs","Artists","Albums","Videos","Playlists","Users","Events"];var e=_.indexOf(this.leftToFetch,s(this.searchType));if(e!=-1){var t=this.leftToFetch.splice(e,1);this.leftToFetch.unshift(t[0])}this.pendingOutCalls=0;var r=_.chainLoading(),i;r.push(this.fetchTemplate("index").done(r.bind(this.renderIndex,this)));while(this.pendingOutCalls<3){i=this.fetchNext(r);if(!i)break;r.push(i)}r.push(n.Services.API.getGoogleSuggest(this.query).done(r.bind(this.showSuggestion,this))),this.searchType&&this.searchType!="digest"?this.setTitle("All "+_.ucwords(this.searchType)+" Results: "+this.query):this.setTitle("Search: "+this.query)},renderIndex:function(e){if(this.destroyed)return;this.$el.html(this.renderTemplate(e,{searchType:this.searchType,cleanQuery:this.cleanQuery,getUrl:_.bind(this.getUrl,this)})),this.indexRendered=!0,n.trigger("page:ready",this)},renderResults:function(e){if(this.destroyed||!this.indexRendered)return;s(this.searchType)===e?this.renderGrid(e):this.searchType==="digest"&&_.contains(r,e)&&this.renderDigestView(e),e!=="Songs"&&this.renderSnapshot(e)},renderDigestView:function(e){var t=e.toLowerCase().substr(0,e.length-1);this.fetchTemplate("digestSection").then(_.bind(function(n){var r=$(".content","#column1");r.append(this.renderTemplate(n,{type:t,cleanQuery:this.cleanQuery})),this.renderGrid(e,"#"+t+"-grid")},this))},renderSnapshot:function(e){var t=e.toLowerCase();this.fetchTemplate("top"+e).always(_.bind(function(n){if(this.destroyed||!this.indexRendered)return;var r=$("#"+t+"-snapshot");if(r.length){var i={cleanQuery:this.cleanQuery};i[t]=this.results[e]&&this.results[e].length?this.results[e].toArray().slice(0,3):[],r.html(this.renderTemplate(n,i))}},this))},renderGrid:function(e,t){t=t||"#grid";var r=$(t),i,o=$(".grid-toolbar"),u=this.results[e],a,f=new n.Models.PlayContext({contextType:"search",query:this.query});f.addStreamType(n.Models.PlayContext.TYPE_DEFAULT);if(this.searchType=="digest"){var l=e=="Songs"?15:4;u=new n.Models.Collections[e](_.first(u.models,l))}e==s(this.searchType)&&this.showHideNoResults(!u.length),r.empty();switch(e){case"Songs":var c=n.Views.SongGridTall,h={el:$(t)[0],collection:u,header:!1,playContext:f};this.searchType=="digest"&&(c=n.Views.SongGrid);var p={searchContext:!0},d=c.extend({handleItemDblclick:function(e){return n.trigger("guts:logsearch","dblClick",this,e),this._super.apply(this,["handleItemDblclick"].concat(_.toArray(arguments)))},handleDragEnd:function(e,t){return n.trigger("guts:logsearch","drag",this,e),this._super.apply(this,["handleDragEnd"].concat(_.toArray(arguments)))},contextMenuExtra:p});i=new d(h),p.grid=i;break;case"Albums":a=this.searchType=="digest"?"AlbumGrid":"AlbumGridTall",i=new n.Views[a]({el:$(t)[0],collection:u,header:!1});break;case"Artists":a=this.searchType=="digest"?"ArtistGrid":"ArtistGridTall",i=new n.Views[a]({el:$(t)[0],collection:u,header:!1});break;case"Playlists":i=new n.Views.PlaylistGridTall({el:$(t)[0],collection:u,header:!1});break;case"Users":i=new n.Views.UserGridTall({el:$(t)[0],collection:u,header:!1});break;case"Events":i=new n.Views.EventGridTall({el:$(t)[0],collection:u,header:!1})}if(i){this.searchType!="digest"&&i.$el.addClass("medium"),this.childViews.push(i),i.render();if(o.length){var v=new n.Views.GridToolbar({el:o[0],model:this.model,gridView:i,playContext:f,page:"search",buttons:e=="Songs"?["play","add","sort","filterSearch"]:["sort","filterSearch"]});this.childViews.push(v),v.render()}}},fetchNext:function(e){if(!this.leftToFetch.length)return;var t=this.leftToFetch.shift();t!="Videos"&&this.pendingOutCalls++;if(t=="Videos")return $.Deferred().resolve([]);if(t=="Songs"&&this.isTagSearch){var r=n.Views.Pages.Search.GENRE_TAGS[this.queryAsTag];return n.Services.API.tagRadioGetAllSongs(r).done(e.bind(this.handleSearchResults,this,"SongsByTag")).fail(e.bind(this.handleSearchResults,this,"SongsByTag"))}return!!this.isTagSearch||t!="Songs"&&t!="Artists"&&t!="Albums"?n.Services.API.getResultsFromSearch(this.query,t,this.ppOverride).done(e.bind(this.handleSearchResults,this,t)).fail(e.bind(this.handleSearchResults,this,t)):(this.leftToFetch=_.without(this.leftToFetch,"Songs","Artists","Albums"),n.Services.API.getResultsFromSearch(this.query,["Songs","Artists","Albums"],this.ppOverride).always(e.bind(this.handleMultiResults,this)))},orderDigest:function(e){var t=[];e.Songs[0]?t.push({name:e.Songs[0].SongName.toLowerCase(),verified:e.Songs[0].IsVerified,type:"Songs"}):t.push({name:"",verified:0,type:"Songs"}),e.Artists[0]?t.push({name:e.Artists[0].ArtistName.toLowerCase(),verified:e.Artists[0].IsVerified,type:"Artists"}):t.push({name:"",verified:0,type:"Artists"}),e.Albums[0]?t.push({name:e.Albums[0].AlbumName.toLowerCase(),verified:e.Albums[0].IsVerified,type:"Albums"}):t.push({name:"",verified:0,type:"Albums"});var n=0,r=t.length,i=this.query.toLowerCase(),s=i.indexOf(" by "),o=e.Tags&&e.Tags[0]?e.Tags[0].Tag.toLowerCase():"",u=o?$.trim(i.replace(o,"")):i,a,f,l,c=!1;if(u!=="")for(;n<r;n++){f=t[n].name==i||t[n].name==u,n!=1&&s>0?l=t[n].name==i.substring(0,s):l=!1;if(f||l){a=t[n].type;if(t[n].verified)break}else!c&&i.indexOf(t[n].name)!==-1&&t[n].verified&&(c=t[n].type)}var h=["Songs","Albums","Artists"];return a?(a!="Songs"?h.splice(_.indexOf(h,a),1):a="FeatureSong",h.unshift(a)):e.Tags?h.unshift("Tags"):c&&(h.splice(_.indexOf(h,c),1),h.unshift(c)),console.log("order of digest",h),h},getUrl:function(e){e=e||"",e=e.toLowerCase();var t=encodeURIComponent(this.query);return t=t.replace(/%20/g,"+"),e?"/#!/search/"+e+"?q="+t:"/#!/search?q="+t},showHideNoResults:function(e){function t(e){e.removeClass("hide")}function n(e){e.addClass("hide")}e?(n($("#search-type-header")),n($("#grid-toolbar-container")),n($("#grid")),t($("#search-no-match-header")),t($("#grid-no-results"))):(t($("#search-type-header")),t($("#grid-toolbar-container")),t($("#grid")),n($("#search-no-match-header")),n($("#grid-no-results")))},handleMultiResults:function(e){if(!e||!e.result){this.showHideNoResults(!0);return}var t=this.orderDigest(e.result);if(this.searchType=="song"&&_.indexOf(t,"Songs")>0){var r=t[0];r=r=="FeatureSong"?"Songs":r;var i=e.result[r];if(i&&i.length){var s;r=="Artists"?s=n.Models.Artist.newOrUpdate(i[0]):r=="Albums"?s=n.Models.Album.newOrUpdate(i[0]):r=="Tags"?s=n.Models.Tag.newOrUpdate($.extend({},i[0])):r=="Songs"&&(s=n.Models.Song.newOrUpdate($.extend({},i[0]))),this.featureItem(s,r)}t.shift()}for(var o=0,u;u=t[o];o++)this.handleSearchResults(u,{result:e.result[u],version:e.version,assignedVersion:e.assignedVersion})},featureItem:function(e,t){var r=$("#featured-item"),i=$(".featured-type-title",r[0]),s=$("a.view-more",r[0]),o;switch(t){case"Songs":i.attr("data-translate-text","TOP_SONG_RESULT").text(_.getString("TOP_SONG_RESULT")),s.addClass("hide"),o=new n.Views.Modules.SongProfileCard({model:e,addClass:"featured",hideSuggestTags:!0}),this.searchType=="song"&&$("#search-type-header").attr("data-translate-text","ALL_SONG_MATCHES").text(_.getString("ALL_SONG_MATCHES"));break;case"Artists":i.attr("data-translate-text","TOP_ARTIST_RESULT").text(_.getString("TOP_ARTIST_RESULT")),s.find(".see-all-text").attr("data-translate-text","SEE_ALL_ARTIST_RESULTS").text(_.getString("SEE_ALL_ARTIST_RESULTS")),s.attr("href",this.getUrl("artist")),o=new n.Views.Modules.ArtistProfileCard({model:e,addClass:"featured",hideSuggestTags:!0});break;case"Albums":i.attr("data-translate-text","TOP_ALBUM_RESULT").text(_.getString("TOP_ALBUM_RESULT")),s.find(".see-all-text").attr("data-translate-text","SEE_ALL_ALBUM_RESULTS").text(_.getString("SEE_ALL_ALBUM_RESULTS")),s.attr("href",this.getUrl("album")),o=new n.Views.Modules.AlbumProfileCard({model:e,addClass:"featured",hideSuggestTags:!0});break;case"Tags":i.attr("data-translate-text","TOP_TAG_RESULT").text(_.getString("TOP_TAG_RESULT")),s.addClass("hide"),o=new n.Views.Modules.TagProfileCard({model:e,addClass:"featured",hideSuggestTags:!0});break;default:return}this.featuredItem={item:e,type:t},t!=="Tags"&&(o.$el.addClass("small"),o.small=!0),r.removeClass("hide"),r.append(o.$el),o.render(),o.on("rendered",function(){n.trigger("page:redrawUpdate")}),this.childViews.push(o),e&&e.getPageNameData&&e.getPageNameData(),e.get("ArtistID")&&n.trigger("theme:notification",{artistID:e.get("ArtistID"),timeout:750})},onPlayStationClick:function(e){n.trigger("player:radio",!0,null,{seeds:[$(e.currentTarget).data("artistId")],seedArtistWeightRange:[110,130],secondaryArtistWeightModifier:.75}),n.trigger("guts:gatrack","player","autoplayOn","artist"),n.trigger("guts:forcelog","autoplayOn",{autoplay:0,autoplayType:"artist"}),n.trigger("guts:begincontext",{autoplay:0,autoplayType:"artist"})},handleSearchResults:function(e,t){e=e=="FeatureSong"?"Songs":e;var r=t&&$.isArray(t.result)?t.result:[],i=t.version,o=s(this.searchType);e==="SongsByTag"&&(e="Songs",r=$.isArray(t)?t:[]),e==="Videos"&&(r=$.isArray(t)?t:[]),this.results[e]=new n.Models.Collections[e](r),i&&e==s(this.searchType)&&(this.model.get("appModel").set("searchVersion",i),this.searchLoggingDFD.resolve(this.model.get("appModel").get("searchVersion")));if(this.searchType=="digest"||e==o)if(e==="Songs"&&!this.prefetchedStreamKeys){var u=Math.min(this.results.Songs.length,3);if(u){var a=[];for(var f=0;f<u;f++)a.push(this.results.Songs.at(f).get("SongID"));n.dispatcher.trigger("swf:prefetchStreamKeys",a),this.prefetchedStreamKeys=!0}}this.renderResults(e),this.pendingOutCalls--;var l=_.chainLoading(),c;while(this.pendingOutCalls<3){if(!(c=this.fetchNext(l)))break;l.push(c)}this.pendingOutCalls<-1&&!this.results.Songs.length&&this.handleNoSongs()},handleNoSongs:function(){var e=this.query.toLowerCase(),t=["artist","user","album","playlist","event"],r=[];r.push(this.results.Artists.filter(_.bind(function(t){return $.trim(t.get("ArtistName").toLowerCase())==e},this)).length),r.push(this.results.Users.filter(_.bind(function(t){return $.trim(t.get("Name").toLowerCase())==e},this)).length),r.push(this.results.Albums.filter(_.bind(function(t){return $.trim(t.get("AlbumName").toLowerCase())==e},this)).length),r.push(this.results.Playlists.filter(_.bind(function(e){return $.trim(e.get("PlaylistName").toLowerCase())==this.query.toLowerCase()},this)).length),r.push(this.results.Events.filter(_.bind(function(e){return $.trim(e.get("EventName").toLowerCase())==this.query.toLowerCase()},this)).length);var i=Math.max.apply(Math,r);i!==0&&n.router.setHash(this.getUrl(t[_.indexOf(r,i)]))},showSuggestion:function(e){if(e==this.query)return;var t=$("#did-you-mean");t.find("a.search-link").text(e).attr("title",e).data({searchquery:e,suggestionSource:"eg",searchtype:this.searchType?this.searchType:""}),t.removeClass("hide");var r=this.searchType=="digest"?"Songs":this.searchType,i=this.results[r]?this.results[r].length:0;n.trigger("guts:gatrack","search","suggest",this.suggestSource),n.trigger("guts:log","suggest",{suggest:e,source:"eg",numSongs:i})},trackSuggestionClick:function(e){var t=$(e.currentTarget),r=t.data("suggestionSource"),i=t.data("suggestion"),s=this.searchType=="digest"?"Songs":this.searchType,o=this.results[s]?this.results[s].length:0;n.trigger("guts:gatrack","search","suggestClick",r,o),n.trigger("guts:log","suggestClick",{suggest:i,source:r,numSongs:o})},reportGutsInformation:function(e){e=_.orEqual(e,this.overrideSearchVersion);var t={type:this.searchType||"song",searchString:this.query,searchVersion:e};this.isTagSearch&&(t.isTagSearch=!0,t.tagID=this.tagID),n.trigger("guts:log","search",t);var r={mostRecentSearch:this.query,mostRecentSearchType:this.searchType||"song",mostRecentSearchVersion:e};this.isTagSearch&&(r.mostRecentTagSearched=this.tagID),n.trigger("guts:begincontext",r),!this.isTagSearch&&n.Services.GUTS&&n.Services.GUTS.context.hasOwnProperty("mostRecentTagSearched")&&n.trigger("guts:endcontext","mostRecentTagSearched")},removeSuggestion:function(e){$("#did-you-mean").slideUp("fast")},onDestroy:function(){n.off("manatee:broadcastEnded",null,this)}},{GENRE_TAGS:{"40s":2837,"50s":1087,"60s":266,"70s":588,"80s":55,"8bit":2145,"90s":9,acapella:4263,acidjazz:3519,acoustic:105,alternativerock:1259,ambient:75,americana:922,anime:120,banda:4264,bass:585,beach:912,beat:1475,bhangra:130,blackmetal:4265,bluegrass:96,blues:230,bluesrock:1106,britpop:534,celtic:513,chanson:3692,chillout:251,chinese:4266,christian:439,christianmetal:4267,christianrock:4268,christmas:703,classical:750,classiccountry:4269,classicrock:3529,club:1038,contemporarychristian:4270,country:80,crunk:748,cumbia:4271,dance:71,dancehall:269,darkwave:2139,dcima:4272,deathmetal:4273,desi:2512,disco:899,disney:623,dnb:273,downtempo:153,dub:3501,dubstep:2563,electro:162,electronic:123,electronica:67,electropop:893,emo:131,eurodance:4028,experimental:191,flamenco:85,folk:122,folkrock:925,funk:397,funky:398,goa:2556,gospel:1489,grime:268,grunge:134,hardcore:245,hardstyle:4274,heavymetal:1054,hiphop:29,house:48,indie:136,indiefolk:1221,indiepop:573,indierock:1138,industrial:275,island:2294,jazz:43,jazzblues:4275,jazzfusion:4276,jesus:1356,jpop:568,jrock:434,jungle:248,kpop:1765,lounge:765,mathrock:4277,medieval:2585,meditation:700,melodic:929,merengue:84,metal:17,metalcore:705,minimal:2177,motown:4278,mpb:819,neofolk:1139,neosoul:4279,noise:171,nujazz:3518,numetal:1103,oi:4280,oldies:102,opera:1535,orchestra:2760,pagode:3606,pop:56,poppunk:1333,poprock:3468,posthardcore:1332,postrock:422,powermetal:4063,progressive:97,progressiverock:4137,psychedelic:1168,psychobilly:3909,punkrock:1754,ragga:4281,rap:3,rave:271,rb:4282,reggae:160,reggaeton:940,relax:1941,rnb:877,"r&b":877,rock:12,rockabilly:1086,rocksteady:4283,rootsreggae:4284,rumba:3454,salsa:81,samba:4285,schlager:3162,screamo:166,sertanejo:4286,singersongwriter:923,ska:100,skapunk:1110,smoothjazz:3855,softrock:1311,soul:520,soundtrack:72,southernrock:1298,surf:1408,swing:1032,symphonicmetal:4287,synthpop:163,tango:2868,techno:47,tejano:789,texascountry:4288,thrashmetal:4289,trance:69,triphop:158,turkish:689,underground:468,vallenato:89,videogame:115,vocal:6,world:313,zydeco:4290}})}),define("/gs/views/pages/popular.js",function(){n.Views=n.Views||{},n.Views.Pages=n.Views.Pages||{};var e="songs",t="daily",r;n.Views.Pages.Popular=n.Views.Pages.Base.extend({templatePath:"popular",pageType:"popular",events:{"click .today, .week, .month, .year":"onButtonGroupClick"},initialize:function(e){r=this.model.get("gsApp"),this.rendered=!1,this.modelBindings=[],this.childViews=[],this.gridView=null,this.timeRange=e.params.type||t,this.model.on("change",this.onModelChange,this),this.model.on("change:type",this.onTypeChange,this),this.updatePageParams(this.options.params)},updatePageParams:function(n){var r=_.orEqual(n.subpage,e),i=_.orEqual(n.type,t),s={};r!==this.model.get("subpage")&&(s.subpage=r),i!==this.model.get("type")&&(s.type=i),_.keys(s).length&&this.model.set(s)},onModelChange:function(){var e=this.model.get("subpage"),t=this.model.get("type");t&&t!==this.timeRange&&(n.router.replaceHash("/popular/"+t),this.timeRange=t);switch(e){case"songs":n.Services.API.popularGetSongs(t).done(_.bind(function(e){this.popularSongs=new n.Models.Collections.Songs(e&&e.Songs||[]),this.songsRendered?this.gridView.collection.reset(this.popularSongs.models,{sorted:!0}):this.render()},this));break;case"artists":case"playlists":case"people":break;default:n.router.notFound();return}},onDestroy:function(){_.each(this.modelBindings,_.bind(function(e){e.off(null,null,this)},this))},onButtonGroupClick:function(e){var t=$(e.currentTarget),n={subpage:this.model.get("subpage")};t.hasClass("today")?n.type="daily":t.hasClass("week")?n.type="weekly":t.hasClass("month")?n.type="monthly":t.hasClass("year")&&(n.type="yearly"),this.updatePageParams(n)},onTypeChange:function(){var e=this.model.get("type");e=="daily"?($(".today").addClass("active"),$(".today").siblings().removeClass("active")):e=="weekly"?($(".week").addClass("active"),$(".week").siblings().removeClass("active")):e=="monthly"?($(".month").addClass("active"),$(".month").siblings().removeClass("active")):e=="yearly"&&($(".year").addClass("active"),$(".year").siblings().removeClass("active"))},render:function(){this.indexRendered=!1,this.songsRendered=!1,this.fetchTemplate("index").always(_.bind(this.renderIndex,this)),this.rendered=!0,this.setTitle(["Popular",_.ucwords(this.model.get("subpage"))])},renderIndex:function(e){if(this.destroyed||!this.popularSongs||this.indexRendered)return;this.childViews&&_.each(this.childViews,function(e){_.isFunction(e.close)&&e.destroy()}),this.childViews=[],this.$el.html(this.renderTemplate(e,{subpage:this.model.get("subpage")})),this.indexRendered=!0;switch(this.model.get("subpage")){case"artists":this.renderArtists();break;case"playlists":this.renderPlaylists();break;case"people":this.renderPeople();break;case"songs":default:this.renderSongs()}n.trigger("page:ready",this)},renderSongs:function(){if(this.destroyed||!this.indexRendered||!this.popularSongs||!this.popularSongs.length||this.model.get("subpage")!="songs")return;var e=$("#grid.popular");if(e.length){if(this.gridView){this.gridView.destroy();var r=_.indexOf(this.childViews,this.gridView);r!=-1&&this.childViews.splice(r,1)}this.gridView=new n.Views.SongGridTall({el:e,collection:this.popularSongs,showCount:!0,header:!1,playContext:new n.Models.PlayContext({contextType:"popular"})}),this.childViews.push(this.gridView),this.gridView.render()}var i=$(".grid-toolbar");if(e.length&&i.length){if(this.gridToolbarView){this.gridToolbarView.destroy();var r=_.indexOf(this.childViews,this.gridToolbarView);r!=-1&&this.childViews.splice(r,1)}this.gridToolbarView=new n.Views.GridToolbar({el:i[0],model:this.model,gridView:this.gridView,page:"popular",buttons:["play","add","popular","filterSearch"],popularTimeRange:this.model.get("type")||t,playContext:new n.Models.PlayContext({contextType:"popular"})}),this.childViews.push(this.gridToolbarView),this.gridToolbarView.render()}this.songsRendered=!0},renderArtists:function(){},renderPlaylists:function(){},renderPeople:function(){}})}),define("/gs/views/pages/tags.js",function(){n.Views=n.Views||{},n.Views.Pages=n.Views.Pages||{};var e;n.Views.Pages.Tags=n.Views.Pages.Base.extend({templatePath:"tags",pageType:"tags",events:{},initialize:function(){e=this.model.get("gsApp"),this.childViews=[],this.model.set(this.options.params)},updatePageParams:function(e){if(e.subpage!==this.model.get("subpage")||e.type!==this.model.get("type"))this.model.set(e),this.cleanupChildViews(),this.hasRendered&&this.render()},render:function(){this.hasRendered=!0;var e=this.model.get("subpage"),t=this.model.get("appModel").get("user"),r=_.chainLoading();r.push(this.fetchTemplate("index").done(r.bind(this.renderIndex,this))),r.push(n.Models.Tag.getTopLevelTags().done(r.bind(function(e){var t=new n.Models.Collections.Tags(e.models),r=t.get(6994);r&&t.remove(r),t.comparator=_.getModelSort("DisplayName",!0),t.sort(),this.model.set("genres",t)},this))),r.done(_.bind(this.renderGenres,this)),this.setTitle("Tags")},renderIndex:function(e){this.$el.html(this.renderTemplate(e)),n.trigger("page:ready",this)},renderGenres:function(){if(this.destroyed||!this.model.get("genres"))return;var e=$("#grid"),t;e.length&&(e.empty(),t=new n.Views.TagGrid({el:e[0],collection:this.model.get("genres")}),this.childViews.push(t),t.render())}},{lowIDFs:[2856,10,102,160,230,424,750,787,814,898,1411,1704,1748,1749,1750,1755,1933,2412,2563,3502,6928,6994,7517,7614,7621,104,162,283,645,678,3529]})}),define("/gs/views/lightboxes/generic.js",function(){n.Views=n.Views||{},n.Views.Lightboxes=n.Views.Lightboxes||{},n.Views.Lightboxes.Generic=n.Views.Lightboxes.Base.extend({initialize:function(e){this._super("initialize"),this.view=e.params.view},onDestroy:function(){this.$el.off("click.generic"),this.options.params&&_.isFunction(this.options.params.onDestroy)&&this.options.params.onDestroy.call(this)},render:function(){this._super("render"),this.fetchTemplate("generic").always(_.bind(this.onTemplate,this))},onTemplate:function(e){if(this.suspended||this.destroyed)return;var t=this.options.params;this.$el.html(this.renderTemplate(e,{type:this._type||t&&t.type,view:this.view})),this.makeButtons();var r=this.$el;_.forEach(this.options.params.callbacks,function(e,t){r.on("click.generic",t,e)}),this._super("onTemplate"),n.trigger("lightbox:rendered")},makeButtons:function(){var e=function(e){if(e.buttonHTML)return e.buttonHTML;var t=document.createElement("a");e.href&&(t.href=e.href),t.className="btn btn-large "+(e.className||"")+" "+(e.disabled||"");if(e.labelHTML)t.innerHTML=e.labelHTML;else{var n=document.createTextNode(_.getString(e.label));t.setAttribute("data-translate-text",e.label),t.appendChild(n)}return e.target&&t.setAttribute("target",e.target),e.data&&t.setAttribute("data-"+e.data.label,e.data.value),t},t=[],n=[];_.forEach(this.view.buttonsLeft,function(n){t.push(e(n))}),_.forEach(this.view.buttonsRight,function(t){n.push(e(t))}),$("div.left-btns").append(t),$("div.right-btns").append(n)}})}),define("/gs/views/lightboxes/locale.js",function(){function t(e,t){return e.name.toLowerCase()>t.name.toLowerCase()?1:-1}n.Views=n.Views||{},n.Views.Lightboxes=n.Views.Lightboxes||{};var e=[{locale:"ca",name:"Catal"},{locale:"cs",name:"etina"},{locale:"hr",name:"hrvatski"},{locale:"cy",name:"Cymraeg"},{locale:"da",name:"Dansk"},{locale:"de",name:"Deutsch"},{locale:"el",name:""},{locale:"en",name:"English"},{locale:"es",name:"Espaol"},{locale:"et",name:"Eesti"},{locale:"eu",name:"Euskara"},{locale:"fr",name:"Franais"},{locale:"gl",name:"Galego"},{locale:"hu",name:"magyar"},{locale:"ko",name:""},{locale:"nl",name:"Nederlands"},{locale:"lv",name:"Latvijas"},{locale:"lt",name:"Lietuvi"},{locale:"pl",name:"Polski"},{locale:"pt",name:"Portugus"},{locale:"ru",name:""},{locale:"sk",name:"Slovenina"},{locale:"fi",name:"Suomi"},{locale:"sv",name:"Svenska"},{locale:"tr",name:"Trke"},{locale:"uk",name:"Y"},{locale:"zh",name:""},{locale:"bg",name:""},{locale:"it",name:"Italiano"},{locale:"ja",name:""},{locale:"nb",name:"Norsk "},{locale:"ro",name:"Romn"},{locale:"sl",name:"Slovenina"}];n.Views.Lightboxes.Locale=n.Views.Lightboxes.Base.extend({events:{"click a.language":"onLanguageClick"},initialize:function(){this._super("initialize"),this.model.set("languages",e.sort(t))},render:function(){this._super("render"),this.fetchTemplate("locale").always(_.bind(this.onTemplate,this))},onTemplate:function(e){if(this.suspended||this.destroyed)return;this.$el.html(this.renderTemplate(e)),this._super("onTemplate"),n.trigger("lightbox:rendered")},onLanguageClick:function(e){var t=e.currentTarget,r=$(t).attr("rel");n.trigger("locale:change",r),n.trigger("guts:log","localeChangePerformed",{newLocale:r,navigatorLanguage:navigator.language,browserLanguage:gsConfig.lang}),n.trigger("guts:endcontext","locale"),n.trigger("guts:begincontext",{locale:r}),n.trigger("guts:gatrack","site","localeChangePerformed",r),this.close()}})}),define("/gs/views/lightboxes/login.js",function(){n.Views=n.Views||{},n.Views.Lightboxes=n.Views.Lightboxes||{};var t;n.Views.Lightboxes.Login=n.Views.Lightboxes.Base.extend({_priority:5,events:{"click a.signup":"gotoSignup","click a.upgrade":"gotoUpgrade","click a.forgot":"gotoForgot","click .exit-preview":"exitPreview","click .submit":"onSubmitClick","submit form":"onFormSubmit","click #lb-google-login":"loginWithGoogle","click #lb-twitter-login":"loginWithTwitter","click .open-signup":"gotoSignup"},initialize:function(){this._super("initialize"),t=this.model.get("appModel");var e=t.get("adrollPages");this.model.set("canClose",this._canClose),_.indexOf(e,"signin")===-1&&e.push("signin"),n.trigger("guts:log","LightboxOpened",{lightbox:"login"})},render:function(){this._super("render"),this.fetchTemplate("login").always(_.bind(this.onTemplate,this))},onDestroy:function(){var e=$("#lightbox-login-form",this.$el);e.length||(e=$("#lightbox-login-form")),e.detach(),$("#login-password",e).val(""),$("#lightbox-login-holder").append(e),_.isFunction(this.options.params.onClose)&&_.defer(this.options.params.onClose)},onTemplate:function(e){if(this.suspended||this.destroyed)return;var t=$("#lightbox-login-form");t.detach(),this.$el.html(this.renderTemplate(e)),$("#lightbox-login-form-goes-here").append(t);var r=this.options.params||{},i=[];r&&r.username&&$("#login-username").val(r.username),r.error&&this.showError(r.error),r.message&&i.push(r.message),r.extraMessage&&i.push(r.extraMessage),r.premiumRequired?$("#lightbox-header p.title").attr("data-translate-text","LB_SIGNUP_LOGIN_PREMIUM_TITLE").html(_.getString("LB_SIGNUP_LOGIN_PREMIUM_TITLE")):r.overrideTitle?$("#lightbox-header p.title").attr("data-translate-text",r.overrideTitle).html(_.getString(r.overrideTitle)):$("#lightbox-header p.title").attr("data-translate-text","LB_LOGIN_TITLE").html(_.getString("LB_LOGIN_TITLE")),i.length&&this.showMessages(i);var s=$("#login-username");$("#login-username",this.element).focus(),s.val()?s.closest(".control-group").addClass("has-text"):s.closest(".control-group").removeClass("has-text"),this._super("onTemplate"),n.trigger("lightbox:rendered")},showError:function(e){$("#lightbox-error").removeClass("hide").text(e)},showMessages:function(e){var t=[];_.forEach(e,function(e){t.push("<p>",e,"</p>")}),this.$el.find("div.positive div.message",this.$el).html(t.join("")),this.$el.find("div.positive",this.$el).removeClass("hide")},gotoSignup:function(e){var t=this.options.params.onClose;t&&delete this.options.params.onClose,this.close(),n.trigger("lightbox:open","signup",{onLogin:this.options.params.onLogin,destination:this.options.params.destination,onClose:t,premiumRequired:this.options.params.premiumRequired,_canClose:this.options.params._canClose}),_.gaTrackPageView("#!/sub-funnel/login-lb-click/link-"+($(e.currentTarget).hasClass("signup")?"signup-top":"signup-bottom"))},gotoUpgrade:function(e){this.close()},gotoForgot:function(e){this.close(),n.trigger("lightbox:open","forget",{premiumRequired:this.options.params.premiumRequired,_canClose:this.options.params._canClose})},exitPreview:function(t){return _.cookie("jpreview",null,{domain:".grooveshark.com"}),setTimeout(function(){e.location="http://grooveshark.com"},100),!1},onSubmitClick:function(e){$("#lightbox-login-form").submit()},onFormSubmit:function(t){$("#lightbox-error").addClass("hide");var n=$("#login-username").val(),r=$("#login-password").val(),i=this.options.params&&this.options.params.destination,s=this.options.params.preventRedirect;e.external&&_.has(e.external,"AutoCompleteSaveForm")&&e.external.AutoCompleteSaveForm(document.getElementById("lightbox-login-form")),this.model.get("appModel").login("normal",n,r,i,s).then(_.bind(this.loginSuccess,this)).fail(_.bind(this.loginFailed,this))},loginWithGoogle:function(e){var t=this.options.params&&this.options.params.destination;this.model.get("appModel").login("google",null,null,t).done(_.bind(this.loginSuccess,this)).fail(_.bind(this.loginFailed,this))},loginWithTwitter:function(e){var t=this.options.params&&this.options.params.destination;this.model.get("appModel").login("twitter",null,null,t).done(_.bind(this.loginSuccess,this)).fail(_.bind(this.loginFailed,this))},loginSuccess:function(e){$("#login-password").val(""),this.close(),_.isFunction(this.options.params.onLogin)&&_.defer(this.options.params.onLogin,e)},loginFailed:function(e){$("#login-password").val("");var t;e.error?(t=_.getString(e.error),t=t.length?t:e.error,this.showError(t)):e&&e.loginReason==1?(t="LB_SIGNUP_LOGIN_FORM_CLAIM_PENDING",this.showError(_.getString(t))):e&&e.authType=="google"?(t="LB_SIGNUP_LOGIN_FORM_GOOGLE_ERROR",this.showError(_.getString(t))):e&&e.authType=="twitter"?(t="LB_SIGNUP_LOGIN_FORM_TWITTER_ERROR",this.showError(_.getString(t))):e&&e.userID===0?(t="LB_SIGNUP_LOGIN_FORM_AUTH_ERROR",this.showError(_.getString(t))):(t="LB_SIGNUP_LOGIN_FORM_GENERAL_ERROR",this.showError(_.getString(t))),t.length&&_.gaTrackPageView("#!/sub-funnel/login-lb-error/error-"+t)}})}),define("/gs/views/lightboxes/forget.js",function(){n.Views=n.Views||{},n.Views.Lightboxes=n.Views.Lightboxes||{};var e=5,t=32;n.Views.Lightboxes.Forget=n.Views.Lightboxes.Base.extend({events:{"click .login":"onLoginClick","click .submit":"onSubmitClick","submit form":"onFormSubmit"},initialize:function(){this._super("initialize"),this.model.set("reset",this.options.params.hasOwnProperty("resetCode")),this.model.set("canClose",this.options.params._canClose)},render:function(){this._super("render"),this.fetchTemplate("forget").always(_.bind(this.onTemplate,this))},onTemplate:function(e){if(this.suspended||this.destroyed)return;this.$el.html(this.renderTemplate(e)),this._super("onTemplate"),n.trigger("lightbox:rendered")},showError:function(e){this.$el.find(".error-text").text(e),this.$el.find(".error").removeClass("hide")},onLoginClick:function(e){this.close(),n.trigger("lightbox:open","login",{premiumRequired:this.options.params.premiumRequired,_canClose:!this.options.params.premiumRequired})},onSubmitClick:function(e){$("#lightbox-forget-form").submit()},onFormSubmit:function(r){r.preventDefault();var i=$("#forget-username").val();if(this.model.get("reset")){var s=$("#forget-new-password").val(),o=$("#forget-confirm-password").val();s==o&&s.length&&s.length>=e&&s.length<=t?n.Services.API.resetPassword(i,this.options.params.resetCode,s).done(_.bind(this.resetSuccess,this,i,s)).fail(_.bind(this.resetFailed,this)):this.showError(_.getString("POPUP_SIGNUP_FORM_PASSWORD_INVALID_NO_MATCH"))}else n.Services.API.userForgotPassword(i).done(_.bind(this.serviceSuccess,this)).fail(_.bind(this.serviceFailed,this));return!1},serviceSuccess:function(e){if(!e||e&&e.userID==0)return this.serviceFailed(e);this.close(),n.trigger("notification:add",{title:_.getString("LB_RESET_PASSWORD_SUCCESS"),icon:"gear icon-gear-white-active",type:"success"})},serviceFailed:function(e){this.showError(_.getString("POPUP_SIGNUP_FORGOT_FORM_RESPONSE_ERROR"))},resetSuccess:function(e,t,n){if(!n||n.success!=1)return this.resetFailed(n);this.model.get("appModel").login("normal",e,t),this.close()},resetFailed:function(e){_.defined(e.success)?e.success==0?this.showError(_.getString("LB_FORGET_RESET_ERROR_BADUSER")):this.showError(_.getString("LB_FORGET_RESET_ERROR_BADCODE")):this.showError(_.getString("LB_FORGET_RESET_ERROR_UNKNOWN"))},close:function(){this._super("close"),this.options.params.premiumRequired&&n.trigger("lightbox:open","login",{premiumRequired:this.options.params.premiumRequired,_canClose:!this.options.params.premiumRequired})}})}),define("/gs/views/lightboxes/swfTimeout.js",function(){n.Views=n.Views||{},n.Views.Lightboxes=n.Views.Lightboxes||{},n.Views.Lightboxes.SwfTimeout=n.Views.Lightboxes.Generic.extend({events:{"click .reload":"onReloadClick"},initialize:function(e){this._super.apply(this,["initialize"].concat(_.toArray(arguments)));var t=swfobject.hasFlashPlayerVersion("9.0.0"),r="http://get.adobe.com/flashplayer/"+(n.External.DesktopBridge.active?"otherversions/":""),i=t?_.getString("LB_SWF_TIMEOUT_MESSAGE"):_.getString("LB_NO_FLASH_MSG",{url:r}),s=_.getString("LB_HTML5_MESSAGE",{url:"http://html5.grooveshark.com"});this.view={header:"LB_SWF_TIMEOUT_TITLE",messageHTML:"<p>"+i+"<br /><br />"+s+"</p>",buttonsRight:[{label:"LB_REFRESH_GROOVESHARK",className:"reload"}]},n.trigger("lightbox:rendered"),t||(this.view.buttonsLeft=[{label:"LB_INSTALL_FLASH",href:r,className:"install",target:"_blank"}],n.Views.Lightbox.trackLightboxView("swfTimeout/noFlash")),n.Services.SWF.ready.done(_.bind(function(){n.Views.Lightbox.trackLightboxView("swfTimeout/autoClosed"),_.defer(_.bind(this.close,this))},this))},onReloadClick:function(t){e.location.reload(!0)}})}),define("/gs/views/lightboxes/profileCard.js",function(){n.Views=n.Views||{},n.Views.Lightboxes=n.Views.Lightboxes||{},n.Views.Lightboxes.ProfileCard=n.Views.Lightboxes.Base.extend({templatePath:"lightbox/profileCard",events:{"click a:not(.btn, .more-friends)":"close","click .view-profile":"close","click .more-friends":"moreFriendsClick"},initialize:function(e){this._super("initialize"),this.options.params=this.options.params||{},this.childViews=[],this.mutualFriendsTemplate=this.fetchTemplate("mutualFriends"),this.model.set("userID",e.params.userID)},onDestroy:function(){var e=this.model.get("user");e&&e.off(null,null,this)},onUser:function(e){this.model.set("user",e),e.on("change:isFavorite",this.onFavoriteChange,this),e.getPageNameData(),e.getTopArtists()},render:function(){this._super("render");var e=_.chainLoading();e.push(n.Models.User.get(this.model.get("userID"),{notifyCache:!0}).done(e.bind(this.onUser,this))),e.push(this.fetchTemplate("profileCard").always(e.bind(this.onTemplate,this)))},onTemplate:function(e){if(this.suspended||this.destroyed||this.rendered)return;var t=this.model.get("user"),r=this.model.get("appModel").get("user"),i=r.get("Following");this.$el.html(this.renderTemplate(e,t)),t.getPageNameData().done(_.bind(this.onPageNameData,this)),t.getTopArtists().done(_.bind(this.onTopArtists,this)),t.get("UserID")!==n.getLoggedInUserID()&&r.get("isLoggedIn")&&t.getIntersectingFollowers(i).done(_.bind(this.onIntersectingFollowers,this)),this._super("onTemplate"),this.rendered=!0,n.trigger("lightbox:rendered")},onPageNameData:function(){if(this.suspended||this.destroyed)return;var e=this.model.get("user"),t=e.get("pageNameData"),n=_.toInt(t.BroadcastListens),r=e.get("followers"),i=r?r.length:_.toInt(t.FollowedCount),s=e.get("favoriteUsers"),o=s?s.length:_.toInt(t.FollowingCount);n&&this.$el.find(".broadcast-listen-count").text(_.truncateNumber(n)).parent().removeClass("hide"),this.$el.find(".follower-count").text(_.truncateNumber(i)),this.$el.find(".following-count").text(_.truncateNumber(o))},onTopArtists:function(){if(this.suspended||this.destroyed)return;var e=this.model.get("user");if(e.get("topArtists").length>0){var t=new n.Views.ArtistGridMini({el:this.$el.find(".top-artists-grid")[0],collection:new n.Models.Collections.Artists(e.get("topArtists").first(5)),header:!1,showCount:!0});t.render(),this.childViews.push(t),$("#lb-profile-content").removeClass("closed")}},onFavoriteChange:function(){if(this.suspended||this.destroyed)return;var e=this.model.get("user"),t=this.$el.find("#lightbox-footer .btn.favorite"),n=t.find(".icon"),r=t.find(".label");e.get("isFavorite")?(t.removeClass("btn-primary").addClass("btn-success"),n.removeClass("plus icon-plus-white").addClass("check icon-check-white"),r.text(_.getString("FOLLOWING"))):(t.removeClass("btn-success").addClass("btn-primary"),n.removeClass("check icon-check-white").addClass("plus icon-plus-white"),r.text(_.getString("FOLLOW")))},onIntersectingFollowers:function(e){if(this.suspended||this.destroyed)return;if(e&&e.length){var t=this.model.get("user"),n=this.$el.find("#profile-intersecting-followers"),r=_.getString(e.length>1?"MUTUAL_FRIENDS_PLURAL":"MUTUAL_FRIENDS_SINGLE",{count:e.length}),i=_.calculateTextWidth(r+":",{fontSize:"11px",fontWeight:"bold",textTransform:"capitalize"})+7,s=Math.floor((350-i)/22),o=e.first(s),u=e.length-s;this.mutualFriendsTemplate.done(_.bind(function(i){n.html(this.renderTemplate(i,{user:t,intersectingFollowers:o,num:e.length,numText:r,numLeft:u})),n.removeClass("closed")},this))}},moreFriendsClick:function(e){var t=this.model.get("user");n.trigger("lightbox:open","mutualFriends",{userID:t.get("UserID")})}})}),function(){n.Views=n.Views||{};var e;n.Views.Tooltips.Tacobell=Backbone.View.extend({templatePath:"tooltip",initialize:function(){e=this.options.appModel,this.renderDfd=$.Deferred()},newNotification:function(){if(!e.get("user").get("notifications"))return;var t=e.get("user").get("notifications").getNormalized(e.get("user"),1),n=e.get("user").get("artistID");t&&t.length&&this.renderDfd.state()==="resolved"&&this.el&&(t[0].forArtistID&&t[0].forArtistID==n||!t[0].forArtistID)&&this.fetchTemplate("taco").always(_.bind(function(e){$("#notifications-container",this.el).prepend(this.renderTemplate(e,{notif:t[0]}))},this))},render:function(){var t=_.chainLoading();return t.push(e.get("user").getNotifications()),t.push(this.fetchTemplate("taco")),t.push(this.fetchTemplate("tacobell").always(t.bind(this.renderNotification,this))),this.renderDfd.promise()},renderNotification:function(t){this.$el.html(this.renderTemplate(t));var n=e.get("user").get("notifications");if(!n||!n.length){this.renderDfd.resolve();return}this.fetchTemplate("taco").always(_.bind(this.onTemplate,this))},onTemplate:function(t){var n=[],r=e.get("user"),i=r.get("notifications"),s=i.getNormalized(e.get("user"),10),o=r.get("artistID"),u;_.each(s,_.bind(function(e){e.btnType&&this.getNotifBtn(e,r),u={notif:e,tacoID:e.id},n.push(this.renderTemplate(t,u))},this)),n.length&&($("#notifications-container",this.el).html(n.join("")),$("#see-more-notifications",this.el).removeClass("hide"),_.defer(function(){if(i.length>4)var e=$(".js-scrollable").tinyscrollbar()})),this.renderDfd.resolve()},getNotifBtn:function(e,t){return e.classes="",e.href="",e.attrib="",e.itemType==="song"&&(e.btnType==="comment"?(e.classes+=" comment-link header-notification-link song-link",e.attrib=' data-comment-id="'+e.commentID+'" data-subpage="comment/'+e.commentID+'" data-song-id="'+e.itemID+'"'):e.attrib=' data-stream-type="TYPE_ACTIVITY, TYPE_SHARE"'),e.btnType==="comment"&&(e.classes+=" reply",e.itemType!="song"&&e.itemType!="update"?e.href=e.link:e.itemType==="update"&&(e.href=e.itemUrl)),e.btnType==="play"&&(e.classes+=" play play-or-add",e.attrib+=" data-"+e.itemType+'-id="'+e.itemID+'"',e.itemType==="artist"?e.classes+=" play-top-songs":e.itemType==="playlist"&&(e.classes+=" play-playlist")),e.btnType==="plus"&&(e.classes+=" favorite favorite-page",e.attrib+=" data-"+e.itemType+'-id="'+e.itemID+'"',t.get("favoriteUsers").get(e.itemID)?(e.classes+=" btn-success",e.attrib+=' data-selected="true"'):e.attrib+=' data-selected="false"'),e.btnType==="edit"&&(e.classes+=" edit",e.itemType==="artist-approved"&&(e.href=n.Models.Artist.getArtistUrl(e.itemID))),e}})}(),function(){function t(e){return function(){try{return store[e].apply(store,arguments)}catch(t){}}}n.Services=n.Services||{};if(!e.store)throw"store.js didn't load!";var r;n.Services.Local={init:function(e){r=e,r.on("change:user",onUserChange,this),n.Services.SWF.ready.then(_.bind(this.onUserChange,this))},onUserChange:function(){if(!n.Services.SWF.ready.state()=="resolved")return}};for(var i in e.store)store.hasOwnProperty(i)&&_.isFunction(store[i])&&(n.Services.Local[i]=t(i))}(),function(){function i(){this.requests=[],this.pendingRequest=null}function s(e,t){return e[e.length-1]===t?{}:e[e.length-1]}function u(t){var r=[].slice.call(arguments,1),i=(new Date).valueOf(),s=new this;this.apply(s,r);if(s.options.uncache)return s.send=o,delete s.pendingCallCache[a],s;var u=6e5;if(t){typeof t=="number"&&(u=t);var a=s.getCacheKey(),f=s.pendingCallCache[a];if(_.defined(f)&&(f.state()=="pending"||i-f.lastResolution<u))s=f;else{s.pendingCallCache[a]=s;var l=function(){s.pendingCallCache[a]===s&&delete s.pendingCallCache[a]};setTimeout(l,u+Math.floor(Math.random()*5e3))}}if(s.options.canPreload){var c=s.method;_.each(s.parameters,function(e,t){if(_.isString(e)||_.isNumber(e))c+=":"+e});var h=function(t,r,i){if(typeof e[t]=="object"&&e[t][c])s.resolve(e[t][c]),delete e[t][c];else if(typeof e[t]=="undefined"){var o=s.send,u=null;s.send=function(){return u=_.toArray(arguments)||[],s.promise()},n.on(r,function(e){e[c]?(s.resolve(e[c]),delete e[c]):u&&o.apply(s,u),s.send=o}),setTimeout(function(){typeof e[t]=="undefined"&&(e[t]={},n.trigger(r,{}))},i)}};s.method==="getCommunicationToken"?(c=s.method,h("tokenData","tokenData",3e3)):h("preloadedData","preloadedData",1e4)}return s}function a(e,t,n,r,i){function o(e){s.isPending=!1,s.aborted||(s.lastResolution=(new Date).valueOf())}this.method=_.orEqual(e,""),this.parameters=_.orEqual(t,{}),this.options=_.orEqual(n,{}),this.useHTTPS=_.orEqual(r,!1),this.useSWF=_.orEqual(i,!1),this.overrideHeaders={},this.type="normal",this.failedAuth=!1,this.isPending=!1,this.numRetries=0,this.lastFault=null,this.lastResolution=0,this.successFilters=[],this.faultFilters=[],this._dfd=$.Deferred();var s=this;this._dfd.abort=function(){if(s.ajaxRequest&&s.state()==="pending")return s.abort=!0,s.ajaxRequest.abort()},this._dfd.always(o)}function f(){return u.apply(a,arguments)}function l(e,t,n){a.call(this,e,t),this.httpMethod=_.orEqual(n,"POST"),this.type="facebook"}function c(e){a.call(this,null,e),this.type="lastfm"}function h(e,t,n){a.call(this,null,t),this.httpMethod=_.orEqual(n,"POST"),this.type="flattr",this.method=e}function p(){var e=String(Math.floor(Math.random()*1e4));return tt[e]?p():e}function d(e,t){var n;_.isFunction(nt)?(n=p(),tt[n]=e,nt(e.getSWFable(),t,n)):(e.isPending=!1,et.push(e))}function v(e){e||(e=1);var t="";for(var n=0;n<6;n++)t+=Math.floor(Math.random()*16).toString(16);return t!=U||e>4?t:v(++e)}function m(e){e=_.orEqual(e,{});var t={client:K,clientRevision:Q,privacy:n.Services.API.privacy,country:n.Services.API.country,uuid:Y};return n.Services.API.sessionID&&(t.session=n.Services.API.sessionID),n.Services.API.collectStats&&(t.collectStats=n.Services.API.collectStats),$.extend(t,e)}function g(e,t){_.defined(e)||(e={fault:{message:"Empty Result",code:V.EMPTY_RESULT}}),e.header&&b(e.header,t),e.fault?w(e.fault,t):t.resolve(e.hasOwnProperty("result")?e.result:e)}function y(){n.trigger("lightbox:open",{_type:"invalidClient",notCloseable:!0,view:{header:"LB_INVALID_CLIENT_TITLE",message:"LB_INVALID_CLIENT_MSG",buttonsRight:[{label:"LB_REFRESH_GROOVESHARK",className:"btn-primary submit"}]},callbacks:{".submit":function(t){e.location.reload(!0)}}})}function b(e,t){var r=e.session;r&&r!=n.Services.API.sessionID&&(n.Services.API.sessionID=r,q=!1,x(!0)),e.expiredClient&&(X=!0,n.player&&n.player.expireSWFService(),y());var i=e.secondsUntilDowntime;if(i<0)_.delay(k,5e3);else if(i>0){var s=Math.floor(i/60),o=(new Date).valueOf();s<=60&&(W===0||s>30&&o-W>36e5||s<=30&&s>15&&o-W>18e5||s<=15&&s>10&&o-W>9e5||s<=10&&s>5&&o-W>6e5||s<=5&&o-W>3e5)&&(W=o,n.trigger("notification:add",{description:_.getString("DATABASE_GOING_DOWN",{duration:s}),type:"error",duration:s*60*1e3}))}if(e.stats&&t.options.logStats!==!1){var u=(+(new Date)-t.startTime)/1e3,a=_.extend({methodName:t.method,requestTime:u},e.stats);n.trigger("api:stats",a)}}function w(t,r){if(t&&_.defined(t.code)){t.aborted||console.log("HANDLE FAULT CODE",t.code,r.method);if(t.code==V.INVALID_TOKEN){var i=(new Date).valueOf();if((!R||i-R>=3e5)&&r.numRetries===0){R=!1,r.isPending=!1,r.numRetries++,Z.push(r),x(!0);return}n.trigger("notification:add",{description:_.getString("SERVICE_ERROR_COMMUNICATING"),type:"error",duration:6e4})}else{if(t.code==V.HTTP_TIMEOUT||t.code==V.EMPTY_RESULT){r.lastFault=t,r.retry(100+r.numRetries*100);return}t.code==V.MAINTENANCE?_.delay(k,5e3):t.code==V.INVALID_CLIENT?y():t.code==V.INVALID_SESSION?n.trigger("lightbox:open",{_type:"sessionBad",_canClose:!1,view:{header:"POPUP_SESSION_BAD_TITLE",message:"POPUP_SESSION_BAD_MSG",buttonsLeft:[{label:"LB_REFRESH_GROOVESHARK",className:"submit"}]},callbacks:{".submit":function(t){e.location.reload(!0)}}}):gsConfig.runMode=="dev"&&t.code==V.HTTP_ERROR&&r.method=="getCommunicationToken"&&(e.gsConfig.httpsFix=!0,e.location="https://"+e.location.host+e.location.hash)}}r.reject(t)}function E(e,t){var n=tt[t];n&&g(e,n),delete tt[t]}function S(e,t){var n=tt[t];n&&w(e,n),delete tt[t]}function x(e){if(q)return;var t,r=(new Date).valueOf();if(e!==!0&&r-F<5e3){N(j);return}T(),q=!0;if(n.Services.API.sessionID){var i=hex_md5(n.Services.API.sessionID);t=f(!1,"getCommunicationToken",{secretKey:i},{canPreload:!0},!0,!1),t.promise().then(N,function(e){C(e,t)})}else q=!1;t&&t.send()}function T(){j=null,I=0,F=0}function N(e){var t=new Date;R=!1,j=e,q=!1,F=t.valueOf(),I=15e5+t.valueOf(),n.Services.SWF&&n.Services.SWF.ready.done(function(){n.Services.SWF.setCommunicationToken(e)});var r;while(Z.length)r=Z.shift(),r.send();n.dispatcher.trigger("api:ready")}function C(e,t){var n=new Date;q=!1,R=n.valueOf();var r;while(Z.length)r=Z.shift(),r.reject({message:$.localize.getString("SERVICE_CREATE_TOKEN_FAIL"),code:V.INVALID_TOKEN})}function k(){z||(z=!0,n.dispatcher.trigger("lightbox:open",{type:"maintenance",_canClose:!1,view:{header:"POPUP_MAINT_TITLE",message:"POPUP_MAINT_MESSAGE",buttonsLeft:[{label:"POPUP_MAINT_TWITTER",href:"http://twitter.com/sharkjanitor"}]}}),A())}function L(){z=!1,n.Views.Lightbox.close("maintenance")}function A(){var e=f(!1,"getServiceStatus");e.promise().then(O,M),e.send()}function O(e,t){e.status==1?L():_.delay(A,2e4)}function M(e,t){_.delay(A,2e4)}function D(e){nt=n.Services.SWF.swfProxy,n.Services.SWF.swfServiceSuccess=E,n.Services.SWF.swfServiceFault=S;var t;while(et.length)t=et.shift(),t.send()}function P(e){return _.map(e,function(e){return e.hasOwnProperty("AlbumID")&&delete e.AlbumID,e.hasOwnProperty("AlbumName")&&delete e.AlbumName,e.hasOwnProperty("SongName")&&delete e.SongName,e.hasOwnProperty("Flags")&&delete e.Flags,e})}function H(){if(e.parentSandboxBridge)return!1;var t=new XMLHttpRequest;return"withCredentials"in t?(gsConfig.runMode==="staging"&&$.ajaxSetup({xhrFields:{withCredentials:!0}}),!0):(typeof XDomainRequest!="undefined",!1)}n.Services=n.Services||{};var r="frenchFriedDogs";i.prototype.queue=function(e){function t(){if(this.requests.length){this.pendingRequest=this.requests.shift();var e=this;this.pendingRequest.promise().always(function(){e.pendingRequest=null,t.call(e)}),this.pendingRequest.send()}}this.requests.push(e),this.pendingRequest||t.call(this)};var o=function(){return this._dfd.reject(),this.promise()};a.createRequest=function(){return u.apply(this,arguments)},a.prototype=$.extend(a.prototype,{promise:function(){var e=this._dfd.promise();return e.abort=this._dfd.abort,e},state:function(){return this._dfd.state()},resolve:function(e){for(var t=0;t<this.successFilters.length;t++)_.isFunction(this.successFilters[t])&&(e=this.successFilters[t](e));this.lastResolution=(new Date).valueOf(),this._dfd.resolve(e)},resolveWith:function(e,t){for(var n=0;n<this.successFilters.length;n++)_.isFunction(this.successFilters[n])&&(t=this.successFilters[n](t));this.lastResolution=(new Date).valueOf(),this._dfd.resolveWith(e,t)},reject:function(e){for(var t=0;t<this.faultFilters.length;t++)_.isFunction(this.faultFilters[t])&&(e=this.faultFilters[t](e));this._dfd.reject(e)},rejectWith:function(e,t){for(var n=0;n<this.faultFilters.length;n++)_.isFunction(this.faultFilters[n])&&(t=this.faultFilters[n](t));this._dfd.rejectWith(e,t)},getSWFable:function(){return{type:this.type,method:this.method,parameters:this.parameters,useHTTPS:this.useHTTPS,overrideHeaders:this.overrideHeaders,overrideKey:r}},pendingCallCache:{},cacheKeyProps:["method","parameters","type"],getCacheKey:function(){var e,t,n="";for(e in this.cacheKeyProps)this.cacheKeyProps.hasOwnProperty(e)&&(t=this[this.cacheKeyProps[e]],t instanceof String?n+=t:n+=$.stringify(t));return hex_md5(n)},send:function(e){e&&e.length==2&&this.promise().then(e[0],e[1]);var i=this,s=!0,o=(new Date).valueOf();if(this.isPending||this.state()=="resolved")return this.promise();if(X)return this.reject({message:$.localize.getString("POPUP_INVALID_CLIENT_MSG"),code:V.INVALID_CLIENT}),this.promise();this.isPending=!0;if(this.numRetries>=3)return this.reject(this.lastFault),this.promise();this.numRetries>0&&(s=!1);if(this.type=="facebook"||this.type=="lastfm"||this.type=="flattr")return d(this,{}),this.promise();if(I>o||_.indexOf(["getCommunicationToken","initiateSession","getServiceStatus"],this.method)!=-1){if(z&&this.method!="getServiceStatus")return this.reject({message:$.localize.getString("SERVICE_DOWN_MAINTENANCE"),code:V.MAINTENANCE}),this.promise();var u="http://"+J+"/"+G+"?"+this.method,a={header:m(this.overrideHeaders),method:this.method,parameters:this.parameters};if(j){U=v();var f=hex_sha1([this.method,j,r,U].join(":"));a.header.token=U+f}this.startTime=+(new Date),n.Services.API.lastRequestTime=this.startTime;if((this.useSWF||this.useHTTPS&&!n.Services.API.useCORS)&&typeof gsConfig.neverUseSWF=="undefined")return d(this,a.header),this.promise();if(this.useHTTPS||gsConfig.forceHTTPS)u=u.replace("http:","https:");this.ajaxRequest=$.ajax($.extend({},this.options,{contentType:"text/plain",dataType:"json",type:"POST",data:$.stringify(a),cache:s,url:u,success:function(e,t,n){g(e,i)},error:function(e,t,n){var r;try{r=(e.responseText||"").substr(0,150)}catch(s){}console.warn("ajax error: "+n+" ("+t+")",r,e,this);var o={};switch(t){case"parsererror":o.code=V.PARSE_ERROR,o.message=$.localize.getString("SERVICE_PARSE_JSON");break;case"timeout":o.code=V.HTTP_TIMEOUT,o.message=$.localize.getString("SERVICE_REQUEST_TIMEOUT");break;case"error":case"notmodified":default:o.code=V.HTTP_ERROR,o.message=$.localize.getString("SERVICE_HTTP_ERROR")}t=="abort"&&(i.abort=!0,o.aborted=!0),w(o,i)}}))}else this.isPending=!1,Z.push(this),x();return this.promise()},retry:function(e){this.isPending=!1,this.numRetries++,_.delay(_.bind(this.send,this),e)},queue:function(e){_.defined(a.prototype.queues)||(a.prototype.queues={});var t=a.prototype.queues[e];return _.defined(t)||(t=a.prototype.queues[e]=new i),t.queue(this),this.promise()}}),l.createRequest=function(){return u.apply(this,arguments)},l.prototype=$.extend(l.prototype,a.prototype,{getSWFable:function(){return{type:this.type,method:this.method,parameters:this.parameters,httpMethod:this.httpMethod}}}),c.createRequest=function(){return u.apply(this,arguments)},c.prototype=$.extend(c.prototype,a.prototype,{getSWFable:function(){return{type:this.type,parameters:this.parameters}}}),h.createRequest=function(){return u.apply(this,arguments)},h.prototype=$.extend(h.prototype,a.prototype,{getSWFable:function(){return{type:this.type,method:this.method,parameters:this.parameters,httpMethod:this.httpMethod}}});var B="nuggetsOfBaller",j=null,F=0,I=0,q=!1,R=!1,U=null,z=!1,W=0,X=!1,V={INVALID_CLIENT:1024,RATE_LIMITED:512,INVALID_TOKEN:256,INVALID_SESSION:16,MAINTENANCE:10,MUST_BE_LOGGED_IN:8,HTTP_TIMEOUT:6,PARSE_ERROR:4,HTTP_ERROR:2,EMPTY_RESULT:-256},J=e.location.host,K="htmlshark",Q="20130520",G="more.php",Y="",Z=[],et=[],tt={},nt=null;n.Services.API={sessionID:null,sessionPart:null,collectStats:null,country:null,privacy:0,lastRequestTime:0,useCORS:!1,init:function(e){this.sessionID=e.sessionID,this.sessionPart=hex_md5(e.sessionID).substr(0,6),this.country=e.country,this.privacy=e.user.Privacy,this.useCORS=H(),Y=e.uuid,G=_.orEqual(G,e.defaultEndpoint),typeof e.neverUseSWF=="undefined"&&n.Services.SWF&&n.Services.SWF.ready.then(D),n.on("swf:tokenRequired",x),this.sessionID||console.error("No SessionID! Reload!"),r=B},httpsFormSubmit:function(t,r,i){var s=$("#https-form"),o=$("#https-iframe"),u=[];s.html(""),s.attr("action",t),s.attr("method","post"),s.attr("target","https-iframe"),s.attr("enctype","multipart/form-data"),_.forEach(r,function(e,t){u.push('<input type="hidden" name="'+t+'" value="'+e+'" />')}),s.append(u.join("")),n.airbridge&&n.airbridge.isDesktop?e.setupBridge=function(){var t={};t[i]=e[i],document.getElementById("https-iframe").contentWindow.parentSandboxBridge=t}:e.setupBridge=function(){},s.submit()},newTokenSuccess:N,isFirstVisit:function(){var e=f(!1,"isFirstVisit",{},{},!1,!0);return e.send()},makeFacebookRequest:function(e,t,n,r,i){var s=l.createRequest(!1,e,t,n);s.send([r,i])},makeLastfmRequest:function(e,t,n){var r=c.createRequest(!1,e);r.send([t,n])},makeFlattrRequest:function(e,t,n){var r=h.createRequest(!1,e,t,n);return r.send()},rapleafPersonalize:function(e,t,n){var r=s(arguments,n),i=f(!1,"personalize",{redirectURL:e},r,!1,!0);i.type="rapleaf",i.send([t,n])},rapleafDirect:function(e,t,n){var r=s(arguments,n),i=f(!1,"direct",{email:e},r,!1,!0);i.type="rapleaf",i.send([t,n])},getAlbumByID:function(e){var t=f(!1,"getAlbumByID",{albumID:e},{canPreload:!0});return t.send()},getArtistByID:function(e){var t=f(!1,"getArtistByID",{artistID:e},{canPreload:!0});return t.send()},getPlaylistByID:function(e){var t=f(!1,"getPlaylistByID",{playlistID:e});return t.send()},getQueueSongListFromSongIDs:function(e){var t=f(!0,"getQueueSongListFromSongIDs",{songIDs:e});return t.send()},getSongFromToken:function(e){var t=f(!0,"getSongFromToken",{token:e,country:this.country});return t.send()},getTokenForSong:function(e,t,n){var r=s(arguments,n),i=f(!0,"getTokenForSong",{songID:e,country:this.country},r);return i.send([t,n])},getUserByID:function(e){var t=f(3e5,"getUserByID",{userID:e});return t.send()},getProfileInfoByID:function(e,t,n,r){var i=f(!1,"getProfileInfoByID",{profileID:e,artistID:t,includeMetadata:n,includePageName:r});return i.send()},albumGetAllSongs:function(e){var t=f(!1,"albumGetAllSongs",{albumID:e},{canPreload:!0});return t.send()},artistGetArtistSongs:function(e,t){var n=f(!1,"artistGetArtistSongs",{artistID:e,limit:t},{canPreload:!0});return n.send()},artistGetArtAttribution:function(e){var t=f(!1,"artistGetArtAttribution",{artistID:e});return t.send()},artistGetAllAlbums:function(e){var t=f(!1,"artistGetAllAlbums",{artistID:e});return t.send()},playlistGetSongs:function(e,t){var n=f(!t,"playlistGetSongs",{playlistID:e});return n.send()},getUserRecentListens:function(e){var t=f(!1,"getUserRecentListens",{userID:e},{canPreload:!0});return t.send()},deleteUserListens:function(e){var t=f(!1,"deleteUserListens",{keys:e});return t.send()},popularGetSongs:function(e){var t={daily:!0,weekly:!0,monthly:!0};t[e]||(e="daily");var n=f(864e5,"popularGetSongs",{type:e},{canPreload:!0});return n.send()},popularGetSongsPreview:function(){var t=this,r=$.Deferred(),i=function(e){var s=e.popularGetSongsPreview;s?r.resolve(s):t.popularGetSongs("daily").done(function(e){e||r.reject(),r.resolve({Songs:_.first(e.Songs,30)})}).fail(function(){r.reject()}),n.off("preloadedData",i)};return e.preloadedData?i(e.preloadedData):n.on("preloadedData",i),r.promise()},featuredGetCurrentFeatured:function(e){var t=f(!0,"featuredGetCurrentFeatured",{date:e},{canPreload:!0});return t.send()},getRecommendedSongs:function(e,t){var n=f(864e5,"getRecommendedSongs",{artistIDs:e,excludeArtistIDs:t},{});return n.send()},artistGetFans:function(e,t){t=_.orEqual(t,0);var n=f(!1,"artistGetFans",{artistID:e,offset:t});return n.send()},playlistGetFans:function(e){var t=f(!1,"playlistGetFans",{playlistID:e});return t.send()},userGetFollowersEx:function(e){var t=f(!1,"userGetFollowersEx",{userID:e});return t.send()},authenticateUser:function(e,t){var n=f(!1,"authenticateUser",{username:e,password:t},null,!0,!1);return n.send()},authenticateAsAuthorizedUser:function(e){var t=f(!1,"authenticateAsAuthorizedUser",{userID:e},null,!0,!1);return t.send()},authenticateGoogleUser:function(e,t,n){var r=f(!1,"authenticateGoogleUserEx",{googleUID:e,googleEmailAddress:t,accessToken:n},null,!0,!1);return r.send()},authenticateTwitterUser:function(e,t,n){var r=a.createRequest(!1,"authenticateTwitterUser",{twitterUserID:e,oauthToken:t,oauthSecret:n},null,!0,!1);return r.send()},reportUserChange:function(e){var t=e.get("Name"),r=e.get("Picture"),i={userID:e.get("UserID"),email:e.get("Email"),username:t,userTrackingID:e.get("userTrackingID"),picture:r,privacy:e.get("sessionPrivacy"),isPremium:e.get("subscription").isPremium(),visibleToUsers:null,chatInfo:{n:t,p:r},contextArtistID:0};n.Services.API.privacy=i.privacy,(i.privacy&8)>0&&(e.get("favoriteUsers")?i.visibleToUsers=e.get("favoriteUsers").pluck("UserID"):i.visibleToUsers=[]);var s=f(!1,"reportUserChange",i,null,!1,!0);return s.send()},logoutUser:function(){var e=f(!1,"logoutUser");return e.send()},userForgotPassword:function(e){var t=f(!1,"userForgotPassword",{usernameOrEmail:e});return t.send()},resetPassword:function(e,t,n){var r=f(!1,"resetPassword",{usernameOrEmail:e,secretResetCode:t,newPassword:n},null,!0,!1);return r.send()},changePassword:function(e,t,n,r){var i=s(arguments,r),o=f(!1,"changePassword",{oldPassword:e,newPassword:t},i,!0,!1);o.send([n,r])},registerUser:function(e,t,n,r,i,o,u,a,l,c,h,p){var d=s(arguments,p),v=f(!1,"registerUser",{username:e,password:t,firstName:n,lastName:r,emailAddress:i,sex:o,birthDate:u,flags:a,inviteID:l,savePassword:c},d,!0,!1);v.send([h,p])},userDisableAccount:function(e,t,n,r){var i=f(!1,"userDisableAccount",{password:e,reason:t,details:n,contact:r},{},!0,!0);return i.send()},getIsUsernameEmailAvailable:function(e,t,n,r){var i=s(arguments,r),o=f(!1,"getIsUsernameEmailAvailable",{username:e,emailAddress:t},i);o.send([n,r])},sendInvites:function(e){var t=f(!1,"sendInvites",{emailAddresses:e});return t.send()},getUserTopArtists:function(e){var t=f(!1,"getUserTopArtists",{userID:e});return t.send()},changeUserInfoEx:function(e,t,n,r,i,o){var u=s(arguments,o),a=f(!1,"changeUserInfoEx",{shitToChange:e,password:t,thirdPartyLogin:n,oldShit:r},u,!0,!1);a.send([i,o])},updateUserProfileURLs:function(e){var t=f(!1,"updateUserProfileURLs",{urls:e});return t.send()},changeNotificationSettings:function(e,t,n){var r=f(!1,"changeNotificationSettings",{newValue:e});return r.send()},changePrivacySettings:function(e){var t=f(!1,"changePrivacySettings",{newValue:e});return t.send()},getSubscriptionDetails:function(){var e=f(!1,"getSubscriptionDetails",{},null,!0,!1);return e.send()},userGetSongsInLibrary:function(e,t,n){t=_.orEqual(t,0),n=_.orEqual(n,!0);var r=f(n,"userGetSongsInLibrary",{userID:e,page:t});return r.send()},userGetLibraryTSModified:function(e){var t=f(!1,"userGetLibraryTSModified",{userID:e},{canPreload:!0});return t.send()},userAddSongsToLibrary:function(e){var t=f(!1,"userAddSongsToLibrary",{songs:e});return t.queue("library")},userRemoveSongsFromLibrary:function(e,t,n,r){var i=f(!1,"userRemoveSongsFromLibrary",{userID:e,songIDs:t,albumIDs:n,artistIDs:r});return i.queue("library")},getFavorites:function(e,t){t=_.orEqual(t,"Songs");var n={};t=="Songs"&&(n.canPreload=!0);var r=f(!1,"getFavorites",{userID:e,ofWhat:t},n);return r.send()},getSubscribedPlaylistsBroadcasts:function(){var e=f(!1,"getSubscribedPlaylistsBroadcasts",{});return e.send()},userGetFavoriteSongsSongIDs:function(){var e=f(!1,"userGetFavoriteSongsSongIDs",{},{canPreload:!0});return e.send()},userGetSongIDsInLibrary:function(){var e=f(!1,"userGetSongIDsInLibrary",{});return e.send()},favorite:function(e,t,n,r,i){var s=f(!1,"favorite",{what:e,ID:t,details:n});return s.queue("library")},unfavorite:function(e,t){var n=f(!1,"unfavorite",{what:e,ID:t});return n.queue("library")},favoriteBroadcast:function(e,t,n,r){var i=f(!1,"favoriteBroadcast",{broadcastID:e,broadcastName:t,ownerUserID:n,ownerArtistID:r});return i.send()},unfavoriteBroadcast:function(e){var t=f(!1,"unfavoriteBroadcast",{broadcastID:e});return t.send()},getFavoriteBroadcasts:function(e){var t=f(!1,"getFavoriteBroadcasts",{userID:e});return t.send()},userGetPlaylists:function(e,t){var n={userID:e};t&&(n.limit=t);var r=f(!1,"userGetPlaylists",n,{canPreload:!0});return r.send()},createPlaylist:function(e,t,n){var r=f(!1,"createPlaylistEx",{playlistName:e,songIDs:t,playlistAbout:n});return r.send()},deletePlaylist:function(e,t){var n=f(!1,"deletePlaylist",{playlistID:e,name:t});return n.queue("playlist")},playlistUndelete:function(e){var t=f(!1,"playlistUndelete",{playlistID:e});return t.queue("playlist")},overwritePlaylist:function(e,t,n,r){var i=f(!1,"overwritePlaylistEx",{playlistID:e,playlistName:t,songIDs:n,songs:r});return i.queue("playlist")},playlistAddSongToExisting:function(e,t,n){var r=f(!1,"playlistAddSongToExistingEx",{playlistID:e,songID:t,song:n});return r.queue("playlist")},renamePlaylist:function(e,t,n){var r=f(!1,"renamePlaylist",{playlistID:e,playlistName:t,broadcast:n});return r.queue("playlist")},setPlaylistAbout:function(e,t,n){var r=f(!1,"setPlaylistAbout",{playlistID:e,about:t,broadcast:n});return r.queue("playlist")},tagRadioGetAllSongs:function(e){var t=f(!1,"tagRadioGetAllSongs",{tagID:e});return t.send()},getResultsFromSearch:function(e,t,r){var i=f(!0,"getResultsFromSearch",{query:e,type:t,guts:n.guts?n.getGuts().shouldLog:0,ppOverride:r});return t==="Artists"?i.successFilters.push(function(e){return $.isArray(e.result)&&(e.result=P(e.result)),e}):$.isArray(t)&&i.successFilters.push(function(e){return e.result.Artists&&$.isArray(e.result.Artists)&&(e.result.Artists=P(e.result.Artists)),e}),i.send()},getAutocompleteEx:function(e,t){var n=f(!0,"getAutocompleteEx",{query:e,type:t});return n.send()},getGoogleSuggest:function(t){t=$.trim(t);var n=new $.Deferred,r="http://google.com/complete/search?output=json&q="+t+" lyrics&client=serp";return e.google||(e.google={}),e.google.ac||(e.google.ac={}),e.google.ac.h=function(e){var r=!1;if(e[1].length>0){e=e[1],r=e[0][0],r=r.replace(/<[^>]+>/ig,""),r=r.substring(0,r.lastIndexOf("lyrics")),r=$.trim(r);var i=document.createElement("div");i.innerHTML=r,r=i.innerText||i.text||i.textContent}r&&r.toLowerCase()!==t.toLowerCase()?n.resolve(r):n.reject()},$.ajax({url:r,dataType:"jsonp",jsonp:!1,jsonpCallback:"window.google.ac.h",success:function(e,t,n){},error:function(e,t,r){_.delay(function(){n.state()=="pending"&&n.reject()},100)}}),n.promise()},getProfileFeedForItem:function(e,t,n){var r=f(!1,"getProfileFeedForItem",{itemID:e,item:t,lastTS:n},{canPreload:!0});return r.send()},getUserCombinedFeedEx:function(e,t,n){var r=f(!1,"getUserCombinedFeedEx",{userID:e,excludeUsers:t,lastTS:n},{canPreload:!0});return r.send()},getFeedEventByID:function(e){var t=f(!1,"getFeedEventByID",{eventID:e});return t.send()},getArtistFeedEventByID:function(e){var t=f(!1,"getArtistFeedEventByID",{eventID:e});return t.send()},getInterestingEvents:function(e){var t=f(3e4,"getInterestingEvents",{limit:e},{canPreload:!0});return t.send()},hideUserEvent:function(e,t){var n=f(!1,"hideUserEvent",{eventID:e,removeEvent:t});return n.send()},hideArtistEvent:function(e,t){var n=f(!1,"hideArtistEvent",{eventID:t,artistID:e});return n.send()},changeFollowFlagsEx:function(e){var t=f(!1,"changeFollowFlagsEx",{userIDsFlags:e},{});return t.send()},sendFeedBroadcast:function(e,t,n,r,i){var s=f(!1,"sendFeedBroadcast",{what:e,ID:t,people:n,message:r,messageParts:i});return s.send()},addEventComment:function(e,t,n){var r=f(!1,"addEventComment",{eventID:e,comment:t,eventOwnerName:n});return r.send()},hideEventComment:function(e,t){var n=f(!1,"hideEventComment",{eventID:e,commentID:t});return n.send()},addArtistFeedComment:function(e,t,n,r){var i=f(!1,"addArtistFeedComment",{eventID:e,comment:t,aboutArtistID:r});return i.send()},hideArtistFeedComment:function(e,t){var n=f(!1,"hideArtistFeedComment",{eventID:e,commentID:t});return n.send()},getUserNotifications:function(e){var t=f(!1,"getUserNotifications",{limit:e});return t.send()},logTargetedThemeImpression:function(e){var t=f(!1,"logTargetedThemeImpression",{themeID:e});return t.send()},logThemeOutboundLinkClick:function(e,t){var n=f(!1,"logThemeOutboundLinkClick",{themeID:e,linkID:t});return n.send()},logThemeCounter:function(e,t){var n=f(!1,"logThemeCounter",{name:e,amount:t});return n.send()},getSongkickEventsFromArtists:function(e,t){var n=f(!0,"getSongkickEventsFromArtists",{artistIDs:e,names:t});return n.send()},broadcastSong:function(e,t,n,r,i,o,u,a,l){var c=s(arguments,l),h=f(!1,"broadcastSong",{songID:e,message:t,username:n,password:r,saveCredentials:i,service:o,song:u},c,!0,!1);h.send([a,l])},getUserGoogleAccessToken:function(){var e=f(!1,"getUserGoogleAccessToken",{},null,!0,!1);return e.send()},saveUserGoogleData:function(e,t,n){var r=f(!1,"saveUserGoogleDataEx",{googleUID:e,googleEmailAddress:t,flags:n},null,!0,!1);return r.send()},updateUserGoogleData:function(e,t,n){var r=f(!1,"updateUserGoogleDataEx",{googleUID:e,googleEmailAddress:t,flags:n},null,!0,!1);return r.send()},removeUserGoogleData:function(e,t,n,r){var i=s(arguments,r),o=f(!1,"removeUserGoogleData",{googleUID:e,googleEmailAddress:t},i);o.send([n,r])},saveUserTwitterData:function(e,t,n,r,i){var s=a.createRequest(!1,"saveUserTwitterData",{twitterUserID:e,oauthToken:t,oauthSecret:n},null,!0,!1);return s.send()},updateUserTwitterData:function(e,t,n){var r=a.createRequest(!1,"updateUserTwitterData",{twitterUserID:e,oauthToken:t,oauthSecret:n},null,!0,!1);return r.send()},removeUserTwitterData:function(e,t,n){var r=arguments[arguments.length-1]===n?{}:arguments[arguments.length-1],i=a.createRequest(!1,"removeUserTwitterData",{twitterUserID:e},r);i.send([t,n])},postTwitterStatus:function(e,t,n,r,i){var s=a.createRequest(!1,"postTwitterStatus",{message:e,oauthToken:t,oauthSecret:n},null);return s.send()},getUsernameSuggestions:function(e,t,n){var r=f(!0,"getUsernameSuggestions",{baseUsername:e,fullName:t,idOrRand:n},null);return r.send()},registerGoogleUser:function(e,t,n,r,i,o,u,a,l,c,h,p,d){var v=s(arguments,d),m=f(!1,"registerGoogleUserEx",{googleUID:a,googleEmailAddress:l,accessToken:c,googleFlags:h,username:e,firstName:t,emailAddress:n,sex:r,birthDate:i,flags:o,inviteID:u},v,!0,!1);m.send([p,d])},registerTwitterUser:function(e,t,n,r,i,s,o,u,f,l,c,h){var p=arguments[arguments.length-1]===h?{}:arguments[arguments.length-1],d=a.createRequest(!1,"registerTwitterUser",{username:e,firstName:t,emailAddress:n,sex:r,birthDate:i,flags:s,inviteID:o,twitterUserID:u,oauthToken:f,oauthSecret:l},p,!0,!1);d.send([c,h])},updateLastfmService:function(e,t,n,r,i,o,u){var a=s(arguments,u),l=f(!1,"updateLastfmService",{session:e,token:t,username:n,flagsAdd:r,flagsRemove:i},a);l.send([o,u])},saveLastfmService:function(e,t,n,r,i,o){var u=s(arguments,o),a=f(!1,"saveLastfmService",{session:e,token:t,username:n,flags:r},u);a.send([i,o])},removeLastfmService:function(e,t,n){var r=s(arguments,n),i=f(!1,"removeLastfmService",{lastfmUsername:e},r);i.send([t,n])},saveUserFlattrData:function(e,t,n){var r=a.createRequest(!1,"saveUserFlattrData",{flattrUsername:t,accessToken:e,flags:n},null,!0,!1);return r.send()},updateUserFlattrData:function(e,t,n){var r=a.createRequest(!1,"updateUserFlattrData",{flattrUsername:t,accessToken:e,flags:n},null,!0,!1);return r.send()},removeUserFlattrData:function(){var e=a.createRequest(!1,"removeUserFlattrData",{});return e.send()},userGetExtraData:function(){var e=f(!1,"userGetExtraData",{},null,!0,!1);return e.send()},userGetRecommendedUsers:function(){var e=a.createRequest(!1,"userGetRecommendedUsers",{});return e.send()},userHideRecommendedUser:function(e){var t=a.createRequest(!1,"userHideRecommendedUser",{recommendedUserID:e});return t.send()},provideVIPFeedback:function(e,t,n){var r=f(!1,"provideVIPFeedback",{fromAddress:e,message:t,type:n});return r.send()},artistGetSimilarArtists:function(e){var t=f(!1,"artistGetSimilarArtists",{artistID:e});return t.send()},getThemeFromDFP:function(e,t){var n=f(!1,"getThemeFromDFP",{unitString:e,paramString:t},{},!1,!0);return n.type="dfp",n.send()},getNotificationFromDFP:function(e,t,n){var r=s(arguments,n),i=f(!1,"getNotificationFromDFP",{paramString:e},r,!1,!0);i.type="dfp",i.send([t,n])},getItemByPageName:function(e){var t=f(!1,"getItemByPageName",{name:e});return t.send()},getPageInfoByIDType:function(t,r,i,s){t===n.getLoggedInUserID()&&r==="user"&&(s||(s={}),s.canPreload=!0);var o=f(!i,"getPageInfoByIDType",{id:t,type:r},s||{});return o.promise().done(function(i){i.Name&&e.GS&&n.router&&n.router.cachePageName(i.Name,r,t)}),o.send()},getPageInfoByIDsType:function(t,r){var i=s(arguments,r),o=f(!0,"getPageInfoByIDsType",{ids:t,type:r},i);return o.promise().done(function(t){if(!t||!t.length)return;for(var i=0,s=t.length;i<s;i++)t[i].Name&&e.GS&&n.router&&n.router.cachePageName(t[i].Name,r,t[i].ItemID)}),o.send()},getPageMetaInfoByIDsType:function(t,r){var i=s(arguments,r),o=f(!0,"getPageMetaInfoByIDsType",{ids:t,type:r},i);return o.promise().done(function(t){if(!t||!t.length)return;for(var i=0,s=t.length;i<s;i++)t[i].Name&&e.GS&&n.router&&n.router.cachePageName(t[i].Name,r,t[i].ItemID)}),o.send()},getTopLevelTags:function(){var e=f(!0,"getTopLevelTags",{},{});return e.send()},getTagList:function(){var e=f(!0,"getTagList",{},{});return e.send()},getTagsSampleSongs:function(e){var t=f(!0,"getTagsSampleSongs",{tagIDs:e},{});return t.send()},userGetPoints:function(){var e=f(!1,"userGetPoints",{},{});return e.send()},redeemPointsForAnywhere:function(){var e=f(!1,"redeemPointsForAnywhere",{},{});return e.send()},sendAdvertisingEmail:function(e){var t=f(!1,"sendAdvertisingEmail",{contents:e});return t.send()},logPerformanceTracking:function(e){var t=f(!1,"logPerformanceTracking",{stats:e},{logStats:!1});return t.send()},getBroadcast:function(e){var t=f(!1,"getBroadcast",{broadcastID:e});return t.send()},getUserBroadcasts:function(e,t){var n=f(!1,"getUserBroadcasts",{userID:e,page:t});return n.send()},getUserLastBroadcast:function(){var e=f(!1,"getUserLastBroadcast",{});return e.send()},broadcastUpdateExtraData:function(e,t,n,r,i,s,o){var u=f(!1,"broadcastUpdateExtraData",{broadcastID:e,name:t,tag:n,description:r,image:i,privacy:s,asArtistID:o});return u.send()},deleteBroadcast:function(e,t){var n=f(!1,"deleteBroadcast",{broadcastID:e,asArtistID:t});return n.send()},undeleteBroadcast:function(e,t){var n=f(!1,"undeleteBroadcast",{broadcastID:e,asArtistID:t});return n.send()},getTopBroadcasts:function(e){var t=f(3e4,"getTopBroadcasts",{manateeTags:e});return t.send()},getTopBroadcastsCombinedEx:function(e){var t=f(3e4,"getTopBroadcastsCombinedEx",{withStagingEvents:e});return t.send()},getLeaderboardBroadcasters:function(e,t,n){var r=f(6e4,"getLeaderboardBroadcasters",{date:e,tagID:t,unit:n});return r.send()},notifyBroadcasterFollowers:function(e,t){var n=f(!1,"notifyBroadcasterFollowers",{broadcastID:e,context:t});return n.send()},submitUserInfoForCampaign:function(e,t){var n=f(!1,"submitUserInfoForCampaign",{campaignID:e,campaignData:t});return n.send()},suggestFlattr:function(e,t){var n=f(!1,"suggestFlattr",{urls:e,delay:t},options,!1,!0);return n.send()},userGetArtistsOwned:function(){var e=f(!1,"userGetArtistsOwned",null,null);return e.send()},artistUpdateProfileEx:function(e,t,n){var r=f(!1,"artistUpdateProfileEx",{artistID:e,profile:t,previousProfile:n});return r.send()},artistUpdatePageName:function(e,t){var n=f(!1,"artistUpdatePageName",{artistID:e,newPageName:t});return n.send()},artistRequestPageNameTakeover:function(e,t){var n=f(!1,"artistRequestPageNameTakeover",{artistID:e,newPageName:t});return n.send()},artistEditAlbum:function(e,t){var n=f(!1,"artistEditAlbum",{album:e,previousAlbum:t});return n.send()},artistEditSongs:function(e,t){var n=f(!1,"artistEditSongs",{songs:e,previousSongs:t});return n.send()},artistDisownSongs:function(e,t,n){var r=f(!1,"artistDisownSongs",{songIDs:e,albumIDs:t,artistID:n});return r.send()},artistDeleteSongs:function(e,t,n){var r=f(!1,"artistDeleteSongs",{songIDs:e,artistID:n,albumIDs:t});return r.send()},artistCreateAlbum:function(e){var t=f(!1,"artistCreateAlbum",{album:e});return t.send()},sendArtistFansUpdate:function(e,t,r,i){var s=f(!1,"sendArtistFansUpdate",{artistID:e,message:t,item:r,type:i}),o={};return o.artistID=e,i&&i.length&&(o.itemType=i),t&&t.length&&(o.messageLength=t.length),i==="artist"?o.itemID=r.artistID:i==="album"?o.itemID=r.albumID:i==="playlist"?o.itemID=r.playlistID:i==="song"&&(o.itemID=r.songID),n.trigger("guts:log","sendArtistFansUpdate",o),n.trigger("guts:gatrack","site","sendArtistFansUpdate",i+"_"+e),s.send()},getArtistsDailyArtistStatsEx:function(e,t,n){var r=f(3600,"getArtistsDailyArtistStatsEx",{artistIDs:e,dayCount:t,includeCumulative:n});return r.send()},getArtistDailySongsStats:function(e,t){var n=f(3600,"getArtistDailySongsStats",{artistID:e,dayCount:t});return n.send()},getArtistWeeklyTopStats:function(e){var t=f(3600,"getArtistWeeklyTopStats",{artistID:e});return t.send()},claimArtist:function(e,t,n,r,i,s,o,u,a,l,c,h,p,d,v,m){var g=f(!1,"claimArtist",{artistID:e,message:t,phoneNumber:n,phoneExt:r,phoneType:i,twitterToken:o,twitterSecret:u,facebookVerificationToken:a,affiliation:s,artistName:l,fullName:c,email:h,newAccountPassword:p,twitterLoginDetails:d,googleLoginDetails:v,inviteCode:m});return g.send()},claimSongs:function(e,t,n,r){var i=f(!1,"claimSongs",{artistID:e,message:r,songIDs:t,album:n});return i.send()},verifyFacebookURL:function(e,t){var n=f(!1,"verifyFacebookURL",{facebookUsername:e,gsUsername:t});return n.send()},userVerifyEmail:function(e){var t=f(!1,"userVerifyEmail",{token:e});return t.send()},resendEmailToken:function(e){var t=f(!1,"resendEmailToken",{lastToken:e});return t.send()},userGetFollowersFollowing:function(){var e=f(!1,"userGetFollowersFollowingEx",{},{canPreload:!0});return e.send()},getCommentByID:function(e){var t=f(!1,"getCommentByID",{commentID:e});return t.send()},getCommentsForItem:function(e,t,n){var r=f(!1,"getCommentsForItem",{itemID:e,typeID:t,page:n});return r.send()},reportComment:function(e){var t=f(!1,"reportComment",{commentID:e});return t.send()},deleteComment:function(e,t){var n=f(!1,"deleteComment",{commentID:e,fromArtistID:t});return n.send()},deleteCommentFromMyPage:function(e,t,n){var r=f(!1,"deleteCommentFromMyPage",{commentID:e,itemID:t,typeID:n});return r.send()},storeCommentForItem:function(e,t,n,r){var i=f(!1,"storeCommentForItemEx",{itemID:e,typeID:t,message:n,item:r});return i.send()},storeResponseToComment:function(e,t,n,r){var i=f(!1,"storeResponseToCommentEx",{commentID:e,itemID:t,typeID:n,message:r});return i.send()},reportResponseToComment:function(e,t){var n=f(!1,"reportResponseToComment",{responseID:t,commentID:e});return n.send()},deleteResponseToComment:function(e,t,n){var r=f(!1,"deleteResponseToComment",{responseID:t,commentID:e,fromArtistID:n});return r.send()},deleteResponseToCommentFromMyPage:function(e,t,n,r){var i=f(!1,"deleteResponseToCommentFromMyPage",{responseID:t,commentID:e,itemID:n,typeID:r});return i.send()},updateNotificationReadTime:function(){var e=f(!1,"updateNotificationReadTime",{});return e.send()},getClaimHistory:function(){var e=f(!1,"getClaimHistory",{});return e.send()},nautilusFetchSubscriptionStatusEx:function(){var e=f(!1,"nautilusFetchSubscriptionStatusEx",{},null,!0,!1);return e.send()},nautilusCancelCurrentSubscriptionEx:function(){var e=f(!1,"nautilusCancelCurrentSubscriptionEx",{},null,!0,!1);return e.send()},stripeSubscribeEx:function(e,t,n,r,i,s){var o=f(!1,"stripeSubscribeEx",{amount:e,subType:t,card:n,period:r,currency:s,isRecurring:i},null,!0,!1);return o.send()},paypalInitPaymentEx:function(e,t,n,r,i){var s=f(!1,"paypalInitPaymentEx",{amount:e,tax:t,subType:n,description:r,responseProtocol:i},null,!0,!1);return s.send()},paypalSubscribeEx:function(e,t,n,r,i,s,o,u){var a=f(!1,"paypalSubscribeEx",{token:e,payerID:t,amount:n,tax:r,subType:i,period:s,interval:s,isRecurring:o,description:u,startDate:Math.floor($.now()/1e3)},null,!0,!1);return a.send()},promoSubscribeEx:function(e){var t=f(!1,"promoSubscribeEx",{promoCode:e},null,!0,!1);return t.send()},verifyPromoCode:function(e){var t=f(!1,"verifyPromoCode",{code:e},null,!0,!1);return t.send()},purchasePromoCode:function(e,t,n){var r=f(!1,"purchasePromoCode",{numMonths:e,amount:t,cardInfo:n},null,!0,!1);return r.send()},emailPromoCode:function(e,t){var n=f(!1,"emailPromoCode",{code:t,email:e});return n.send()},getUserSpecialPricing:function(){var e=f(!1,"getUserSpecialPricing",{});return e.send()},getUserSpecialPricingEx:function(){var e=f(!1,"getUserSpecialPricingEx",{},null,!0,!1);return e.send()},getUserFreeCodes:function(){var e=f(!1,"getUserFreeCodes",{});return e.send()},userSawPendingNotification:function(e){var t=f(!1,"userSawPendingNotification",{notificationName:e});return t.send()},storeChatIdentity:function(e){var t=f(!1,"storeChatIdentity",{channelToNotify:e});return t.send()},reportBadAd:function(e,t,n,r,i){var s=f(!1,"reportBadAd",{placement:e,desc:t,info:n,type:r,itemID:i});return s.send()},getCallout:function(e){var t=f(!1,"getCallout",{calloutID:e});return t.send()},getUserCallouts:function(e){var t=f(!1,"getUserCallouts",{userID:e});return t.send()},updateCalloutDetails:function(e,t){var n=f(!1,"updateCalloutDetails",{calloutID:e,name:t});return n.send()},deleteCallout:function(e){var t=f(!1,"deleteCallout",{calloutID:e});return t.send()},banBroadcastListenerByUserID:function(e,t,n,r){var i=f(!1,"banBroadcastListenerByUserID",{userID:e,broadcastID:t,existingBannedUserIDs:n,chatMessage:r});return i.send()},logGuts:function(e,t){var n=f(!1,"logGuts",{data:e},t);return n.send()},sendRealtimeBroadcastInvite:function(e,t){var n=f(!1,"sendRealtimeBroadcastInvite",{recipientUserID:e,broadcastID:t});return n.send()},getPastBroadcastInvites:function(){var e=f(!1,"getPastBroadcastInvites");return e.send()},sendEmailBroadcastInvites:function(e,t,n){var r=f(!1,"sendEmailBroadcastInvites",{recipientUserIDs:e,broadcastID:t,message:n});return r.send()},getArtistsFromName:function(e){var t=f(!0,"getArtistsFromName",{name:e});return t.send()},deleteFeedEvents:function(){var e=f(!1,"deleteFeedEvents");return e.send()}}}(),function(){function m(){var e=u.get("user"),t=a&&a.id!=e.id,n=o.get("currentQueue"),r=n?n.get("currentBroadcast"):null;a&&(a.off("change:favoriteUsers",b),a.off("change:settings",w),a.off("change:sessionPrivacy",E),t&&y()),a=e,a.on("change:favoriteUsers",b),a.on("change:settings",w),a.on("change:sessionPrivacy",E),b(),w(),S(),E(a,a.get("sessionPrivacy"),{dontReport:!0});if(r&&t&&a.get("isLoggedIn")){var i=a.getUserBroadcastInvites();a.getFollowers().done(_.bind(function(){i.done(_.bind(a.updateBroadcastInviteableUsers,this))},a))}}function g(e){var t=e.get("ArtistID")*-1-100,r=n.Models.User.getCached(t);return r||(r=new n.Models.User({UserID:e.get("ArtistID")*-1-100,FName:e.get("ArtistName"),Picture:e.get("CoverArtFilename"),artist:e}),e.on("change",function(){r.trigger.apply(r,["change"].concat(_.toArray(arguments)))},r)),r}function y(){L.state()!=="pending"&&(L=$.Deferred(),O.chatReady=L.promise())}function b(){if(k.state()!=="resolved"){k.done(_.bind(w,this));return}var e=a.get("favoriteUsers");e&&a.get("isLoggedIn")&&(a.get("sessionPrivacy")&8)>0&&typeof O.setListeningReadableUsers=="function"&&O.setListeningReadableUsers(e.pluck("UserID"),!1)}function w(){if(k.state()!=="resolved"){k.done(_.bind(w,this));return}var e=a.get("settings").local;e.crossfadeEnabled!=O.getCrossfadeEnabled()&&O.setCrossfadeEnabled(e.crossfadeEnabled),e.crossfadeAmount!=O.getCrossfadeAmount()&&O.setCrossfadeAmount(e.crossfadeAmount),e.lowerQuality!=O.getLowerQuality()&&O.setLowerQuality(e.lowerQuality),!e.noPrefetch!=O.getPrefetchEnabled()&&O.setPrefetchEnabled(!e.noPrefetch),e.playPauseFade!=O.getPlayPauseFade()&&O.setPlayPauseFade(e.playPauseFade),O.setPersistShuffle(e.persistShuffle),e.persistShuffle&&e.lastShuffle!=O.getShuffle()&&O.setShuffle(e.lastShuffle),O.setPlayerKeyShortcuts(!e.disablePlayerShortcuts)}function E(e,t,r){(!r||!r.dontReport)&&n.Services.API.reportUserChange(e);var i=o.get("currentQueue"),s=i?i.get("currentBroadcast"):null;if(!s)return;(t&4)>0?(s.removePersistentChatActivity("info",n.Models.ChatActivity.VISIBILITY_FRIENDS_WARNING),s.addPersistentChatActivity(new n.Models.ChatActivity({type:"info",infoType:n.Models.ChatActivity.OFFLINE_CANT_CHAT,closeable:!0}))):(t&8)>0?(s.removePersistentChatActivity("info",n.Models.ChatActivity.OFFLINE_CANT_CHAT),s.addPersistentChatActivity(new n.Models.ChatActivity({type:"info",infoType:n.Models.ChatActivity.VISIBILITY_FRIENDS_WARNING,closeable:!0}))):(s.removePersistentChatActivity("info",n.Models.ChatActivity.VISIBILITY_FRIENDS_WARNING),s.removePersistentChatActivity("info",n.Models.ChatActivity.OFFLINE_CANT_CHAT))}function S(){o.off(null,x),a.get("subscription").canListenUninterrupted()||(f=Date.now(),o.on("change:playStatus",x))}function x(){var e=Date.now();o.get("playStatus")==3&&e-f>l&&!o.get("currentQueue").get("currentBroadcast")&&!a.get("subscription").canListenUninterrupted()&&(O.setPauseNextSong(!0),n.trigger("lightbox:open","interactionTimeout",{_canClose:!1}))}function T(){k.state()=="pending"&&n.trigger("lightbox:open","swfTimeout",{_canClose:!1})}function N(){_.each(h,function(e){n.trigger("notification:close",e)}),c=null}n.Services=n.Services||{};var i=!1,s={bytesLoaded:0,bytesTotal:0,duration:0,position:0,playStatus:0,currentStreamServer:""},o,u,a,f,l=36e5,c=null,h=[],p={},d,v,C=_.throttle(function(){var e=o.get("currentQueue"),t=e?e.get("currentBroadcast"):!1,r=e?e.get("activeSong"):!1,i=r?r.get("context"):!1,s=t?t.get("activeSong"):!1,u=a.get("settings");if(e.get("isBroadcasting")&&t&&u.local&&!!u.local.broadcastAutoApprove&&!t.get("nextSong")){var f=o.get("position"),l=o.get("duration"),c=t.get("lastSawAutoApproveForSong"),h=!t.get("disableAutoApproveLb");if(r&&c&&c==r.get("queueSongID")||i&&i.data&&i.data.wasAuto)h=!1;if(f&&l){var p=l-f;p<105e3?(h&&(n.trigger("lightbox:open","broadcastAutoApprove",{countdown:60,broadcast:t,user:a}),t.set("lastSawAutoApproveForSong",r?r.get("queueSongID"):!1)),t.approveTopSuggestion(h?6e4:Math.max(0,Math.min(6e4,p-45e3)),!h)):t.cancelPendingAutoApprove()}else t.cancelPendingAutoApprove()}else t&&t.cancelPendingAutoApprove()},5e3),k=$.Deferred(),L=$.Deferred(),A=0,O=n.Services.SWF={ready:k.promise(),chatReady:L.promise(),playSpecialIndexes:{PREVIEW:-99,DEFAULT:-1,NEXT:-2,LAST:-3,REPLACE:-4},chatDisconnected:!1,chatReconnecting:!1,queueSongCount:0,largeBroadcastThreshold:49,broadcastNextPreventPosition:3e4,init:function(t){u=t,o=u.get("player"),i=!0,this.muteLocks={},this.preLockMuteValue=!1,this.preLockVolume=100,u.on("change:user",m),m(),n.ready.done(function(){k.state()=="pending"&&setTimeout(T,1e4)}),k.done(function(){var t=function(){var t=e.preloadedDataTotalTime,r=e.preloadedDataTotalSize,i=e.preloadedData.processTime,s=192,o,u,a,f;t&&r&&(o=r*.25,u=Math.max(o,16e3)/(t/1e3-i)/1024*8,a=u/s,a>=2?f=_.toInt(1e3/a-200):a>=1?f=_.toInt(2e3/a-200):f=3e3,n.Services.SWF.setCurrentBufferSize(Math.min(Math.max(f,50),3e3)))};e.preloadedData?t():n.on("preloadedData",t),n.on("userActivity",function(e){f=Date.now(),O.setLastMouseMove&&O.setLastMouseMove(e)})})},flashSafeTrigger:function(){n.dispatcher.trigger.apply(n.dispatcher,_.toArray(arguments))},getConfig:function(){if(!i)return!1;var t=_.clone(e.gsConfig);return delete t.profile,t},addSwfMethods:function(e){return _.extend(this,e),!0},swfReady:function(t){if(!n.loadedTokenData)return!1;t||(t=this.getEverything()),n.on("player:volumeChange",this.changeVolume,this);try{o.set({volume:t.volume,isMuted:t.isMuted,crossfadeAmount:t.crossfadeAmount,crossfadeEnabled:t.crossfadeEnabled,playPauseFade:t.playPauseFade,currentQueue:t.currentQueue?new n.Models.Queue(t.currentQueue):null,previousQueue:t.previousQueue})}catch(r){console.log(r)}this.setErrorCallback("GS.Services.SWF.playerError"),this.setPlaybackStatusCallback("GS.Services.SWF.playerStatus"),this.setPropertyChangeCallback("GS.Services.SWF.propertyChange"),this.setQueueChangeCallback("GS.Services.SWF.queueChange"),this.setSongPropertyChangeCallback("GS.Services.SWF.songChange"),this.setChatServers(gsConfig.chatServersWeighted?gsConfig.chatServersWeighted:{},e.clientTimeDivergence||0);var i=this.setZoomChangeCallback("GS.Services.SWF.onZoomChange");return this.onZoomChange(i),n.on("swf:prefetchStreamKeys",this.prefetchStreamKeys,this),n.on("player:addSongs",this.addSongs,this),n.on("player:removeSongs",this.removeSongsWrapper,this),n.on("player:removeSpecific",this.removeSpecificSong,this),n.on("player:playSong",this.playSongWrapper,this),n.on("player:pauseSong",this.handlePauseSong,this),n.on("player:resumeSong",this.resumeSong,this),n.on("player:togglePlay",this.togglePlay,this),n.on("player:shuffle",this.toggleShuffle,this),n.on("player:repeat",this.toggleRepeat,this),n.on("player:volumeMute",this.toggleVolumeMute,this),n.on("player:nextSong",this.playNextSong,this),n.on("player:seekTo",this.seekTo,this),n.on("player:previousSong",this.playPreviousSong,this),n.on("player:crossfade",this.toggleCrossfade,this),n.on("player:clear",this.handleClearQueue,this),n.on("player:restore",this.restoreQueue,this),n.on("player:radio",this.toggleAutoplay,this),n.on("player:startRadioWithSongs",this.startRadioWithSongs,this),n.on("player:voteSong",this.setAutoplayVote,this),n.on("player:flagSong",this.flagQueueSong,this),n.on("player:startComputeSpectrum",this.startComputingSpectrum,this),n.on("player:stopComputeSpectrum",this.stopComputingSpectrum,this),n.on("manatee:initReconnect",this.initReconnect,this),this.getQueueIsRestorable()&&o.set({previousQueue:!0}),u.get("user")&&(n.Services.API.reportUserChange(u.get("user")),m()),k.resolve(),this.songToPlayOnReadyToken&&n.Models.Song.getByToken(this.songToPlayOnReadyToken).then(_.bind(function(e){this.addSongs([e],0,!0)},this)),t.interruptionExpireTime&&$.now()<t.interruptionExpireTime&&a.get("subscription").trigger("freeAdExpiresUpdate",t.interruptionExpireTime),!0},setPlayerKeyShortcuts:function(e){$(document).unbind(".playerShortcut");var t=this;e&&$(document).bind("keyup.playerShortcut.playerShortcutPause","space",function(e){if($(e.target).is("button")){e.preventDefault();return}}).bind("keydown.playerShortcut.playerShortcutPause","space",function(e){if($(e.target).is("input,textarea,select,object,embed")&&$(e.target).val().length>0)return;var t=r.lightbox;if(t&&t.currentLightbox&&(!t.currentLightbox._showPlayerControls||_.isInstance(t.currentLightbox,n.Views.Lightboxes.Record)))return;var i=o,s=i.get("currentQueue");return s.get("currentBroadcast")?r.player.onVolumeClick():n.trigger("player:togglePlay"),n.trigger("guts:gatrack","player","playPauseShortcut"),!1}).bind("keydown.playerShortcut.playerShortcutNext","ctrl+right",function(e){if($(e.target).is("input,textarea,select,object,embed")&&$(e.target).val().length>0)return;var i=r.lightbox;if(i&&i.currentLightbox&&!i.currentLightbox._showPlayerControls)return;return t.playNextSong(),n.trigger("guts:gatrack","player","nextShortcut"),!1}).bind("keydown.playerShortcut.playerShortcutNext","meta+right",function(e){if($(e.target).is("input,textarea,select,object,embed")&&$(e.target).val().length>0)return;var i=r.lightbox;if(i&&i.currentLightbox&&!i.currentLightbox._showPlayerControls)return;return t.playNextSong(),n.trigger("guts:gatrack","player","nextShortcut"),!1}).bind("keydown.playerShortcut.playerShortcutPrevious","ctrl+left",function(e){if($(e.target).is("input,textarea,select,object,embed")&&$(e.target).val().length>0)return;var i=r.lightbox;if(i&&i.currentLightbox&&!i.currentLightbox._showPlayerControls)return;return t.playPreviousSong(),n.trigger("guts:gatrack","player","prevShortcut"),!1}).bind("keydown.playerShortcut.playerShortcutPrevious","meta+left",function(e){if($(e.target).is("input,textarea,select,object,embed")&&$(e.target).val().length>0)return;var i=r.lightbox;if(i&&i.currentLightbox&&!i.currentLightbox._showPlayerControls)return;return t.playPreviousSong(),n.trigger("guts:gatrack","player","prevShortcut"),!1}).bind("keydown.playerShortcut.playerShortcutVolumeUp","ctrl+up",function(e){if($(e.target).is("input,textarea,select,object,embed")&&$(e.target).val().length>0)return;var i=r.lightbox;if(i&&i.currentLightbox&&!i.currentLightbox._showPlayerControls)return;return t.setVolume(Math.min(100,t.getVolume()+5)),n.trigger("player:volume:keychange"),n.trigger("guts:gatrack","player","volumeUpShortcut",t.getVolume()),!1}).bind("keydown.playerShortcut.playerShortcutVolumeUp","meta+up",function(e){if($(e.target).is("input,textarea,select,object,embed")&&$(e.target).val().length>0)return;var i=r.lightbox;if(i&&i.currentLightbox&&!i.currentLightbox._showPlayerControls)return;return t.setVolume(Math.min(100,t.getVolume()+5)),n.trigger("player:volume:keychange"),n.trigger("guts:gatrack","player","volumeUpShortcut",t.getVolume()),!1}).bind("keydown.playerShortcut.playerShortcutVolumeDown","ctrl+down",function(e){if($(e.target).is("input,textarea,select,object,embed")&&$(e.target).val().length>0)return;var i=r.lightbox;if(i&&i.currentLightbox&&!i.currentLightbox._showPlayerControls)return;var s=t.getVolume()-5;return s>0?t.setVolume(s):t.toggleVolumeMute(!0),n.trigger("player:volume:keychange"),n.trigger("guts:gatrack","player","volumeDownShortcut",t.getVolume()),!1}).bind("keydown.playerShortcut.playerShortcutVolumeDown","meta+down",function(e){if($(e.target).is("input,textarea,select,object,embed")&&$(e.target).val().length>0)return;var i=r.lightbox;if(i&&i.currentLightbox&&!i.currentLightbox._showPlayerControls)return;var s=t.getVolume()-5;return s>0?t.setVolume(s):t.toggleVolumeMute(!0),n.trigger("player:volume:keychange"),n.trigger("guts:gatrack","player","volumeDownShortcut",t.getVolume()),!1})},lockMute:function(e){var t=!_.isEmpty(this.muteLocks);this.muteLocks[e]=!0,t||(this.preLockMuteValue=this.getIsMuted(),this.preLockVolume=this.getVolume()),this.setIsMuted(!0)},unlockMute:function(e){this.muteLocks.hasOwnProperty(e)&&delete this.muteLocks[e],_.isEmpty(this.muteLocks)&&(this.setVolume(this.preLockVolume),this.setIsMuted(this.preLockMuteValue))},playerError:function(e){function t(e,t){n.trigger("notification:add",{description:e,duration:t||6500,type:"error"})}console.log("player.playererror",e);var r=o.get("currentQueue"),i;switch(e.type){case"errorAddingSongs":console.log("player. failed to add songs: ",e.details.songs,e.details.reason),e.details.reason=="tooManySongs"?t(_.getString("ERROR_TOO_MANY_SONGS")):t(_.getString("ERROR_ADDING_SONG")+": "+e.details.reason);break;case"playbackError":console.log("player. error playing song",e.details.song,e.details.reason,e.details.errorDetail);var s=r.get("isBroadcasting");e.details.reason==="broadcasterError"||r&&r.get("currentBroadcast")&&s?e.details.errorDetail=="broadcasterFailed"?(i=e.details.song,t(_.getString("POPUP_ERROR_BROADCASTER_SONG_FAILED_LISTENER",{song:i?_.escape(i.SongName):"-",artist:i?_.escape(i.ArtistName):"-"}),3e4)):e.details.errorDetail=="warningFrequentBuffering"&&!s?t(_.getString("POPUP_ERROR_BROADCASTER_SONG_LOADING"),15e3):t(_.getString("ERROR_PLAYING_INBROADCAST")):e.details.errorDetail=="cacheRequired"?t(_.getString("POPUP_ERROR_BROADCAST_CACHE_FAILED"),6e4):e.details.reason==="unknownHasNext"?t(_.getString("ERROR_HASNEXT_MESSAGE")):e.details.errorDetail=="broadcastBufferStop"?t(_.getString("POPUP_ERROR_BROADCASTER_SONG_BUFFER_STOPPED"),15e3):t(_.getString("ERROR_PLAYING_SONG"));break;case"autoplayFailed":console.log("player. error fetching autoplay song",e.details.reason),e.details.reason==="unknownHasNext"?t(_.getString("ERROR_HASNEXT_MESSAGE")):e.details.reason==="noRecommendations"?n.trigger("lightbox:open","stations",{noRecs:!0}):t(_.getString("ERROR_FETCHING_RADIO"));break;case"autoplayVoteError":console.log("player. error voting song",e.details.song),t(_.getString("ERROR_VOTING_SONG"));break;case"serviceError":console.log("player. service error",e.details),t(_.getString("ERROR_FETCHING_INFO"));break;case"nextSongPlaybackError":console.log("player. nextSongPlaybackError",e.details.song,e.details.reason,e.details.errorDetail),r&&r.get("isBroadcasting")&&(e.details.reason=="unknownStopping"?t(_.getString("POPUP_ERROR_BROADCAST_NEXT_SONG_FAIL_PERMANENTLY"),0):(i=e.details.song,t(_.getString("POPUP_ERROR_BROADCAST_NEXT_SONG_FAIL",{song:i?_.escape(i.SongName):"-",artist:i?_.escape(i.ArtistName):"-"}),12e4)))}e.details.errorDetail?n.trigger("guts:gatrack","playerError",e.type,e.details.reason+", "+e.details.errorDetail):n.trigger("guts:gatrack","playerError",e.type,e.details.reason)},addSongs:function(e,t,r,i,s,u){if(!e.length)return;var a=[],f=[],l=[];t=_.orEqual(t,this.playSpecialIndexes.DEFAULT),r=_.orEqual(r,!1),i=_.orEqual(i,null),_.isNull(i)&&(i=new n.Models.PlayContext),s=_.orEqual(s,!1),e.models&&(e=e.models);if(e.length&&e[0].attributes)_.each(e,function(e){var t=e.getDetailsForSwf();a.push(t),t.isCallout?l.push(e.get("CalloutID")):f.push(e.get("SongID"))});else if(e.length&&_.isNumber(e[0]))for(var c=0;c<e.length;c++){var h=n.Models.Song.getCached(e[c]);a.push(h.getDetailsForSwf()),f.push(h.get("SongID"))}else a=e||[];var p=o.get("currentQueue"),d=p.get("currentBroadcast"),v=p.get("isBroadcasting"),m=o.get("playStatus"),g=m!==n.Models.Player.playStatuses.NONE&&m!==n.Models.Player.playStatuses.COMPLETED&&m!==n.Models.Player.playStatuses.FAILED,y=!1,b={songIDs:f};v&&(s=!1);if(t==this.playSpecialIndexes.PREVIEW||!u&&d&&(r||!d.isLoggedInUserOwner())&&(g||!v)){n.trigger("lightbox:open","previewSong",{index:t,songs:(new n.Models.Collections.Songs(a,{dontCache:!0})).models,playContext:i,playOnAdd:r,showPlayerControls:!0,_showPlayerControls:!0}),n.trigger("guts:log","broadcastPreviewSong",b);return}if(!u&&v&&p&&p.get("isBroadcasting")&&p.get("currentBroadcast").get("listenersCount")>O.largeBroadcastThreshold){var w=p.get("activeSong")&&p.get("songs").lastIndexOf(p.get("activeSong"))||0;if(t===this.playSpecialIndexes.NEXT||t>0&&t-w===1){var E=o.get("position"),S=o.get("duration");S&&S-E<n.Services.SWF.broadcastNextPreventPosition&&(n.trigger("notification:add",{description:_.getString("POPUP_ERROR_BROADCASTER_CHANGE_NEXT"),type:"error"}),t=w+2)}}if(i&&(i.streamType&n.Models.PlayContext.TYPE_BROADCAST)>0){var x=i.data&&i.data.BroadcastID;x&&(!d||x!==d.get("BroadcastID"))&&(i.data.archivedBroadcast=!0)}p&&p.get("isBroadcasting")&&!p.get("activeSong")&&(r=!0),t==this.playSpecialIndexes.REPLACE&&(this.stopSong(),this.clearQueue(),t=this.playSpecialIndexes.DEFAULT),this.addSongsToQueueAt(a,t,r,i,s,y),r?o.set({expectManualSongChange:!0}):y&&o.set({expectManualSongChange:!0,playSongOnDownloaded:!0}),n.trigger("guts:log","songsQueued",{songIDs:f,calloutIDs:l,atIndex:t,playOnAdd:r,autoplayOnAdd:s})},removeSongsWrapper:function(e){var t=[],r=0,i=e.length;for(;r<i;r++)t.push(e[r].get("queueSongID"));this.removeSongs(t),n.Services.GUTS&&n.trigger("guts:gatrack","player","removeSongs")},removeSpecificSong:function(e,t){o.get("currentQueue")&&o.get("currentQueue").get("queueID")==t&&this.removeSongs([e])},playSongWrapper:function(e){var t=o.get("currentQueue"),r=!1;if(_.isUndefined(e)){r=!0,e=t?t.get("activeSong"):!1;if(!e)return}var i=typeof e=="number"?e:e.get("queueSongID");r&&o.get("playStatus")===n.Models.Player.playStatuses.PAUSED?this.resumeSong():this.playSong(i)},playerStatus:function(e){var t;e?t={bytesLoaded:e.bytesLoaded,bytesTotal:e.bytesTotal,position:e.position,duration:e.duration,playStatus:e.playStatus||e.status,currentStreamServer:e.currentStreamServer}:t=s,o.set(t),e&&e.position&&e.duration&&C()},propertyChange:function(e){_.isEmpty(this.muteLocks)||(e.hasOwnProperty("isMuted")&&delete e.isMuted,e.hasOwnProperty("volume")&&delete e.volume),o.set(e);if(a){var t=a.get("settings").local,n={};e.hasOwnProperty("crossfadeAmount")&&t.crossfadeAmount!=e.crossfadeAmount&&(n.crossfadeAmount=e.crossfadeAmount),e.hasOwnProperty("crossfadeEnabled")&&t.crossfadeEnabled!=e.crossfadeEnabled&&(n.crossfadeEnabled=e.crossfadeEnabled?1:0),e.hasOwnProperty("crossfadeInOutEnabled")&&t.crossfadeInOutEnabled!=e.crossfadeInOutEnabled&&(n.crossfadeInOutEnabled=e.crossfadeInOutEnabled?1:0),a.saveLocalSettings(n)}},queueChange:function(e){var t=o.get("currentQueue"),r=t.get("activeSong"),i=t.get("nextSong"),s=t.get("previousSong"),u=t.get("queueID"),f=t.get("songs"),l=t.get("cachedSongs"),c=e.details,h=!1,p,d,v,m=e.type=="queueReset"&&(!t&&e||t&&!e||u!=c.queueID),g=function(e){_.isArray(e)||(e=[e]);var t=[],r,i,s;for(var o=0,u=e.length;o<u;o++)r=e[o].queueSongID,i=l.get(r),i||(s=e[o].context,s&&s.data&&s.data.fromUserAction&&(e[o].fromUserAction=!0),i=new n.Models.QueueSong(e[o],{notifyCache:!0,skipUpdate:!0}),l.add(i)),t.push(i);return t},y=function(e){var t=g([e]);return t.length?t[0]:null};!m&&c&&!_.isUndefined(c.previousSong)&&(p=c.previousSong,!s&&p||s&&p&&s.get("queueSongID")!=p.queueSongID?s=y(p):p||(s=null),c.previousSong=s),!m&&c&&!_.isUndefined(c.activeSong)&&(d=c.activeSong,!r&&d||r&&d&&r.get("queueSongID")!=d.queueSongID?r=y(d):d||(r=null),c.activeSong=r,r&&o.get("playSongOnDownloaded")&&(o.get("playSongOnDownloaded",!1),this.playSong()),a.set("nowPlayingSong",r)),!m&&c&&!_.isUndefined(c.nextSong)&&(v=c.nextSong,!i&&v||i&&v&&i.get("queueSongID")!=v.queueSongID?i=y(v):v||(i=null),e.details.nextSong=i),c&&!_.isUndefined(c.shuffleEnabled)&&a&&a.saveLocalSettings({lastShuffle:c.shuffleEnabled?1:0});if(e.type=="queueReset"){c.lastQueueReset=+(new Date);if(c&&c.queueID!=u){var b=new n.Models.Queue(c),w=this.getEverything().previousQueue;b.get("activeSong")?a.set("nowPlayingSong",b.get("activeSong")):a.set("nowPlayingSong",null);var E=t.get("currentBroadcast");E&&(b.set({currentBroadcast:E,isBroadcasting:t.get("isBroadcasting")}),E.subscribeToChat("queue")),o.set({currentQueue:b,previousQueue:w}),t=b}else c.songs=g(c.songs),c.songs=f.reset(c.songs),t.set(c)}else if(e.type=="contentChange"){var S=e.details.index,x,T,N,C;h=e.details.items&&e.details.items.length>50;switch(e.details.kind){case"add":C=g(e.details.items),f.add(C,{at:S,silent:h});break;case"remove":C=g(e.details.items),f.remove(C,{silent:h});break;case"replace":for(T=0,N=e.details.items.length;T<N;T++)x=f.at(S+T),f.remove(x),x=y(e.details.items[T]),f.add(x,{at:S+T,silent:h});break;case"move":var k=e.details.oldIndex;x=f.at(k),f.remove(x,{silent:h}),x&&(e.details.items&&e.details.items[0]&&(x=y(e.details.items[0])),f.add(x,{at:S,silent:h}))}}else if(e.type=="propertyChange"){if(c.songs){var L=g(c.songs);c.songs=f.reset(L)}t.set(c)}h&&f.trigger("reset",f,{}),console.log("got a queue event",_.extend({},e),t)},songChange:function(e){var t=o.get("currentQueue"),r=t&&t.get("songs"),i;if(!t||!r){console.log("songChange fail",o,e);return}i=r.get(e.queueSongID);if(i){if(i._wrapped&&!_.isUndefined(e.autoplayVote)&&t.get("clientRadioEnabled")&&i.get("autoplayVote")!=e.autoplayVote){var s=t.get("clientRadio");e.autoplayVote==-1?s.frowns.add(i._wrapped):s.frowns.remove(i._wrapped)}i._wrapped&&$.isArray(e.Tags)&&!i.get("Tags")?e.Tags=new n.Models.Collections.Tags(e.Tags):e.Tags&&delete e.Tags;if(e.artistIsClaimed&&e.ArtistID){var u=i.getArtists(e.ArtistID);u&&!u.isClaimed()&&u.set("Flags",(u.get("Flags")||0)|n.Models.Artist.FLAG_ARTIST_CLAIMED),delete e.artistIsClaimed}i.set(e),i===t.get("activeSong")&&n.trigger("player:userActiveSongEngagement")}},startComputingSpectrum:function(e,t){t=_.orEqual(t,!1),this.computeSpectrumCallback=e,this.setComputeSpectrumCallback("GS.Services.SWF.onSpectrumData",t)},stopComputingSpectrum:function(){this.computeSpectrumCallback=null,this.setComputeSpectrumCallback("")},onSpectrumData:function(e){_.isFunction(this.computeSpectrumCallback)&&this.computeSpectrumCallback(e)},onZoomChange:function(e){console.log("onZoomChange",e),this.lastZoomLevel=e},attemptAutoRestoreQueue:function(){o.get("previousQueue")&&a&&a.get("settings")&&a.get("settings").local.restoreQueue&&this.restoreQueue()},swfBadHost:function(){n.trigger("lightbox:open",{_type:"badHost",_canClose:!1,view:{header:"LB_BAD_HOST_TITLE",message:"LB_BAD_HOST_MSG",buttonsLeft:[{href:"http://www.grooveshark.com",labelHTML:"http://www.grooveshark.com"}]}})},swfNeedsToken:function(){n.trigger("swf:tokenRequired")},onChatReady:function(e){var t=a.get("UserID");e&&(t<1||e.userID==t)?(L.resolve(e),A=0,this.chatDisconnected&&(this.handleManateeReconnected(),n.trigger("manatee:connected"),this.chatDisconnected=!1,this.chatReconnecting=!1),t>0&&n.Services.API.storeChatIdentity(),v&&v.outageType=="manateeGoingDown"&&(n.trigger("notification:close",v),v=null),d&&clearTimeout(d),O.sendSelfMessage({},"statusRequest"),d=setTimeout(function(){a.get("shouldSyncUserContent")||a.set("shouldSyncUserContent",!1)},1e4)):A++<1?(n.Services.API.reportUserChange(a),y()):(n.Services.SWF.onPageUnload(),this.chatDisconnected=!0,this.chatReconnecting=!1,this.onManateeDisconnected(),y())},onChatData:function(e){var t=e,i;e=e.data;if(t&&t.messageType==="flattrData"){n.trigger("manatee:flattrData",t);return}switch(e.command){case"usersStatusUpdate":if(e.users){var s=(a.get("sessionPrivacy")&4)===0,o=[],u=[],f=[],l,c,h;_.each(e.users,function(e,t){i=n.Models.User.getCached(t);if(!i){_.isUndefined(n.Models.User.getUserStatusDfds[t])||n.Models.User.getUserStatusDfds[t].resolve(e,t);return}c={onlineStatus:_.toInt(e.status)},e.bcastOwnerInfo&&e.bcastOwnerInfo.u&&(h=n.Models.User.getCached(_.toInt(e.bcastOwnerInfo.i))),h&&(h instanceof n.Models.AuthUser||!h.get("isFavorite"))&&(h=null),e.bcast&&c.onlineStatus?$.extend(c,i.storeCurrentBroadcast(_.toInt(e.bcastOwner),e.bcast,e.bcastName,e.bcastPic,e.bcastOwnerInfo,!0,!0)):(i.attributes.currentBroadcastID||typeof i.attributes.currentBroadcastID=="undefined")&&$.extend(c,i.storeCurrentBroadcast(0,null,null,null,null,!0,!0)),i.get("isFavorite")&&(l=i.attributes.currentBroadcastOwner,l instanceof n.Models.Artist&&(l=g(l)),l&&l!=c.currentBroadcastOwner&&l.friendsLinked&&(l.friendsLinked.remove(i),f.push(l)),c.currentBroadcastOwner&&i!==a&&!h&&(l=c.currentBroadcastOwner,l instanceof n.Models.Artist&&(l=g(l)),l instanceof n.Models.User&&(l.friendsLinked?l.friendsLinked.add(i):(l.friendsLinked=new n.Models.Collections.Users([i]),l!=c.currentBroadcastOwner&&(c.currentBroadcastOwner.friendsLinked=l.friendsLinked)),o.push(l)))),s&&(e.status&&e.song&&e.song.SongID?c.nowPlayingSong=n.Models.Song.newOrUpdate(e.song,{dontCache:!0}):c.nowPlayingSong=null,c.currentBroadcastOwner&&c.currentBroadcastOwner.friendsLinked&&(!c.currentBroadcastOwner.statusSubLocks||!c.currentBroadcastOwner.statusSubLocks[0])?c.currentBroadcastOwner.set({nowPlayingSong:c.nowPlayingSong}):c.currentBroadcastOwner&&(c.nowPlayingSong=c.currentBroadcastOwner.get("nowPlayingSong"))),c.onlineStatus||(c.nowPlayingSong=null),i.set(c),_.isUndefined(n.Models.User.getUserStatusDfds[t])||n.Models.User.getUserStatusDfds[t].resolve(e,t)}),_.each(f,function(e){if(e&&e.friendsLinked&&!e.friendsLinked.length){if(!(e instanceof n.Models.AuthUser)){var t=e.get("artist");e.id<-100&&t&&(t.off(null,null,e),n.Models.User.uncache(e))}u.push(e)}}),n.trigger("manatee:friendsStatus"),o&&o.length&&n.trigger("manatee:extraUsersStatus",o),u&&u.length&&n.trigger("manatee:extraUsersRemoved",u)}break;case"offlineFriendsUpdate":var p;e.users?_.each(e.users,function(e,t){i=n.Models.User.getCached(t);if(!i){_.isUndefined(n.Models.User.getUserStatusDfds[t])||n.Models.User.getUserStatusDfds[t].resolve(e,t);return}p={onlineStatus:0,nowPlayingSong:null},$.extend(p,i.storeCurrentBroadcast(0,null,null,null,null,!0,!0)),i.set(p),_.isUndefined(n.Models.User.getUserStatusDfds[t])||n.Models.User.getUserStatusDfds[t].resolve(e,t)}):e.artists&&_.each(e.artists,function(e,t){d=n.Models.Artist.getCached(t);if(!d){_.isUndefined(n.Models.Artist.getArtistStatusDfds[t])||n.Models.Artist.getArtistStatusDfds[t].resolve(e,t);return}p={onlineStatus:0,nowPlayingSong:null},$.extend(p,d.storeCurrentBroadcast(0,null,null,null,null,!0,!0)),d.set(p),_.isUndefined(n.Models.Artist.getArtistStatusDfds[t])||n.Models.Artist.getArtistStatusDfds[userID].resolve(e,t)});break;case"artistsStatusUpdate":if(e.artists){var d;_.each(e.artists,function(e,t){d=n.Models.Artist.getCached(t);if(!d){_.isUndefined(n.Models.Artist.getArtistStatusDfds[t])||n.Models.Artist.getArtistStatusDfds[userID].resolve(e,t);return}c={onlineStatus:_.toInt(e.status)},e.bcast?$.extend(c,d.storeCurrentBroadcast(_.toInt(e.bcastOwner),e.bcast,e.bcastName,e.bcastPic,e.bcastOwnerInfo,!0,!0)):$.extend(c,d.storeCurrentBroadcast(0,null,null,null,null,!0)),s&&(e.status&&e.song&&e.song.SongID?c.nowPlayingSong=n.Models.Song.newOrUpdate(e.song,{dontCache:!0}):c.nowPlayingSong=null),d.set(c),d.currentStatusDfd&&d.currentStatusDfd.resolve(d),_.isUndefined(n.Models.Artist.getArtistStatusDfds[t])||n.Models.Artist.getArtistStatusDfds[userID].resolve(e,t)})}break;case"userInfoUpdate":if(e&&e.users){var v=[];_.each(e.users,function(e,t){if(!e)return;if(e.r){i=n.Models.User.getCached(t),i&&i.set("restricted",!0);return}i=n.Models.User.newOrUpdate({UserID:t,FName:e.n,Picture:e.p},{dontCache:!0}),v.push(i)}),n.trigger("manatee:getUsersChatInfo",v,e.extraData)}break;case"push":var m;e.publish&&e.publish.value&&(e.publish.value.messageType?e.publish.value.messageType=="userAccountDisabled"?a.get("isLoggedIn")&&(e.publish.id.sudo||e.publish.id.userid==a.id)&&(r.model.logout(!1,!0),n.trigger("notification:add",{description:_.getString("NOTIF_ACCOUNT_DISABLED"),type:"error",duration:0})):n.trigger("manatee:"+e.publish.value.messageType,e.publish.value):(m=e.publish.destination.match(/^bcast:p:([a-f0-9]+)$/))&&this.handlePublicBroadcastPublish(e,m[1]));break;case"broadcastGet":if(e&&e.broadcastID){var y=this.handleBroadcastGet(e.broadcast,e.broadcastID);n.trigger("manatee:broadcastInfo",y||null,e.broadcastID)}break;case"fetchBroadcastListenerCount":if(e&&e.broadcastID&&e.count>0){var y=n.Models.Broadcast.getCached(e.broadcastID);y.updateListenersCount(e.count)}break;case"fetchBroadcastsInfo":if(e&&e.broadcasts){var b=[],w=[],E,S;_.each(e.broadcasts,_.bind(function(e){E=e.BroadcastID,S=this.handleBroadcastGet(e,E),S&&w.push(S),b.push(E)},this)),e.broadcastIDs&&_.each(_.difference(e.broadcastIDs,b),_.bind(function(e){S=this.handleBroadcastGet(null,e),S&&w.push(S)},this)),n.trigger("manatee:broadcastsInfo",w)}break;case"fetchBroadcastsInfoFromMetaSub":e&&e.broadcasts&&_.each(e.broadcasts,_.bind(function(e){this.handleBroadcastGet(e)},this));break;case"broadcastUsers":e&&e.broadcastID&&this.handleBroadcastUsers(e,e.broadcastID);break;case"userSelfMessage":O.userSelfMessage(e.message);break;case"selfMasterStatus":e&&e.status&&a.get("UserID")==e.userID&&a.currentMasterStatusDfd&&a.currentMasterStatusDfd.resolve(e.status);break;case"fetchSubsByTags":n.trigger("manatee:fetchSubsByTags",e.results);break;case"globalAlert":this.handleGlobalAlert(e.value)}},handlePublicBroadcastPublish:function(e,t){var r=n.Models.Broadcast.getLatestIncrementedCached(t),i=o.get("currentQueue");if(!r||i&&i.get("currentBroadcast")===r)return;var s=[],u=r.get("ownerUserIDs"),a=r.get("ArtistID"),f,l,c,h;if(e.publish.type==="latestMessages"){var p=r.get("chatActivities");if(p&&p.length)return;s=e.publish.value,r.set("chatEnabled",e.publish.chatEnabled)}else s=[e.publish];for(c=0,h=s.length;c<h;c++){f=s[c];if(f.type!=="data")continue;l=!1,f.id.hasOwnProperty("artistid")&&a&&a===_.toInt(f.id.artistid)?l=!0:f.id.hasOwnProperty("userid")&&_.indexOf(u,_.toInt(f.id.userid))>-1&&(l=!0);switch(f.value.type){case"chat":this.handleBroadcastChat(r,f);break;case"songAddedToHistory":l&&this.handleBroadcastNewHistorySong(t,f.value)}}},handleBroadcastGet:function(e,t){if(!t&&(!e||!e.BroadcastID))return;t=t||e.BroadcastID;var r=e.ownerUserIDs&&e.ownerUserIDs[0],i=n.Models.User.getCached(r);if(i&&!i.get("friendsLinked")){var s=i.get("currentBroadcastID");s>t&&s.split(":")[0]===t.split(":")[0]&&(console.log("Overwriting broadcastID we got back with newer one from broadcaster",t,s),t=s)}var o=n.Models.Broadcast.getLatestIncrementedCached(t);return e&&e.Name!==null?(e.activeStatus=e.ownerSubscribed===!1?0:1,o?(e.BroadcastID=o.id,o.updateFromSwf(e)):(e.lastUpdated=Date.now(),e.BroadcastID=t,o=new n.Models.Broadcast(e)),n.Models.Broadcast.restoreListenersFromCache(o)):o?o.cleanupOnEnd():n.Models.Broadcast.storeBroadcastNotFound(t),o},handleBroadcastUsers:function(e,r){var i=[],s={};_.each(e.users,function(e){if(!e||!e.userID||s[e.userID])return;if(e.r)return;i.push({FName:e.n,Picture:e.p,UserID:_.toInt(e.userID),friendsLinked:null,contextArtistID:_.toInt(e.artistID)||t}),s[e.userID]=1});var o=n.Models.Broadcast.getLatestIncrementedCached(r);if(o){o.setListeners(i),o.set("listenersCount",e.count);var u=p[r];if(!u){var a=r.split(":");a[1]&&(u=p[a[0]])}u&&(u=_.last(p[r],10),_.each(u,_.bind(this.handleBroadcastChat,this,o)),delete p[r])}else n.Models.Broadcast.storeListenersInCache(r,i,e.count)},onChatError:function(e){e&&e.source!=="broadcastDispatch:chat"&&e.error!=="no_auth"&&console.log("Got chat error, data:",e);if(e&&e.type)switch(e.type){case"noServersAvailable":case"identifiesOverThreshold":case"identifyFailed":this.chatDisconnected=!0,this.chatReconnecting=!1,this.onManateeDisconnected(),y();break;case"connectionDrop":case"connectTimeout":case"ioError":case"securityError":this.chatDisconnected=!0,this.chatReconnecting=!0,this.onManateeDisconnected(),y()}if(e&&e.error)switch(e.error){case"over_rate_limit":var t=o.get("currentQueue"),r=t?t.get("currentBroadcast"):null}e&&e.error&&e.source&&n.trigger("manatee:"+e.source,{success:!1,error:e.error})},onManateeDisconnected:function(){n.ready.done(function(){var e=o.get("isJoiningBroadcast");if(e){var t=n.Models.Broadcast.getCached(e),r=t?t.getOwner():null;r?n.router.setHash(r.toUrl("broadcast")):n.trigger("notification:add",{description:_.getString("POPUP_ERROR_BROADCAST_JOIN_ERROR"),type:"error",duration:5e3}),o.set("isJoiningBroadcast",!1)}else o.get("isCreatingBroadcast")&&n.router.setHash("broadcasts?down");n.trigger("manatee:disconnected")})},onChatUserChanged:function(e){n.trigger("manatee:change:user",e)},onActiveBroadcastEvent:function(e,t,r){var i,s;switch(t){case"started":this.handleBroadcastStarted(e,r);break;case"ended":this.handleBroadcastEnded(e,r);break;case"generalError":case"unrecoverableError":case"assertError":this.handleBroadcastError(e,t,r);break;case"propsUpdate":this.handleBroadcastPropsUpdate(e,r);break;case"listenerJoin":this.handleBroadcastListenerJoined(e,r);break;case"activeSongVote":this.handleBroadcastActiveSongVote(e,r);break;case"chatReceived":i=n.Models.Broadcast.getCached(e),i&&this.handleBroadcastChat(i,r);break;case"suggestionAction":i=n.Models.Broadcast.getCached(e),i&&i.handleSuggestionsAction(r);break;case"unhandledPublish":this.handleMiscBroadcastPublish(e,r);break;case"songListensUpdate":i=n.Models.Broadcast.getCached(e),i&&r&&r&&r.songID&&r.listens&&i.addHistoryListenCount(r.songID,_.toInt(r.listens));break;case"commandResult":this.handleMiscBroadcastCommandResult(e,r);break;case"newHistorySong":this.handleBroadcastNewHistorySong(e,r);break;case"deactivated":var u=o.get("currentQueue");if(u){var a=u.get("currentBroadcast");a&&a.id==e&&(u.set({currentBroadcast:null,isBroadcasting:!1}),o.get("isJoiningBroadcast")==e&&o.set("isJoiningBroadcast",!1))}break;case"serverMetadataChanges":i=n.Models.Broadcast.getCached(e),s=r&&r.changes,i&&s&&i.updateBroadcastDetails(s.Name||null,s.Tag||null,s.Description||null,null,null)}},handleBroadcastStarted:function(e,t){if(!t||!t.properties)return;t.properties.suggestions&&t.properties.suggestions.lastAction&&(t.properties.suggestions.lastAction=null);var i=n.Models.Broadcast.getCached(e),s=t.latestChatMessages,u=o.get("currentQueue"),f=u&&u.get("currentBroadcast");if(t.source=="takeOverBroadcast"&&f){f.unsubscribeAllFromChat(),i||(i=new n.Models.Broadcast({BroadcastID:e,activeStatus:1,ownerUser:a})),f.removeVIPUser(n.getLoggedInUserID()),f.removePersistentChatActivity("info",n.Models.ChatActivity.NEW_BROADCAST_OWNER),i.transferFromOldBroadcast(f,a),f.cleanupOnEnd(),i.subscribeToChat("queue");var l=f.getOwner();l&&(l.unsubscribeFromStatus("queue"),l.off("change:currentBroadcastID",this.onBroadcastOwnerCurrentIDChanged,this),l.storeCurrentBroadcast(0,e,i.get("Name"),i.get("Image"),a,!1,!0),O.broadcastRemoveOwner(l.get("UserID"),l.get("ArtistID"))),n.trigger("guts:log","broadcastTransferCompleted",{newBroadcastID:e,oldBroadcastID:f.get("BroadcastID"),newBroadcaster:!0})}else i?(t.properties.activeStatus=1,i.updateFromSwf(t.properties)):(t.properties.lastUpdated=Date.now(),t.properties.activeStatus=1,i=new n.Models.Broadcast(t.properties));var c=i.get("chatActivities");if(!c||!c.length)i.get("listenersLoaded")?(s=_.last(s,10),_.each(s,_.bind(this.handleBroadcastChat,this,i))):p[e]=s;if(t.isActive&&u){var h=t.isBroadcasting;u.set({isBroadcasting:t.isBroadcasting,currentBroadcast:i,repeatMode:n.Models.Player.repeatModes.NONE}),i.subscribeToChat("queue"),h?(a.storeCurrentBroadcast(1,e,i.get("Name"),i.get("Image"),i.getOwner(),!1,!0),a.clearLastBroadcast(),n.trigger("guts:log","broadcastStarted",{broadcastID:e}),n.trigger("guts:begincontext",{isBroadcasting:!0,autoplayID:e}),u&&u.get("clientRadioEnabled")&&u.get("clientRadio").disable()):(a.storeCurrentBroadcast(0,e,i.get("Name"),i.get("Image"),i.getOwner(),!1,!0),n.trigger("guts:log","broadcastJoined",{broadcastID:e}),n.trigger("guts:startNewAutoplayContext","broadcast",e),a.saveLocalSettings({recentBroadcasts:{BroadcastID:i.get("BroadcastID"),Image:i.get("Image"),Tag:i.get("Tag"),UserID:i.get("UserID")}})),a.storeBroadcastingLocally(i);if(!h){var d=i.get("ownerUserIDs"),v=n.Models.User.getCached(d[0]),m=n.Models.Artist.getCached(i.get("ArtistID")),g=new n.Models.ChatActivity({artist:m,user:!m&&v,type:"info",infoType:n.Models.ChatActivity.WELCOME_MESSAGE});i.newChatActivity(g);var y=i.getOwner();y&&(y.subscribeToStatus("queue"),!y.get("currentBroadcastID")==e&&a.storeCurrentBroadcast(1,e,i.get("Name"),i.get("Image"),null),y.on("change:currentBroadcastID",this.onBroadcastOwnerCurrentIDChanged,this)),E(a,a.get("sessionPrivacy"),{dontReport:!0})}n.trigger("manatee:startBroadcast",{success:!0,broadcast:i,created:h});var b=r.page.getCurrentPageView();(!t.token||t.token.source!="moveToNewBroadcast")&&(!b||!b.broadcastView||!b.broadcastView.broadcastID!=e)&&n.router.setHash(i.toUrl()),console.log("broadcastStart",e),n.Services.SWF.unsubscribeFromBroadcastsStatuses([e]),n.Models.Song.addCacheCallback(this.onSongCached,o),n.Models.User.addCacheCallback(this.onUserCached,this)}N(),o.set({isJoiningBroadcast:!1,isCreatingBroadcast:!1})},onSongCached:function(e,t){var r=o.get("currentQueue"),i=r?r.get("currentBroadcast"):null;i?i.handleSongCached(e,t):n.Models.Song.removeCacheCallbacks(o)},onUserCached:function(e,t){var r=o.get("currentQueue"),i=r?r.get("currentBroadcast"):null;i?i.handleUserCached(e,t):n.Models.User.removeCacheCallbacks(o)},handleBroadcastError:function(e,t,r){if(t=="assertError"){console.log("Broadcast: Assert Error: ",r);return}var i=e?n.Models.Broadcast.getCached(e):null,s="POPUP_ERROR_BROADCAST_UNKNOWN",o=0,u={};switch(r.error){case"createBroadcastFailed":case"initialUpdateFailed":n.trigger("manatee:startBroadcast",{success:!1,error:r.error});return;case"subJoinFailed":if(r.source!="joinBroadcast"){n.trigger("manatee:broadcast:subJoinFailed",{success:!1,error:r.error});return}s="POPUP_ERROR_BROADCAST_UNKNOWN";break;case"broadcastServerDrop":s="POPUP_ERROR_BROADCAST_SERVER";break;case"noChatServersAvailable":s="POPUP_ERROR_BROADCAST_SERVER",this.chatDisconnected=!0;break;case"suggestionVerificationFailed":if(!i)return;var a=i.get("suggestions"),f;r.result.realSong?(s="POPUP_ERROR_BROADCAST_SUGGESTION_BAD",f=a.get(r.result.realSong.SongID),f&&n.Models.Song.replaceCacheAttributes(f._wrapped,r.result.realSong)):r.result.asSuggested&&(s="POPUP_ERROR_BROADCAST_SUGGESTION_FAILED",f=a.get(r.result.asSuggested.SongID)),f&&f.set("approvalStatus",0),o=7e3;break;case"renameForTakeOverFailed":s="ERROR_BROADCAST_TRANSFER_OWNERSHIP",o=7e3,n.trigger("broadcast:renameForTakeOverFailed")}if(c&&c===r.error)return;c=r.error,n.trigger("notification:add",{description:_.getString(s,u),type:"error",duration:o,initFunc:function(e){e.errorDetails=r.error,h.push(e)}})},handleBroadcastPropsUpdate:function(e,t){if(!t||!t.properties)return;var r=n.Models.Broadcast.getCached(e);if(!r)return;var i=o.get("currentQueue"),s=i?i.get("currentBroadcast"):null,u=s===r,f=r.get("activeSong");u?(t.properties.ownerSubscribed===!1?r.startOwnerLeftTimer():t.properties.ownerSubscribed===!0&&r.stopOwnerLeftTimer(!0),N(),i.get("isBroadcasting")&&t.properties.playbackStatus&&a.storeBroadcastingLocally(r)):t.properties.ownerSubscribed===!1&&(t.properties.activeStatus=0);var l=t.properties.suggestions;r.updateFromSwf(t.properties,u),l&&(l.lastAction&&r.handleSuggestionsAction(l.lastAction),r.cleanupSuggestionsCache());var c=r.get("activeSong");if(c){(!f||c!==f)&&r.newChatActivity(new n.Models.ChatActivity({type:"info",infoType:"songChange",song:c}));var p=r.get("activeSongStatus");if(p>n.Models.Player.playStatuses.NONE&&p<n.Models.Player.playStatuses.FAILED&&h.length)for(var d=0;d<h.length;d++)if(h[d]&&h[d].errorDetails&&h[d].errorDetails==="broadcastSongStopListener"){h.splice(d,1);break}}},handleBroadcastListenerJoined:function(e,t){var r,i=n.Models.Broadcast.getCached(e),s;if(!t||!i||!i.get("listenersLoaded"))return;if(t.userID&&t.extra){if(t.extra.r){r=n.Models.User.getCached(t.userID),r&&r.set("restricted",!0);return}r=n.Models.User.newOrUpdate({FName:t.extra.n,Picture:t.extra.p,UserID:_.toInt(t.userID)},{dontCache:!0})}else if(t.userID){r=n.Models.User.getCached(t.userID);if(r&&r.get("restricted"))return;if(!r){var o=i.get("listeners");o&&(r=o.get(t.userID))}}else if(t.extra&&t.extra.n==="Anonymous")return;t.joined?i.newListener(r):i.listenerLeft(r)},handleBroadcastActiveSongVote:function(e,t){var r=n.Models.Broadcast.getCached(e);if(!t||!t.userID||!r)return;var i=r.get("activeSong"),s=_.toInt(t.userID)+"";if(i&&i.get("queueSongID")===t.queueSongID){var o=t.vote,u=i.get("upVotes"),a=i.get("downVotes"),f;o>0?(f=_.indexOf(u,s),f===-1&&(f=_.indexOf(a,s),f>-1&&a.splice(f,1),u.push(s))):t.vote<0?(f=_.indexOf(a,s),f===-1&&(f=_.indexOf(u,s),f>-1&&u.splice(f,1),a.push(s))):(f=_.indexOf(u,s),f>-1&&u.splice(f,1),f=_.indexOf(a,s),f>-1&&a.splice(f,1)),i.trigger("change"),t.userID==n.getLoggedInUserID()&&i.set("userVote",o),r.activeVotesChanged()}},handleMiscBroadcastPublish:function(e,t){var r=n.Models.Broadcast.getCached(e),i=o.get("currentQueue");switch(t.type){case"inviteNewBroadcaster":if(t&&t.trusted&&r){var s=r.getOwner();n.trigger("lightbox:open","broadcastTransferOwnership",{owner:s,broadcast:r,receivingTransfer:!0}),n.Services.SWF.currentBroadcastPrivateDispatch("receivedTransferInvite",{receivedUserID:n.getLoggedInUserID()},s.get("UserID"))}break;case"newBroadcasterResponse":t&&t.userID&&t.trusted&&i&&i.get("isBroadcasting")&&r&&(t.data&&t.data.accept&&r.set("pendingOwnerUserID",t.userID),n.trigger("manatee:newBroadcasterResponse",t));break;case"receivedTransferInvite":t&&t.userID&&t.trusted&&i&&i.get("isBroadcasting")&&n.trigger("broadcast:takeoverRequestAck",t);break;case"upcomingQueueForTakeover":t&&t.trusted&&n.trigger("broadcast:upcomingQueueForTakeover",e,t);break;case"renameForTakeOverFailed":t&&t.trusted&&t.userID&&n.trigger("broadcast:renameForTakeOverFailed",t);break;case"userInfoUpdate":if(t.data&&t.data.users){var u,a=r.get("listeners");_.each(t.data.users,function(e,t){if(!e)return;u=n.Models.User.getCached(t)||a&&a.get(t);if(!u)return;e.r?u.set("restricted",!0):u.updateFromNew({FName:e.n,Picture:e.p})})}break;case"vipRequestResponse":t.data&&t.data.resultKey&&r&&r.handleVIPRequestResponse(t.data)}},handleMiscBroadcastCommandResult:function(e,t){var r=n.Models.Broadcast.getCached(e);switch(t.command){case"suggestion":n.trigger("broadcast:suggestionResult:"+t.songID,t);break;case"chat":_.defined(t.success)&&!t.success&&n.trigger("guts:log","broadcastChatFailed",{broadcastID:e,error:t.error});if(t.error=="rateLimited")r&&!r.get("rateLimited")&&(r.set("rateLimited",!0),r.addPersistentChatActivity(new n.Models.ChatActivity({type:"info",infoType:n.Models.ChatActivity.RATE_LIMITED})),setTimeout(function(){r.set("rateLimited",!1),r.removePersistentChatActivity("info",n.Models.ChatActivity.RATE_LIMITED)},3e3));else{var i=r?r.get("bannedUserIDs"):{};if(!t.success&&r&&t.error=="no_auth"&&i&&i[n.getLoggedInUserID()]){t.extraData&&t.extraData.message&&this.handleBroadcastChat(r,{data:t.extraData.message,id:{userid:n.getLoggedInUserID()}});return}n.trigger("broadcast:chatResult",t)}break;case"broadcastAddPublisher":n.trigger("manatee:"+t.source,t);break;case"transferredBroadcast":this.handleTransferredBroadcast(e,t);break;case"vipRequest":t.resultKey&&n.trigger("manatee:"+t.resultKey,t)}},handleTransferredBroadcast:function(e,t){var i=n.Models.Broadcast.getCached(e),s=o.get("currentQueue");if(s&&s.get("currentBroadcast")!==i)return;var u=t.newBroadcastID,f=i.get("pendingNewOwner"),l=new n.Models.Broadcast({BroadcastID:u,activeStatus:1,ownerUser:f}),c=s.get("isBroadcasting"),h=i.getOwner();h&&(h.unsubscribeFromStatus("queue"),h.off("change:currentBroadcastID",this.onBroadcastOwnerCurrentIDChanged,this)),t.newUserID&&(!f||f.get("UserID")!=t.newUserID)&&(f=i.get("listeners").get(t.newUserID)),i.unsubscribeAllFromChat(),l.transferFromOldBroadcast(i,f),i.cleanupOnEnd(),l.subscribeToChat("queue"),s.set({currentBroadcast:l,isBroadcasting:!1}),a.storeCurrentBroadcast(0,u,l.get("Name"),l.get("Image"),f,!1,!0);if(f){f.storeCurrentBroadcast(1,u,l.get("Name"),l.get("Image"),null,!1,!0);var p={u:!0,n:f.get("Name"),i:f.id,p:f.get("Picture")};O.updateCurrentBroadcastOwnerInfo(p),l.removePersistentChatActivity("info",n.Models.ChatActivity.NEW_BROADCAST_OWNER),l.addPersistentChatActivity(new n.Models.ChatActivity({type:"info",infoType:n.Models.ChatActivity.NEW_BROADCAST_OWNER,owner:f,closeable:!0})),f.subscribeToStatus("queue"),f.on("change:currentBroadcastID",this.onBroadcastOwnerCurrentIDChanged,this)}c&&a.storeBroadcastingLocally();var d=r.page.getCurrentPageView();d&&d.broadcastView&&d.broadcastView.broadcastID===i.get("BroadcastID")&&n.router.setHash(l.toUrl()),n.trigger("manatee:broadcastTransferred",l,i),c&&n.trigger("guts:log","broadcastTransferCompleted",{newBroadcastID:t.newBroadcastID,oldBroadcastID:e,newBroadcaster:!1})},handleBroadcastNewHistorySong:function(e,t){if(!t||!t.newSong)return;var r=n.Models.Broadcast.getCached(e);if(!r)return;var i={newHistorySong:t.newSong,totalListens:t.totalListens};r.updateFromSwf(i)},onActiveBroadcastLog:function(e,t){console.log("Broadcast Log: ("+e+") "+t.log)},onChatResult:function(e,t){t&&t.blackbox&&t.blackbox.source&&n.trigger("manatee:"+t.blackbox.source,t)},onChatSubUpdate:function(e){if(!e||!e.broadcastID||!e.properties)return;e.publicChannel&&delete e.properties.publisherUserIDs,e.properties.hasOwnProperty("ownerSubscribed")&&(e.properties.activeStatus=e.properties.ownerSubscribed===!1?0:1);var t=n.Models.Broadcast.getLatestIncrementedCached(e.broadcastID);t&&t.updateFromSwf(e.properties)},handleBroadcastEnded:function(e,t){var r=o.get("currentQueue");if(!r)return;console.log("Broadcast ended!",t);var i=n.Models.Broadcast.getCached(e),s=i&&i.attributes.suggestions,u=i&&i.get("Tag"),f=r.get("isBroadcasting");a.storeCurrentBroadcast(0,null);var l=i&&i.getOwner();l&&!f&&(l.unsubscribeFromStatus("queue"),l.off("change:currentBroadcastID",this.onBroadcastOwnerCurrentIDChanged,this)),n.Models.Song.removeCacheCallbacks(o);if(f){if(!i||t.source==="error"||t.source==="unknown"){i&&i.cleanupOnEnd(!0),N();if(this.chatDisconnected){n.trigger("notification:add",{title:_.getString("POPUP_BROADCAST_ENDED"),description:_.getString("POPUP_ERROR_BROADCAST_RETRY"),type:"error",duration:0,initFunc:function(e){h.push(e)}});var c;c=setInterval(_.bind(function(){if(!this.chatDisconnected)clearInterval(c);else{var e=o.get("currentQueue");!e||e.get("currentBroadcast")!==i?clearInterval(c):(this.chatReconnecting=!0,this.reconnectToChat())}},this),(4+Math.random()*4)*1e3)}else n.trigger("notification:add",{title:_.getString("POPUP_BROADCAST_ENDED"),description:_.getString("POPUP_ERROR_BROADCAST_UNKNOWN_ENDED"),type:"error",duration:0,initFunc:function(e){h.push(e)}})}else{var d=!1;t.source=="createdAnotherViaMaster"?(n.trigger("notification:add",{title:_.getString("POPUP_BROADCAST_ENDED"),description:_.getString("POPUP_ERROR_BROADCAST_ANOTHER_CREATED"),duration:0}),i.unsubscribeFromChat("queue")):t.source=="resumeViaMaster"?(n.trigger("notification:add",{title:_.getString("POPUP_BROADCAST_ENDED"),description:_.getString("POPUP_ERROR_BROADCAST_RESUMED"),duration:0}),i.unsubscribeFromChat("queue"),d=!0):t.source=="termination"?(n.trigger("notification:add",{title:_.getString("POPUP_BROADCAST_ENDED"),description:_.getString("POPUP_ERROR_BROADCAST_KILLED"),duration:0}),i.unsubscribeAllFromChat()):i.unsubscribeAllFromChat(),i.cleanupOnEnd(d),a.storeBroadcastingLocally()}n.trigger("guts:log","broadcastEnded",{broadcastID:t.broadcastID}),n.trigger("guts:endcontext","isBroadcasting"),n.trigger("guts:endcontext","autoplayID")}else if(i&&t.source==="user")i.unsubscribeFromChat("queue"),i.listenerLeft(a),i.cleanupOnEnd(i.get("ownerSubscribed")),n.Services.SWF.clearQueue(),n.trigger("guts:log","broadcastLeft",{broadcastID:t.broadcastID}),n.trigger("guts:clearAllAutoplayContexts");else if(i&&t.source==="joinedAnother")i.unsubscribeAllFromChat(),i.listenerLeft(a),i.cleanupOnEnd(i.get("ownerSubscribed")),n.trigger("guts:log","broadcastLeft",{broadcastID:t.broadcastID}),n.trigger("guts:clearAllAutoplayContexts");else if(!i||t.source==="error"||t.source==="unknown")N(),this.chatDisconnected||!i?n.trigger("notification:add",{title:_.getString("POPUP_BROADCAST_ENDED"),description:_.getString("POPUP_ERROR_BROADCAST_SERVER"),type:"error",duration:0,initFunc:function(e){h.push(e)}}):(i.unsubscribeAllFromChat(),i.listenerLeft(a),i.cleanupOnEnd(!0),n.trigger("notification:add",{title:_.getString("POPUP_BROADCAST_ENDED"),description:_.getString("POPUP_ERROR_BROADCAST_SERVER"),type:"error",duration:0,initFunc:function(e){h.push(e)}}),O.getBroadcastInfo(i.get("BroadcastID")),n.trigger("guts:log","broadcastLeft",{broadcastID:t.broadcastID,reason:t.source}),n.trigger("guts:clearAllAutoplayContexts"));else{i&&i.cleanupOnEnd();var v=!1;if(t&&t.source=="owner"&&t.extra&&t.extra.nBcast&&i){var m=r.get("currentBroadcast");m===i?(v=!0,n.Models.Broadcast.fetchRealtimeBroadcast(t.extra.nBcast).always(_.bind(function(e){if(e&&e.get("activeStatus")>0){var n=e.get("BroadcastID"),r=e.getOwner();r&&r.storeCurrentBroadcast(1,n,e.get("Name"),e.get("Image")),a.joinBroadcast(e.get("BroadcastID"),r,"moveToNewBroadcast").fail(_.bind(function(n){if(n===4)return;this.handleOwnerEndedBroadcast(e,s,u,t.extra)},this))}else this.handleOwnerEndedBroadcast(e,s,u,t.extra)},this))):o.get("isJoiningBroadcast")==t.extra.nBcast&&(v=!0)}!v&&i&&this.handleOwnerEndedBroadcast(i,s,u,t.extra),p[t.broadcastID]&&delete p[t.broadcastID]}n.trigger("manatee:broadcastEnded",{success:!0,broadcastID:t.broadcastID})},handleOwnerEndedBroadcast:function(e,t,i,s){var u=o.get("currentQueue");if(!u||!e)return;n.trigger("lightbox:open","broadcastEnded",{broadcast:e});var a=s&&s.s?s.s:[],f=new n.Models.Collections.Songs(a,{modelOptions:{dontCache:!0}});f=n.Models.Queue.shuffleSongsForRadio(f),t&&t.length&&(t=n.Models.Queue.shuffleSongsForRadio(t),f.add(t.models));var l=u.get("clientRadio"),c=!1;l.extraStreamFlags=n.Models.PlayContext.TYPE_BROADCAST,l.reset(f.models).enable(),l.onActiveSongChange(u,u.get("activeSong"),{}),l.on("needSongs",function(e,t){function r(){e.switchToAutoplay({secondaryArtistWeightModifier:.7,seedArtistWeightRange:[75,100],weightModifierRange:[-14,9]}),n.trigger("guts:startAutoplayFallbackContext","autoplay",0)}c||!i||!i.i?r():(c=!0,n.Models.Tag.get(i.i).done(_.bind(function(t){t.getSongs().done(function(t){t&&t.length?(t=n.Models.Queue.shuffleSongsForRadio(t),e.extraStreamFlags=0,e.add(t.models),n.trigger("guts:startAutoplayFallbackContext","tag",i.i)):r()})},this)))}),f.length&&n.trigger("guts:startAutoplayFallbackContext","broadcast",e.get("BroadcastID"),"song",f.pluck("SongID").toString());var h=r.page.getCurrentPageView();h&&h.broadcastView&&h.broadcastView.broadcastID===e.get("BroadcastID")&&n.router.setHash("broadcasts")},handleBroadcastChat:function(e,t){var i=_.orEqual(t.userID,t.id?t.id.userid:0),s=_.orEqual(t.artistID,t.id?t.id.artistid:0);if(i<1)return;!t.data&&t.value&&(t=t.value);if(e){var o=s?n.Models.Artist.getCached(s):null,u=e.get("listeners"),a=!o&&(u&&u.get(i)||n.Models.User.getCached(i));(a||o)&&e.newChatActivity(new n.Models.ChatActivity({user:a,artist:o,message:t.data,type:"message",ignoreTag:t.ignoreTag}));var f=r.page.getCurrentPageView();(!f||!f.broadcastView||f.broadcastView.model.get("broadcast")!==e)&&n.trigger("broadcast:notifEvent",e)}},onBroadcastOwnerCurrentIDChanged:function(e,t){var n=o.get("currentQueue"),r=n?n.get("currentBroadcast"):null;n&&t&&r&&e.get("isOwnerOfCurrentBroadcast")&&n.get("currentBroadcast")&&r.get("BroadcastID")!==t&&a.joinBroadcast(t,e,"moveToNewBroadcast")},onChatSelfChannelJoinAlert:function(){a.set("shouldSyncUserContent",!0),d&&clearTimeout(d)},userSelfMessage:function(e){if(!e||!e.type)return;switch(e.type){case"logout":e.sessionPart==n.Services.API.sessionPart&&n.getLoggedInUserID()>0&&r.model.logout(!0);break;case"queueTransferResponse":n.trigger("manatee:self:queueTransferResponse",e.params);break;case"userContentSync":a.handleUserContentSync(e.params);break;case"statusReply":a.set("shouldSyncUserContent",!0),d&&clearTimeout(d);break;case"statusUpdate":if(e.params){var t=e.params,i=a.get("UserID"),s={onlineStatus:_.toInt(t.status)};t.bcast&&s.onlineStatus?$.extend(s,a.storeCurrentBroadcast(_.toInt(t.bcastOwner),t.bcast,t.bcastName,t.bcastPic,t.bcastOwnerInfo,!0,!0)):(a.attributes.currentBroadcastID||typeof a.attributes.currentBroadcastID=="undefined")&&$.extend(s,a.storeCurrentBroadcast(0,null,null,null,null,!0,!0)),t.status&&t.song&&t.song.SongID?s.nowPlayingSong=n.Models.Song.newOrUpdate(t.song,{dontCache:!0}):s.nowPlayingSong=null,s.currentBroadcastOwner&&(!s.currentBroadcastOwner.statusSubLocks||!s.currentBroadcastOwner.statusSubLocks[0])&&s.currentBroadcastOwner.set({nowPlayingSong:s.nowPlayingSong}),s.onlineStatus||(s.nowPlayingSong=null),a.set(s);var o=n.Models.User.getUserStatusDfds[i];o&&o.state()=="pending"&&o.resolve(t,i)}}},handleGlobalAlert:function(e){if(!e||!e.messageType)return;if(e.test&&gsConfig.runMode=="production"){console.log("Ignoring test globalAlert message");return}switch(e.messageType){case"message":if(e.id){if(v){if(v.outageType==e.messageType&&v.outageID==e.id&&e.id!="RAW")return;n.trigger("notification:close",v)}var t="",r={},i=0,s=0,o=a.get("isLoggedIn"),u;switch(e.id){case-1:case"CLEAR":v&&n.trigger("notification:close",v);break;case 1:case"DATABASE_GOING_DOWN":r.duration=60,e.params.duration&&(s=e.params.duration*60*1e3),t="DATABASE_GOING_DOWN";break;case 2:o&&(t="PLAYLISTS_DOWN");break;case 3:case"NEW_VERSION_ALERT":if(!e.params||!e.params.minVersion||e.params.minVersion>gsConfig.revision)t="NEW_VERSION_ALERT",u=Math.max(15,_.toInt(_.orEqual(e.params&&e.params.delay,60))),i=Math.floor(Math.random()*u*60*1e3);break;case"BROADCASTS_UPGRADED":if(!e.params||!e.params.minVersion||e.params.minVersion>gsConfig.revision)t="BROADCASTS_UPGRADED",u=Math.max(15,_.toInt(_.orEqual(e.params&&e.params.delay,60))),i=Math.floor(Math.random()*u*60*1e3);break;case 4:case"BROADCASTS_DOWN":r.duration=15,e.params.duration&&(s=e.params.duration*60*1e3),t="BROADCASTS_DOWN";break;case 5:t="STREAMS_DOWN";break;case 6:t="INTERMITTENT_DOWN";break;case 7:o&&(t="NOTIFICATIONS_DOWN");break;case 8:t="UPLOADS_DOWN";break;case 9:case"ARTISTS_DOWN":var f=a.get("artistsOwned");f&&f.length&&(t="ARTISTS_DOWN");break;case"BROADCASTS_DOWN_LATER_MINS":r.duration=15,e.params.duration&&(s=e.params.duration*60*1e3),t="BROADCASTS_DOWN_LATER_MINS";break;case"BROADCASTS_DOWN_LATER_HOURS":r.duration=2,e.params.duration&&(s=e.params.duration*60*60*1e3),t="BROADCASTS_DOWN_LATER_HOURS";break;case"PLANNED_MAINTENANCE_MINS":r.duration=15,e.params.duration&&(s=e.params.duration*60*1e3),t="PLANNED_MAINTENANCE_MINS";break;case"PLANNED_MAINTENANCE_HOURS":r.duration=2,e.params.duration&&(s=e.params.duration*60*60*1e3),t="PLANNED_MAINTENANCE_HOURS";break;case"LOGIN_ISSUES":o||(t=e.id);break;case"PLAYLIST_ISSUES":case"COLLECTION_FAVORITES_ISSUES":case"NOTIFICATIONS_DOWN":case"PLAYLISTS_DOWN":o&&(t=e.id);break;case"UPLOADS_DOWN":case"INTERMITTENT_DOWN":case"STREAMS_DOWN":case"BROADCASTS_ISSUES":case"TAGS_ISSUES":case"POPULAR_ISSUES":case"RAW":t=e.id}s?s=Math.max(s,Math.min(5*s,432e5)):s=432e5;if(!t)return;var l;if(t=="RAW"){if(!e.params.text)return;l=_.escape(e.params.text)}else l=_.getString(t,$.extend(r,e.params));var c=function(){n.trigger("notification:add",{description:l,type:"error",duration:s,initFunc:function(t){v=t,t.outageType=e.messageType,t.outageID=e.id},closeAction:function(){v&&v.outageType==e.messageType&&v.outageID==e.id&&(v=null)}})};i>0?setTimeout(c,i):c()}break;case"manateeGoingDown":v||n.trigger("notification:add",{description:_.getString("MANATEE_GOING_DOWN"),type:"error",duration:0,initFunc:function(t){v=t,t.outageType=e.messageType},closeAction:function(){v&&v.outageType==e.messageType&&(v=null)}})}},togglePlay:function(e){var t=n.Models.Player.playStatuses,r=o.get("playStatus"),i=o.get("currentQueue"),s=i?i.get("activeSong"):!1,u=i?i.get("isBroadcasting"):!1;if(e&&(!s||e!==s.get("queueSongID"))){if(u){var a=i.get("songs").get(e),f=i.get("songs");if(s&&f.indexOf(a)!=f.indexOf(s)+1){n.trigger("lightbox:open","previewSong",{index:this.playSpecialIndexes.NEXT,fromQueue:!0,songs:[a],_showPlayerControls:!0});return}}this.playSong(e)}else switch(r){case t.PAUSED:this.resumeSong();break;case t.INITIALIZING:case t.LOADING:case t.BUFFERING:case t.PLAYING:this.handlePauseSong();break;default:this.playSong()}},handlePauseSong:function(){var e=o.get("currentQueue");if(e&&e.get("isBroadcasting")){var t=e.get("currentBroadcast");if(t&&t.get("listenersCount")>1&&!t.get("allowPauseSkip")){n.trigger("lightbox:open","broadcastPauseSkip",{broadcast:t,confirmType:"PAUSE",callback:_.bind(this.pauseSong,this)});return}}this.pauseSong()},toggleVolumeMute:function(e){e=_.isUndefined(e)?!o.get("isMuted"):e,this.preLockMuteValue=e,o.set("isMuted",e),_.isEmpty(this.muteLocks)&&this.setIsMuted(e)},toggleShuffle:function(e){var e=typeof e=="undefined"?!this.getShuffle():e;this.setShuffle(e)},toggleRepeat:function(){var e=o.get("currentQueue"),t=n.Models.Player.repeatModes,r=e?o.get("currentQueue").get("repeatMode"):null;r==t.NONE?this.setRepeat(t.ALL):r==t.ALL?this.setRepeat(t.ONE):this.setRepeat(t.NONE)},toggleCrossfade:function(e){var t=typeof e=="undefined"?!this.getCrossfadeEnabled():!!e;t?a.get("subscription").canUsePlayerBonuses()?this.setCrossfadeEnabled(!0):n.trigger("lightbox:open","vipOnlyFeature",{onLogin:function(){n.trigger("player:crossfade",!0)}}):this.setCrossfadeEnabled(!1)},changeVolume:function(e){e=_.orEqual(e,0),this.preLockVolume=e,o.set("volume",e),_.isEmpty(this.muteLocks)&&this.setVolume(e)},playNextSong:function(e){e=_.orEqual(e,!1);var t=_.bind(function(){this.nextSong(),o.set({expectManualSongChange:!0})},this),r=o.get("currentQueue");if(r&&r.get("isBroadcasting")){var i=r.get("currentBroadcast");if(i&&i.get("listenersCount")>1&&!i.get("allowPauseSkip")&&!e){n.trigger("lightbox:open","broadcastPauseSkip",{broadcast:i,confirmType:"SKIP",callback:t});return}}t()},playPreviousSong:function(e){this.previousSong(e),o.set({expectManualSongChange:!0})},radioClearQueue:function(e){var t=o.get("currentQueue"),r=!1,i=function(){var i=function(){if(r)return;r=!0,o.off("change:currentQueue",i),t.off("change",i),e()};n.Services.SWF.stopSong(),n.Services.SWF.clearQueue(),o.on("change:currentQueue",i),t.on("change",i)};n.trigger("lightbox:open","radioClearQueue",{startRadio:i,inBroadcast:!!t.get("currentBroadcast")})},toggleAutoplay:function(e,r,i,s,u){function f(){this.setAutoplay(!0,r,i,s);var e=a.get("songs").pluck("SongID").toString(),o=r?"oldTag":"autoplay",u=r?r:0,f=i&&i.seeds?"artist":r?t:"song",l=i&&i.seeds?i.seeds.toString():r?t:e;n.trigger("guts:startAutoplayFallbackContext",o,u,f,l),n.trigger("guts:gatrack","player","autoplayOn","queue",a.get("songs").length),r?n.trigger("guts:forcelog","autoplayOn",{tagID:u,autoplayType:"oldTag"}):n.trigger("guts:forcelog","autoplayOn",{tagID:0,autoplayType:"autoplay",autoplaySeedSongs:e})}var a=o.get("currentQueue");if(n.isBroadcaster()){n.trigger("notification:add",{title:_.getString("POPUP_NO_RADIO_WHILE_BROADCASTING"),type:"error"});return}e=_.orEqual(e,!a.get("autoplayEnabled")),r=_.orEqual(r,0),i=_.orEqual(i,null),s=_.orEqual(s,null);if(e)(r>0||i)&&a.get("songs")&&a.get("songs").length&&!u?this.radioClearQueue(_.bind(f,this)):a.get("currentBroadcast")&&!u?this.radioClearQueue(_.bind(f,this)):f.call(this);else{this.setAutoplay(!1);var l=a.get("clientRadio");l&&l.disable(),n.trigger("guts:gatrack","player","autoplayOff"),n.trigger("guts:forcelog","autoplayOff",{}),n.trigger("guts:clearAllAutoplayContexts")}},startRadioWithSongs:function(e,t){function i(){n.Services.SWF.addSongs(e,n.Services.SWF.playSpecialIndexes.REPLACE,!0,t,!0);var r="autoplay",i=0,s="song",o=e[0].hasOwnProperty("attributes")?(new Backbone.Collection(e)).pluck("SongID").toString():e.toString();n.trigger("guts:startAutoplayFallbackContext",r,i,s,o),n.trigger("guts:gatrack","player","autoplayOn","queue",e.length),n.trigger("guts:forcelog","autoplayOn",{tagID:0,autoplayType:"autoplay",autoplaySeedSongs:o})}t=t||{};var r=o.get("currentQueue");if(n.isBroadcaster()){n.trigger("notification:add",{title:_.getString("POPUP_NO_RADIO_WHILE_BROADCASTING"),type:"error"});return}r&&(r.get("songs")&&r.get("songs").length||r.get("currentBroadcast"))?this.radioClearQueue(_.bind(i,this)):i.call(this)},setAutoplayVote:function(e,t){var r=o.get("currentQueue");if(r){var i=r.get("clientRadioEnabled");if(i||r.get("autoplayEnabled"))this.voteSong(e,t),i&&r.get("clientRadio").voteSong(e,t)}t<0?(n.trigger("guts:gatrack","player","frown","queueSongID",e),n.trigger("guts:log","songDownVoted",{queueSongID:e,songID:r.get("songs").models[e-1].get("SongID")})):t>0&&(n.trigger("guts:gatrack","player","smile","queueSongID",e),n.trigger("guts:log","songUpVoted",{queueSongID:e,songID:r.get("songs").models[e-1].get("SongID")}))},flagQueueSong:function(e,t){this.flagSong(e,t),n.trigger("notification:add",{title:"",description:_.getString("SUCCESS_FLAG_SONG"),url:""})},handleClearQueue:function(){var e=o.get("currentQueue");n.trigger("guts:gatrack","player","clearQueue"),n.trigger("guts:log","clearQueue"),(!e||!e.get("isBroadcasting"))&&n.trigger("guts:clearAllAutoplayContexts"),e&&e.get("clientRadioEnabled")&&e.get("clientRadio").disable(),this.clearQueue()},initReconnect:function(){this.chatDisconnected&&!this.chatReconnecting&&(n.Services.SWF.reconnectToChat(),this.chatReconnecting=!0)},handleManateeReconnected:function(){}}}(),function(){n.Services=n.Services||{};var i=[{targetRange:[0,.1],dateRange:["2013-01-23","2013-01-29"],name:"Interleaving_HTP4PopArtist_HTP4",groups:["0"]},{targetRange:[.1,.2],dateRange:["2013-07-01","2013-07-08"],name:"guts-json",groups:["0"]},{targetRange:[.4,.9],dateRange:["2013-03-05","2013-03-13"],name:"paymentsPopup",groups:[0,1]}],s=6048e5,o;n.Services.GUTS={shouldLog:!1,server:"/guts",appID:"html",context:!1,debug:!1,abTest:null,bufferLength:10,localLogs:[],canLogStats:Math.random()>=.5,localStats:[],statsTimer:0,lastStatsTime:0,lastUserChangeTime:0,searchClickLpid:"searchClick",loggedNormally:!1,eligibleForABTest:!1,abTestBucket:null,currentTest:null,currentGroup:null,loggingStatusExpirationDate:null,init:function(e){o=e,this.context={},this.server=_.orEqual(gsConfig.gutsServer,!1),this.setLoggingStatus(),this.debug=gsConfig.runMode!=="production",this.createdAt=Date.now(),this.debug&&(this.bufferLength=1,this.shouldLog=!0),this.currentPage={},this.currentPage.pageType="home",this.currentPage.section="",this.currentPage.subpage="",this.currentPage.id="",gsConfig.isPreview&&(this.appID="preview",this.shouldLog=!0);var t=_.browserDetect(),r=o.get("user");this.beginContext({version:"jawharp"}),this.gaSetCustomVariable(4,"misc","V:JH02"),this.beginContext({sessionID:gsConfig.sessionID}),this.beginContext({initTime:(new Date).getTime()}),this.beginContext({country:gsConfig.country.ID});if(r.id>0){var i=r.get("subscription").getTypeString().length?r.get("subscription").getTypeString():!1;this.beginContext({userID:r.id}),i&&this.beginContext({subscription:i}),o.get("user").get("Flags")&n.Models.User.FLAG_OWNS_ARTIST&&this.beginContext({hasArtists:!0})}this.gaSetCustomVariable(1,"User",o.get("user").getUserStringForAnalytics()),o.on("change:user",this.onUserChange,this),this.logEvent("init",{browser:t.browser,browserVersion:t.version,os:navigator.platform,ip:gsConfig.remoteAddr,locale:o.get("locale")}),n.on("change:page",this.handlePageLoad,this),n.on("player:restore",this.handlePlayerRestoreQueue,this),n.on("api:stats",this.handleAPIStats,this),$(document).click(_.bind(function(e){if(Math.random()<.001){var t=$(e.target.outerHTML).html("").get(0).outerHTML;this.logEvent("globalClick",{outerHTML:t})}},this)),this.onShouldLogChange(),n.on("guts:log",this.onLog,this),n.on("guts:gatrack",this.onGaTrack,this),n.on("guts:logsearch",this.onLogSearch,this),n.on("guts:forcelog",this.onForceLog,this),n.on("guts:begincontext",this.onBeginContext,this),n.on("guts:endcontext",this.onEndContext,this),n.on("guts:startNewAutoplayContext",this.onStartNewAutoplayContext,this),n.on("guts:startAutoplayFallbackContext",this.onStartAutoplayFallbackContext,this),n.on("guts:clearAllAutoplayContexts",this.onClearAllAutoplayContexts,this),n.on("guts:handleFieldClick",this.onHandleFieldClick,this),n.on("guts:gaSetCustomVariable",this.onGaSetCustomVariable,this)},onShouldLogChange:function(){if(!n.Services.API||!this.canLogStats)return;this.shouldLog?(n.Services.API.collectStats=!0,this.statsTimer||(this.statsTimer=setInterval(_.bind(this.sendStats,this),1e4))):(this.localStats=[],n.Services.API.collectStats=null,clearTimeout(this.statsTimer),this.statsTimer=0)},onUserChange:function(){var e=o.get("user"),t=_.defined(this.context.userID),r=_.defined(this.context.subscription),i=_.defined(this.context.hasArtists),s=e.get("subscription").getTypeString().length?e.get("subscription").getTypeString():!1,u=e.id;t&&this.endContext("userID"),r&&this.endContext("subscription"),i&&this.endContext("hasArtists");if(u>0){var a=_.browserDetect(),f={userID:u,browser:a.browser,browserVersion:a.version,os:navigator.platform,ip:gsConfig.remoteAddr};s&&(f.subscription=s),this.logEvent("login",f),this.beginContext({userID:u}),s&&this.beginContext({subscription:s}),e.get("Flags")&n.Models.User.FLAG_OWNS_ARTIST&&this.beginContext({hasArtists:!0})}else t&&this.logEvent("logout",{});this.gaSetCustomVariable(1,"User",e.getUserStringForAnalytics()),this.lastUserChangeTime=(new Date).getTime()},setLoggingStatus:function(){var e=new Date,t=n.Services.Local,r,o,u,a,f=t.get("currentTest"),l=t.get("currentGroup");if(f){r=t.get("abTestBucket"),o=t.get("eligibleForABTest"),u=t.get("loggedNormally");if(typeof r=="number"&&r>=0&&r<=1&&o&&u===!1&&f.name&&typeof l=="number")for(var c=0;c<i.length;c++)if(i[c].name===f.name&&f.dateRange){var h=new Date(f.dateRange[0]),p=new Date(f.dateRange[1]);if(e>=h&&e<p){this.eligibleForABTest=o,this.loggedNormally=u,this.currentTest=f,this.currentGroup=l,this.beginContext({abtest:this.currentTest.name,group:this.currentGroup}),this.shouldLog=!0,this.gaSetCustomVariable(2,"GUTSLoggingStatus",this.currentTest.name+"_"+this.currentGroup,2),this.onShouldLogChange();return}break}this.clearLoggingStatus()}r=t.get("abTestBucket"),o=t.get("eligibleForABTest"),u=t.get("loggedNormally"),a=t.get("loggingStatusExpirationDate"),a&&(a=new Date(a));var d=Math.random();a&&e>a&&(this.clearLoggingStatus(),u=t.get("loggedNormally"),o=t.get("eligibleForABTest"),r=t.get("abTestBucket"),f=t.get("currentTest"),l=t.get("currentGroup"));if(r&&o&&u===!1){this.abTestBucket=r,this.setCurrentTest();return}_.defined(u)||(u=d<=.1,t.set("loggedNormally",u)),this.loggedNormally=u,this.loggedNormally?(this.eligibleForABTest=!1,this.shouldLog=!0,t.set("eligibleForABTest",!1),this.gaSetCustomVariable(2,"GUTSLoggingStatus","normal",2),this.onShouldLogChange()):_.defined(o)?this.eligibleForABTest=o:(this.eligibleForABTest=d>.1&&d<=.2,t.set("eligibleForABTest",this.eligibleForABTest)),this.eligibleForABTest?(this.abTestBucket=Math.random(),t.set("abTestBucket",this.abTestBucket)):(this.abTestBucket=null,t.set("abTestBucket",this.abTestBucket)),this.loggingStatusExpirationDate=new Date(e.getTime()+s),t.set("loggingStatusExpirationDate",this.loggingStatusExpirationDate),this.abTestBucket&&this.setCurrentTest()},forceABTest:function(e,t){e&&typeof t=="number"&&(this.currentTest={},this.currentTest.name=e,this.currentGroup=t,this.beginContext({abtest:this.currentTest.name,group:this.currentGroup}),this.shouldLog=!0,this.debug=!0,this.loggedNormally=!1,this.eligibleForABTest=!0,this.onShouldLogChange())},forceExistingABTest:function(e,t,r){if(e&&typeof t=="number")for(var s=0;s<i.length;s++){var o=i[s];if(o.name===e){this.currentTest=o,this.currentGroup=t,this.shouldLog=!0,this.debug=!0,this.loggedNormally=!1,this.eligibleForABTest=!0,this.abTestBucket=(o.targetRange[0]+o.targetRange[1])/2;if(r){var u=n.Services.Local;u.set("loggedNormally",!1),u.set("eligibleForABTest",!0),u.set("abTestBucket",this.abTestBucket),u.set("currentTest",this.currentTest),u.set("currentGroup",this.currentGroup)}this.onShouldLogChange();break}}},clearLoggingStatus:function(){var e=n.Services.Local;e.set("loggedNormally",null),e.set("eligibleForABTest",null),e.set("abTestBucket",null),e.set("currentTest",null),e.set("currentGroup",null),e.set("loggingStatusExpirationDate",null),this.shouldLog=!1,this.loggedNormally=null,this.eligibleForABTest=null,this.abTestBucket=null,this.currentTest=null,this.currentGroup=null,_gaq.push(["_deleteCustomVar",2]),this.onShouldLogChange()},setCurrentTest:function(){if(this.abTestBucket){var e,t,r,s=new Date,o=n.Services.Local;for(var u=0;u<i.length;u++){e=i[u],t=new Date(e.dateRange[0]),r=new Date(e.dateRange[1]);if(e.targetRange[0]<=this.abTestBucket&&e.targetRange[1]>=this.abTestBucket&&t<=s&&r>=s){this.currentTest=e,o.set("currentTest",e);var a=(e.targetRange[1]-e.targetRange[0])/e.groups.length;return this.currentGroup=Math.min(Math.floor((this.abTestBucket-e.targetRange[0])/a),e.groups.length-1),o.set("currentGroup",this.currentGroup),this.beginContext({abtest:e.name,group:this.currentGroup}),this.shouldLog=!0,this.gaSetCustomVariable(2,"GUTSLoggingStatus",e.name+"_"+this.currentGroup,2),this.onShouldLogChange(),e}}}return null},beginContext:function(e){_.forEach(e,function(t,n){e.hasOwnProperty(n)&&(this.context[n]=e[n])},this)},endContext:function(e){_.defined(this.context[e])&&delete this.context[e]},doLogEvent:function(e,t){var n=this.currentTest;if(n&&n.dateRange&&n.dateRange.length==2){var r=new Date,i=new Date(n.dateRange[1]);if(r>i){this.clearLoggingStatus(),this.setLoggingStatus();if(!this.shouldLog)return}}var s=(new Date).getTime(),o={time:s,appID:this.appID,lpID:e,state:{},context:{}};currentContext=this.context,_.forEach(currentContext,function(e,t){currentContext.hasOwnProperty(t)&&($.isArray(currentContext[t])?(this.context[t]=[],_.forEach(currentContext[t],function(e,t){this.push(t)},this.context[t])):this.context[t]=_.orEqual(currentContext[t],"").toString())},o),_.forEach(t,function(e,n){t.hasOwnProperty(n)&&(o.state[n]=_.orEqual(e,"").toString())},o),this.localLogs.push(o),(this.debug||this.checkSendCondition())&&this.sendLogs()},logEvent:function(e,t){this.shouldLog&&this.doLogEvent(e,t)},onBeginContext:function(e){this.beginContext(e)},onEndContext:function(e){this.endContext(e)},onStartNewAutoplayContext:function(e,t,n,r){this.startNewAutoplayContext(e,t,n,r)},onStartAutoplayFallbackContext:function(e,t,n,r){this.startAutoplayFallbackContext(e,t,n,r)},onGaTrack:function(e,t,n,r){this.gaTrackEvent(e,t,n,r)},onLogSearch:function(e,t,n,r){this.logSearchEvent(e,t,n,r)},onClearAllAutoplayContexts:function(){this.clearAllAutoplayContexts()},onForceLog:function(e,t){var n=this.checkLogForErrors(e,t,!0);n&&this.forceLogEvent(n.lpID,n.state)},onHandleFieldClick:function(e,t,n,r){this.handleFieldClick(e,t,n,r)},onGaSetCustomVariable:function(e,t,n,r){this.gaSetCustomVariable(e,t,n,r)},checkLogForErrors:function(e,t,n){n=_.defined(n)?n:!1;var r={lpID:e,state:t};if(!n&&!this.shouldLog)return!1;try{if(_.isNull(e)||_.isUndefined(e))throw{msg:"missing lpID in log event",cause:r};if(typeof e!="string")throw{msg:"invalid param type of lpID, expected string:",cause:r};if(_.isNull(t)||_.isUndefined(t))r.state={};else{if(typeof t!="object")throw{msg:"invalid param type of state, expected object:",cause:r};var i=_.keys(t),s=i.length;for(var o=0;o<s;o++){var u=i[o];if(typeof t[u]=="object"&&!_.isArray(t[u]))throw{msg:"state property in log function cannot contain objects:",cause:r}}}return r}catch(a){return console.log("GUTS logging error -",a.msg,a.cause),!1}},onLog:function(e,t){var n=this.checkLogForErrors(e,t);n&&this.doLogEvent(n.lpID,n.state)},forceLogEvent:function(e,t){t||(t={}),t.forceLogged=!0,this.doLogEvent(e,t)},logSearchEvent:function(e,i,s,o){try{var u="",a={},f=r.model.get("searchVersion"),l=new n.Models.Collections.Songs,c=s?jQuery.data(s.currentTarget,"module"):null,h;switch(e){case"OLlibraryClick":case"OLfavoriteClick":case"OLartistPageLoad":case"OLalbumPageLoad":case"OLsongPageLoad":case"OLshareClick":case"OLplayButton":case"OLaddButton":u=e;break;case"dblClick":u="handleItemDblclick";break;default:u="searchClick",a.clickType=e}if(u!="searchClick"&&s&&c&&c.model)h=c.model,l.push(h);else{if(!i.selectedItems.length){console.log("No items for logSearchEvent");return}l.reset(i.selectedItems.models)}if(h){a.rank=i.collection.indexOf(h)+1;var p=r.page.getCurrentPageView();h.get("ppVersion")&&_.isInstance(p,n.Views.Pages.Search)&&(a.ppVersion=h.get("ppVersion"))}else{var d=Infinity,v=[];l.each(function(e){var t=i.collection.indexOf(e)+1;d=Math.min(d,t),v[t]=e.get("ppVersion")}),d!=Infinity&&(a.rank=d),v=_.without(v,t),v.length&&(a.ppVersions=v.join(","))}l.length==1?a.songID=l.models[0].get("SongID"):a.songIDs=l.pluck("SongID"),o&&(a=_.extend(a,o)),this.logEvent(u,a)}catch(m){console.log(m)}},checkSendCondition:function(){return this.localLogs.length>=this.bufferLength&&(new Date).getTime()-this.lastUserChangeTime>1e4},forceSend:function(){this.sendLogs(!0)},sendLogsTimeout:!1,sendLogsWait:function(){var e=(new Date).getTime()-this.lastUserChangeTime;return e>=1e4?1e3:1e4-e},sendLogs:function(e){var t=this.debug?0:this.sendLogsWait();e?this._internalSend(!1):this._internalSend(!0,t)},sendStats:function(e){var t=+(new Date);e=e||(t-n.Services.API.lastRequestTime)/1e3>=20||(t-this.lastStatsTime)/1e3>=300||this.localStats.length>100,e&&this.lastStatsTime&&this.localStats&&this.localStats.length?(this.lastStatsTime=0,n.Services.API.logPerformanceTracking(this.localStats).always(_.bind(function(){this.lastStatsTime=t},this)),this.localStats=[]):this.lastStatsTime||(this.lastStatsTime=t)},_internalSend:function(t,r){clearTimeout(this.sendLogsTimeout),r=r||500,t=_.orEqual(t,!0);var i=0,s=0,o=_.bind(function(){var u=Date.now()-this.createdAt;i+=r,s++;if(t&&$.active&&u>1e4&&(i<=2e3||s<=2)){this.sendLogsTimeout=setTimeout(o,r);return}var a=this.toTransmissionFormat(this.localLogs);if(this.localLogs.length>0){this.debug&&console.log(a);var f=this;this.currentTest?($.ajax({contentType:"text/xml",type:"POST",data:a,url:"/guts-ab.php",cache:!1,async:t,success:function(e,t,n){},error:function(e,t,n){}}),this.currentTest.name=="guts-json"&&(data={logpoints:this.localLogs,clientTimeDivergence:e.clientTimeDivergence},n.Services.API.logGuts(data,{async:t}))):$.ajax({contentType:"text/xml",type:"POST",data:a,url:this.server,cache:!1,async:t,success:function(e,t,n){},error:function(e,t,n){}}),this.localLogs=[]}},this);t?this.sendLogsTimeout=setTimeout(o,r):o()},toTransmissionFormat:function(e){var t=(new Date).getTime()+"\n",n={result:t,appID:this.appID};return _.forEach(e,function(t,n){var r=/\:/g,i=/\\/g,s=e[n];this.result+=this.appID+"	",this.result+=s.lpID+"	";var o=s.context;_.forEach(o,function(e,t){o.hasOwnProperty(t)&&(this.result+=t+":"+o[t].replace(i,"\\\\").replace(r,"\\:")+"	")},this);var u=s.state;_.forEach(u,function(e,t){u.hasOwnProperty(t)&&(this.result+=t+":"+u[t].replace(i,"\\\\").replace(r,"\\:")+"	")},this),this.result+=s.time+"\n"},n),n.result},gaSetCustomVariable:function(t,n,r,i){if(_.notDefined(t)||_.notDefined(n)||_.notDefined(r))return console.warn("guts.gaSetCustomVariable: nonexistant slot, key, or value"),!1;t=Number(t);if(isNaN(t)||t<1)return console.warn("guts.gaSetCustomVariable: invalid slot"),!1;i=_.orEqual(i,3),e._gaq&&e._gaq.push&&e._gaq.push(["_setCustomVar",t,n,r,i])},gaTrackEvent:function(t,n,r,i){if(_.notDefined(t)||_.notDefined(n)){console.warn("guts.gaTrackEvent: bad category or action",t,n);return}r=""+_.orEqual(r,""),i=parseFloat(""+_.orEqual(i,""),10);if(isNaN(i)||i==="")i=null;e._gaq&&e._gaq.push&&(r&&i?e._gaq.push(["_trackEvent",t,n,r,i]):r?e._gaq.push(["_trackEvent",t,n,r]):i?e._gaq.push(["_trackEvent",t,n,null,i]):e._gaq.push(["_trackEvent",t,n]))},handlePageLoad:function(t,n){var r={};r.destinationPageType=t;if(n.firstPage){r.firstPage=!0;try{var i=_.cookie("referrerURL"),s;i?(s=i,_.cookie("referrerURL",null,{domain:e.location.host})):s=document.referrer;if(s&&_.isString(s)){var o=/^(?:(?:(.+?):)?\/\/(?:(.+)@)?([^/]+)(?::([0-9]+))?)?\/?/,u=s.match(o);u&&(r.referrerHost=u[3]||"grooveshark.com",r.referrer=s)}}catch(a){console.log("error parsing referrer",a.message)}}switch(t){case"home":n&&n.redeemingPromoCard&&(r.reason="redeem"),n.notFound?(r.reason="pageNotFound",this.logEvent("pageNotFound",{})):n.reason&&(r.reason=n.reason);break;case"user":case"profile":r.destinationPageID=n.id,r.destinationSubpageType=n.section&&!n.subpage?n.section:n.subpage,n.section=="broadcast"&&(r.destinationSubpageType="broadcast"),r.destinationSubpageType=_.orEqual(r.destinationSubpageType,"profile");break;case"playlist":case"album":case"artist":case"promotion":case"tag":r.destinationPageID=n.id,r.destinationSubpageType=n.subpage,r.destinationSubpageType||(t=="album"?r.destinationSubpageType="tracklist":t=="artist"&&(r.destinationSubpageType="overview"));break;case"search":r.destinationSubpageType=n.type||"song";break;case"song":r.destinationPageID=n.id,r.destinationSubpageType=n.subpage;break;case"settings":r.destinationSubpageType=_.orEqual(n.subpage,"profile");break;case"popular":r.destinationTimeRange=n.type||"daily";case"surveys":case"explore":case"trending":n.subpage&&(r.destinationSubpageType=n.subpage);case"artistDashboard":n.subpage&&(r.destinationSubpageType=n.subpage),n.id&&(r.destinationPageID=n.id);case"static":n.section&&(r.destinationSubpageType=n.section);break;case"broadcasts":r.destinationSubpageType=n.subpage||"broadcasts",r.destinationSubpageType==="leaderboard"&&(r.destinationPeriod=n.period||"week",r.destinationGenre=n.tagID||"All",r.destinationDate=n.date||"This Week")}!r.destinationPageID&&_.toInt(n.id)&&(r.destinationPageID=_.toInt(n.id)),this.pageParamsAreDifferent(r)&&(r.firstPage&&r.destinationSubpageType==="broadcast"?this.forceLogEvent("loadPage",r):this.logEvent("loadPage",r),r.destinationPageType==="popular"&&this.beginContext({currentTimeRange:n.type||"daily"}),r.destinationSubpageType==="leaderboard"&&this.beginContext({currentPeriod:r.destinationPeriod,currentGenre:r.destinationGenre,currentDate:r.destinationDate}),this.context.currentSubpage==="leaderboard"&&r.destinationSubpageType!=="leaderboard"&&(this.endContext("currentPeriod"),this.endContext("currentGenre"),this.endContext("currentDate")),this.context.currentPageType==="popular"&&r.destinationPageType!=="popular"&&this.endContext("currentTimeRange"),this.beginContext({currentPageType:r.destinationPageType}),r.destinationSubpageType?this.beginContext({currentSubpage:r.destinationSubpageType}):this.endContext("currentSubpage"),r.destinationPageID?this.beginContext({currentPageID:r.destinationPageID}):this.endContext("currentPageID"))},startNewAutoplayContext:function(e,t,n,r){console.log("startNewAutoplayContext",arguments),this.clearAllAutoplayContexts(),this.beginContext({autoplay:!0,autoplayType:e,autoplayID:t}),n&&r&&this.beginContext({autoplaySeedType:n,autoplaySeedIDs:r})},startAutoplayFallbackContext:function(e,t,n,r){console.log("startAutoplayFallbackContext",arguments),this.clearAutoplayFallbackContexts(),this.beginContext({autoplayFallbackType:e,autoplayFallbackID:t}),n&&r&&this.beginContext({autoplayFallbackSeedType:n,autoplayFallbackSeedIDs:r})},clearAllAutoplayContexts:function(){console.log("clearAllAutoplayContexts"),this.endContext("autoplay"),this.endContext("autoplayType"),this.endContext("autoplayID"),this.endContext("autoplaySeedType"),this.endContext("autoplaySeedIDs"),this.clearAutoplayFallbackContexts()},clearAutoplayFallbackContexts:function(){this.endContext("autoplayFallbackType"),this.endContext("autoplayFallbackID"),this.endContext("autoplayFallbackSeedType"),this.endContext("autoplayFallbackSeedIDs")},handlePlayerRestoreQueue:function(){this.gaTrackEvent("player","restoreQueue"),this.logEvent("restoreQueue")},handleAPIStats:function(e){this.shouldLog&&(this.localStats.push(e),this.sendStats())},pageParamsAreDifferent:function(e){return!this.context.currentPageType||!this.context.currentSubpage||!this.context.currentPageID?!0:e&&e.destinationPageType&&e.destinationSubpageType&&e.destinationPageID?this.context.currentPageType!=e.destinationPageType?!0:this.context.currentSubpage!=e.destinationSubpageType?!0:this.context.currentPageID!=e.destinationPageID?!0:!1:!0},handleFieldClick:function(e,t,n,r){var i={songID:n,rank:t};r!==null&&r.length>0&&(i.ppVersion=r);var s="";e.indexOf("artist")>-1?s="OLartistPageLoad":e.indexOf("album")>-1?s="OLalbumPageLoad":s="OLsongPageLoad",this.logEvent(s,i)},handleFeedEventClick:function(e,t){var n={},r=$(e)[0].tagName;switch(r){case"A":feedEvent=$(e).parents(".event");if($(e).attr("href")){var i=$(e).attr("href"),s=i.split("/");n.clickedType=s[1],n.clickedID=s[3]}else n.clickedType=$(e).attr("class");break;case"LI":feedEvent=$(e).parents(".event");var o=$(e).attr("class").split(" "),u=o[o.length-1];u=="option"?n.clickedType="playSongs":u=="show"&&(n.clickedType="showSongs");break;default:}n.rank=$(feedEvent).index()+1;var a=$(feedEvent).attr("class"),s=a.split(" ");n.whoseFeed=s[2].split("user")[1],_.forEach(s,function(e,t){s[t].indexOf("type")>-1&&(n.eventType=s[t].substring(4,s[t].length))},n);var f={},l;$('.what>a[class!="showSongs"]',feedEvent).each(function(e,t){var r=$(this).attr("href");if(_.defined(r)){var i=r.split("/"),s=i[1];f[s]?f[s]+=1:f[s]=1;var o=i[3];n[s+f[s]]=o}});var c={};$("#feed>li").each(function(){a=$(this).attr("class"),s=a.split(" ");var e=s[1].substring(4,s[1].length);c[e]?c[e]+=1:c[e]=1});var h="";_.forEach(c,function(e,t){h=h+t+";"+e+","},h),h=h.slice(0,h.length-1),n.counts=h,this.logEvent("feedEventClick",n)},objectListPlayAdd:function(e,t,n){var r,i;switch(n){case"play":r="OLPlayClick";break;case"add":r="OLAddClick";break;default:}var s,o=$("#grid .slick-row.selected",t);o.length>0?(i="",$(o).each(function(){s=parseInt($(this).attr("row"),10),isNaN(s)||(i=i+(s+1)+",")}),i=i.slice(0,i.length-1),this.logEvent(r,{songIDs:e,ranks:i})):(i="all",this.logEvent(r,{songIDs:e,ranks:i}))},songItemGetContexts:function(e){var t={},n="",r=$(e.target).closest(".listens-set-grid");return r.length&&(r.hasClass("today")?n="today":r.hasClass("yesterday")?n="yesterday":r.hasClass("last-week")?n="last-week":r.hasClass("last-month")?n="last-month":r.hasClass("long-ago")&&(n="long-ago")),n.length&&(t.recentListensGroup=n),t},songItemLibraryClick:function(e){this.logEvent("OLlibraryClick",e)},songItemFavoriteClick:function(e){this.logEvent("OLfavoriteClick",e)}}}(),function(){function s(t){e._gaq&&e._gaq.push&&e._gaq.push(["_trackSocial","facebook","like",t])}function o(t){e._gaq&&e._gaq.push&&e._gaq.push(["_trackSocial","facebook","unlike",t])}n.Services=n.Services||{};var t=0,r=!1,i;n.Services.Facebook={lastError:null,loadFacebookJS:function(){if(typeof e.FB=="object"){r||this.onFacebookJSLoaded();return}if($.browser.msie&&$.browser.version<=6)return;var n=null,i=this;t++;try{if($("#facebook-js script").length)$("#facebook-js").empty(),$("#fb-root").empty(),e.FB=null;else if(!document.getElementById("facebook-js")){var s=document.createElement("div");s.id="facebook-js",document.body.appendChild(s)}if(!document.getElementById("facebook-root")){var o=document.createElement("div");o.id="fb-root",document.body.appendChild(o)}var u=document.createElement("script");u.async=!0,u.src=document.location.protocol+"//connect.facebook.net/en_US/all.js",e.fbAsyncInit=_.bind(this.onFacebookJSLoaded,this),document.getElementById("facebook-js").appendChild(u)}catch(u){console.error("Could not load Facebook JS. Fatal Error: ",u)}n=setTimeout(function(){!e.FB&&t<3?i.loadFacebookJS():!e.FB&&t>=3},2e4)},onFacebookJSLoaded:function(){if(typeof e.FB!="object"||!e.FB)return;r||e.FB.init({appId:"111132365592157",status:!1,cookie:!1,xfbml:!1,oauth:!0,channelUrl:"//"+e.location.hostname+"/channel.html"}),r=!0,e.FB.Event.subscribe("edge.create",s),e.FB.Event.subscribe("edge.remove",o),this.parseWidgets()},parseWidgets:function(t){if(typeof e.FB!="object"||!e.FB){this.loadFacebookJS();return}var n=$.Deferred();return e.FB.XFBML.parse(t,function(){n.resolve()}),n.promise()},SERVICE_ID:4,FACEBOOK_ONLY_SERVICE_ID:16,loginDeferred:null,APPLICATION_ID:"111132365592157",PERMISSIONS:"offline_access,publish_stream,email,user_about_me,user_likes,user_interests,user_location,user_birthday,publish_actions",REQUIRED_PERMISSIONS:"offline_access,publish_stream,email,user_about_me,user_location,user_birthday",PUBLISH_PERMISSION:"publish_stream",USER_ACTIONS:"publish_actions",WALL_FAVORITES:8,WALL_PLAYLIST_CREATE:16,SCROBBLING_OFF_FLAG:32,AUTO_RATE_LIMIT:18e6,MINIMUM_DURATION:15,connected:!1,userID:-1,registeredWithFacebook:!1,profile:{},init:function(t){i=t,n.ready.done(_.bind(this.appReady,this)),this.LISTEN_APPLICATION_ID="111132365592157";if(e.location.host.indexOf("grooveshark.com")>-1&&this.APPLICATION_ID!==this.LISTEN_APPLICATION_ID||!this.APPLICATION_ID)this.APPLICATION_ID=this.LISTEN_APPLICATION_ID},appReady:function(){},shareLink:function(t,n,r){var i=$.Deferred(),s=_.getCenteredCoordinates(660,360);return e.open("http://facebook.com/share.php?u="+encodeURIComponent(t)+"&ref="+n+"Share","","width=660,height=360,left="+s[0]+",top="+s[1]),i.resolve(!0,!0),i.promise()},verifyFacebookUsername:function(e,t){return n.Services.API.verifyFacebookURL(e,t)}}}(),function(){function g(e){e=_.orEqual(e,3600),l=(new Date).getTime()+e*1e3}function y(t){var n=!1,r="414496129962.apps.googleusercontent.com",i={window:e.name,flags:0};t?n=!0:t=[],_.indexOf(t,"https://www.googleapis.com/auth/plus.moments.write")===-1&&(t.push("https://www.googleapis.com/auth/userinfo.profile"),t.push("https://www.googleapis.com/auth/userinfo.email"));var s="online",o="token",u="auto";n&&(s="offline",o="code",i.flags|=d,u="force");for(var a=0;a<t.length;a++)i.flags|=m[t[a]];return"https://accounts.google.com/o/oauth2/auth?response_type="+o+"&client_id="+r+"&redirect_uri="+encodeURIComponent(e.location.protocol+"//"+e.location.hostname+"/googleCallback.php")+"&access_type="+s+"&approval_prompt="+u+"&scope="+encodeURIComponent(t.join(" "))+"&state="+encodeURIComponent(JSON.stringify(i))}function b(e,t){var n={type:"http://schemas.google.com/ListenActivity",target:{url:t}};w(e,n)}function w(t,r){(typeof e.gapi!="object"||!e.gapi||typeof e.gapi.client!="object")&&n.Services.Google.loadGoogleAPIJS(),s.done(function(){T().done(function(){e.gapi.auth.setToken({access_token:f,expires_in:3600});var n={path:"/plus/v1moments/people/me/moments/vault?debug=true",method:"POST",body:JSON.stringify(r),callback:_.bind(E,this,t)};e.gapi.client.request(n)})})}function E(e,t){console.log("Moment write response",t),e&&e.resolve(t)}function T(){return x?x.promise():(x=$.Deferred(),!f||l<(new Date).getTime()?++S>3?x.reject():n.Services.API.getUserGoogleAccessToken().always(function(e){e&&e.access_token?(S=0,f=e.access_token,g(),x.resolve()):x.reject()}):x.resolve(),x.promise())}function N(){(typeof e.gapi!="object"||!e.gapi||typeof e.gapi.client!="object")&&n.Services.Google.loadGoogleAPIJS();var t=new $.Deferred,r=this;return s.done(function(){T().done(function(){e.gapi.auth.setToken({access_token:f,expires_in:3600});var n={path:"/oauth2/v2/userinfo",method:"GET",callback:_.bind(C,r,t)};e.gapi.client.request(n)}).fail(_.bind(t.reject,t))}).fail(_.bind(t.reject,t)),t.promise()}function C(e,t){t&&t.name?e.resolve(t):(n.Services.Google.reset(),e.reject())}n.Services=n.Services||{};var t=0,i=!1,s=new $.Deferred,o,u,a,f,l,c,h=!1,p,d=1,v=97,m={"https://www.googleapis.com/auth/userinfo.profile":0,"https://www.googleapis.com/auth/userinfo.email":0,"https://apps-apis.google.com/a/feeds/alias/":0,"https://www.google.com/m8/feeds/":8,"https://www.googleapis.com/auth/plus.me":16,"https://www.googleapis.com/auth/plus.moments.write":32},S=0,x=null;n.Services.Google={loadGooglePlusJS:function(){if(typeof e.gapi=="object"&&e.gapi&&typeof e.gapi.plusone=="object"){i||this.onGooglePlusJSLoaded();return}if($.browser.msie&&$.browser.version<=6)return;var n=null,r=this;t++;try{if($("#google-plus-js script").length)$("#google-plus-js").empty(),e.gapi=null;else if(!document.getElementById("google-plus-js")){var s=document.createElement("div");s.id="google-plus-js",document.body.appendChild(s)}var o=document.createElement("script");o.async=!0,o.src=document.location.protocol+"//apis.google.com/js/plusone.js?onload=onGAPIPlus",o.text="{parsetags: 'explicit'}",e.onGAPIPlus=function(){setTimeout(function(){if(e.gapi&&e.gapi.plusone){clearTimeout(n),r.onGooglePlusJSLoaded();try{delete e.onGAPIPlus}catch(t){}}},100)},document.getElementById("google-plus-js").appendChild(o)}catch(o){console.error("Could not load Google Plus JS. Fatal Error: ",o)}n=setTimeout(function(){!e.gapi&&t<3?r.loadGooglePlusJS():(!e.gapi||!e.gapi.plusone)&&t>=3},2e4)},onGooglePlusJSLoaded:function(){if(typeof e.gapi!="object"||!e.gapi||typeof e.gapi.plusone!="object")return;i=!0,this.parseWidgets()},parseWidgets:function(t){if(typeof e.gapi!="object"||!e.gapi||typeof e.gapi.plusone!="object"){this.loadGooglePlusJS();return}try{e.gapi.plusone.go(t?t:document.body)}catch(n){}},loadGoogleAPIJS:function(){if(typeof e.gapi=="object"&&e.gapi&&typeof e.gapi.client=="object"){s.state()==="pending"&&this.onGoogleAPIJSLoaded();return}if($.browser.msie&&$.browser.version<=6)return;var n=null,r=this;t++;try{if($("#google-api-js script").length)$("#google-api-js").empty(),e.gapi=null;else if(!document.getElementById("google-api-js")){var i=document.createElement("div");i.id="google-api-js",document.body.appendChild(i)}var o=document.createElement("script");o.async=!0,o.src=document.location.protocol+"//apis.google.com/js/client.js?onload=onGAPIClient",e.onGAPIClient=function(){setTimeout(function(){if(e.gapi&&e.gapi.client){clearTimeout(n),r.onGoogleAPIJSLoaded();try{delete e.onGAPIClient}catch(t){}}},100)},document.getElementById("google-api-js").appendChild(o)}catch(o){console.error("Could not load Google+ API JS. Fatal Error: ",o)}n=setTimeout(function(){(!e.gapi||!e.gapi.client)&&t<3?r.loadGoogleAPIJS():(!e.gapi||!e.gapi.client)&&t>=3},2e4)},onGoogleAPIJSLoaded:function(){if(typeof e.gapi!="object"||!e.gapi||typeof e.gapi.client!="object")return;s.resolve()},SERVICE_ID:64,GOOGLE_ONLY_SERVICE_ID:32,MINIMUM_DURATION:120,GOOGLE_PLUS_FLAG:16,connected:!1,registeredWithGoogle:!1,profile:{},loginDeferred:null,lastError:"",onLoginSaveData:null,init:function(e){u=e,u.model.on("change:user",this.onUserChange,this),c=u.model.get("player"),n.ready.done(_.bind(this.appReady,this))},appReady:function(){this.onUserChange()},reset:function(){this.connected=!1,this.profile={},this.registeredWithGoogle=!1,f=null,l=null,s.state()==="resolved"&&e.gapi.auth.setToken(null),this.suspendScrobbling(),p=null,x=null,n.trigger("google:profile:update")},onUserChange:function(){a&&a.off("change:extraData",this.onUserDataChange,this),a=u.model.get("user"),this.reset(),typeof a.get("extraData")=="undefined"?a.on("change:extraData",this.onUserDataChange,this):this.onUserDataChange()},onUserDataChange:function(){if(a&&a.get("isLoggedIn")&&(a.get("Flags")&this.SERVICE_ID||a.get("Flags")&this.GOOGLE_ONLY_SERVICE_ID)){this.registeredWithGoogle=(a.get("Flags")&this.GOOGLE_ONLY_SERVICE_ID)>0;var e=a.get("extraData");e&&e.Google?this.onUserGoogleData(e.Google):gsConfig.runMode!=="production"&&console.error("Supposed to have Google data for auth user but undefined!!",a,e)}},onUserGoogleData:function(e){var t=$.Deferred();try{e&&(e.GoogleUID||e.GoogleEmailAddress)?(x=null,this.profile={},this.profile.email=_.orEqual(e.GoogleEmailAddress,null),this.profile.flags=parseInt(e.Flags,10),this.profile.id=_.orEqual(e.GoogleUID,null),this.profile.flags&this.SCROBBLING_FLAG&&this.enableScrobbling(),this.connected=!0,t.resolve(),n.trigger("google:profile:update")):(gsConfig.runMode!=="production"&&console.error("onUserGoogleData returned invalid resp:",e),this.onAuthError("onUserGoogleData returned invalid resp",t),t.reject({error:"GOOGLE_MISSING_LOGIN_INFO_ERROR_MSG"}));return}catch(r){gsConfig.runMode!=="production"&&console.error("onUserGoogleData exception thrown:",r)}return this.reset(),t.reject({error:"GOOGLE_MISSING_LOGIN_INFO_ERROR_MSG"}),t.promise()},removeFromUser:function(){var e=$.Deferred();return this.profile&&this.profile.googleUID&&this.profile.email?n.Services.API.removeUserGoogleData(this.profile.id,this.profile.email,_.bind(this.onRemovedFromUser,this,e)):this.profile&&this.profile.email?n.Services.API.removeUserGoogleData(null,this.profile.email,_.bind(this.onRemovedFromUser,this,e)):n.Services.API.removeUserGoogleData(null,_.bind(this.onRemovedFromUser,this,e)),e.promise()},onRemovedFromUser:function(e,t){if(!t||!t.success){e.reject();return}var n=a.get("Flags");a.set("Flags",(n|this.SERVICE_ID)-this.SERVICE_ID),this.reset(),e.resolve()},login:function(){var t=$.Deferred(),r=_.getCenteredCoordinates(430,560);return o=e.open(y(),"","width=430,height=560,status=1,location=1,resizable=yes,left="+r[0]+",top="+r[1]),this.loginDeferred=$.Deferred(),this.loginDeferred.always(_.bind(this.onLogin,this,t)),n.airbridge&&n.airbridge.isDesktop&&(o.parentSandboxBridge={confirmGoogleConnection:e.confirmGoogleConnection}),t.promise()},loginWithGooglePlus:function(t){var r=$.Deferred(),i=_.getCenteredCoordinates(430,600),s=["https://www.googleapis.com/auth/plus.me"];return t&&s.push("https://www.googleapis.com/auth/plus.moments.write"),o=e.open(y(s),"","width=430,height=600,status=1,location=1,resizable=yes,left="+i[0]+",top="+i[1]),this.loginDeferred=$.Deferred(),this.loginDeferred.always(_.bind(this.onLogin,this,r)),n.airbridge&&n.airbridge.isDesktop&&(o.parentSandboxBridge={confirmGoogleConnection:e.confirmGoogleConnection}),r.promise()},onLogin:function(e,t){if(t.error||!t.email)e.reject({error:"LB_SIGNUP_LOGIN_FORM_GOOGLE_ERROR"});else{if(!t.id||!t.email||!t.access_token){e.reject({error:"LB_SIGNUP_LOGIN_FORM_GOOGLE_ERROR"});return}var r=0;this.profile&&this.profile.flags&&(r=this.profile.flags),x=null,this.profile=t,this.profile.flags=r,t.state&&t.state.flags&&(this.profile.flags|=t.state.flags),this.profile.flags&this.SCROBBLING_FLAG&&this.enableScrobbling(),f=t.access_token,g(t.expires_in),delete this.profile.access_token,delete this.profile.expires_in,a.get("isLoggedIn")?t.stored?this.onSaveUserGoogleData(e,1):a.get("Flags")&this.SERVICE_ID||a.get("Flags")&this.GOOGLE_ONLY_SERVICE_ID?n.Services.API.updateUserGoogleData(t.id,t.email,this.profile.flags).done(_.bind(this.onSaveUserGoogleData,this,e)).fail(_.bind(e.reject,e)):n.Services.API.saveUserGoogleData(t.id,t.email,this.profile.flags).done(_.bind(this.onSaveUserGoogleData,this,e)).fail(_.bind(e.reject,e)):n.Services.API.authenticateGoogleUser(t.id,t.email,f).done(_.bind(this.onAuthGoogleUser,this,e)).fail(_.bind(e.reject,e))}},onAuthGoogleUser:function(e,t){if(t)if(t.userID<=0){if(t.loginReason==1){e.reject({error:"LB_SIGNUP_LOGIN_FORM_CLAIM_PENDING"});return}this.register(e)}else t.accessToken=f,e.resolve(t),n.trigger("google:profile:update");else e.reject({error:"GOOGLE_MISSING_LOGIN_INFO_ERROR_MSG"})},onSaveUserGoogleData:function(e,t){if(t==1){this.connected=!0,n.trigger("google:profile:update"),t={result:t},t.accessToken=f,e.resolve(t);var r=a.get("Flags");a.set("Flags",r|this.SERVICE_ID)}else t===-1?e.reject({error:"GOOGLE_DUPLICATE_ACCOUNT_ERROR_MSG",signupError:4096}):t===-2?e.reject({error:"GOOGLE_MISSING_LOGIN_INFO_ERROR_MSG"}):e.reject({error:"LB_SIGNUP_LOGIN_FORM_GOOGLE_ERROR"})},connectionLogout:function(){var t=_.getCenteredCoordinates(890,600);e.open("https://www.google.com/accounts/Logout","","width=890,height=600,status=1,location=1,resizable=yes,left="+t[0]+",top="+t[1])},getGoogleUserInfo:function(e,t){if(t&&t.access_token){var n="https://www.googleapis.com/oauth2/v2/userinfo?access_token="+t.access_token;$.ajax({url:n,success:function(n){$.extend(t,n),e.resolve(t)},error:_.bind(function(t){e.reject(t)}),dataType:"jsonp",cache:!0})}else e.reject(t)},loadGoogleProfile:function(){var e=new $.Deferred;return this.connected?this.profile.name?e.resolve(this.profile):N().done(_.bind(function(t){$.extend(this.profile,t),e.resolve(this.profile),n.trigger("google:profile:update")},this)).fail(_.bind(e.reject,e)):e.reject(),e.promise()},register:function(e){if(!this.profile||!this.profile.email){e.reject({error:"LB_SIGNUP_LOGIN_FORM_GOOGLE_ERROR"});return}var t=this.profile.email.split("@"),r=t[0];r&&(r=r.replace(/^[\.\-_]|[^a-zA-Z0-9\.\-_]|[\.\-_]$/g,""),r=r.replace(/([\.\-_]){2,}/g,"$1"));var i=this.profile.name,s=this.profile.id||Math.floor(Math.random()*997508)+1005;i||r?n.Services.API.getUsernameSuggestions(r,i,s).done(_.bind(this.openRegisterLightbox,this,e)).fail(_.bind(function(t){e.reject({error:"LB_SIGNUP_LOGIN_FORM_GOOGLE_ERROR"})},this,e)):e.reject({error:"LB_SIGNUP_LOGIN_FORM_GOOGLE_ERROR"})},openRegisterLightbox:function(e,t){var i="";this.profile.gender==="male"?i="M":this.profile.gender==="female"&&(i="F");var s=0,o=0,u=0;if(this.profile.birthday){var a=this.profile.birthday.split("-");o=_.toInt(a[0]),s=_.toInt(a[1]),u=_.toInt(a[2])}var l=r.model.get("user").get("subscription").premiumRequired(),c={signupType:"google",details:{accessToken:f,googleEmailAddress:this.profile.email,googleUID:this.profile.id},values:{username:_.orEqual(t[0],""),email:this.profile.email,name:this.profile.name,gender:i,month:s,day:u,year:o},premiumRequired:l,_canClose:!l};n.trigger("lightbox:close"),n.trigger("lightbox:open","signup",c)},shareLink:function(t,n,r){var i=$.Deferred(),s=_.getCenteredCoordinates(720,420);return e.open("https://plus.google.com/share?url="+encodeURIComponent(t),"","width=720,height=420,left="+s[0]+",top="+s[1]),i.resolve(!0,!0),i.promise()},suspendScrobbling:function(){this.profile&&(this.profile.scrobblingEnabled=!1),h&&(c.off("change:playStatus",this.onPlayStatusChange,this),c.off("change:position",this.onPositionChange,this),h=!1)},enableScrobbling:function(){this.profile.scrobblingEnabled=!0,c&&!h&&(c.on("change:playStatus",this.onPlayStatusChange,this),c.on("change:position",this.onPositionChange,this),h=!0,this.onPlayStatusChange())},shouldScrobble:function(){return this.profile&&this.profile.flags&v&&this.profile.scrobblingEnabled},onPlayStatusChange:function(){if(!this.shouldScrobble()||!f||c.get("playStatus")!==n.Models.Player.playStatuses.PLAYING)return;var e=c.get("currentQueue").get("activeSong");if(!e||typeof e.get("queueSongID")!="number"){p=null;return}if(!!p&&e.get("queueSongID")===p.queueSongID&&e.get("SongID")===p.songID)return;p={songID:e.get("SongID"),queueSongID:e.get("queueSongID"),secondsListened:0,scrobbled:!1}},onPositionChange:function(){if(!this.shouldScrobble()||!f||c.get("playStatus")!==n.Models.Player.playStatuses.PLAYING)return;var e=c.get("currentQueue").get("activeSong");if(!e||typeof e.get("queueSongID")!="number"){p=null;return}if(!p||e.get("queueSongID")!==p.queueSongID||e.get("SongID")!==p.songID)return;p.secondsListened+=.5;if(c.get("duration")>this.MINIMUM_DURATION*1e3&&p.secondsListened>30&&!p.scrobbled){p.scrobbled=!0;var t=e.toUrl();if(t.toLowerCase().indexOf("notfound")>-1)return;t=t.replace("#!/","http://grooveshark.com/"),b(null,t)}}},e.confirmGoogleConnection||(e.confirmGoogleConnection=function(t){o&&(o.close(),o=null);var r=n.Services.Google.loginDeferred;if(!r)return;try{t=$.parseJSON(t)}catch(i){r.reject({error:"parseError"});return}t.mode==="cancel"||t.error==="cancel"?r.reject({error:"cancel"}):n.airbridge&&n.airbridge.isDesktop?e.setTimeout(function(){r.resolve(t)},300):n.Services.Google.getGoogleUserInfo(r,t)})}(),function(){function c(e,t,n){gsConfig.runMode!=="production"&&console.log("onPostTweet",t,n),n.success&&n.response.id?e.resolve(n.response.id,!1):h(e,n)}function h(e,t){var n={error:"POPUP_SHARE_TWITTER_ERROR"};t.response&&t.response.error&&t.response.error.indexOf("Status is over 140 characters.")>-1?n.error="POPUP_SHARE_TWITTER_TOO_LONG":gsConfig.runMode!=="production"&&console.error("postTwitterStatus returned unexpected resp:",t),e.reject(n)}n.Services=n.Services||{};var i=0,s=!1,o=null,u=null,a,f,l;n.Services.Twitter={lastError:null,loadTwitterJS:function(){if(typeof e.twttr=="object"){s||this.onTwitterJSLoaded();return}if($.browser.msie&&$.browser.version<=6)return;var t=null,n=this;i++;try{if($("#twitter-js script").length)$("#twitter-js").empty(),e.twttr=null;else if(!document.getElementById("twitter-js")){var r=document.createElement("div");r.id="twitter-js",document.body.appendChild(r)}var o=document.createElement("script");o.async=!0,o.src=document.location.protocol+"//platform.twitter.com/widgets.js";var u=function(){if($.browser.msie&&this.readyState&&this.readyState!=="complete"&&this.readyState!=="loaded")return;this.onload=this.onreadystatechange=null,setTimeout(function(){e.twttr&&(clearTimeout(t),n.onTwitterJSLoaded())},100)};o.onload=o.onreadystatechange=u,document.getElementById("twitter-js").appendChild(o)}catch(o){console.error("Could not load Twitter JS. Fatal Error: ",o)}t=setTimeout(function(){!e.twttr&&i<3?n.loadTwitterJS():!e.twttr&&i>=3},2e4)},onTwitterJSLoaded:function(){if(typeof e.twttr!="object"||!e.twttr)return;s=!0,e.twttr.events.bind("tweet",function(t){if(t){var n;if(t.target&&t.target.nodeName==="IFRAME"&&t.target.src){var r=decodeURI(t.target.src),i=r.split("&");for(var s=0,o;o=i[s];++s)o.indexOf("url=")===0&&(n=unescape(o.split("=")[1]))}e._gaq&&e._gaq.push&&e._gaq.push(["_trackSocial","twitter","tweet",n])}}),this.parseWidgets()},parseWidgets:function(){if(typeof e.twttr!="object"||!e.twttr){this.loadTwitterJS();return}e.twttr.widgets.load()},getTwitterShareMessage:function(e,t,n,r){var i=$.Deferred(),s="",o="",u=n&&n.length?25:0;switch(e){case"song":s=t.get("SongName"),s.length>40&&(s=s.substr(0,40)+"..."),o=_.getString("SHARE_TWITTER_SONG",{SongName:s,ArtistName:t.get("ArtistName")});break;case"artist":s=t.get("ArtistName"),s.length>60&&(s=s.substr(0,60)+"..."),o=_.getString("SHARE_TWITTER_ARTIST",{ArtistName:s});break;case"album":s=t.get("AlbumName"),s.length>40&&(s=s.substr(0,40)+"..."),o=_.getString("SHARE_TWITTER_ALBUM",{AlbumName:s,ArtistName:t.get("ArtistName")});break;case"playlist":s=t.get("PlaylistName"),s.length>40&&(s=s.substr(0,40)+"..."),o=_.getString("SHARE_TWITTER_PLAYLIST",{PlaylistName:s,UserName:t.get("UserName")});break;case"broadcast":s=t.get("Name");if(t.isLoggedInUserOwner()){o=_.getString("SHARE_TWITTER_BROADCAST",{BroadcastName:s});if(o>140-u-18){var a=_.getString("SHARE_TWITTER_BROADCAST",{BroadcastName:""}),f;s>140-u-1&&(f=s.substr(0,140-u-3-a.length)+"..."),o=_.getString("SHARE_TWITTER_BROADCAST",{BroadcastName:f})}}else o=_.getString("SHARE_TWITTER_BROADCAST_OTHER");break;case"user":s=t.get("Name"),s.length>40&&(s=s.substr(0,40)+"..."),o=_.getString("SHARE_TWITTER_USER",{UserName:t.get("Name")})}return o.length<128-u-18?o+=" #nowplaying":o.length<137-u-18&&(o+=" #np"),o.length<127-u-18&&(new Date).format("D")==="Mon"&&(o+=" #musicmonday"),o.length<130-u-18&&(new Date).format("D")==="Tue"&&(o+=" #tunesday"),i.resolve(o,n),i.promise()},SERVICE_ID:4096,TWITTER_ONLY_SERVICE_ID:8192,loginDeferred:null,connected:!1,registeredWithTwitter:!1,profile:{},friendIDs:[],friends:{},followerIDs:[],followers:{},init:function(e){f=e,f.model.on("change:user",this.onUserChange,this),n.ready.done(_.bind(this.appReady,this))},appReady:function(){this.onUserChange()},reset:function(){this.connected=!1,o=null,u=null,this.profile={},this.registeredWithTwitter=!1,this.friendIDs=[],this.friends={},this.friendCount=0,this.followers={},this.followerIDs=[],this.followerCount=0,n.trigger("twitter:profile:update")},onUserChange:function(){l&&l.off("change:extraData",this.onUserDataChange,this),l=f.model.get("user"),this.reset(),typeof l.get("extraData")=="undefined"?l.on("change:extraData",this.onUserDataChange,this):this.onUserDataChange()},onUserDataChange:function(){if(l&&l.get("isLoggedIn")&&(l.get("Flags")&this.SERVICE_ID||l.get("Flags")&this.TWITTER_ONLY_SERVICE_ID)){this.registeredWithTwitter=(l.get("Flags")&this.TWITTER_ONLY_SERVICE_ID)>0;var e=l.get("extraData");e&&e.Twitter?this.onUserTwitterData(e.Twitter):gsConfig.runMode!=="production"&&console.error("Supposed to have Twitter data for auth user but undefined!!",l,e)}},onUserTwitterData:function(e){var t=$.Deferred();try{if(e){e.TwitterUserID&&e.OAuthToken&&e.OAuthSecret&&e.twitterProfileURL?(this.profile={id_str:e.TwitterUserID},o=e.OAuthToken,u=e.OAuthSecret,this.loadUserProfile(e.twitterProfileURL,e.twitterProfileCallback,t)):(gsConfig.runMode!=="production"&&console.error("onUserTwitterData returned invalid resp:",e),this.onAuthError(t,"onUserTwitterData returned invalid resp"),t.reject({error:"TWITTER_MISSING_LOGIN_INFO_ERROR_MSG"}));return}}catch(n){gsConfig.runMode!=="production"&&console.error("onUserTwitterData exception thrown:",n)}return this.reset(),t.reject({error:"TWITTER_MISSING_LOGIN_INFO_ERROR_MSG"}),t.promise()},onAuthError:function(e,t){console.log("onAuthError from twitter",t,e),e&&e.reject()},removeFromUser:function(){var e=$.Deferred();return this.profile&&this.profile.id_str?n.Services.API.removeUserTwitterData(this.profile.id_str,_.bind(this.onRemovedFromUser,this,e)):n.Services.API.removeUserTwitterData(null,_.bind(this.onRemovedFromUser,this,e)),e.promise()},onRemovedFromUser:function(e,t){if(!t||!t.success){e.reject();return}var n=l.get("Flags");l.set("Flags",(n|this.SERVICE_ID)-this.SERVICE_ID),this.reset(),e.resolve()},loadUserProfile:function(e,t,n){var r=!1;n||(n=$.Deferred(),r=!0),$.ajax({url:e,success:_.bind(this.onUserProfile,this,n),error:_.bind(this.onAuthError,this,n),dataType:"jsonp",jsonp:!1,jsonpCallback:t,cache:!0});if(r)return n.promise()},onUserProfile:function(e,r){r.id_str&&r.profile_image_url?(this.profile=r,this.connected=!0,n.trigger("twitter:profile:update"),e.resolve()):(gsConfig.runMode!=="production"&&console.error("onUserProfile returned unexpected resp:",r),this.onAuthError(t,"onUserProfile returned unexpected resp"),e.reject({error:"TWITTER_MISSING_LOGIN_INFO_ERROR_MSG"}))},login:function(t){var r=$.Deferred(),i=_.getCenteredCoordinates(650,600);return a=e.open("http://"+e.location.host+"/twitterCallback.php?window="+e.name,"","width=650,height=600,left="+i[0]+",top="+i[1]),this.loginDeferred=$.Deferred(),this.loginDeferred.always(_.bind(this.onLogin,this,r,t)),n.airbridge&&n.airbridge.isDesktop&&(a.parentSandboxBridge={confirmTwitterConnection:e.confirmTwitterConnection}),r.promise()},onLogin:function(e,t,r){console.log("Twitter:onLogin",r);if(r.error)e.reject({error:"LB_SIGNUP_LOGIN_FORM_TWITTER_ERROR"});else{if(!r.oauth_token||!r.oauth_token_secret){e.reject({error:"LB_SIGNUP_LOGIN_FORM_TWITTER_ERROR"});return}if(t){e.resolve(r);return}o=r.oauth_token,u=r.oauth_token_secret,delete r.oauth_token,delete r.oauth_token_secret,this.profile=r,l.get("isLoggedIn")?l.get("Flags")&this.SERVICE_ID||l.get("Flags")&this.TWITTER_ONLY_SERVICE_ID?n.Services.API.updateUserTwitterData(this.profile.id_str,o,u).done(_.bind(this.onSaveUserTwitterData,this,e)).fail(_.bind(e.reject,e)):n.Services.API.saveUserTwitterData(this.profile.id_str,o,u).done(_.bind(this.onSaveUserTwitterData,this,e)).fail(_.bind(e.reject,e)):n.Services.API.authenticateTwitterUser(this.profile.id_str,o,u).done(_.bind(this.onAuthTwitterUser,this,e)).fail(_.bind(e.reject,e))}},onAuthTwitterUser:function(e,t){console.log("onAuthTwitterUser",t);if(t&&t.TwitterProfile&&t.TwitterProfile.name){this.profile=t.TwitterProfile;if(t.userID<=0){if(t.loginReason==1){e.reject({error:"LB_SIGNUP_LOGIN_FORM_CLAIM_PENDING"});return}this.register(e)}else t.oauthToken=o,t.oauthSecret=u,e.resolve(t),n.trigger("twitter:profile:update")}else t&&t.loginReason==1?e.reject({error:"LB_SIGNUP_LOGIN_FORM_CLAIM_PENDING"}):e.reject({error:"TWITTER_MISSING_LOGIN_INFO_ERROR_MSG"})},onSaveUserTwitterData:function(e,t){console.log("onSaveUserTwitterData",t);if(t.result==1&&t.twitterProfileURL&&t.twitterProfileCallback){this.loadUserProfile(t.twitterProfileURL,t.twitterProfileCallback),t.oauthToken=o,t.oauthSecret=u,e.resolve(t);var n=l.get("Flags");!(n&this.SERVICE_ID)&&!(n&this.TWITTER_ONLY_SERVICE_ID),l.set("Flags",n|this.SERVICE_ID)}else t.result===-1?e.reject({error:"TWITTER_DUPLICATE_ACCOUNT_ERROR_MSG"}):t.result===-2?e.reject({error:"TWITTER_MISSING_LOGIN_INFO_ERROR_MSG"}):e.reject({error:"LB_SIGNUP_LOGIN_FORM_TWITTER_ERROR"})},connectionLogout:function(){var t=_.getCenteredCoordinates(1e3,580);e.open("https://twitter.com/logout","","width=1000,height=580,status=1,location=1,resizable=yes,left="+t[0]+",top="+t[1])},register:function(e){if(!this.profile||!this.profile.screen_name){e.reject({error:"LB_SIGNUP_LOGIN_FORM_TWITTER_ERROR"});return}var t=this.profile.screen_name,r=_.orEqual(this.profile.name,""),i=this.profile.id_str||Math.floor(Math.random()*997508)+1005;r||t?n.Services.API.getUsernameSuggestions(t,r,i).done(_.bind(this.openRegisterLightbox,this,e)).fail(_.bind(function(t){e.reject({error:"LB_SIGNUP_LOGIN_FORM_TWITTER_ERROR"})},this,e)):e.reject({error:"LB_SIGNUP_LOGIN_FORM_TWITTER_ERROR"})},openRegisterLightbox:function(e,t){var i=r.model.get("user").get("subscription").premiumRequired(),s={signupType:"twitter",details:{oauthToken:o,oauthSecret:u,twitterUserID:this.profile.id},values:{username:_.orEqual(t[0],""),name:this.profile.name},premiumRequired:i,_canClose:!i};n.trigger("lightbox:close"),n.trigger("lightbox:open","signup",s)},shareLink:function(t,n,r){if(o&&u)return this.postTweet(r,n);var i=$.Deferred(),s=_.getCenteredCoordinates(700,280);return r=r.replace(t,""),e.open("http://twitter.com/share?related=grooveshark&via=grooveshark&url="+encodeURIComponent(t)+"&text="+encodeURIComponent(r),"","width=700,height=280,left="+s[0]+",top="+s[1]),i.resolve(!0,!0),i.promise()},postTweet:function(e,t){var r=$.Deferred();return o&&u?(e.length<123&&(e+=" via @grooveshark"),n.Services.API.postTwitterStatus(e,o,u).done(_.bind(c,this,r,t)).fail(_.bind(h,this,r,t))):r.reject(),r.promise()}},e.confirmTwitterConnection||(e.confirmTwitterConnection=function(t){console.log("twitter confirm connection",t),a&&(a.close(),a=null);var r=n.Services.Twitter.loginDeferred;if(!r)return;try{t=$.parseJSON(t)}catch(i){r.reject({error:"parseError"});return}t.mode==="cancel"||t.error==="cancel"?r.reject({error:"cancel"}):n.airbridge&&n.airbridge.isDesktop?e.setTimeout(function(){r.resolve(t)},300):r.resolve(t)})}(),function(){function l(e,t){var r=new $.Deferred;return e?(t.format="json",$.ajax({url:e,data:t,success:_.bind(c,this,r),error:_.bind(h,this,r),dataType:"jsonp",cache:!0})):n.Services.API.makeLastfmRequest(t,_.bind(c,this,r),_.bind(h,this,r)),r.promise()}function c(e,t){if(typeof t!="object")try{t=$.parseJSON(t)}catch(n){}if(t&&t.error){h(e,t);return}e&&e.resolve(t)}function h(e,t){if(typeof t!="object")try{t=$.parseJSON(t)}catch(n){}e&&e.reject(t)}function p(e){e.user?($.extend(this.profile,e.user),this.connected=!0,n.trigger("lastfm:profile:update")):d(e)}function d(e){this.reset()}n.Services=n.Services||{};var t,r,i,s,o,u,a=!1,f;n.Services.Lastfm={SERVICE_ID:2,API_KEY:"b1ecfd8a5f8ec4dbb4cdacb8f3638f6d",loginDeferred:null,P_VERSION:"1.2.1",URL_USER_AUTH:"http://www.last.fm/api/auth",URL_AUDIOSCROBBLER:"http://ws.audioscrobbler.com/2.0/",CLIENT_ID:"gvs",CLIENT_VERSION:"1",MINIMUM_DURATION:120,SCROBBLING_FLAG:1,DEFAULT_FLAGS:1,connected:!1,profile:{},scrobblingEnabled:!1,init:function(e){i=e,i.model.on("change:user",this.onUserChange,this),o=i.model.get("player"),u=o.get("currentQueue"),o.on("change:currentQueue",this.onQueueChange,this),n.ready.done(_.bind(this.appReady,this))},appReady:function(){this.onUserChange()},reset:function(){this.connected=!1,this.profile={},t=null,this.suspendScrobbling(),f=null,n.trigger("lastfm:profile:update")},onUserChange:function(){s&&s.off("change:extraData",this.onUserDataChange,this),s=i.model.get("user"),this.reset(),typeof s.get("extraData")=="undefined"?s.on("change:extraData",this.onUserDataChange,this):this.onUserDataChange()},onUserDataChange:function(){if(s&&s.get("isLoggedIn")&&s.get("Flags")&this.SERVICE_ID){var e=s.get("extraData");e&&e.Lastfm?this.onUserLastfmData(e.Lastfm):gsConfig.runMode!=="production"&&console.error("Supposed to have Lastfm data for auth user but undefined!!",s,e)}},onUserLastfmData:function(e){try{e&&e.Session&&e.LastfmUsername?(this.profile={username:e.LastfmUsername,flags:0},t={session:e.Session},typeof e.FlagScrb=="undefined"&&typeof e.FlagFav=="undefined"?this.profile.flags=1:(e.FlagScrb&&(this.profile.flags=this.profile.flags|this.SCROBBLING_FLAG),e.FlagFav&&(this.profile.flags=this.profile.flags|this.FAVORITES_FLAG)),this.profile.flags&this.SCROBBLING_FLAG&&this.enableScrobbling(),this.loadProfile()):(gsConfig.runMode!=="production"&&console.error("onUserLastfmData returned invalid resp:",e),this.onAuthError("onUserLastfmData returned invalid resp"));return}catch(n){gsConfig.runMode!=="production"&&console.error("onUserLastfmData exception thrown:",n)}this.reset()},onAuthError:function(e,t){this.showReAuthLightbox(),t&&t.reject()},removeFromUser:function(){var e=$.Deferred();return this.profile&&this.profile.username?n.Services.API.removeLastfmService(this.profile.username,_.bind(this.onRemovedFromUser,this,e)):n.Services.API.removeLastfmService(null,_.bind(this.onRemovedFromUser,this,e)),e.promise()},onRemovedFromUser:function(e,t){if(!t||!t.success){e.reject();return}var n=s.get("Flags");s.set("Flags",(n|this.SERVICE_ID)-this.SERVICE_ID),this.reset(),e.resolve()},login:function(){var t=$.Deferred(),i=_.getCenteredCoordinates(950,700),s="http://"+e.location.host+"/lastfmCallback.php?window="+e.name;return r=e.open(this.URL_USER_AUTH+"?api_key="+this.API_KEY+"&cb="+encodeURIComponent(s),"","width=950,height=700,left="+i[0]+",top="+i[1]),this.loginDeferred=$.Deferred(),this.loginDeferred.always(_.bind(this.onLogin,this,t)),n.airbridge&&n.airbridge.isDesktop&&(r.parentSandboxBridge={confirmLastfmConnection:e.confirmLastfmConnection}),t.promise()},onLogin:function(e,t){console.log("Lastfm:onLogin",t);if(t.error)e.reject({error:"LB_SIGNUP_LOGIN_FORM_LASTFM_ERROR"});else{if(!t.token){e.reject({error:"LB_SIGNUP_LOGIN_FORM_LASTFM_ERROR"});return}s.get("Flags")&this.SERVICE_ID?n.Services.API.updateLastfmService("",t.token,"",0,0,_.bind(this.onSaveUserLastfmData,this,e)):(typeof this.profile.flags=="undefined"&&(this.profile.flags=this.DEFAULT_FLAGS),n.Services.API.saveLastfmService("",t.token,"",this.profile.flags,_.bind(this.onSaveUserLastfmData,this,e)),this.enableScrobbling())}},onSaveUserLastfmData:function(e,n){console.log("onSaveUserLastfmData",n);if(n.result>0&&n.lastfmData&&n.lastfmData.user){this.profile.username=n.lastfmData.user,t={session:n.lastfmData.session},this.connected=!0,this.loadProfile().done(function(){e.resolve()}).fail(function(){e.reject({error:"LASTFM_PROBLEM_CONNECTING_ERROR_MSG"})});var r=s.get("Flags");s.set("Flags",r|this.SERVICE_ID)}else n.result===-1?e.reject({error:"LASTFM_DUPLICATE_ACCOUNT_ERROR_MSG"}):n.result===-3?e.reject({error:"LASTFM_PROBLEM_CONNECTING_ERROR_MSG"}):e.reject({error:"LB_SIGNUP_LOGIN_FORM_LASTFM_ERROR"})},saveFlags:function(e){var r=$.Deferred(),i=0,s=0;return e&this.SCROBBLING_FLAG?(i|=this.SCROBBLING_FLAG,this.enableScrobbling()):(s|=this.SCROBBLING_FLAG,this.suspendScrobbling()),e&this.FAVORITES_FLAG?i|=this.FAVORITES_FLAG:s|=this.FAVORITES_FLAG,this.profile.flags=this.profile.flags&~s|i,n.service.updateLastfmService(t.session,"",this.profile.username,i,s,_.bind(this.onSaveUserLastfmData,this,r,null)),r.promise()},loadProfile:function(){if(!t||!t.session)return!1;var e=new $.Deferred,n={method:"user.getinfo",sk:t.session,api_key:this.API_KEY};l(this.URL_AUDIOSCROBBLER,n).done(_.bind(p,this)).fail(_.bind(d,this))},getPicture:function(){if(this.connected&&this.profile.image)for(var e=Math.min(2,this.profile.image.length);e>=0;e--)if(this.profile.image[e]["#text"])return this.profile.image[e]["#text"];return"http://cdn.last.fm/flatness/catalogue/noimage/2/default_user_large.png"},onQueueChange:function(){u&&u.off(null,null,this),u=o.get("currentQueue"),u.on("change:activeSong",this.onPlayStatusChange,this)},suspendScrobbling:function(){this.scrobblingEnabled=!1,a&&(o.off("change:playStatus",this.onPlayStatusChange,this),o.off("change:position",this.onPositionChange,this),a=!1)},enableScrobbling:function(){this.scrobblingEnabled=!0,o&&!a&&(o.on("change:playStatus",this.onPlayStatusChange,this),o.on("change:position",this.onPositionChange,this),a=!0,this.onPlayStatusChange())},shouldScrobble:function(){return this.profile&&this.profile.flags&this.SCROBBLING_FLAG&&this.scrobblingEnabled},onPlayStatusChange:function(){if(!this.shouldScrobble()||!t||o.get("playStatus")!==n.Models.Player.playStatuses.PLAYING)return;var e=u.get("activeSong");if(!e||typeof e.get("queueSongID")!="number"){f=null;return}if(!f||e.get("queueSongID")!==f.queueSongID||e.get("SongID")!==f.songID)f={songID:e.get("SongID"),queueSongID:e.get("queueSongID"),secondsListened:0,scrobbled:!1};else{if(u.get("repeatMode")!==n.Models.Player.repeatModes.ONE||e.get("queueSongID")!==f.queueSongID)return;f.scrobbled=!1,f.secondsListened=0}var r={album:e.get("AlbumName"),artist:e.get("ArtistName"),method:"track.updateNowPlaying",track:e.get("SongName"),sk:t.session,api_key:this.API_KEY};e.get("TrackNum")&&typeof e.get("TrackNum")=="number"&&(r.trackNumber=String(e.get("TrackNum"))),typeof e.get("EstimateDuration")=="number"&&(r.duration=Math.round(e.get("EstimateDuration"))),l(null,r)},onPositionChange:function(){if(!this.shouldScrobble()||!t||o.get("playStatus")!==n.Models.Player.playStatuses.PLAYING)return;var e=o.get("currentQueue").get("activeSong");if(!e||typeof e.get("queueSongID")!="number"){f=null;return}if(!f||e.get("queueSongID")!==f.queueSongID||e.get("SongID")!==f.songID)return;f.secondsListened+=.5;if(o.get("duration")>this.MINIMUM_DURATION*1e3&&f.secondsListened>30&&!f.scrobbled){var r=new Date,i=Math.round(r.getTime()/1e3),s={album:e.get("AlbumName"),artist:e.get("ArtistName"),track:e.get("SongName"),timestamp:i,duration:Math.round(o.get("duration")/1e3),method:"track.scrobble",sk:t.session,api_key:this.API_KEY};e.get("TrackNum")&&typeof e.get("TrackNum")=="number"&&(s.trackNumber=String(e.get("TrackNum")));if(e&&e.get("context")){switch(e.get("context").streamType){case n.Models.PlayContext.TYPE_STATION:case n.Models.PlayContext.TYPE_RADIO:case n.Models.PlayContext.TYPE_DMCA_RADIO:case n.Models.PlayContext.TYPE_BROADCAST:s.chosenByUser=0;break;default:s.chosenByUser=1}e.get("context").type=="radio"&&(s.chosenByUser=0)}f.scrobbled=!0,f.timestamp=i,l(null,s)}},deleteLastScrobble:function(){var e=o.get("currentQueue").get("activeSong");if(!e||!t||!f||!f.scrobbled)return;var n={album:e.get("AlbumName"),artist:e.get("ArtistName"),track:e.get("SongName"),timestamp:f.timestamp+"",method:"library.removeScrobble",sk:t.session,api_key:this.API_KEY};f=null,l(null,n)}},e.confirmLastfmConnection||(e.confirmLastfmConnection=function(t){console.log("lastfm confirm connection",t),r&&(r.close(),r=null);var i=n.Services.Lastfm.loginDeferred;if(!i)return;try{t=$.parseJSON(t)}catch(s){i.reject({error:"parseError"});return}n.airbridge&&n.airbridge.isDesktop?e.setTimeout(function(){i.resolve(t)},300):i.resolve(t)})}(),function(){n.Services=n.Services||{};var t=0,r=!1,i,s,o,u,a,f;n.Services.Flattr={loadFlattrJS:function(){if(typeof e.FlattrLoader=="object"){r||this.onFlattrJSLoaded();return}if($.browser.msie&&$.browser.version<=6)return;var n=null,i=this;t++;try{if($("#flattr-js script").length)$("#flattr-js").empty(),e.FlattrLoader=null;else if(!document.getElementById("flattr-js")){var s=document.createElement("div");s.id="flattr-js",document.body.appendChild(s)}var o=document.createElement("script");o.async=!0,o.src=document.location.protocol+"//api.flattr.com/js/0.6/load.js?mode=manual&popout=0&revsharekey="+this.REV_SHARE_KEY;var u=function(){if($.browser.msie&&this.readyState&&this.readyState!=="complete"&&this.readyState!=="loaded")return;this.onload=this.onreadystatechange=null,setTimeout(function(){e.FlattrLoader&&(clearTimeout(n),i.onFlattrJSLoaded())},100)};o.onload=o.onreadystatechange=u,document.getElementById("flattr-js").appendChild(o)}catch(o){console.error("Could not load Flattr JS. Fatal Error: ",o)}n=setTimeout(function(){!e.FlattrLoader&&t<3?i.loadFlattrJS():!e.FlattrLoader&&t>=3},2e4)},onFlattrJSLoaded:function(){if(typeof e.FlattrLoader!="object"||!e.FlattrLoader)return;r=!0,this.parseWidgets()},parseWidgets:function(){if(typeof e.FlattrLoader!="object"||!e.FlattrLoader){this.loadFlattrJS();return}try{e.FlattrLoader.setup()}catch(t){}},SERVICE_ID:131072,CLIENT_ID:"QAzyxeB9yS0VqfQ3e0l6AQef5VIVnbW3CmsZqTYPCPBSUhLY8XVyDZEyKcjXe6RG",REV_SHARE_KEY:"05e1a1",URL_USER_AUTH:"https://flattr.com/oauth/authorize",musicBrainzArtistURL:"http://musicbrainz.org/artist/",musicBrainzSongURL:"http://musicbrainz.org/recording/",URL_REST_API:"https://api.flattr.com/rest/v2/",connected:!1,profile:{},loginDeferred:null,tmpAutoOff:!1,flags:0,DEFAULT_FLAGS:0,FLATTR_AUTO_PER_MONTH_FLAG:1,FLATTR_AUTO_PER_STREAM_FLAG:2,FLATTR_AUTO_PER_FAVORITE_FLAG:4,lastError:"",init:function(e){u=e,u.model.on("change:user",this.onUserChange,this),n.on("manatee:flattrData",_.bind(this.onAutoFlattr,this)),n.on("flattr:flattrCount",_.bind(this.onAutoSubmitThingLookup,this)),n.on("flattr:renderEmbed",_.bind(this.renderEmbedButton,this)),n.Services.SWF.ready.then(_.bind(function(){n.Services.SWF.setFlattr(this.profile.autoPerMonth)},this)),o=u.model.get("player"),o.on("change:currentQueue",function(){o.get("currentQueue").on("change:activeSong",this.onActiveSongChange,this)},this),n.ready.done(_.bind(this.appReady,this))},appReady:function(){this.onUserChange()},reset:function(){this.connected=!1,this.profile={},f=null,n.Services.SWF&&_.isFunction(n.Services.SWF.setFlattr)&&n.Services.SWF.setFlattr(!1),n.trigger("flattr:profile:update")},onUserChange:function(){a&&a.off("change:extraData",this.onUserDataChange,this),a=u.model.get("user"),this.reset(),typeof a.get("extraData")=="undefined"?a.on("change:extraData",this.onUserDataChange,this):this.onUserDataChange()},onUserDataChange:function(){if(a&&a.get("isLoggedIn")&&a.get("Flags")&this.SERVICE_ID){var e=a.get("extraData");e&&e.Flattr?this.onUserFlattrData(e.Flattr):gsConfig.runMode!=="production"&&console.error("Supposed to have Flattr data for auth user but undefined!!",a,e)}},onUserFlattrData:function(e){var t=$.Deferred();try{e&&e.AccessToken&&e.FlattrUsername?(s=e.AccessToken,this.profile={},this.profile.username=e.FlattrUsername,this.profile.flags=0,this.profile.autoPerMonth=!1,this.profile.autoPerStream=!1,this.profile.autoPerFavorite=!1,e.Flags&&(this.profile.flags=e.Flags,e.Flags&this.FLATTR_AUTO_PER_MONTH_FLAG?(this.profile.autoPerMonth=!0,o.on("change:position",this.onPositionChange,this)):e.Flags&this.FLATTR_AUTO_PER_STREAM_FLAG&&(this.profile.autoPerStream=!0),e.Flags&this.FLATTR_AUTO_PER_FAVORITE_FLAG&&(this.profile.autoPerFavorite=!0)),this.loadUserProfile(t)):(gsConfig.runMode!=="production"&&console.error("onUserFlattrData returned invalid resp:",e),this.onFlattrError("FLATTR_MISSING_LOGIN_INFO_ERROR_MSG"),t.reject());return}catch(n){gsConfig.runMode!=="production"&&console.error("onUserFlattrData exception thrown:",n)}return this.reset(),t.reject(),this.onFlattrError("FLATTR_MISSING_LOGIN_INFO_ERROR_MSG"),t.promise()},loadUserProfile:function(e){var t=!1;e||(e=$.Deferred(),t=!0);var r={access_token:s};n.Services.API.makeFlattrRequest("user?compat-errors",r,"GET").always(_.bind(this.onUserProfile,this,e));if(t)return e.promise()},onUserProfile:function(e,t){try{t=$.parseJSON(t)}catch(r){e.reject(),this.onFlattrError("FLATTR_MISSING_LOGIN_INFO_ERROR_MSG");return}t&&!t.error&&t.username?(t.avatar?this.profile.avatar=t.avatar:this.profile.avatar=gsConfig.assetHost+"webincludes/css/images/services/flattr-small.png",this.profile.link=t.link,this.profile.username=t.username,this.profile.firstname=t.firstname,this.profile.lastname=t.lastname,this.connected=!0,n.trigger("flattr:profile:update"),e.resolve()):(gsConfig.runMode!=="production"&&console.error("flattr::onUserProfile returned unexpected resp:",t),e.reject())},removeFromUser:function(){var e=$.Deferred();return n.Services.API.removeUserFlattrData().always(_.bind(this.onRemovedFromUser,this,e)),e.promise()},onRemovedFromUser:function(e,t){if(!t){this.onFlattrError("FLATTR_PROBLEM_REMOVING_MSG"),e.reject();return}var n=a.get("Flags");a.set("Flags",(n|this.SERVICE_ID)-this.SERVICE_ID),this.reset(),e.resolve()},login:function(){var t=$.Deferred(),r=_.getCenteredCoordinates(850,600),s="http://"+e.location.host+"/flattrCallback.html",o="window-"+e.name;return i=e.open(this.URL_USER_AUTH+"?response_type=token&scope=flattr&client_id="+this.CLIENT_ID+"&redirect_uri="+encodeURIComponent(s)+"&state="+encodeURIComponent(o),"","width=850,height=600,left="+r[0]+",top="+r[1]),this.loginDeferred=$.Deferred(),this.loginDeferred.always(_.bind(this.onLogin,this,t)),n.airbridge&&n.airbridge.isDesktop&&(i.parentSandboxBridge={confirmFlattrConnection:e.confirmFlattrConnection}),t.promise()},onLogin:function(e,t){console.log("Flattr:onLogin",t);if(t.error)e.reject(),this.onFlattrError("FLATTR_MISSING_LOGIN_INFO_ERROR_MSG");else{if(!t.accessToken){e.reject(),this.onFlattrError("FLATTR_MISSING_LOGIN_INFO_ERROR_MSG");return}console.log("Flattr:onLogin got access token:",t.accessToken),s=t.accessToken,this.loadUserProfile().done(_.bind(function(){console.log("Flattr:onloadUserProfile"),typeof this.profile.flags=="undefined"&&(this.profile.flags=this.DEFAULT_FLAGS),a.get("Flags")&this.SERVICE_ID?n.Services.API.updateUserFlattrData(s,this.profile.username,this.profile.flags).always(_.bind(this.onSaveUserFlattrData,this,e)):n.Services.API.saveUserFlattrData(s,this.profile.username,this.profile.flags).always(_.bind(this.onSaveUserFlattrData,this,e))},this))}},onSaveUserFlattrData:function(e,t){if(t==1){this.connected=!0,e.resolve();var n=a.get("Flags");a.set("Flags",n|this.SERVICE_ID)}else t===-1?(e.reject(),this.onFlattrError("FLATTR_NAME_ALREADY_IN_USE")):(e.reject(),this.onFlattrError("FLATTR_MISSING_LOGIN_INFO_ERROR_MSG"))},enableListenAndFlattr:function(){var e=$.Deferred(),t=this.profile.flags|this.FLATTR_AUTO_PER_MONTH_FLAG;return n.Services.API.updateUserFlattrData(s,this.profile.username,t).then(_.bind(function(e,n){this.profile.flags=t,this.profile.autoPerMonth=!0,o.on("change:position",this.onPositionChange,this),e.resolve()},this,e)).fail(_.bind(function(e){this.onFlattrError("FLATTR_PROBLEM_UPDATING_MSG"),e.reject()})),e.promise()},disableListenAndFlattr:function(){var e=$.Deferred(),t=this.profile.flags&~this.FLATTR_AUTO_PER_MONTH_FLAG;return n.Services.API.updateUserFlattrData(s,this.profile.username,t).then(_.bind(function(e,n){this.profile.flags=t,this.profile.autoPerMonth=!1,o.off("change:position",this.onPositionChange,this),e.resolve()},this,e)).fail(_.bind(function(e){this.onFlattrError("FLATTR_PROBLEM_UPDATING_MSG"),e.reject()})),e.promise()},enableFavoriteAndFlattr:function(){var e=$.Deferred(),t=this.profile.flags|this.FLATTR_AUTO_PER_FAVORITE_FLAG;return n.Services.API.updateUserFlattrData(s,this.profile.username,t).then(_.bind(function(e,n){this.profile.flags=t,this.profile.autoPerFavorite=!0,e.resolve()},this,e)).fail(_.bind(function(e){this.onFlattrError("FLATTR_PROBLEM_UPDATING_MSG"),e.reject()})),e.promise()},disableFavoriteAndFlattr:function(){var e=$.Deferred(),t=this.profile.flags&~this.FLATTR_AUTO_PER_FAVORITE_FLAG;return n.Services.API.updateUserFlattrData(s,this.profile.username,t).then(_.bind(function(e,n){this.profile.flags=t,this.profile.autoPerFavorite=!1,e.resolve()},this,e)).fail(_.bind(function(e){this.onFlattrError("FLATTR_PROBLEM_UPDATING_MSG"),e.reject()})),e.promise()},connectionLogout:function(){var t=_.getCenteredCoordinates(800,720);e.open("https://flattr.com/session/logout","","width=800,height=720,status=1,location=1,resizable=yes,left="+t[0]+",top="+t[1])},onActiveSongChange:function(){var e=u.model.get("player").get("currentQueue");if(!e)return;var t=e.get("activeSong");if(!t||typeof t.get("queueSongID")!="number"){f=null;return}if(!f||t.get("queueSongID")!==f.queueSongID||t.get("SongID")!==f.songID)f={songID:t.get("SongID"),queueSongID:t.get("queueSongID"),secondsListened:0,flattrd:!1,MusicBrainzID:null,artistID:t.get("ArtistID")};else{if(e.get("repeatMode")!==n.Models.Player.repeatModes.ONE||t.get("queueSongID")!==f.queueSongID)return;f.flattrd=!1,f.secondsListened=0}t&&this.connected&&this.profile.autoPerMonth&&n.Services.SWF.setFlattr(!0)},onPositionChange:function(){if(!this.connected||this.tmpAutoOff||o.get("playStatus")!==n.Models.Player.playStatuses.PLAYING)return;var e=u.model.get("player").get("currentQueue");if(!e)return;var t=e.get("activeSong");if(!t||typeof t.get("queueSongID")!="number"){f=null;return}if(!f||t.get("queueSongID")!==f.queueSongID||t.get("SongID")!==f.songID)return;f.secondsListened+=.5;if(f.secondsListened*1e3/o.get("duration")>=.8&&f.MusicBrainzID&&!f.flattrd){var r=new Date,i=Math.round(r.getTime()/1e3);f.flattrd=!0,this.flattrURL(f.MusicBrainzID,{artistID:f.artistID,isSong:f.isSong})}},onAutoFlattr:function(e){if(!e)return;var t=e.pageInfo,n=e.songPageInfo;(t.Data.MusicBrainzID||n.Data&&n.Data.MusicBrainzID)&&f&&(f.isSong=n.Data&&n.Data.MusicBrainzID,f.MusicBrainzID=f.isSong?n.Data.MusicBrainzID:t.Data.MusicBrainzID)},flattrURL:function(e,t){var r=t&&t.isSong?this.musicBrainzSongURL:this.musicBrainzArtistURL,i={access_token:s,url:"http://flattr.com/submit/auto?url="+r+e+"&category=audio&tags=music"};n.Services.API.makeFlattrRequest("flattr?compat-errors",i,"POST").always(_.bind(this.onFlattrURLComplete,this,t))},onFlattrURLComplete:function(e,t){var n=e.artistID;try{t=JSON.parse(t)}catch(r){console.log("onFlattrURLComplete - bad json"),this.onFlattrError();return}if(t.message&&t.message=="ok")e&&e.notify&&this.onFlattrSuccess();else if(t.error)switch(t.error){case"flattr_once":break;case"flattr_owner":break;case"no_means":this.onFlattrError("FLATTR_SERVICE_TEMP_OFF"),this.tmpAutoOff=!0;break;case"not_found":case"invalid_request":case"unauthorized":default:this.onFlattrError()}},onFavoriteAndFlattr:function(e){e.getPageNameData().done(_.bind(function(t){t.MusicBrainzID?this.flattrURL(t.MusicBrainzID,{artistID:e.get("ArtistID"),notify:!0,isSong:!0}):n.Models.Artist.getCached([e.get("ArtistID")]).getPageNameData().done(_.bind(function(t){this.flattrURL(t.MusicBrainzID,{artistID:e.get("ArtistID"),notify:!0})},this))},this))},onFlattrError:function(e){if(!e||!e.length)e="FLATTR_SERVICE_DEFAULT_ERROR";var t=_.getString(e);n.trigger("notification:add",{title:"Flattr",description:t,type:"error"})},onFlattrSuccess:function(e){if(!e||!e.length)e="FLATTR_SERVICE_DEFAULT_SUCCESS_FLATTR";var t=_.getString(e);n.trigger("notification:add",{title:"Flattr",description:t,icon:"flattr icon-flattr-white-active",type:"success"})},onAutoSubmitThingLookup:function(e){var t=$.Deferred(),r={};return e.url=this.musicBrainzArtistURL+e.mbID,n.Services.API.makeFlattrRequest("things/lookup/?compat-errors&url=http://flattr.com/submit/auto?url="+encodeURIComponent(e.url),r,"POST").always(_.bind(function(e,t){try{t=JSON.parse(t),e.resolve(t)}catch(n){this.onFlattrError(),e.reject()}},this,t)),t.promise()},getFlattrList:function(e){var t=$.Deferred(),r={count:30};return n.Services.API.makeFlattrRequest("things/"+e+"/flattrs",r,"GET").always(_.bind(function(e,t){try{t=JSON.parse(t),e.resolve(t)}catch(n){this.onFlattrError(),e.reject()}},this,t)),t.promise()},parseButtons:function(){e.FlattrLoader&&$.each($("a.FlattrButton"),function(t,n){e.FlattrLoader.loadButton(n)})},renderEmbedButton:function(e,t,n){var r="flattr;popout:0;category:audio;tags:music",i=e.data("song")?this.musicBrainzSongURL:this.musicBrainzArtistURL;n&&(r="flattr;button:compact;popout:0;category:audio;tags:music");var s=$('<a class="FlattrButton" style="display:none;" rev="'+r+'" href="'+i+t+'"></a>');e.append(s),this.parseWidgets()},isUserConnected:function(){return a&&a.get("isLoggedIn")&&a.get("Flags")&this.SERVICE_ID},isUserListenAndFlattr:function(){return this.profile.autoPerMonth},isUserFavoriteAndFlattr:function(){return this.profile.autoPerFavorite}},e.confirmFlattrConnection||(e.confirmFlattrConnection=function(t){console.log("flattr confirm connection",t),i&&(i.close(),i=null);var r=n.Services.Flattr.loginDeferred;if(!r)return;try{t=$.parseJSON(t)}catch(s){r.reject({error:"parseError"});return}if(!t.hash){r.reject({error:"invalid"});return}var o={accessToken:null},u=t.hash.match(/access\_token\=([a-zA-Z0-9\-\_]+)/);u&&u[1]&&(o.accessToken=u[1]),n.airbridge&&n.airbridge.isDesktop?e.setTimeout(function(){r.resolve(t)},300):r.resolve(o)})}(),function(){function a(e,t,r,i,s){if(s.feed&&s.feed.entry){var o=s.feed.entry,a=[],c={};_.forEach(o,function(e){if(!e.media$group||!e.media$group.media$thumbnail)return;c={Author:"",Description:"",Duration:0,Rating:0,LikeRatio:0,VideoID:"",Plays:0,URL:"",Title:"",Thumbnails:[]},e.author&&e.author[0]&&e.author[0].name&&e.author[0].name.$t?c.Author=e.author[0].name.$t:e.media$group.media$credit&&e.media$group.media$credit.$t&&(c.Author=e.media$group.media$credit.$t),e.media$group.media$description&&e.media$group.media$description.$t&&(c.Description=e.media$group.media$description.$t),e.media$group.yt$duration&&e.media$group.yt$duration.seconds&&(c.Duration=parseInt(e.media$group.yt$duration.seconds,10)),e.gd$rating&&e.gd$rating.average&&(c.Rating=parseFloat(e.gd$rating.average)),e.yt$rating&&e.yt$rating.numLikes&&e.yt$rating.numDislikes&&(c.LikeRatio=parseInt(e.yt$rating.numLikes,10)/parseInt(e.yt$rating.numDislikes,10));if(e.media$group.yt$videoid&&e.media$group.yt$videoid.$t)c.VideoID=e.media$group.yt$videoid.$t;else if(e.id){var t=e.id.split(":");c.VideoID=t[t.length-1]}e.yt$statistics&&e.yt$statistics.viewCount&&(c.Plays=parseInt(e.yt$statistics.viewCount,10)),e.title&&e.title.$t&&(c.Title=e.title.$t),e.link&&e.link[0]&&e.link.href&&(c.URL=e.link.href),_.forEach(e.media$group.media$thumbnail,function(e){if(e.yt$name)switch(e.yt$name){case"default":c.Thumbnails.unshift(e);return;case"hqdefault":c.Thumbnails.length&&c.Thumbnails[0].yt$name==="default"?c.Thumbnails.splice(1,0,e):c.Thumbnails.unshift(e);return}c.Thumbnails.push(e)}),c.type="youtube",c=new n.Models.Video(c),a.push(c)}),t&&(a=l(t,a)),u[r]=a,e.resolve(a.slice(0,i))}else f(e,s)}function f(e,t){e.reject(t)}function l(e,t){var n=[],r="";e&&e.get("ArtistName")&&(r=e.get("ArtistName").match(/[a-z0-9]/gi).join("").toLowerCase());var i=9.7,s=8.98,o=4.209,u=4.01,a=2.41,f=2.101,l=1.201,c=.82,h=.203;return _.forEach(t,function(e,p){if(e.get("VideoID")&&e.get("Author")&&e.get("durationSecs")>60){e.weight=Math.floor(u*(t.length-p));var d=e.get("Author").toLowerCase();d.lastIndexOf("vevo")>-1?e.weight*=i:d.lastIndexOf("emimusic")>-1?e.weight*=s:d.lastIndexOf("warnerbrosrecords")>-1?e.weight*=s:d.lastIndexOf("hollywoodrecords")>-1?e.weight*=s:d.lastIndexOf("records")>-1&&(e.weight*=o),r&&d.indexOf(r)>-1&&(e.weight*=f);var v=e.get("Title").toLowerCase();v.lastIndexOf("parody")>-1?e.weight*=h:v.lastIndexOf("official")>-1?e.weight*=a:v.lastIndexOf("cover")>-1?e.weight*=l:v.lastIndexOf("live")>-1&&(e.weight*=c);for(var m=0;m<n.length;m++)if(n[m].weight<e.weight){n.splice(m,0,e);return}n.push(e)}}),n}function c(t,n){var r={callbacks:[],addEvent:function(r,i){if(_.isFunction(i)){var s="yt"+r+n+Math.floor(Math.random()*1001);e[s]=i,i=s,this.callbacks.push(s)}t.addEventListener(r,i)},play:function(){t.playVideo()},playVideoAt:function(e){t.playVideoAt(e)},pause:function(){t.pauseVideo()},isPaused:function(){var e=this.getState();return e!=1&&e!=3},getState:function(){return t.getPlayerState()},stop:function(){t.stopVideo()},getCurrentTime:function(){return t.getCurrentTime()},getDuration:function(){return t.getDuration()},getVideoUrl:function(){return t.getVideoUrl()},getVolume:function(){return t.getVolume()/100},setVolume:function(e){t.setVolume(e*100)},loadVideoById:function(e){t.loadVideoById(e)},loadVideoByUrl:function(e){t.loadVideoByUrl(e)}};return $(t).parent().bind("remove",function(){try{r.callbacks&&r.callbacks.length&&_.forEach(r.callbacks,function(t){e[t]=null})}catch(t){}}),r}n.Services=n.Services||{};var t=[],r="http://gdata.youtube.com/feeds/api/videos",i="AI39si6SJVyxgw9MFbAdbXE-wbtZFdTl8qnY2UWX3dFA97c9PrcfAYDpqUh0iLeVEkurJsjUvDmObBWvLX-wmsy_kW8KHAgN-Q",s="Grooveshark",o,u={};n.Services.Youtube={init:function(n){o=n,e.onYouTubePlayerReady=function(e){var n=c($("#"+e)[0],e);t[e]&&(t[e](n),delete t[e])}},searchViaSong:function(e){var t="",n='"'+e.get("SongName").replace(/[\(\[][a-zA-Z0-9\s]+[\]\)]/g,"")+'"';return e.get("ArtistName").toLowerCase()!="unknown"&&e.get("ArtistName").toLowerCase()!="unknown artist"?t=['"'+e.get("ArtistName")+'"'||"",n||""].join(" "):t=n,t=$.trim(t),this.search(t,5,e)},search:function(e,t,n){var o=$.Deferred();e=$.trim(_.orEqual(e,"")),t=_.orEqual(t,5);if(!e)o.reject();else if(u[e])o.resolve(u[e].splice(0,t));else{var l="jQueryYoutube"+OAuth.nonce(10),c={"max-results":Math.min(t,15),orderBy:"relevance",safeSearch:"none",alt:"json-in-script",time:"all_time","start-index":1,q:e,callback:l,key:i,v:2,category:"music|Music|EMI|VEVO|official|Official",restriction:gsConfig.remoteAddr,format:5},h=r;OAuth.completeRequest({method:"GET",action:h,parameters:c},{consumerKey:s,consumerSecret:i});var p=OAuth.getParameterMap(c);h=h+"?"+$.param(p),$.ajax({url:h,success:_.bind(a,this,o,n,e,t),error:_.bind(f,this,o),dataType:"jsonp",jsonp:!1,jsonpCallback:l,cache:!0})}return o.promise()},attachPlayer:function(e,r,i,s,o){var u=new $.Deferred,a="videoYTObj"+s;if(!e||_.notDefined(e))u.reject();else{var f="http://www.youtube.com/v/"+e+"?version=3&enablejsapi=1&version=3&fs=1&playerapiid="+a,l={},c={allowScriptAccess:"always",allowFullScreen:"true"},h={id:a,name:a,allowFullScreen:"true"};r=r||480,i=i||385,o=_.orEqual(o,!0),t[a]=function(e){return u.resolve(e),o&&e.play(),!0},swfobject.embedSWF(f,s,r,i,"8",null,l,c,h),n.trigger("guts:log","youtubeLoadVideoById",{youtubeVideoID:e}),n.trigger("guts:gatrack","youtube","loadVideoById",e)}return u.promise()}}}(),function(){function o(e){var t={callbacks:[],addEvent:_.bind(e.addEvent,e),loadVideoById:function(t){var n=new $.Deferred,r=$(e.element);return e.unload(),r.attr("src","http://player.vimeo.com/video/"+t+"?api=1&player_id="+r.attr("id")),e=$f(r),e.addEvent("ready",_.bind(u,this,n,e)),n.promise()}};return t}function u(e,t){t=o(t),e.resolve(t)}n.Services=n.Services||{};var t=[],r,i=new $.Deferred,s=0;n.Services.Vimeo={init:function(e){r=e},loadPlayerJS:function(){if(typeof e.Froogaloop=="function"){i.state()==="pending"&&this.onPlayerJSLoaded();return}var t=null,n=this;s++;try{if($("#froogaloop-js script").length)$("#froogaloop-js").empty(),e.Froogaloop=null;else if(!document.getElementById("froogaloop-js")){var r=document.createElement("div");r.id="froogaloop-js",document.body.appendChild(r)}var o=document.createElement("script");o.async=!0,o.src="/gs/resources/froogaloop.min.js";var u=function(){if($.browser.msie&&this.readyState&&this.readyState!=="complete"&&this.readyState!=="loaded")return;this.onload=this.onreadystatechange=null,setTimeout(function(){e.Froogaloop&&(clearTimeout(t),n.onPlayerJSLoaded())},300)};o.onload=o.onreadystatechange=u,document.getElementById("froogaloop-js").appendChild(o)}catch(o){console.error("Could not load Froogaloop JS. Fatal Error: ",o)}t=setTimeout(function(){!e.Froogaloop&&s<3&&n.loadPlayerJS()},2e4)},onPlayerJSLoaded:function(){if(typeof e.Froogaloop!="function")return;i.resolve()},attachPlayer:function(e,t,r,s){this.loadPlayerJS();var o=new $.Deferred,a="videoVObj"+s;return i.done(_.bind(function(){if(!e||_.notDefined(e))o.reject();else{var i="http://player.vimeo.com/video/"+e+"?api=1&player_id=videoVObj"+s+"&autoplay=1";t=t||480,r=r||385;var f=document.createElement("iframe");f.className="vimeo",f.src=i,f.id=a,f.width=t,f.height=r;if(!document.getElementById(s)){o.reject();return}document.getElementById(s).appendChild(f);var l=$f(f);l.addEvent("ready",_.bind(u,this,o,l)),n.trigger("guts:log","vimeoLoadVideoById",{youtubeVideoID:e}),n.trigger("guts:gatrack","vimeo","loadVideoById",e)}},this)),o.promise()}}}(),function(){n.External=n.External||{};var t,r,i,s,o,u,a;if(e.parentSandboxBridge){u=e.parentSandboxBridge,e.console.error=u.consoleError;function f(e){var t={};for(var n in e)e.hasOwnProperty(n)&&(typeof e[n]=="object"?t[n]=f(e[n]):t[n]=e[n]);return t}n.Services&&n.Services.Local&&(n.Services.Local.set=u.storeSet,n.Services.Local.remove=u.storeRemove,n.Services.Local.clear=u.storeClear,n.Services.Local.get=function(e){var t=u.storeGet(e);return typeof t=="object"?f(t):t}),e.gsConfig.assetHost="http://"+e.location.host}var l=_.throttle(function(){var e=r.get("currentQueue");e!==i&&(i&&i.off(null,null,this),i=e,i&&i.on("change:activeSong",l,this));var t=i?i.get("activeSong"):null;t!==s&&(s&&s.off(null,null,this),s=t,s&&s.on("change:smile change:frown change:isFavorite change:fromLibrary",l,this));var n=this.getQueueStatus(),u=!1;for(var a in n)if(n.hasOwnProperty(a)&&n[a]!==o[a]){u=!0;break}o=n,c()},500),c=_.throttle(function(){u&&u.playerChange()},500);n.External.AIRBridge={isDesktop:!1,init:function(f){e.parentSandboxBridge&&(this.isDesktop=!0,e.childSandboxBridge=this,t=f,r=t.get("player"),r.on("change:playStatus change:currentQueue",l,this),i=r.get("currentQueue"),i&&(i.on("change:activeSong",l,this),s=i.get("activeSong"),s&&s.on("change:smile change:frown change:isFavorite change:fromLibrary",l,this)),o=this.getQueueStatus(),$("body").delegate('a[target="_blank"]',"click",function(e){if($(e.target).closest("a").hasClass("airNoFollow"))return;e.preventDefault();var t=$(e.target).closest("a").attr("href");return u.consoleWarn(t),t&&u.navigateToUrl(t,"_blank"),!1}),a=e.open,e.open=function(t,n,r){return r=_.orEqual(r,"width=800,height=600"),n=="_blank"?u.navigateToUrl(t,n):a.call(e,t,n,r)}),n.ready.then(function(){u&&(u.ready(),$("body").addClass("airbridge"))})},getDesktopPreferences:function(){return u?u.getDesktopPreferences():null},setDesktopPreferences:function(e){u&&u.setDesktopPreferences(e)},displayNotification:function(e,t){n.trigger("notification:add",{title:"",description:getString(t),url:""})},buildSong:function(e,t){if(!e||!e instanceof n.Models.QueueSong)return null;var r=e._wrapped,i={SongID:r.attributes.SongID,SongName:r.attributes.SongName,ArtistID:r.get("ArtistID"),ArtistName:r.get("ArtistName"),AlbumID:r.get("AlbumID"),AlbumName:r.get("AlbumName"),queueSongID:e.attributes.queueSongID};return t&&(i.url=r.get("token")?"http://grooveshark.com/"+r.toUrl().replace("#!/",""):"",i.imageUrl=r.getImageURL()),i},getQueueStatus:function(){var e={activeSong:this.buildSong(s,!0),autoplayEnabled:i?i.attributes.autoplayEnabled:!1,currentAutoplayTagID:i?i.attributes.currentAutoplayTagID:0,hasRestoreQueue:r.attributes.previousQueue&&(!i||!i.attributes.songs||!i.attributes.songs.length),nextSong:i?this.buildSong(i.attributes.nextSong):null,playStatus:r.attributes.playStatus,previousSong:i?this.buildSong(i.attributes.previousSong):null,queueID:i?i.attributes.queueID:"",repeatMode:i?i.attributes.repeatMode:0,shuffleEnabled:i?i.attributes.shuffleEnabled:!1};return s||(e.playStatus=0),e},setHash:function(e){n.router.setHash(e)},safeToClose:function(){return e.onbeforeunload()},addSongsToQueueAt:function(){return n.Services.SWF.addSongsToQueueAt.apply(n.Services.SWF,arguments)},playSong:function(){return n.Services.SWF.playSong.apply(n.Services.SWF,arguments)},pauseSong:function(){return n.Services.SWF.pauseSong.apply(n.Services.SWF,arguments)},resumeSong:function(){return n.Services.SWF.resumeSong.apply(n.Services.SWF,arguments)},stopSong:function(){return n.Services.SWF.stopSong.apply(n.Services.SWF,arguments)},previousSong:function(){return n.Services.SWF.previousSong.apply(n.Services.SWF,arguments)},nextSong:function(){return n.Services.SWF.nextSong.apply(n.Services.SWF,arguments)},flagSong:function(){return n.Services.SWF.flagSong.apply(n.Services.SWF,arguments)},voteSong:function(){return n.Services.SWF.voteSong.apply(n.Services.SWF,arguments)},getIsMuted:function(){return n.Services.SWF.getIsMuted.apply(n.Services.SWF,arguments)},setIsMuted:function(){return n.Services.SWF.setIsMuted.apply(n.Services.SWF,arguments)},getVolume:function(){return n.Services.SWF.getVolume.apply(n.Services.SWF,arguments)},setVolume:function(){return n.Services.SWF.setVolume.apply(n.Services.SWF,arguments)},getShuffle:function(){return n.Services.SWF.getShuffle.apply(n.Services.SWF,arguments)},setShuffle:function(){return n.Services.SWF.setShuffle.apply(n.Services.SWF,arguments)},setAutoplay:function(){return n.Services.SWF.setAutoplay.apply(n.Services.SWF,arguments)},clearQueue:function(){return n.Services.SWF.clearQueue.apply(n.Services.SWF,arguments)},getRepeat:function(){return n.Services.SWF.getRepeat.apply(n.Services.SWF,arguments)},setRepeat:function(){return n.Services.SWF.setRepeat.apply(n.Services.SWF,arguments)},addPlaylist:function(e,t,r){n.Models.Playlist.get(e).then(function(e){n.trigger("player:addSongs",e.get("songs").toArray(),t,r,new n.Models.PlayContext(e))})},addSongFromToken:function(e,t,r){n.Models.Song.getByToken(e).then(function(e){n.trigger("player:addSongs",[e],t,r)})},favoriteSong:function(e){n.Models.Song.get(e).then(function(n){t.get("user").favorite("Songs",e)})},unfavoriteSong:function(e){n.Models.Song.get(e).then(function(n){t.get("user").unfavorite("Songs",e)})},addSongToLibrary:function(e){n.Models.Song.get(e).then(function(n){t.get("user").addSongsToLibrary([e])})},removeSongFromLibrary:function(e){n.Models.Song.get(e).then(function(n){t.get("user").removeSongsFromLibrary([e])})},executeProtocol:function(e){n.External.PluginAPI.executeProtocol(e)}}}(),function(){function i(e){var i=r.model.get("player").get("currentQueue"),s=i&&i.get("activeSong");s&&i.get("autoplayEnabled")&&n.trigger("player:voteSong",s.get("queueSongID"),s.get("autoplayVote")===e?t.NEUTRAL:e)}function s(e){var n=r.model.get("player").get("currentQueue"),i=n&&n.get("currentBroadcast"),s=i&&i.get("activeSong");s&&i.voteActiveSong(s.get("userVote")===e?t.NEUTRAL:e)}n.External=n.External||{};var t={SMILE:1,UPVOTE:1,NEUTRAL:0,FROWN:-1,DOWNVOTE:-1},o=Backbone.Model.extend({initialize:function(e){this._model=e.model,_.each(this.defaults,_.bind(function(e,t){this._model.has(t)&&this.set(t,this._model.get(t))},this)),this.onBind()},onBind:function(){},unbind:function(){this._model&&(this._model.off(null,null,this),this._model=null)}}),u=o.extend({defaults:{playStatus:0,currentQueue:null},onBind:function(){var e=this._model.get("currentQueue");this.set("currentQueue",e?new a({model:e}):null),this._model.on("change:playStatus change:currentQueue",function(){this._model.hasChanged("playStatus")&&this.set("playStatus",this._model.get("playStatus"));if(this._model.hasChanged("currentQueue")){var e=this._model.get("currentQueue");this.get("currentQueue")&&this.get("currentQueue").unbind(),this.set("currentQueue",e?new a({model:e}):null)}},this)},isPlaying:function(){switch(this._model.get("playStatus")){case n.Models.Player.playStatuses.INITIALIZING:case n.Models.Player.playStatuses.LOADING:case n.Models.Player.playStatuses.PLAYING:case n.Models.Player.playStatuses.BUFFERING:return!0;case n.Models.Player.playStatuses.NONE:case n.Models.Player.playStatuses.PAUSED:case n.Models.Player.playStatuses.FAILED:case n.Models.Player.playStatuses.COMPLETED:default:return!1}}}),a=o.extend({defaults:{activeSong:null,autoplayEnabled:!1},onBind:function(){var e=this._model.get("activeSong");this.set("activeSong",e?new f({model:e}):null),this._model.on("change:activeSong change:autoplayEnabled",function(){if(this._model.hasChanged("activeSong")){var e=this._model.get("activeSong");this.get("activeSong")&&this.get("activeSong").unbind(),this.set("activeSong",e?new f({model:e}):null)}this._model.hasChanged("autoplayEnabled")&&this.set("autoplayEnabled",!!this._model.get("autoplayEnabled"))},this)},hasNext:function(){return!!this._model.get("nextSong")},hasPrev:function(){return!!this._model.get("previousSong")},inBroadcast:function(){return!!this._model.get("currentBroadcast")}}),f=o.extend({defaults:{SongName:"",SongID:0,ArtistName:"",ArtistID:0,AlbumName:"",AlbumID:0,fromLibrary:!1,isCallout:!1,smile:!1,frown:!1},onBind:function(){this._model.on("change:fromLibrary change:isCallout change:smile change:frown",function(){this._model.hasChanged("fromLibrary")&&this.set("fromLibrary",!!this._model.get("fromLibrary")),this._model.hasChanged("isCallout")&&this.set("isCallout",!!this._model.get("isCallout")),this._model.hasChanged("smile")&&this.set("smile",!!this._model.get("smile")),this._model.hasChanged("frown")&&this.set("frown",!!this._model.get("frown"))},this)},toSongUrl:function(){return this._model.toUrl()},toArtistUrl:function(){return this._model.toArtistUrl()},toAlbumUrl:function(){return this._model.toAlbumUrl()},getImageUrl:function(e){return this._model.getImageURL(e)}});n.External.DesktopBridge={init:function(){this.ready=$.Deferred(),this.player=null,this.active=!1,_.extend(this,Backbone.Events),e.nodeWebkit&&(this.active=!0,e.desktopBridge=this,n.ready.then(_.bind(this._onGsReady,this)))},_onGsReady:function(){this.player=new u({model:r.model.get("player")}),this.ready.resolve(this)},setHash:function(e){return n.router.setHash(e)},prevSong:function(e){return n.trigger("player:previousSong",e)},nextSong:function(){return n.trigger("player:nextSong")},togglePlay:function(){return n.trigger("player:togglePlay")},play:function(){switch(r.model.get("player").get("playStatus")){case n.Models.Player.playStatuses.NONE:case n.Models.Player.playStatuses.FAILED:case n.Models.Player.playStatuses.COMPLETED:return n.trigger("player:playSong");case n.Models.Player.playStatuses.PAUSED:default:return n.trigger("player:resumeSong")}},pause:function(){switch(r.model.get("player").get("playStatus")){case n.Models.Player.playStatuses.INITIALIZING:case n.Models.Player.playStatuses.LOADING:return n.Services.SWF.stopSong();case n.Models.Player.playStatuses.PLAYING:case n.Models.Player.playStatuses.BUFFERING:default:return n.trigger("player:pauseSong")}},stop:function(){return n.Services.SWF.stopSong()},incrementVolume:function(e){return n.trigger("player:volumeChange",n.Services.SWF.getVolume()+e)},toggleSmile:function(){return i(t.SMILE)},toggleFrown:function(){return i(t.FROWN)},toggleUpvote:function(){return s(t.UPVOTE)},toggleDownvote:function(){return s(t.DOWNVOTE)},toggleRadio:function(){return n.trigger("player:radio")},toggleCollection:function(){var e=r.model.get("user"),t=r.model.get("player").get("currentQueue"),n=t&&t.get("activeSong"),i=n&&n.get("SongID");n&&(n.get("fromLibrary")?e.removeSongsFromLibrary([i]):e.addSongsToLibrary([i]))},toggleFavorite:function(){var e=r.model.get("user"),t=r.model.get("player").get("currentQueue"),n=t&&t.get("activeSong"),i=n&&n.get("SongID");n&&(n.get("isFavorite")?e.unfavorite("Songs",i):e.favorite("Songs",i))},toggleShuffle:function(){return n.trigger("player:shuffle")},getSettings:function(){return},setSettings:function(){return}}}(),function(){function h(e,t){var n=t.shift(),r=e[n];return r?t.length?h(r,t):r:null}n.External=n.External||{};var t,r,i,s,o,u,a=[],f=!1,l={0:"none",1:"loading",2:"loading",3:"playing",4:"paused",5:"buffering",6:"failed",7:"completed"},c=["play","add","next"];n.External.PluginAPI={init:function(r){t=r,i=t.get("player"),i.on("change:playStatus change:currentQueue",this._onPlayerChange,this),s=i.get("currentQueue"),s&&(s.on("change:activeSong",this._onPlayerChange,this),o=s.get("activeSong"),o&&o.on("change:smile change:frown change:isFavorite change:fromLibrary",this._onPlayerChange,this)),n.ready.then(_.bind(function(){e.Grooveshark=this;if(e.postMessage&&e.addEventListener){var t=this.getAPIVersion(),n=this.getApplicationVersion();e.addEventListener("message",_.bind(this._onReceiveMessage,this),!1),setTimeout(function(){var r={Grooveshark:n,GroovesharkAPIReady:t};e.postMessage($.stringify(r),"*")},1e3)}},this))},_onReceiveMessage:function(t){var n=this.getApplicationVersion();try{t=$.parseJSON(t.data)}catch(r){f&&console.log("API: processing failed",r)}if(!t||typeof t!="object"||t.Grooveshark||!t.groovesharkAPI)return;var i=t.id,s=t.method||"",o=t.parameters,u;if(!f&&s!="enablePostMessage")return;if(typeof i!="number"&&typeof i!="string"){console.log("API: postMessage id required",t);return}if(!s||typeof s!="string"){console.log("API: postMessage method required",t);return}if(s.indexOf("_")===0||s=="init"){console.log("API: disabled "+s);return}_.isArray(o)||(o=[]);switch(s){case"setSongStatusCallback":u=_.bind(this[s],this)(function(t){var r=$.stringify({Grooveshark:n,id:i,method:s,result:t});e.postMessage(r,"*")});return;default:this[s]&&(u=this[s].apply(this,o))}var a=$.stringify({Grooveshark:n,id:i,method:s,result:u});e.postMessage(a,"*")},_onPlayerChange:function(e,t){var n=e.changedAttributes(),r=!1;if(!_.isEmpty(n)){n.currentQueue&&(r=!0,s&&s.off(null,null,this),s=i.get("currentQueue"),s&&s.on("change:activeSong",this._onPlayerChange,this));if(r||n.activeSong)o&&o.off(null,null,this),s?(o=s.get("activeSong"),o&&o.on("change:smile change:frown change:isFavorite change:fromLibrary",this._onPlayerChange,this)):o=null}a.length&&_.each(a,_.bind(function(e){_.isFunction(e)&&e(this._buildCurrentPlayStatus())},this))},getApplicationVersion:function(){return gsConfig.snapVersion},getAPIVersion:function(){return 1.6},executeProtocol:function(e){var t=e.toLowerCase();t.indexOf("gs://")!=-1&&(e=e.substring(5),t=t.substring(5)),e.charAt(e.length-1)=="/"&&(e=e.substring(0,e.length-1),t=t.substring(0,t.length-1));var r=t.split("/"),i=r.pop();_.indexOf(c,i)==-1&&(r.push(i),i="");if(r[0]=="themes"){n.trigger("lightbox:open","themes");return}if(i){e=e.substring(0,e.length-i.length-1);var s=n.Services.SWF.playSpecialIndexes.DEFAULT,o=!1;switch(i){case"play":o=!0;break;case"next":s=n.Services.SWF.playSpecialIndexes.NEXT}switch(r[0]){case"s":n.Models.Song.get(r[2]).then(function(e){n.trigger("player:addSongs",[e],s,o)});break;case"song":n.Models.Song.getByToken(r[2]).then(function(e){n.trigger("player:addSongs",[e],s,o)});break;case"album":n.Models.Album.get(r[2]).then(function(e){n.trigger("player:addSongs",e.get("songs").toArray(),s,o,new n.Models.PlayContext(e))});break;case"playlist":n.Models.Playlist.get(r[2]).then(function(e){n.trigger("player:addSongs",e.get("songs").toArray(),s,o,new n.Models.PlayContext(e))})}}if(r[0]=="search"){var u=r[r.length-1];e=e.substring(0,e.length-u.length),e+="?q="+u}n.router.setHash("/"+e)},getCurrentSongStatus:function(){return this._buildCurrentPlayStatus()},setSongStatusCallback:function(t){if(_.isFunction(t))a.push(t);else if(_.isString(t)){var n=t.split("."),r=h(e,n);_.isFunction(r)&&a.push(t)}return this._buildCurrentPlayStatus()},_buildCurrentPlayStatus:function(){var e={song:null,status:"none"};return o&&(e.song={songID:o.get("SongID"),songName:o.get("SongName"),artistID:o.get("ArtistID"),artistName:o.get("ArtistName"),albumID:o.get("AlbumID"),albumName:o.get("AlbumName"),trackNum:o.get("TrackNum"),estimateDuration:o.get("EstimateDuration")*1e3,artURL:o.getImageURL(),calculatedDuration:i.get("duration"),position:i.get("position"),vote:o.get("smile")?1:o.get("frown")?-1:0,isFavorite:!!o.get("isFavorite"),isInLibrary:!!o.get("fromLibrary")}),e.status=l[i.get("playStatus")],e},getPreviousSong:function(){var e=null;if(s){var t=s.get("previousSong");t&&(e={songID:t.get("SongID"),songName:t.get("SongName"),artistID:t.get("ArtistID"),artistName:t.get("ArtistName"),albumID:t.get("AlbumID"),albumName:t.get("AlbumName"),trackNum:t.get("TrackNum"),estimateDuration:t.get("EstimateDuration")*1e3,artURL:t.getImageURL(),vote:t.get("smile")?1:t.get("frown")?-1:0})}return e},getNextSong:function(){var e=null;if(s){var t=s.get("nextSong");t&&(e={songID:t.get("SongID"),songName:t.get("SongName"),artistID:t.get("ArtistID"),artistName:t.get("ArtistName"),albumID:t.get("AlbumID"),albumName:t.get("AlbumName"),trackNum:t.get("TrackNum"),estimateDuration:t.get("EstimateDuration")*1e3,artURL:t.getImageURL(),vote:t.get("smile")?1:t.get("frown")?-1:0})}return e},addSongsByID:function(e,t){var r=[],i=[];_.forEach(e,function(e){var t=n.Models.Song.get(e);t.then(function(e){i.push(e)}),r.push(t)}),$.when.apply($,r).then(function(){n.trigger("player:addSongs",i,n.Services.SWF.playSpecialIndexes.DEFAULT,t)})},addSongByToken:function(e,t){n.Models.Song.getByToken(e).done(function(e){n.trigger("player:addSongs",[e],n.Services.SWF.playSpecialIndexes.DEFAULT,t)})},addAlbumByID:function(e,t){n.Models.Album.get(e).done(function(e){e.getSongs().done(function(r){r=r&&r.toArray()||[],n.trigger("player:addSongs",r,n.Services.SWF.playSpecialIndexes.LAST,t,new n.Models.PlayContext(e))})})},addPlaylistByID:function(e,t){n.Models.Playlist.get(e).done(function(e){e.getSongs().done(function(r){r=r&&r.toArray()||[],n.trigger("player:addSongs",r,n.Services.SWF.playSpecialIndexes.LAST,t,new n.Models.PlayContext(e))})})},play:function(){!s.get("currentBroadcast")||s.get("isBroadcasting")?n.trigger("player:playSong"):n.trigger("player:volumeMute",!1)},pause:function(){!s.get("currentBroadcast")||s.get("isBroadcasting")?n.trigger("player:pauseSong"):n.trigger("player:volumeMute",!0)},seekToPosition:function(e){n.trigger("player:seekTo",e)},togglePlayPause:function(){!s.get("currentBroadcast")||s.get("isBroadcasting")?n.trigger("player:togglePlay"):n.trigger("player:volumeMute")},previous:function(){n.trigger("player:previousSong")},next:function(){n.trigger("player:nextSong")},setVolume:function(e){n.trigger("player:volumeChange",e)},getVolume:function(){return i.get("volume")},setIsMuted:function(e){n.trigger("player:volumeMute",e)},getIsMuted:function(){return i.get("isMuted")},voteCurrentSong:function(e){n.trigger("player:voteSong",o.get("queueSongID"),e)},getVoteForCurrentSong:function(){return o?o.get("smile")?1:o.get("frown")?-1:0:0},favoriteCurrentSong:function(){o&&t.get("user").favorite("Songs",o.get("SongID"))},setPlaylistsUpdateCallback:function(n){var i=function(t){r&&r.getPlaylists().done(_.bind(function(e){e.off("add remove reset",null,this)},this)),r=t,u?t.getPlaylists().done(_.bind(function(t){t.on("add remove reset",function(){var n=$.stringify({Grooveshark:this.getApplicationVersion(),method:"setPlaylistsUpdateCallback",type:"generic",result:t});e.postMessage(n,"*")},this);var n=$.stringify({Grooveshark:this.getApplicationVersion(),method:"setPlaylistsUpdateCallback",type:"generic",result:t});e.postMessage(n,"*")},this)):t.getPlaylists().done(_.bind(function(t){t.on("add",function(t){var n=$.stringify({Grooveshark:this.getApplicationVersion(),method:"setPlaylistsUpdateCallback",type:"add",result:t});e.postMessage(n,"*")},this),t.on("remove",function(t){var n=$.stringify({Grooveshark:this.getApplicationVersion(),method:"setPlaylistsUpdateCallback",type:"remove",result:t});e.postMessage(n,"*")},this),t.on("reset",function(){var n=$.stringify({Grooveshark:this.getApplicationVersion(),method:"setPlaylistsUpdateCallback",type:"reset",result:t});e.postMessage(n,"*")},this);var n=$.stringify({Grooveshark:this.getApplicationVersion(),method:"setPlaylistsUpdateCallback",type:"generic",result:t});e.postMessage(n,"*")},this))};u=n,t.on("change:user",i,this),i.call(this,t.get("user"))},addCurrentSongToLibrary:function(){o&&t.get("user").addSongsToLibrary([o.get("SongID")])},removeCurrentSongFromQueue:function(){o&&n.trigger("player:removeSongs",[o])},enablePostMessage:function(){f=!0},searchAlbums:function(e){},searchSongs:function(e){},toggleRadio:function(){n.trigger("player:radio")},getRadioStatus:function(){var e=i.get("currentQueue");return e&&(e.get("autoplayEnabled")||e.get("clientRadioEnabled"))}}}(),function(r){function s(e){o(e),u(e),a(e)}function o(t){e._gaq&&_gaq.push&&_gaq.push(["_trackPageview",t])}function u(t){var n={c1:2,c2:"8187464",c4:(location.protocol+"//"+location.host+"/"+t).replace("#!/","")};e.COMSCORE&&COMSCORE.beacon?COMSCORE.beacon(n):e._comscore.push(n)}function a(e){}function f(t,s){var o=i.model.get("user");if(_.defined(t.inviteCode)){gsConfig.inviteCode=t.inviteCode;var u=new Date,a=u.valueOf()+12096e5;try{n.Services.Local.set("lastInviteCode",{inviteCode:t.inviteCode,expires:a})}catch(f){}}if(t.hasOwnProperty("password")){var l={};t.hasOwnProperty("code")&&(l.resetCode=t.code),n.trigger("lightbox:open","forget",l)}t.hasOwnProperty("invite")&&n.trigger("lightbox:open","invite"),t.hasOwnProperty("signup")&&n.trigger("lightbox:open","signup"),t.hasOwnProperty("login")&&(!o||!o.get("isLoggedIn"))&&(s?n.trigger("lightbox:open","login",{onLogin:function(){setTimeout(function(){n.router.setHash(s)},0)}}):n.trigger("lightbox:open","login")),t.hasOwnProperty("testAds")&&(n.Models.Ad.useTestAds=!0,n.Models.Ad.useTestAdsValue=t.testAds);if(t.hasOwnProperty("asArtist")||t.hasOwnProperty("asartist")){var c=_.toInt(t.asArtist)||_.toInt(t.asartist);c&&o&&o.getOwnedArtists().done(function(e){if(e){var t=e.find(function(e){return e.get("ArtistID")===c});t}})}if(t.hasOwnProperty("measurePerformance")){var h=1,p=!1,d=function(){r("#grid ul.options").length?(top.hasLoaded("search"),n.player.addSongsToQueueAt([r("#grid ul.options:first").attr("rel")],-1,!0),setTimeout(v,h)):setTimeout(d,h)},v=function(){n.player.isPlaying&&!n.player.isLoading&&!p?(p=!0,top.hasLoaded("play")):setTimeout(v,h)};e.top&&e!=top&&_.isFunction(top.hasLoaded)&&(top.hasLoaded("page"),setTimeout(d,h),n.router.setHash("/search?q=quiet+company"))}if(t.hasOwnProperty("verifyEmailToken")){var m=t.verifyEmailToken;n.Services.API.userVerifyEmail(m).done(function(e){var t;switch(e.code){case 2:t="POPUP_EMAIL_VERIFIED_USER_CREATED",e.artist&&(t="POPUP_EMAIL_VERIFIED_ARTIST_CREATED"),o.get("isLoggedIn")||(e.artist?t="POPUP_EMAIL_VERIFIED_ARTIST_CREATED_LOGIN":t="POPUP_EMAIL_VERIFIED_USER_CREATED_LOGIN"),r.localize.ready.done(function(){n.trigger("notification:add",{icon:"email icon-email-white-active",type:"success",duration:1e4,description:_.getString(t)})});break;case 1:e.artist?t="POPUP_EMAIL_VERIFIED_ARTIST_CLAIM":t="POPUP_EMAIL_VERIFIED_USER",r.localize.ready.done(function(){n.trigger("notification:add",{icon:"email icon-email-white-active",type:"success",duration:1e4,description:_.getString(t)})});break;case-1:r.localize.ready.done(function(){n.trigger("notification:add",{type:"error",duration:0,description:_.getString("POPUP_EMAIL_VERIFY_MISMATCH")})});break;case-2:r.localize.ready.done(function(){n.trigger("notification:add",{type:"error",duration:0,click:function(){n.Services.API.resendEmailToken(m).done(function(){n.trigger("notification:add",{icon:"email icon-email-white-active",type:"success",description:_.getString("EMAIL_VERIFY_FAILED_RESENT_EMAIL")})})},description:_.getString("POPUP_EMAIL_VERIFY_EXPIRED")})});break;default:r.localize.ready.done(function(){n.trigger("notification:add",{type:"error",duration:1e4,description:_.getString("POPUP_EMAIL_VERIFY_FAILED")})})}}).fail(function(){n.trigger("notification:add",{type:"error",duration:1e4,description:_.getString("POPUP_EMAIL_VERIFY_FAILED")})}),n.router.setHash("/")}}function h(e,t){extraGutsParams=_.orEqual(t,!1);var n=_.defined(e.search),r=_.defined(e.notFound),s=_.defined(e.reason)?e.reason:!1;i.page.setPage("home",{id:0,focusSearch:n,notFound:r,reason:s})}function p(e){var t=new x(e.splat,"login","id","section","subpage","subpageData");i.page.setPage("user",{id:t.id,subpage:t.subpage,section:t.section,subpageData:t.subpageData,login:t.login})}function d(e){var t=e.splat;t&&t[0]==="profile"&&t.shift();var n=new x(t,"login","id","section","subpage","subpageData");n.artistID=e.artistID,i.page.setPage("profile",{id:n.id,subpage:n.subpage,section:n.section,subpageData:n.subpageData,artistID:e.artistID,isFollowReq:!!e.follow})}function v(e){var t=e.splat.shift(),n=new x(e.splat,"name","id","subpage","subpageData");n.subpageData&&(n.subpage==="comment"||n.subpage==="activity")&&(n.subpage+="/"+n.subpageData),t==="artist"&&n.subpage==="dashboard"?i.page.setPage("artistDashboard",{id:n.id,subpage:n.subpageData}):i.page.setPage(t,{id:n.id,subpage:_.orEqual(n.subpage,"profile"),subpageData:n.subpageData,playOnLoad:e.play,name:n.name})}function m(e){var t=e.splat.shift(),n=new x(e.splat,"subpage");n.section=t,t==="apply"&&(n.subpage=t,n.section="careers"),i.page.setPage("static",{subpage:_.orEqual(n.subpage,""),section:_.orEqual(n.section,"")})}function g(e,t){e.loadSubscription().done(function(e){i.page.setPage("settings",{subpage:"subscriptions"}),!e.hasSubscription()&&t&&n.trigger("lightbox:open","payments")})}function y(e,t){var n=e.indexOf("/");return n!==-1?e.substring(0,n)+"/"+t+e.substring(n):e+"/"+t}function b(e){var n=new x(e.splat,"subpage","type");n.subpage=="popular"&&(n.subpage="songs");if(n.subpage==="daily"||n.subpage==="weekly"||n.subpage==="monthly")n.type=n.subpage,n.subpage="songs";i.page.setPage("popular",{subpage:n.subpage||t,type:n.type||t})}function w(e){var t=new x(e.splat,"subpage","tag","tagID");i.page.setPage("broadcasts",{subpage:t.subpage,tag:t.tag,tagID:t.tagID,period:e.period,date:e.date})}function S(){var t=this;this._routes=[],this._lastHash="",this._history=[],this._wasReplace=null,this._historyIndex=0,this._nextHashShift=0,this._pageNameCache={},this.hasBack=!1,this.hasForward=!1,this.setHash=function(t){t===null&&(t="notFound"),t=_.cleanHash(t),e.location.hash=t},this.replaceHash=function(t){t===null&&(t="notFound"),t=_.cleanHash(t),this._wasReplace=[e.location.hash,t],e.location.replace(e.location.protocol+"//"+e.location.hostname+"/"+t)},this.get=function(e,t,n){n=_.orEqual(n,this);if(!(e instanceof RegExp)&&!_.isString(e)){console.error("invalid route, must be String or RegExp");return}_.isString(e)&&(e=new RegExp("^"+e+"$")),this._routes.push({path:e,callback:t,context:n})},this.notFound=function(){this.replaceHash("notFound")},this.back=function(){this.navHistory(-1)},this.forward=function(){this.navHistory(1)},this.navHistory=function(e){var t=this._historyIndex+e;t>=0&&t<this._history.length&&(this._nextHashShift=e,this.setHash(this._history[t]))},this.performSearch=function(e,t){t=t.toString();if(t.indexOf("http://")===0&&t.indexOf("tinysong")==-1){t=t.substring(7),this.setHash(t);return}e=e.toLowerCase(),t=encodeURIComponent(t),t=t.replace(/%20/g,"+"),e?this.setHash("/search/"+e+"?q="+t):this.setHash("/search?q="+t)},this.cachePageName=function(e,t,n){this._pageNameCache[e]={type:t,id:n}},this.uncachePageName=function(e){this._pageNameCache.hasOwnProperty(e)&&delete this._pageNameCache[e]},this.run=function(n){i=n,i.render(),this.page={activate:function(){},getPageClass:function(){return r.Deferred()}},r(e).hashchange(function(e){var n=location.hash;n&&n.length&&(n=location.href.substring(location.href.indexOf("#"))),t._onHashChange(n)}),r(e).trigger("hashchange")},this._onHashChange=function(e){if(e!==this._lastHash){var t=i.page.getCurrentPageView(),r=t?t.blockPageChange():!1;if(r&&!confirm(r)){this.replaceHash(this._lastHash);return}}e=e||"#!/",this._lastHash=e,s(e);if(this._nextHashShift!==0){var o=this._historyIndex+this._nextHashShift;o>=0&&o<this._history.length&&this._history[o]==e?this._historyIndex=o:this._nextHashShift=0}this._nextHashShift===0&&(this._history=this._history.slice(0,this._historyIndex+1),e&&(this._wasReplace&&this._history.length&&this._wasReplace[0]===this._history[this._history.length-1]&&this._wasReplace[1]===e&&this._history.pop(),this._history.push(e)),this._historyIndex=this._history.length-1),this._nextHashShift=0,this._wasReplace=null;var u=this._parseQueryString(e),a=decodeURIComponent(e.replace(E,"")),l=this._getRouteForPath(a);if(!l){this.notFound();return}var c=a.match(l.path);c.shift(),u.splat=c,_.isFunction(l.callback)&&(l.callback.call(l.context,u),f(u,a)),this.hasBack=this._history.length&&this._historyIndex>0,this.hasForward=this._history.length&&this._historyIndex<this._history.length-1,n.trigger("router:change")},this._getRouteForPath=function(e){var t,n,r;for(n=0,r=this._routes.length;n<r;n++)if(this._routes[n].path.test(e)){t=this._routes[n];break}return t},this._parseQueryString=function(e){var t={},n=/\+/g,r,i,s,o,u;r=e.match(E);if(r){i=r[1].split("&");for(o=0,u=i.length;o<u;o++){s=i[o].split("=");if(s[0]==="q"||s[0]==="query")s[1]=s[1].replace(n,"%20");t=this._parseParamPair(t,decodeURIComponent(s[0]),decodeURIComponent(s[1]))}}return t},this._parseParamPair=function(e,t,n){return e[t]?_isArray(e[t])?e[t].push(n):e[t]=[e[t],n]:e[t]=n,e},this._getTypeIDForPageName=function(e){var i=r.Deferred(),s,o,u;return _.defined(this._pageNameCache[e])?i.resolve(this._pageNameCache[e]):n.Services.API.getItemByPageName(e).done(function(r){if(r&&r.type){u=r[r.type];if(!u){i.reject(r);return}u.PathName=e,u.pageNameData=r.data,u.pageNameSource="router";switch(r.type){case"user":s=n.Models.User.newOrUpdate(u,{notifyCache:!0}),o=s.id,o<1&&(o=0);break;case"artist":s=n.Models.Artist.newOrUpdate(u,{notifyCache:!0}),s._gotExtraDetails=!0,o=s.id;break;case"album":s=n.Models.Album.newOrUpdate(u,{notifyCache:!0}),o=s.id;break;case"theme":s=u,o=u.themeID;break;default:console.log("unknown type for PageName",r.type,e),i.reject(r);return}if(!o){i.reject(r);return}t._pageNameCache[e]={type:r.type,id:o,item:s},i.resolve(t._pageNameCache[e])}else i.reject(r)}).fail(function(e){i.reject(e)}),i.promise()}}function x(){var e=r.makeArray(arguments),t=e.shift()[0],n=this;if(_.isEmpty(t)){n.length=0;return}var i=t.replace(/\/$/,"").split("/");n.length=i.length;var s;_.forEach(i,function(t,r){s=e[r],n[s]=t})}var i;typeof e._comscore!="object"&&(e._comscore=[]),n.router=new S;var l="",c=null;n.router.get("",function(e){h(e)}),n.router.get(/^#!?\/$/,function(e){h(e)}),n.router.get(/^#!?\/notFound\/?$/,function(e){e.notFound=!0,h(e)}),n.router.get(/^#!?\/whatisbroadcast\/?$/,function(e){n.trigger("lightbox:open","broadcastAbout"),h({reason:"whatisbroadcast"})}),n.router.get(/^#!?\/user\/(.*)\/?$/,p),n.router.get(/^#!?\/profile\/(.*)\/?$/,d),n.router.get(/^#!?\/playlist\/(.*)\/?/,function(e){var t=new x(e.splat,"name","id","subpage","subpageData");if(t.subpage==="comment"||t.subpage==="activity")t.subpage+="/"+t.subpageData;i.page.setPage("playlist",{id:t.id,subpage:_.orEqual(t.subpage,"profile"),playOnLoad:e.play})}),n.router.get(/^#!?\/s(?:ong)?\/(.*)\/?/,function(e){var t=new x(e.splat,"name","token","subpage","subpageData");if(t.subpage==="comment"||t.subpage==="activity")t.subpage+="/"+t.subpageData;i.page.setPage("song",{id:t.token,subpage:_.orEqual(t.subpage,""),fbComment:e.fbComment})}),n.router.get(/^#!?\/(album|artist|promotion)\/(.*)\/?/,v),n.router.get(/^#!?\/(about|legal|contact|press|press_release|logo|artists|careers|apply)(?:\/?|\/(.*))$/,m),n.router.get(/^#!\/redeem\/?(.*)\/?/,function(e){var t=new x(e.splat,"type","code");!t.code&&t.type&&(t.code=t.type),h(t);var i=function(){n.trigger("lightbox:open","payments",{code:t.code,tab:"redeem"})};n.getLoggedInUserID()<1?r.localize.ready.done(function(){n.trigger("lightbox:open","login",{message:_.getString("POPUP_EREDEEM_CODE_LOGIN_REQUIRED"),onLogin:i})}):i()}),n.router.get(/^#!?\/login(?:$|\/(.*)\/?)/,function(e){var t=new x(e.splat,"type");h({reason:"login"}),n.getLoggedInUserID()<1&&n.trigger("lightbox:open","login",{type:t.type})}),n.router.get(/^#!?\/themes(?:$|\/(.*)\/?)/,function(e){var t=new x(e.splat,"type");h(t),n.trigger("lightbox:open","themes",{type:t.type})}),n.router.get(/^#!?\/(theme)\/(.*)\/?/,function(e){var t=e.splat.shift(),r=new x(e.splat,"name","themeid","type");n.trigger("theme:set",{temporary:!0,manual:!0,themeID:r.themeid,name:r.name}),h(r)}),n.router.get(/^#!?\/boxee(?:$|\/(.*)\/?)/,function(e){var t=new x(e.splat,"type");h({reason:"boxee"})}),n.router.get(/^#!?\/perks(?:$|\/(.*)\/?)/,function(e){var t=new x(e.splat,"type");h(t),n.theme.setCurrentTheme(163,!0),n.trigger("lightbox:open","vipPerks")}),n.router.get(/^#!?\/gift(?:$|\/(.*)\/?)/,function(e){var t=new x(e.splat,"type");h({reason:"gift"});var s=new Date;s.getMonth()>=10&&i.theme.setCurrentTheme(945);var o=function(){n.trigger("lightbox:open","payments",{action:"purchase"})};n.getLoggedInUserID()<1?r.localize.ready.done(function(){n.trigger("lightbox:open","login",{message:_.getString("POPUP_BUY_CODE_LOGIN_REQUIRED"),onLogin:o})}):o()}),n.router.get(/^#!?\/upgrade(?:$|\/(.*)\/?)/,function(e){var t=new x(e.splat,"type"),r=new Date;r.getMonth()>=10&&i.theme.setCurrentTheme(945);var s=i.model.get("user");s&&s.get("isLoggedIn")?g(s,!0):(g(s,!1),n.trigger("lightbox:open","login",{message:_.getString("LB_LOGIN_MUST_LOGIN_TO_UPGRADE"),onLogin:g}))}),n.router.get(/^#!?\/leap\/?/,function(){var e=i.model.get("user");e.loadSubscription().done(function(e){n.router.setHash("/settings/subscription")}),n.trigger("lightbox:open","slider",{slideTemplate:"/lightbox/leapAbout",sliderName:"slider-leapAbout"}),n.trigger("leap:loadLib")}),n.router.get(/^#!?\/(sessions)/,function(e){h({reason:"sessions"})}),n.router.get(/^#!?\/search(?:$|\/(.*)\/?)/,function(e){var t=new x(e.splat,"type"),n,r;i.page.setPage("search",{id:e.q||e.query,type:t.type,query:e.q||e.query})}),n.router.get(/^#!?\/surveys(?:$|\/(.*)\/?|\/(.*)\/(.*)\/?)/,function(e){i.page.setPage("surveys",{})}),n.router.get(/^#!?\/(?:now_playing|queue)(?:$|\/(.*)\/?)/,function(t){var s=new x(t.splat,"songName","songToken"),o=t.splat.input.replace("/now_playing/","/s/").replace("/queue/","/s/");if(s.songToken&&s.songToken.length){n.router.replaceHash(o),r(e).trigger("hashchange");return}i.page.setPage("nowPlaying",{id:0})}),n.router.get(/^#!?\/popular(?:$|\/(.*)\/?)/,b),n.router.get(/^#!?\/broadcasts?(?:$|\/(.*)\/?)/,w),n.router.get(/^#!?\/signup(?:$|\/(.*)\/?)/,function(){n.router.replaceHash("/"),n.trigger("lightbox:open","signup")}),n.router.get(/^#!\/recommended(?:$|\/(.*)\/?)/,function(e){var t=new x(e.splat,"subpage","type");i.page.setPage("recommended",{subpage:t.subpage||"",type:t.type||""})}),n.router.get(/^#!\/(?:music|explore)(?:$|\/(.*)\/?)/,function(e){var t=new x(e.splat,"subpage","type");t.subpage=="popular"?b(e):h(e)}),n.router.get(/^#!\/(?:tag|genre)(?:$|\/(.*)\/?)/,function(e){var t=new x(e.splat,"tagName","tagID","subpage");t.tagName===""?self.notFound():i.page.setPage("tag",{tagName:t.tagName||"",tagID:t.tagID||"",id:t.tagID||"",subpage:t.subpage||""})}),n.router.get(/^#!\/(?:tags|genres)(?:$|\/(.*)\/?)/,function(e){var t=new x(e.splat,"subpage","type");i.page.setPage("tags",{subpage:t.subpage||"",type:t.type||""})}),n.router.get(/^#!\/(?:community)(?:$|\/(.*)\/?)/,function(e){var t=new x(e.splat,"subpage","type");i.page.setPage("community",{subpage:t.subpage||"",type:t.type||""})}),n.router.get(/^#!?\/(.*)\/?$/,function(e){var t=new x(e.splat,"page","subpage","type"),r,s=this;r=t.page;if(t.page=="anywhere"||t.page=="subscription"){n.router.replaceHash("/settings/subscription");return}t.page=="popular"&&b(),t.page=="genres"&&(r=t.page="tags");var o=i.page.setPage(r,t);o.fail(_.bind(function(){this._getTypeIDForPageName(t.page).done(function(t){switch(t.type){case"user":e.splat[1]=y(e.splat[0],t.id),e.splat[0]="profile",d(e);break;case"artist":e.splat[1]=y(e.splat[0],t.id*-1),e.splat[0]="profile",e.artistID=t.id,d(e);break;case"album":e.splat[1]=y(e.splat[0],t.id),e.splat[0]=t.type,v(e);break;case"theme":var n=t.item.themeName?t.item.themeName:"x",r=t.id;t.item.pageNameData.isPromo?s.setHash("/promotion/"+n+"/"+r):s.setHash("/theme/"+n+"/"+r);break;default:console.log("cant handle pageName type",t),s.notFound()}}).fail(function(e){s.notFound()})},this))}),n.router.get(/^#!?(?:[a-z0-9A-Z])/,function(e){if(n.page.activePage&&n.page.activePage){var t=n.page.activePage.url;t=t.replace(/(&|\?)fb_comment_id=([a-zA-Z0-9\_\-]+)/,"$1fbComment");var r=n.page.activePage.element.controller();r.scrollToFBComment&&r.scrollToFBComment(),location.replace(t)}});var E=/\?([^#]*)$/}(jQuery);var n=typeof n!="undefined"?n:{},r;n.dispatcher=_.extend({},Backbone.Events),n.trigger=_.bind(n.dispatcher.trigger,n.dispatcher),n.on=_.bind(n.dispatcher.on,n.dispatcher),n.off=_.bind(n.dispatcher.off,n.dispatcher),n.once=_.bind(n.dispatcher.once,n.dispatcher);var s=new $.Deferred;n.ready=s.promise(),n.loadedTokenData=!1,e.GS=n;var o=setTimeout(function(){var t=$("#page-inner"),n=$("body"),r=$("#offline-notification"),i;e.gsLocale&&e.gsLocale.OFFLINE_RELOAD_MSG?i=e.gsLocale.OFFLINE_RELOAD_MSG:i="You appear to be offline. Please check your internet connection and try reloading the page.",n.addClass("offline"),t.removeClass("hide"),r.removeClass("hide"),t.find("p").html(i)},2e4);n.on("tokenData",function(i){function c(){var e=document.title||"";e.indexOf("#")!=-1&&(e=e.substring(0,e.indexOf("#"))),document.title!=e&&e!==""&&(document.title=e)}function h(){var e=!0,t=_.browserDetect(),r={browser:t};switch(t.browser){case"chrome":t.version>=6&&(e=!1),Boolean(navigator.userAgent.match(/GoogleTV/i))&&(r.isUncertain=!0,e=!0);break;case"safari":t.version>=5&&(e=!1),Boolean(navigator.userAgent.match(/luakit/i))&&(r.isUncertain=!0,e=!0);break;case"msie":t.version>=7&&t.version<=10&&(e=!1),t.version<=6&&(r.isChromeFrame=!0,e=!0);break;case"firefox":t.version>=3&&(e=!1);break;case"mozilla":t.version>=1.9&&(e=!1);break;case"opera":t.version>=11&&(e=!1);break;case"adobeair":e=!1}e&&n.trigger("lightbox:open","unsupportedBrowser",r)}clearTimeout(o),n.loadedTokenData=!0,e.gsConfig=i.getGSConfig,e.gsLocale=i.getGSLocale,e.gsProduction=i.getGSProduction,e.gsViewBundles=i.getGSViewBundle,e.gsPageBundle=i.getGSPageBundle,e.clientTimeDivergence=i.getGSConfig.timestamp*1e3-(new Date).getTime(),n.currentYear=(new Date(Date.now()+e.clientTimeDivergence)).getFullYear();try{OAuth.correctTimestamp(gsConfig.timestamp)}catch(u){}gsConfig.snapVersion&&($.localize.cachebuster="?v="+gsConfig.snapVersion),gsConfig.localeJSONP?$.localize.jsonpCallback=gsConfig.localeJSONP:$.localize.jsonpCallback=!1;if(_.defined(e.gsLocale)){_.defined($.localize.data.gs)||($.localize.data.gs=gsLocale);var a;for(a in gsLocale)gsLocale.hasOwnProperty(a)&&($.localize.defaultLangData[a]=gsLocale[a])}setTimeout(function(){$.localize("gs",{language:"en",callback:_.bind($.localize.ready.resolve,$.localize.ready)})},0),function(){var t=document.getElementsByTagName("script")[0],n=t.parentNode,r=gsConfig.country&&gsConfig.country.ID;if(r==174){e.pp_gemius_identifier="nLrglARWI2UVfQNr05sNWcVHnMmNUwxHYBVcbVy.dTT.37",e.pp_gemius_time_identifier="csrr4EuVpEjFMNEgzOo0t_VyPw1dQfu3ps74UAeI94H.r7";var i=document.createElement("script");i.type="text/javascript",i.async=!0,i.src="http://gapl.hit.gemius.pl/xgemius.js",n.insertBefore(i,t)}else if(r==15){var s=document.createElement("script");s.type="text/javascript",s.async=!0,s.src=("https:"==document.location.protocol?"https://au-ssl":"http://au-cdn")+".effectivemeasure.net/em.js",n.insertBefore(s,t)}else if(r==106){function o(){var e={cid:"webads-it",content:"0",server:"secure-it"},t={check_cookie:0},n=nol_t&&nol_t(e,t);if(n&&n.record){var r=n.record();r&&r.post()}}var u=document.createElement("script"),a=!1;u.type="text/javascript",u.async=!0,u.src="//secure-it.imrworldwide.com/v60.js",u.onload=function(){a||(a=!0,o())},u.onreadystatechange=function(){!a&&(this.readyState=="loaded"||this.readyState=="complete")&&(a=!0,o())},n.insertBefore(u,t)}}(),n.Views=n.Views||{},n.Views.Modules=n.Views.Modules||{},n.Views.Pages=n.Views.Pages||{},n.Views.Lightboxes=n.Views.Lightboxes||{},n.Views.Tooltips=n.Views.Tooltips||{};var f={tier2:"/gs/tier2.js",settingsPage:"/gs/tier2.js",nowPlayingPage:"/gs/tier2.js",communityPage:"/gs/tier2.js",promotionPage:"/gs/tier2.js",surveysPage:"/gs/tier2.js",tagPage:"/gs/tier2.js",shareLightbox:"/gs/tier2.js",inviteLightbox:"/gs/tier2.js",suggestTagsLightbox:"/gs/tier2.js",feedbackLightbox:"/gs/tier2.js",leap:"/gs/leap.js",leapGestures:"/gs/leap.js",artistDashboardPage:"/gs/artists.js",claimArtistLightbox:"/gs/artists.js",claimSongsLightbox:"/gs/artists.js",editArtistLightbox:"/gs/artists.js",editAlbumLightbox:"/gs/artists.js",editSongsLightbox:"/gs/artists.js",uploadLightbox:"/gs/artists.js",id3:"/gs/artists.js",gsTag:"/gs/tier2.js",countriesStates:"/gs/tier2.js",contextMenus:"/gs/tier2.js"};if(gsProduction&&gsProduction.packages){var l=gsProduction.packages;_.extend(f,l)}amdModules.setPathRedirects(e.gsProduction),amdModules.addPackages(f),$.drop({mode:"mouse"}),jQuery.event.special.drag.defaults.distance=10,n.Views=n.Views||{},n.Views.viewBundles=e.gsViewBundles||{},n.Views.templateCache={};if(e.gsPageBundle&&$.isPlainObject(gsPageBundle))for(var p in gsPageBundle)gsPageBundle.hasOwnProperty(p)&&(n.Views.templateCache[p]=gsPageBundle[p]);var d=new n.Models.Model({gsConfig:gsConfig});n.getCurrentBroadcastID=function(){var e=d.get("player"),t=e&&e.get("currentQueue"),n=t&&t.get("currentBroadcast");return n?n.get("BroadcastID"):!1},n.getCurrentBroadcast=function(){var e=d.get("player"),t=e&&e.get("currentQueue"),n=t&&t.get("currentBroadcast");return n?n:!1},gsConfig.windowName&&(e.name=gsConfig.windowName),n.getLoggedInUserID=function(){return d.get("user").id},n.getLoggedInUserPicture=function(e){return d.get("user").getImageURL(e)},n.isLoggedInUserOwnerOfArtist=function(e){if(!e)return!1;var n=d.get("user").get("artistsOwned");if(n){if(e)return n.get(e)?!0:!1;if(e===t)return n.length>0}return!1},n.isLoggedInUserArtistProfile=function(e){var t=d.get("user"),r=_.toInt(t.get("Flags")),i=!1;return r&n.Models.User.FLAG_ARTIST_PROFILE&&(e?e==t.get("artistID")&&(i=!0):i=!0),i},n.isBroadcastListener=function(e){var t=d.get("player"),n=t&&t.get("currentQueue"),r=n&&n.get("currentBroadcast");return r?e?r===e&&!n.get("isBroadcasting"):!n.get("isBroadcasting"):!1},n.isBroadcaster=function(){var e=d.get("player"),t=e&&e.get("currentQueue");return t&&!!t.get("isBroadcasting")},n.getCurrentPlayStatus=function(){return d.get("player").get("playStatus")},r=new n.Views.Application({model:d}),gsConfig.runMode==="dev"&&(e.debugApp=r),n.Services.SWF.init(d),n.Services.API.init(gsConfig),n.Services.API.newTokenSuccess(i.getCommunicationToken),delete i.getCommunicationToken,n.Services.GUTS.init(d),n.Services.Facebook.init(r),n.Services.Twitter.init(r),n.Services.Google.init(r),n.Services.Lastfm.init(r),n.Services.Flattr.init(r),n.Services.Youtube.init(r),n.Services.Vimeo.init(r),n.External.AIRBridge.init(d),n.External.DesktopBridge.init(d),n.External.PluginAPI.init(d);var v,m=function(e){if(!e)return;clearTimeout(v);var t=e.getStreamKeyWithSong;if(t&&t.song&&t.streamKey){e.consumedStreamKey=!0,delete e.getStreamKeyWithSong;var r=n.Models.Song.newOrUpdate(t.song);n.Services.SWF.ready.done(function(){var e=t.streamKey;e.serverID=t.streamKey.streamServerID,n.Services.SWF.playSongFromStreamkey(r.getDetailsForSwf(),e)})}};typeof preloadedData!="undefined"?preloadedData.getStreamKeyWithSong&&m(preloadedData):(v=setTimeout(function(){n.trigger("neverGotStreamKey")},4e3),n.on("preloadedData",m)),n.Models.Callout.setupCalloutListeners();var g=_.once(function(){s.notify(),$("body").removeClass("css-loading");var e=$("body,#main,#page_wrapper,#mainContainer");e.scrollTop(0),document.body.scroll="no",e.scroll(function(e){return $(this).scrollTop()>0&&$(this).scrollTop(0),!1}),$.browser.msie&&($(document).bind("propertychange",function(){event.propertyName=="title"&&c()}),c()),$.drop({mode:"mouse"}),s.resolve(),n.router.run(r),h(),setTimeout(_.doStyles,1e4)});$(document).ready(function(){$.browser.msie&&$("body").addClass("is-ie is-ie"+_.toInt($.browser.version)),e.gotGSStyle?g():n.on("gsStyle:ready",g)});var y=Date.now();e.onbeforeunload=function(){var e=d.get("user");e&&e.id>0&&e.storeLibrary(),n.Services.SWF&&n.Services.SWF.hasOwnProperty("storeQueue")&&n.Services.SWF.storeQueue(),n.Services.GUTS&&n.Services.GUTS.forceSend();if(!e.get("subscription").canHideAds()&&Date.now()-y<3e4&&!gsConfig.httpsFix&&!n.External.AIRBridge.isDesktop&&!n.External.DesktopBridge.active)return _.getString("ONCLOSE_JUST_LOADED");var t=r.page.getCurrentPageView(),i=t?t.blockPageChange():!1;if(i)return i;var s=swfobject.getObjectById("record-swf");if(s&&_.isFunction(s.numPendingUploads)&&s.numPendingUploads()>0)return _.getString("ONCLOSE_PENDING_UPLOADS");if(d.get("player").playStatusIsPlaying())return _.getString("ONCLOSE_PLAYING")},e.onunload=function(){n.Services.SWF&&n.Services.SWF.hasOwnProperty("onPageUnload")&&n.Services.SWF.onPageUnload()}}),e.tokenData&&n.trigger("tokenData",e.tokenData)};(function(t){var n=5,r={PRECORE:0,POSTCORE:1},i=0,s=0,o=5,u=1e3,a=6e4,f=!1,l=+(new Date),c=t.applicationCache,h=!0,p=!1,d=!1,v,m=function(e,t){if(e&&e.getGSProduction&&e.getGSProduction.JSQUEUE){var n=e.getGSProduction,r=$("#jsPlayerEmbed");if(r.length){var i=n.JSQUEUE.assetPath,s=r.clone(),o=s.find("param[name=movie]");if(t.runMode=="dev"||t.runMode=="themes")i+="?"+ +(new Date);o.length?o.attr("value",i):s.attr("data",i),r.replaceWith(s)}}};if(t.gsBootstrap&&t.gsBootstrap.booting){t.gsBootstrap.upgrade=function(e,i){var s=parseInt(e||0,10),o=t.tokenData,u=o.getGSConfig||{};if(s===n||!c)return;i==r.POSTCORE&&m(o,u)},gsBootstrap.newApp=function(t){gsBootstrap.version||gsBootstrap.upgrade(0,r.POSTCORE),e(t)};return}t.gsBootstrap||(t.gsBootstrap={version:n,booting:!0,performance:t.performance||{},upgrade:function(){}},gsBootstrap.performance.mark||(gsBootstrap.performance.mark=function(e){gsBootstrap.log.push(e+": "+(+(new Date)-l))})),gsBootstrap.log=[];var g=function(l){if(f)return;s++,!e&&t.gsBootstrap.newApp&&(e=t.gsBootstrap.newApp);if(!t.groovesharkCore||!e){if(i>=a&&confirm("Failed to load some files, retry?")){t.location.reload();return}l||(i+=o,s>=8&&i>o*5&&o<u&&(o*=2)),setTimeout(g,o);return}gsBootstrap.upgrade(n,r.PRECORE),f=!0,t.gsBootstrap.newApp=null,gsBootstrap.performance.mark("running core"),t.groovesharkCore(t),gsBootstrap.performance.mark("finished core"),t.groovesharkCore=null,gsBootstrap.upgrade(n,r.POSTCORE),gsBootstrap.performance.mark("running app"),e(t),gsBootstrap.performance.mark("finished app")},y=function(){clearTimeout(v),v=null,h=!1,p=!0;var e=document.getElementById("coreJS");e&&(e.onload=e.onreadystatechange=g),setTimeout(g,o)};if(!c)return y();var b=function(e){var t=e.getElementsByTagName("script"),n=[],r,i,s,o;for(r=0,i=t.length;r<i;r++)s=t[r],o=s.src,o&&n.push([o,s,"js"]);t=e.getElementsByTagName("link");for(r=0,i=t.length;r<i;r++)s=t[r],o=s.href,o&&s.rel=="stylesheet"&&n.push([o,s,"css"]);return n}(document),w=function(){var n,r=0,i=function(){console.log("reloading due to failed update"),console.trace(),t.location.reload(),clearInterval(n)};t.groovesharkCore=null,e=null;var s=function(){if(++r>70)return i();if(!t.tokenData)return;var e=t.tokenData,s=e.getGSProduction,o=e.getGSConfig||{};clearInterval(n);if(!s||!s.CORE||!s.APP)return i();var u=s.CORE.assetPath,a=s.APP.assetPath,f=s.LOAD_CSSURI.assetPath,l=s.CSSURI.assetPath;if(o.runMode=="dev"||o.runMode=="themes"){var c=+(new Date);u+="?"+c,a+="?"+c,f+="?"+c,l+="?"+c}gsAddScript(u),gsAddScript(a,{callback:function(){y()}});var h=document.getElementById("loadingCSS"),p=document.getElementById("loadingCSSFallback");gsAddCSS(f,{id:"loadingCSS",callback:function(){var e=h&&h.parentNode;e&&e.removeChild(h),e=p&&p.parentNode,e&&e.removeChild(p)}}),gsAddCSS(l,{callback:function(){for(var e=0,t=b.length,n;e<t;e++)b[e][2]=="css"&&(n=b[e][1].parentNode,n&&n.removeChild(b[e][1]))}})};n=setInterval(s,100),s()},E=function(){gsBootstrap.log.push("appCache: "+c.status+" (allowLoad: "+h+")");if(!h)return;clearTimeout(v),v=null;switch(c.status){case c.UNCACHED:y();break;case c.IDLE:d&&y();break;case c.CHECKING:v=setTimeout(y,3500);case c.DOWNLOADING:d=!0;break;case c.UPDATEREADY:setTimeout(function(){h=!1,w()},6);break;case c.OBSOLETE:setTimeout(function(){t.location.reload()},1e3);break;default:y()}};gsBootstrap.checkCache=E,c.addEventListener("cached",function(){gsBootstrap.log.push("appCache: "+c.status+" (cached: true)"),y()},!1),c.addEventListener("progress",function(e){gsBootstrap.log.push("appCache progress: "+e.loaded+"/"+e.total),clearTimeout(v)},!1),c.addEventListener("downloading",E,!1),c.addEventListener("obsolete",E,!1),c.addEventListener("updateready",E,!1),c.addEventListener("noupdate",function(){gsBootstrap.log.push("appCache: "+c.status+" (noupdate: true)"),y()},!1),c.addEventListener("error",function(e){gsBootstrap.log.push("appCache: "+c.status+" (failed: true)"),console.log("appCache failed",e.message,e),y()},!1),E()})(window)})()